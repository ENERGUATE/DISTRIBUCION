HA$PBExportHeader$u_tab_2301_form_incidencias.sru
$PBExportComments$FDO
forward
global type u_tab_2301_form_incidencias from tab
end type
type tabpage_formulario from userobject within u_tab_2301_form_incidencias
end type
type dw_informe_tecnico from datawindow within tabpage_formulario
end type
type st_18 from statictext within tabpage_formulario
end type
type st_cxt_valor from statictext within tabpage_formulario
end type
type st_cxt_t from statictext within tabpage_formulario
end type
type st_pxt_valor from statictext within tabpage_formulario
end type
type st_pxt_t from statictext within tabpage_formulario
end type
type st_pxt_cxt_fondo from statictext within tabpage_formulario
end type
type dw_3 from datawindow within tabpage_formulario
end type
type dw_1 from datawindow within tabpage_formulario
end type
type dw_detalle_interr from u_inc_2005_pr_detalle_interrup within tabpage_formulario
end type
type cbx_blackout from checkbox within tabpage_formulario
end type
type dw_2 from datawindow within tabpage_formulario
end type
type st_2 from statictext within tabpage_formulario
end type
type st_1 from statictext within tabpage_formulario
end type
type d_inf_general from u_inc_2003_pr_form_inf_general within tabpage_formulario
end type
type st_fases from statictext within tabpage_formulario
end type
type gb_3 from groupbox within tabpage_formulario
end type
type tabpage_formulario from userobject within u_tab_2301_form_incidencias
dw_informe_tecnico dw_informe_tecnico
st_18 st_18
st_cxt_valor st_cxt_valor
st_cxt_t st_cxt_t
st_pxt_valor st_pxt_valor
st_pxt_t st_pxt_t
st_pxt_cxt_fondo st_pxt_cxt_fondo
dw_3 dw_3
dw_1 dw_1
dw_detalle_interr dw_detalle_interr
cbx_blackout cbx_blackout
dw_2 dw_2
st_2 st_2
st_1 st_1
d_inf_general d_inf_general
st_fases st_fases
gb_3 gb_3
end type
type tabpage_observaciones from userobject within u_tab_2301_form_incidencias
end type
type cb_14 from commandbutton within tabpage_observaciones
end type
type cb_2 from commandbutton within tabpage_observaciones
end type
type st_3 from statictext within tabpage_observaciones
end type
type st_4 from statictext within tabpage_observaciones
end type
type mle_observaciones_mnto from multilineedit within tabpage_observaciones
end type
type mle_observaciones from multilineedit within tabpage_observaciones
end type
type ole_1 from olecontrol within tabpage_observaciones
end type
type tabpage_observaciones from userobject within u_tab_2301_form_incidencias
cb_14 cb_14
cb_2 cb_2
st_3 st_3
st_4 st_4
mle_observaciones_mnto mle_observaciones_mnto
mle_observaciones mle_observaciones
ole_1 ole_1
end type
type tabpage_ot from userobject within u_tab_2301_form_incidencias
end type
type st_sin_ot from statictext within tabpage_ot
end type
type cb_ot from commandbutton within tabpage_ot
end type
type gb_11 from groupbox within tabpage_ot
end type
type rb_2 from radiobutton within tabpage_ot
end type
type rb_1 from radiobutton within tabpage_ot
end type
type bmp_brigada_responsable from picture within tabpage_ot
end type
type d_lista_brigadas_ot from u_bri_2002_pr_list_brigadas_ot within tabpage_ot
end type
type dw_lista_contratas from u_gen_0002_pr_generico within tabpage_ot
end type
type tab_lista_brigadas from u_tab_brigadas within tabpage_ot
end type
type tab_lista_brigadas from u_tab_brigadas within tabpage_ot
end type
type d_crit_seleccion from datawindow within tabpage_ot
end type
type gb_2 from groupbox within tabpage_ot
end type
type dw_ambito from u_cen_2001_pr_form_centro_cmd_mesa within tabpage_ot
end type
type d_datos_ot from datawindow within tabpage_ot
end type
type tabpage_ot from userobject within u_tab_2301_form_incidencias
st_sin_ot st_sin_ot
cb_ot cb_ot
gb_11 gb_11
rb_2 rb_2
rb_1 rb_1
bmp_brigada_responsable bmp_brigada_responsable
d_lista_brigadas_ot d_lista_brigadas_ot
dw_lista_contratas dw_lista_contratas
tab_lista_brigadas tab_lista_brigadas
d_crit_seleccion d_crit_seleccion
gb_2 gb_2
dw_ambito dw_ambito
d_datos_ot d_datos_ot
end type
type tabpage_cuadrillas from userobject within u_tab_2301_form_incidencias
end type
type cb_eliminar from u_cb within tabpage_cuadrillas
end type
type cb_agregar from u_cb within tabpage_cuadrillas
end type
type d_materiales from u_bri_2005_pr_materiales_incidencia within tabpage_cuadrillas
end type
type tabpage_cuadrillas from userobject within u_tab_2301_form_incidencias
cb_eliminar cb_eliminar
cb_agregar cb_agregar
d_materiales d_materiales
end type
type tabpage_interrupciones from userobject within u_tab_2301_form_incidencias
end type
type cb_1 from commandbutton within tabpage_interrupciones
end type
type uo_eltos_corte from u_elementos_corte within tabpage_interrupciones
end type
type dw_lista_int_comunes from datawindow within tabpage_interrupciones
end type
type pb_anterior from picturebutton within tabpage_interrupciones
end type
type st_fases_afect from statictext within tabpage_interrupciones
end type
type cbx_fase_c from checkbox within tabpage_interrupciones
end type
type cbx_fase_b from checkbox within tabpage_interrupciones
end type
type cbx_fase_a from checkbox within tabpage_interrupciones
end type
type pb_avanzar from picturebutton within tabpage_interrupciones
end type
type st_duracion_total from statictext within tabpage_interrupciones
end type
type st_durac_total from statictext within tabpage_interrupciones
end type
type st_datos_interrup from statictext within tabpage_interrupciones
end type
type st_durac from statictext within tabpage_interrupciones
end type
type st_duracion from statictext within tabpage_interrupciones
end type
type st_lista_int_operaciones from statictext within tabpage_interrupciones
end type
type cb_separador from commandbutton within tabpage_interrupciones
end type
type st_otras_inst from statictext within tabpage_interrupciones
end type
type rb_otras_inc from radiobutton within tabpage_interrupciones
end type
type rb_misma_inc from radiobutton within tabpage_interrupciones
end type
type dw_afec_parcial_sum from datawindow within tabpage_interrupciones
end type
type dw_sin_interrupcion from datawindow within tabpage_interrupciones
end type
type d_datos_interrup from datawindow within tabpage_interrupciones
end type
type dw_lista_int_operaciones from u_lista_interrupciones_operacion within tabpage_interrupciones
end type
type d_lista_otras_inst_ant from u_ins_2010_pr_lista_dat_tecnicos within tabpage_interrupciones
end type
type dw_lista_acometidas from u_inc_lista_acometidas_int within tabpage_interrupciones
end type
type d_lista_otras_inst from u_ins_2010_pr_lista_otras_ins within tabpage_interrupciones
end type
type tv_1 from u_tv within tabpage_interrupciones
end type
type tabpage_interrupciones from userobject within u_tab_2301_form_incidencias
cb_1 cb_1
uo_eltos_corte uo_eltos_corte
dw_lista_int_comunes dw_lista_int_comunes
pb_anterior pb_anterior
st_fases_afect st_fases_afect
cbx_fase_c cbx_fase_c
cbx_fase_b cbx_fase_b
cbx_fase_a cbx_fase_a
pb_avanzar pb_avanzar
st_duracion_total st_duracion_total
st_durac_total st_durac_total
st_datos_interrup st_datos_interrup
st_durac st_durac
st_duracion st_duracion
st_lista_int_operaciones st_lista_int_operaciones
cb_separador cb_separador
st_otras_inst st_otras_inst
rb_otras_inc rb_otras_inc
rb_misma_inc rb_misma_inc
dw_afec_parcial_sum dw_afec_parcial_sum
dw_sin_interrupcion dw_sin_interrupcion
d_datos_interrup d_datos_interrup
dw_lista_int_operaciones dw_lista_int_operaciones
d_lista_otras_inst_ant d_lista_otras_inst_ant
dw_lista_acometidas dw_lista_acometidas
d_lista_otras_inst d_lista_otras_inst
tv_1 tv_1
end type
type tabpage_seguimiento from userobject within u_tab_2301_form_incidencias
end type
type chk_resolucion_mant from checkbox within tabpage_seguimiento
end type
type d_estados_mantenimientos from u_ema_2002_pr_lista_estado_mantenimiento within tabpage_seguimiento
end type
type d_seguimiento_operaciones from u_eop_2001_pr_seguimiento_operaciones within tabpage_seguimiento
end type
type d_seguimiento_mantenimiento from u_ema_2001_pr_seguimiento_mantenimiento within tabpage_seguimiento
end type
type d_estados_operaciones from u_eop_2002_pr_lista_estados_operaciones within tabpage_seguimiento
end type
type tabpage_seguimiento from userobject within u_tab_2301_form_incidencias
chk_resolucion_mant chk_resolucion_mant
d_estados_mantenimientos d_estados_mantenimientos
d_seguimiento_operaciones d_seguimiento_operaciones
d_seguimiento_mantenimiento d_seguimiento_mantenimiento
d_estados_operaciones d_estados_operaciones
end type
type tabpage_acciones from userobject within u_tab_2301_form_incidencias
end type
type st_titulo from statictext within tabpage_acciones
end type
type d_lista_acciones from u_inc_2015_pr_lista_acciones within tabpage_acciones
end type
type d_lista_acciones_incidencia from u_inc_2014_pr_lista_acciones_incidencia within tabpage_acciones
end type
type mle_observacion_accion_incidencia from multilineedit within tabpage_acciones
end type
type tabpage_acciones from userobject within u_tab_2301_form_incidencias
st_titulo st_titulo
d_lista_acciones d_lista_acciones
d_lista_acciones_incidencia d_lista_acciones_incidencia
mle_observacion_accion_incidencia mle_observacion_accion_incidencia
end type
type tabpage_maniobras from userobject within u_tab_2301_form_incidencias
end type
type cb_otras_man from commandbutton within tabpage_maniobras
end type
type dw_maniobras from u_inc_2052_lista_maniobras within tabpage_maniobras
end type
type tabpage_maniobras from userobject within u_tab_2301_form_incidencias
cb_otras_man cb_otras_man
dw_maniobras dw_maniobras
end type
type tabpage_indisponibilidades from userobject within u_tab_2301_form_incidencias
end type
type cb_maniobras from commandbutton within tabpage_indisponibilidades
end type
type dw_lista_indisponibilidades_batch from datawindow within tabpage_indisponibilidades
end type
type em_1 from editmask within tabpage_indisponibilidades
end type
type st_17 from statictext within tabpage_indisponibilidades
end type
type st_15 from statictext within tabpage_indisponibilidades
end type
type st_14 from statictext within tabpage_indisponibilidades
end type
type st_13 from statictext within tabpage_indisponibilidades
end type
type st_12 from statictext within tabpage_indisponibilidades
end type
type st_11 from statictext within tabpage_indisponibilidades
end type
type st_10 from statictext within tabpage_indisponibilidades
end type
type st_9 from statictext within tabpage_indisponibilidades
end type
type st_8 from statictext within tabpage_indisponibilidades
end type
type st_7 from statictext within tabpage_indisponibilidades
end type
type st_6 from statictext within tabpage_indisponibilidades
end type
type st_5 from statictext within tabpage_indisponibilidades
end type
type p_10 from picture within tabpage_indisponibilidades
end type
type p_9 from picture within tabpage_indisponibilidades
end type
type p_8 from picture within tabpage_indisponibilidades
end type
type p_7 from picture within tabpage_indisponibilidades
end type
type p_6 from picture within tabpage_indisponibilidades
end type
type p_5 from picture within tabpage_indisponibilidades
end type
type p_4 from picture within tabpage_indisponibilidades
end type
type p_3 from picture within tabpage_indisponibilidades
end type
type p_2 from picture within tabpage_indisponibilidades
end type
type p_1 from picture within tabpage_indisponibilidades
end type
type dw_lista_indisponibilidades from u_gen_0000_lista within tabpage_indisponibilidades
end type
type tv_2 from uo_man_instalac within tabpage_indisponibilidades
end type
type gb_1 from groupbox within tabpage_indisponibilidades
end type
type st_16 from statictext within tabpage_indisponibilidades
end type
type dw_datos_indisponibilidades from datawindow within tabpage_indisponibilidades
end type
type dw_filtro_indisponibilidades from datawindow within tabpage_indisponibilidades
end type
type tabpage_indisponibilidades from userobject within u_tab_2301_form_incidencias
cb_maniobras cb_maniobras
dw_lista_indisponibilidades_batch dw_lista_indisponibilidades_batch
em_1 em_1
st_17 st_17
st_15 st_15
st_14 st_14
st_13 st_13
st_12 st_12
st_11 st_11
st_10 st_10
st_9 st_9
st_8 st_8
st_7 st_7
st_6 st_6
st_5 st_5
p_10 p_10
p_9 p_9
p_8 p_8
p_7 p_7
p_6 p_6
p_5 p_5
p_4 p_4
p_3 p_3
p_2 p_2
p_1 p_1
dw_lista_indisponibilidades dw_lista_indisponibilidades
tv_2 tv_2
gb_1 gb_1
st_16 st_16
dw_datos_indisponibilidades dw_datos_indisponibilidades
dw_filtro_indisponibilidades dw_filtro_indisponibilidades
end type
type tabpage_otros from userobject within u_tab_2301_form_incidencias
end type
type dw_otros from datawindow within tabpage_otros
end type
type tabpage_otros from userobject within u_tab_2301_form_incidencias
dw_otros dw_otros
end type
type tabpage_ocen from userobject within u_tab_2301_form_incidencias
end type
type uo_ot_ocen from u_2301_tabpage_ocen within tabpage_ocen
end type
type tabpage_ocen from userobject within u_tab_2301_form_incidencias
uo_ot_ocen uo_ot_ocen
end type
type datos_arbol from structure within u_tab_2301_form_incidencias
end type
end forward

type datos_arbol from structure
	long		ll_codigo
	long		ll_tipo
end type

global type u_tab_2301_form_incidencias from tab
integer width = 5563
integer height = 4000
integer taborder = 1
integer textsize = -9
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long backcolor = 81324524
boolean focusonbuttondown = true
boolean boldselectedtext = true
integer selectedtab = 1
tabpage_formulario tabpage_formulario
tabpage_observaciones tabpage_observaciones
tabpage_ot tabpage_ot
tabpage_cuadrillas tabpage_cuadrillas
tabpage_interrupciones tabpage_interrupciones
tabpage_seguimiento tabpage_seguimiento
tabpage_acciones tabpage_acciones
tabpage_maniobras tabpage_maniobras
tabpage_indisponibilidades tabpage_indisponibilidades
tabpage_otros tabpage_otros
tabpage_ocen tabpage_ocen
event ue_armar_sql ( )
event type integer ue_selecttab ( integer index )
end type
global u_tab_2301_form_incidencias u_tab_2301_form_incidencias

type variables
// Objeto no visual que se autoinstancia
u_inc_2003_rn_form_inf_general iu_inc_2003_rn
u_gen_0000_nu_filtro iu_filtro 
char ic_tabs[8]="00000000"
w_2301_form_incidencia  iw_contenedora
decimal{0} idec_nro_instalacion_afectada
int ii_estado_oper, ii_estado_mant
int ii_nro_centro
int ii_nro_cmd
int ii_nro_mesa
int ii_incid_suministro
int ii_resuelve_mant
int ii_viejo_index
integer ii_indice
int ii_alcance=0
//
// ii_alcance=1 >> Indica que la inc. es imprevista
// ii_alcance=2 >> Indica que la inc. es programada
// ii_alcance=3 >> Indica que la inc. es de calidad
/////////////////////////////////////////////////////
int ii_tipo_incid
int ii_modifica_causa = 0
// ii_tipo_incid = 1 >> Indica que la inc. es Imprevista
// ii_tipo_incid = 2 >> Indica que la inc. es Programada
// ii_tipo_incid = 3 >> Indica que la inc. es De Calidad
// filas en las que se encuentra cada estado en la dw de seguimiento de operaciones
int ii_incidencia_pendiente 
int ii_incidencia_enviado_brigada
int ii_incidencia_en_reposicion
int ii_incidencia_servicio_repuesto
int ii_incidencia_resuelta
int ii_incidencia_cerrada
int ii_incidencia_pte_pta_explotacion
int ii_ind_act_grafica =0
Int ii_avisar_oop_eb = 2  //1- SI, 0 - NO
Int ii_tipo_inst // AMR AFECTACION PARCIAL 20020809

long il_nro_incidencia
long il_nro_ot
long il_handle_instalacion=0

// fechas  de los estaos de oper 
datetime idt_fec_deteccion 
datetime idt_fec_deteccion_nueva 
datetime idt_fecha_eb
datetime idt_fecha_cl
datetime idt_fecha_er
datetime idt_fecha_sr
datetime idt_fecha_resuelta
datetime idt_fecha_nueva_repos
datetime idt_fecha_vieja_repos
datetime idt_fecha_pt_pex
//fechas de los estados de mant
datetime idt_fecha_st_mant
datetime idt_fecha_eb_mant 
datetime idt_fecha_al_mant
datetime idt_fecha_rp_mant
datetime idt_fecha_pr_mant
datetime idt_fecha_rm_mant
datetime idt_f_actual

string is_accion_llamada
string tipo_ot = 'BR'
string is_sqlcontratas = ""
string is_tipo_ventana

////  Variables para indicar que es la primera vez 
//// que se accede al tabpage correpondiente
boolean ib_open = True
boolean ib_primera_vez_formulario = True
boolean ib_primera_vez_observaciones =  True
boolean ib_primera_vez_ot =  True
boolean ib_primera_vez_cuadrillas =  True
boolean ib_primera_vez_interrupciones =  True
boolean ib_primera_vez_seguimiento =  True
boolean ib_primera_vez_acciones =  True
boolean ib_primera_vez_maniobras =True
boolean ib_primera_vez_indisponibilidades =True
boolean ib_cambio_instalacion
boolean ib_derivada_mante = false
boolean ib_valido_ot=false
boolean ib_mensaje=false
boolean ib_hay_brig_trab=false
boolean ib_retorno_segumiento=false
boolean ib_hubo_cambios=false
boolean ib_inst_int
Boolean ib_pestana_otros  //**  OSGI 2001.1  15/05/2001
Boolean ib_nuevos_tip_inc  //**  OSGI 2001.1  17/05/2001
Boolean ib_pxt_cxt  //**  OSGI 2001.1  22/05/2001
Boolean ib_afect_parcial  //**  OSGI 2001.1  28/05/2001
Boolean ib_error_en_causa = FALSE
Boolean ib_error_en_causa_subtipo = FALSE // TDA.EDM-2
Boolean ib_inc_finalizada = FALSE
Boolean ib_ind_scada = FALSE
Boolean ib_anadir_eb =false
Boolean ib_error_fec_deteccion //**  JPE 20020807  PM001 RESTRICCION N DIAS ANTIG$$HEX1$$dc00$$ENDHEX$$EDAD
Boolean ib_necesita_enviar_estados
////////  FORMULARIO   //////////////
datetime idt_fec_est_res
int ii_causa_ant

///////    Materiales utilizados por las brigadas   ///////
int ii_fila_selec_mat
boolean ib_valido_mat, ib_modif_mat

//////     ORDEN DE TRABAJO    ////////// 
int click_row, click_row_brig_ot
int i_grabo_ot
int ii_brigada_resp
datetime idt_f_brigada_old

////////      INTERRUPCIONES ///////////

// indica que se borro la interrupcion
boolean ib_dejo_cambiar = TRUE
int l_si_valido
string ls_columna

///////////    SEGUIMIENTO     //////////////
long il_click_mant_seg
long il_click_oper_seg
long il_ultima_fila_clickeada_seg
long il_ultima_fila_click_mant_seg
datetime idt_fecha_ant_mant_seg
boolean ib_cancelo_seg
string is_nom_brig_res

//////////     ACCIONES     ///////////////
long ll_row_acc_inc_acc=1
long ll_row_accion_acc
boolean ib_hubo_error= false
boolean ib_observ=true

//INSTALACIONES DIGITALIZADAS.

long il_inst_dig[]
long ii_resul_dig

// Trabajos BDI
int ii_cant_trabajos = 0,ii_pe = 0,ii_eliminar_pe = 0

// GNU 8-2-2006. Incidencia pruebas Integradas Nicaragua
boolean ib_mensaje_resuelta= false

// FDO - Fila clickeada
int ii_fila_clickeada

// GNU 9-10-2006. Mejora EPSA
long il_handle_indisponibilidad
long il_ENR

long il_ind_desmarcadas []

//JME 08/05/09
long il_nro_inst_indisponibilidad, il_row_datos_indisponibilidad

//AHM (15/10/2010)
int	ii_estActualAnterior			//Estado de operaci$$HEX1$$f300$$ENDHEX$$n anterior
//JHE 04/04/2013
int ii_valtiempomax = 0

//LSH INI 08/09/2013 evolutivo DEO12-00000263
datetime idt_fec_elim_peligro

//HLA.INI.DDAG-6453.25/08/2016
int ii_causa
//HLA.FIN.DDAG-6453.25/08/2016
end variables

forward prototypes
public function string f_devolver_observaciones (ref datawindow pd_dw)
public function integer f_grabar_materiales (long pl_nro_incidencia)
public function boolean frn_hab_brigadistas (ref datawindow pd_dw)
public function long f_actualizar_ultima_ot ()
public function integer f_crea_ddw_estado (ref datawindow pd_dw)
public function integer f_mostrar_datos_ot (ref datawindow pd_dw, long pl_nro_ot)
public function integer frn_datos_ot_por_defecto (ref datawindow pd_dw, long pl_nro_ot)
public function integer fpr_deshabilitar_lista_brigadas_ot (ref datawindow pd_dw, integer pi_estado)
public function integer f_deshabilitar_datos_ot_2 (ref datawindow pd_dw, integer pi_estado)
public function boolean frn_existen_brigadas_con_tarea (ref datawindow pd_dw)
public function su_drag_brigada_ot f_devolver_brigada_ot (ref datawindow pd_dw, integer pl_click_row)
public function integer fnu_agregar_brigada (ref datawindow pd_dw, su_drag_brigada_ot ps_estructura)
public function integer fnu_asignar_responsable (ref datawindow pd_dw, long pl_click_row)
public function integer frn_h_seguimiento_segun_perfil (integer pi_incidencia_suministro, ref datawindow d_seguimiento_oper, string ps_accion_llamada)
public function boolean frn_valida_fechas_de_derivacion (ref datawindow pd_dw1, ref datawindow pd_dw2)
public function integer fnu_quitar_accion (datawindow pd_dw, integer pl_row)
public function integer fnu_devolver_obs_accion (ref datawindow pd_dw, multilineedit mle_obs_accion, long pl_row_inc)
public function integer fnu_devolver_brigada_resp (ref datawindow pd_dw)
public function long f_devolver_primer_aviso (ref datawindow pd_dw)
public function integer frn_habilitar_obs_accion (boolean pb_habilitar)
public function integer fnu_agregar_accion (ref datawindow pd_dw, integer pi_nro_accion, string ps_descripcion, long pl_nro_incidencia, boolean pb_usuario_mant)
public function integer fnu_obte_estados_oper ()
public function boolean frn_evaluo_f_deteccion (datetime pdt_fec_nueva, datetime pdt_fec_vieja)
public function integer fnu_obte_estados_mant ()
public function long fnu_actualizar_ultima_inc ()
public function boolean frn_v_fechas (ref datawindow pd_dw)
public function boolean frn_validar_estado_pr (ref datawindow pd_dw, boolean pb_resuelve_mant)
public function boolean frn_validar_salida_mant (ref datawindow pd_dw, ref datawindow pd_dw2, integer pl_click_row, integer pi_estado_mant)
public function integer frn_habilita_resuelve_mant ()
public function boolean fnu_env_operaciones ()
public function boolean fnu_fecha_solo_en_st ()
public function boolean frn_validar_salida_oper (long pl_click_row)
public function integer frn_habilitar_op (boolean pb_habilitar)
public function integer frn_habilitar_mant (boolean pb_habilitar)
public function integer fnu_evaluo_sin_selec (integer pl_causa_ant)
public function boolean frn_es_anulacion (ref datawindow pd_dw, integer pl_click_row)
public function boolean frn_validar_anulacion (ref datawindow pd_dw, integer pl_click_row)
public function boolean fnu_devolver_env_mant (ref datawindow pd_dw)
public function integer fnu_cargar_ot (ref datawindow pd_dw, decimal pd_instalacion, long pl_aviso, integer pi_brigada_resp, integer pi_centro, integer pi_cmd, integer pi_mesa, long pl_nro_incidencia)
public function integer f_finalizar_tareas_brigadas ()
public function integer f_changing (long pl_indice_viejo, long pl_indice_nuevo)
public subroutine f_changed (long pl_indice_viejo, long pl_indice_nuevo)
public function boolean frn_evaluo_f_res_estimada ()
public function boolean f_inserta_datos_brig ()
public function integer f_deshab_tabs (boolean pb_primera)
public function integer fnu_inc_descargos ()
public function integer fnu_validar_brigadas_prev ()
public function integer fnu_fecha_menor_prev ()
public function integer fnu_habilito_f_hasta ()
public function integer fnu_comprueba_fin_ot (datetime pdt_fecha)
public subroutine fnu_deshabilito_al_resolver ()
public function integer fnu_comprueba_valores_nulos_interrup (ref datawindow pd_dw)
public function integer frn_validar_quitar_brigada (ref datawindow pd_dw, long pl_nro_brigada)
public function integer frn_validar_drag_brigada (ref datawindow pd_dw, long pl_nro_brigada)
public function string f_devolver_observaciones_mnto (ref datawindow pd_dw)
public function integer of_pasar_explotacion (long ll_nro_incidencia)
public function integer of_deriv_mante (long nro_incidencia, datetime ld_fecha_resolucion, boolean ib_enviada_mante)
public subroutine wf_actualizar_contrata (ref datawindow pd_dw, long row, ref su_drag_brigada_ot s_estructura)
public subroutine fnu_cambiar_ot_tipo (string mode)
public function integer fnu_finalizar_ot (datetime pdt_fecha)
public function boolean fw_equipo_disponible (integer pl_nro_equipo, string ps_tipo_equipo)
public subroutine of_iniciar_estados_oper ()
public function integer fw_valida_drag_brigada_no_disp (long pl_nro_brigada)
public function integer fnu_carga_sin_interrup (long pl_nro_instalacion, integer pi_tipo_instalacion)
public function boolean of_brigada_aun_disponible (long pl_nro_brigada)
public function integer of_componer_dw_interrupciones ()
public function integer of_grabar_ot ()
public function boolean of_comprobar_reapertura (datetime pdt_fecha_sr)
public function integer fnu_valida_cierre_interrupcion (long pl_handle, string ps_fase_afectada)
public subroutine of_validar_fecha_rep (long pl_fila, datawindow pdw_interr, boolean pb_int_en_arbol)
public function integer fnu_valida_interrupcion (long pl_handle, string ps_fase_afectada, ref string ps_fase_permitida, boolean pb_mostrar_ventana)
public function boolean of_comprobar_cierre_maniobras ()
public subroutine of_mostrar_fases_int (ref long pl_fila, string ps_fase_instalacion)
public subroutine fu_perfil_consulta (readonly datawindow adw_dw)
public subroutine of_validaciones_sbt (long al_row, datawindow adw_dw)
public function integer of_afec_parcial (readonly long al_row, datawindow adw_dw, readonly string as_column_name, readonly string as_data)
public function integer f_actualizar_estado ()
public function datetime of_obtener_max_fecha_rep (datetime pdt_fecha1, datetime pdt_fecha2, datetime pdt_fecha3)
public subroutine of_calcular_min_fecha_alta (long pl_fila_int)
public subroutine of_cambiar_f_alta_int (datetime pdt_fec_nueva)
public subroutine fnu_otras_maniobras ()
public function integer fnu_anadir_eb (datetime pdt_f_eb)
public function integer of_interrumpir_fase (boolean pb_fase_a, boolean pb_fase_b, boolean pb_fase_c, integer pi_cbx_pulsado, boolean pb_int_agrupadas, boolean pb_int_en_arbol)
public function datetime fnu_o_primer_aviso (long pl_nro_instalacion, string ps_fase_interrumpida, ref boolean pb_encontrado)
public function integer of_bloquea_interrupciones ()
public function integer fnu_valida_interrupcion_padre (long pl_handle, string ps_fase_afectada, boolean pb_int_agrupadas)
public function integer fw_act_otras_inc (ref long pl_incidencias [])
public subroutine of_pot_interrump_col (datawindow adw_dw)
public subroutine of_suministros_int (ref datawindow adw_dw, long al_row, long pl_codigo)
public function integer fnu_int_comunes (datetime pdt_f_desde, datetime pdt_f_hasta, long pdec_nro_inst)
public function integer fnu_finalizar_descargo ()
public subroutine fw_grabar_eltos_corte ()
public function integer of_marcar_hijos (long pl_handle, boolean pl_bold)
public function boolean fnu_valida_indisponibilidad (long pl_handle)
public function integer of_cargar_indisponibilidad (long pl_nro_instalacion)
public function integer fnu_valida_sr ()
public function integer fw_validacion_fecha_reposicion (datetime pdt_f_reposicion, datetime pdt_f_alta, datetime pdt_f_deteccion)
public function long fw_actualiza_indisponibilidades_maniobra (datastore pds_atributos, datastore pds_indisponibilidades)
public subroutine fw_actualiza_indisponibilidades_maniobra (long pl_cod_maniobra, datastore pds_atributos)
public function long fw_actualiza_indisponibilidades_cierre (datastore pds_atributos, datawindow pdw_indisponibilidades)
public function long fw_actualiza_indisponibilidades_apertura (datastore pds_atributos, datawindow pdw_indisponibilidades)
public function long fw_actualiza_otras_indisp_apertura (datastore pds_atributos, datastore pds_indisponibilidades)
public function long fw_actualiza_otras_indisp_cierre (datastore pds_atributos, datastore pds_indisponibilidades)
public subroutine fw_actualiza_otras_indisponibilidades (long pl_cod_maniobra, datastore pds_atributos)
public function integer of_validarindisponibilidad (long pl_nroincidencia)
public function integer of_validacionessolicitudmant ()
public function boolean frn_evaluo_f_elim_peligro ()
end prototypes

event ue_armar_sql();//  Fecha         Responsable   Actuaci$$HEX1$$f300$$ENDHEX$$n
// ---------    -------         ----------------------------------------
// 23/02/2000     DSA				Introducir las contratas
//
////////////////////////////////////////////////////////////////////////////////////////////////

string ls_select,ls_select_no_disp
string ls_where,ls_where_no_disp, ls_sqlcontratas
string ls_clausula1,ls_clausula2,ls_modificacion1,ls_modificacion2
int li_tipo
string ls_retorno, ls_filtro_ambito_brig, ls_filtro_ambito_cont
Datetime ldt_fecha_turno
long ll_zona, ll_cmd, ll_sector

ls_filtro_ambito_brig=""
ls_filtro_ambito_cont=""
ll_zona = tabpage_ot.dw_ambito.getitemnumber(1,"nro_centro")
ll_cmd = tabpage_ot.dw_ambito.getitemnumber(1,"nro_cmd") 
ll_sector = tabpage_ot.dw_ambito.getitemnumber(1,"nro_mesa")


IF ll_zona > 0 THEN
	ls_filtro_ambito_brig = " AND GI_BRIGADA.NRO_CENTRO = " + string(ll_zona)
	ls_filtro_ambito_cont = " AND GI_CONTRATAS.NRO_CENTRO = " + string(ll_zona)
END IF
IF ll_cmd > 0 THEN
	ls_filtro_ambito_brig = ls_filtro_ambito_brig + " AND GI_BRIGADA.NRO_CMD = " + string(ll_cmd)
	ls_filtro_ambito_cont = ls_filtro_ambito_cont + " AND GI_CONTRATAS.NRO_CMD = " + string(ll_cmd)
END IF
IF ll_sector > 0 THEN
	ls_filtro_ambito_brig = ls_filtro_ambito_brig + " AND GI_BRIGADA.NRO_MESA = " + string(ll_sector)
	ls_filtro_ambito_cont = ls_filtro_ambito_cont + " AND GI_CONTRATAS.NRO_MESA = " + string(ll_sector)
END IF



li_tipo=tabpage_ot.d_crit_seleccion.object.pi_tipo_brig[1]
// DSA INI 23/02/2000
//if tipo_ot = 'CO' THEN
	long 	li_counter = 1;
IF is_sqlcontratas = "" THEN
	is_sqlcontratas = tabpage_ot.dw_lista_contratas.GetSqlSelect()	
END IF

ls_sqlcontratas = is_sqlcontratas
	//No incluir las que estan trabajando
	ls_where =ls_where + ' AND NRO_CONTRATA not in (-1'   
	
	for li_counter	= 1 to tabpage_ot.d_lista_brigadas_ot.RowCount()		
		if tabpage_ot.d_lista_brigadas_ot.object.est_brigada[li_counter] < 3	AND &
			tabpage_ot.d_lista_brigadas_ot.object.tipo[li_counter] = 'Cont.' then // DSA 29/03/2000 			
			ls_where =ls_where + ',' + &
				string(tabpage_ot.d_lista_brigadas_ot.getitemnumber(li_counter,'nro_brigada'))
		end if				
	next
	
	ls_where =ls_where +")" + ls_filtro_ambito_cont
	
	if li_tipo <> 0 then  
		ls_where = ls_where + &
							" AND ( GI_CONTRATAS.TIPO =" + string(li_tipo) + ") "
	end if
		
	ls_where =	tabpage_ot.dw_lista_contratas.Modify('DataWindow.Table.Select="' + ls_sqlcontratas + ls_where + '"')

// DSA FIN 23/02/2000	
//else

// FORMAR ARMAR SQL PARA BRIGADAS DISPONIBLES

ls_select = "SELECT DISTINCT GI_BRIGADA.NOMBRE," + &   
            "GI_BRIGADA.NRO_MESA, " + &
			   "GI_BRIGADA.NRO_CMD, " + &  
            "GI_BRIGADA.NRO_CENTRO, " + &   
            "GI_BRIGADA.IND_DISPONIBLE, "  + &   
            "GI_BRIGADA.MOVIL," + &   
            "GI_BRIGADA.NRO_BRIGADA ," + &   
            "GI_BRIGADA.FREC_RADIO , "+ &   
				"GI_BRIGADA.IND_PREVISTO, "  + & 
				"GI_BRIGADA.TIP_BRIGADA " + &
            " FROM GI_BRIGADA"

ls_where =	" WHERE ( GI_BRIGADA.IND_DISPONIBLE = 1 and GI_BRIGADA.NRO_BRIGADA not in (select nro_brigada from gi_brigada_ot where nro_ot = :pi_nro_ot AND gi_brigada_ot.est_brigada <> 3))"

tabpage_ot.d_crit_seleccion.accepttext()

IF tabpage_ot.d_crit_seleccion.GetItemNumber(1, 'pi_brigadas_en_turno') = 1 THEN
	ldt_fecha_turno = tabpage_ot.d_crit_seleccion.GetItemDatetime(1, 'pdt_fecha_turno')
 
 	ls_select = ls_select + ",GI_BRIGADAS_CAL "
	ls_where = ls_where + " AND GI_BRIGADA.NRO_BRIGADA = GI_BRIGADAS_CAL.NRO_BRIGADA " + &
			 " AND gi_brigadas_cal.fecha_inicio <= TO_DATE('" + String(Date(ldt_fecha_turno)) + "', 'DD/MM/YYYY') " + &
			 " AND gi_brigadas_cal.fecha_fin >= TO_DATE('" + String(Date(ldt_fecha_turno)) + "', 'DD/MM/YYYY') " + &
			 " AND TO_CHAR(gi_brigadas_cal.hora_desde,'HH24:MI:SS') <= TO_CHAR(TO_DATE('" + String(ldt_fecha_turno) + "', 'DD/MM/YYYY HH24:MI:SS'), 'HH24:MI') " + &
			 " AND TO_CHAR(gi_brigadas_cal.hora_hasta,'HH24:MI:SS') >= TO_CHAR(TO_DATE('" + String(ldt_fecha_turno) + "', 'DD/MM/YYYY HH24:MI:SS'), 'HH24:MI') "
END IF			
/////////////////////////////////////////////////////////////

// FORMAR ARMAR SQL PARA BRIGADAS NO DISPONIBLES

ls_select_no_disp= "SELECT DISTINCT GI_BRIGADA.NRO_BRIGADA, " + &  
         			 "GI_BRIGADA.NRO_MESA, " + &   
         			 "GI_BRIGADA.NRO_CMD, " + &   
         			 "GI_BRIGADA.NRO_CENTRO, " + &   
         			 "GI_BRIGADA.IND_DISPONIBLE," + &   
         			 "GI_BRIGADA.MOVIL," + &   
        				 "GI_BRIGADA.NOMBRE," + & 
						 "GI_BRIGADA.TIP_BRIGADA," + & 
        				 "SGD_INCIDENCIA.EST_ACTUAL," + &   
        				 "SGD_INSTALACION.NOM_INSTALACION," + &   
       				 "SGD_INCIDENCIA.CCLI_AFEC," + &   
        				 "GI_BRIGADA_OT.NRO_OT," + &   
        				 "SGD_INCIDENCIA.TIP_INCIDENCIA," + &   
         			 "SGD_INCIDENCIA.NRO_INCIDENCIA," + &   
        				 "SGD_INCIDENCIA.F_DETECCION," + &   
        				 "GI_BRIGADA_OT.F_DESDE," + &   
        				 "GI_BRIGADA.FREC_RADIO," + &   
        				 "GI_OT.NRO_INSTALACION,"  + & 
					 "GI_OT.IND_TRABAJO, " + &
					" FGNU_EST_INC2(	SGD_INCIDENCIA.EST_ACTUAL ,SGD_INCIDENCIA.ALCANCE,SGD_INCIDENCIA.TIP_INCIDENCIA)      est_act, " + &
					" Fgnu_brigada_bitmap(	GI_BRIGADA_OT.NRO_OT, GI_OT.IND_TRABAJO,SGD_INCIDENCIA.NRO_INCIDENCIA ,GI_OT.NRO_INSTALACION , SGD_INCIDENCIA.TIP_INCIDENCIA , SGD_INCIDENCIA.ALCANCE ) bitmap, " +&
					" fgnu_asignacion_ot( gi_ot.nro_aviso , gi_ot.nro_incidencia , gi_ot.nro_instalacion , gi_avisos.nom_calle , gi_avisos.num_puerta , gi_avisos.duplicador , gi_avisos.ref_dir , SGD_INCIDENCIA.desc_incidencia , sgd_instalacion.nom_instalacion ) " +&
					"	FROM " + &
						 " GI_OT, " + &
						 " GI_BRIGADA_OT, " + &
						 " SGD_INSTALACION, " + &
						 " SGD_INCIDENCIA, " + &
						 " GI_BRIGADA, " + &
						 " GI_AVISOS "
							
ls_where_no_disp= " WHERE gi_brigada.nro_brigada = gi_brigada_ot.nro_brigada and " + &
  						" gi_brigada_ot.nro_ot = gi_ot.nro_ot and " + &
						" gi_ot.nro_instalacion = sgd_instalacion.nro_instalacion (+) and " + &
						" gi_ot.nro_ot = SGD_incidencia.ot (+) and " + &
						" gi_brigada_ot.est_brigada = 2 AND " + &
						" ( gi_brigada_ot.f_hasta is Null) AND " + &
						" GI_BRIGADA.IND_DISPONIBLE = 0 AND " + &
						" GI_BRIGADA_OT.EST_BRIGADA <> 3 AND " + &
						" GI_AVISOS.NRO_AVISO(+) = GI_OT.NRO_AVISO "

IF tabpage_ot.d_crit_seleccion.GetItemNumber(1, 'pi_brigadas_en_turno') = 1 THEN
	ls_select_no_disp = ls_select_no_disp + ",GI_BRIGADAS_CAL "
	ls_where_no_disp = ls_where_no_disp + " AND GI_BRIGADA.NRO_BRIGADA = GI_BRIGADAS_CAL.NRO_BRIGADA " + &
			 " AND gi_brigadas_cal.fecha_inicio <= TO_DATE('" + String(Date(ldt_fecha_turno)) + "', 'DD/MM/YYYY') " + &
			 " AND gi_brigadas_cal.fecha_fin >= TO_DATE('" + String(Date(ldt_fecha_turno)) + "', 'DD/MM/YYYY') " + &
			 " AND TO_CHAR(gi_brigadas_cal.hora_desde,'HH24:MI:SS') <= TO_CHAR(TO_DATE('" + String(ldt_fecha_turno) + "', 'DD/MM/YYYY HH24:MI:SS'), 'HH24:MI') " + &
			 " AND TO_CHAR(gi_brigadas_cal.hora_hasta,'HH24:MI:SS') >= TO_CHAR(TO_DATE('" + String(ldt_fecha_turno) + "', 'DD/MM/YYYY HH24:MI:SS'), 'HH24:MI') "
END IF	

//						" GI_BRIGADA.NRO_CENTRO = :pi_centro  AND " + & 
//						" GI_BRIGADA.NRO_MESA = :pi_puesto  AND " + &						
//ls_where_no_disp=ls_where_no_disp + " and sgd_instalacion.bdi_job = 0 " //DBE 11/01/2000
//				
///////////////////////////////////////////////////////


if li_tipo <> 0 then
	ls_where = ls_where + " AND ( GI_BRIGADA.TIP_BRIGADA =" + STRING(LI_TIPO) + ") "
	ls_where_no_disp = ls_where_no_disp + " AND ( GI_BRIGADA.TIP_BRIGADA =" + STRING(LI_TIPO) + ") "
end if

ls_clausula1= ls_select + ls_where + ls_filtro_ambito_brig
ls_clausula2= ls_select_no_disp + ls_where_no_disp + ls_filtro_ambito_brig

ls_modificacion1="Datawindow.table.select=~" "+ls_clausula1 + " ~" "
ls_modificacion2="Datawindow.table.select=~" "+ls_clausula2 + " ~" "

ls_retorno=tabpage_ot.tab_lista_brigadas.tabpage_disponibles.dw_brigadas_disponibles.modify(ls_modificacion1)
ls_retorno=tabpage_ot.tab_lista_brigadas.tabpage_no_disponibles.dw_brigadas_no_disponibles.modify(ls_modificacion2)

ls_retorno=ls_retorno
//end if	
end event

event ue_selecttab;selecttab(index)

return 1
end event

public function string f_devolver_observaciones (ref datawindow pd_dw);//////////////////////////////////////////////////////////
//
// Funci$$HEX1$$f300$$ENDHEX$$n: fnu_devolver_observacion
//
// Objetivo:
//         Retorna campo Observaci$$HEX1$$f300$$ENDHEX$$n
//
// Ambito:  P$$HEX1$$fa00$$ENDHEX$$blico
//
// Par$$HEX1$$e100$$ENDHEX$$metros:
//        Entrada: pd_dw
//        Salida:
//
// Devuelve: 
//
// Fecha                Responsable             Actuaci$$HEX1$$f300$$ENDHEX$$n
// -----                -----------             ---------
//
/////////////////////////////////////////////////////////// 

Return pd_dw.GetItemstring(1,"observacion")
end function

public function integer f_grabar_materiales (long pl_nro_incidencia);string ls_descripcion
long ll_cantidad
int j
datetime ldt_fecha

tabpage_cuadrillas.d_materiales.AcceptText()

ldt_fecha = fgnu_fecha_actual()

FOR j = 1 TO tabpage_cuadrillas.d_materiales.RowCount()
	ls_descripcion = tabpage_cuadrillas.d_materiales.GetItemString(j,"materiales_material")
	ll_cantidad = tabpage_cuadrillas.d_materiales.GetItemNumber(j,"materiales_cantidad")
	IF IsNull(ls_descripcion) THEN
		gnv_msg.f_mensaje("EG05","Materiales","",OK!)
		tabpage_cuadrillas.d_materiales.SetFocus()
		tabpage_cuadrillas.d_materiales.SetColumn("cdescripcion")
		tabpage_cuadrillas.d_materiales.SetRow(j)
		tabpage_cuadrillas.d_materiales.ScrollToRow(j)
		ib_valido_mat = False
		Return -1

	ELSEIF IsNull(ll_cantidad) OR ll_cantidad = 0 THEN
		gnv_msg.f_mensaje("EG05","Cantidad","",OK!)
		tabpage_cuadrillas.d_materiales.SetFocus()
		tabpage_cuadrillas.d_materiales.SetColumn("materiales_cantidad")
		tabpage_cuadrillas.d_materiales.SetRow(j)
		tabpage_cuadrillas.d_materiales.ScrollToRow(j)
		ib_valido_mat = False
		Return -1

	ELSE
		ib_valido_mat = True
	END IF

	tabpage_cuadrillas.d_materiales.SetItem(j,"materiales_material",ls_descripcion)
	tabpage_cuadrillas.d_materiales.SetItem(j,"materiales_nro_incidencia",pl_nro_incidencia)
	tabpage_cuadrillas.d_materiales.SetItem(j,"materiales_usuario",gs_usuario)
	tabpage_cuadrillas.d_materiales.SetItem(j,"materiales_f_actual",ldt_fecha)
	tabpage_cuadrillas.d_materiales.SetItem(j,"materiales_programa","w_2306_cuadr")

NEXT
if tabpage_cuadrillas.d_materiales.RowCount()>0 then
	gi_con_material_averiado = 1
else
	gi_con_material_averiado = 0
end if
//tabpage_cuadrillas.d_materiales.Update()
return 1
end function

public function boolean frn_hab_brigadistas (ref datawindow pd_dw);//////////////////
//	Retorna True si esta en condiciones de mostrar informacion
//	de las brigadas y brigadistas asignados a la incidencia
//
//

if  isnull(pd_dw.getitemnumber(1,"ot")) then 
		Return false
end if 

Return true


end function

public function long f_actualizar_ultima_ot ();/////////////////////////////////////////////////////////////////////
//
// Funcion: fnu_actualizar_ultima_ot
//
// Objetivo: Obtiene la $$HEX1$$fa00$$ENDHEX$$ltima ot y se actualiza el valor
//
// Ambito:   P$$HEX1$$fa00$$ENDHEX$$blico
//
// Par$$HEX1$$e100$$ENDHEX$$metros:
//    Entrada: --
//		Salida : --
//
// Devuelve:
//
// Fecha      Responsable   Actuaci$$HEX1$$f300$$ENDHEX$$n

// ------	   -----------   ---------
//
///////////////////////////////////////////////////////

long ll_nro_ot

//Obtengo la ultima OT y agrego uno al contador de ots

SELECT COD_OT.NEXTVAL
INTO :ll_nro_ot
FROM DUAL;

Return ll_nro_ot

end function

public function integer f_crea_ddw_estado (ref datawindow pd_dw);////////////////////////////////////////////////////////////////////////////////////////////////
//
// Funci$$HEX1$$f300$$ENDHEX$$n: fnu_crea_dddw
// 
// Objetivo: Crea la drop down data window de estado de la orden de trabajo
// Ambito:	P$$HEX1$$fa00$$ENDHEX$$blico
//
// Par$$HEX1$$e100$$ENDHEX$$metros: 



//		Entrada: data window 
//		Salida:   --
//						
// Devuelve:	
//
//  Fecha	  Responsable	Actuaci$$HEX1$$f300$$ENDHEX$$n
// ---------	-------		----------------------------------------
//	30/1/96		SAB			Versi$$HEX1$$f300$$ENDHEX$$n Original
//
////////////////////////////////////////////////////////////////////////////////////////////////

DataWindowChild ddw_Estado					

pd_dw.GetChild('est_ot',ddw_Estado)	//Creo la dropDown de Estado de ot
ddw_Estado.SetTransObject(SQLCA)
ddw_Estado.retrieve()

Return 1
end function

public function integer f_mostrar_datos_ot (ref datawindow pd_dw, long pl_nro_ot);////////////////////////////////////////////////////////////////////////////////////////////////
//
// Funci$$HEX1$$f300$$ENDHEX$$n: fnu_mostrar_datos
// 
// Objetivo: Realiza la conecci$$HEX1$$f300$$ENDHEX$$n con la base de datos y el retrieve 
//				 para mostrar los datos relacionados con los par$$HEX1$$e100$$ENDHEX$$metros 
//				 pasados
//
// Ambito:	P$$HEX1$$fa00$$ENDHEX$$blico
//
// Par$$HEX1$$e100$$ENDHEX$$metros: 
//		Entrada: d_inc_2001_pr_form_orden de trabajo y nro de instalacion 
//		Salida:   --
//						
// Devuelve:	
//
//  Fecha	  Responsable	Actuaci$$HEX1$$f300$$ENDHEX$$n
// ---------	-------		----------------------------------------
//	30/1/96		SAB			Versi$$HEX1$$f300$$ENDHEX$$n Original
//
////////////////////////////////////////////////////////////////////////////////////////////////

long ll_filas

ll_filas=pd_dw.Retrieve(pl_nro_ot)

IF ll_filas=0 THEN
	
	pd_dw.InsertRow(0)
	frn_datos_ot_por_defecto(pd_dw,pl_nro_ot)	

END IF

Return 1

end function

public function integer frn_datos_ot_por_defecto (ref datawindow pd_dw, long pl_nro_ot);////////////////////////////////////////////////////////////////////////////////////////////////
//
// Funci$$HEX1$$f300$$ENDHEX$$n: frn_datos_por_defecto
// 
// Objetivo: Inserta en la datawindow los datos por defecto
//	
// Ambito:	P$$HEX1$$fa00$$ENDHEX$$blico
//
// Par$$HEX1$$e100$$ENDHEX$$metros: 
//		Entrada: datawindow
//					nro_ot
//		Salida:   --
//						
// Devuelve:	
//
//  Fecha	  Responsable	Actuaci$$HEX1$$f300$$ENDHEX$$n
// ---------	-------		----------------------------------------
//	29/1/96		SAB			Versi$$HEX1$$f300$$ENDHEX$$n Original
//
////////////////////////////////////////////////////////////////////////////////////////////////

	pd_dw.SetItem(1,"nro_ot",pl_nro_ot)
	pd_dw.SetItem(1,"est_ot",fgci_ot_pendiente)   

Return 1
end function

public function integer fpr_deshabilitar_lista_brigadas_ot (ref datawindow pd_dw, integer pi_estado);////////////////////////////////////////////////////////////////////////////////////////////////
//
// Funci$$HEX1$$f300$$ENDHEX$$n: frn_deshabilitar
// 
// Objetivo: Seg$$HEX1$$fa00$$ENDHEX$$n un valor pasado por par$$HEX1$$e100$$ENDHEX$$metro, habilita o deshabilita las fechas,
//				 cambiando el color a blanco o gris segun corresponda
//
//	Ambito:	P$$HEX1$$fa00$$ENDHEX$$blico
//
// Par$$HEX1$$e100$$ENDHEX$$metros: 
//		Entrada: datawindow
//					variable que indica si habilita o no
//		Salida:   --
//						
// Devuelve:	
//
//  Fecha	  Responsable	Actuaci$$HEX1$$f300$$ENDHEX$$n
// ---------	-------		----------------------------------------
//	29/2/96		SAB			Versi$$HEX1$$f300$$ENDHEX$$n Original
//
////////////////////////////////////////////////////////////////////////////////////////////////

IF pi_estado=1 THEN
	pd_dw.modify("f_desde.Protect=1")
	pd_dw.modify("f_hasta.Protect=1")
	pd_dw.modify("f_elim_peligro.Protect=1")
// Modificado por Sgo. Unificaci$$HEX1$$f300$$ENDHEX$$n.
//	pd_dw.modify("f_hasta.background.Color ="+string(65536*192+256*192+192))
//	pd_dw.modify("f_desde.background.Color ="+string(65536*192+256*192+192))	
	pd_dw.modify("f_desde.background.Color =" + gs_gris)
	pd_dw.modify("f_hasta.background.Color =" + gs_gris)
	pd_dw.modify("f_elim_peligro.background.Color =" + gs_gris)
// Fin. Sgo.
ELSE
//	pd_dw.modify("f_desde.Protect=0")
//	pd_dw.modify("f_hasta.protect=0")
//	pd_dw.modify("f_elim_peligro.Protect=0")
// Modificado por Sgo. Unificaci$$HEX1$$f300$$ENDHEX$$n.
//	pd_dw.modify("f_desde.background.Color ="+string(65536*255+256*255+255))
//	pd_dw.modify("f_hasta.background.Color ="+string(65536*255+256*255+255))
//	pd_dw.modify("f_desde.background.Color =" + gs_blanco)
//	pd_dw.modify("f_hasta.background.Color =" + gs_blanco)
//	pd_dw.modify("f_elim_peligro.background.Color =" + gs_blanco)
// Fin. Sgo.
	
END IF
Return 1
end function

public function integer f_deshabilitar_datos_ot_2 (ref datawindow pd_dw, integer pi_estado);////////////////////////////////////////////////////////////////////////////////////////////////
//
// Funci$$HEX1$$f300$$ENDHEX$$n: fpr_deshabilitar
// 
// Objetivo: Cambia el color de fondo y pone el taborden de los 
//				 campos habilitados para ingresar datos segun los datos pasados como parametros
//	
// Ambito:	P$$HEX1$$fa00$$ENDHEX$$blico
//
// Par$$HEX1$$e100$$ENDHEX$$metros: 
//		Entrada: datwindow
//					pi_estado(anular_o no
//		Salida:   --
//						
// Devuelve:	
//
//  Fecha	  Responsable	Actuaci$$HEX1$$f300$$ENDHEX$$n
// ---------	-------		----------------------------------------
//	29/1/96		SAB			Versi$$HEX1$$f300$$ENDHEX$$n Original
//
////////////////////////////////////////////////////////////////////////////////////////////////

pd_dw.AcceptText()
IF pi_estado=1 THEN		//deshabilitar
	pd_dw.modify("descripcion.edit.displayonly=yes")
	pd_dw.modify("f_desde.protect=1")
// Modificado por Sgo. Unificaci$$HEX1$$f300$$ENDHEX$$n.
//	pd_dw.modify("descripcion.background.Color ="+string(65536*192+256*192+192))
//	pd_dw.modify("f_desde.background.Color ="+string(65536*192+256*192+192))
	pd_dw.modify("descripcion.background.Color =" + gs_gris)
	pd_dw.modify("f_desde.background.Color =" + gs_gris)
//
ELSE							//habilitar
	pd_dw.modify("descripcion.edit.displayonly=no")
//	pd_dw.modify("f_desde.protect=0")
// Modificado por Sgo. Unificaci$$HEX1$$f300$$ENDHEX$$n.
//	pd_dw.modify("descripcion.background.Color ="+string(65536*255+256*255+255))
//	pd_dw.modify("f_desde.background.Color ="+string(65536*255+256*255+255))
//	pd_dw.modify("descripcion.background.Color =" + gs_blanco)
//	pd_dw.modify("f_desde.background.Color =" + gs_blanco)
// Fin. Sgo.
END IF

return 1
end function

public function boolean frn_existen_brigadas_con_tarea (ref datawindow pd_dw);////////////////////////////////////////////////////////////////////////////////////////////////
//
// Funci$$HEX1$$f300$$ENDHEX$$n: fnu_existen_brigadas_con_tareas
// 
// Objetivo: Retorna True si existe alguna abrigada con fecha de fin de tareas en null
//				 o False en caso contrario.
//	Ambito:	P$$HEX1$$fa00$$ENDHEX$$blico
//
// Par$$HEX1$$e100$$ENDHEX$$metros: 
//		Entrada: data window
//		Salida:   True o False
//						
// Devuelve:	
//
//  Fecha	  Responsable	Actuaci$$HEX1$$f300$$ENDHEX$$n
// ---------	-------		----------------------------------------
//	4/3/96		SAB			Versi$$HEX1$$f300$$ENDHEX$$n Original
//
////////////////////////////////////////////////////////////////////////////////////////////////

long ll_fila

ll_fila=0

ll_fila=pd_dw.find("ISNULL(f_hasta)",0,pd_dw.RowCount())
IF ll_fila=0 THEN
	Return False
ELSE
	Return True
END IF
return true
end function

public function su_drag_brigada_ot f_devolver_brigada_ot (ref datawindow pd_dw, integer pl_click_row);////////////////////////////////////////////////////////////////////////////////////////////////
//
// Funci$$HEX1$$f300$$ENDHEX$$n: fnu_devolver_brigada_ot
// 
// Objetivo: Carga a la estructura con los datos de la fila
//				 seleccionada en la datawindows
//	Ambito:	P$$HEX1$$fa00$$ENDHEX$$blico
//
// Par$$HEX1$$e100$$ENDHEX$$metros: 
//			Entrada: pd_dw, click_row_brig_ot
//			Salida:   --
//						
// Devuelve:	
//
//  Fecha	  Responsable	Actuaci$$HEX1$$f300$$ENDHEX$$n
// ---------	-------		----------------------------------------
//	29/2/96		SAB			Versi$$HEX1$$f300$$ENDHEX$$n Original
//
////////////////////////////////////////////////////////////////////////////////////////////////

su_drag_brigada_ot ls_estructura

IF pl_click_row	>0 THEN
	ls_estructura.click_row=pl_click_row
	ls_estructura.brigada=pd_dw.GetItemString(pl_click_row,"brigada")
	ls_estructura.nro_brigada=pd_dw.GetItemNumber(pl_click_row,"nro_brigada")
	ls_estructura.f_desde=pd_dw.GetItemDateTime(pl_click_row,"f_desde")
	ls_estructura.f_hasta=pd_dw.GetItemDateTime(pl_click_row,"f_hasta")
	
	if pd_dw.dataobject='d_bri_2002_pr_list_brigadas_ot'  then	
		ls_estructura.movil=pd_dw.GetItemString(pl_click_row,"movil")
		ls_estructura.tip_brigada = pd_dw.GetItemNumber(pl_click_row,"tip_brigada")
	else
      ls_estructura.movil=pd_dw.GetItemString(click_row_brig_ot,"telefono")
      ls_estructura.pers_contacta=pd_dw.GetItemString(click_row_brig_ot,"pers_contacto")
      ls_estructura.cantidad_ot=pd_dw.GetItemNumber(click_row_brig_ot,"cantidad_ot")
      ls_estructura.cantidad_tp=pd_dw.GetItemNumber(click_row_brig_ot,"cantidad_tp")		  
      ls_estructura.estado=pd_dw.GetItemNumber(click_row_brig_ot,"gi_contratas_estado")				
   end if 
ELSE
	ls_estructura.click_row=0
END IF
Return ls_estructura

end function

public function integer fnu_agregar_brigada (ref datawindow pd_dw, su_drag_brigada_ot ps_estructura);////////////////////////////////////////////////////////////////////////////////////////////////
//
// Funci$$HEX1$$f300$$ENDHEX$$n: fnu_agregar_brigada
// 
// Objetivo: Inserta los datos en la datawindow pasados en la estructura
//	Ambito:	P$$HEX1$$fa00$$ENDHEX$$blico
//
// Par$$HEX1$$e100$$ENDHEX$$metros: 
//		Entrada: data window
//					estructura
//		Salida:   --
//						
// Devuelve:	
//
//  Fecha	  Responsable	Actuaci$$HEX1$$f300$$ENDHEX$$n


// ---------	-------		----------------------------------------
//	29/2/96		SAB			Versi$$HEX1$$f300$$ENDHEX$$n Original
//
////////////////////////////////////////////////////////////////////////////////////////////////

long ll_row
long ll_encontre


ll_encontre = tabpage_ot.d_lista_brigadas_ot.Find(String("ISNULL(f_hasta)"),0,tabpage_ot.d_lista_brigadas_ot.Rowcount())
ll_row=tabpage_ot.d_lista_brigadas_ot.InsertRow(0)

//Datos de la  brigada
tabpage_ot.d_lista_brigadas_ot.SetItem(ll_row,"brigada",ps_estructura.brigada)
tabpage_ot.d_lista_brigadas_ot.SetItem(ll_row,"nro_ot",ps_estructura.nro_ot)
tabpage_ot.d_lista_brigadas_ot.SetItem(ll_row,"nro_brigada",ps_estructura.nro_brigada)

if tabpage_ot.d_lista_brigadas_ot.dataobject='d_bri_2002_pr_list_brigadas_ot' then//dsa 
		tabpage_ot.d_lista_brigadas_ot.SetItem(ll_row,"movil",ps_estructura.movil)
		tabpage_ot.d_lista_brigadas_ot.SetItem(ll_row,"ind_disponible",1)               //No Disponible
		tabpage_ot.d_lista_brigadas_ot.SetItem(ll_row,"frec_radio",ps_estructura.frec_radio)
		tabpage_ot.d_lista_brigadas_ot.SetItem(ll_row,"h_actual",ps_estructura.h_actual)
		tabpage_ot.d_lista_brigadas_ot.SetItem(ll_row,"h_hasta",ps_estructura.h_hasta)
		tabpage_ot.d_lista_brigadas_ot.SetItem(ll_row,"tip_brigada",ps_estructura.tip_brigada)
		
		IF tabpage_ot.rb_2.checked = True THEN
			tabpage_ot.d_lista_brigadas_ot.SetItem(ll_row,"tipo",'Cont.')
		ELSE
			tabpage_ot.d_lista_brigadas_ot.SetItem(ll_row,"tipo",'Brig.')
		END IF
else
		tabpage_ot.d_lista_brigadas_ot.SetItem(ll_row,"pers_contacto",ps_estructura.pers_contacta)	
		tabpage_ot.d_lista_brigadas_ot.SetItem(ll_row,"telefono",ps_estructura.movil)
		tabpage_ot.d_lista_brigadas_ot.SetItem(ll_row,"cantidad_ot",ps_estructura.cantidad_ot)
		tabpage_ot.d_lista_brigadas_ot.SetItem(ll_row,"cantidad_tp",ps_estructura.cantidad_tp)
		tabpage_ot.d_lista_brigadas_ot.SetItem(ll_row,"gi_contratas_estado",ps_estructura.estado)		
end if

//Datos Brigadas_OT
//NCA-INICIO.DDAG-2482.20150612.La fecha desde la obtenemos de la funcion que trae la fecha actual con segundos.
tabpage_ot.d_lista_brigadas_ot.SetItem(ll_row,"f_desde",fgnu_fecha_actual_con_seg())
//NCA-FIN.DDAG-2482.20150612.
idt_f_actual = fgnu_fecha_actual()
tabpage_ot.d_lista_brigadas_ot.SetItem(ll_row,"usuario",ps_estructura.usuario)
tabpage_ot.d_lista_brigadas_ot.SetItem(ll_row,"f_actual",ps_estructura.f_actual)
tabpage_ot.d_lista_brigadas_ot.SetItem(ll_row,"programa",ps_estructura.programa)
tabpage_ot.d_lista_brigadas_ot.SetItem(ll_row,"nro_ot",ps_estructura.nro_ot)
tabpage_ot.d_lista_brigadas_ot.SetItem(ll_row,"f_hasta",ps_estructura.f_hasta)

tabpage_ot.d_lista_brigadas_ot.AcceptText()

IF tabpage_ot.rb_1.checked = True THEN 
	
	IF tabpage_ot.d_lista_brigadas_ot.Find('ind_responsable = 1 and IsNull(f_hasta)',1,tabpage_ot.d_lista_brigadas_ot.RowCount()) <= 0 THEN
		this.fnu_asignar_responsable(tabpage_ot.d_lista_brigadas_ot,ll_row)
	ELSE
		IF ll_encontre > 0 THEN
			tabpage_ot.d_lista_brigadas_ot.SetItem(ll_row,"ind_responsable",0)
		ELSE
			this.fnu_asignar_responsable(tabpage_ot.d_lista_brigadas_ot,ll_row)
		END IF
	END IF
end if

Return 1
end function

public function integer fnu_asignar_responsable (ref datawindow pd_dw, long pl_click_row);////////////////////////////////////////////////////////////////////////////////////////////////
//
// Funci$$HEX1$$f300$$ENDHEX$$n: fpr_asignar_responsable
// 
// Objetivo: Marca en la datawindow la brigada seleccionada para ser responsable
//				 de las tareas y desmarca la antigua responsable
//	Ambito:	P$$HEX1$$fa00$$ENDHEX$$blico
//
// Par$$HEX1$$e100$$ENDHEX$$metros: 
//		Entrada: data window
//			 		fila en la que se dio el click
//		Salida:   --
//						
// Devuelve:	
//
//  Fecha	  Responsable	Actuaci$$HEX1$$f300$$ENDHEX$$n
// ---------	-------		----------------------------------------
//	29/2/96		SAB			Versi$$HEX1$$f300$$ENDHEX$$n Original
//
////////////////////////////////////////////////////////////////////////////////////////////////

long ll_fila

ll_fila=tabpage_ot.d_lista_brigadas_ot.Find("Ind_responsable = 1",0,tabpage_ot.d_lista_brigadas_ot.RowCount())

IF (ll_fila = 0)  THEN
	tabpage_ot.d_lista_brigadas_ot.SetItem(pl_Click_row,"Ind_responsable",1)
	is_nom_brig_res = tabpage_ot.d_lista_brigadas_ot.GetItemString(pl_click_row,"brigada")
ELSE
	IF ISNULL(pd_dw.GetItemDateTime(pl_click_row,"f_hasta")) THEN
		tabpage_ot.d_lista_brigadas_ot.SetItem(ll_fila,"Ind_responsable",0)
		tabpage_ot.d_lista_brigadas_ot.SetItem(pl_Click_row,"Ind_responsable",1)
		is_nom_brig_res=tabpage_ot.d_lista_brigadas_ot.GetItemString(pl_Click_row,"brigada")
	ELSE
		IF frn_existen_brigadas_con_tarea(pd_dw) THEN
			gnv_msg.f_mensaje("AI05","brigada","",OK!)
		ELSE
			tabpage_ot.d_lista_brigadas_ot.SetItem(ll_fila,"Ind_responsable",0)
			tabpage_ot.d_lista_brigadas_ot.SetItem(pl_Click_row,"Ind_responsable",1)
			is_nom_brig_res=tabpage_ot.d_lista_brigadas_ot.GetItemString(pl_click_row,"brigada")
			END IF
	END IF
END IF

Return 1
end function

public function integer frn_h_seguimiento_segun_perfil (integer pi_incidencia_suministro, ref datawindow d_seguimiento_oper, string ps_accion_llamada);////////////////////////////////////////////////////////////////////////////////////////////////
//
// Funci$$HEX1$$f300$$ENDHEX$$n: frn_seguimiento_segun_perfil
// 
// Objetivo: Habilita seguimiento segun el perfil del usuario
//	Ambito:	P$$HEX1$$fa00$$ENDHEX$$blico
//
// Par$$HEX1$$e100$$ENDHEX$$metros: 
//		Entrada: indicativo de incidencia de suministro
//				datwindow de seguimiento
//		Salida:  --
//						
// Devuelve:	
//
//  Fecha	  Responsable	Actuaci$$HEX1$$f300$$ENDHEX$$n
// ---------	-------		----------------------------------------
//	29/2/96		SAB			Versi$$HEX1$$f300$$ENDHEX$$n Original
//
////////////////////////////////////////////////////////////////////////////////////////////////
//fgnu_tiene_perfil(fgci_perfil_mantenimiento())

IF ps_accion_llamada="Consulta" THEN
	This.frn_habilitar_op(False)
	//This.frn_habilitar_mant(False)	
	Return 1
END IF

IF fgnu_auto_der_oper() AND NOT pi_incidencia_suministro=fgci_incidencia_de_suministro THEN
	This.frn_habilitar_op(False)
	//Si la incidencia no fue derivada a mantenimiento
	//deshabilito a la datwindow
ELSE	
	IF NOT fgnu_auto_der_mant() THEN  
		This.frn_habilitar_op(False)
//		This.frn_habilitar_mant(False)	
	END IF
END IF

IF ii_estado_oper >= fgci_incidencia_resuelta THEN
	// Se comprueba en qu$$HEX2$$e9002000$$ENDHEX$$fila de d_seguimiento_operaciones se encuentra el estado resuelto
	IF NOT ISNULL(tabpage_seguimiento.d_seguimiento_operaciones.GetItemdateTime(ii_incidencia_resuelta,"f_alta")) THEN
		This.frn_habilitar_op(False)
//		This.frn_habilitar_mant(False)	
	END IF
END IF

Return 1
end function

public function boolean frn_valida_fechas_de_derivacion (ref datawindow pd_dw1, ref datawindow pd_dw2);//////////////////////////////////////////////////////////
//
// Funci$$HEX1$$f300$$ENDHEX$$n: frn_valida_fechas_de_derivaci$$HEX1$$f300$$ENDHEX$$n
//
// Objetivo: Valida fechas de derivaci$$HEX1$$f300$$ENDHEX$$n.
//
// Ambito: P$$HEX1$$fa00$$ENDHEX$$blico
//
// Par$$HEX1$$e100$$ENDHEX$$metros:
//        Entrada:pd_dw1, pd_dw2
//        Salida : --
//
// Devuelve: 
//
// Fecha		Responsable		Actuaci$$HEX1$$f300$$ENDHEX$$n
// -----	 	-----------		---------
//
///////////////////////////////////////////////////////////


//long ll_row
//DateTime ld_fecha1,ld_fecha2,ld_fecha3
//
//pd_dw1.AcceptText()	//operaciones
//pd_dw2.AcceptText()	//mantenimiento
//
//ld_fecha1=pd_dw1.getitemdatetime(1,"f_alta") // incidencia pendiente
//ld_fecha2=pd_dw2.getitemdatetime(1,"f_alta") // incidencia sin atender
//
//IF ISNULL(ld_fecha2) THEN
//	return TRUE
//ELSE
//	if ld_fecha1 > ld_fecha2 THEN
//		return false
//	end if
//END IF		
//
//		//fecha de enviada a mantenimiento
//		// Si no se derivo a mantenimiento, retorna true
//ll_row=pd_dw1.Find("ind_env_mant=1",0,pd_dw1.RowCount())
//IF ll_row=0 THEN
//	Return TRUE
//END IF
//
//	//fecha del estado siguiente al que se derivo la incidencia
//ld_fecha1=pd_dw1.GetItemDateTime(ll_Row,"f_alta") 
//
//	// Si se derivo a mantenimiento en un estado menor que servicio repuesto
//	// cargo en la variable auxiliar la fecha del estado siguiente
//	// al que se derivo la incidencia
//IF ll_row + 1 <= fgci_incidencia_resuelta THEN
//	ld_fecha2=pd_dw1.GetItemDateTime(ll_Row+1,"f_alta") 
//ELSE
//	SETNULL(ld_fecha2)
//END IF
//
//	//fecha de entrada a mantenimiento
//ll_row = pd_dw2.Find("ind_env_mant=1",0,pd_dw2.RowCount())
//IF ll_row = 0 THEN
//	gnv_msg.F_mensaje("CI03","","",OK!)	
//	Return False
//END IF
//	// Recogo en ld_fecha3 la fecha de entrada a mantenimiento
//ld_fecha3 = pd_dw2.GetItemDateTime(ll_Row,"f_alta") 
//
//	//si la fecha de operaciones es mayor que la de mantenimiento
//IF ld_fecha1 > ld_fecha3 THEN
//	gnv_msg.f_mensaje("CI03","","",OK!)
//	Return FALSE
//END IF
//
//	//si la fecha de operaciones del estado siguiente al que se derivo
//	// es mayor que el de mantenimiento
//IF NOT ISNULL(ld_fecha2) AND ld_fecha3 > ld_fecha2 THEN
//	gnv_msg.F_mensaje("CI03","","",OK!)
//	Return FALSE
//END IF 
//
Return TRUE
end function

public function integer fnu_quitar_accion (datawindow pd_dw, integer pl_row);/////////////////////////////////////////////////////////////////////
//
// Funcion: fnu_quitar_accion
//
// Objetivo: Obtiene datos si los encuentra, marca y desmarca la fila.
//
// Ambito:   P$$HEX1$$fa00$$ENDHEX$$blico
//
// Par$$HEX1$$e100$$ENDHEX$$metros:
//    Entrada: pd_dw, pl_row
//		Salida : --
//
// Devuelve:
//
// Fecha      Responsable   Actuaci$$HEX1$$f300$$ENDHEX$$n
// ------	  -----------   ---------
//
//
///////////////////////////////////////////////////////


long ll_fila
string ls_obs

ll_fila=pd_dw.RowCount()
IF ll_fila>0 THEN
	pd_dw.Deleterow(pl_row)
	IF ll_fila=1  THEN
			Return 1
	END IF
	if pd_dw.rowcount() > 0 then 
	pd_dw.SelectRow(0,False)
	pd_dw.SelectRow(1,True)
end if 

	
END IF
return 1
end function

public function integer fnu_devolver_obs_accion (ref datawindow pd_dw, multilineedit mle_obs_accion, long pl_row_inc);////////////////////////////////////////////////////////////////////////////////////////////////
//
// Funci$$HEX1$$f300$$ENDHEX$$n: fnu_devolver_obs_accion
// 
// Objetivo: Inserta en la datawindow de lista de incidencia la 
//				observacion de la accion y la fecha y hora de alta. 
//	Ambito:	P$$HEX1$$fa00$$ENDHEX$$blico
//
// Par$$HEX1$$e100$$ENDHEX$$metros: 
//		Entrada: pd_dw, mle_obs_accion, pl_row_inc
//		Salida:  --
//						
// Devuelve:	
//
//  Fecha	  Responsable	Actuaci$$HEX1$$f300$$ENDHEX$$n
// ---------	-------		----------------------------------------
//	29/2/96		SAB			Versi$$HEX1$$f300$$ENDHEX$$n Original
//
////////////////////////////////////////////////////////////////////////////////////////////////
pd_dw.SetItem(pl_row_inc,"observacion",mle_obs_accion.text)
pd_dw.SetItem(pl_row_inc,"f_actual",fgnu_fecha_actual())
pd_dw.SetItem(pl_row_inc,"h_actual",fgnu_fecha_actual())
pd_dw.SetItem(pl_row_inc,"usuario",gs_usuario)
pd_dw.AcceptText()

Return 1
end function

public function integer fnu_devolver_brigada_resp (ref datawindow pd_dw);///////////////////////////////////////////////////////////////////////////////////
//
// Funci$$HEX1$$f300$$ENDHEX$$n: fnu_devolver_brigada_resp
// 
// Objetivo: Retorna el nro de la brigada responsable
//				
//	Ambito:	P$$HEX1$$fa00$$ENDHEX$$blico
//
// Par$$HEX1$$e100$$ENDHEX$$metros: 

//			Entrada: data window
//			Salida:  nro de la brigada responsable o -1 en caso de que tendria
//						que tener brigada responsable y no la tuviera o 0 en caso
//						que no tenga brigadas asignadas
//						
// Devuelve:	
//
//  Fecha	  Responsable	Actuaci$$HEX1$$f300$$ENDHEX$$n
// ---------	-------		----------------------------------------
//	29/2/96		SAB			Versi$$HEX1$$f300$$ENDHEX$$n Original
//	26/8/97		AFS			Modificada para cargar la fecha de EB
///////////////////////////////////////////////////////////////////////////////////

long ll_fila
datetime ldt_fecha_menor = DateTime(Date('2999/01/01'),Time('12:00:00'))
int li_total_filas, li_cont

pd_dw.AcceptText()

li_total_filas = pd_dw.RowCount()

IF li_total_filas > 0 THEN
	// Obtengo la fecha de EB
	FOR li_cont = 1 TO li_total_filas
		
		IF pd_dw.GetItemDateTime(li_cont,"f_desde") < ldt_fecha_menor and not isnull(pd_dw.GetItemDateTime(li_cont,"f_desde")) THEN
			ldt_fecha_menor = pd_dw.GetItemDateTime(li_cont,"f_desde")
			idt_fecha_eb = ldt_fecha_menor
		END IF
	NEXT

	if ldt_fecha_menor = DateTime(Date('2999/01/01'),Time('12:00:00')) then
				setnull(ldt_fecha_menor)
	end if	

	// Obtengo la brigada responsable
	ll_fila = pd_dw.Find("ind_responsable=1",1,li_total_filas)
	IF ll_fila>0 THEN
			ii_brigada_resp= pd_dw.GetItemNumber(ll_fila,"nro_brigada")
			// Asigno la fecha de EB
			idt_fecha_eb = ldt_fecha_menor
			return ii_brigada_resp
	ELSE
		ll_fila = pd_dw.Find("tipo = 'Brig.' and isnull(f_hasta)",1,li_total_filas)
		IF ll_fila > 0 THEN
			Return -1
		ELSE
			IF pd_dw.Find("tipo = 'Cont.' and isnull(f_hasta)",1,li_total_filas) > 0 THEN
				idt_fecha_eb = ldt_fecha_menor
				return 0
			END IF
		END IF
	END IF
		
	return 0
ELSE
	return 0
END IF

end function

public function long f_devolver_primer_aviso (ref datawindow pd_dw);//////////////
//
//	Retorna el primer aviso asociado a la incidencia
//
/////////////

Return pd_dw.GetItemNumber(1,"primer_aviso")
end function

public function integer frn_habilitar_obs_accion (boolean pb_habilitar);////////////////////////////////////////////////////////////////////////
//
// Funci$$HEX1$$f300$$ENDHEX$$n: frn_habilita_obs_accion
// 
// Objetivo: Habilita o Deshabilita el MultiLineEdit
//	Ambito:	P$$HEX1$$fa00$$ENDHEX$$blico
//
// Par$$HEX1$$e100$$ENDHEX$$metros: 
//		Entrada: pb_habilitar
//		Salida:   --
//						
// Devuelve:	
//
//  Fecha	  Responsable	Actuaci$$HEX1$$f300$$ENDHEX$$n
// ---------	-------		----------------------------------------
//	29/2/96		SAB			Versi$$HEX1$$f300$$ENDHEX$$n Original
//
///////////////////////////////////////////////////////////////////////

IF pb_habilitar THEN
//	tabpage_acciones.mle_observacion_accion_incidencia.enabled = true
	tabpage_acciones.mle_observacion_accion_incidencia.DisplayOnly=false
	tabpage_acciones.mle_observacion_accion_incidencia.backcolor = long(gs_blanco)
ELSE
//	tabpage_acciones.mle_observacion_accion_incidencia.enabled = false
	tabpage_acciones.mle_observacion_accion_incidencia.DisplayOnly=true
	tabpage_acciones.mle_observacion_accion_incidencia.backcolor = long(gs_gris)
END IF

Return 1
end function

public function integer fnu_agregar_accion (ref datawindow pd_dw, integer pi_nro_accion, string ps_descripcion, long pl_nro_incidencia, boolean pb_usuario_mant);/////////////////////////////////////////////////////////////////////
//
// Funcion: fnu_agregar_accion
//
// Objetivo: Setea los datos de la datawindow seg$$HEX1$$fa00$$ENDHEX$$n los par$$HEX1$$e100$$ENDHEX$$metros recibidos.
//
// Ambito:   P$$HEX1$$fa00$$ENDHEX$$blico
//
// Par$$HEX1$$e100$$ENDHEX$$metros:
//    Entrada: pd_dw, pi_nro_accion, ps_descripcion, pl_nro_incidencia,
//             pl_row
//		Salida : --
//
// Devuelve:
//
// Fecha      Responsable   Actuaci$$HEX1$$f300$$ENDHEX$$n
// ------	   -----------   ---------
//
//
///////////////////////////////////////////////////////

long ll_cant_filas, ll_fila

ll_fila = pd_dw.InsertRow(0)
pd_dw.SetItem(ll_fila,"nro_incidencia",pl_nro_incidencia)
pd_dw.SetItem(ll_fila,"usuario",gs_usuario)
pd_dw.SetItem(ll_fila,"f_actual",fgnu_fecha_actual())
pd_dw.SetItem(ll_fila,"h_actual",fgnu_fecha_actual())
pd_dw.SetItem(ll_fila,"programa","fnu_agr")
pd_dw.SetItem(ll_fila,"f_alta",fgcd_fecha_con_seg())
pd_dw.SetItem(ll_fila,"cod_accion",pi_nro_accion)
pd_dw.SetItem(ll_fila,"accion",ps_descripcion)
pd_dw.SetItem(ll_fila,"observacion"," ")
if pb_usuario_mant=true THEN
	pd_dw.SetItem(ll_fila,"accion_inc_tip_accion",gi_usuario_mant)
ELSE
	pd_dw.SetItem(ll_fila,"accion_inc_tip_accion",gi_usuario_oper)
END IF

return ll_fila
end function

public function integer fnu_obte_estados_oper ();////////////////////////////////////////////////////////////////////////////////////////////////
//
// Funci$$HEX1$$f300$$ENDHEX$$n: fnu_obte_estados_oper
// 
// Objetivo: 
//	Ambito:	P$$HEX1$$fa00$$ENDHEX$$blico
//
// Par$$HEX1$$e100$$ENDHEX$$metros: 
//			Entrada: --
//						
//			Salida:   --
//						
// Devuelve:	
//
//  Fecha	  Responsable	Actuaci$$HEX1$$f300$$ENDHEX$$n
// ---------	-------		----------------------------------------
//	29/2/96		SAB			Versi$$HEX1$$f300$$ENDHEX$$n Original
//	07/03/00      FDO			Inc. Calidad
////////////////////////////////////////////////////////////////////////////////////////////////

long ll_contador,ll_row_est_inc,ll_tope,ll_cont_estados_oper,ll_nro_descargo
string ls_estado, rc, mod_string, ls_select, ls_est_oper, ls_estado_rs
datetime ldt_nula
setnull(ldt_nula)
boolean 	lb_hayEb
int	li_numeroReg			//N$$HEX1$$fa00$$ENDHEX$$mero de registros que recupera la consulta del programa que ha generado el descargo en el caso de las incidencias programadas.


li_numeroReg = 0

// recupero los estados normales de operaciones.

ls_est_oper="'E_OP'"

IF is_tipo_ventana <> "w_2301_hist" THEN		 
	if gb_mantenimiento = true then
	
		ls_select ="SELECT DISTINCT SGD_VALOR.VALOR, SGD_ESTADO_OPER.H_ALTA, SGD_ESTADO_OPER.F_ALTA, SGD_ESTADO_OPER.OBSERVACION, " + &
					  "SGD_ESTADO_OPER.COD_ESTADO, SGD_ESTADO_OPER.USUARIO, SGD_ESTADO_OPER.F_ACTUAL, SGD_ESTADO_OPER.H_ACTUAL, " + &
					  "SGD_ESTADO_OPER.PROGRAMA, SGD_ESTADO_OPER.NRO_INCIDENCIA, SGD_ESTADO_OPER.IND_ENV_MANT " + &
					  "FROM SGD_ESTADO_OPER, SGD_VALOR " + &
					  "WHERE SGD_ESTADO_OPER.COD_ESTADO = SGD_VALOR.CODIGO and SGD_VALOR.CODIF = " + ls_est_oper + " and " + &
					  "SGD_ESTADO_OPER.NRO_INCIDENCIA = :pi_nro_incidencia and SGD_ESTADO_OPER.COD_ESTADO <> 99 and " + &
					  "SGD_ESTADO_OPER.COD_ESTADO < 8 "
	
	else
		
		ls_select ="SELECT DISTINCT SGD_VALOR.VALOR, SGD_ESTADO_OPER.H_ALTA, SGD_ESTADO_OPER.F_ALTA, SGD_ESTADO_OPER.OBSERVACION, " + &
					  "SGD_ESTADO_OPER.COD_ESTADO, SGD_ESTADO_OPER.USUARIO, SGD_ESTADO_OPER.F_ACTUAL, SGD_ESTADO_OPER.H_ACTUAL, " + &
					  "SGD_ESTADO_OPER.PROGRAMA, SGD_ESTADO_OPER.NRO_INCIDENCIA, SGD_ESTADO_OPER.IND_ENV_MANT " + &
					  "FROM SGD_ESTADO_OPER, SGD_VALOR " + &
					  "WHERE SGD_ESTADO_OPER.COD_ESTADO = SGD_VALOR.CODIGO and SGD_VALOR.CODIF = " + ls_est_oper + " and " + &
					  "SGD_ESTADO_OPER.NRO_INCIDENCIA = :pi_nro_incidencia and SGD_ESTADO_OPER.COD_ESTADO <> 99 " 
					  //+ &
					  //"SGD_ESTADO_OPER.COD_ESTADO < 7 "
	
		
	end if
	
	//ACO-DESCARGOS
	
	IF ii_tipo_incid = fgci_incidencia_programada THEN
		 
		 SELECT NVL("SGD_DESCARGOS"."IND_ACT_GRAFICA" ,0),nro_descargo
		 INTO :ii_ind_act_grafica ,:ll_nro_descargo 
		 FROM "SGD_DESCARGOS"  
		WHERE "SGD_DESCARGOS"."NRO_INCIDENCIA" = :il_nro_incidencia   ;

		select count(*) 
		into :ii_cant_trabajos 
		from sgd_trabajos_bdi 
		where nro_descargo = :ll_nro_descargo;		
		
//		if li_ind_act_grafica =1 then
//			ii_ind_Act_grafica = 1
//			ls_select ="SELECT DISTINCT SGD_VALOR.VALOR, SGD_ESTADO_OPER.H_ALTA, SGD_ESTADO_OPER.F_ALTA, SGD_ESTADO_OPER.OBSERVACION, " + &
//					  "SGD_ESTADO_OPER.COD_ESTADO, SGD_ESTADO_OPER.USUARIO, SGD_ESTADO_OPER.F_ACTUAL, SGD_ESTADO_OPER.H_ACTUAL, " + &
//					  "SGD_ESTADO_OPER.PROGRAMA, SGD_ESTADO_OPER.NRO_INCIDENCIA, SGD_ESTADO_OPER.IND_ENV_MANT " + &
//					  "FROM SGD_ESTADO_OPER, SGD_VALOR " + &
//					  "WHERE SGD_ESTADO_OPER.COD_ESTADO = SGD_VALOR.CODIGO and SGD_VALOR.CODIF = " + ls_est_oper + " and " + &
//					  "SGD_ESTADO_OPER.NRO_INCIDENCIA = :pi_nro_incidencia and SGD_ESTADO_OPER.COD_ESTADO <> 99 and " + &
//					  "(SGD_ESTADO_OPER.COD_ESTADO < 7 	OR  SGD_ESTADO_OPER.COD_ESTADO =" + string( fgci_incidencia_pte_explotacion)+")"
//		end if

END IF

	ls_select = ls_select + " ORDER BY SGD_ESTADO_OPER.F_ALTA, SGD_ESTADO_OPER.COD_ESTADO ASC"
	
	mod_string = "DataWindow.Table.Select=~" " + ls_select + "~""
	
	rc = tabpage_seguimiento.d_seguimiento_operaciones.Modify(mod_string)
	
	IF rc <> "" THEN
		MessageBox("Status", "Modify Failed" + rc)
		return 0
	END IF
END IF

ll_row_est_inc=tabpage_seguimiento.d_seguimiento_operaciones.Retrieve(il_nro_incidencia)

IF is_tipo_ventana = "w_2301_hist" THEN		 
	// La ventana de hist$$HEX1$$f300$$ENDHEX$$ricos no ordena en la SELECT, por lo que hay que ordenar despu$$HEX1$$e900$$ENDHEX$$s
	tabpage_seguimiento.d_seguimiento_operaciones.SetSort('f_alta A, est_oper A')
	tabpage_seguimiento.d_seguimiento_operaciones.Sort()
END IF

//actualizo los registros faltantes para completar la data window de est de la inc.
//se tiene que obtener los datos de memoria para cada estado sup al obtenido de la bd.

ll_row_est_inc++

IF (ll_row_est_inc > fgci_incidencia_enviado_brigada AND &
	ii_incidencia_enviado_brigada = 0 AND ii_tipo_incid= fgci_incidencia_imprevista) and &
	tabpage_seguimiento.d_estados_operaciones.object.cod_estado[fgci_incidencia_enviado_brigada] = fgci_incidencia_enviado_brigada THEN

	tabpage_seguimiento.d_estados_operaciones.SetFilter("cod_estado <> " + string(fgci_incidencia_enviado_brigada))
	tabpage_seguimiento.d_estados_operaciones.Filter()
	
ELSEif ii_incidencia_enviado_brigada = 2 then 

	tabpage_seguimiento.d_estados_operaciones.SetFilter("")
	tabpage_seguimiento.d_estados_operaciones.Filter()	
	
	tabpage_seguimiento.d_estados_operaciones.setsort("cod_estado")
	tabpage_seguimiento.d_estados_operaciones.sort()
END IF

//AHM (04/11/2011) Integraci$$HEX1$$f300$$ENDHEX$$n OSGI - OSGM
//Obtenemos si el descargo ha sido generado por OSGM
//IF gb_interfaseOsgm THEN
//	SELECT count(*)
//	INTO	 :li_numeroReg
//	FROM   sgd_estados_descargo
//	WHERE  UPPER(programa) = 'W_SGM_DESCARGO'
//			 AND estado = 1
//			 AND nro_descargo = :ll_nro_descargo;
//END IF

IF ii_tipo_incid = fgci_incidencia_programada and ((ii_ind_Act_grafica = 1 and ii_cant_trabajos = 0 and ii_pe = 0) OR li_numeroReg = 1) then 
	tabpage_seguimiento.d_estados_operaciones.SetFilter("cod_estado <> " + string(fgci_incidencia_pte_explotacion))
	tabpage_seguimiento.d_estados_operaciones.Filter()
end if

ll_cont_estados_oper = tabpage_seguimiento.d_estados_operaciones.RowCount()

//AHM (07/02/2011) ASUR 919288
//FOR ll_contador = ll_row_est_inc TO ll_cont_estados_oper
ll_contador = ll_row_est_inc
DO WHILE ll_contador <= ll_cont_estados_oper

	IF (ll_contador <> ii_incidencia_pte_pta_explotacion or ii_eliminar_pe = 1) THEN //AND ((ll_row_est_inc - 1 >= 2) AND tabpage_seguimiento.d_estados_operaciones.find("cod_estado = 2", 1, tabpage_seguimiento.d_estados_operaciones.rowcount()) = 0) 
		// si se elimina el estado pe hay que meter el estado RS.
		tabpage_seguimiento.d_seguimiento_operaciones.InsertRow(0)
	end if

	ls_estado=tabpage_seguimiento.d_estados_operaciones.GetItemString(ll_contador,"nomenclatura")
	tabpage_seguimiento.d_seguimiento_operaciones.SetItem(ll_contador,"nomenclatura",ls_estado)
	
	CHOOSE CASE ll_contador
			
		case  ii_incidencia_pte_pta_explotacion // PTE PUESTA EXPLOTACION
			
			//tabpage_seguimiento.d_seguimiento_operaciones.deleterow(0)
			if ii_eliminar_pe = 1 then
				tabpage_seguimiento.d_seguimiento_operaciones.SetItem(ll_contador,"usuario",gs_usuario)
				tabpage_seguimiento.d_seguimiento_operaciones.SetItem(ll_contador,"f_actual",fgnu_fecha_actual())
				tabpage_seguimiento.d_seguimiento_operaciones.SetItem(ll_contador,"h_actual",fgnu_fecha_actual())
				tabpage_seguimiento.d_seguimiento_operaciones.SetItem(ll_contador,"programa","iw_2301")
				tabpage_seguimiento.d_seguimiento_operaciones.SetItem(ll_contador,"est_oper",fgci_incidencia_resuelta)
				tabpage_seguimiento.d_seguimiento_operaciones.SetItem(ll_contador,"f_alta",idt_fecha_sr)
				tabpage_seguimiento.d_seguimiento_operaciones.SetItem(ll_contador,"h_alta",idt_fecha_sr)
				tabpage_seguimiento.d_seguimiento_operaciones.SetItem(ll_contador,"nro_incidencia",il_nro_incidencia)
				tabpage_seguimiento.d_seguimiento_operaciones.SetItem(ll_contador,"ind_env_mant",0) 		//no enviado
			end if
						
	
		CASE 	ii_incidencia_pendiente  //PT

			tabpage_seguimiento.d_seguimiento_operaciones.SetItem(ll_contador,"usuario",gs_usuario)
			tabpage_seguimiento.d_seguimiento_operaciones.SetItem(ll_contador,"f_actual",fgnu_fecha_actual())
			tabpage_seguimiento.d_seguimiento_operaciones.SetItem(ll_contador,"h_actual",fgnu_fecha_actual())
			tabpage_seguimiento.d_seguimiento_operaciones.SetItem(ll_contador,"f_alta", idt_fec_deteccion)
			//tabpage_seguimiento.d_seguimiento_operaciones.SetItem(ll_contador,"f_alta", Datetime(Date(idt_fec_deteccion),Time(String(Time(idt_fec_deteccion), "hh:mm"))))
			tabpage_seguimiento.d_seguimiento_operaciones.SetItem(ll_contador,"h_alta",idt_fec_deteccion)
			tabpage_seguimiento.d_seguimiento_operaciones.SetItem(ll_contador,"programa","iw_2301")
			tabpage_seguimiento.d_seguimiento_operaciones.SetItem(ll_contador,"est_oper",fgci_incidencia_pendiente)
			tabpage_seguimiento.d_seguimiento_operaciones.SetItem(ll_contador,"nro_incidencia",il_nro_incidencia)
			tabpage_seguimiento.d_seguimiento_operaciones.SetItem(ll_contador,"ind_env_mant",0) 		//no enviado
			
		CASE  ii_incidencia_enviado_brigada //EB
			
			tabpage_seguimiento.d_seguimiento_operaciones.SetItem(ll_contador,"usuario",gs_usuario)
			tabpage_seguimiento.d_seguimiento_operaciones.SetItem(ll_contador,"f_actual",fgnu_fecha_actual())
			tabpage_seguimiento.d_seguimiento_operaciones.SetItem(ll_contador,"h_actual",fgnu_fecha_actual())
			tabpage_seguimiento.d_seguimiento_operaciones.SetItem(ll_contador,"f_alta",idt_fecha_eb)
			tabpage_seguimiento.d_seguimiento_operaciones.SetItem(ll_contador,"h_alta",idt_fecha_eb)
			tabpage_seguimiento.d_seguimiento_operaciones.SetItem(ll_contador,"programa","iw_2301")
			tabpage_seguimiento.d_seguimiento_operaciones.SetItem(ll_contador,"est_oper",fgci_incidencia_enviado_brigada)
			tabpage_seguimiento.d_seguimiento_operaciones.SetItem(ll_contador,"nro_incidencia",il_nro_incidencia)
			tabpage_seguimiento.d_seguimiento_operaciones.SetItem(ll_contador,"ind_env_mant",0) 		//no enviado


		CASE  ii_incidencia_en_reposicion  //ER
			
			tabpage_seguimiento.d_seguimiento_operaciones.SetItem(ll_contador,"usuario",gs_usuario)
			tabpage_seguimiento.d_seguimiento_operaciones.SetItem(ll_contador,"f_actual",fgnu_fecha_actual())
			tabpage_seguimiento.d_seguimiento_operaciones.SetItem(ll_contador,"h_actual",fgnu_fecha_actual())
			//tabpage_seguimiento.d_seguimiento_operaciones.SetItem(ll_contador,"f_alta",idt_fecha_er)
			//tabpage_seguimiento.d_seguimiento_operaciones.SetItem(ll_contador,"h_alta",idt_fecha_er)
			tabpage_seguimiento.d_seguimiento_operaciones.SetItem(ll_contador,"programa","iw_2301")
//			IF ii_tipo_incid = fgci_incidencia_calidad  &
//				OR	ii_alcance = fgci_incidencia_de_suministro &
//				OR	ii_alcance = fgci_incidencia_sin_interrupcion THEN
//				
//				tabpage_seguimiento.d_seguimiento_operaciones.SetItem(ll_contador,"est_oper",fgci_incidencia_servicio_repuesto)
//				tabpage_seguimiento.d_seguimiento_operaciones.SetItem(ll_contador,"f_alta",idt_fecha_sr)
//				tabpage_seguimiento.d_seguimiento_operaciones.SetItem(ll_contador,"h_alta",idt_fecha_sr)
//			ELSE
				tabpage_seguimiento.d_seguimiento_operaciones.SetItem(ll_contador,"est_oper",fgci_incidencia_en_reposicion)
				tabpage_seguimiento.d_seguimiento_operaciones.SetItem(ll_contador,"f_alta",idt_fecha_er)
				tabpage_seguimiento.d_seguimiento_operaciones.SetItem(ll_contador,"h_alta",idt_fecha_er)
//			END IF
			
			tabpage_seguimiento.d_seguimiento_operaciones.SetItem(ll_contador,"nro_incidencia",il_nro_incidencia)
			tabpage_seguimiento.d_seguimiento_operaciones.SetItem(ll_contador,"ind_env_mant",0) 		//no enviado
						
		CASE  ii_incidencia_servicio_repuesto  //SR

			tabpage_seguimiento.d_seguimiento_operaciones.SetItem(ll_contador,"usuario",gs_usuario)
			tabpage_seguimiento.d_seguimiento_operaciones.SetItem(ll_contador,"f_actual",fgnu_fecha_actual())
			tabpage_seguimiento.d_seguimiento_operaciones.SetItem(ll_contador,"h_actual",fgnu_fecha_actual())
			tabpage_seguimiento.d_seguimiento_operaciones.SetItem(ll_contador,"programa","iw_2301")
			tabpage_seguimiento.d_seguimiento_operaciones.SetItem(ll_contador,"est_oper",fgci_incidencia_servicio_repuesto)
			tabpage_seguimiento.d_seguimiento_operaciones.SetItem(ll_contador,"f_alta",idt_fecha_sr)
			tabpage_seguimiento.d_seguimiento_operaciones.SetItem(ll_contador,"h_alta",idt_fecha_sr)
			tabpage_seguimiento.d_seguimiento_operaciones.SetItem(ll_contador,"nro_incidencia",il_nro_incidencia)
			tabpage_seguimiento.d_seguimiento_operaciones.SetItem(ll_contador,"ind_env_mant",0) 		//no enviado
						
		CASE  ii_incidencia_resuelta //RS
			
			// En caso de que tenga trabajo de BDI cambiamos el orden de la fila metiendo primero PE
			if (ii_ind_Act_grafica = 1 and ii_cant_trabajos > 0) or ii_pe > 0 then 

				// DATOS DE PE1
				// El estado RS es el anterior
				if ll_row_est_inc<>ll_cont_estados_oper and li_numeroReg = 0 then 
					ll_contador --
					ls_estado_rs=tabpage_seguimiento.d_estados_operaciones.GetItemString(ll_contador ,"nomenclatura")
					ls_estado=tabpage_seguimiento.d_estados_operaciones.GetItemString(ll_contador + 1 ,"nomenclatura")
					tabpage_seguimiento.d_seguimiento_operaciones.SetItem(ll_contador,"nomenclatura",ls_estado)
					tabpage_seguimiento.d_seguimiento_operaciones.SetItem(ll_contador,"usuario",gs_usuario)
					tabpage_seguimiento.d_seguimiento_operaciones.SetItem(ll_contador,"f_actual",fgnu_fecha_actual())
					tabpage_seguimiento.d_seguimiento_operaciones.SetItem(ll_contador,"h_actual",fgnu_fecha_actual())
					tabpage_seguimiento.d_seguimiento_operaciones.SetItem(ll_contador,"f_alta", idt_fecha_pt_pex)
					tabpage_seguimiento.d_seguimiento_operaciones.SetItem(ll_contador,"h_alta", idt_fecha_pt_pex)
					tabpage_seguimiento.d_seguimiento_operaciones.SetItem(ll_contador,"programa","iw_2301")
					tabpage_seguimiento.d_seguimiento_operaciones.SetItem(ll_contador,"est_oper",fgci_incidencia_pte_explotacion)
					tabpage_seguimiento.d_seguimiento_operaciones.SetItem(ll_contador,"nro_incidencia",il_nro_incidencia)
					tabpage_seguimiento.d_seguimiento_operaciones.SetItem(ll_contador,"ind_env_mant",0) 		//no enviado
					
					ll_Contador ++
					tabpage_seguimiento.d_seguimiento_operaciones.InsertRow(0)
					tabpage_seguimiento.d_seguimiento_operaciones.SetItem(ll_contador,"nomenclatura",ls_estado_rs)
				 else
					tabpage_seguimiento.d_seguimiento_operaciones.SetItem(ll_contador,"nomenclatura","RS")
				end if
			end if
				tabpage_seguimiento.d_seguimiento_operaciones.SetItem(ll_contador,"usuario",gs_usuario)
				tabpage_seguimiento.d_seguimiento_operaciones.SetItem(ll_contador,"f_actual",fgnu_fecha_actual())
				tabpage_seguimiento.d_seguimiento_operaciones.SetItem(ll_contador,"h_actual",fgnu_fecha_actual())
				if ii_estado_oper=fgci_incidencia_pte_explotacion then 
					tabpage_seguimiento.d_seguimiento_operaciones.SetItem(ll_contador,"f_alta",ldt_nula)
					tabpage_seguimiento.d_seguimiento_operaciones.SetItem(ll_contador,"h_alta",ldt_nula)
				else
					tabpage_seguimiento.d_seguimiento_operaciones.SetItem(ll_contador,"f_alta",idt_fecha_resuelta)
					tabpage_seguimiento.d_seguimiento_operaciones.SetItem(ll_contador,"h_alta",idt_fecha_resuelta)
				end if
				tabpage_seguimiento.d_seguimiento_operaciones.SetItem(ll_contador,"programa","iw_2301")
				tabpage_seguimiento.d_seguimiento_operaciones.SetItem(ll_contador,"est_oper",fgci_incidencia_resuelta)
				tabpage_seguimiento.d_seguimiento_operaciones.SetItem(ll_contador,"nro_incidencia",il_nro_incidencia)
				tabpage_seguimiento.d_seguimiento_operaciones.SetItem(ll_contador,"ind_env_mant",0) 		//no enviado
					
		CASE  ii_incidencia_cerrada //CE

			tabpage_seguimiento.d_seguimiento_operaciones.SetItem(ll_contador,"usuario",gs_usuario)
			tabpage_seguimiento.d_seguimiento_operaciones.SetItem(ll_contador,"f_actual",fgnu_fecha_actual())
			tabpage_seguimiento.d_seguimiento_operaciones.SetItem(ll_contador,"h_actual",fgnu_fecha_actual())
			tabpage_seguimiento.d_seguimiento_operaciones.SetItem(ll_contador,"f_alta",idt_fecha_resuelta)
			tabpage_seguimiento.d_seguimiento_operaciones.SetItem(ll_contador,"h_alta",idt_fecha_resuelta)
			tabpage_seguimiento.d_seguimiento_operaciones.SetItem(ll_contador,"programa","iw_2301")
			tabpage_seguimiento.d_seguimiento_operaciones.SetItem(ll_contador,"est_oper",fgci_incidencia_cerrada)
			tabpage_seguimiento.d_seguimiento_operaciones.SetItem(ll_contador,"nro_incidencia",il_nro_incidencia)
			tabpage_seguimiento.d_seguimiento_operaciones.SetItem(ll_contador,"ind_env_mant",0) 		//no enviado
	
	END CHOOSE
	
//NEXT
	ll_contador++
	
	//AHM (07/02/2011) ASUR 919288
	IF ((ll_row_est_inc - 1 > 2) AND tabpage_seguimiento.d_seguimiento_operaciones.find("est_oper = 2", 1, tabpage_seguimiento.d_estados_operaciones.rowcount()) = 0) THEN
		ll_contador++
	END IF
	
LOOP
	tabpage_seguimiento.d_seguimiento_operaciones.AcceptText()
		
Return 1
end function

public function boolean frn_evaluo_f_deteccion (datetime pdt_fec_nueva, datetime pdt_fec_vieja);//////////////////////////////////////////////////////////
//
// Funci$$HEX1$$f300$$ENDHEX$$n: frn_evaluo_f_deteccion
//
// Objetivo: Evalua fecha de detecci$$HEX1$$f300$$ENDHEX$$n.
//
// Ambito: P$$HEX1$$fa00$$ENDHEX$$blico
//
// Par$$HEX1$$e100$$ENDHEX$$metros:
//        Entrada: pd_dw, pdt_fec_ant
//        Salida : --
//
// Devuelve: 
//
// Fecha		Responsable		Actuaci$$HEX1$$f300$$ENDHEX$$n
// -----	 	-----------		---------
//
///////////////////////////////////////////////////////////

// LA FECHA ANTERIOR PARA DEJARLA COMO ESTABA EN CASO DE ERROR				
DateTime ldt_f_nula
string lss

// SI LA INCIDENCIA ES PROGRAMADA
IF tabpage_formulario.d_inf_general.getitemnumber(1,"Tipo_incidencia")=fgci_incidencia_programada THEN

	//SI LA FECHA DE DETECCION ES MENOR QUE LA FECHA ACTUAL MENSAJE

	IF pdt_fec_nueva > fgnu_fecha_actual() THEN
		gnv_msg.f_mensaje("AI55","","",OK!)
		tabpage_formulario.d_inf_general.SetItem(1,"f_deteccion",pdt_fec_vieja)
		tabpage_formulario.d_inf_general.Accepttext()
		RETURN FALSE
	END IF

	//   SI LA INCIDENCIA YA TIENE UNA ORDEN DE TRABAJO
	IF ii_estado_oper > fgci_incidencia_pendiente THEN  // SI EXISTE ORDEN DE TRABAJO


			
		// SI LA FECHA DE DETECCION DE LA INCIDENCIAS ES MAYOR QUE LA FECHA DE LA ORDEN , MENSAJE
				
		IF idt_fecha_eb < pdt_fec_nueva THEN
			gnv_msg.f_mensaje("AI61","","",OK!)







			tabpage_formulario.d_inf_general.setitem(1,"f_deteccion",pdt_fec_vieja)
			tabpage_formulario.d_inf_general.accepttext()

















			RETURN FALSE
		END IF
	END IF

ELSE   // SI LA INCIDENCIA ES IMPREVISTA O DE CALIDAD
	//*******************************************
	//**  OSGI 2002.1  	07/08/2002				 **
	//**  Jair Padilla / Soluziona PANAMA  	 **
	//**  PM001 RESTRICCION N DIAS ANTIG$$HEX1$$dc00$$ENDHEX$$EDAD  **
	//*******************************************
	If Not IsNull(pdt_fec_nueva) And IsDate(String(Date(pdt_fec_nueva))) Then
		Integer li_dias_antig
	
		SELECT Trunc(((SYSDATE - :pdt_fec_nueva)), 0) INTO :li_dias_antig FROM dual where rownum = 1 ;
	
		If ( li_dias_antig >= gi_dias_antiguedad And gi_dias_antiguedad > 0 And gb_inc_antig And Not IsNull(li_dias_antig) ) Then
			MessageBox("Atenci$$HEX1$$f300$$ENDHEX$$n", "No se pueden gestionar incidencias con una fecha de detecci$$HEX1$$f300$$ENDHEX$$n menor o igual a " + String(gi_dias_antiguedad) + " d$$HEX1$$ed00$$ENDHEX$$as.")

			tabpage_formulario.d_inf_general.setitem(1,"f_deteccion", pdt_fec_vieja)
			tabpage_formulario.d_inf_general.Accepttext()
			ib_error_fec_deteccion = True
			RETURN FALSE
		End If
	End If
	//*******************************************
	//**  OSGI 2002.1  	07/08/2002				 **
	//**  Jair Padilla / Soluziona PANAMA  	 **
	//**  PM001 RESTRICCION N DIAS ANTIG$$HEX1$$dc00$$ENDHEX$$EDAD  **
	//*******************************************

	// SI LA FECHA DE DETECCION DE LA INCIDENCIAS ES MAYOR QUE LA FECHA ACTUAL, MENSAJE

	IF pdt_fec_nueva > fgnu_fecha_actual() THEN
//		gnv_msg.f_mensaje("AI54","","",OK!)
		messagebox("Atenci$$HEX1$$f300$$ENDHEX$$n","La fecha de deteccion no puede ser mayor a la del d$$HEX1$$ed00$$ENDHEX$$a")
		tabpage_formulario.d_inf_general.setitem(1,"f_deteccion",pdt_fec_vieja)
		tabpage_formulario.d_inf_general.Accepttext()
		RETURN FALSE
	END IF

END IF

// SI LA FECHA DE DETECCION ES MAYOR QUE LA FECHA DE ESTIMACION, MENSAJE

IF ldt_f_nula <> idt_fec_est_res AND pdt_fec_nueva > idt_fec_est_res THEN
	gnv_msg.f_mensaje("AI60","","",OK!)
	tabpage_formulario.d_inf_general.setitem(1,"f_deteccion",pdt_fec_vieja)
	tabpage_formulario.d_inf_general.Accepttext()
	RETURN FALSE
END IF

// SI LA INCIDENCIA , YA TIENE UNA ORDEN DE TRABAJO GENERADA

IF ii_estado_oper > fgci_incidencia_pendiente THEN  // SI EXISTE ORDEN DE TRABAJO
	// SI LA FECHA DE LA ORDEN ES MENOR QUE LA FECHA DE DETECCION, MENSAJE
	IF idt_fecha_eb < pdt_fec_nueva THEN
		gnv_msg.f_mensaje("AI61","","",OK!)
		tabpage_formulario.d_inf_general.setitem(1,"f_deteccion",pdt_fec_vieja)
		tabpage_formulario.d_inf_general.accepttext()
		RETURN FALSE
	END IF
END IF

lss = "( (not isNull(f_reposicion)) and f_alta < TO_DATE('" + String(pdt_fec_nueva) + "', 'DD/MM/YYYY HH24:MI:SS')) OR " +&
												"( (not isNull(f_reposicion_fase_a)) and f_alta_fase_a < TO_DATE('" + String(pdt_fec_nueva) + "', 'DD/MM/YYYY HH24:MI:SS')) OR " +&
												"( (not isNull(f_reposicion_fase_b)) and f_alta_fase_b < TO_DATE('" + String(pdt_fec_nueva) + "', 'DD/MM/YYYY HH24:MI:SS')) OR " +&
												"( (not isNull(f_reposicion_fase_c)) and f_alta_fase_c < TO_DATE('" + String(pdt_fec_nueva) + "', 'DD/MM/YYYY HH24:MI:SS'))" 

IF tabpage_interrupciones.d_datos_interrup.find("( (not isNull(f_reposicion)) and f_alta < datetime('" + String(pdt_fec_nueva) + "')) OR " +&
												"( (not isNull(f_reposicion_fase_a)) and f_alta_fase_a < datetime('" + String(pdt_fec_nueva) + "')) OR " +&
												"( (not isNull(f_reposicion_fase_b)) and f_alta_fase_b < datetime('" + String(pdt_fec_nueva) + "')) OR " +&
												"( (not isNull(f_reposicion_fase_c)) and f_alta_fase_c < datetime('" + String(pdt_fec_nueva) + "')) ", 1, tabpage_interrupciones.d_datos_interrup.RowCount()) > 0 THEN

	messagebox("Error","La Fecha de Detecci$$HEX1$$f300$$ENDHEX$$n no puede ser mayor que la fecha de alta una interrupci$$HEX1$$f300$$ENDHEX$$n ya resuelta de una instalaci$$HEX1$$f300$$ENDHEX$$n")
	tabpage_formulario.d_inf_general.setitem(1,"f_deteccion",pdt_fec_vieja)
	tabpage_formulario.d_inf_general.accepttext()
	RETURN FALSE
END IF

IF tabpage_interrupciones.d_datos_interrup.find("(f_alta < datetime('" + String(pdt_fec_nueva) + "')) OR " +&
												"( f_alta_fase_a < datetime('" + String(pdt_fec_nueva) + "')) OR " +&
												"( f_alta_fase_b < datetime('" + String(pdt_fec_nueva) + "')) OR " +&
												"( f_alta_fase_c < datetime('" + String(pdt_fec_nueva) + "')) ", 1, tabpage_interrupciones.d_datos_interrup.RowCount()) > 0 THEN
	
	IF Messagebox("Atenci$$HEX1$$f300$$ENDHEX$$n", "Existen interrupciones definidas cuya fecha de alta es inferior a la nueva fecha de detecci$$HEX1$$f300$$ENDHEX$$n. El sistema cambiar$$HEX2$$e1002000$$ENDHEX$$estas fechas de alta por la nueva fecha de detecci$$HEX1$$f300$$ENDHEX$$n, pero es posible que al grabar la incidencia se desasocien avisos. $$HEX1$$bf00$$ENDHEX$$Desea continuar", Question!, YesNo!) = 2 THEN
		tabpage_formulario.d_inf_general.setitem(1,"f_deteccion",pdt_fec_vieja)
		tabpage_formulario.d_inf_general.accepttext()
		RETURN FALSE
	ELSE
		// Se pone como la fecha de detecci$$HEX1$$f300$$ENDHEX$$n como fecha de alta de las interrupciones 
		// cuya fecha de alta sea menor que nueva fecha de detecci$$HEX1$$f300$$ENDHEX$$n

		of_cambiar_f_alta_int(pdt_fec_nueva)
	END IF
END IF
													
IF pdt_fec_nueva <> DateTime(Date("01/01/1900")) THEN
	idt_fec_deteccion = pdt_fec_nueva
END IF

RETURN TRUE
end function

public function integer fnu_obte_estados_mant ();//////////////////////////////////////////////////////////////////////////////////////////////////
////
//// Funci$$HEX1$$f300$$ENDHEX$$n: fnu_obte_estados_mant
//// 
//// Objetivo: 
////	Ambito:	P$$HEX1$$fa00$$ENDHEX$$blico
////
//// Par$$HEX1$$e100$$ENDHEX$$metros: 
////			Entrada: --
////						
////			Salida:   --
////						
//// Devuelve:	
////
////  Fecha	  Responsable	Actuaci$$HEX1$$f300$$ENDHEX$$n
//// ---------	-------		----------------------------------------
////	29/2/96		SAB			Versi$$HEX1$$f300$$ENDHEX$$n Original
////
//////////////////////////////////////////////////////////////////////////////////////////////////
//
//long ll_contador,ll_row_est_inc,ll_tope,ll_cont_estados_mant
//string ls_estado
//
////tabpage_seguimiento.d_seguimiento_mantenimiento.SetTransObject(SQLCA)
//ll_row_est_inc=tabpage_seguimiento.d_seguimiento_mantenimiento.Retrieve(il_nro_incidencia)
//
////actualizo los registros faltantes para completar la data window de est de la inc.
////se tiene que obtener los datos de memoria para cada estado sup al obtenido de la bd.
//ll_row_est_inc++
//ll_cont_estados_mant = tabpage_seguimiento.d_estados_mantenimientos.RowCount()
//
//FOR ll_contador=ll_row_est_inc TO ll_cont_estados_mant
//
//	tabpage_seguimiento.d_seguimiento_mantenimiento.InsertRow(0)
//	ls_estado=tabpage_seguimiento.d_estados_mantenimientos.GetItemString(ll_contador,"nomenclatura")
//	tabpage_seguimiento.d_seguimiento_mantenimiento.SetItem(ll_contador,"nomenclatura",ls_estado)
//
//	CHOOSE CASE ll_contador
//	
//		CASE 	fgci_incidencia_mant_sin_atender  //ST
//
//			tabpage_seguimiento.d_seguimiento_mantenimiento.SetItem(ll_contador,"usuario",gs_usuario)
//			tabpage_seguimiento.d_seguimiento_mantenimiento.SetItem(ll_contador,"f_actual",fgnu_fecha_actual())
//			tabpage_seguimiento.d_seguimiento_mantenimiento.SetItem(ll_contador,"h_actual",fgnu_fecha_actual())
//			tabpage_seguimiento.d_seguimiento_mantenimiento.SetItem(ll_contador,"f_alta",idt_fecha_st_mant)
//			tabpage_seguimiento.d_seguimiento_mantenimiento.SetItem(ll_contador,"h_alta",idt_fecha_st_mant)
//			tabpage_seguimiento.d_seguimiento_mantenimiento.SetItem(ll_contador,"programa","iw_2301")
//			tabpage_seguimiento.d_seguimiento_mantenimiento.SetItem(ll_contador,"est_mant",fgci_incidencia_mant_sin_atender)
//			tabpage_seguimiento.d_seguimiento_mantenimiento.SetItem(ll_contador,"nro_incidencia",il_nro_incidencia)
//			tabpage_seguimiento.d_seguimiento_mantenimiento.SetItem(ll_contador,"ind_env_mant",0) 		//no enviado
//			
//		CASE  fgci_incidencia_mant_enviado_brigada //EB
//			tabpage_seguimiento.d_seguimiento_mantenimiento.SetItem(ll_contador,"usuario",gs_usuario)
//			tabpage_seguimiento.d_seguimiento_mantenimiento.SetItem(ll_contador,"f_actual",fgnu_fecha_actual())
//			tabpage_seguimiento.d_seguimiento_mantenimiento.SetItem(ll_contador,"h_actual",fgnu_fecha_actual())
//			tabpage_seguimiento.d_seguimiento_mantenimiento.SetItem(ll_contador,"f_alta",idt_fecha_eb_mant)
//			tabpage_seguimiento.d_seguimiento_mantenimiento.SetItem(ll_contador,"h_alta",idt_fecha_eb_mant)
//			tabpage_seguimiento.d_seguimiento_mantenimiento.SetItem(ll_contador,"programa","iw_2301")
//			tabpage_seguimiento.d_seguimiento_mantenimiento.SetItem(ll_contador,"est_mant",fgci_incidencia_mant_enviado_brigada)
//			tabpage_seguimiento.d_seguimiento_mantenimiento.SetItem(ll_contador,"nro_incidencia",il_nro_incidencia)
//			tabpage_seguimiento.d_seguimiento_mantenimiento.SetItem(ll_contador,"ind_env_mant",0) 		//no enviado
//
//		CASE  fgci_incidencia_mant_averia_localizada //AL
//			tabpage_seguimiento.d_seguimiento_mantenimiento.SetItem(ll_contador,"usuario",gs_usuario)
//			tabpage_seguimiento.d_seguimiento_mantenimiento.SetItem(ll_contador,"f_actual",fgnu_fecha_actual())
//			tabpage_seguimiento.d_seguimiento_mantenimiento.SetItem(ll_contador,"h_actual",fgnu_fecha_actual())
//			tabpage_seguimiento.d_seguimiento_mantenimiento.SetItem(ll_contador,"f_alta",idt_fecha_al_mant)
//			tabpage_seguimiento.d_seguimiento_mantenimiento.SetItem(ll_contador,"h_alta",idt_fecha_al_mant)
//			tabpage_seguimiento.d_seguimiento_mantenimiento.SetItem(ll_contador,"programa","iw_2301")
//			tabpage_seguimiento.d_seguimiento_mantenimiento.SetItem(ll_contador,"est_mant",fgci_incidencia_mant_averia_localizada)
//			tabpage_seguimiento.d_seguimiento_mantenimiento.SetItem(ll_contador,"nro_incidencia",il_nro_incidencia)
//			tabpage_seguimiento.d_seguimiento_mantenimiento.SetItem(ll_contador,"ind_env_mant",0) 		//no enviado
//		
//		CASE  fgci_incidencia_mant_reparando //RP
//			tabpage_seguimiento.d_seguimiento_mantenimiento.SetItem(ll_contador,"usuario",gs_usuario)
//			tabpage_seguimiento.d_seguimiento_mantenimiento.SetItem(ll_contador,"f_actual",fgnu_fecha_actual())
//			tabpage_seguimiento.d_seguimiento_mantenimiento.SetItem(ll_contador,"h_actual",fgnu_fecha_actual())
//			tabpage_seguimiento.d_seguimiento_mantenimiento.SetItem(ll_contador,"f_alta",idt_fecha_rp_mant)
//			tabpage_seguimiento.d_seguimiento_mantenimiento.SetItem(ll_contador,"h_alta",idt_fecha_rp_mant)
//			tabpage_seguimiento.d_seguimiento_mantenimiento.SetItem(ll_contador,"programa","iw_2301")
//			tabpage_seguimiento.d_seguimiento_mantenimiento.SetItem(ll_contador,"est_mant",fgci_incidencia_mant_reparando)
//			tabpage_seguimiento.d_seguimiento_mantenimiento.SetItem(ll_contador,"nro_incidencia",il_nro_incidencia)
//			tabpage_seguimiento.d_seguimiento_mantenimiento.SetItem(ll_contador,"ind_env_mant",0) 		//no enviado
//		
//		CASE  fgci_incidencia_mant_para_resolucion  //PR
//			tabpage_seguimiento.d_seguimiento_mantenimiento.SetItem(ll_contador,"usuario",gs_usuario)
//			tabpage_seguimiento.d_seguimiento_mantenimiento.SetItem(ll_contador,"f_actual",fgnu_fecha_actual())
//			tabpage_seguimiento.d_seguimiento_mantenimiento.SetItem(ll_contador,"h_actual",fgnu_fecha_actual())
//			tabpage_seguimiento.d_seguimiento_mantenimiento.SetItem(ll_contador,"f_alta",idt_fecha_pr_mant)
//			tabpage_seguimiento.d_seguimiento_mantenimiento.SetItem(ll_contador,"h_alta",idt_fecha_pr_mant)
//			tabpage_seguimiento.d_seguimiento_mantenimiento.SetItem(ll_contador,"programa","iw_2301")
//			tabpage_seguimiento.d_seguimiento_mantenimiento.SetItem(ll_contador,"est_mant",fgci_incidencia_mant_para_resolucion)
//			tabpage_seguimiento.d_seguimiento_mantenimiento.SetItem(ll_contador,"nro_incidencia",il_nro_incidencia)
//			tabpage_seguimiento.d_seguimiento_mantenimiento.SetItem(ll_contador,"ind_env_mant",0) 		//no enviado
//			
//		CASE  fgci_incidencia_mant_resuelta_mant  //RM
//			tabpage_seguimiento.d_seguimiento_mantenimiento.SetItem(ll_contador,"usuario",gs_usuario)
//			tabpage_seguimiento.d_seguimiento_mantenimiento.SetItem(ll_contador,"f_actual",fgnu_fecha_actual())
//			tabpage_seguimiento.d_seguimiento_mantenimiento.SetItem(ll_contador,"h_actual",fgnu_fecha_actual())
//			tabpage_seguimiento.d_seguimiento_mantenimiento.SetItem(ll_contador,"f_alta",idt_fecha_rm_mant)
//			tabpage_seguimiento.d_seguimiento_mantenimiento.SetItem(ll_contador,"h_alta",idt_fecha_rm_mant)
//			tabpage_seguimiento.d_seguimiento_mantenimiento.SetItem(ll_contador,"programa","iw_2301")
//			tabpage_seguimiento.d_seguimiento_mantenimiento.SetItem(ll_contador,"est_mant",fgci_incidencia_mant_resuelta_mant)
//			tabpage_seguimiento.d_seguimiento_mantenimiento.SetItem(ll_contador,"nro_incidencia",il_nro_incidencia)
//			tabpage_seguimiento.d_seguimiento_mantenimiento.SetItem(ll_contador,"ind_env_mant",0) 		//no enviado
//		
//					
//	END CHOOSE
//	
//NEXT
//	tabpage_seguimiento.d_seguimiento_mantenimiento.AcceptText()
//		
Return 1

end function

public function long fnu_actualizar_ultima_inc ();////////////////////////////////////////////////////////////////////////////////////////////////
//
// Funci$$HEX1$$f300$$ENDHEX$$n: fnu_actualizar_ultima_inc
// 
// Objetivo: Incrementa en uno el nro de la ultima incidencia que se dio de alta
//      
// Ambito:      P$$HEX1$$fa00$$ENDHEX$$blico
//
// Par$$HEX1$$e100$$ENDHEX$$metros: 
//              Entrada: --
//              Salida:  --
//                                              
//
//  Fecha         Responsable   Actuaci$$HEX1$$f300$$ENDHEX$$n
// ---------    -------         ----------------------------------------
//      13/2/96         SAB                     Versi$$HEX1$$f300$$ENDHEX$$n Original
//
////////////////////////////////////////////////////////////////////////////////////////////////

long ll_nro_inc

//Obtengo la ultima Incidencia
SELECT COD_INCIDENCIA.NEXTVAL
INTO :ll_nro_inc
FROM DUAL;
	
 
Return ll_nro_inc
end function

public function boolean frn_v_fechas (ref datawindow pd_dw);/////////////////////////////////////////////////////////////////////
//
// Funcion: frn_v_fechas
//
// Objetivo: Valida la correlatividad de las fechas
//
// Ambito:   P$$HEX1$$fa00$$ENDHEX$$blico
//
// Par$$HEX1$$e100$$ENDHEX$$metros:
//    Entrada: pd_dw
//		Salida : --
//
// Devuelve:
//
// Fecha      Responsable   Actuaci$$HEX1$$f300$$ENDHEX$$n
// ------	   -----------   ---------
//
//
///////////////////////////////////////////////////////

long ll_contador
DateTime ld_fec_estado1,ld_fec_estado2
datetime ldt_f_actual
Boolean lb_valida
string ls_estado1,ls_estado2

lb_valida=True
ll_contador=1 
pd_dw.AcceptText()
ldt_f_actual = fgnu_fecha_actual()

DO WHILE ll_contador < pd_dw.RowCount()
	ld_fec_estado1=pd_dw.GetItemDateTime(ll_contador,"f_alta")
	ld_fec_estado2=pd_dw.GetItemDateTime(ll_contador+1,"f_alta")

		//Controla la correlatividad de las fechas

//NCA-INICIO.DDAG-2482.20150610.Agrego los segundos a los formatos de fechas.
	IF Datetime(string(ld_fec_estado1, 'dd/mm/yyyy hh:mm:ss')) > Datetime(string(ld_fec_estado2, 'dd/mm/yyyy hh:mm:ss')) AND NOT ISNULL(ld_fec_estado2) THEN
//NCA-FIN.DDAG-2482.20150610.
		ls_estado1 = pd_dw.GetItemString(ll_contador,"nomenclatura")
		ls_estado2 = pd_dw.GetItemString(ll_contador+1,"nomenclatura")
		lb_valida = False
		gnv_msg.f_mensaje("CI02",ls_estado1,ls_estado2,OK!)
		Exit
	END IF
	If ISNULL(ld_fec_estado1) and NOT ISNULL(ld_fec_estado2) THEN
		lb_valida=False
		ls_estado1=pd_dw.GetItemString(ll_contador,"nomenclatura")
		ls_estado2=pd_dw.GetItemString(ll_contador+1,"nomenclatura")
		gnv_msg.F_mensaje("CI02",ls_estado1,ls_estado2,OK!)
		Exit
	END IF
	
	//	Valida que las fechas no pueda ser mayores al d$$HEX1$$ed00$$ENDHEX$$a de la fecha
	IF ld_fec_estado2 > ldt_f_actual THEN
		lb_valida=False
		gnv_msg.F_mensaje("EI24","","",OK!)
		EXIT
	END IF
	
	ll_contador++							
LOOP

Return lb_valida 

end function

public function boolean frn_validar_estado_pr (ref datawindow pd_dw, boolean pb_resuelve_mant);/////////////////////////////////////////////////////////////////////

//
// Funcion: frn_validar_estado_pr
//
// Objetivo: Valida estados de presentaci$$HEX1$$f300$$ENDHEX$$n
//
// Ambito:   P$$HEX1$$fa00$$ENDHEX$$blico
//
// Par$$HEX1$$e100$$ENDHEX$$metros:
//    Entrada: pd_dw, pi_resuelve_mant
//		Salida : --
//
// Devuelve:
//
// Fecha      Responsable   Actuaci$$HEX1$$f300$$ENDHEX$$n

// ------	   -----------   ---------
//
//
///////////////////////////////////////////////////////

//long ll_row

//

//IF NOT pb_resuelve_mant THEN
//	ll_row=pd_dw.Find("nomenclatura='gs_nomenclatura_pr'",0,pd_dw.RowCount())
//	IF ll_row > 0 THEN
//		IF ISNULL(pd_dw.GetItemDateTime(ll_row,"f_alta")) THEN
//			gnv_msg.F_mensaje("CI13","","",OK!)
//			Return False
//		END IF	
//	END IF
//END IF
//
Return True
end function

public function boolean frn_validar_salida_mant (ref datawindow pd_dw, ref datawindow pd_dw2, integer pl_click_row, integer pi_estado_mant);////////////////////////////////////////////////////////////////////////////////////////////////
//
// Funci$$HEX1$$f300$$ENDHEX$$n: frn_validar_salida_mant

// 
// Objetivo: Valida que pueda enviarse a mantenimiento
//	Ambito:	 P$$HEX1$$fa00$$ENDHEX$$blico
//
// Par$$HEX1$$e100$$ENDHEX$$metros: 
//		Entrada: data window
//				
//		Salida:   TRUE Valida
//					 FALSE No valida		
// Devuelve:	
//
//  Fecha	  Responsable	Actuaci$$HEX1$$f300$$ENDHEX$$n
// ---------	-------		----------------------------------------
//	29/2/96		SAB			Versi$$HEX1$$f300$$ENDHEX$$n Original
//
///////////////////////////////////////////////////////////////////////////////////////////////

//datetime ld_f_alta
//long ll_row 
//string ls_obs
//
////this.acceptText()		
//
//		//Valida las fechas 
//IF NOT this.frn_v_fechas(pd_dw2) THEN
//	Return False
//END IF
//
//			//Control de que el usuario tenga permiso
//ld_f_alta=pd_dw2.GetItemdatetime(2,"f_alta")
//IF NOT ISNULL(ld_f_alta) THEN 
//	IF NOT (fgnu_auto_der_oper()) THEN          // gl_perfil<>gl_perfil_mantenimiento THEN
//		gnv_msg.f_mensaje("EG18","","",OK!)
//		Return FALSE //NO Valida
//	END IF
//END IF
//
//				//Control de que no exista una derivacion previa
//ll_row = pd_dw2.find("ind_env_mant = "+string(fgci_entrada)+" OR ind_env_mant=3",0,pd_dw2.rowCount())
//IF ll_row<>0 THEN
//	gnv_msg.f_mensaje("AI07","","",OK!)
//	Return FALSE //no valida
//END IF
//
//
Return TRUE // valida
end function

public function integer frn_habilita_resuelve_mant ();////////////////////////////////////////////////////////////////////////////////////
//
// Funci$$HEX1$$f300$$ENDHEX$$n: frn_habilita_resuelve_mant
// 
// Objetivo: Marca el CheckBox de resuelve mantenimiento y 
//				 habilita o deshabilita si el estado es mayor que CL en operaciones,
//				 y menor que pr en mantenimiento.
//
//	Ambito:	P$$HEX1$$fa00$$ENDHEX$$blico
//
// Par$$HEX1$$e100$$ENDHEX$$metros: 
//	Entrada: CheckBox
//				marcar o desmarcar
//				si resuelve mantenimiento 0 o 1
//	Salida:   --
//						
// Devuelve:	
//
//  Fecha	  Responsable	Actuaci$$HEX1$$f300$$ENDHEX$$n
// ---------	-------		----------------------------------------
//	29/2/96		SAB			Versi$$HEX1$$f300$$ENDHEX$$n Original
//
//////////////////////////////////////////////////////////////////////////////////

//marco el check box segun indicativo de resolver_mantenimiento
//IF ii_resuelve_mant=1 THEN
//	tabpage_seguimiento.chk_resolucion_mant.Checked = TRUE
//ELSE
//	tabpage_seguimiento.chk_resolucion_mant.Checked = FALSE
//END IF
//
//IF is_accion_llamada="Consulta" THEN
//	tabpage_seguimiento.chk_resolucion_mant.Enabled=FALSE
//	Return 1
//END IF
//
//			// habilito 
//IF fgnu_auto_der_mant() AND &
//	ii_estado_mant>=fgci_incidencia_mant_sin_atender AND &
//	ii_estado_mant<fgci_incidencia_mant_para_resolucion	THEN
//
//	tabpage_seguimiento.chk_resolucion_mant.Enabled=TRUE
//ELSE
//
//	tabpage_seguimiento.chk_resolucion_mant.Enabled=FALSE
//END IF

Return 1


end function

public function boolean fnu_env_operaciones ();////////////////////////////////////////////////////////////////////////////////////////////////
//
// Funci$$HEX1$$f300$$ENDHEX$$n: fnu_env_operaciones
// 
// Objetivo: Retorna, si retorno de mantenimiento a operaciones 
//	Ambito:	P$$HEX1$$fa00$$ENDHEX$$blico



//
// Par$$HEX1$$e100$$ENDHEX$$metros: 
//		Entrada: Data window
//					marcar o desmarcar
//		Salida:   --
//						
// Devuelve:	
//
//  Fecha	  Responsable	Actuaci$$HEX1$$f300$$ENDHEX$$n
// ---------	-------		----------------------------------------
//	29/2/96		SAB			Versi$$HEX1$$f300$$ENDHEX$$n Original
//

////////////////////////////////////////////////////////////////////////////////////////////////





long ll_row

ll_row=tabpage_seguimiento.d_seguimiento_mantenimiento.Find("ind_env_mant= 2",0,tabpage_seguimiento.d_seguimiento_mantenimiento.RowCount()) 
IF ll_row=0 THEN
	return  False  //NO se retorno a operaciones
ELSE
	return True	//se retorno a operaciones
END IF
end function

public function boolean fnu_fecha_solo_en_st ();/////////////////////////////////////////////////////////////////////
//
// Funcion: fnu_fecha_solo_en_st
//
// Objetivo: Obtengo fecha de alta si la encuentro
//
// Ambito:   P$$HEX1$$fa00$$ENDHEX$$blico
//
// Par$$HEX1$$e100$$ENDHEX$$metros:
//    Entrada: pd_dw
//		Salida : --
//
// Devuelve:
//
// Fecha      Responsable   Actuaci$$HEX1$$f300$$ENDHEX$$n
// ------	   -----------   ---------
//
//
///////////////////////////////////////////////////////

boolean lb_no_encontre
//long ll_contador
//
//lb_no_encontre=true
//FOR ll_contador=2 TO tabpage_seguimiento.d_seguimiento_mantenimiento.RowCount()
//	IF NOT ISNULL(tabpage_seguimiento.d_seguimiento_mantenimiento.GetItemDateTime(ll_contador,"f_alta")) THEN
//		lb_no_encontre=False
//	END IF
//NEXT
//
Return lb_no_encontre
end function

public function boolean frn_validar_salida_oper (long pl_click_row);////////////////////////////////////////////////////////////////////////////////////////////////
//
// Funci$$HEX1$$f300$$ENDHEX$$n: frn_validar_salida_oper
// 
// Objetivo: Valida que pueda enviarse a mantenimiento
//	Ambito:	P$$HEX1$$fa00$$ENDHEX$$blico
//
// Par$$HEX1$$e100$$ENDHEX$$metros: 
//		Entrada: data window
//				
//		Salida:   1 Valida
//					 2 No valida		
// Devuelve:	
//
//  Fecha	  Responsable	Actuaci$$HEX1$$f300$$ENDHEX$$n
// ---------	-------		----------------------------------------
//	29/2/96		SAB			Versi$$HEX1$$f300$$ENDHEX$$n Original
//
////////////////////////////////////////////////////////////////////////////////////////////////


long ll_row

		//Valiida las fechas 
IF NOT this.frn_v_fechas(tabpage_seguimiento.d_seguimiento_operaciones) THEN
	Return FALSE
END IF
			
		//valida el perfil de usuario
IF NOT fgnu_auto_der_mant() THEN
	gnv_msg.f_mensaje("EG18","","",OK!)
	Return FALSE
END IF

					//valida que no fuese dragueado previamente
ll_row = tabpage_seguimiento.d_seguimiento_operaciones.find("ind_env_mant = "+string(fgci_salida),0,tabpage_seguimiento.d_seguimiento_operaciones.rowCount())
IF ll_row<>0 THEN
	gnv_msg.f_mensaje("AI07","","",OK!)
	Return FALSE //no valida
END IF
		
			//valida el estado en que se deriva
ll_row=tabpage_seguimiento.d_estados_operaciones.Find("nomenclatura= 'CL'",0,tabpage_seguimiento.d_estados_operaciones.rowcount())
IF pl_click_row <> ll_row THEN
	ll_row=tabpage_seguimiento.d_estados_operaciones.Find("nomenclatura='ER'",0,tabpage_seguimiento.d_estados_operaciones.rowcount())
	IF pl_click_row <> ll_row THEN
		ll_row=tabpage_seguimiento.d_estados_operaciones.Find("nomenclatura= 'SR'",0,tabpage_seguimiento.d_estados_operaciones.rowcount())
		IF pl_click_row <> ll_row THEN
			gnv_msg.f_mensaje("AI11","","",OK!)					
			Return FALSE //no valida		
		END IF
	END IF
END IF

return TRUE
end function

public function integer frn_habilitar_op (boolean pb_habilitar);////////////////////////////////////////////////////////////////////////////////////////////////
//
// Funci$$HEX1$$f300$$ENDHEX$$n: frn_habilitar
// 
// Objetivo: Habilita y Deshabilita los campos de la datawindow
//	Ambito:	P$$HEX1$$fa00$$ENDHEX$$blico
//
// Par$$HEX1$$e100$$ENDHEX$$metros: 
//		Entrada: data window
//					pb_habilitar Ture (habilitar)
//					pb_habilitar False (deshabilitar)			
//		Salida:  		
// Devuelve:	
//
//  Fecha	  Responsable	Actuaci$$HEX1$$f300$$ENDHEX$$n
// ---------	-------		----------------------------------------
//	29/2/96		SAB			Versi$$HEX1$$f300$$ENDHEX$$n Original
//
////////////////////////////////////////////////////////////////////////////////////////////////

long ll_contador

IF pb_habilitar THEN
// Modificado por Sgo. Unificaci$$HEX1$$f300$$ENDHEX$$n.
//	tabpage_seguimiento.d_seguimiento_operaciones.modify("f_alta.background.Color ="+string(65536*255+256*255+255))

//	tabpage_seguimiento.d_seguimiento_operaciones.modify("observacion.background.Color ="+string(65536*255+256*255+255))
//	tabpage_seguimiento.d_seguimiento_operaciones.modify("f_alta.background.Color =" + gs_blanco)
//	tabpage_seguimiento.d_seguimiento_operaciones.modify("observacion.background.Color =" + gs_blanco)
// Fin. Sgo.
//	tabpage_seguimiento.d_seguimiento_operaciones.Modify("f_alta.protect=0")
//	tabpage_seguimiento.d_seguimiento_operaciones.Modify("observacion.protect=0")
	tabpage_seguimiento.chk_resolucion_mant.Enabled=True
ELSE
// Modificado por Sgo. Unificaci$$HEX1$$f300$$ENDHEX$$n.
//	tabpage_seguimiento.d_seguimiento_operaciones.modify("observacion.background.Color ="+string(65536*192+256*192+192))
//	tabpage_seguimiento.d_seguimiento_operaciones.modify("f_alta.background.Color ="+string(65536*192+256*192+192))	
	tabpage_seguimiento.d_seguimiento_operaciones.modify("observacion.background.Color =" + gs_gris)
	tabpage_seguimiento.d_seguimiento_operaciones.modify("f_alta.background.Color =" + gs_gris)	
// Fin. Sgo.
	tabpage_seguimiento.d_seguimiento_operaciones.Modify("f_alta.protect=1")
	
	//***************************************
	//**  OSGI 2001.1  	21/05/2001			**
	//**  Jair Padilla / Soluziona PANAMA  **
	//***************************************
	//**  OSGI 2001.1  	21/05/2001  	tabpage_seguimiento.d_seguimiento_operaciones.Modify("observacion.protect=1")

	//If tabpage_formulario.d_inf_general.GetItemNumber(1,"estado_actual") >= fgci_incidencia_resuelta Then
		tabpage_seguimiento.d_seguimiento_operaciones.Modify("observacion.Edit.DisplayOnly=Yes")
	//Else
	//	tabpage_seguimiento.d_seguimiento_operaciones.Modify("observacion.protect=1")
	//End If
	//***************************************
	//**  OSGI 2001.1  	21/05/2001			**
	//**  Jair Padilla / Soluziona PANAMA  **
	//***************************************

	tabpage_seguimiento.chk_resolucion_mant.Enabled=False
END IF
Return 1
end function

public function integer frn_habilitar_mant (boolean pb_habilitar);////////////////////////////////////////////////////////////////////////////////////////////////
//
// Funci$$HEX1$$f300$$ENDHEX$$n: frn_habilitar
// 
// Objetivo: habilita y deshabilita los campos de la datawindow
//	Ambito:	P$$HEX1$$fa00$$ENDHEX$$blico
//
// Par$$HEX1$$e100$$ENDHEX$$metros: 
//		Entrada: data window
//					pb_habilitar Ture (habilitar)
//					pb_habilitar False (deshabilitar)			
//		Salida:  --		
// Devuelve:	
//
//  Fecha	  Responsable	Actuaci$$HEX1$$f300$$ENDHEX$$n
// ---------	-------		----------------------------------------
//	29/2/96		SAB			Versi$$HEX1$$f300$$ENDHEX$$n Original
//
////////////////////////////////////////////////////////////////////////////////////////////////
//long ll_contador,ll_row
//
//tabpage_seguimiento.d_seguimiento_mantenimiento.SetRow(1)
//
//IF pb_habilitar THEN
//	tabpage_seguimiento.d_seguimiento_mantenimiento.modify("f_alta.background.Color ="+string(65536*255+256*255+255))
//	tabpage_seguimiento.d_seguimiento_mantenimiento.modify("observacion.background.Color ="+string(65536*255+256*255+255))
//	tabpage_seguimiento.d_seguimiento_mantenimiento.Modify("f_alta.protect=0")
//	tabpage_seguimiento.d_seguimiento_mantenimiento.Modify("observacion.protect=0")
//ELSE
//	tabpage_seguimiento.d_seguimiento_mantenimiento.modify("observacion.background.Color ="+string(65536*192+256*192+192))
//	tabpage_seguimiento.d_seguimiento_mantenimiento.modify("f_alta.background.Color ="+string(65536*192+256*192+192))	
//	tabpage_seguimiento.d_seguimiento_mantenimiento.Modify("f_alta.protect=1")
//	tabpage_seguimiento.d_seguimiento_mantenimiento.Modify("observacion.protect=1")
//END IF
//

Return 1
end function

public function integer fnu_evaluo_sin_selec (integer pl_causa_ant);//////////////////////////////////////////////////////////
//
// Funci$$HEX1$$f300$$ENDHEX$$n: fnu_evaluo_sin_selec
//
// Objetivo: 
//
// Ambito: P$$HEX1$$fa00$$ENDHEX$$blico
//
// Par$$HEX1$$e100$$ENDHEX$$metros:
//        Entrada:  pl_causa_ant
//        Salida : --
//
// Devuelve: 
//
// Fecha                Responsable             Actuaci$$HEX1$$f300$$ENDHEX$$n
// -----                -----------             ---------
//
///////////////////////////////////////////////////////////



	int li_cod_estado_en_rep, li_cod_estado_ser_rep, li_cod_estado_ot, li_null
	DateTime ldt_null
	DateTime ldt_fec_causa

	setnull(ldt_null)
	setnull(li_null)

	md_ingreso_incidencias lm_menu
	lm_menu= iw_contenedora.menuid
	
	li_cod_estado_en_rep = fgci_incidencia_en_reposicion
	li_cod_estado_ser_rep = fgci_incidencia_servicio_repuesto
	li_cod_estado_ot = fgci_incidencia_enviado_brigada
	// Si se selecciono la causa "Sin seleccionar" o no seleccione causa
	IF tabpage_formulario.d_inf_general.getitemnumber(1,"causa") = fgci_sin_seleccionar or ISNULL(tabpage_formulario.d_inf_general.getitemnumber(1,"causa")) THEN
		// si la incidencia fue derivada no permito deseleccionar la causa
		If NOT ISNULL(tabpage_formulario.d_inf_general.getitemnumber(1,"estado_mantenimiento")) AND tabpage_formulario.d_inf_general.getitemnumber(1,"estado_mantenimiento")<>0 THEN  
			gnv_msg.f_mensaje("AI57","","",OK!)
			tabpage_formulario.d_inf_general.setitem(1,"causa",pl_causa_ant)  // dejo el que estaba
			tabpage_formulario.d_inf_general.accepttext()
		Else
			// si la incidencia no fue derivada pero el estado es en reposicion o mayor, mensaje
			IF tabpage_formulario.d_inf_general.getitemnumber(1,"estado_actual") >= li_cod_estado_en_rep THEN
				gnv_msg.f_mensaje("AI58","","",OK!)
				tabpage_formulario.d_inf_general.setitem(1,"causa",pl_causa_ant)  // dejo el que estaba
				tabpage_formulario.d_inf_general.accepttext()

			ELSE
				// Si la inc. no fue derivada y el estado < ER , proceso
				tabpage_formulario.d_inf_general.setitem(1,"causa",li_null)   //reseteo causa 
				tabpage_formulario.d_inf_general.setitem(1,"fec_causa",ldt_null)
				tabpage_formulario.d_inf_general.modify("fec_causa.protect=1")
				tabpage_formulario.d_inf_general.modify("fec_causa.background.color=" + gs_gris)
				//tabpage_formulario.d_inf_general.setitem(1,"estado_actual",fgci_incidencia_enviado_brigada)
				//ii_estado_oper = fgci_incidencia_enviado_brigada
				
				tabpage_formulario.d_inf_general.accepttext()

			END IF
		END IF
	ELSE   //si seleccione una causa
//		tabpage_formulario.d_inf_general.modify("fec_causa.protect=0")
//		tabpage_formulario.d_inf_general.modify("fec_causa.background.color="+gs_blanco)
		tabpage_formulario.d_inf_general.accepttext()

		IF ISNULL(tabpage_formulario.d_inf_general.getitemdatetime(1,"fec_causa")) THEN  
			// Actualizo la fecha de causa
			//IF NOT iw_contenedora.fw_incidencia_de_operaciones()  then		
			

			//NCA-INICIO.DDAG-2482.20150612.LLamo a la funcion creada para traer la fecha actual con segundos.
				ldt_fec_causa=fgnu_fecha_actual_con_seg()  
			//NCA-INICIO.DDAG-2482.20150612.

			tabpage_formulario.d_inf_general.setitem(1,"fec_causa",ldt_fec_causa)  

			idt_fecha_cl = ldt_fec_causa
		END IF

		tabpage_formulario.d_inf_general.accepttext()
	END IF
	Return 1
end function

public function boolean frn_es_anulacion (ref datawindow pd_dw, integer pl_click_row);////////////////////////////////////////////////////////////////////////////////////////////////
//
// Funci$$HEX1$$f300$$ENDHEX$$n: frn_es_anulacion
// 
// Objetivo: Valida si es anulacion
//	Ambito:	P$$HEX1$$fa00$$ENDHEX$$blico
//
// Par$$HEX1$$e100$$ENDHEX$$metros: 
//			Entrada: data window
//				
//			Salida:   1 anulacion
//						 0 no anulacion		
// Devuelve:	
//
//  Fecha	  Responsable	Actuaci$$HEX1$$f300$$ENDHEX$$n
// ---------	-------		----------------------------------------
//	29/2/96		SAB			Versi$$HEX1$$f300$$ENDHEX$$n Original
//
////////////////////////////////////////////////////////////////////////////////////////////////
long ll_entrada


//ll_entrada = tabpage_seguimiento.d_seguimiento_operaciones.GetItemNumber(pl_click_row,"ind_env_mant")
ll_entrada = pd_dw.GetItemNumber(pl_click_row,"ind_env_mant")

IF ll_entrada=1 THEN
	Return True
ELSE
	Return False

END IF
end function

public function boolean frn_validar_anulacion (ref datawindow pd_dw, integer pl_click_row);////////////////////////////////////////////////////////////////////////////////////////////////
//
// Funci$$HEX1$$f300$$ENDHEX$$n: frn_validar_anulacion

// 
// Objetivo: Valida si se anula el retorno de la incidencia de mantenimiento
//	Ambito:	P$$HEX1$$fa00$$ENDHEX$$blico
//
// Par$$HEX1$$e100$$ENDHEX$$metros: 
//		Entrada: data window
//		Salida:   1 anulacion
//					 0 no anulacion		
// Devuelve:	
//
//  Fecha	  Responsable	Actuaci$$HEX1$$f300$$ENDHEX$$n
// ---------	-------		----------------------------------------
//	29/2/96		SAB			Versi$$HEX1$$f300$$ENDHEX$$n Original
//
////////////////////////////////////////////////////////////////////////////////////////////////

//long  ll_salida
//datetime  ld_f_alta
//		
//	//Valida que mantenimiento no pueda anular la operacion
//	//si la fecha de EB NO es nula o se derivo a operaciones
//
//ll_salida = pd_dw.Find&
//			("ind_env_mant=2",0,pd_dw.RowCount())
//IF ll_salida > 0 OR &
//	NOT ISNULL(pd_dw.GetItemDateTime(2,"f_alta")) OR &
//	NOT fgnu_auto_der_mant() THEN
//
//	gnv_msg.f_mensaje("AG01","","",OK!)
//
//	Return False //NO valida la anulacion
//END IF
//
Return True
end function

public function boolean fnu_devolver_env_mant (ref datawindow pd_dw);/////////////////////////////////////////////////////////////////////
//
// Funcion:fnu_devolver_env_mant
//
// Objetivo: Obtiene enviado de mantenimiento
//
// Ambito:   P$$HEX1$$fa00$$ENDHEX$$blico
//
// Par$$HEX1$$e100$$ENDHEX$$metros:
//    Entrada: pd_dw
//		Salida : --
//
// Devuelve:
//
// Fecha      Responsable   Actuaci$$HEX1$$f300$$ENDHEX$$n
// ------	   -----------   ---------
//
//
///////////////////////////////////////////////////////

long ll_row
ll_row=pd_dw.Find("ind_env_mant=1",0,pd_dw.RowCount())

IF ll_row <> 0 THEN
	return TRUE
ELSE
	Return FALSE
END IF
end function

public function integer fnu_cargar_ot (ref datawindow pd_dw, decimal pd_instalacion, long pl_aviso, integer pi_brigada_resp, integer pi_centro, integer pi_cmd, integer pi_mesa, long pl_nro_incidencia);///////////////////////////////////////////////////////////////////////////
//
// Funci$$HEX1$$f300$$ENDHEX$$n: fnu_cargar_ot
// 
// Objetivo:Carga en la estructura los datos de ot en la tabla ot
//           
// Ambito:	P$$HEX1$$fa00$$ENDHEX$$blico
//
// Par$$HEX1$$e100$$ENDHEX$$metros: 
//			Entrada: data window 
//				 		todos los datos de la tabla
//			Salida:   --
//						
// Devuelve:	
//
//  Fecha	  Responsable	Actuaci$$HEX1$$f300$$ENDHEX$$n
// ---------	-------		----------------------------------------
//	30/1/96		SAB			Versi$$HEX1$$f300$$ENDHEX$$n Original
//
///////////////////////////////////////////////////////////////////////////

long ll_nro_aviso
datetime ld_fecha
pd_dw.AcceptText()

//evalua los parametros pasados por defecto
	
	IF ISNULL(pi_brigada_resp) THEN
		pi_brigada_resp=fgci_sin_seleccionar
	END IF

	IF ISNULL(pd_instalacion) THEN
		pd_instalacion=0
	END IF
	
	IF ISNULL(pl_aviso) THEN
		pl_aviso=0
	END IF	

	pd_dw.SetItem(1,"usuario",gs_usuario) 
	pd_dw.SetItem(1,"f_actual",fgnu_fecha_actual())
	pd_dw.SetItem(1,"h_actual",fgnu_fecha_actual())					
	pd_dw.SetItem(1,"programa","u_bri_2001_nu")
	
			//Controlo el estado de la ot

	IF IsNull(pd_dw.GetItemNumber(1,"est_ot")) THEN
		//messageBox("Error Intentando Grabar un registro en estado OT","error")
		gnv_msg.f_mensaje("EI35","","",OK!)
		pd_dw.SetItem(1,"f_hasta",fgnu_fecha_actual())
		pd_dw.SetItem(1,"h_hasta",fgnu_fecha_actual())
	END IF

	IF ISNULL(pd_dw.GetItemString(1,"descripcion")) THEN
		pd_dw.SetItem(1,"descripcion"," ")
	END IF

	pd_dw.SetItem(1,"nro_instalacion",pd_instalacion)
	pd_dw.SetItem(1,"nro_incidencia",pl_nro_incidencia)
	pd_dw.SetItem(1,"f_alta",fgnu_fecha_actual())
	pd_dw.SetItem(1,"h_alta",fgnu_fecha_actual())
	 
	pd_dw.SetItem(1,"ult_brigada",pi_brigada_resp) 
	pd_dw.SetItem(1,"nro_centro",pi_centro)
	pd_dw.SetItem(1,"nro_cmd",pi_cmd)
	pd_dw.SetItem(1,"nro_mesa",pi_mesa)
	

	IF pd_instalacion <> 0 THEN
		//Obtencion del nro del pimer aviso sobre la instalacion
		// por ser incidencia a nivel de instalacion

		pd_dw.SetItem(1,"nro_aviso",0)	
	ELSE
		pd_dw.SetItem(1,"nro_aviso",pl_aviso)	
	END IF
Return 1
end function

public function integer f_finalizar_tareas_brigadas ();/////////////////////

//	Si las brigadas asignadas a la ot tienen fecha de
//	fin de tareas nula, les asigna fecha de fin

//
//
/////////////////////
int i
long ll_nro_brigada

FOR i = 1 to tabpage_ot.d_lista_brigadas_ot.RowCount()
	IF IsNull(tabpage_ot.d_lista_brigadas_ot.GetItemDateTime(i,"f_hasta")) THEN
		
		tabpage_ot.d_lista_brigadas_ot.SetItem(i,"f_hasta",idt_fecha_resuelta)
		
		if tipo_ot = 'BR' then //DSA 23/02/2000
			ll_nro_brigada = tabpage_ot.d_lista_brigadas_ot.GetItemNumber(i,"nro_brigada")
			// Actualizo el estado
			UPDATE "GI_BRIGADA"  
				SET "IND_DISPONIBLE" = 1  
				WHERE "GI_BRIGADA"."NRO_BRIGADA" = :ll_nro_brigada;
			
			IF sqlca.sqlcode < 0 THEN
				Return -1
			END IF
		END IF
	END IF
NEXT

// Cierro la ot

tabpage_ot.d_datos_ot.SetItem(1,"f_hasta",idt_fecha_resuelta)
tabpage_ot.d_datos_ot.SetItem(1,"h_hasta",idt_fecha_resuelta)
tabpage_ot.d_datos_ot.SetItem(1,"est_ot",fgci_ot_resuelta)

// Actualizo el formulario
tabpage_formulario.d_inf_general.SetItem(1,"ot_f_hasta",idt_fecha_resuelta)

return 1
end function

public function integer f_changing (long pl_indice_viejo, long pl_indice_nuevo);/////////////////////////////////////////////////////////
//										
// Funcion/Evento: f_changing 
// 
// Objetivo://////////////////
//
// En este evento verifico que el usuario puede cambiarse de tabpage
// es decir lanzo las validaciones, y si no las pasa, no lo dejo cambiar
//
// Aqui se codifican los equivalentes al CloseQuery y a la
// funcion Evaluar_Apertura
//
//////////////////////////////
//	
//
// Responsable: 	AFS
//						FDO 
//
//    Entrada: pl_indice_viejo
//					pl_indice_nuevo
//
//		Salida : -1 si fall$$HEX1$$f300$$ENDHEX$$
//
// Devuelve:
//
//// Fecha      Responsable   Actuaci$$HEX1$$f300$$ENDHEX$$n
// ------	   -----------   ---------
// 15/09/98    FDO
// 28/04/2005	SGO	Mejora de Moldavia.
//
///////////////////////////////////////////////////////

boolean		lb_osgmActivo					//Indicativo de la activaci$$HEX1$$f300$$ENDHEX$$n de la interfase con OSGM
int li_nulo, li_contador
string ls_nulo, ls_observaciones
datetime ldt_nula, ldt_fecha_vieja_repos, ldt_fecha_debe_reponer
long  ll_brigada_resp, ll_nro_aviso, ll_causa, ll_tension, ll_ot_existente, li_conta
md_ingreso_incidencias lm_menu

SetNull(li_nulo)
SetNull(ls_nulo)
SetNull(ldt_nula)
lb_osgmActivo = fg_verifica_parametro("OSGM ACTIVO")
IF (NOT ISNULL(pl_indice_viejo)) and (pl_indice_viejo <= 8) and (pl_indice_viejo > 0) THEN

	CHOOSE CASE This.control[pl_indice_viejo]
		CASE tabpage_formulario	// Formulario
		IF is_accion_llamada <> "Consulta" THEN  //ACO
			tabpage_formulario.d_inf_general.AcceptText()

			if ib_hubo_error then 
				ib_hubo_error=false
				return -1
			end if
			
			IF isnull(tabpage_formulario.d_inf_general.GetItemDatetime(1, 'fec_causa')) AND &
				tabpage_formulario.d_inf_general.object.st_causa.text <> "" THEN
			
				messagebox("Atenci$$HEX1$$f300$$ENDHEX$$n", "La fecha de la causa no puede ser nula")
				return -1
			END IF
			
// Modificado por Sgo. 28/04/2005. Mejora Moldavia.
// En Moldavia, el campo Descripci$$HEX1$$f300$$ENDHEX$$n no ser$$HEX2$$e1002000$$ENDHEX$$obligatorio.
//			if len(trim(tabpage_formulario.d_inf_general.getitemstring(1,"desc"))) < 1 or isnull(tabpage_formulario.d_inf_general.getitemstring(1,"desc")) then
			if (len(trim(tabpage_formulario.d_inf_general.getitemstring(1,"desc"))) < 1 or isnull(tabpage_formulario.d_inf_general.getitemstring(1,"desc"))) and gi_pais <> 8 then
// Fin. Sgo.
				gnv_msg.f_mensaje("AI59","","",OK!)
				return -1
			end if

		end if //ACO	

		CASE tabpage_observaciones	// Observaciones
		IF is_accion_llamada <> "Consulta" THEN  //ACO			
			iw_contenedora.tab_1.f_deshab_tabs(false)
			ls_observaciones = tabpage_observaciones.mle_observaciones.text
			if len(trim(ls_observaciones)) = 0 and gb_obs_obligatorias = true then
				//MessageBox("Atenci$$HEX1$$f300$$ENDHEX$$n","Debe ingresar alguna observaci$$HEX1$$f300$$ENDHEX$$n.")
				gnv_msg.f_mensaje("AI46","","",OK!)
				Return -1
			end if
		end if			
		CASE tabpage_ot	// OT

			//Coloco la brigada en la ventana de informacion general
			if isnull(tabpage_formulario.d_inf_general.GetItemstring(1,"nom_brigada")) or &
											tabpage_formulario.d_inf_general.GetItemstring(1,"nom_brigada")="" THEN
				f_inserta_datos_brig()

			END IF
	

			// Nuevo codigo del equivalente al evento "closequery" 
			// de OT
			IF is_accion_llamada <> "Consulta" THEN
				
				ib_valido_ot=true
				tabpage_ot.d_datos_ot.AcceptText()
				tabpage_ot.d_lista_brigadas_ot.AcceptText()
				//Si no hay brigada trabajando he intento acceder a interrup o materiales no le dejo
				if ib_mensaje=true and pl_indice_nuevo <> 1 & 
					and pl_indice_nuevo <> 2 and pl_indice_nuevo <> 3 &
					and pl_indice_nuevo <> 6 and pl_indice_nuevo <> 7 then
					return -1
				end if
				if fnu_validar_brigadas_prev()= -1 then
					return -1
				end if
				if fnu_habilito_f_hasta() = -1 then
					return -1
				end if
				ib_valido_ot=false
				IF tabpage_ot.d_lista_brigadas_ot.RowCount() <= 0  then
					
					// Si el estado es superior a EB, no puede dejar la OT sin brigadas
					IF ii_estado_oper > fgci_incidencia_enviado_brigada AND &
						NOT ib_ind_scada  and il_nro_ot > 0 THEN
						//MessageBox("Atenci$$HEX1$$f300$$ENDHEX$$n","La incidencia est$$HEX2$$e1002000$$ENDHEX$$en estado CL o superior.~nDebe asignar al menos una Brigada.")
						gnv_msg.f_mensaje("AI101","","",OK!)
						Return -1
					// Si estaba en EB, la paso a pt
					ELSEIF ii_estado_oper = fgci_incidencia_enviado_brigada THEN
						ii_estado_oper = fgci_incidencia_pendiente

						SetNull(idt_fecha_eb)

						// Actualizo el formulario
						tabpage_formulario.d_inf_general.SetItem(1,"estado_actual",ii_estado_oper)
						tabpage_formulario.d_inf_general.SetItem(1,"brigada",li_nulo)
						tabpage_formulario.d_inf_general.SetItem(1,"ot",li_nulo)
						tabpage_formulario.d_inf_general.SetItem(1,"ot_descripcion",ls_nulo)
						tabpage_formulario.d_inf_general.SetItem(1,"ot_f_desde",ldt_nula)
						
						tabpage_formulario.d_inf_general.Modify("Causa.Background.Color=" + gs_gris)
	//					tabpage_formulario.d_inf_general.Modify("Causa.Protect=1")
						
						// Actualizo el seguimiento
						tabpage_seguimiento.d_seguimiento_operaciones.SetItem(ii_incidencia_enviado_brigada,"f_alta",ldt_nula)
						tabpage_seguimiento.d_seguimiento_operaciones.SetItem(ii_incidencia_enviado_brigada,"h_alta",ldt_nula)
						tabpage_seguimiento.d_seguimiento_operaciones.SetItem(ii_incidencia_enviado_brigada,"observacion",ls_nulo)
						END IF
	//**
				END IF
				// Obtengo la fecha de EB y la brigada responsable

				ll_brigada_resp = iw_contenedora.tab_1.fnu_devolver_brigada_resp(tabpage_ot.d_lista_brigadas_ot)

				//AHM (18/12/2008)
				IF tabpage_ot.d_datos_ot.rowCount() = 0 THEN
					tabpage_ot.d_datos_ot.insertRow(0)
				END IF

				// Si la fecha de EB es menor que la fecha 
				// de generada la OT, mensaje
				IF idt_fecha_eb < tabpage_ot.d_datos_ot.GetItemDateTime(1,"f_desde") THEN
					//MessageBox("Atenci$$HEX1$$f300$$ENDHEX$$n","La fecha de EB no puede ser menor que la fecha de generada la OT.")
					gnv_msg.f_mensaje("AI102","","",OK!)
					Return -1
				END IF
				
				// Si la fecha de alguna de las brigadas es mayor que la actual
				// y la incidencia es imprevista, no dejo salir

				if ii_estado_oper >= fgci_incidencia_enviado_brigada then
					f_inserta_datos_brig()
				end if
				
				if (ll_brigada_resp= -1 AND tipo_ot = 'BR') and tabpage_ot.d_lista_brigadas_ot.rowcount()>0 then 
					//MessageBox("Atenci$$HEX1$$f300$$ENDHEX$$n","No hay Brigada encargada, debe seleccionar una.")
					gnv_msg.f_mensaje("AI10","","",OK!)
					RETURN -1
				end if
				
				// Si el estado era pendiente
				//	cambio el estado a EB, actualizo el formulario (debo actualizar el estado,
				// la brigada responsable, el nro_ot, fecha de inicio de ot, etc)
				//, las fechas y el seguimiento
				IF ii_estado_oper <= fgci_incidencia_enviado_brigada 	AND &
					(ll_brigada_resp > 0 OR tipo_ot = 'CO') 				and &
					not isnull(tabpage_ot.d_datos_ot.object.f_desde[1]) 			THEN // Segunda condicion a$$HEX1$$f100$$ENDHEX$$adida por pacho

					ii_estado_oper = fgci_incidencia_enviado_brigada			
					// Actualizo el formulario
					tabpage_formulario.d_inf_general.SetItem(1,"estado_actual",ii_estado_oper)
					tabpage_formulario.d_inf_general.SetItem(1,"brigada",ll_brigada_resp)
					tabpage_formulario.d_inf_general.SetItem(1,"ot",il_nro_ot)
					tabpage_formulario.d_inf_general.SetItem(1,"ot_descripcion",tabpage_ot.d_datos_ot.GetItemString(1,"descripcion"))
					tabpage_formulario.d_inf_general.SetItem(1,"ot_f_desde",tabpage_ot.d_datos_ot.GetItemDateTime(1,"f_desde"))
					
					tabpage_formulario.d_inf_general.Modify("Causa.Background.Color=" + gs_blanco)
	// Solo se habilita cuando BT or no hay operaciones or ya existia una causa
				
					tabpage_seguimiento.d_seguimiento_operaciones.SetItem(ii_incidencia_enviado_brigada,"f_alta",idt_fecha_eb)
					tabpage_seguimiento.d_seguimiento_operaciones.SetItem(ii_incidencia_enviado_brigada,"h_alta",idt_fecha_eb)

	// Bloqueo la pesta$$HEX1$$f100$$ENDHEX$$a de clase de incidencia en el tabpage principal.
					tabpage_formulario.d_inf_general.object.tipo_incidencia.protect=1
					tabpage_formulario.d_inf_general.object.tipo_incidencia.background.color=gs_gris
				END IF
	
				// Actualizo el seguimiento
				ll_nro_aviso = iw_contenedora.tab_1.f_devolver_primer_aviso(tabpage_formulario.d_inf_general)
				This.fnu_cargar_ot(tabpage_ot.d_datos_ot,idec_nro_instalacion_afectada,ll_nro_aviso,ll_brigada_resp,gi_nro_centro,gi_nro_cmd,gi_nro_puesto,il_nro_incidencia)
	
				// *********RETOCAR PACHO **********
	
				// Hay que probar por que asigna una ot cuando la incidencia > SR sin scada.
	
				if (isnull(tabpage_formulario.d_inf_general.GetItemnumber(1,"ot")) &
					or tabpage_formulario.d_inf_general.GetItemnumber(1,"ot")=0) &
					and ii_estado_oper = fgci_incidencia_enviado_brigada then
					
					if (isnull(il_nro_ot) or il_nro_ot=0) and (ib_ind_scada = false)  then 
						il_nro_ot=f_actualizar_ultima_ot()
					end if
					tabpage_formulario.d_inf_general.Object.ot[1] = il_nro_ot
					tabpage_ot.d_datos_ot.Object.nro_ot[1] = il_nro_ot
				end if
				
				// *********RETOCAR PACHO ***********
				
				if isnull(tabpage_formulario.d_inf_general.GetItemstring(1,"nom_brigada")) or &
					tabpage_formulario.d_inf_general.GetItemstring(1,"nom_brigada")="" THEN
					f_inserta_datos_brig()
				END IF
	
			END IF

			ib_hay_brig_trab=false
			
			IF is_accion_llamada <> "Consulta" THEN  //ACO
			if ii_estado_oper >= fgci_incidencia_enviado_brigada and ii_estado_oper < fgci_incidencia_servicio_repuesto then
				
				for li_contador=1 to tabpage_ot.d_lista_brigadas_ot.rowcount()
					if not IsNull(tabpage_ot.d_lista_brigadas_ot.object.f_desde[li_contador]) and &
						isnull(tabpage_ot.d_lista_brigadas_ot.object.f_hasta[li_contador]) then
						ib_hay_brig_trab=true
						ib_mensaje=false
					end if		 
				next
				if ib_hay_brig_trab=false and ib_mensaje=false then
					if (iw_contenedora.tab_1.f_deshab_tabs(false)=-1) then 
						tabpage_ot.d_lista_brigadas_ot.object.f_hasta[tabpage_ot.d_lista_brigadas_ot.rowcount()]=ldt_nula
						tabpage_ot.d_lista_brigadas_ot.object.est_brigada[tabpage_ot.d_lista_brigadas_ot.rowcount()]=2
						return -1
					end if
				end if
			else
				yield()
				if (iw_contenedora.tab_1.f_deshab_tabs(false)=-1) then 
					tabpage_ot.d_lista_brigadas_ot.object.f_hasta[tabpage_ot.d_lista_brigadas_ot.rowcount()]=ldt_nula

					tabpage_ot.d_lista_brigadas_ot.object.est_brigada[tabpage_ot.d_lista_brigadas_ot.rowcount()]=2
					return -1
				end if
			end if
			iw_contenedora.tab_1.f_deshab_tabs(false)	
			end if //ACO
					
		CASE tabpage_cuadrillas	// Cuadrillas
		IF is_accion_llamada <> "Consulta" THEN  //ACO
			IF f_grabar_materiales(il_nro_incidencia) = -1 THEN
				Return -1
			END IF
		end if			
		CASE tabpage_interrupciones	// Interrupciones
		
		IF is_accion_llamada <> "Consulta" THEN  //ACO
			if (ii_alcance=fgci_incidencia_con_interrupcion) then
			   //and ii_tipo_incid <> fgci_incidencia_calidad then
				tabpage_interrupciones.d_datos_interrup.AcceptText()
				if tabpage_interrupciones.d_datos_interrup.rowcount() > 0 then
					ldt_fecha_vieja_repos = tabpage_interrupciones.d_datos_interrup.GetItemDateTime(1,"f_reposicion")
					ldt_fecha_debe_reponer = tabpage_interrupciones.d_datos_interrup.GetItemDateTime(1,"f_debe_rep")
					
					// Si estamos dando de alta una incidencia habr$$HEX2$$e1002000$$ENDHEX$$que deshabilitar la lista
					// del tipo de incidencia en cuanto generemos una interrupci$$HEX1$$f300$$ENDHEX$$n
					IF is_accion_llamada = "Alta" THEN						
						tabpage_formulario.d_inf_general.object.tipo_incidencia.background.color=gs_gris
						tabpage_formulario.d_inf_general.object.tipo_incidencia.protect=1
					END IF
				end if
				IF NOT ib_dejo_cambiar THEN
					ib_dejo_cambiar = True
					Return -1
				END IF
			end if
		END IF //ACO						
		CASE tabpage_seguimiento	// Seguimiento
		IF is_accion_llamada <> "Consulta" THEN  //ACO
			IF NOT ib_cancelo_seg THEN
				datetime ld_fecha_pr
				long ll_derivada_oper
		
				//valida que las fechas en que se derivo la incidencia
				tabpage_seguimiento.d_seguimiento_operaciones.accepttext()
				tabpage_seguimiento.d_seguimiento_mantenimiento.accepttext()
				Yield()
				
			
				if not isvalid(this) then return -1
				
				if ib_retorno_segumiento= true then // si encontr$$HEX2$$f3002000$$ENDHEX$$errores en seguimiento
					ib_retorno_segumiento= false
					return -1
				end if
				//valida fechas de seguimiento
				IF	NOT This.frn_validar_estado_pr(tabpage_seguimiento.d_seguimiento_mantenimiento,tabpage_seguimiento.chk_resolucion_mant.Checked) OR &
					NOT This.frn_v_fechas(tabpage_seguimiento.d_seguimiento_mantenimiento) OR &
					NOT This.frn_v_fechas(tabpage_seguimiento.d_seguimiento_operaciones) THEN
		
					Return -1
				END IF
			END IF
		end if			
		CASE tabpage_acciones	
			// Acciones
		
	END CHOOSE

END IF

//////////////////
//	Controlo si dejo al usuario acceder al tabpage que seleccion$$HEX1$$f300$$ENDHEX$$.
// Equivalente a un evaluar apertura

IF (NOT ISNULL(pl_indice_viejo)) and (pl_indice_viejo <= 8) and (pl_indice_viejo > 0) and pl_indice_nuevo > 0 THEN

	CHOOSE CASE This.control[pl_indice_nuevo]
	CASE tabpage_formulario
     		if  is_accion_llamada <> "Consulta" then //ACO
			// Aqui compruebo cuando se ha de mostrar la etiqueta de causa
				if f_inserta_datos_brig() = false then
					tabpage_formulario.d_inf_general.Modify("ot.visible=0")
				else
					tabpage_formulario.d_inf_general.Modify("ot.visible=1")
				end if
				tabpage_formulario.d_inf_general.accepttext()
				ll_causa = tabpage_formulario.d_inf_general.getitemnumber(1,"causa")
				ll_tension = tabpage_formulario.d_inf_general.getitemnumber(1,"tip_tension")
				if isnull(ll_causa) then
					ll_causa = 0
				end if
				
				//AHM (26/10/2011) Integraci$$HEX1$$f300$$ENDHEX$$n OSGI - OSGM
//				if (ii_estado_oper < fgci_incidencia_servicio_repuesto) OR & // GNU 5-7-2006. Incidencia correo
//					( (IsNull(tabpage_formulario.d_inf_general.GetItemNumber(1, 'causa')) OR &
//					  tabpage_formulario.d_inf_general.GetItemNumber(1, 'causa') = fgci_cod_causa_desconocida ) AND &
//					  ii_estado_oper >= fgci_incidencia_servicio_repuesto) THEN
				if (ii_estado_oper <= fgci_incidencia_servicio_repuesto) OR & 
					( (IsNull(tabpage_formulario.d_inf_general.GetItemNumber(1, 'causa')) OR &
					  tabpage_formulario.d_inf_general.GetItemNumber(1, 'causa') = fgci_cod_causa_desconocida ) AND &
					  ii_estado_oper > fgci_incidencia_servicio_repuesto) THEN
					  
					IF NOT(lb_osgmActivo) OR (lb_osgmActivo  AND (tabpage_formulario.d_inf_general.getitemnumber(1,"estado_mantenimiento") = 1)) THEN
//						tabpage_formulario.st_1.visible = true
					END IF
					
				else
					//AHM (23/07/2009) Mejora 1/578477
					IF NOT fg_verifica_parametro('CAMBIO CAUSA INCIDENCIA RESUELTA') THEN
						tabpage_formulario.st_1.visible = false
					END IF
					//Fin AHM
				end if
				
				// TDA.INI.EDM-2
				IF ii_estado_oper <= fgci_incidencia_servicio_repuesto OR &
					(IsNull(tabpage_formulario.d_inf_general.GetItemNumber(1,'causa_subtipo')) AND &
					ii_estado_oper > fgci_incidencia_servicio_repuesto)THEN
					
					IF NOT(lb_osgmActivo) OR (lb_osgmActivo  AND (tabpage_formulario.d_inf_general.getitemnumber(1,"estado_mantenimiento") = 1)) THEN
//						tabpage_formulario.st_18.visible = true
					END IF
				ELSE
					tabpage_formulario.st_18.visible = false	
				END IF
				// TDA.FIN.EDM-2
			else
				//AHM (23/07/2009) Mejora 1/578477
				IF NOT fg_verifica_parametro('CAMBIO CAUSA INCIDENCIA RESUELTA') THEN
					tabpage_formulario.st_1.visible = false
				END IF
				//Fin AHM
				tabpage_formulario.st_18.visible = false // TDA.EDM-2
			end if

	CASE tabpage_observaciones		// Observaciones
			// Si la incidencia esta resuelta no dejo modificar las observaciones
			IF ii_estado_oper > fgci_incidencia_resuelta or is_accion_llamada = "Consulta" THEN //ACO
				tabpage_observaciones.mle_observaciones.DisplayOnly = True
			END IF
			
	CASE tabpage_ot		// OT
			IF ii_estado_oper >= fgci_incidencia_resuelta or is_accion_llamada = "Consulta" THEN //ACO
				tabpage_ot.d_lista_brigadas_ot.Modify("f_desde.protect=1")
				tabpage_ot.d_lista_brigadas_ot.Modify("f_desde.background.color="+gs_gris)
				
				tabpage_ot.d_lista_brigadas_ot.Modify("f_hasta.protect=1")
				tabpage_ot.d_lista_brigadas_ot.Modify("f_hasta.background.color="+gs_gris)

				tabpage_ot.d_crit_seleccion.Modify("pi_tipo_brig.protect=1")
				tabpage_ot.d_crit_seleccion.Modify("pi_tipo_brig.background.color="+gs_gris)
				
				tabpage_ot.dw_lista_contratas.enabled = FALSE
				tabpage_ot.tab_lista_brigadas.tabpage_disponibles.dw_brigadas_disponibles.enabled = false
				tabpage_ot.tab_lista_brigadas.tabpage_no_disponibles.dw_brigadas_no_disponibles.enabled = false

// A$$HEX1$$f100$$ENDHEX$$adido por Sgo. Mejora de Moldavia. 06/07/2005.
				If gi_pais = 8 Then
					tabpage_ot.d_datos_ot.Modify("f_prepara_lm.protect=1")
					tabpage_ot.d_datos_ot.Modify("f_prepara_lm.background.color="+gs_gris)
				End If
// Fin. Sgo.

				tabpage_ot.d_datos_ot.Modify("f_desde.protect=1")
				tabpage_ot.d_datos_ot.Modify("f_desde.background.color="+gs_gris)
				
				tabpage_ot.d_datos_ot.modify("descripcion.edit.displayonly=yes")
				tabpage_ot.d_datos_ot.Modify("descripcion.background.color="+gs_gris)
			END IF
			
			IF ib_primera_vez_ot =  True and (isnull(il_nro_ot) or il_nro_ot=0 )  then  
				If gi_pais <> 8 Then // A$$HEX1$$f100$$ENDHEX$$adido por Sgo. 14/06/2005. Mejora Moldavia.
					tabpage_ot.st_sin_ot.visible=true
				End If // A$$HEX1$$f100$$ENDHEX$$adido por Sgo. 14/06/2005. Mejora Moldavia.
				
				Select COUNT(gi_ot.nro_ot)
    					into :ll_ot_existente
					from gi_ot
					where ( gi_ot.nro_incidencia = 0 or gi_ot.nro_incidencia is null ) and 
		  					gi_ot.est_ot < 3 and
		  					gi_ot.nro_instalacion = :idec_nro_instalacion_afectada and 
		  					gi_ot.f_desde >= :idt_fec_deteccion;
			
				IF sqlca.sqlcode = 0 THEN
					IF ll_ot_existente > 0 THEN
						tabpage_ot.cb_ot.visible=true
					ELSE
						tabpage_ot.cb_ot.visible=false
					END IF
				END IF
	
			END IF	
	CASE tabpage_cuadrillas	// Cuadrillas
			IF NOT frn_hab_brigadistas(tabpage_formulario.d_inf_general) THEN
				Return -1
			END IF
	
	CASE tabpage_interrupciones	// Interrupciones
			
			IF ii_estado_oper >= fgci_incidencia_servicio_repuesto or is_accion_llamada = "Consulta" OR (lb_osgmActivo  AND (tabpage_formulario.d_inf_general.getitemnumber(1,"estado_mantenimiento") = 1))THEN //ACO
				tabpage_interrupciones.d_datos_interrup.Modify("f_alta.protect=1")
				tabpage_interrupciones.d_datos_interrup.Modify("f_alta.background.color="+gs_gris)
				
				tabpage_interrupciones.d_datos_interrup.Modify("f_reposicion.protect=1")
				tabpage_interrupciones.d_datos_interrup.Modify("f_reposicion.background.color="+gs_gris)
				
			END IF
			if ii_tipo_incid<>fgci_incidencia_programada and is_accion_llamada <> "Consulta" AND (NOT lb_osgmActivo) then //ACO
//				tabpage_interrupciones.d_datos_interrup.modify("f_alta.Protect=0")
			end if

	CASE tabpage_seguimiento
			long ll_inst_origen
			
			ib_error_en_causa = FALSE
			ib_error_en_causa_subtipo = FALSE // TDA.EDM-2
			if ii_estado_oper = fgci_incidencia_resuelta and is_accion_llamada <> "Consulta" then //ACO
				ll_inst_origen = iw_contenedora.tab_1.tabpage_formulario.d_inf_general.getitemnumber(1,"instalacion_origen")
				if (not ll_inst_origen > 0 or isnull(ll_inst_origen)) and tabpage_formulario.d_inf_general.GetItemNumber(1,"nombre_ins") <> fgcdec_incidencia_de_suministro & 
				  and (ii_alcance=fgci_incidencia_con_interrupcion) and ii_tipo_incid <> fgci_incidencia_calidad &
				  and ii_tipo_incid <> fgci_incidencia_programada &
				  and (NOT iw_contenedora.fw_incidencia_de_operaciones()) &
				  and is_accion_llamada <> "Consulta" then
					gnv_msg.f_mensaje("AI142","","",Ok!)
					this.selecttab(tabpage_interrupciones)
					return -1
				end if
			end if

	CASE tabpage_acciones

			IF ii_estado_oper = fgci_incidencia_pendiente THEN
				return -1
			end if
		
	CASE tabpage_maniobras
			
		// Al estar habilitado el tab, se sabe que la incidencia es de operacion.
		// Buscamos los datos por si la incidencia tiene maniobras asociadas si el estado de la incidencia >= ER.
		
		if ib_primera_vez_maniobras = true then
			fnu_otras_maniobras()

			ib_primera_vez_maniobras = false
		end if

	CASE tabpage_indisponibilidades
		
		// FDO. Se controla que no se hayan recuperado registros.
		
		if ib_primera_vez_indisponibilidades = true then
			tabpage_indisponibilidades.cb_maniobras.visible = FALSE
			//FDO Inicializaci$$HEX1$$f300$$ENDHEX$$n de los filtros.

			tabpage_indisponibilidades.dw_filtro_indisponibilidades.settransobject(sqlca)
			tabpage_indisponibilidades.dw_filtro_indisponibilidades.retrieve()
			tabpage_indisponibilidades.dw_filtro_indisponibilidades.insertrow(0)
			tabpage_indisponibilidades.dw_filtro_indisponibilidades.object.tip_instalacion[1] = '0'
			
			tabpage_indisponibilidades.dw_lista_indisponibilidades.settransobject(sqlca)
			tabpage_indisponibilidades.dw_lista_indisponibilidades.retrieve(il_nro_incidencia)
			
			tabpage_indisponibilidades.dw_lista_indisponibilidades_batch.settransobject(sqlca)
			tabpage_indisponibilidades.dw_lista_indisponibilidades_batch.retrieve(il_nro_incidencia)
			
			ib_primera_vez_indisponibilidades = false
			
			for li_conta = 1 to tabpage_indisponibilidades.dw_lista_indisponibilidades.rowcount() 
				if tabpage_indisponibilidades.dw_lista_indisponibilidades.object.f_reposicion[li_conta] > &
					tabpage_indisponibilidades.dw_lista_indisponibilidades.object.f_alta[li_conta] then
					
					tabpage_indisponibilidades.dw_lista_indisponibilidades.object.modificado[li_conta] = '1'
					
				end if
			next 
			
			if iw_contenedora.lu_comunic.is_comunic.Accion_llamada="Consulta" or not iw_contenedora.fw_incidencia_de_operaciones() then
				tabpage_indisponibilidades.dw_lista_indisponibilidades.object.tip_interrupcion.protect = 1
				tabpage_indisponibilidades.dw_lista_indisponibilidades.object.cb_fechas.visible = false
//				tabpage_indisponibilidades.dw_datos_indisponibilidades.enabled=false
			else
				tabpage_indisponibilidades.dw_lista_indisponibilidades.object.tip_interrupcion.protect = 1
				tabpage_indisponibilidades.dw_lista_indisponibilidades.object.cb_fechas.visible = false
//				tabpage_indisponibilidades.dw_lista_indisponibilidades.object.tip_interrupcion.protect = 0
//				tabpage_indisponibilidades.dw_lista_indisponibilidades.object.cb_fechas.visible = true
			end if
			
			if ii_estado_oper > fgci_incidencia_servicio_repuesto then
				tabpage_indisponibilidades.dw_datos_indisponibilidades.enabled=false
				tabpage_indisponibilidades.st_16.enabled=false
			end if
			
		end if
	
	END CHOOSE
	
if  is_accion_llamada <> "Consulta" then //ACO

	if ii_estado_oper > fgci_incidencia_pendiente then
		lm_menu= iw_contenedora.menuid
		lm_menu.m_consultar.m_instalacionafectada.enabled=false
	else
		tabpage_formulario.d_inf_general.Modify("Causa.Background.Color=" + gs_gris)
	end if
	
	end if 
	Return 0

END IF

Return 0
end function

public subroutine f_changed (long pl_indice_viejo, long pl_indice_nuevo);///////////////////////////////////////////////////////
//										
// Funcion/Evento: f_changed
// 
// Objetivo: 
///////////////////
//
//	En este evento ejecuto lo que era el open de las ventanas que dieron
//	origen al tabpage.
//
//	Ademas preguntando por el oldindex se ejecuta lo codificado en los
//	eventos close y posteriormente se llama a una funcion que simula
//	el evento activate de la ventana w_2301_form_incidencias.
//
/////////////////
//
// Responsables: 	AFS
//						FDO 
//


// Par$$HEX1$$e100$$ENDHEX$$metros:
//
//    Entrada: pl_indice_viejo
//					pl_indice_nuevo
//
//		Salida : -1 si fall$$HEX1$$f300$$ENDHEX$$
//
// Devuelve:
//

// Fecha      Responsable   Actuaci$$HEX1$$f300$$ENDHEX$$n
// ------	   -----------   ---------
// 15/09/98    FDO
//
///////////////////////////////////////////////////////

long li_error, ll_item
Datetime ldt_fecha_turno,ldt_fecha,ldt_f_desde
md_ingreso_incidencias lm_menu

lm_menu= iw_contenedora.menuid
//////////////
//	Ejecuto lo que necesita el tabpage para mostrar los datos
// y crear lo que sea necesario (similar al evento OPEN )
//***************************************
//**  OSGI 2001.1  	13/06/2001			**
//**  Jair Padilla / Soluziona PANAMA  **
//***************************************
//**  OSGI 2001.1  	13/06/2001  IF (NOT ISNULL(pl_indice_viejo)) and (pl_indice_viejo <= 7) and (pl_indice_viejo > 0) THEN
IF Not IsNull(pl_indice_viejo) And &
	((pl_indice_viejo <= 8 and pl_indice_viejo > 0) Or &
	(pl_indice_viejo = 9 and pl_indice_viejo > 0)) THEN
//***************************************
//**  OSGI 2001.1  	13/06/2001			**
//**  Jair Padilla / Soluziona PANAMA  **
//***************************************

//Compruebo si se ha de mostrar el icono de operaciones

if iw_contenedora.fw_incidencia_de_operaciones() then
		//if gi_perfil <> fgci_perfil_supervisor_operaciones and ii_estado_oper >= fgci_incidencia_enviado_brigada and ii_estado_oper <= fgci_incidencia_servicio_repuesto then
		if gu_perfiles.of_acceso_perfil(gi_perfil, 'GAV_M_OPER', "") > 1 and ii_estado_oper >= fgci_incidencia_enviado_brigada and ii_estado_oper <= fgci_incidencia_servicio_repuesto then
			lm_menu.m_consultar.m_operacion.visible=true
			lm_menu.m_consultar.m_operacion.toolbaritemvisible=true
		end if
end if

CHOOSE CASE This.control[pl_indice_nuevo]
	CASE tabpage_formulario	// El formulario
		IF ib_primera_vez_formulario THEN
			ii_estado_oper=tabpage_formulario.d_inf_general.GetItemNumber(1,"estado_actual")
			gi_est_oper = ii_estado_oper
			idt_fec_deteccion=tabpage_formulario.d_inf_general.GetItemDateTime(1,"f_deteccion")
//			IF oldindex = 2 THEN		// Si vino de Observaciones
//				tabpage_formulario.d_inf_general.SetItem(1,"observacion",tabpage_observaciones.mle_observaciones.Text)	
//			END IF
			ib_primera_vez_formulario = False
		END IF
	CASE tabpage_observaciones	// Observaciones
		IF ib_primera_vez_observaciones THEN
			tabpage_observaciones.mle_observaciones.Text = f_devolver_observaciones(tabpage_formulario.d_inf_general)	
			tabpage_observaciones.mle_observaciones_mnto.Text = f_devolver_observaciones_mnto(tabpage_formulario.d_inf_general)
			if len(trim(tabpage_observaciones.mle_observaciones_mnto.Text)) > 0 and tabpage_formulario.d_inf_general.GetItemNumber(1,"estado_actual") >= fgci_incidencia_servicio_repuesto then
				tabpage_observaciones.st_4.visible = true
				tabpage_observaciones.mle_observaciones.height = 740
				tabpage_observaciones.mle_observaciones_mnto.visible=true
			else
				tabpage_observaciones.mle_observaciones.height = 1480
			end if
			ib_primera_vez_observaciones = False
		END IF
	CASE tabpage_ot	// OT
		// Permite asignar una brigada
		// Permite asignar una orden de trabajo 

		// Si no es la primer vez que seleccion$$HEX2$$e9002000$$ENDHEX$$este tabpage
		// realizo el retrieve
		if ib_primera_vez_ot then

			// Analizo  que programa me llamo y que accion me pide que realice
			//Alta
			tabpage_ot.d_datos_ot.SetItem(1,"nro_ot",il_nro_ot)
	
			iw_contenedora.tab_1.f_crea_ddw_estado(tabpage_ot.d_datos_ot)		
			
			tabpage_ot.tab_lista_brigadas.tabpage_disponibles.dw_brigadas_disponibles.SetRedraw(FALSE)
			this.triggerevent("ue_armar_sql")
	
			// se actualizan las brigadas que entran en el horario
			ldt_fecha_turno = tabpage_ot.d_crit_seleccion.GetItemDatetime(1, 'pdt_fecha_turno')
			iw_contenedora.dw_brigadas_calendario_rango.Retrieve(Datetime(Date(ldt_fecha_turno)), ldt_fecha_turno)
			
			li_error=tabpage_ot.tab_lista_brigadas.tabpage_no_disponibles.dw_brigadas_no_disponibles.settransobject(sqlca)
			li_error=tabpage_ot.tab_lista_brigadas.tabpage_disponibles.dw_brigadas_disponibles.settransobject(sqlca)
			//li_error=tabpage_ot.tab_lista_brigadas.tabpage_no_disponibles.dw_brigadas_no_disponibles.retrieve()
			li_error=tabpage_ot.tab_lista_brigadas.tabpage_disponibles.dw_brigadas_disponibles.retrieve(il_nro_ot)
			tabpage_ot.tab_lista_brigadas.tabpage_disponibles.dw_brigadas_disponibles.SetRedraw(TRUE)

			// A$$HEX1$$d100$$ENDHEX$$ADIDO CAMBIOS DE OTS //
			
			iw_contenedora.tab_1.f_mostrar_datos_ot(tabpage_ot.d_datos_ot,il_nro_ot)	
						
			ib_primera_vez_ot = False
		end if
				
		//*****************    ACCION LLAMADA CONSULTA     ********************//
		
		IF is_accion_llamada = "Consulta" THEN
			iw_contenedora.tab_1.f_deshabilitar_datos_ot_2(tabpage_ot.d_datos_ot,1)
			iw_contenedora.tab_1.fpr_deshabilitar_lista_brigadas_ot(tabpage_ot.d_lista_brigadas_ot,1)
			tabpage_ot.bmp_brigada_responsable.Enabled=False
		END IF
		tabpage_ot.tab_lista_brigadas.il_nro_ot=il_nro_ot
	CASE tabpage_cuadrillas	// Cuadrillas
		ii_fila_selec_mat = 1
		
		// Si el estado de la incidencia es mayor o igual
		// que Enviado Brigada permito ingresar materiales
		IF ii_estado_oper >=  fgci_incidencia_enviado_brigada and ii_estado_oper < fgci_incidencia_resuelta THEN 
			tabpage_cuadrillas.cb_agregar.enabled = TRUE
		ELSE
			tabpage_cuadrillas.cb_agregar.enabled = FALSE
		END IF
		
		IF tabpage_cuadrillas.d_materiales.rowcount() <= 0 or ii_estado_oper > fgci_incidencia_resuelta THEN
			tabpage_cuadrillas.cb_eliminar.enabled = False
		ELSE
			tabpage_cuadrillas.cb_eliminar.enabled = True
		END IF

		ib_valido_mat = True
		ib_modif_mat = True
		IF ib_primera_vez_cuadrillas	then
			// Preparo la presentacion del tabpage de acuerdo a la accion llamada
			IF is_accion_llamada = "Consulta" THEN
				tabpage_cuadrillas.d_materiales.fpr_habilitar_campos(False)
				tabpage_cuadrillas.cb_agregar.visible = False
				tabpage_cuadrillas.cb_eliminar.Visible = False

			ELSE
				tabpage_cuadrillas.d_materiales.fpr_habilitar_campos(True)
			END IF
			
			ib_primera_vez_cuadrillas = False
		END IF
		
	CASE tabpage_interrupciones	// Interrupciones

		if ib_primera_vez_interrupciones or ib_cambio_instalacion Then
			if ib_cambio_instalacion then
			// Reseteo el tab por si antes hubiera elegido otra inst
				tabpage_interrupciones.d_datos_interrup.reset()
				tabpage_interrupciones.d_lista_otras_inst.reset()
				ib_cambio_instalacion=false
			end if
			
			// Se hace el retrieve de las instalaciones
			IF tabpage_interrupciones.d_lista_otras_inst.RowCount() > 0 THEN  //pacho
				ib_inst_int=true
			END IF

			l_si_valido=0
			ib_primera_vez_interrupciones = False
			
		end if
		
		IF NOT iw_contenedora.fw_incidencia_de_operaciones() AND &
			tabpage_interrupciones.visible = TRUE THEN
			
			tabpage_interrupciones.tv_1.HideSelection = FALSE
			ll_item = tabpage_interrupciones.tv_1.FindItem(RootTreeItem!,0)
			tabpage_interrupciones.tv_1.Event selectionchanged(0,ll_item)
			tabpage_interrupciones.tv_1.SelectItem(ll_item)
			tabpage_interrupciones.d_lista_otras_inst_ant.SelectRow(0,False)
		END IF

	CASE tabpage_seguimiento	// Seguimiento

		ib_cancelo_seg = FALSE
		
		//chequea y habilita el ind de resuelve mantenimiento
		frn_habilita_resuelve_mant()
		
		//habilita o desabilita el seguimiento segun el usuario
		this.frn_h_seguimiento_segun_perfil(ii_incid_suministro,tabpage_seguimiento.d_seguimiento_operaciones,is_accion_llamada)

		// Seteo el checkbox "Resuelve mant"
		IF gi_resuelve_mant = 1 THEN
			tabpage_seguimiento.chk_resolucion_mant.Checked = True
		ELSEIF gi_resuelve_mant = 0 THEN
			tabpage_seguimiento.chk_resolucion_mant.Checked = False
		END IF
		
		IF ii_estado_oper >= fgci_incidencia_resuelta THEN
			tabpage_seguimiento.d_seguimiento_mantenimiento.enabled = FALSE
		END IF

		tabpage_seguimiento.d_seguimiento_operaciones.Setrow(1)
		This.setfocus()

	CASE tabpage_acciones	// Acciones
		IF tabpage_acciones.d_lista_acciones_incidencia.RowCount() > 0 THEN
			fnu_devolver_obs_accion(tabpage_acciones.d_lista_acciones_incidencia,tabpage_acciones.mle_observacion_accion_incidencia,ll_row_acc_inc_acc)
			tabpage_acciones.d_lista_acciones_incidencia.Event RowFocusChanged(ll_row_acc_inc_acc)
			tabpage_acciones.d_lista_acciones_incidencia.SetFocus()
		END IF

	//***************************************
	//**  OSGI 2001.1  	13/06/2001			**

	//**  Jair Padilla / Soluziona PANAMA  **
	//***************************************
	CASE tabpage_otros	// Otros
		If tabpage_formulario.d_inf_general.GetItemNumber(1,"estado_actual") >= fgci_incidencia_resuelta Then
// Modificado por Sgo. Unificaci$$HEX1$$f300$$ENDHEX$$n.
//			tabpage_seguimiento.d_seguimiento_operaciones.modify("observacion.background.Color ="+string(65536*192+256*192+192))
//			tabpage_seguimiento.d_seguimiento_operaciones.modify("f_alta.background.Color ="+string(65536*192+256*192+192))	
			tabpage_seguimiento.d_seguimiento_operaciones.modify("observacion.background.Color =" + gs_gris)
			tabpage_seguimiento.d_seguimiento_operaciones.modify("f_alta.background.Color =" + gs_gris)
// Fin. Sgo.
			tabpage_seguimiento.d_seguimiento_operaciones.Modify("f_alta.protect=1")
			tabpage_seguimiento.d_seguimiento_operaciones.Modify("observacion.Edit.DisplayOnly=Yes")

			
		
		End If
	//***************************************
	//**  OSGI 2001.1  	13/06/2001			**
	//**  Jair Padilla / Soluziona PANAMA  **
	//***************************************



	END CHOOSE

//A$$HEX1$$f100$$ENDHEX$$adido por RCA(04-03-20008) Incidencia: 555693. Inicializamos los datos de la OT.
ELSEIF (pl_indice_viejo = 10) THEN
	IF tabpage_ot.d_datos_ot.RowCount() = 0 THEN
		iw_contenedora.tab_1.f_mostrar_datos_ot(tabpage_ot.d_datos_ot,il_nro_ot)	
	END IF	
//Fin a$$HEX1$$f100$$ENDHEX$$adido RCA(04-03-20008)
END IF
		
//////////////////////////
// En el siguiente choose-case se ejecuta el codigo del evento CLOSE de la
// ventana de origen, si corresponde, y se llama a una funcion que realiza
// lo que realizaba el evento activate de la w_2301_form_incidencias.
// Se sustituyo dicho evento por funciones del tab

IF (NOT ISNULL(pl_indice_viejo)) and (pl_indice_viejo <= 7) and (pl_indice_viejo > 0)  THEN

	CHOOSE CASE This.control[pl_indice_viejo]
		CASE tabpage_formulario	// El formulario
			
		CASE tabpage_observaciones	// Observaciones
			tabpage_formulario.d_inf_general.SetItem(1,"observacion",tabpage_observaciones.mle_observaciones.Text)
			iw_contenedora.triggerEvent("ue_pos_activate")
			iw_contenedora.ib_post_activate = false
			
		CASE tabpage_ot	// OT
			
			//	Si he cambiado de tab y he asignado una ot pongo invisible el bot$$HEX1$$f300$$ENDHEX$$n de las OT
			if il_nro_ot > 0 and not isnull(il_nro_ot) then
				tabpage_ot.cb_ot.visible=false
				// A$$HEX1$$d100$$ENDHEX$$ADIR ESTADO EB	
				if isnull(idt_fecha_er) then
					ldt_fecha = idt_fecha_sr
				else
					ldt_fecha = idt_fecha_er
				end if
					
				ldt_f_desde = tabpage_ot.d_datos_ot.object.f_desde[1]
					
				if ii_estado_oper > fgci_incidencia_enviado_brigada and ldt_f_desde <= ldt_fecha &
					and ii_incidencia_enviado_brigada = 0 then
					fnu_anadir_eb(ldt_f_desde)
				end if
					
			end if
		
		CASE tabpage_cuadrillas	// Cuadrillas
			
			iw_contenedora.triggerEvent("ue_pos_activate")
		CASE tabpage_interrupciones	// Interrupciones
			
			iw_contenedora.triggerEvent("ue_pos_activate")
		CASE tabpage_seguimiento	// Seguimiento
			
			iw_contenedora.triggerEvent("ue_pos_activate")
		CASE tabpage_acciones	// Acciones
			
			iw_contenedora.triggerEvent("ue_pos_activate")
	
	//***************************************
	//**  OSGI 2001.1  	13/06/2001			**
	//**  Jair Padilla / Soluziona PANAMA  **
	//***************************************
		CASE tabpage_otros	// Otros
			
			iw_contenedora.triggerEvent("ue_pos_activate")
	//***************************************
	//**  OSGI 2001.1  	13/06/2001			**
	//**  Jair Padilla / Soluziona PANAMA  **
	//***************************************

	END CHOOSE

END IF
IF ii_estado_oper >= fgci_incidencia_resuelta then
	iw_contenedora.tab_1.fnu_deshabilito_al_resolver()
END IF
end subroutine

public function boolean frn_evaluo_f_res_estimada ();//////////////////////////////////////////////////////////
//
// Funci$$HEX1$$f300$$ENDHEX$$n: frn_evaluo_f_deteccion
//
// Objetivo: Evalua fecha de detecci$$HEX1$$f300$$ENDHEX$$n.
//
// Ambito: P$$HEX1$$fa00$$ENDHEX$$blico
//
// Par$$HEX1$$e100$$ENDHEX$$metros:
//        Entrada: pd_dw, pdt_fec_ant
//        Salida : --
//
// Devuelve: 
//
// Fecha		Responsable		Actuaci$$HEX1$$f300$$ENDHEX$$n
// -----	 	-----------		---------
//
///////////////////////////////////////////////////////////
datetime ld_f_est
datetime ld_f_det

ld_f_est=tabpage_formulario.d_inf_general.getitemdatetime(1,'f_est_res')
ld_f_det=tabpage_formulario.d_inf_general.getitemdatetime(1,'f_deteccion')
if ld_f_est < ld_f_det and not isnull(ld_f_est) then
	//messagebox("Atenci$$HEX1$$f300$$ENDHEX$$n","La fecha de resoluci$$HEX1$$f300$$ENDHEX$$n estimada no debe ser menor que la fecha de detecci$$HEX1$$f300$$ENDHEX$$n")
	gnv_msg.f_mensaje("AI105","","",OK!)
	tabpage_formulario.d_inf_general.SetItem(1,'f_est_res', idt_fec_est_res)
	tabpage_formulario.d_inf_general.Accepttext()
	return false
end if
idt_fec_est_res=ld_f_est

return true
end function

public function boolean f_inserta_datos_brig ();///////////////////////
/// inserta la brigada seleccionada en la datawindows de informacion
///
/// Realizado por FDB
////////////////////////77
long ll_num_fila
long ll_nro_brigada
long ll_cant_filas
long ll_contador 
string ls_nombre , ls_nombre_leido

ll_cant_filas= tabpage_ot.d_lista_brigadas_ot.ROWCOUNT()

IF ll_cant_filas>0 THEN
	ll_num_fila=tabpage_ot.d_lista_brigadas_ot.find("ind_responsable=1",1,ll_cant_filas)
	
	// SI NO EXISTE RESPONSABLE ES POR QUE SON CONTRATAS O ESTA VACIA LA OT
	if ll_num_fila >0  then 
		ll_nro_brigada = tabpage_ot.d_lista_brigadas_ot.getitemnumber(ll_num_fila,"nro_brigada")
	ELSE
		// BUSCAMOS LA PRIMERA CONTRATA POR ORDEN ALFABETICO
		
		ll_num_fila = 1
		ls_nombre = tabpage_ot.d_lista_brigadas_ot.getitemstring(ll_num_fila,"brigada") 
		
	for  ll_contador = 1 to ll_cant_filas
		
		ls_nombre_leido = tabpage_ot.d_lista_brigadas_ot.getitemstring(ll_contador,"brigada") 
			
			if ls_nombre_leido  < ls_nombre then 
				ll_num_fila = ll_contador

			end if
	 next 
	END IF
	
	IF ll_num_fila > 0 THEN
		
		tabpage_formulario.d_inf_general.setitem(1,"nom_brigada",tabpage_ot.d_lista_brigadas_ot.getitemstring(ll_num_fila,"brigada"))
		if ll_nro_brigada > 0 then 
				tabpage_formulario.d_inf_general.setitem(1,"brigada",tabpage_ot.d_lista_brigadas_ot.getitemnumber(ll_num_fila,"nro_brigada"))
		end if
		return true
		
	ELSE 
		return false
	END IF
ELSE
	return false
END IF


end function

public function integer f_deshab_tabs (boolean pb_primera);///////////////////////////////////////////////////////
//										
// Funcion/Evento: f_deshab_tabs()
// 
// Objetivo: Habilita y deshabilita los tabs, segun el estado en 
//				 operaciones en el que se encuentre. Tambi$$HEX1$$e900$$ENDHEX$$n tiene en 
//				 cuenta, el caso de que la ot se quede sin brigadas.
//
// Responsable: FDO 
//
// Par$$HEX1$$e100$$ENDHEX$$metros:
//    Entrada: pb_primera
//		Salida : -1 si fall$$HEX1$$f300$$ENDHEX$$
//
// Devuelve:
//
// Fecha      Responsable   Actuaci$$HEX1$$f300$$ENDHEX$$n
// ------	   -----------  ---------
// 15/09/98    FDO
//					LFE			Adaptaci$$HEX1$$f300$$ENDHEX$$n versi$$HEX1$$f300$$ENDHEX$$n 2001.1
//
///////////////////////////////////////////////////////
int	li_ocen				//Valor del par$$HEX1$$e100$$ENDHEX$$metro indicador de OCEN
int 	li_hayOT				//Almacena el n$$HEX1$$fa00$$ENDHEX$$mero de OT de OCEN
int	li_estadoActual	//Estado actual de la incidencia
int	li_estadoMant		//Estado mantenimiento de la incidencia
long ll_causa, ll_tension
string ls_obs, ls_observaciones
ls_obs=f_devolver_observaciones(tabpage_formulario.d_inf_general)
ls_observaciones = tabpage_observaciones.mle_observaciones.text

li_ocen = fg_valor_parametro("OCEN")


if isnull(ls_observaciones) then
	ls_observaciones = ""
end if

ll_causa = tabpage_formulario.d_inf_general.getitemnumber(1,"causa")
ll_tension = tabpage_formulario.d_inf_general.getitemnumber(1,"tip_tension")

if isnull(ll_causa) then
	ll_causa = 0
end if

tabpage_formulario.d_inf_general.accepttext()
ll_causa = tabpage_formulario.d_inf_general.getitemnumber(1,"causa")
ll_tension = tabpage_formulario.d_inf_general.getitemnumber(1,"tip_tension")
if isnull(ll_causa) then

	ll_causa = 0
end if


//AHM(24/10/2010) Integraci$$HEX1$$f300$$ENDHEX$$n OSGI - OSGM
li_estadoActual = tabpage_formulario.d_inf_general.getitemnumber(1,"estado_actual")
li_estadoMant = tabpage_formulario.d_inf_general.getitemnumber(1,"estado_mantenimiento")

// Si la incidencia est$$HEX2$$e1002000$$ENDHEX$$resuelta se deshabilitan los controles
//AHU (06/03/2009) -> Cuando se ha realizado una solicitus OCEN debe deshabilitarse la incidencia
IF li_ocen = 1 THEN //JME 22/07/09 Codificado por AHU
	IF tabpage_ocen.uo_ot_ocen.dw_ot_ocen.rowcount() > 0 THEN
		li_hayOt = tabpage_ocen.uo_ot_ocen.dw_ot_ocen.getItemNumber(1, "nro_sol_ocen")
	ELSE		
		
		SELECT nro_sol_ocen
		INTO   :li_hayOt
		FROM 	 GI_OCEN_OT
		WHERE  nro_incidencia = :il_nro_incidencia;
		
		IF li_hayOt = 0 THEN
			setNull(li_hayOt)
		END IF		
		
	END IF
ELSEIF (li_estadoMant >= 2 AND gb_interfaseOsgm) THEN
	li_hayOt = 1
END IF


//AHU (03/04/2008) Solo bloqueamos la causa una vez que hemos enviado a OCEN
/*If tabpage_formulario.d_inf_general.getitemnumber(1,"estado_actual")>=fgci_incidencia_resuelta OR (NOT(isNull(li_hayOT)) AND li_hayOt >0) THEN*/
If (li_estadoActual >=fgci_incidencia_resuelta) OR (li_estadoMant >= 2 AND gb_interfaseOsgm) THEN
	//AHM (23/07/2009) Mejora 1/578477
	IF NOT fg_verifica_parametro('CAMBIO CAUSA INCIDENCIA RESUELTA') OR li_estadoMant > 1 THEN
		tabpage_formulario.st_1.visible = false
	END IF
	//Fin AHM	
	tabpage_formulario.st_18.visible = false // TDA.EDM-2
	tabpage_formulario.st_2.visible = false
	
	tabpage_observaciones.mle_observaciones.displayonly = True
	tabpage_cuadrillas.cb_agregar.enabled = false
	tabpage_cuadrillas.cb_eliminar.enabled = false
	tabpage_ot.tab_lista_brigadas.enabled = false
	tabpage_ot.dw_lista_contratas.enabled = false
	tabpage_ot.dw_ambito.fnu_des_centro()
	tabpage_ot.dw_ambito.fnu_des_cmd()
	tabpage_ot.dw_ambito.fnu_des_puesto()
	tabpage_ot.d_crit_seleccion.enabled=false

	tabpage_ot.d_crit_seleccion.object.pi_tipo_brig.background.color=gs_gris
	tabpage_ot.d_crit_seleccion.object.pdt_fecha_turno.background.color=gs_gris
	tabpage_ot.d_crit_seleccion.object.pi_brigadas_en_turno.background.color=gs_gris
	tabpage_ot.rb_1.enabled = FALSE
	tabpage_ot.rb_2.enabled = FALSE
	tabpage_ot.d_datos_ot.Modify("descripcion.edit.displayonly=yes")
	tabpage_ot.d_datos_ot.Modify("descripcion.background.color="+gs_gris)
	tabpage_cuadrillas.d_materiales.fpr_habilitar_campos(False)
	tabpage_cuadrillas.cb_agregar.visible = False
	tabpage_cuadrillas.cb_eliminar.Visible = False
	tabpage_interrupciones.uo_eltos_corte.cb_mas.visible = False
	tabpage_interrupciones.uo_eltos_corte.cb_menos.visible = False		
	if tabpage_interrupciones.uo_eltos_corte.dw_elementos_corte.rowcount() > 0 then
		tabpage_interrupciones.uo_eltos_corte.dw_elementos_corte.object.matricula.protect = true
		tabpage_interrupciones.uo_eltos_corte.dw_elementos_corte.object.matricula.background.color = gs_gris		
	end if	
//***************************************
//**  OSGI 2001.1  	21/05/2001			**
//**  Jair Padilla / Soluziona PANAMA  **
//***************************************
//**  OSGI 2001.1  	21/05/2001  	tabpage_seguimiento.d_seguimiento_operaciones.enabled = false
//***************************************
//**  OSGI 2001.1  	21/05/2001			**
//**  Jair Padilla / Soluziona PANAMA  **
//***************************************

	tabpage_seguimiento.d_seguimiento_mantenimiento.enabled = false
	tabpage_acciones.d_lista_acciones.enabled = false
	tabpage_acciones.mle_observacion_accion_incidencia.DisplayOnly = True
	tabpage_acciones.mle_observacion_accion_incidencia.backcolor = long(gs_gris)
	//AHM (18/12/2008)
	tabpage_otros.dw_otros.enabled = FALSE
	tabpage_otros.dw_otros.Modify("tension_origen.background.color="+gs_gris)
	tabpage_otros.dw_otros.Modify("tension_afectada.background.color="+gs_gris)
	tabpage_otros.dw_otros.Modify("agente.background.color="+gs_gris)
	tabpage_otros.dw_otros.Modify("area_afec.background.color="+gs_gris)
	IF li_ocen = 1 OR gb_interfaseOsgm THEN
		tabpage_ocen.uo_ot_ocen.mle_comentarios.backcolor = long(gs_gris)
		tabpage_ocen.uo_ot_ocen.dw_servicios.Modify("descripcion.background.color="+gs_gris)
		tabpage_ocen.uo_ot_ocen.dw_servicios.Modify("codigo.background.color="+gs_gris)
		tabpage_ocen.uo_ot_ocen.dw_servicios.enabled = FALSE
		tabpage_ocen.uo_ot_ocen.enabled = FALSE
	END IF
end if

// Si la incidencia est$$HEX2$$e1002000$$ENDHEX$$en entado inferior a servicio repuesto se habilita el 
// control que asigna la causa de la incidencia
if ii_estado_oper  < fgci_incidencia_servicio_repuesto AND (isNull(li_estadoMant) OR li_estadoMant = 1) then
//	tabpage_formulario.st_1.visible = true
//	tabpage_formulario.st_18.visible = true
else
	
//GNU 3-10-2006. Incidencia correo
//	IF ii_estado_oper = fgci_incidencia_servicio_repuesto AND &
//		ii_alcance <> fgci_incidencia_con_interrupcion THEN
//		tabpage_ot.tab_lista_brigadas.enabled = false
//		tabpage_ot.dw_lista_contratas.enabled = false
//		tabpage_interrupciones.uo_eltos_corte.cb_mas.visible = False
//		tabpage_interrupciones.uo_eltos_corte.cb_menos.visible = False		
//		if tabpage_interrupciones.uo_eltos_corte.dw_elementos_corte.rowcount() > 0 then		
//			tabpage_interrupciones.uo_eltos_corte.dw_elementos_corte.object.matricula.protect = true
//			tabpage_interrupciones.uo_eltos_corte.dw_elementos_corte.object.matricula.background.color = gs_gris
//		end if	
//	END IF
	
		IF ii_estado_oper = fgci_incidencia_servicio_repuesto THEN
			IF isNull(li_estadoMant) OR li_estadoMant = 1 THEN
				tabpage_formulario.st_1.visible = true
//				tabpage_formulario.st_18.visible = true // TDA.EDM-2
			END IF
			IF ii_alcance <> fgci_incidencia_con_interrupcion THEN
				tabpage_ot.tab_lista_brigadas.enabled = false
				tabpage_ot.dw_lista_contratas.enabled = false
				tabpage_interrupciones.uo_eltos_corte.cb_mas.visible = False
				tabpage_interrupciones.uo_eltos_corte.cb_menos.visible = False		
				if tabpage_interrupciones.uo_eltos_corte.dw_elementos_corte.rowcount() > 0 then		
					tabpage_interrupciones.uo_eltos_corte.dw_elementos_corte.object.matricula.protect = true
					tabpage_interrupciones.uo_eltos_corte.dw_elementos_corte.object.matricula.background.color = gs_gris
				end if
			END IF
	END IF
// FIN GNU

	// GNU 5-7-2006. Incidencia correo
//	IF (IsNull(tabpage_formulario.d_inf_general.GetItemNumber(1, 'causa')) OR &
//		 tabpage_formulario.d_inf_general.GetItemNumber(1, 'causa') = fgci_cod_causa_desconocida )  THEN
//		 
//		tabpage_formulario.st_1.visible = TRUE
//	ELSE
//		tabpage_formulario.st_1.visible = FALSE
//	END IF
	// FIN GNU
	
end if			

IF 	tabpage_formulario.d_inf_general.object.st_causa.Text <> "" THEN
//	tabpage_formulario.d_inf_general.modify("fec_causa.protect=0")
//	tabpage_formulario.d_inf_general.modify("fec_causa.background.color=" + gs_blanco)
else
	tabpage_formulario.d_inf_general.modify("fec_causa.protect=1")
	tabpage_formulario.d_inf_general.modify("fec_causa.background.color=" + gs_gris)
end if

if ii_estado_oper >= fgci_incidencia_pendiente and (ii_estado_oper < fgci_incidencia_resuelta) AND (isNull(li_estadoMant) OR (li_estadoMant = 1))then
	tabpage_formulario.d_inf_general.enabled=true
	if ii_tipo_incid <> fgci_incidencia_programada AND ii_tipo_incid <> fgci_incidencia_calidad AND &
		ii_alcance <> fgci_incidencia_de_suministro AND NOT iw_contenedora.fw_incidencia_de_operaciones() then
		
//		iw_contenedora.tab_1.tabpage_formulario.d_inf_general.modify("f_deteccion.background.color="+gs_blanco)
//		iw_contenedora.tab_1.tabpage_formulario.d_inf_general.modify("f_deteccion.protect=0")
//		tabpage_formulario.d_inf_general.Modify("Causa.Background.Color=" + gs_blanco)
	ELSEIF ii_tipo_incid = fgci_incidencia_programada THEN
		iw_contenedora.tab_1.tabpage_formulario.d_inf_general.modify("f_deteccion.background.color="+gs_gris)
		iw_contenedora.tab_1.tabpage_formulario.d_inf_general.modify("f_deteccion.protect=1")
	END IF
//	iw_contenedora.tab_1.tabpage_formulario.d_inf_general.modify("desc.background.color="+gs_blanco)
//	iw_contenedora.tab_1.tabpage_formulario.d_inf_general.modify("f_est_res.background.color="+gs_blanco)
	//LSH INI 08/09/2013 evolutivo DEO12-00000263
	//tabpage_ot.d_datos_ot.SetItem(1,"f_elim_peligro", idt_fec_elim_peligro)
	IF date(idt_fec_elim_peligro) <> date("01/01/1900") THEN
		tabpage_ot.d_datos_ot.SetItem(1,"f_elim_peligro", idt_fec_elim_peligro)
	END IF
	//iw_contenedora.tab_1.tabpage_formulario.d_inf_general.modify("f_elim_peligro.background.color="+gs_blanco)
	//LSH FIN 08/09/2013 evolutivo DEO12-00000263
end if

this.setredraw(false)
	
// Incidencias con interrupci$$HEX1$$f300$$ENDHEX$$n
if iw_contenedora.lu_comunic.is_comunic.accion_llamada <> "Alta_nivel_suministro" and &
	ii_alcance = fgci_incidencia_con_interrupcion THEN
	
	// Se controla la visibilidad/invisibilidad de los tabpages en funci$$HEX1$$f300$$ENDHEX$$n de la incidencia
	IF iw_contenedora.fw_incidencia_de_operaciones() THEN
		IF iw_contenedora.lu_comunic.is_comunic.accion_llamada <> "Alta_nivel_instalacion" THEN
			// Como hay interfaz con operaciones se hace visible el tab de maniobras			
			tabpage_maniobras.visible=true			// Maniobras			
			tabpage_maniobras.enabled = true
		END IF
		IF gb_red_trifasica = FALSE THEN
			tabpage_formulario.st_fases.visible = FALSE
		END IF
	ELSE	
		tabpage_formulario.st_fases.visible = ii_estado_oper < fgci_incidencia_servicio_repuesto &
														  AND NOT gb_red_trifasica &
														  AND iw_contenedora.lu_comunic.is_comunic.accion_llamada <> "Consulta"
	//	tabpage_maniobras.visible=false			// Maniobras		
	END IF

// FDO SCADA	
//	IF ii_estado_oper > fgci_incidencia_enviado_brigada THEN
//		IF ii_tipo_incid = fgci_incidencia_scada AND &
//			tabpage_ot.d_lista_brigadas_ot.RowCount() <= 0 THEN
//			// Si la incidencia procede de SCADA y no hay estado EB, se hacen invisibles los
//			// tabpages que est$$HEX1$$e100$$ENDHEX$$n afectados por la existencia de la OT
//			tabpage_ot.visible = false
//			tabpage_cuadrillas.visible=false
//			tabpage_acciones.visible=false
//		END IF
//	END IF
// FDO SCADA

	IF iw_contenedora.lu_comunic.is_comunic.accion_llamada = "Consulta" OR &
		ii_estado_oper <> fgci_incidencia_servicio_repuesto THEN
//Comentado por GNU 26-09-2005 Incidencia 0/373898
// A$$HEX1$$f100$$ENDHEX$$adido por Sgo. 06/07/2005. Mejora Moldavia.
//		If gi_pais = 8 Then
//			tabpage_ot.d_datos_ot.Modify("f_prepara_lm.protect=1")
//			tabpage_ot.d_datos_ot.Modify("f_prepara_lm.background.color=" + gs_gris)
////		End If
// Fin. Sgo.
//Fin GNU
		tabpage_ot.d_datos_ot.Modify("f_hasta.protect=1")
		tabpage_ot.d_datos_ot.Modify("f_hasta.background.color="+gs_gris)

		//LSH INI 08/09/2013 evolutivo DEO12-00000263
		//tabpage_ot.d_datos_ot.SetItem(1,"f_elim_peligro", idt_fec_elim_peligro)
		IF date(idt_fec_elim_peligro) <> date("01/01/1900") THEN
			tabpage_ot.d_datos_ot.SetItem(1,"f_elim_peligro", idt_fec_elim_peligro)
		END IF


		//LSH INI 02/10/2013 evolutivo DEO12-00000263
		IF iw_contenedora.lu_comunic.is_comunic.accion_llamada = "Consulta"  THEN
			IF date(idt_fec_elim_peligro) <> date("01/01/1900") THEN
				tabpage_ot.d_datos_ot.SetItem(1,"f_elim_peligro", idt_fec_elim_peligro)
			END IF
			tabpage_ot.d_datos_ot.Modify("f_elim_peligro.protect=1")
			tabpage_ot.d_datos_ot.Modify("f_elim_peligro.background.color="+gs_gris)
		ELSE
			IF date(idt_fec_elim_peligro) <> date("01/01/1900") THEN
				tabpage_ot.d_datos_ot.SetItem(1,"f_elim_peligro", idt_fec_elim_peligro)
			END IF
//			tabpage_ot.d_datos_ot.Modify("f_elim_peligro.protect=0")
//			tabpage_ot.d_datos_ot.Modify("f_elim_peligro.background.color="+gs_blanco)
		END IF
		//LSH FIN 02/10/2013 evolutivo DEO12-00000263



		//tabpage_ot.d_datos_ot.Modify("f_elim_peligro.protect=1")
		//tabpage_ot.d_datos_ot.Modify("f_elim_peligro.background.color="+gs_gris)
		//LSH FIN 08/09/2013 evolutivo DEO12-00000263

	END IF
	// Ahora se controla la habilitaci$$HEX1$$f300$$ENDHEX$$n/deshabilitaci$$HEX1$$f300$$ENDHEX$$n de los tabpages en funci$$HEX1$$f300$$ENDHEX$$n 
	// del estado de la incidencia
	choose case ii_estado_oper
		case fgci_incidencia_pendiente
			tabpage_formulario.enabled=true        // Incidencia
			IF isnull(idec_nro_instalacion_afectada) THEN
				tabpage_observaciones.enabled=false
				tabpage_interrupciones.enabled=false
				tabpage_seguimiento.enabled=false 		// Seguimiento
				tabpage_ot.enabled=false
				IF li_ocen = 1 OR gb_interfaseOsgm THEN
					tabpage_ocen.enabled=false
				END IF
			ELSE
				tabpage_interrupciones.enabled=True
				tabpage_observaciones.enabled=true 		// Observaciones
				tabpage_seguimiento.enabled=True 		// Seguimiento
				IF li_ocen = 1 OR gb_interfaseOsgm THEN
					tabpage_ocen.enabled=true
				END IF
				tabpage_ot.enabled= True
			END IF
			tabpage_cuadrillas.enabled=false			// Materiales
			tabpage_acciones.enabled=false			// Acciones
		
		case fgci_incidencia_enviado_brigada
			tabpage_formulario.enabled=true        // Incidencia
			tabpage_observaciones.enabled=true 		// Observaciones
			tabpage_interrupciones.enabled=True 	// Interrupciones
			tabpage_seguimiento.enabled=True 		// Seguimiento
			IF li_ocen = 1  OR gb_interfaseOsgm THEN
				tabpage_ocen.enabled=TRUE
			END IF
			tabpage_ot.enabled = true
			// A$$HEX1$$f100$$ENDHEX$$adido por GNU 14/11/2005. Incidencia 0/373898
				If gi_pais = 8  and iw_contenedora.lu_comunic.is_comunic.accion_llamada = "Modificacion" Then
//					tabpage_ot.d_datos_ot.Modify("f_prepara_lm.protect=0")
//					tabpage_ot.d_datos_ot.Modify("f_prepara_lm.background.color=" + gs_blanco)
				End If
		// Fin. GNU

		case fgci_incidencia_en_reposicion
			tabpage_formulario.enabled=true
			tabpage_observaciones.enabled=true
			tabpage_ot.enabled=true
			tabpage_interrupciones.enabled=true
			tabpage_seguimiento.enabled=true
			IF li_ocen = 1 OR gb_interfaseOsgm THEN
				tabpage_ocen.enabled=true
			END IF
		case fgci_incidencia_servicio_repuesto
			tabpage_formulario.enabled=true
			tabpage_observaciones.enabled=true
			tabpage_ot.enabled=true
			tabpage_interrupciones.enabled=true
			tabpage_seguimiento.enabled=true
			IF li_ocen = 1 OR gb_interfaseOsgm THEN
				tabpage_ocen.enabled=true
			END IF
			tabpage_formulario.d_inf_general.modify("f_deteccion.background.color="+gs_gris)
			tabpage_formulario.d_inf_general.modify("f_deteccion.protect=1")
			tabpage_formulario.d_inf_general.modify("f_est_res.background.color="+gs_gris)
			tabpage_formulario.d_inf_general.modify("f_est_res.protect=1")
			//LSH INI 08/09/2013 evolutivo DEO12-00000263
			//tabpage_ot.d_datos_ot.SetItem(1,"f_elim_peligro", idt_fec_elim_peligro)
			IF date(idt_fec_elim_peligro) <> date("01/01/1900") THEN
				tabpage_ot.d_datos_ot.SetItem(1,"f_elim_peligro", idt_fec_elim_peligro)
			END IF
			tabpage_formulario.d_inf_general.modify("f_elim_peligro.background.color="+gs_gris)
			tabpage_formulario.d_inf_general.modify("f_elim_peligro.protect=1")
			//LSH FIN 08/09/2013 evolutivo DEO12-00000263
			//AHM (02/11/2011) Intergraci$$HEX1$$f300$$ENDHEX$$n OSGI - OSGM
			IF iw_contenedora.lu_comunic.is_comunic.accion_llamada <> "Consulta" AND &
				tabpage_ot.d_datos_ot.GetItemNumber(1,'est_ot') = fgci_ot_trabajando &
				AND (NOT gb_interfaseOsgm OR (gb_interfaseOsgm AND tabpage_formulario.d_inf_general.getItemNumber(1, "estado_mantenimiento") < 2)) THEN

// A$$HEX1$$f100$$ENDHEX$$adido por Sgo. 06/07/2005. Mejora Moldavia.
				If gi_pais = 8 Then
//					tabpage_ot.d_datos_ot.Modify("f_prepara_lm.protect=0")
//					tabpage_ot.d_datos_ot.Modify("f_prepara_lm.background.color=" + gs_blanco)
				End If
// Fin. Sgo.

//				tabpage_ot.d_datos_ot.Modify("f_hasta.protect=0")
//				tabpage_ot.d_datos_ot.Modify("f_hasta.background.color="+gs_blanco)
				
				//LSH INI 08/09/2013 evolutivo DEO12-00000263
				//tabpage_ot.d_datos_ot.SetItem(1,"f_elim_peligro", idt_fec_elim_peligro)
				IF date(idt_fec_elim_peligro) <> date("01/01/1900") THEN
					tabpage_ot.d_datos_ot.SetItem(1,"f_elim_peligro", idt_fec_elim_peligro)
				END IF
//				tabpage_ot.d_datos_ot.Modify("f_elim_peligro.protect=0")
//				tabpage_ot.d_datos_ot.Modify("f_elim_peligro.background.color="+gs_blanco)
				IF date(idt_fec_elim_peligro) <> date("01/01/1900") THEN
					tabpage_ot.d_datos_ot.SetItem(1,"f_elim_peligro", idt_fec_elim_peligro)
				END IF
				//LSH FIN 08/09/2013 evolutivo DEO12-00000263
			ELSE
// A$$HEX1$$f100$$ENDHEX$$adido por Sgo. 06/07/2005. Mejora Moldavia.
				If gi_pais = 8 Then
					tabpage_ot.d_datos_ot.Modify("f_prepara_lm.protect=1")
					tabpage_ot.d_datos_ot.Modify("f_prepara_lm.background.color=" + gs_gris)
				End If
// Fin. Sgo.
				tabpage_ot.d_datos_ot.Modify("f_hasta.protect=1")
				tabpage_ot.d_datos_ot.Modify("f_hasta.background.color="+gs_gris)

				//LSH INI 08/09/2013 evolutivo DEO12-00000263
				//tabpage_ot.d_datos_ot.SetItem(1,"f_elim_peligro", idt_fec_elim_peligro)
				IF date(idt_fec_elim_peligro) <> date("01/01/1900") THEN
					tabpage_ot.d_datos_ot.SetItem(1,"f_elim_peligro", idt_fec_elim_peligro)
				END IF
				tabpage_ot.d_datos_ot.Modify("f_elim_peligro.protect=1")
				tabpage_ot.d_datos_ot.Modify("f_elim_peligro.background.color="+gs_gris)
				//LSH FIN 08/09/2013 evolutivo DEO12-00000263
			END IF
			
		case fgci_incidencia_resuelta
			tabpage_formulario.enabled=true
			tabpage_observaciones.enabled=true
			tabpage_ot.enabled=true
			tabpage_cuadrillas.enabled=true
			tabpage_interrupciones.enabled=true
			tabpage_seguimiento.enabled=true
			IF li_ocen = 1 OR gb_interfaseOsgm THEN
				tabpage_ocen.enabled=true
			END IF
			tabpage_acciones.enabled=true
			tabpage_formulario.d_inf_general.modify("f_deteccion.background.color="+gs_gris)
			tabpage_formulario.d_inf_general.modify("f_deteccion.protect=1")
			tabpage_formulario.d_inf_general.modify("f_est_res.background.color="+gs_gris)
			tabpage_formulario.d_inf_general.modify("f_est_res.protect=1")
			//LSH INI 08/09/2013 evolutivo DEO12-00000263
			//tabpage_ot.d_datos_ot.SetItem(1,"f_elim_peligro", idt_fec_elim_peligro)
			IF date(idt_fec_elim_peligro) <> date("01/01/1900") THEN
					tabpage_ot.d_datos_ot.SetItem(1,"f_elim_peligro", idt_fec_elim_peligro)
			END IF
			tabpage_formulario.d_inf_general.modify("f_elim_peligro.background.color="+gs_gris)
			tabpage_formulario.d_inf_general.modify("f_elim_peligro.protect=1")
			//LSH FIN 08/09/2013 evolutivo DEO12-00000263
			
			//NCA-INICIO.DDAG-1783.20150304.
				tabpage_formulario.d_inf_general.modify("cod_accion_inc.background.color="+gs_gris)
				tabpage_formulario.d_inf_general.modify("cod_accion_inc.protect=1")		
			//NCA-FIN.DDAG-1783.20150304.	

		case else // estado superior a RS, en caso de que exista interfaz con Open-SGM
			tabpage_formulario.enabled=true
			tabpage_observaciones.enabled=true
			tabpage_ot.enabled=true
			tabpage_cuadrillas.enabled=true
			tabpage_interrupciones.enabled=true
			tabpage_seguimiento.enabled=true
			IF li_ocen = 1 OR gb_interfaseOsgm THEN
				tabpage_ocen.enabled=true
			END IF
			tabpage_acciones.enabled=true
			tabpage_formulario.d_inf_general.modify("f_deteccion.background.color="+gs_gris)
			tabpage_formulario.d_inf_general.modify("f_deteccion.protect=1")
			tabpage_formulario.d_inf_general.modify("f_est_res.background.color="+gs_gris)
			tabpage_formulario.d_inf_general.modify("f_est_res.protect=1")
			//LSH INI 08/09/2013 evolutivo DEO12-00000263
			//tabpage_ot.d_datos_ot.SetItem(1,"f_elim_peligro", idt_fec_elim_peligro)
			IF date(idt_fec_elim_peligro) <> date("01/01/1900") THEN
				tabpage_ot.d_datos_ot.SetItem(1,"f_elim_peligro", idt_fec_elim_peligro)
			END IF
			tabpage_formulario.d_inf_general.modify("f_elim_peligro.background.color="+gs_gris)
			tabpage_formulario.d_inf_general.modify("f_elim_peligro.protect=1")
			//LSH FIN 08/09/2013 evolutivo DEO12-00000263

	end choose

ELSE // incidencias sin interrupci$$HEX1$$f300$$ENDHEX$$n
	tabpage_formulario.st_fases.visible = FALSE
//GNU 11-12-2006. Incidencica EPSA
//	IF ii_tipo_incid = fgci_incidencia_calidad OR ii_alcance = fgci_incidencia_de_suministro THEN
	IF ii_tipo_incid = fgci_incidencia_calidad THEN
// FIN GNU		
		tabpage_formulario.d_inf_general.Modify("f_deteccion.background.color = " + gs_gris)
		tabpage_formulario.d_inf_general.Modify("f_deteccion.protect = 1")
	END IF

// FDO SCADA	
//	IF ii_estado_oper > fgci_incidencia_enviado_brigada THEN
//		IF ii_tipo_incid = fgci_incidencia_scada AND &
//			tabpage_ot.d_lista_brigadas_ot.RowCount() <= 0 THEN
//			// Si la incidencia procede de SCADA y no hay estado EB, se hacen invisibles los
//			// tabpages que est$$HEX1$$e100$$ENDHEX$$n afectados por la existencia de la OT
//			tabpage_ot.visible = false
//			tabpage_cuadrillas.visible=false
//			tabpage_acciones.visible=false
//		END IF
//	END IF
//FDO SCADA


	IF iw_contenedora.lu_comunic.is_comunic.accion_llamada = "Consulta" OR &
		ii_estado_oper <> fgci_incidencia_enviado_brigada THEN
// A$$HEX1$$f100$$ENDHEX$$adido por Sgo. 06/07/2005. Mejora Moldavia.
		If gi_pais = 8 Then
			tabpage_ot.d_datos_ot.Modify("f_prepara_lm.protect=1")
			tabpage_ot.d_datos_ot.Modify("f_prepara_lm.background.color=" + gs_gris)
		End If
// Fin. Sgo.
		tabpage_ot.d_datos_ot.Modify("f_hasta.protect=1")
		tabpage_ot.d_datos_ot.Modify("f_hasta.background.color="+gs_gris)

		//LSH INI 08/09/2013 evolutivo DEO12-00000263
		//tabpage_ot.d_datos_ot.SetItem(1,"f_elim_peligro", idt_fec_elim_peligro)
		IF date(idt_fec_elim_peligro) <> date("01/01/1900") THEN
			tabpage_ot.d_datos_ot.SetItem(1,"f_elim_peligro", idt_fec_elim_peligro)
		END IF
		//tabpage_ot.d_datos_ot.Modify("f_elim_peligro.protect=1")
		//tabpage_ot.d_datos_ot.Modify("f_elim_peligro.background.color="+gs_gris)
		//LSH FIN 08/09/2013 evolutivo DEO12-00000263

	END IF


	// Se habilitan/deshabilitan las pesta$$HEX1$$f100$$ENDHEX$$as en funci$$HEX1$$f300$$ENDHEX$$n del estado	
	choose case ii_estado_oper		
		case fgci_incidencia_pendiente
			tabpage_formulario.enabled=true
         IF isnull(idec_nro_instalacion_afectada) THEN
				tabpage_observaciones.enabled=false
				tabpage_interrupciones.enabled=false
				tabpage_seguimiento.enabled=false 		// Seguimiento
				IF li_ocen = 1 OR gb_interfaseOsgm THEN
					tabpage_ocen.enabled=false
				END IF
				tabpage_ot.enabled=false
			ELSE
				// FDO Mejora 1/244594
				if gi_pais = 4 then // Si el pais es Panam$$HEX1$$e100$$ENDHEX$$
					tabpage_interrupciones.enabled=false
				end if
				// FDO Mejora 1/244594
				tabpage_interrupciones.enabled=True
				tabpage_observaciones.enabled=true 		// Observaciones
				tabpage_seguimiento.enabled=True 		// Seguimiento
				tabpage_ot.enabled=True
				IF li_ocen = 1 OR gb_interfaseOsgm THEN
					tabpage_ocen.enabled=true
				END IF
			END IF
			
			tabpage_acciones.enabled=false
			tabpage_cuadrillas.enabled=false
			
			if len(trim(ls_observaciones)) = 0 and gb_obs_obligatorias = true then
				tabpage_seguimiento.enabled=false
			else
				tabpage_seguimiento.enabled=true 
			end if
			
			
		case fgci_incidencia_enviado_brigada
				IF li_ocen = 1 OR gb_interfaseOsgm THEN
					tabpage_ocen.enabled=true
				END IF
				tabpage_formulario.enabled=true
				tabpage_observaciones.enabled=true
				tabpage_ot.enabled=true
				tabpage_seguimiento.enabled=true
				tabpage_cuadrillas.enabled=true
				tabpage_acciones.enabled=true
				// FDO Mejora 1/244594
				if gi_pais = 4 then // Si el pais es Panam$$HEX1$$e100$$ENDHEX$$
					tabpage_interrupciones.enabled=false
				end if
				// FDO Mejora 1/244594
				IF iw_contenedora.lu_comunic.is_comunic.accion_llamada <> "Consulta" AND &
					NOT iw_contenedora.fw_incidencia_de_operaciones() THEN
// A$$HEX1$$f100$$ENDHEX$$adido por Sgo. 06/07/2005. Mejora Moldavia.
					If gi_pais = 8 Then
//						tabpage_ot.d_datos_ot.Modify("f_prepara_lm.protect=0")
//						tabpage_ot.d_datos_ot.Modify("f_prepara_lm.background.color=" + gs_blanco)
					End If
// Fin. Sgo.
//					tabpage_ot.d_datos_ot.Modify("f_hasta.protect=0")	
//					tabpage_ot.d_datos_ot.Modify("f_hasta.background.color="+gs_blanco)
					
					//LSH INI 08/09/2013 evolutivo DEO12-00000263
					//tabpage_ot.d_datos_ot.SetItem(1,"f_elim_peligro", idt_fec_elim_peligro)
					IF date(idt_fec_elim_peligro) <> date("01/01/1900") THEN
						tabpage_ot.d_datos_ot.SetItem(1,"f_elim_peligro", idt_fec_elim_peligro)
					END IF
//					tabpage_ot.d_datos_ot.Modify("f_elim_peligro.protect=0")
//					tabpage_ot.d_datos_ot.Modify("f_elim_peligro.background.color="+gs_blanco)
					//LSH FIN 08/09/2013 evolutivo DEO12-00000263

				ELSE
// A$$HEX1$$f100$$ENDHEX$$adido por Sgo. 06/07/2005. Mejora Moldavia.
					If gi_pais = 8 Then
						tabpage_ot.d_datos_ot.Modify("f_prepara_lm.protect=1")
						tabpage_ot.d_datos_ot.Modify("f_prepara_lm.background.color=" + gs_gris)
					End If
// Fin. Sgo.
					tabpage_ot.d_datos_ot.Modify("f_hasta.protect=1")	
					tabpage_ot.d_datos_ot.Modify("f_hasta.background.color="+gs_gris)
					
					//LSH INI 08/09/2013 evolutivo DEO12-00000263
					tabpage_ot.d_datos_ot.SetItem(1,"f_elim_peligro", idt_fec_elim_peligro)
					IF date(idt_fec_elim_peligro) <> date("01/01/1900") THEN
						tabpage_ot.d_datos_ot.SetItem(1,"f_elim_peligro", idt_fec_elim_peligro)
					END IF
					tabpage_ot.d_datos_ot.Modify("f_elim_peligro.protect=1")
					tabpage_ot.d_datos_ot.Modify("f_elim_peligro.background.color="+gs_gris)
					//LSH FIN 08/09/2013 evolutivo DEO12-00000263

				END IF
		
		case fgci_incidencia_servicio_repuesto
			// FDO Mejora 1/244594
			if gi_pais = 4 then // Si el pais es Panam$$HEX1$$e100$$ENDHEX$$
				tabpage_interrupciones.enabled=false
			end if
			// FDO Mejora 1/244594
			tabpage_formulario.enabled=true
			tabpage_observaciones.enabled=true
			tabpage_ot.enabled=true
			tabpage_cuadrillas.enabled=true
			tabpage_seguimiento.enabled=true
			IF li_ocen = 1 OR gb_interfaseOsgm THEN
				tabpage_ocen.enabled=true
			END IF
			tabpage_acciones.enabled=true
			tabpage_formulario.d_inf_general.modify("f_deteccion.background.color="+gs_gris)
			tabpage_formulario.d_inf_general.modify("f_deteccion.protect=1")
			tabpage_formulario.d_inf_general.modify("f_est_res.background.color="+gs_gris)
			tabpage_formulario.d_inf_general.modify("f_est_res.protect=1")
			//LSH INI 08/09/2013 evolutivo DEO12-00000263
			//tabpage_ot.d_datos_ot.SetItem(1,"f_elim_peligro", idt_fec_elim_peligro)
			IF date(idt_fec_elim_peligro) <> date("01/01/1900") THEN
				tabpage_ot.d_datos_ot.SetItem(1,"f_elim_peligro", idt_fec_elim_peligro)
			END IF
			tabpage_formulario.d_inf_general.modify("f_elim_peligro.background.color="+gs_gris)
			tabpage_formulario.d_inf_general.modify("f_elim_peligro.protect=1")
			//LSH FIN 08/09/2013 evolutivo DEO12-00000263
			tabpage_formulario.d_inf_general.modify("tipo_luminaria.background.color="+gs_gris)
			tabpage_formulario.d_inf_general.modify("tipo_luminaria.protect=1")
			tabpage_formulario.d_inf_general.modify("lum_reparadas.background.color="+gs_gris)
			tabpage_formulario.d_inf_general.modify("lum_reparadas.protect=1")
			tabpage_ot.tab_lista_brigadas.enabled = false
			tabpage_ot.dw_lista_contratas.enabled = false
			tabpage_ot.dw_ambito.fnu_des_centro()
			tabpage_ot.dw_ambito.fnu_des_cmd()
			tabpage_ot.dw_ambito.fnu_des_puesto()
			tabpage_ot.d_crit_seleccion.enabled=false
			tabpage_ot.d_crit_seleccion.object.pi_tipo_brig.background.color=gs_gris
			tabpage_ot.d_crit_seleccion.object.pdt_fecha_turno.background.color=gs_gris
			tabpage_ot.d_crit_seleccion.object.pi_brigadas_en_turno.background.color=gs_gris
			tabpage_ot.rb_1.enabled = FALSE
			tabpage_ot.rb_2.enabled = FALSE
			tabpage_ot.d_datos_ot.Modify("descripcion.edit.displayonly=yes")
			tabpage_ot.d_datos_ot.Modify("descripcion.background.color="+gs_gris)
			tabpage_formulario.st_2.visible = False
			//AHM (02/11/2011) Integraci$$HEX1$$f300$$ENDHEX$$n OSGI - OSGM
			IF gb_interfaseOsgm THEN
				tabpage_formulario.d_inf_general.enabled = FALSE
				tabpage_formulario.d_inf_general.Modify("desc.background.color="+gs_gris)
			END IF
		case fgci_incidencia_resuelta
			// FDO Mejora 1/244594
			if gi_pais = 4 then // Si el pais es Panam$$HEX1$$e100$$ENDHEX$$
				tabpage_interrupciones.enabled=false
			end if
			// FDO Mejora 1/244594
			tabpage_formulario.enabled=true
			tabpage_observaciones.enabled=true
			tabpage_ot.enabled=true
			tabpage_cuadrillas.enabled=true
			tabpage_seguimiento.enabled=true
			IF li_ocen = 1 OR gb_interfaseOsgm THEN
				tabpage_ocen.enabled=true
			END IF
			tabpage_acciones.enabled=true
			tabpage_formulario.d_inf_general.modify("f_deteccion.background.color="+gs_gris)
			tabpage_formulario.d_inf_general.modify("f_deteccion.protect=1")
			tabpage_formulario.d_inf_general.modify("f_est_res.background.color="+gs_gris)
			tabpage_formulario.d_inf_general.modify("f_est_res.protect=1")
			//LSH INI 08/09/2013 evolutivo DEO12-00000263
			IF date(idt_fec_elim_peligro) <> date("01/01/1900") THEN
				tabpage_ot.d_datos_ot.SetItem(1,"f_elim_peligro", idt_fec_elim_peligro)
			END IF
			//tabpage_ot.d_datos_ot.SetItem(1,"f_elim_peligro", idt_fec_elim_peligro)
			tabpage_formulario.d_inf_general.modify("f_elim_peligro.background.color="+gs_gris)
			tabpage_formulario.d_inf_general.modify("f_elim_peligro.protect=1")
			//LSH FIN 08/09/2013 evolutivo DEO12-00000263
			tabpage_formulario.d_inf_general.modify("tipo_luminaria.background.color="+gs_gris)
			tabpage_formulario.d_inf_general.modify("tipo_luminaria.protect=1")
			tabpage_formulario.d_inf_general.modify("lum_reparadas.background.color="+gs_gris)
			tabpage_formulario.d_inf_general.modify("lum_reparadas.protect=1")
			
			//NCA-INICIO.DDAG-1783.20150304.
				tabpage_formulario.d_inf_general.modify("cod_accion_inc.background.color="+gs_gris)
				tabpage_formulario.d_inf_general.modify("cod_accion_inc.protect=1")						
			//NCA-FIN.DDAG-1783.20150304.
			
		case else // estado superior a RS, en caso de que exista interfaz con Open-SGM
			// FDO Mejora 1/244594			
			tabpage_interrupciones.enabled=false
	// FDO Mejora 1/244594
	IF ii_alcance = fgci_incidencia_sin_interrupcion then //&
//		AND iw_contenedora.fw_incidencia_de_operaciones() then
		
		tabpage_interrupciones.visible=false
			end if
			// FDO Mejora 1/244594
			tabpage_formulario.enabled=true
			tabpage_observaciones.enabled=true
			tabpage_ot.enabled=true
			tabpage_cuadrillas.enabled=true
			tabpage_seguimiento.enabled=true
			IF li_ocen = 1 OR gb_interfaseOsgm THEN
				tabpage_ocen.enabled=true
			END IF
			tabpage_acciones.enabled=true
			tabpage_formulario.d_inf_general.modify("f_deteccion.background.color="+gs_gris)
			tabpage_formulario.d_inf_general.modify("f_deteccion.protect=1")
			tabpage_formulario.d_inf_general.modify("f_est_res.background.color="+gs_gris)
			tabpage_formulario.d_inf_general.modify("f_est_res.protect=1")
			//LSH INI 08/09/2013 evolutivo DEO12-00000263
			//tabpage_ot.d_datos_ot.SetItem(1,"f_elim_peligro", idt_fec_elim_peligro)
			IF date(idt_fec_elim_peligro) <> date("01/01/1900") THEN
				tabpage_ot.d_datos_ot.SetItem(1,"f_elim_peligro", idt_fec_elim_peligro)
			END IF
			tabpage_formulario.d_inf_general.modify("f_elim_peligro.background.color="+gs_gris)
			tabpage_formulario.d_inf_general.modify("f_elim_peligro.protect=1")
			//LSH FIN 08/09/2013 evolutivo DEO12-00000263
			tabpage_formulario.d_inf_general.modify("tipo_luminaria.background.color="+gs_gris)
			tabpage_formulario.d_inf_general.modify("tipo_luminaria.protect=1")
			tabpage_formulario.d_inf_general.modify("lum_reparadas.background.color="+gs_gris)
			tabpage_formulario.d_inf_general.modify("lum_reparadas.protect=1")

	end choose	
	// FDO Mejora 1/244594
	if gi_pais = 4 then // Si el pais es Panam$$HEX1$$e100$$ENDHEX$$
		tabpage_interrupciones.enabled=false
	else
		IF ii_alcance = fgci_incidencia_sin_interrupcion &
		AND iw_contenedora.fw_incidencia_de_operaciones() then
			tabpage_interrupciones.visible=false
		END IF
	END IF	
	// FDO Mejora 1/244594
END IF

If tabpage_ot.d_lista_brigadas_ot.RowCount() > 0 then
	tabpage_cuadrillas.enabled=true
	tabpage_acciones.enabled=true	
else
	tabpage_cuadrillas.enabled=false
	tabpage_acciones.enabled=false
end if
/*AHU (03/04/2009) Solo deshabilitamos la causa y el tab de OCEN cuando hay una solicitud OCEN*/
//AHU (06/03/2008) -> Deshabilitamos tabs cuando hay una OT de OCEN
	IF (NOT(isNull(li_hayOT)) AND li_hayOt >0) OR ii_estado_oper = fgci_incidencia_resuelta THEN
		/*tabpage_formulario.d_inf_general.enabled = FALSE
		tabpage_formulario.st_1.enabled = FALSE
		tabpage_interrupciones.tv_1.enabled = FALSE
		tabpage_seguimiento.d_seguimiento_operaciones.enabled = FALSE
		tabpage_seguimiento.d_seguimiento_mantenimiento.enabled = FALSE
		tabpage_seguimiento.d_estados_operaciones.enabled = FALSE
		tabpage_maniobras.dw_maniobras.enabled = FALSE
		tabpage_indisponibilidades.tv_2.enabled = FALSE
		tabpage_indisponibilidades.dw_lista_indisponibilidades.enabled = FALSE
		tabpage_indisponibilidades.dw_datos_indisponibilidades.enabled = FALSE
		tabpage_indisponibilidades.cb_maniobras.enabled = FALSE*/
		
		//AHM (23/07/2009) Mejora 1/578477
		IF NOT fg_verifica_parametro('CAMBIO CAUSA INCIDENCIA RESUELTA') OR (li_estadoMant >1) THEN
			tabpage_formulario.st_1.visible = false
		END IF
		tabpage_formulario.st_18.visible = false // TDA.EDM-2
		tabpage_formulario.st_2.visible = false
		
		IF li_ocen = 1 OR (gb_interfaseOsgm AND tabpage_formulario.d_inf_general.getItemNumber(1, "estado_mantenimiento")>1) THEN
			tabpage_ocen.uo_ot_ocen.mle_comentarios.backcolor = long(gs_gris)
			tabpage_ocen.uo_ot_ocen.dw_servicios.Modify("descripcion.background.color="+gs_gris)
			tabpage_ocen.uo_ot_ocen.dw_servicios.Modify("codigo.background.color="+gs_gris)
			tabpage_ocen.uo_ot_ocen.dw_servicios.enabled = FALSE
			tabpage_ocen.uo_ot_ocen.enabled = FALSE
			tabpage_ocen.uo_ot_ocen.cb_peticion.enabled = FALSE
			tabpage_ocen.uo_ot_ocen.cb_refresh.enabled = FALSE
			IF (gb_interfaseOsgm AND tabpage_formulario.d_inf_general.getItemNumber(1, "estado_mantenimiento")>1) THEN
				tabpage_seguimiento.d_seguimiento_operaciones.modify("f_alta.protect=1")
				tabpage_seguimiento.d_seguimiento_operaciones.modify("f_alta.background.color="+gs_gris)
				tabpage_seguimiento.d_seguimiento_operaciones.modify("observacion.protect=1")
				tabpage_seguimiento.d_seguimiento_operaciones.modify("observacion.background.color="+gs_gris)
				tabpage_seguimiento.d_seguimiento_operaciones.enabled = FALSE
				tabpage_formulario.d_inf_general.modify("desc.background.color="+gs_gris)
				tabpage_formulario.d_inf_general.modify("desc.protect=1")
				tabpage_formulario.d_inf_general.modify("fec_causa.protect=1")
				tabpage_formulario.d_inf_general.modify("fec_causa.background.color="+gs_gris)
				tabpage_observaciones.mle_observaciones.enabled = FALSE
			END IF
		END IF
		
	END IF

//	//AHM(26/10/2011) Integraci$$HEX1$$f300$$ENDHEX$$n OSGI - OSGM
//	IF (NOT(isNull(li_hayOT)) AND li_hayOt >0) THEN
//		tabpage_interrupciones.tv_1.enabled = FALSE
//		tabpage_seguimiento.d_seguimiento_operaciones.enabled = FALSE
//		tabpage_formulario.d_inf_general.enabled = FALSE		
//	END IF

// AHM (22/12/2011) Integraci$$HEX1$$f300$$ENDHEX$$n OSGI - OSGM
//No dejamos que env$$HEX1$$ed00$$ENDHEX$$e a OSGM si es una incidencia programada
IF (gb_interfaseOsgm AND ii_tipo_incid = 2) THEN
	tabpage_ocen.uo_ot_ocen.mle_comentarios.backcolor = long(gs_gris)
	tabpage_ocen.uo_ot_ocen.dw_servicios.Modify("descripcion.background.color="+gs_gris)
	tabpage_ocen.uo_ot_ocen.dw_servicios.Modify("codigo.background.color="+gs_gris)
	tabpage_ocen.uo_ot_ocen.dw_servicios.enabled = FALSE
	tabpage_ocen.uo_ot_ocen.enabled = FALSE
	tabpage_ocen.uo_ot_ocen.cb_peticion.enabled = FALSE
	tabpage_ocen.uo_ot_ocen.cb_refresh.enabled = FALSE
END IF
	
this.setredraw(true)

return 1

end function

public function integer fnu_inc_descargos ();///////////////////////////////////////////////////////
//										
// Funcion/Evento: fnu_inc_descargos
// 
// Objetivo: Pone a Gris y deshabilitados los campos del formulario.
//	
//
// Responsable: FDO 
//
// Par$$HEX1$$e100$$ENDHEX$$metros:
//    Entrada: --
//		Salida : --
//
// Devuelve:
//
// Fecha      Responsable   Actuaci$$HEX1$$f300$$ENDHEX$$n
// ------	   -----------   ---------
// 15/09/98    FDO
//
///////////////////////////////////////////////////////

tabpage_formulario.d_inf_general.modify("f_est_res.Protect=1")
// Modificado por Sgo. Unificaci$$HEX1$$f300$$ENDHEX$$n.
//tabpage_formulario.d_inf_general.modify("f_est_res.background.Color ="+string(65536*192+256*192+192))
//tabpage_formulario.d_inf_general.modify("desc.edit.displayonly=yes")
//tabpage_formulario.d_inf_general.modify("desc.background.Color ="+string(65536*192+256*192+192))	
//tabpage_formulario.d_inf_general.modify("causa.background.Color ="+string(65536*192+256*192+192))
//tabpage_formulario.d_inf_general.modify("fec_causa.Protect=1")
//tabpage_formulario.d_inf_general.modify("fec_causa.background.Color ="+string(65536*192+256*192+192))	
//
//tabpage_interrupciones.d_datos_interrup.modify("f_alta.Protect=1")
//tabpage_interrupciones.d_datos_interrup.modify("f_alta.background.Color ="+string(65536*192+256*192+192))
//tabpage_interrupciones.d_datos_interrup.modify("f_debe_rep.Protect=1")
//tabpage_interrupciones.d_datos_interrup.modify("f_debe_rep.background.Color ="+string(65536*192+256*192+192))	

tabpage_formulario.d_inf_general.modify("f_est_res.background.Color =" + gs_gris)
tabpage_formulario.d_inf_general.modify("desc.edit.displayonly=yes")
tabpage_formulario.d_inf_general.modify("desc.background.Color =" + gs_gris)
tabpage_formulario.d_inf_general.modify("causa.background.Color =" + gs_gris)
tabpage_formulario.d_inf_general.modify("fec_causa.Protect=1")
tabpage_formulario.d_inf_general.modify("fec_causa.background.Color =" + gs_gris)

tabpage_interrupciones.d_datos_interrup.modify("f_alta.Protect=1")
tabpage_interrupciones.d_datos_interrup.modify("f_alta.background.Color =" + gs_gris)
tabpage_interrupciones.d_datos_interrup.modify("f_debe_rep.Protect=1")
tabpage_interrupciones.d_datos_interrup.modify("f_debe_rep.background.Color =" + gs_gris)
// Fin. Sgo.
//LSH INI 08/09/2013 evolutivo DEO12-00000263
tabpage_formulario.d_inf_general.modify("f_elim_peligro.Protect=1")
tabpage_formulario.d_inf_general.modify("f_elim_peligro.background.Color =" + gs_gris)
//LSH FIN 08/09/2013 evolutivo DEO12-00000263
tabpage_interrupciones.d_lista_otras_inst.enabled=false
return 1
end function

public function integer fnu_validar_brigadas_prev ();// Esta funci$$HEX1$$f300$$ENDHEX$$n se encargar$$HEX2$$e1002000$$ENDHEX$$de validar las fechas previstas y comprobar que estan correctamente.

			
/////
int li_contador
datetime	 ldt_f_nula
datetime	ldt_f_desde
datetime	ldt_f_hasta
datetime	ldt_f_actual
long ll_nro_brigada

setnull(ldt_f_nula)

for li_contador = 1 to tabpage_ot.d_lista_brigadas_ot.rowcount()
	
	ldt_f_desde = tabpage_ot.d_lista_brigadas_ot.object.f_desde[li_contador]
	ldt_f_hasta = tabpage_ot.d_lista_brigadas_ot.object.f_hasta[li_contador]
	//ldt_f_actual = tabpage_ot.d_lista_brigadas_ot.object.f_actual[li_contador]
	ldt_f_actual = fgnu_fecha_actual()
	ll_nro_brigada = tabpage_ot.d_lista_brigadas_ot.object.nro_brigada[li_contador]

	if tabpage_ot.d_lista_brigadas_ot.object.est_brigada[li_contador]=0 then

		if isnull(ldt_f_desde)  then
			//messagebox("Atenci$$HEX1$$f300$$ENDHEX$$n","Alguna de las fechas previstas de la Brigada " + string(tabpage_ot.d_lista_brigadas_ot.object.brigada[li_contador]) + ", est$$HEX2$$e1002000$$ENDHEX$$con valores nulos")
			gnv_msg.f_mensaje("AI124",string(tabpage_ot.d_lista_brigadas_ot.object.brigada[li_contador]),"",Ok!)
			return -1
		else
			if (ldt_f_desde > ldt_f_actual) then
				//messagebox("Atenci$$HEX1$$f300$$ENDHEX$$n","La fecha prevista de inicio de la Brigada " + string(tabpage_ot.d_lista_brigadas_ot.object.brigada[li_contador]) + ", no puede ser menor que la fecha actual")
				gnv_msg.f_mensaje("AI125",string(tabpage_ot.d_lista_brigadas_ot.object.brigada[li_contador]),"",Ok!)

				return -1
			//NCA-INICIO.DDAG-2482.20150610.agregamos los segundos a las fechas.	
			elseif Datetime(string(ldt_f_desde)) < Datetime(string(tabpage_formulario.d_inf_general.GetitemDatetime(1, 'f_deteccion'), 'dd/mm/yyyy hh:mm:ss')) then
			//NCA-FIN.DDAG-2482.20150610.	
				gnv_msg.f_mensaje("AI127",string(tabpage_ot.d_lista_brigadas_ot.object.brigada[li_contador]),"",Ok!)
				return -1
			else
				tabpage_ot.d_lista_brigadas_ot.object.est_brigada[li_contador]=fgci_ot_trabajando
				
				if isnull(tabpage_ot.d_datos_ot.object.est_ot[1]) or tabpage_ot.d_datos_ot.object.est_ot[1] < 2 then

					tabpage_ot.d_datos_ot.object.est_ot[1]=fgci_ot_trabajando
						
				end if
				//fnu_fecha_menor_prev()
				//AHM (03/11/2011) Integraci$$HEX1$$f300$$ENDHEX$$n OSGI - OSGM
				tabpage_ot.d_datos_ot.object.ind_trabajo[1] = 1
				tabpage_ot.d_lista_brigadas_ot.SetColumn("f_desde")
				setnull(idt_fecha_eb)
			end if
		END IF
		
	elseif tabpage_ot.d_lista_brigadas_ot.object.est_brigada[li_contador] = fgci_ot_trabajando then
		if not isnull(ldt_f_hasta) then
			if (ldt_f_hasta > ldt_f_desde) then
				if (ldt_f_hasta <= fgnu_fecha_actual()) then
					tabpage_ot.d_lista_brigadas_ot.object.est_brigada[li_contador]= fgci_ot_resuelta
					IF tabpage_ot.d_lista_brigadas_ot.object.Tipo[li_contador]	= 'Brig.' THEN
						tabpage_ot.d_lista_brigadas_ot.object.Trabajo_resuelto[li_contador] = '1'
					END IF
					tabpage_ot.d_lista_brigadas_ot.object.ind_disponible[li_contador]= 1
				else
					//messagebox("Atenci$$HEX1$$f300$$ENDHEX$$n","La fecha de fin del Trabajo de la Brigada " + string(tabpage_ot.d_lista_brigadas_ot.object.brigada[li_contador]) + ", no puede ser mayor que la fecha actual")
					gnv_msg.f_mensaje("AI130",string(tabpage_ot.d_lista_brigadas_ot.object.brigada[li_contador]),"",Ok!)
					setnull(idt_fecha_eb)
					tabpage_ot.d_lista_brigadas_ot.object.f_hasta[li_contador]=ldt_f_nula
					return -1
				end if
			else
				//messagebox("Atenci$$HEX1$$f300$$ENDHEX$$n","La fecha de fin del Trabajo de la brigada " + string(tabpage_ot.d_lista_brigadas_ot.object.brigada[li_contador]) + " ,no debe ser menor que la fecha de inicio de la misma")
				gnv_msg.f_mensaje("AI131",string(tabpage_ot.d_lista_brigadas_ot.object.brigada[li_contador]),"",Ok!)
				setnull(idt_fecha_eb)
				tabpage_ot.d_lista_brigadas_ot.object.f_hasta[li_contador]=ldt_f_nula
				return -1
			end if
		end if
	end if
NEXT

fnu_fecha_menor_prev()

return 1
end function

public function integer fnu_fecha_menor_prev ();int li_contador
int li_cont_array
datetime ldt_array_fechas[]
datetime ldt_fecha
datetime ldt_fecha_nula

for li_contador=1 to tabpage_ot.d_lista_brigadas_ot.rowcount()
	ldt_fecha=tabpage_ot.d_lista_brigadas_ot.object.f_desde[li_contador]
	if not isnull(ldt_fecha) then
		li_cont_array ++ 
		ldt_array_fechas[li_cont_array]= ldt_fecha
	end if
next

if li_cont_array >1 then
	ldt_fecha=ldt_array_fechas[1]
	for li_contador=1 to li_cont_array - 1
		
		if ldt_fecha > ldt_array_fechas[li_contador + 1] then
			ldt_fecha=ldt_array_fechas[li_contador + 1]
		end if
	next

	tabpage_ot.d_datos_ot.object.f_desde[1]=ldt_fecha

	tabpage_seguimiento.d_seguimiento_operaciones.SetItem(ii_incidencia_enviado_brigada,"f_alta",ldt_fecha)
	tabpage_seguimiento.d_seguimiento_operaciones.SetItem(ii_incidencia_enviado_brigada,"h_alta",ldt_fecha)

elseif li_cont_array =1 then
	
	tabpage_ot.d_datos_ot.setitem(1,"f_desde",ldt_array_fechas[1])
	// GNU 27-10-2005. Incidencia 0/373898
	If gi_pais = 8 and isnull(tabpage_ot.d_datos_ot.getitemdatetime(1,'f_prepara_lm')) Then
		tabpage_ot.d_datos_ot.setitem(1,'f_prepara_lm', ldt_array_fechas[1])
	end if
	// FIN GNU
	tabpage_seguimiento.d_seguimiento_operaciones.SetItem(ii_incidencia_enviado_brigada,"f_alta",ldt_array_fechas[1])
	tabpage_seguimiento.d_seguimiento_operaciones.SetItem(ii_incidencia_enviado_brigada,"h_alta",ldt_array_fechas[1])
end if

if li_cont_array > 0 AND ii_estado_oper > fgci_incidencia_enviado_brigada & 
	and ldt_fecha > idt_fecha_er and ii_incidencia_enviado_brigada <> 0 &
	and iw_contenedora.fw_incidencia_de_operaciones() then
		

	tabpage_seguimiento.d_seguimiento_operaciones.deleterow(ii_incidencia_enviado_brigada)
	ib_anadir_eb = false
	ii_incidencia_enviado_brigada = 0
	IF ii_incidencia_en_reposicion <> 0 THEN ii_incidencia_en_reposicion --
	ii_incidencia_servicio_repuesto --
	ii_incidencia_resuelta --
	ii_incidencia_cerrada --
	ii_avisar_oop_eb = 0
end if	

return 1
end function

public function integer fnu_habilito_f_hasta ();///////////////////////////////////////////////////////
//										
// Funcion/Evento: fnu_habilito_f_hasta()
// 
// Objetivo: Calcula si existen brigadas en la incidencia, que esten trabajando 
// cuando esta se encuentre en un estado igual o superior a Enviado Brigada.
//
// Responsable: FDO 
//
// Par$$HEX1$$e100$$ENDHEX$$metros:
//    Entrada: --
//		Salida : --
//
// Devuelve:
//
// Fecha      Responsable   Actuaci$$HEX1$$f300$$ENDHEX$$n
// ------	   -----------   ---------
// 15/09/98    FDO
//
///////////////////////////////////////////////////////


// PACHO SOFT

int li_contador
boolean lb_hay_f_desde=false
if ii_estado_oper >= fgci_incidencia_enviado_brigada and ii_estado_oper < fgci_incidencia_servicio_repuesto then
	for li_contador=1 to tabpage_ot.d_lista_brigadas_ot.rowcount()
// DSA 29/03/2000	
//		if not isnull(tabpage_ot.d_lista_brigadas_ot.object.f_desde[li_contador]) and & 
//				 isnull(tabpage_ot.d_lista_brigadas_ot.object.f_hasta[li_contador]) then
		if not fgnu_es_nula (tabpage_ot.d_lista_brigadas_ot.object.f_desde[li_contador]) and & 
				 fgnu_es_nula (tabpage_ot.d_lista_brigadas_ot.object.f_hasta[li_contador]) then
			lb_hay_f_desde=true
		end if		 
	next
	if not lb_hay_f_desde then
		tabpage_formulario.d_inf_general.enabled=false
//		iw_contenedora.tab_1.tabpage_formulario.d_inf_general.modify("material_averiado.background.color="+gs_gris)
		iw_contenedora.tab_1.tabpage_formulario.d_inf_general.modify("f_deteccion.background.color="+gs_gris)
		iw_contenedora.tab_1.tabpage_formulario.d_inf_general.modify("f_est_res.background.color="+gs_gris)
		iw_contenedora.tab_1.tabpage_formulario.d_inf_general.modify("f_elim_peligro.background.color="+gs_gris)
		iw_contenedora.tab_1.tabpage_formulario.d_inf_general.modify("causa.background.color="+gs_gris)
		iw_contenedora.tab_1.tabpage_formulario.d_inf_general.modify("fec_causa.background.color="+gs_gris)
		iw_contenedora.tab_1.tabpage_formulario.d_inf_general.modify("desc.background.color="+gs_gris)
		tabpage_formulario.enabled=true
		tabpage_observaciones.enabled=true
		tabpage_ot.enabled=true
		
		tabpage_seguimiento.enabled=true
		tabpage_acciones.enabled=true
		return 2
	end if
end if

return 1
end function

public function integer fnu_comprueba_fin_ot (datetime pdt_fecha);///////////////////////////////////////////////////////
//										
// Funcion/Evento: fnu_comprueba_fin_ot
// 
// Objetivo: Comprueba que a la ot se le puedan finalizar todas las 
//           brigadas y en caso afirmativo setea fechas y estados en la
//           datawindow de finalizaci$$HEX1$$f300$$ENDHEX$$n.
//	
//

// Responsable: FDO 
//
// Par$$HEX1$$e100$$ENDHEX$$metros:
//    Entrada: pdt_fecha
//		Salida : --
//
// Devuelve:
//
// Fecha      Responsable   Actuaci$$HEX1$$f300$$ENDHEX$$n
// ------	   -----------   ---------
// 15/09/98    FDO
//
///////////////////////////////////////////////////////

int li_contador

for  li_contador=1 to tabpage_ot.d_lista_brigadas_ot.rowcount()
	
	if tabpage_ot.d_lista_brigadas_ot.object.est_brigada[li_contador] = fgci_ot_trabajando then
		tabpage_ot.d_lista_brigadas_ot.object.f_hasta[li_contador] = pdt_fecha
		tabpage_ot.d_lista_brigadas_ot.object.est_brigada[li_contador]	= fgci_ot_resuelta
		IF tabpage_ot.d_lista_brigadas_ot.object.Tipo[li_contador]	= 'Brig.' THEN
			tabpage_ot.d_lista_brigadas_ot.object.Trabajo_resuelto[li_contador] = '1'
		END IF
		tabpage_ot.d_lista_brigadas_ot.object.ind_disponible[li_contador]	= 1
	end if

next

//FDO 13/03/2009
IF isNull(tabpage_ot.d_datos_ot.object.f_hasta[1]) THEN
	tabpage_ot.d_datos_ot.object.f_hasta[1] = pdt_fecha
END IF

tabpage_ot.d_datos_ot.object.est_ot[1] = 3


//AHM (04/11/2011) Integraci$$HEX1$$f300$$ENDHEX$$n OSGI - OSGM 
tabpage_ot.d_datos_ot.object.ind_trabajo[1] = 1

//ib_primera_vez_ot=false
tabpage_ot.d_lista_brigadas_ot.accepttext()
tabpage_ot.d_datos_ot.accepttext()


return 1
		
end function

public subroutine fnu_deshabilito_al_resolver ();// Calcula si existen brigadas en la incidencia, que esten trabajando 
// cuando esta se encuentre en un estado igual o superior a Enviado Brigada.

//tabpage_formulario.d_inf_general.enabled=false
tabpage_formulario.d_inf_general.modify("desc.edit.displayonly=yes")
tabpage_formulario.d_inf_general.modify("f_deteccion.background.color="+gs_gris)
tabpage_formulario.d_inf_general.modify("f_est_res.background.color="+gs_gris)
tabpage_formulario.d_inf_general.modify("f_elim_peligro.background.color="+gs_gris)
tabpage_formulario.d_inf_general.modify("causa.background.color="+gs_gris)
tabpage_formulario.d_inf_general.modify("fec_causa.background.color="+gs_gris)
tabpage_formulario.d_inf_general.object.fec_causa.protect = 1
tabpage_formulario.d_inf_general.modify("desc.edit.displayonly=yes")
tabpage_formulario.d_inf_general.modify("desc.background.color="+gs_gris)
tabpage_formulario.enabled=true
tabpage_observaciones.enabled=true
tabpage_ot.enabled=true

tabpage_cuadrillas.enabled=true
//tabpage_interrupciones.d_datos_interrup.enabled=false
if ii_alcance=fgci_incidencia_con_interrupcion then
	tabpage_interrupciones.enabled=true
else
	tabpage_interrupciones.enabled=false
end if

If tabpage_ot.d_lista_brigadas_ot.RowCount() > 0 then
	tabpage_cuadrillas.enabled=true
	tabpage_acciones.enabled=true	
else
	tabpage_cuadrillas.enabled=false
	tabpage_acciones.enabled=false
end if


//***************************************
//**  OSGI 2001.1  	28/05/2001			**
//**  Jair Padilla / Soluziona PANAMA  **
//***************************************
//////////of_validaciones_sbt(0, tabpage_interrupciones.d_datos_interrup)
//***************************************
//**  OSGI 2001.1  	28/05/2001			**
//**  Jair Padilla / Soluziona PANAMA  **
//***************************************
end subroutine

public function integer fnu_comprueba_valores_nulos_interrup (ref datawindow pd_dw);///////////////////////////////////////////////////////
//										
// Funcion/Evento: Fnu_comprueba_valores_nulos
// 
// Objetivo: Comprobar que los datos requeridos de las in
//           terrupciones no tiene valores nulos.
//	
//
// Responsable: FDO 
//
// Par$$HEX1$$e100$$ENDHEX$$metros:
//    Entrada: Pd_dw
//		Salida : --
//
// Devuelve:
//
// Fecha      Responsable   Actuaci$$HEX1$$f300$$ENDHEX$$n
// ------	   -----------   ---------
// 15/09/98    FDO
//
///////////////////////////////////////////////////////


int li_contador
pd_dw.accepttext()

for li_contador=1 to pd_dw.rowcount()
	
	if isnull(pd_dw.object.pot_instalada[li_contador]) then
		pd_dw.object.pot_instalada[li_contador]=0
	end if
	
	if isnull(pd_dw.object.pot_contratada[li_contador]) then
		pd_dw.object.pot_contratada[li_contador]=0
	end if
	
	if isnull(pd_dw.object.kwh[li_contador]) then
		pd_dw.object.kwh[li_contador]=0
	end if
	
	if isnull(pd_dw.object.cant_cli[li_contador]) then
		pd_dw.object.cant_cli[li_contador]=0
	end if

next

pd_dw.accepttext()

return 1
end function

public function integer frn_validar_quitar_brigada (ref datawindow pd_dw, long pl_nro_brigada);////////////////////////////////////////////////////////////////////////////////////////////////
//
// Funci$$HEX1$$f300$$ENDHEX$$n: frn_validar_quitar_brigada
// 
// Objetivo: Indica si se puede quitar la brigada segun tenga fecha de fin
//	Ambito:	P$$HEX1$$fa00$$ENDHEX$$blico
//

// Par$$HEX1$$e100$$ENDHEX$$metros: 
//			Entrada: datawindow
//						nro de brigada
//			Salida:   --
//						
// Devuelve:	
//
//  Fecha	  Responsable	Actuaci$$HEX1$$f300$$ENDHEX$$n
// ---------	-------		----------------------------------------
//	29/2/96		SAB			Versi$$HEX1$$f300$$ENDHEX$$n Original
//
////////////////////////////////////////////////////////////////////////////////////////////////
long ll_row

pd_dw.AcceptText()

ll_row = pd_dw.Find("nro_brigada = "+string(pl_nro_brigada)+"AND ISNULL(f_hasta)",0,pd_dw.RowCount()) 
IF ll_row <> 0 THEN
	Return 1
END IF

Return 0

end function

public function integer frn_validar_drag_brigada (ref datawindow pd_dw, long pl_nro_brigada);////////////////////////////////////////////////////////////////////////////////////////////////
//
// Funci$$HEX1$$f300$$ENDHEX$$n: frn_valida_drag_brigada
// 
// Objetivo: Indica si esta autorizado a realizar el dragueo de las 
//				 brigadas segun tenga fecha de fin de tareas
//	Ambito:	p$$HEX1$$fa00$$ENDHEX$$blico
//
// Par$$HEX1$$e100$$ENDHEX$$metros: 
//			Entrada: datawindow
//						nro_brigada
//			Salida:   --
//						
// Devuelve:	
//

//  Fecha	  Responsable	Actuaci$$HEX1$$f300$$ENDHEX$$n
// ---------	-------		----------------------------------------
//	29/2/96		SAB			Versi$$HEX1$$f300$$ENDHEX$$n Original

//
////////////////////////////////////////////////////////////////////////////////////////////////

long ll_row

pd_dw.AcceptText()

ll_row = pd_dw.Find("nro_brigada = "+string(pl_nro_brigada)+" AND ISNULL(f_hasta)",0,pd_dw.RowCount()) 

IF ll_row <> 0 THEN
	Return 0
END IF

Return 1


end function

public function string f_devolver_observaciones_mnto (ref datawindow pd_dw);//////////////////////////////////////////////////////////
//
// Funci$$HEX1$$f300$$ENDHEX$$n: fnu_devolver_observacion
//
// Objetivo:
//         Retorna campo Observaci$$HEX1$$f300$$ENDHEX$$n
//
// Ambito:  P$$HEX1$$fa00$$ENDHEX$$blico
//
// Par$$HEX1$$e100$$ENDHEX$$metros:
//        Entrada: pd_dw
//        Salida:
//
// Devuelve: 
//
// Fecha                Responsable             Actuaci$$HEX1$$f300$$ENDHEX$$n
// -----                -----------             ---------
//
/////////////////////////////////////////////////////////// 

Return pd_dw.GetItemstring(1,"observ_mnto")
end function

public function integer of_pasar_explotacion (long ll_nro_incidencia);////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//
// Funci$$HEX1$$f300$$ENDHEX$$n/Evento: of_pasar_explotaci$$HEX1$$f300$$ENDHEX$$n
//
// Objetivo: Actualizar el estado de los descargos en la tabla sgd_descargos y 
//			   el estado de los trabajos en la tabla sgd_trabajos_bdi
//         
// Ambito:  P$$HEX1$$fa00$$ENDHEX$$blico
//
// Par$$HEX1$$e100$$ENDHEX$$metros:
//
//        Entrada:  ll_nro_incidencia
//        Salida: 
//
// Devuelve: 
//
// Fecha            Responsable             Actuaci$$HEX1$$f300$$ENDHEX$$n
// --------         -----------             ---------
// 07/11/2000	ACO,FDO       Revisi$$HEX1$$f300$$ENDHEX$$n de c$$HEX1$$f300$$ENDHEX$$digo.
//		
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////// 

Long ll_nro_trabajo, ll_nro_descargo, ll_nro_instalacion,li_estado
int li_tipo_sgt 
String ls_usuario
boolean lb_grafico = false
DateTime ldt_inicio, ldt_fin

li_tipo_sgt=0

SELECT sgd_descargos.nro_descargo, 
		 nvl(sgd_descargos.ind_act_grafica,0),
		 sgd_descargos.usuario,
		 sgd_estados_descargo.f_inicio,
		 sgd_estados_descargo.f_fin,
		 sgd_descargos.cod_inst_origen,
		 sgd_descargos.estado
INTO :ll_nro_descargo, 
	  :ii_ind_act_grafica, 
	  :ls_usuario,
	  :ldt_inicio,
	  :ldt_fin,
	  :ll_nro_instalacion,
	  :li_estado
FROM sgd_descargos, sgd_estados_descargo
WHERE sgd_descargos.nro_incidencia= :ll_nro_incidencia and

		sgd_descargos.nro_descargo = sgd_estados_descargo.nro_descargo and
		sgd_estados_descargo.estado = :fgci_descargo_activado;
			
IF sqlca.sqlcode=0 THEN
	IF ii_ind_act_grafica = 1 and li_estado = fgci_descargo_activado THEN
		UPDATE "SGD_DESCARGOS"  
		SET "ESTADO" = : fgci_descargo_pendiente_pta_servicio
		WHERE "SGD_DESCARGOS"."NRO_DESCARGO" = :ll_nro_descargo;
	
		IF fg_insertar_estado_descargo(ll_nro_descargo, fgci_descargo_pendiente_pta_servicio, &
												ldt_inicio, ldt_fin, fgnu_fecha_actual(), "", ll_nro_instalacion) THEN
	
			// pte pta exp
			UPDATE "SGD_TRABAJOS_BDI"  
			SET "ESTADO_TRABAJO" = :fgci_trabajo_pendiente_pta_servicio
			WHERE "SGD_TRABAJOS_BDI"."NRO_DESCARGO" = :ll_nro_descargo   ;
		
			// pte pta exp
			
			RETURN 1
		ELSE
			messagebox("Atenci$$HEX1$$f300$$ENDHEX$$n", "Se ha producido un error a la hora de actualizar los estados del Descargo asociado a la Incidencia.")
			return -1
		END IF
	else
	IF ii_estado_oper = fgci_incidencia_resuelta THEN
		UPDATE "SGD_DESCARGOS"  
		SET "ESTADO" = :fgci_descargo_finalizado 
		WHERE "SGD_DESCARGOS"."NRO_DESCARGO" = :ll_nro_descargo;
		
		IF SQLCA.SQLCode = 0 THEN
			IF fg_insertar_estado_descargo(ll_nro_descargo, fgci_descargo_finalizado , &
													ldt_inicio, ldt_fin, fgnu_fecha_actual(),"", ll_nro_instalacion) THEN
	
				return 1
			ELSE
				messagebox("Atenci$$HEX1$$f300$$ENDHEX$$n", "Se ha producido un error a la hora de actualizar los estados del Descargo asociado a la Incidencia.")
				return -1
			END IF

		ELSE
			messagebox("Atenci$$HEX1$$f300$$ENDHEX$$n", "Se ha producido un error a la hora de finalizar el Descargo asociado a la Incidencia." + SQLCA.SQLErrText)
			return -1
		END IF				
	ELSE
		Return 1
	END IF
end if

else
	
	gnv_msg.f_mensaje("AI122","","",ok!)
	return -1

end IF
end function

public function integer of_deriv_mante (long nro_incidencia, datetime ld_fecha_resolucion, boolean ib_enviada_mante);////Envia a SGD_INCID_MTO la incidencia
//
//// Recibe el numero de incidencia, duracion
//// Tipo Incidencia (PR/IM)
//// Incidencia Suministro, Instalacion
//
//long ll_nro_incidencia, ll_nro_inst_afectada, ll_cod_causa, ll_est_actual, ll_tip_tension, ll_nro_inst_origen
//long ll_year, ll_cod_tipo4, ll_nro_mesa, ll_tipo_base, ll_nuevo_cod, ll_ot, ll_tip_incidencia, ll_cod_padre
//string ls_usuario, ls_programa, ls_desc_incid, ls_observacion, ls_observ_mto, ls_mat_averiado, ls_cod_base
//string ls_nom_instalacion, ls_nom_padre
//datetime ld_fecha, ld_fecha_deteccion
//double ldec_tiepi, ldec_tiebt
//int li_filas = 0
//
//ll_year = year(today())
//
//SELECT COUNT(*)
// INTO :li_filas
// FROM "SGD_INCID_MTO"
// WHERE "SGD_INCID_MTO"."NRO_INCIDENCIA" = :nro_incidencia ;
//
//if li_filas > 0 then
//	return 0
//end if
//  
//SELECT "SGD_INCIDENCIA"."NRO_INCIDENCIA",   
//		"SGD_INCIDENCIA"."USUARIO",   
//		"SGD_INCIDENCIA"."F_ACTUAL",   
//		"SGD_INCIDENCIA"."PROGRAMA",   
//		"SGD_INCIDENCIA"."NRO_INST_AFECTADA",   
//		"SGD_INCIDENCIA"."DESC_INCIDENCIA",   
//		"SGD_INCIDENCIA"."F_DETECCION",   
//		NVL("SGD_INCIDENCIA"."COD_CAUSA",0),   
//		"SGD_INCIDENCIA"."EST_ACTUAL",   
//		"SGD_INCIDENCIA"."TIP_TENSION",   
//		"SGD_INCIDENCIA"."INSTALACION_ORIGEN",   
//		NVL("SGD_INCIDENCIA"."MAT_AVERIADO", ' '),  
//		"SGD_INCIDENCIA"."OT",   
//		"SGD_INCIDENCIA"."OBSERVACION",   
//		"SGD_INCIDENCIA"."OBSERV_MTO",   
//		"SGD_INCIDENCIA"."TIEPI",   
//		"SGD_INCIDENCIA"."TIEBT",
//		"SGD_INCIDENCIA"."TIP_INCIDENCIA",
//		"SGD_INCIDENCIA"."NRO_MESA"
// INTO :ll_nro_incidencia,   
//		:ls_usuario,   
//		:ld_fecha,   
//		:ls_programa,   
//		:ll_nro_inst_afectada,   
//		:ls_desc_incid,   
//		:ld_fecha_deteccion,   
//		:ll_cod_causa,   
//		:ll_est_actual,   
//		:ll_tip_tension,   
//		:ll_nro_inst_origen,   
//		:ls_mat_averiado,   
//		:ll_ot,   
//		:ls_observacion,   
//		:ls_observ_mto,   
//		:ldec_tiepi,   
//		:ldec_tiebt,
//		:ll_tip_incidencia,
//		:ll_nro_mesa
// FROM "SGD_INCIDENCIA"  
// WHERE "SGD_INCIDENCIA"."NRO_INCIDENCIA" = :nro_incidencia  ;
//	 
// if sqlca.sqlcode = 0 then
//	if (ll_tip_incidencia = fgci_incidencia_imprevista &
//		 OR ll_tip_incidencia = fgci_incidencia_calidad) &
//		and (fg_duracion_minutos(ld_fecha_deteccion,ld_fecha_resolucion) > 3 or ib_enviada_mante= true )then
//
//		  INSERT INTO "SGD_INCID_MTO"  
//					( "USUARIO",   
//					  "FECHA",   
//					  "PROGRAMA",   
//					  "NRO_INCIDENCIA",   
//					  "NRO_INST_AFECTADA",   
//					  "DESC_INCIDENCIA",   
//					  "F_DETECCION",   
//					  "COD_CAUSA",   
//					  "EST_ACTUAL",   
//					  "TIP_TENSION",   
//					  "NRO_INST_ORIGEN",   
//					  "MAT_AVERIADO",   
//					  "OT",   
//					  "OBS_OPERACION",   
//					  "OBS_MANT",   
//					  "TIEPI",   
//					  "TIEBT",   
//					  "GENERADA_SOLICITUD",
//					  "TIP_INCIDENCIA")  
//		  VALUES ( :gs_usuario,   
//					  sysdate,   
//					  'INCIDEN',   
//					  :ll_nro_incidencia,   
//					  :ll_nro_inst_afectada,   
//					  :ls_desc_incid,   
//					  :ld_fecha_deteccion,   
//					  :ll_cod_causa,   
//					  :ll_est_actual,   
//					  :ll_tip_tension,   
//					  :ll_nro_inst_origen,   
//					  :ls_mat_averiado,   
//					  :ll_ot,   
//					  :ls_observacion,   
//					  :ls_observ_mto,   
//					  :ldec_tiepi,   
//					  :ldec_tiebt,   
//					  0,
//					  :ll_tip_incidencia)  ;
//					  
//		IF SQLCA.SQLCode <> 0 THEN
//			return -1
//		END IF
//			
//				   if ll_tip_incidencia = fgci_incidencia_imprevista then
//						  ll_cod_tipo4 = 1101
////					elseif ll_tip_incidencia = fgci_incidencia_programada then
////						  ll_cod_tipo4 = 1100
//					end if
//					
//  SELECT "GM_BASES"."COD_BASE"  
//    INTO :ls_cod_base
//    FROM "GM_BASES"  
//   WHERE "GM_BASES"."COD_NIVEL3_BDI" = :ll_nro_mesa 
//			AND "GM_BASES"."TIPO_RED" = 'D';
//
//  SELECT "GM_BASES"."TIPO_BASE"  
//    INTO :ll_tipo_base
//    FROM "GM_BASES"  
//   WHERE "GM_BASES"."COD_BASE" = :ls_cod_base  
//			AND "GM_BASES"."TIPO_RED" = 'D';
//	
// SELECT MAX("GM_SOLICITUDES"."COD_SOLICITUD")
//	INTO :ll_nuevo_cod
//	FROM "GM_SOLICITUDES"
//  WHERE "GM_SOLICITUDES"."PLAN" = :ll_year 
//  		AND "GM_SOLICITUDES"."COD_BASE" = :ls_cod_base 
//		and "GM_SOLICITUDES"."TIPO_RED" = 'D' ;
//
//if ll_nuevo_cod < 1 OR isnull(ll_nuevo_cod) then
//	ll_nuevo_cod = 1
//else
//	ll_nuevo_cod ++
//end if
//					
//					  
//  INSERT INTO "GM_SOLICITUDES"  
//         ( "TIPO_RED",   
//           "PLAN",   
//           "COD_BASE",   
//           "COD_SOLICITUD",   
//           "PROGRAMA",   
//           "USUARIO",   
//           "FECHA",   
//           "COD_TIPO1",   
//           "COD_TIPO2",   
//           "COD_TIPO3",   
//           "COD_TIPO4",   
//           "CONTRATA",   
//           "FECHA_ALTA_SOLICITUD",   
//           "FECHA_INICIO",   
//           "FECHA_FIN",   
//           "COD_SERV_SOLICITANTE",   
//           "DESCRIPCION",   
//           "HORAS_HOMBRE",   
//           "GASTO_INVERSION",   
//           "COD_PRIORIDAD",   
//           "COD_DESCARGO",   
//           "COD_USUARIO",   
//           "IMPORTE",   
//           "COD_ESTADO",   
//           "PROCEDENCIA",   
//           "FECHA_APROBACION",   
//           "COD_INCIDENCIA",   
//           "COMENTARIO" )  
//  VALUES ( 'D',   
//           :ll_year,   
//           :ls_cod_base,   
//           :ll_nuevo_cod,   
//           'OPENSGI',   
//           :gs_usuario,   
//           SYSDATE,   
//           :ll_tipo_base,   
//           7,   
//           52,   
//           :ll_cod_tipo4,   
//           0,   
//           SYSDATE,   
//           SYSDATE,   
//           SYSDATE,   
//           4,   
//           :ls_desc_incid,   
//           0,   
//           'G',   
//           2,   
//           2,   
//           'GMD91E',   
//           0,   
//           0,   
//           'NO_PLAN',   
//           null,   
//           :nro_incidencia,   
//           null )  ;
//			  
//	IF SQLCA.SQLCode <> 0 THEN
//		return -1
//	END IF
//
//			  
//  SELECT "SGD_INSTALACION"."NOM_INSTALACION",   
//         "SGD_INSTALACION"."NRO_INST_PADRE"  
//    INTO :ls_nom_instalacion,   
//         :ll_cod_padre  
//    FROM "SGD_INSTALACION"  
//	 WHERE "SGD_INSTALACION"."NRO_INSTALACION" = :ll_nro_inst_afectada 
//	 and "SGD_INSTALACION"."BDI_JOB" = 0 //DBE 11/01/2000
//	 ;
//
//  SELECT "SGD_INSTALACION"."NOM_INSTALACION"
//    INTO :ls_nom_padre   
//    FROM "SGD_INSTALACION"  
//	 WHERE "SGD_INSTALACION"."NRO_INSTALACION" = :ll_cod_padre 
//	 and "SGD_INSTALACION"."BDI_JOB" = 0 //DBE 11/01/2000
//	 ;
//			  
//INSERT INTO "GM_R_SOLICITUDES_EQUIPOS"  
//         ( "TIPO_RED",   
//           "PLAN",   
//           "COD_BASE",   
//           "COD_SOLICITUD",   
//           "COD_EQUIPO",   
//           "PROGRAMA",   
//           "USUARIO",   
//           "FECHA",   
//           "COD_EQUIPO_PADRE",   

//           "DESC_EQUIPO",   
//           "DESC_EQUIPO_PADRE" )  
//  VALUES ( 'D',   
//           :ll_year,   
//           :ls_cod_base,   
//           :ll_nuevo_cod,   
//           :ll_nro_inst_afectada,   
//           'OPENSGI',   
//           :gs_usuario,   
//           SYSDATE,   
//           :ll_cod_padre,   
//           :ls_nom_instalacion,   
//           :ls_nom_padre )  ;
//	
//		return sqlca.sqlcode
//	end if	
//	return 0
//else
//	
//	return -1
//	
//end if
//
return 0
end function

public subroutine wf_actualizar_contrata (ref datawindow pd_dw, long row, ref su_drag_brigada_ot s_estructura);//  Fecha         Responsable   Actuaci$$HEX1$$f300$$ENDHEX$$n
// ---------    -------         ----------------------------------------
// 23/02/2000     DSA				Introducir las contratas
//
////////////////////////////////////////////////////////////////////////////////////////////////
String ls_filtro

pd_dw.SetRedraw(False)
pd_dw.Retrieve(gi_nro_centro,gi_nro_cmd,gi_nro_puesto)
int li_contador

ls_filtro ='nro_brigada not in (-1'
	
for li_contador= 1 to tabpage_ot.d_lista_brigadas_ot.RowCount()		
	if tabpage_ot.d_lista_brigadas_ot.object.est_brigada[li_contador] < fgci_ot_resuelta	then
		ls_filtro = ls_filtro + ',' + &
				string(tabpage_ot.d_lista_brigadas_ot.getitemnumber(li_contador,'nro_brigada'))
	end if
next	
	
ls_filtro = ls_filtro +")"

pd_dw.SetFilter(ls_filtro)
pd_dw.Filter()

pd_dw.SetRedraw(True)
end subroutine

public subroutine fnu_cambiar_ot_tipo (string mode);////////////////////////////////////////////////////////////////////////////////////////////////
// Funci$$HEX1$$f300$$ENDHEX$$n: wf_cambiar_ot_tipo
//
// Objetivo: Cambiar el tabpage OT para utilizar las contratas or las brigadas
//
//  Fecha         Responsable   Actuaci$$HEX1$$f300$$ENDHEX$$n
// ---------    -------         ----------------------------------------
// 23/02/2000     DSA				Introducir las contratas
//
////////////////////////////////////////////////////////////////////////////////////////////////

if mode = 'CO' then
	// DSA INI 29/03/2000	
	tabpage_ot.d_datos_ot.object.tip_brigada[1] = 2
	iw_contenedora.dw_brigadas_calendario_rango.DataObject = 'd_contratas_calendario_rango_fechas'
	iw_contenedora.dw_brigadas_calendario_rango.SetTransObject(SQLCA)
	tipo_ot = 'CO'
	tabpage_ot.d_crit_seleccion.object.pi_tipo_brigada_t.Text = 'Tipo de Contrata:'
	tabpage_ot.d_crit_seleccion.object.pi_brigadas_en_turno.CheckBox.Text = 'Contratas en turno'
	tabpage_ot.tab_lista_brigadas.Hide()
//	tabpage_ot.dw_lista_contratas.Show()
	tabpage_ot.rb_2.Checked = TRUE
else
	// DSA INI 29/03/2000	
	tabpage_ot.d_datos_ot.object.tip_brigada[1] = 1
	tipo_ot = 'BR'
	tabpage_ot.tab_lista_brigadas.Show()
	tabpage_ot.dw_lista_contratas.Hide()
	iw_contenedora.dw_brigadas_calendario_rango.DataObject = 'd_brigadas_calendario_rango_fechas'
	iw_contenedora.dw_brigadas_calendario_rango.SetTransObject(SQLCA)
	tabpage_ot.d_crit_seleccion.object.pi_tipo_brigada_t.Text = 'Tipo de Brigada:'
	tabpage_ot.d_crit_seleccion.object.pi_brigadas_en_turno.CheckBox.Text = 'Brigadas en turno'
	tabpage_ot.rb_1.Checked = TRUE	
end if
end subroutine

public function integer fnu_finalizar_ot (datetime pdt_fecha);//////////////////////////////////////////////////////////////////////////////////////////////////////////////
//										
// Funcion/Evento: fnu_comprueba_fin_ot
// 
// Objetivo: Comprueba que a la ot se le puedan finalizar todas las 
//           brigadas y en caso afirmativo setea fechas y estados en la

//           datawindow de finalizaci$$HEX1$$f300$$ENDHEX$$n.
//	
// Responsable: FDO 
//
// Par$$HEX1$$e100$$ENDHEX$$metros:
//       Entrada: pdt_fecha
//		Salida :   --
//
// Devuelve:
//
// Fecha           Responsable   Actuaci$$HEX1$$f300$$ENDHEX$$n
// ------	          -----------          ---------
// 24/04/2000    FDO
//
//////////////////////////////////////////////////////////////////////////////////////////////////////////////

int li_contador


// Se comprueba que la incidencia tenga una cauasa asociada si no es de SCADA
//IF ib_ind_scada = false AND &
//	ii_alcance <> fgci_incidencia_con_interrupcion THEN
//	IF ISNULL(tabpage_formulario.d_inf_general.object.st_causa.text) OR &
//		tabpage_formulario.d_inf_general.object.st_causa.text="" THEN
//		
//		Messagebox("Atenci$$HEX1$$f300$$ENDHEX$$n","Debe seleccionar una causa antes de finalizar la OT")
//		//tabpage_ot.cbx_fin_ot.checked=false (comentado por LFE)
//		return -1
//	END IF
//END IF

// Bucle para ir finalizando una por una las brigadas.
for  li_contador=1 to tabpage_ot.d_lista_brigadas_ot.rowcount()
	
	if tabpage_ot.d_lista_brigadas_ot.object.est_brigada[li_contador] = fgci_ot_trabajando or & 
		isnull(tabpage_ot.d_lista_brigadas_ot.object.f_hasta[li_contador]) then
		tabpage_ot.d_lista_brigadas_ot.object.f_hasta[li_contador] = pdt_fecha
		tabpage_ot.d_lista_brigadas_ot.object.est_brigada[li_contador]	= fgci_ot_resuelta
		tabpage_ot.d_lista_brigadas_ot.object.ind_disponible[li_contador]	= 1
		tabpage_ot.d_lista_brigadas_ot.object.trabajo_resuelto[li_contador]	= '1'
	end if

next

if ii_estado_oper= fgci_incidencia_enviado_brigada then 
	ii_estado_oper=fgci_incidencia_servicio_repuesto
	// no hay estado ER, luego la posici$$HEX1$$f300$$ENDHEX$$n del estado SR en d_seguimiento_operaciones es fgci_incidencia_servicio_repuesto-1
	tabpage_seguimiento.d_seguimiento_operaciones.object.f_alta[ii_incidencia_servicio_repuesto] = pdt_fecha
	tabpage_formulario.d_inf_general.object.estado_actual[1]=fgci_incidencia_servicio_repuesto
end if

tabpage_ot.d_datos_ot.object.f_hasta[1] = pdt_fecha
tabpage_ot.d_datos_ot.object.est_ot[1] = fgci_ot_resuelta
ib_primera_vez_ot=false

tabpage_ot.d_crit_seleccion.enabled=false
tabpage_ot.d_crit_seleccion.object.pi_tipo_brig.background.color=gs_gris

tabpage_ot.d_crit_seleccion.object.pdt_fecha_turno.background.color=gs_gris
tabpage_ot.d_crit_seleccion.object.pi_brigadas_en_turno.background.color=gs_gris
tabpage_ot.tab_lista_brigadas.tabpage_disponibles.dw_brigadas_disponibles.enabled=false
tabpage_ot.tab_lista_brigadas.tabpage_no_disponibles.dw_brigadas_no_disponibles.enabled=false
tabpage_ot.rb_1.enabled = false
tabpage_ot.rb_2.enabled = false

tabpage_ot.dw_ambito.fnu_des_centro()
tabpage_ot.dw_ambito.fnu_des_cmd()
tabpage_ot.dw_ambito.fnu_des_puesto()
tabpage_ot.d_lista_brigadas_ot.accepttext()
tabpage_ot.d_datos_ot.accepttext()
	
f_deshab_tabs(false)

return 1
		
end function

public function boolean fw_equipo_disponible (integer pl_nro_equipo, string ps_tipo_equipo);// Devuelve: True  - en caso de que la brigada est$$HEX2$$e9002000$$ENDHEX$$diponible para esa hora
//				 False - en caso de qu eno trabaje a esa hora      
//
//  Fecha      Responsable   Actuaci$$HEX1$$f300$$ENDHEX$$n
// ---------   -----------  ----------------------------------------
// 10/04/2000     LFE         Versi$$HEX1$$f300$$ENDHEX$$n Original
//
////////////////////////////////////////////////////////////////////////////////////////////////

Long  ll_fila_calen, ll_fila_horarios 
Datetime ldt_hora_desde, ldt_hora_hasta
string ls_tipo_equipo
		
// Verifico el horario de la brigada
IF iw_contenedora.dw_brigadas_calendario_rango.RowCount() = 0 THEN
	Return False
END IF
IF ps_tipo_equipo = 'CO' THEN
	ls_tipo_equipo = "nro_contrata="
ELSE
	ls_tipo_equipo = "nro_brigada="
END IF

ll_fila_calen = iw_contenedora.dw_brigadas_calendario_rango.Find("nro_contrata=" + String(pl_nro_equipo), 1, iw_contenedora.dw_brigadas_calendario_rango.RowCount())
RETURN ll_fila_calen > 0
end function

public subroutine of_iniciar_estados_oper ();///////////////////////////////////////////////////////
//										
// Funcion/Evento: of_iniciar_estados_oper
// 
// Objetivo: Debido a que las incidencias van a tener estados distintos seg$$HEX1$$fa00$$ENDHEX$$n su tipo,
// 			 los cambios en la dw d_seguimiento_operaciones se har$$HEX1$$e100$$ENDHEX$$n seg$$HEX1$$fa00$$ENDHEX$$n la fila en la que
//				 se encuentre cada estado en esta dw. 
//
//				 En las incidencias imprevistas con interrupci$$HEX1$$f300$$ENDHEX$$n, scada con interrupci$$HEX1$$f300$$ENDHEX$$n:
//					- fila 1: estado pendiente
//					- fila 2: estado enviado brigada


//					- fila 3: estado en reposici$$HEX1$$f300$$ENDHEX$$n
//					- fila 4: estado servicio repuesto
//					- fila 5: estado resuelta
//
//				 En las incidencias de suministro,de calidad o de scada sin p$$HEX1$$e900$$ENDHEX$$rdidas:
//					- fila 1: estado pendiente
//					- fila 2: estado enviado brigada
//					- fila 3: estado servicio repuesto
//					- fila 4: estado resuelta
//
//
//				 En las incidencias programadas con interrupci$$HEX1$$f300$$ENDHEX$$n:
//					- fila 1: estado pendiente
//					- fila 2: estado enviado brigada
//					- fila 3: estado en reposici$$HEX1$$f300$$ENDHEX$$n
//					- fila 4: estado servicio repuesto

//					- fila 5: estado resuelta
//
//				 En las incidencias programadas sin interrupci$$HEX1$$f300$$ENDHEX$$n:
//					- fila 1: estado pendiente
//					- fila 2: estado enviado brigada
//					- fila 3: estado servicio repuesto
//					- fila 4: estado resuelta
//
// Responsables: 	LFE
//
// Par$$HEX1$$e100$$ENDHEX$$metros:
//    Entrada: 
//		Salida : 
//
// Devuelve:
//
// Fecha      Responsable   Actuaci$$HEX1$$f300$$ENDHEX$$n
// ------	  -----------   ---------
// 27/07/00    LFE
// 26/03/01    ACO 
///////////////////////////////////////////////////////

int li_ind_act_grafica,li_eb=0
int li_estado_oper
int	li_numeroReg			//N$$HEX1$$fa00$$ENDHEX$$mero de registros que recupera la consulta del programa que ha generado el descargo en el caso de las incidencias programadas.
long ll_row, ll_fila_estado_sr, ll_fila_estado_rs,ll_nro_descargo
datetime ld_fecha

Select cod_estado 
into :li_eb 
from sgd_estado_oper 
where nro_incidencia = :il_nro_incidencia 
	and cod_estado = :fgci_incidencia_enviado_brigada; 

IF tabpage_formulario.d_inf_general.rowcount() > 0 THEN
	li_estado_oper = tabpage_formulario.d_inf_general.object.estado_actual[1]
ELSE
	li_estado_oper = fgci_incidencia_pendiente
END IF

IF ii_tipo_incid = fgci_incidencia_calidad &
	OR ii_alcance = fgci_incidencia_de_suministro &
	OR (ii_alcance = fgci_incidencia_sin_interrupcion AND ii_tipo_incid <> fgci_incidencia_programada) THEN
	
	// MIRAMOS SI LA INCIDENCIA TIENE EB O NO
	if li_estado_oper > fgci_incidencia_pendiente and li_eb <> 2 THEN

		ii_incidencia_pendiente = 1  // fila 1 de la dw de seguimiento de operaciones
		ii_incidencia_enviado_brigada = 0
		ii_incidencia_en_reposicion = 0
		ii_incidencia_servicio_repuesto = 2
		ii_incidencia_resuelta = 3
		IF ib_ind_scada = true THEN
			ii_incidencia_cerrada = 4
		ELSE
			ii_incidencia_cerrada = 4
		END IF
	else
		// Incidencias de calidad, imprevistas de suministro, imprevistas sin p$$HEX1$$e900$$ENDHEX$$rdida,
		// scada sin p$$HEX1$$e900$$ENDHEX$$rdida
		ii_incidencia_pendiente = 1  // fila 1 de la dw de seguimiento de operaciones
		ii_incidencia_enviado_brigada = 2
		ii_incidencia_en_reposicion = 0
		ii_incidencia_servicio_repuesto = 3
		ii_incidencia_resuelta = 4
		IF ib_ind_scada = true THEN
			ii_incidencia_cerrada = 5
		ELSE
			ii_incidencia_cerrada = 5
		END IF
	END IF
ELSEIF ii_tipo_incid = fgci_incidencia_programada THEN
	//Incializaciones
	li_numeroReg = 0
	
	
	// COMPROBAMOS SI ES CON TRABJO GRAFICO DE BDI
	  SELECT nvl("SGD_DESCARGOS"."IND_ACT_GRAFICA",0),nro_descargo
	  INTO :li_ind_act_grafica,:ll_nro_descargo  
    FROM "SGD_DESCARGOS"  
   WHERE "SGD_DESCARGOS"."NRO_INCIDENCIA" = :il_nro_incidencia   ;

	// Comprobamos si todav$$HEX1$$ed00$$ENDHEX$$a se est$$HEX2$$e1002000$$ENDHEX$$gestionando el trabajo
	
	select count(*) 
	into :ii_cant_trabajos 
	from sgd_trabajos_bdi 
	where nro_descargo = :ll_nro_descargo;
	
	// Comprobamos si la incidencia ha llegado al estado pe
	
	Select cod_estado 
	into :ii_pe 
	from sgd_estado_oper 
	where nro_incidencia = :il_nro_incidencia 
	and cod_estado = :fgci_incidencia_pte_explotacion; 
	
	//AHM (03/11/2011) Integraci$$HEX1$$f300$$ENDHEX$$n OSGI - OSGM
//	IF gb_interfaseOsgm THEN
//		
//		SELECT count(*)
//		INTO	 :li_numeroReg
//		FROM   sgd_estados_descargo
//		WHERE  UPPER(programa) = 'W_SGM_DESCARGO'
//				 AND estado = 1
//				 AND nro_descargo = :ll_nro_descargo;
//		
//	END IF
		
				
	IF ii_alcance=fgci_incidencia_con_interrupcion THEN  // incidencia programada con interrupci$$HEX1$$f300$$ENDHEX$$n
		//AHM (07/02/2011) ASUR 919288
		IF li_eb = 0 AND li_estado_oper > 2 THEN
			ii_incidencia_pendiente = 1  // fila 1 de la dw de seguimiento de operaciones
			ii_incidencia_enviado_brigada = 0
			ii_incidencia_en_reposicion = 2
			ii_incidencia_servicio_repuesto = 3
			
			// En caso de que tenga trabajo de BDI cambiamos el orden de la fila metiendo primero PE
			
			if (li_ind_Act_grafica = 1 and ii_cant_trabajos > 0) or ii_pe > 0 then 
	//		if (li_ind_Act_grafica = 1 ) then
				IF li_numeroReg = 0 THEN
					ii_incidencia_pte_pta_explotacion= 4 // OJO ESTA TRUCADO PARA QUE APAREZCA EN EL ORDEN CORRECTO
					ii_incidencia_resuelta = 5
				ELSE
					ii_incidencia_pte_pta_explotacion= 0 // OJO ESTA TRUCADO PARA QUE APAREZCA EN EL ORDEN CORRECTO
					ii_incidencia_resuelta = 4
				END IF
			else
				ii_incidencia_resuelta = 4
			end if
			
		ELSE
			ii_incidencia_pendiente = 1  // fila 1 de la dw de seguimiento de operaciones
			ii_incidencia_enviado_brigada = 2 
			ii_incidencia_en_reposicion = 3
			ii_incidencia_servicio_repuesto = 4
			
			// En caso de que tenga trabajo de BDI cambiamos el orden de la fila metiendo primero PE
			
			if (li_ind_Act_grafica = 1 and ii_cant_trabajos > 0) or ii_pe > 0 then 
	//		if (li_ind_Act_grafica = 1 ) then
				IF li_numeroReg = 0 THEN
					ii_incidencia_pte_pta_explotacion= 5 // OJO ESTA TRUCADO PARA QUE APAREZCA EN EL ORDEN CORRECTO
					ii_incidencia_resuelta = 6
				ELSE
					ii_incidencia_pte_pta_explotacion= 0 // OJO ESTA TRUCADO PARA QUE APAREZCA EN EL ORDEN CORRECTO
					ii_incidencia_resuelta = 5
				END IF
			else
				ii_incidencia_resuelta = 5
			end if
			
		END IF
				
	ELSE  // incidencia programada sin interrupci$$HEX1$$f300$$ENDHEX$$n
		//AHM (07/02/2011) ASUR 919288
		IF li_eb = 0 AND li_estado_oper > 2 THEN
			ii_incidencia_pendiente = 1  // fila 1 de la dw de seguimiento de operaciones
			ii_incidencia_enviado_brigada = 0 
			ii_incidencia_en_reposicion = 0
			ii_incidencia_servicio_repuesto = 2
				// En caso de que tenga trabajo de BDI cambiamos el orden de la fila metiendo primero PE
			if li_ind_Act_grafica = 1 and ii_cant_trabajos > 0 then 
				IF li_numeroReg = 0 THEN
					ii_incidencia_pte_pta_explotacion=3 // OJO ESTA TRUCADO PARA QUE APAREZCA EN EL ORDEN CORRECTO
					ii_incidencia_resuelta = 4
				ELSE
					ii_incidencia_pte_pta_explotacion=0 // OJO ESTA TRUCADO PARA QUE APAREZCA EN EL ORDEN CORRECTO
					ii_incidencia_resuelta = 3
				END IF
			else
				ii_incidencia_resuelta = 3
			end if
			
		ELSE
			ii_incidencia_pendiente = 1  // fila 1 de la dw de seguimiento de operaciones
			ii_incidencia_enviado_brigada = 2 
			ii_incidencia_en_reposicion = 0
			ii_incidencia_servicio_repuesto = 3
				// En caso de que tenga trabajo de BDI cambiamos el orden de la fila metiendo primero PE
			if li_ind_Act_grafica = 1 and ii_cant_trabajos > 0 then 
				IF li_numeroReg = 0 THEN
					ii_incidencia_pte_pta_explotacion=4 // OJO ESTA TRUCADO PARA QUE APAREZCA EN EL ORDEN CORRECTO
					ii_incidencia_resuelta = 5
				ELSE
					ii_incidencia_pte_pta_explotacion=0 // OJO ESTA TRUCADO PARA QUE APAREZCA EN EL ORDEN CORRECTO
					ii_incidencia_resuelta = 4
				END IF
			else
				ii_incidencia_resuelta = 4
			end if
			
		END IF
		

	END IF
	
ELSE // incidencia imprevista con interrupci$$HEX1$$f300$$ENDHEX$$n o scada con interrupcion
	
	IF li_estado_oper <= fgci_incidencia_enviado_brigada then
		ii_incidencia_pendiente = 1  // fila 1 de la dw de seguimiento de operaciones
		ii_incidencia_enviado_brigada = 2
		ii_incidencia_en_reposicion = 3
		ii_incidencia_servicio_repuesto = 4
		ii_incidencia_resuelta = 5

		ii_incidencia_cerrada = 6
	ELSE
		IF li_eb = 2 THEN // Si tiene Enviado Brigada en BD
			ii_incidencia_pendiente = 1  // fila 1 de la dw de seguimiento de operaciones
			ii_incidencia_enviado_brigada = 2
			ii_incidencia_en_reposicion = 3
			ii_incidencia_servicio_repuesto = 4
			ii_incidencia_resuelta = 5
			ii_incidencia_cerrada = 6				
		ELSEIF ib_anadir_eb = true then// Si no tiene enviado Brigada en EB pero se lo acabo de a$$HEX1$$f100$$ENDHEX$$adir
			ii_incidencia_pendiente = 1  // fila 1 de la dw de seguimiento de operaciones
			ii_incidencia_enviado_brigada = 2
			ii_incidencia_en_reposicion = 3
			ii_incidencia_servicio_repuesto = 4
			ii_incidencia_resuelta = 5
			ii_incidencia_cerrada = 6
		ELSE // Si no tiene EB ni se lo acabo de a$$HEX1$$f100$$ENDHEX$$adir
			ii_incidencia_pendiente = 1  // fila 1 de la dw de seguimiento de operaciones
			ii_incidencia_enviado_brigada = 0
			ii_incidencia_en_reposicion = 2
			ii_incidencia_servicio_repuesto = 3
			ii_incidencia_resuelta = 4
			ii_incidencia_cerrada = 5
		END IF
	END IF
END IF

end subroutine

public function integer fw_valida_drag_brigada_no_disp (long pl_nro_brigada);////////////////////////////////////////////////////////////////////////////////////////////////
//
// Funci$$HEX1$$f300$$ENDHEX$$n: fw_valida_drag_brigada_no_disp
// 
// Objetivo: Indica si se puede asignar una brigada no disponible a una OT
//
//	Ambito:	p$$HEX1$$fa00$$ENDHEX$$blico
//
// Par$$HEX1$$e100$$ENDHEX$$metros: 
//			Entrada: pl_nro_brigada -> nro de brigada que se desea asignar a la OT
//						
//			Salida:  
//						
// Devuelve: 1 -> en caso de que se pueda asignar
//				 0 -> en caso de que no se pueda asignar
//
//  Fecha	  Responsable	Actuaci$$HEX1$$f300$$ENDHEX$$n
// ---------	-------		----------------------------------------
//	17/08/2000  LFE	      
//
////////////////////////////////////////////////////////////////////////////////////////////////

int li_nro_brigadas, li_retorno
long ll_row, ll_nro_ot

// Se comprueba si la brigada se encuentra trabajando en esta OT
ll_row = tabpage_ot.d_lista_brigadas_ot.Find("nro_brigada = "+string(pl_nro_brigada)+" AND ISNULL(f_hasta)", 0, tabpage_ot.d_lista_brigadas_ot.RowCount())

IF ll_row > 0 THEN
	// La brigada se encuentra trabajando esta OT. No se puede volver a asignar
	gnv_msg.f_mensaje("EO04", "","", OK!)
	li_retorno = 0
ELSE
	// Se comprueba en la OT de la brigada si hay m$$HEX1$$e100$$ENDHEX$$s brigadas trabajando
	
	// En primer lugar se busca la OT en la que traja la brigada

	ll_nro_ot = tabpage_ot.tab_lista_brigadas.tabpage_no_disponibles.dw_brigadas_no_disponibles.GetItemNumber(click_row,"nro_ot")
	
	IF ll_nro_ot = -1 THEN 
		// No se puede desasignar la brigada de la OT
		gnv_msg.f_mensaje("EO05", "","", OK!)
		li_retorno = 0
	ELSE
		li_retorno = 1
	END IF
END IF

return li_retorno
		

end function

public function integer fnu_carga_sin_interrup (long pl_nro_instalacion, integer pi_tipo_instalacion);//////////////////////////////////////////////////////////
//
// Funci$$HEX1$$f300$$ENDHEX$$n/Evento: Fnu_carga_sin_interrup
//
// Objetivo: Carga la Datawindow que muestra informaci$$HEX1$$f300$$ENDHEX$$n acerca de la instalaci$$HEX1$$f300$$ENDHEX$$n cuando marca
//           una interrupcion
//         
// Ambito:  Privado
//
// Par$$HEX1$$e100$$ENDHEX$$metros:
//
//        Entrada: Pl_nro_instalaci$$HEX1$$f300$$ENDHEX$$n
//        Salida: 1 si trae los datos
//					  -1 si no los trae.
//
// Devuelve: 
//
// Fecha            Responsable             Actuaci$$HEX1$$f300$$ENDHEX$$n
// --------         -----------             ---------
// 09/02/2000	    FDO
//		
/////////////////////////////////////////////////////////// 

Double ll_pot_inst_afect, &
		 ll_pot_contr_afec, &
		 ll_pot_inst_afect_TOT=0, &
		 ll_pot_contr_afec_TOT=0, &
		 ll_pot_contr, &
		 ll_pot_instalada

long ll_ccli_afect,ll_ccli_afect_TOT=0
long ll_cant_cli,ll_fila,ll_nro_inst

// Se ejecuta una select que me trae el sumatorio de los datos de las intalaciones hijas
// que me afectan

DECLARE LC_CURSOR_POTENCIAS CURSOR FOR
(select distinct nro_instalacion,pot_inst_afec,pot_contr_afec,ccli_afec 
from sgd_interrupcion
where nro_incidencia= :il_nro_incidencia and sgd_interrupcion.nro_instalacion in 
	(select nro_instalacion 
	 from sgd_instalacion 
	 start with nro_instalacion=:pl_nro_instalacion and bdi_job=0
	 connect by prior nro_instalacion =nro_inst_padre and bdi_job=0 ));


OPEN LC_CURSOR_POTENCIAS;

if sqlca.sqlcode <> 0 then
	return -1
end if

FETCH LC_CURSOR_POTENCIAS INTO :ll_nro_inst,:ll_pot_inst_afect,:ll_pot_contr_afec,:ll_ccli_afect;

DO WHILE sqlca.sqlcode = 0 
	
	if not isnull(ll_pot_inst_afect) then
		ll_pot_inst_afect_TOT=ll_pot_inst_afect_TOT + ll_pot_inst_afect
	end if
	if not isnull(ll_pot_contr_afec) then
		ll_pot_contr_afec_TOT=ll_pot_contr_afec_TOT + ll_pot_contr_afec
	end if
	if not isnull(ll_ccli_afect) then
			ll_ccli_afect_TOT=ll_ccli_afect_TOT + ll_ccli_afect
	end if
	
	FETCH LC_CURSOR_POTENCIAS INTO :ll_nro_inst,:ll_pot_inst_afect,:ll_pot_contr_afec,:ll_ccli_afect;

LOOP

CLOSE LC_CURSOR_POTENCIAS;

// Se cargan los datos gen$$HEX1$$e900$$ENDHEX$$ricos de la instalacion

select pot_contratada,pot_instalada,cant_cli 
into :ll_pot_contr,:ll_pot_instalada,:ll_cant_cli
from sgd_instalacion
where nro_instalacion=:pl_nro_instalacion and bdi_job=0 ;

if sqlca.sqlcode <> 0 then
	return -1
end if

// Se inserta un registro en la datawindow y se cargan los datos

ll_fila=tabpage_interrupciones.dw_sin_interrupcion.insertrow(0)

tabpage_interrupciones.dw_sin_interrupcion.object.pot_inst[ll_fila]=ll_pot_instalada
tabpage_interrupciones.dw_sin_interrupcion.object.pot_inst_afect[ll_fila]=ll_pot_inst_afect_tot
tabpage_interrupciones.dw_sin_interrupcion.object.pot_contr[ll_fila]=ll_pot_contr
tabpage_interrupciones.dw_sin_interrupcion.object.pot_contr_afect[ll_fila]=ll_pot_contr_afec_tot
tabpage_interrupciones.dw_sin_interrupcion.object.cant_cli[ll_fila]=ll_cant_cli
tabpage_interrupciones.dw_sin_interrupcion.object.cant_cli_afect[ll_fila]=ll_ccli_afect_tot
tabpage_interrupciones.dw_sin_interrupcion.object.nro_instalacion[ll_fila]=pl_nro_instalacion

return 1
end function

public function boolean of_brigada_aun_disponible (long pl_nro_brigada);////////////////////////////////////////////////////////////////////
//
// Funcion: of_brigada_aun_disponible
//
// Objetivo: Comprueba si la brigada que se desea asignar a una OT sigue disponible. 
//				 El problema est$$HEX2$$e1002000$$ENDHEX$$en que la brigada ha podido ser asignada a otra OT por parte 
//				 de otro usuario, y no nos hemos enterado de este cambio en el estado de la
//				 brigada
//


// Ambito:   P$$HEX1$$fa00$$ENDHEX$$blico
//
// Par$$HEX1$$e100$$ENDHEX$$metros:
//    Entrada: pl_nro_brigada: n$$HEX1$$fa00$$ENDHEX$$mero de brigada
//		Salida : --
//
// Devuelve: TRUE si la brigada sigue disponible
//				 FALSE si ls brigada ya no se encuentra disponible
//
// Fecha     	 Responsable   Actuaci$$HEX1$$f300$$ENDHEX$$n
// ------	    -----------   ---------
// 08/11/2000	  LFE				Creaci$$HEX1$$f300$$ENDHEX$$n
//
///////////////////////////////////////////////////////
int li_ind_disponible

IF tabpage_ot.rb_2.checked = True THEN
	return TRUE
ELSE
	SELECT IND_DISPONIBLE
	INTO :li_ind_disponible
	FROM GI_BRIGADA
	WHERE NRO_BRIGADA = :pl_nro_brigada;
	
	IF SQLCA.SQLCode <> 0 THEN
		RETURN False
	ELSE
		IF li_ind_disponible = 1 THEN
			Return True
		ELSE 
			Return False
		END IF
	END IF
END IF
end function

public function integer of_componer_dw_interrupciones ();////////////////////////////////////////////////////////////////////////////////////////////////
//
// Funci$$HEX1$$f300$$ENDHEX$$n: of_componer_dw_interrupciones
// 
// Objetivo: Funci$$HEX1$$f300$$ENDHEX$$n que asigna a la datawindow d_datos_interrup el dataobject adecuado
//				 en funci$$HEX1$$f300$$ENDHEX$$n de si en operaciones se han interrumpido acometidas o CT, y de si
//				 se est$$HEX2$$e1002000$$ENDHEX$$o no en la ventana de hist$$HEX1$$f300$$ENDHEX$$ricos
//	 
// Ambito:	P$$HEX1$$fa00$$ENDHEX$$blico
//
// Par$$HEX1$$e100$$ENDHEX$$metros: 
//		Entrada:  --
//
//		Salida:   --
//						
// Devuelve:	
//
//  Fecha	  Responsable	Actuaci$$HEX1$$f300$$ENDHEX$$n
// ---------	-------		----------------------------------------
//	17/1/01		LFE			Creaci$$HEX1$$f300$$ENDHEX$$n
//
////////////////////////////////////////////////////////////////////////////////////////////////

// Se comprueba si hay interfaz con operaciones y de si la incidencia se ha dado de alta 
// desde all$$HEX1$$ed00$$ENDHEX$$
IF iw_contenedora.fw_incidencia_de_operaciones() THEN
	
	// Si operaciones ha interrumpido acometidas y no CT's
	IF (gi_tension_nivel_min >= fgci_baja_tension & 
	OR is_tipo_ventana <> "w_2301_hist")  THEN

		// Se comprueba el nivel de tensi$$HEX1$$f300$$ENDHEX$$n con representaci$$HEX1$$f300$$ENDHEX$$n gr$$HEX1$$e100$$ENDHEX$$fica en operaciones
		IF gi_tension_nivel_min < fgci_baja_tension THEN
			// En el caso de no tener baja tensi$$HEX1$$f300$$ENDHEX$$n el dataobject de d_datos_interrupt tiene que
			// ser 'd_ins_datos_acometida_int_mt', ya que se obtienen los datos de la acometida de
			// manera distinta, ya que $$HEX1$$e900$$ENDHEX$$stas no se encuentran en SGD_INTERRUPCION
			tabpage_interrupciones.d_datos_interrup.dataobject='d_ins_datos_acometida_int_mt'
			//tabpage_interrupciones.d_datos_interrup.dataobject='d_ins_datos_acometida_int'
		ELSE
			// Operaciones tiene baja tensi$$HEX1$$f300$$ENDHEX$$n. Los datos de las acometidas interrumpidas se 
			// encuentran en SGD_INTERRUPCION, y es de ah$$HEX2$$ed002000$$ENDHEX$$de donde se obtienen los datos de
			// cada acometida interrumpida
			tabpage_interrupciones.d_datos_interrup.dataobject='d_ins_datos_acometida_int'
		END IF
		tabpage_interrupciones.d_datos_interrup.Object.fase_a.Text='Fase ' + gs_fase_a
		tabpage_interrupciones.d_datos_interrup.Object.fase_b.Text='Fase ' + gs_fase_b
		tabpage_interrupciones.d_datos_interrup.Object.fase_c.Text='Fase ' + gs_fase_c
		tabpage_interrupciones.d_datos_interrup.SetTransObject(SQLCA)
		tabpage_interrupciones.d_datos_interrup.Reset()
	END IF
	
END IF

return 1
end function

public function integer of_grabar_ot ();////////////////////////////////////////////////////////////////////////////////////////////////
//
// Funci$$HEX1$$f300$$ENDHEX$$n: of_grabar_ot
// 
// Objetivo: Funci$$HEX1$$f300$$ENDHEX$$n que graba los datos de las brigadas/contratas asignadas a una OT en 

//				 GI_BRIGADA_OT y GI_CONTRATA_OT
//	 
// Ambito:	P$$HEX1$$fa00$$ENDHEX$$blico
//
// Par$$HEX1$$e100$$ENDHEX$$metros: 
//		Entrada:  --
//
//		Salida:   --
//						
// Devuelve:	
//
//  Fecha	  Responsable	Actuaci$$HEX1$$f300$$ENDHEX$$n
// ---------	-------		----------------------------------------
//	17/1/01		LFE			Creaci$$HEX1$$f300$$ENDHEX$$n
//
////////////////////////////////////////////////////////////////////////////////////////////////
int li_contador
int li_id_responsable, li_est_brigada 
long ll_nro_ot, ll_nro_brigada
string ls_programa, ls_usuario, ls_tipo
Datetime  ldt_h_desde, ldt_h_hasta, ldt_f_desde, ldt_f_hasta, ldt_h_actual, ldt_f_actual

DELETE GI_BRIGADA_OT
WHERE NRO_OT = :il_nro_ot;

DELETE GI_CONTRATA_OT
WHERE NRO_OT = :il_nro_ot;

// Como se pueden tener brigadas y contratas asignada en la OT, no se puede hacer un update
// de la datawindow, ya que no es capaz de actualizar dos tablas. En su lugar se insertan 
// los datos de las brigadas/contratas en gi_brigada_ot y gi_contrata_ot respectivamente
// teniendo en cuenta el tipo de equipo asignado
FOR li_contador=1 TO tabpage_ot.d_lista_brigadas_ot.RowCount()
	// Se obtiene el tipo
	ls_tipo = tabpage_ot.d_lista_brigadas_ot.GetItemString(li_contador, 'tipo')
	// Se obtiene el resto de los datos de la brigada/contrata

	ldt_h_desde = tabpage_ot.d_lista_brigadas_ot.GetItemDateTime(li_contador, 'h_desde')
	ldt_f_desde = tabpage_ot.d_lista_brigadas_ot.GetItemDateTime(li_contador, 'f_desde')
	ldt_f_hasta = tabpage_ot.d_lista_brigadas_ot.GetItemDateTime(li_contador, 'f_hasta')
	ldt_h_hasta = tabpage_ot.d_lista_brigadas_ot.GetItemDateTime(li_contador, 'h_hasta')
	li_id_responsable = tabpage_ot.d_lista_brigadas_ot.GetItemNumber(li_contador, 'ind_responsable')
	ll_nro_ot = tabpage_ot.d_lista_brigadas_ot.GetItemNumber(li_contador, 'nro_ot')
	ls_programa = tabpage_ot.d_lista_brigadas_ot.GetItemString(li_contador, 'programa')
	ldt_h_actual = tabpage_ot.d_lista_brigadas_ot.GetItemDateTime(li_contador, 'h_actual')
	ldt_f_actual = tabpage_ot.d_lista_brigadas_ot.GetItemDateTime(li_contador, 'f_actual')
	ls_usuario = tabpage_ot.d_lista_brigadas_ot.GetItemString(li_contador, 'usuario')
	ll_nro_brigada = tabpage_ot.d_lista_brigadas_ot.GetItemNumber(li_contador, 'nro_brigada')
	li_est_brigada = tabpage_ot.d_lista_brigadas_ot.GetItemNumber(li_contador, 'est_brigada')
	
	
	IF ls_tipo = 'Brig.' THEN
		
		// El equipo se trata de una brigada. Se han borrado sus datos de GI_BRIGADA_OT y se 
		// vuelven a insertar para su actualizaci$$HEX1$$f300$$ENDHEX$$n. No se realiza un UPDATE debido a que no
		// se sabe si la brigada es una brigada nueva en la OT, con lo que el UPDATE fallar$$HEX1$$ed00$$ENDHEX$$a
				
		// Se inserta la brigada en la ot
	  	INSERT INTO "GI_BRIGADA_OT"  
         ( "USUARIO",   
           "F_ACTUAL",   
           "H_ACTUAL",   
           "PROGRAMA",   
           "NRO_OT",   
           "NRO_BRIGADA",   
           "F_DESDE",   
           "H_DESDE",   
           "F_HASTA",   
           "H_HASTA",   
           "ID_REPONSABLE",   
           "EST_BRIGADA")  
		VALUES ( :ls_usuario,   
				  :ldt_f_actual,   
				  :ldt_h_actual,   
				  :ls_programa,   
				  :ll_nro_ot,   
				  :ll_nro_brigada,   
				  :ldt_f_desde,   
				  :ldt_h_desde,   
				  :ldt_f_hasta,   
				  :ldt_h_hasta,   
				  :li_id_responsable,   
				  :li_est_brigada)  ;
				  
		IF SQLCA.SQLCode <> 0 THEN
			Return -1
		END IF
				  
		ELSE
			// El equipo se trata de una contrata. Se han borrado sus datos de GI_CONTRATA_OT y se 
			// vuelven a insertar para su actualizaci$$HEX1$$f300$$ENDHEX$$n. No se realiza un UPDATE debido a que no
			// se sabe si la contrata es una contrata nueva en la OT, con lo que el UPDATE fallar$$HEX1$$ed00$$ENDHEX$$a
				
			 INSERT INTO "GI_CONTRATA_OT"  
						( "USUARIO",   
						  "F_ACTUAL",   
						  "PROGRAMA",   
						  "NRO_OT",   
						  "NRO_CONTRATA",   
						  "F_DESDE",   
						  "F_HASTA",   
						  "EST_BRIGADA")  
			 VALUES (  :ls_usuario,   
				  		  :ldt_f_actual,   
						  :ls_programa,   
						  :ll_nro_ot,   
						  :ll_nro_brigada,   
						  :ldt_f_desde,   
						  :ldt_f_hasta,   
						  :li_est_brigada)  ;

		IF SQLCA.SQLCode <> 0 THEN
			Return -1
		END IF
	END IF
NEXT

return 1
end function

public function boolean of_comprobar_reapertura (datetime pdt_fecha_sr);Double ld_minutos, ld_duracion
Boolean lb_permitir_interrupcion

// La incidencia se encuentra en estado SR. Hay que comprobar si se ha sobrepasado o no
// el tiempo 't' parametrizable para permitir reabrir la incidencia.
// Si se ha sobrepasado el tiempo 't' no se permite marcar m$$HEX1$$e100$$ENDHEX$$s interrupciones
		

SELECT TO_NUMBER(VALOR)
INTO :ld_minutos
FROM SGD_VALOR
WHERE CODIF = 'REAP';

IF SQLCA.SQLCode <> 0 THEN
	// No se ha podido obtener el tiempo 't' parametrizable
	messagebox("Atenci$$HEX1$$f300$$ENDHEX$$n", "La incidencia no ha podido ser reabierta")
	lb_permitir_interrupcion = False
ELSE
	// Se comprueba si se est$$HEX2$$e1002000$$ENDHEX$$dentro del tiempo en el que se puede reabrir la
	// incidencia
	SELECT ( (:pdt_fecha_sr + (:ld_minutos/(24*60))) - sysdate) * 24 * 60
	INTO :ld_duracion
	FROM DUAL; 
	
	IF ld_duracion > 0 THEN
		// No se ha sobrepasado el tiempo 't' parametrizable. Se puede reabrir la incidencia
		lb_permitir_interrupcion = true
	ELSE
		// Se ha sobrepasado el tiempo 't' parametrizable. No se puede reabrir la incidencia
		lb_permitir_interrupcion = false
		messagebox("Atenci$$HEX1$$f300$$ENDHEX$$n", "No se ha podido reabrir la incidencia debido a que se ha sobrepasado el tiempo de " + string(integer(ld_minutos)) + " minutos desde que la incidencia pas$$HEX2$$f3002000$$ENDHEX$$a SR")	
	END IF

	
END IF

return lb_permitir_interrupcion
end function

public function integer fnu_valida_cierre_interrupcion (long pl_handle, string ps_fase_afectada);//////////////////////////////////////////////////////////
//
// Funci$$HEX1$$f300$$ENDHEX$$n/Evento: fnu_valida_cierre_interrupcion
//
// Objetivo: Validar si existen otras interrupciones aguas abajo y dar la posibilidad de resolverlas.
//         
// Ambito:  P$$HEX1$$fa00$$ENDHEX$$blico
//
// Par$$HEX1$$e100$$ENDHEX$$metros:
//
//        Entrada: 
//        Salida: 
//
// Devuelve: 1 si esta permitido
//	            -1 si no est$$HEX2$$e1002000$$ENDHEX$$permitido
//
// Fecha            Responsable             Actuaci$$HEX1$$f300$$ENDHEX$$n
// --------             -----------             ---------
// 01/09/2000	  FDO
//		
/////////////////////////////////////////////////////////// 

int  li_fila, li_nro_inst_int = 0, li_tipo_instalacion_inter
long ll_nro_instalacion,ll_nro_incidencia, ll_fila, ll_nro_inst_padre
string ls_nombre_instalacion, ls_campo_f_rep, ls_mensaje, ls_fase_afect, ls_fases_extras
datetime ldt_fecha_nula
DataStore lds_inst_int

setnull(ldt_fecha_nula)

if pl_handle > 0 then
	ll_nro_instalacion = tabpage_interrupciones.tv_1.of_ret_codigo(pl_handle) 
	SELECT NRO_INST_PADRE
	INTO :ll_nro_inst_padre
	FROM SGD_INSTALACION
	WHERE NRO_INSTALACION = :ll_nro_instalacion
			AND BDI_JOB = 0;
			
	IF SQLCA.SQLCODE = 0 THEN
		ll_nro_instalacion = ll_nro_inst_padre
	ELSE
		Return 1
	END IF
else
	return -1
end if

lds_inst_int = CREATE DataStore
lds_inst_int.dataobject = 'd_instalaciones_interrumpidas'

DECLARE lc_instalaciones  CURSOR FOR  
SELECT sgd_instalacion.nom_instalacion,
		 sgd_interrupcion.nro_incidencia,
		 sgd_instalacion.tipo_instalacion,
	decode(f_alta_fase_a, null, '0', decode(f_reposicion_fase_a,null,'1','0')) || 
	decode(f_alta_fase_b, null, '0', decode(f_reposicion_fase_b,null,'1','0')) || 
	decode(f_alta_fase_c, null, '0', decode(f_reposicion_fase_c,null,'1','0'))
FROM 
	  "SGD_INTERRUPCION",   
      "SGD_INSTALACION" 
WHERE "SGD_INTERRUPCION"."NRO_INSTALACION" in
		 (SELECT "NRO_INSTALACION" 
		  FROM "SGD_INSTALACION"
		  START WITH "SGD_INSTALACION"."NRO_INSTALACION" = :ll_nro_instalacion
		  CONNECT BY PRIOR  "SGD_INSTALACION"."NRO_INST_PADRE" = "SGD_INSTALACION"."NRO_INSTALACION" ) AND
   "SGD_INTERRUPCION"."NRO_INSTALACION" = "SGD_INSTALACION"."NRO_INSTALACION" AND
   "SGD_INTERRUPCION"."NRO_INCIDENCIA" <> :il_nro_incidencia AND
	"SGD_INTERRUPCION"."F_REPOSICION" IS NULL;
	
//	AND
//	((SUBSTR(:ps_fase_afectada,1,1) ='1' AND SUBSTR(NVL("SGD_INTERRUPCION"."FASE_AFECTADA",'111'),1,1) = '1')  OR 
// 	 (SUBSTR(:ps_fase_afectada,2,1) ='1' AND SUBSTR(NVL("SGD_INTERRUPCION"."FASE_AFECTADA",'111'),2,1) = '1') OR 
//	 (SUBSTR(:ps_fase_afectada,3,1) ='1' AND SUBSTR(NVL("SGD_INTERRUPCION"."FASE_AFECTADA",'111'),3,1) = '1')) AND
//	DECODE(:ps_fase_afectada, '111', "SGD_INTERRUPCION"."F_REPOSICION",
//									  '100', "SGD_INTERRUPCION"."F_REPOSICION_FASE_A",
//									  '010', "SGD_INTERRUPCION"."F_REPOSICION_FASE_B",
//									  '001', "SGD_INTERRUPCION"."F_REPOSICION_FASE_C", 
//											   "SGD_INTERRUPCION"."F_REPOSICION") IS NULL;
	  
//	   	fgnu_comparar_fase("SGD_INTERRUPCION"."FASE_AFECTADA", :ps_fase_afectada) = 1 AND

OPEN lc_instalaciones;

FETCH lc_instalaciones INTO :ls_nombre_instalacion,:ll_nro_incidencia, 
									 :li_tipo_instalacion_inter,:ls_fase_afect;


DO WHILE sqlca.sqlcode <> 100
	IF NOT gb_red_trifasica THEN 
		IF tabpage_interrupciones.tv_1.of_ret_tipo(pl_handle) > fgci_tipo_ct AND li_tipo_instalacion_inter <= fgci_tipo_ct THEN
			ls_fases_extras = tabpage_interrupciones.tv_1.of_det_perdida_ct(ll_nro_instalacion,ls_fase_afect, tabpage_interrupciones.tv_1.of_ret_tipo_conexion(pl_handle) , tabpage_interrupciones.tv_1.of_ret_tipo_ct(pl_handle) )
		ELSE
			ls_fases_extras = ls_fase_afect
		END IF
	END IF
	IF gb_red_trifasica OR ls_fases_extras <> '' THEN
		IF (Mid(ps_fase_afectada,1,1) = '1' AND Mid(ls_fases_extras,1,1) = '1') OR &
			(Mid(ps_fase_afectada,2,1) = '1' AND Mid(ls_fases_extras,2,1) = '1') OR &
			(Mid(ps_fase_afectada,3,1) = '1' AND Mid(ls_fases_extras,3,1) = '1') OR &
			gb_red_trifasica THEN
			// No se puede reponer la interrupcion
	
			IF lds_inst_int.Find("ps_nom_instalacion = " + ls_nombre_instalacion, 1, lds_inst_int.RowCount()) <= 0 THEN
				li_nro_inst_int ++
				li_fila=lds_inst_int.InsertRow(0)
				lds_inst_int.SetItem(li_fila, 'pl_nro_incidencia', ll_nro_incidencia)
				lds_inst_int.SetItem(li_fila, 'ps_nom_instalacion', ls_nombre_instalacion)
				IF gb_red_trifasica THEN
					lds_inst_int.SetItem(li_fila, 'pi_fase_visible', 0)	
				ELSE
					lds_inst_int.SetItem(li_fila, 'pi_fase_visible', 1)
										
					ls_fases_extras = ""
					
					IF Mid(ls_fase_afect,1,1) = '1' THEN
						ls_fases_extras = gs_fase_a
					END IF
					IF Mid(ls_fase_afect,2,1) = '1' THEN
						ls_fases_extras += gs_fase_b
					END IF
					IF Mid(ls_fase_afect,3,1) = '1' THEN
						ls_fases_extras += gs_fase_c
					END IF
					lds_inst_int.SetItem(li_fila, 'ps_fase_afectada', ls_fases_extras)
				END IF
			END IF
		END IF
	END IF	

	FETCH lc_instalaciones INTO :ls_nombre_instalacion,:ll_nro_incidencia,
										 :li_tipo_instalacion_inter,:ls_fase_afect;

LOOP

CLOSE lc_instalaciones;

if li_nro_inst_int > 0 then

	gu_comunic.is_comunic.strval1 = 'Interrupciones de nivel superior que afectan a la instalaci$$HEX1$$f300$$ENDHEX$$n'

	Messagebox("Atenci$$HEX1$$f300$$ENDHEX$$n", "No se puede reponer la Interrupci$$HEX1$$f300$$ENDHEX$$n debido a que existen Interrupciones pendientes en Instalaciones de nivel superior")
	OpenWithParm(w_mensaje_2, lds_inst_int)
	
	ll_fila=tabpage_interrupciones.d_datos_interrup.FIND("nro_instalacion = " + string(ll_nro_instalacion),0,tabpage_interrupciones.d_datos_interrup.rowcount())

	IF ps_fase_afectada = "111" THEN
		ls_campo_f_rep = "f_reposicion"  // trif$$HEX1$$e100$$ENDHEX$$sico
	ELSEIF ps_fase_afectada = "100" THEN
		ls_campo_f_rep = "f_reposicion_fase_a" // monof$$HEX1$$e100$$ENDHEX$$sico, resolviendo fase A
	ELSEIF ps_fase_afectada = "010" THEN
		ls_campo_f_rep = "f_reposicion_fase_b"	// monof$$HEX1$$e100$$ENDHEX$$sico, resolviendo fase B
	ELSEIF ps_fase_afectada = "001" THEN
		ls_campo_f_rep = "f_reposicion_fase_c" // monof$$HEX1$$e100$$ENDHEX$$sico, resolviendo fase C
	END IF
	
	tabpage_interrupciones.d_datos_interrup.Setitem(ll_fila, ls_campo_f_rep, ldt_fecha_nula)
	
	return -1
	
end if

if tabpage_interrupciones.d_lista_otras_inst.rowcount() > 0 AND &
	tabpage_interrupciones.d_lista_otras_inst.visible AND &
	tabpage_interrupciones.tv_1.HideSelection = FALSE then
	
	ls_mensaje= "Existen otras interrupciones en instalaciones que dependen de esta instalaci$$HEX1$$f300$$ENDHEX$$n. Es posible que esas interrupciones puedan resolverse a partir de este momento."
	messagebox("Atenci$$HEX1$$f300$$ENDHEX$$n",ls_mensaje,information!,ok!) 
	tabpage_interrupciones.d_lista_otras_inst.setfocus()
	return 1
end if

return 1
end function

public subroutine of_validar_fecha_rep (long pl_fila, datawindow pdw_interr, boolean pb_int_en_arbol);////////////////////////////////////////////////////////////////////////////////////////////////
//
// Funci$$HEX1$$f300$$ENDHEX$$n: of_validar_fecha_rep
// 
// Objetivo: Funci$$HEX1$$f300$$ENDHEX$$n que obtiene la fecha final de reposici$$HEX1$$f300$$ENDHEX$$n de la interrrupci$$HEX1$$f300$$ENDHEX$$n de una
// 	       instalaci$$HEX1$$f300$$ENDHEX$$n cuando todas las fases afectadas se encuentren repuestas
//
// Ambito:	P$$HEX1$$fa00$$ENDHEX$$blico
//
// Par$$HEX1$$e100$$ENDHEX$$metros: 
//		Entrada:  pl_fila --> fila de la datawindow pdw_interr donde se encuentra los datos
//									 de la interrupcion
//					 pdw_interr --> d_datos_interrup, o d_lista_otras_inst
//					 pb_int_en_arbol --> indica si los datos se la interrupci$$HEX1$$f300$$ENDHEX$$n son de d_datos_interrup
//
//		Salida:   --
//						
// Devuelve:	
//				 
//
//  Fecha	  Responsable	Actuaci$$HEX1$$f300$$ENDHEX$$n
// ---------	-------		----------------------------------------
//	20/03/01		LFE			Creaci$$HEX1$$f300$$ENDHEX$$n
//
////////////////////////////////////////////////////////////////////////////////////////////////

Boolean lb_interrupciones_res = TRUE
//String ls_fase_interrumpida
Datetime ldt_fecha_rep, ldt_fecha_max_rep, ldt_f_alta, ldt_f_no_valida
Long ll_tiempo_interrupcion, ll_nro_instalacion, ll_fila_dw_otras_int, ll_elem
Int li_tipo_instalacion
String ls_fase_abierta='', ls_fase_afectada_padre = ''
treeviewitem le_elemento

//SetNull(ldt_fecha_max_rep)
IF pl_fila > 0 THEN
	
	if gb_red_trifasica = FALSE THEN
	
		// Miramos qu$$HEX2$$e9002000$$ENDHEX$$fase est$$HEX2$$e1002000$$ENDHEX$$interrumpida
		//ls_fase_interrumpida_num = pdw_interr.GetItemString(pl_fila, 'fase_afectada')
		ll_elem = tabpage_interrupciones.tv_1.FindItem(ParentTreeItem!, il_handle_instalacion)
		IF ll_elem > 0 THEN
			ls_fase_afectada_padre = tabpage_interrupciones.tv_1.of_ret_fase_afectada(ll_elem)
		END IF
		// Se comprueba si la fase A ha sido interrumpida
		//IF Match(ls_fase_interrumpida, "A") THEN
		IF NOT ISNULL(pdw_interr.GetItemDateTime(pl_fila, 'f_alta_fase_a')) THEN
			// Se comprueba si la interrupci$$HEX1$$f300$$ENDHEX$$n en A est$$HEX2$$e1002000$$ENDHEX$$resuelta
			ldt_fecha_rep = pdw_interr.GetItemDatetime(pl_fila, 'f_reposicion_fase_a')
			IF NOT isnull(ldt_fecha_rep) THEN
				ldt_fecha_max_rep = ldt_fecha_rep
				IF Match(ls_fase_afectada_padre, gs_fase_a) THEN
					ls_fase_abierta = gs_fase_a
				END IF
			ELSE
				ls_fase_abierta = gs_fase_a
				lb_interrupciones_res = FALSE
			END IF
		ELSE
			IF Match(ls_fase_afectada_padre, gs_fase_a) THEN
				ls_fase_abierta = gs_fase_a
			END IF
		END IF
		
		// Se comprueba si la fase B ha sido interrumpida 
		//IF Match(ls_fase_interrumpida, "B") AND lb_interrupciones_res THEN
		IF NOT ISNULL(pdw_interr.GetItemDateTime(pl_fila, 'f_alta_fase_b')) THEN
			// Se comprueba si la interrupci$$HEX1$$f300$$ENDHEX$$n en A est$$HEX2$$e1002000$$ENDHEX$$resuelta
			ldt_fecha_rep = pdw_interr.GetItemDatetime(pl_fila, 'f_reposicion_fase_b')
			IF NOT isnull(ldt_fecha_rep) AND ldt_fecha_rep > ldt_fecha_max_rep THEN
				ldt_fecha_max_rep = ldt_fecha_rep
			ELSEIF NOT isnull(ldt_fecha_rep) THEN
				IF Match(ls_fase_afectada_padre, gs_fase_b) THEN
					ls_fase_abierta += gs_fase_b
				END IF
			ELSEIF isnull(ldt_fecha_rep) THEN
				ls_fase_abierta += gs_fase_b
				lb_interrupciones_res = FALSE
			END IF
		ELSE
			IF Match(ls_fase_afectada_padre, gs_fase_b) THEN
				ls_fase_abierta += gs_fase_b
			END IF
		END IF
		
		// Se comprueba si la fase C ha sido interrumpida 
		//IF Match(ls_fase_interrumpida, "C") AND lb_interrupciones_res THEN
		IF NOT ISNULL(pdw_interr.GetItemDateTime(pl_fila, 'f_alta_fase_c')) THEN
			// Se comprueba si la interrupci$$HEX1$$f300$$ENDHEX$$n en A est$$HEX2$$e1002000$$ENDHEX$$resuelta
			ldt_fecha_rep = pdw_interr.GetItemDatetime(pl_fila, 'f_reposicion_fase_c')
			IF NOT isnull(ldt_fecha_rep) AND ldt_fecha_rep > ldt_fecha_max_rep THEN
				ldt_fecha_max_rep = ldt_fecha_rep
			ELSEIF NOT isnull(ldt_fecha_rep) THEN
				IF Match(ls_fase_afectada_padre, gs_fase_c) THEN
					ls_fase_abierta += gs_fase_c
				END IF
			ELSEIF isnull(ldt_fecha_rep) THEN
				ls_fase_abierta += gs_fase_c
				lb_interrupciones_res = FALSE
			END IF
		ELSE
			IF Match(ls_fase_afectada_padre, gs_fase_c) THEN
				ls_fase_abierta += gs_fase_c
			END IF
		END IF
	ELSE
		ldt_fecha_max_rep = pdw_interr.GetItemDatetime(pl_fila, 'f_reposicion')
	END IF
	// Esta condici$$HEX1$$f300$$ENDHEX$$n es para prevenir el caso de que la interrupci$$HEX1$$f300$$ENDHEX$$n resuelta sea de 
	// trif$$HEX1$$e100$$ENDHEX$$sico y se est$$HEX2$$e9002000$$ENDHEX$$resolviendo en monof$$HEX1$$e100$$ENDHEX$$sico
	IF ldt_fecha_max_rep = ldt_f_no_valida THEN
		ldt_fecha_max_rep = pdw_interr.GetItemDatetime(pl_fila, 'f_reposicion')
	END IF
	
	tabpage_interrupciones.tv_1.of_set_fase_afectada(il_handle_instalacion, ls_fase_abierta)
	
	IF lb_interrupciones_res AND NOT isnull(ldt_fecha_max_rep) THEN
		// Si todas fases interrumpidas est$$HEX1$$e100$$ENDHEX$$n repuestas se a$$HEX1$$f100$$ENDHEX$$ade la fecha final de reposici$$HEX1$$f300$$ENDHEX$$n
		// y el tiempo de interrupci$$HEX1$$f300$$ENDHEX$$n a los datos de la instalaci$$HEX1$$f300$$ENDHEX$$n interrumpida
		ldt_f_alta = pdw_interr.GetItemDatetime(pl_fila,"f_alta")
		ll_tiempo_interrupcion = fg_duracion_minutos(ldt_f_alta, ldt_fecha_max_rep)
	
		IF gb_red_trifasica = FALSE THEN
			pdw_interr.SetItem(pl_fila,"f_reposicion",ldt_fecha_max_rep)
		END IF

		IF pb_int_en_arbol THEN
			pdw_interr.SetItem(pl_fila,"tiempo_interrupcion",ll_tiempo_interrupcion)
		END IF
		
		pdw_interr.AcceptText()
		
		IF pb_int_en_arbol THEN
			// Hay que asignar a la instalaci$$HEX1$$f300$$ENDHEX$$n un nuevo icono y eliminar la X ya que 
			// las interrupciones han quedado resueltas
			tabpage_interrupciones.tv_1.getitem(il_handle_instalacion, le_elemento)
			li_tipo_instalacion = pdw_interr.GetItemNumber(pl_fila, 'tipo_instalacion')
			ll_nro_instalacion = pdw_interr.GetItemNumber(pl_fila, 'nro_instalacion')
			tabpage_interrupciones.tv_1.of_icono_rama(li_tipo_instalacion,ll_nro_instalacion,pdw_interr,le_elemento,il_handle_instalacion)
			le_elemento.StatePictureIndex = 3
			tabpage_interrupciones.tv_1.setitem(il_handle_instalacion,le_elemento)
		ELSE
			ll_fila_dw_otras_int = tabpage_interrupciones.d_lista_otras_inst_ant.Find("nro_instalacion="+string(tabpage_interrupciones.d_lista_otras_inst_ant.il_nro_instalacion)+&
																											  " and isnull(f_reposicion)", 1, &
																											  tabpage_interrupciones.d_lista_otras_inst_ant.RowCount())

			IF ll_fila_dw_otras_int > 0 THEN
				tabpage_interrupciones.d_lista_otras_inst_ant.Setitem(ll_fila_dw_otras_int, 'f_reposicion', ldt_fecha_max_rep)
			END IF
		END IF
	END IF
	
END IF


end subroutine

public function integer fnu_valida_interrupcion (long pl_handle, string ps_fase_afectada, ref string ps_fase_permitida, boolean pb_mostrar_ventana);//////////////////////////////////////////////////////////
//
// Funci$$HEX1$$f300$$ENDHEX$$n/Evento: fnu_valida_interrupcion
//
// Objetivo:lb_permitir_int Validar si es posible dar de alta una interrupcion en una instalacion
//         
// Ambito:  P$$HEX1$$fa00$$ENDHEX$$blico
//
// Par$$HEX1$$e100$$ENDHEX$$metros:
//
//        Entrada: 
//        Salida: 
//
// Devuelve: 1 si esta permitido
//	            -1 si no est$$HEX2$$e1002000$$ENDHEX$$permitido
//
// Fecha            Responsable             Actuaci$$HEX1$$f300$$ENDHEX$$n
// --------             -----------             ---------
// 01/09/2000	  FDO
//		
/////////////////////////////////////////////////////////// 

int li_fila, li_tipo_instalacion_inter
long ll_nro_instalacion,ll_nro_incidencia, ll_interrupciones = 0
string ls_nombre_instalacion, ls_fase_afectada, ls_fase, ls_fase_int, ls_fases_extras, ls_fase_afect
Boolean lb_permitir_int = FALSE
Boolean lb_permitir_int_fase_a,lb_permitir_int_fase_b,lb_permitir_int_fase_c
Datetime ldt_f_res, ldt_f_res_fase_a, ldt_f_res_fase_b, ldt_f_res_fase_c
DataStore lds_inst_int

if pl_handle > 0 then
	ll_nro_instalacion = tabpage_interrupciones.tv_1.of_ret_codigo(pl_handle) 
else
	return -1
end if

IF pb_mostrar_ventana THEN
	lds_inst_int = CREATE DataStore
	lds_inst_int.dataobject = 'd_instalaciones_interrumpidas'
END IF

ps_fase_permitida=''

IF MATCH(ps_fase_afectada, gs_fase_a)  THEN
	ls_fase_afectada = '1'
ELSE
	ls_fase_afectada = '0'
END IF

IF MATCH(ps_fase_afectada, gs_fase_b)  THEN
	ls_fase_afectada = ls_fase_afectada + '1'
ELSE
	ls_fase_afectada = ls_fase_afectada + '0'
END IF

IF MATCH(ps_fase_afectada, gs_fase_c)  THEN
	ls_fase_afectada = ls_fase_afectada + '1'
ELSE

	ls_fase_afectada = ls_fase_afectada + '0'
END IF

DECLARE lc_instalaciones  CURSOR FOR  
SELECT "SGD_INSTALACION"."NOM_INSTALACION",
		 "SGD_INTERRUPCION"."NRO_INCIDENCIA",
		 "SGD_INTERRUPCION"."FASE_AFECTADA",
		 "SGD_INTERRUPCION"."F_REPOSICION",
		 "SGD_INTERRUPCION"."F_REPOSICION_FASE_A",
		 "SGD_INTERRUPCION"."F_REPOSICION_FASE_B",
		 "SGD_INTERRUPCION"."F_REPOSICION_FASE_C",
		 "SGD_INSTALACION"."TIPO_INSTALACION"
FROM  "SGD_INTERRUPCION",   
		"SGD_INSTALACION"
WHERE "SGD_INTERRUPCION"."NRO_INSTALACION" in
				 (SELECT "NRO_INSTALACION" 
				  FROM "SGD_INSTALACION"
				  START WITH "SGD_INSTALACION"."NRO_INSTALACION" = :ll_nro_instalacion And BDI_JOB = 0
				  CONNECT BY PRIOR  "SGD_INSTALACION"."NRO_INST_PADRE" = "SGD_INSTALACION"."NRO_INSTALACION" And BDI_JOB = 0 )
  AND	"SGD_INTERRUPCION"."NRO_INSTALACION" = "SGD_INSTALACION"."NRO_INSTALACION" AND
		"SGD_INTERRUPCION"."NRO_INCIDENCIA" <> :il_nro_incidencia AND
		"SGD_INTERRUPCION"."F_REPOSICION" is null;


//SELECT sgd_instalacion.nom_instalacion,
//			sgd_interrupcion.nro_incidencia,
//			sgd_valor.descripcion,
//			SGD_INTERRUPCION.F_REPOSICION, 
//			SGD_INTERRUPCION.F_REPOSICION_FASE_A, 
//			SGD_INTERRUPCION.F_REPOSICION_FASE_B, 
//			SGD_INTERRUPCION.F_REPOSICION_FASE_C 
//FROM 
//	  "SGD_INTERRUPCION",   
//      "SGD_INSTALACION",
//		"SGD_VALOR"
//WHERE "SGD_INTERRUPCION"."NRO_INSTALACION" in
//		 (SELECT "NRO_INSTALACION" 
//		  FROM "SGD_INSTALACION"
//		  START WITH "SGD_INSTALACION"."NRO_INSTALACION" = :ll_nro_instalacion And BDI_JOB = 0
//		  CONNECT BY PRIOR  "SGD_INSTALACION"."NRO_INST_PADRE" = "SGD_INSTALACION"."NRO_INSTALACION" And BDI_JOB = 0 ) AND
//      "SGD_INTERRUPCION"."NRO_INSTALACION" = "SGD_INSTALACION"."NRO_INSTALACION" AND
//		"SGD_INTERRUPCION"."NRO_INCIDENCIA" <> :il_nro_incidencia AND
//	   "SGD_INTERRUPCION"."F_REPOSICION" is null AND
//	   ((SUBSTR(NVL("SGD_INTERRUPCION"."FASE_AFECTADA",'111'),1,1) = '1' AND SUBSTR(:ls_fase_afectada,1,1) ='1')  OR 
//		 (SUBSTR(NVL("SGD_INTERRUPCION"."FASE_AFECTADA",'111'),2,1) = '1' AND SUBSTR(:ls_fase_afectada,2,1) ='1') OR 
//		 (SUBSTR(NVL("SGD_INTERRUPCION"."FASE_AFECTADA",'111'),3,1) = '1' AND SUBSTR(:ls_fase_afectada,3,1) ='1')) AND
//		"SGD_VALOR"."CODIF" (+) = 'FASE' AND
//		"SGD_VALOR"."VALOR" (+) = "SGD_INTERRUPCION"."FASE_AFECTADA";
//		
////		fgnu_comparar_fase("SGD_INTERRUPCION"."FASE_AFECTADA", :ls_fase_afectada) = 1 AND



IF gb_red_trifasica THEN
	lb_permitir_int_fase_a = TRUE
	lb_permitir_int_fase_b = TRUE
	lb_permitir_int_fase_c = TRUE
	
	OPEN lc_instalaciones;
		
	FETCH lc_instalaciones 
	INTO :ls_nombre_instalacion,:ll_nro_incidencia, :ls_fase_int,
		  :ldt_f_res, :ldt_f_res_fase_a, :ldt_f_res_fase_b, :ldt_f_res_fase_c,
		  :li_tipo_instalacion_inter;

	IF sqlca.sqlcode = 100 THEN
		lb_permitir_int = TRUE
	END IF
	
	DO WHILE sqlca.sqlcode = 0
		IF pb_mostrar_ventana THEN
			IF lds_inst_int.Find("ps_nom_instalacion = " + ls_nombre_instalacion, 1, lds_inst_int.RowCount()) <= 0 THEN
				li_fila=lds_inst_int.InsertRow(0)
				lds_inst_int.SetItem(li_fila, 'pl_nro_incidencia', ll_nro_incidencia)
				lds_inst_int.SetItem(li_fila, 'ps_nom_instalacion', ls_nombre_instalacion)
				lds_inst_int.SetItem(li_fila, 'pi_fase_visible', 0)
			END IF
		END IF
		ll_interrupciones ++
		FETCH lc_instalaciones 
		INTO :ls_nombre_instalacion,:ll_nro_incidencia, :ls_fase_int,
			  :ldt_f_res, :ldt_f_res_fase_a, :ldt_f_res_fase_b, :ldt_f_res_fase_c,
			  :li_tipo_instalacion_inter;

	LOOP
	
	CLOSE lc_instalaciones;
ELSE
	lb_permitir_int_fase_a = MATCH(ps_fase_afectada,gs_fase_a) &
					 AND NOT MATCH(tabpage_interrupciones.tv_1.of_ret_fase_afectada(pl_handle), gs_fase_a)
	lb_permitir_int_fase_b = MATCH(ps_fase_afectada,gs_fase_b) &
					 AND NOT MATCH(tabpage_interrupciones.tv_1.of_ret_fase_afectada(pl_handle), gs_fase_b)
	lb_permitir_int_fase_c = MATCH(ps_fase_afectada,gs_fase_c) &
					 AND NOT MATCH(tabpage_interrupciones.tv_1.of_ret_fase_afectada(pl_handle), gs_fase_c)
	
	OPEN lc_instalaciones;
		
	FETCH lc_instalaciones 
	INTO :ls_nombre_instalacion,:ll_nro_incidencia, :ls_fase_int,
		  :ldt_f_res, :ldt_f_res_fase_a, :ldt_f_res_fase_b, :ldt_f_res_fase_c,
		  :li_tipo_instalacion_inter;

	IF sqlca.sqlcode = 100 THEN
		lb_permitir_int = TRUE
		lb_permitir_int_fase_a = TRUE 
		lb_permitir_int_fase_b = TRUE
		lb_permitir_int_fase_c = TRUE
	END IF
		
	DO WHILE sqlca.sqlcode = 0 AND (lb_permitir_int_fase_a OR lb_permitir_int_fase_b OR lb_permitir_int_fase_c)
		//IF lb_permitir_int_fase_a THEN //AND NOT IsNull(ldt_f_alta_fase_a) THEN
			IF Mid(ls_fase_int,1,1) = '1' AND IsNull(ldt_f_res_fase_a) THEN
				ls_fase_afect = '1'
			ELSE
				ls_fase_afect = '0'
			END IF
		//ELSE
		//	ls_fase_afect = '0'
		//END IF
					
		//IF lb_permitir_int_fase_b THEN //AND NOT IsNull(ldt_f_alta_fase_a) THEN
			IF Mid(ls_fase_int,2,1) = '1' AND IsNull(ldt_f_res_fase_b) THEN
				ls_fase_afect += '1'
			ELSE
				ls_fase_afect += '0'
			END IF
		//ELSE
		//	ls_fase_afect += '0'
		//END IF
	
		//IF lb_permitir_int_fase_c THEN //AND NOT IsNull(ldt_f_alta_fase_a) THEN
			IF Mid(ls_fase_int,3,1) = '1' AND IsNull(ldt_f_res_fase_c) THEN
				ls_fase_afect += '1'
			ELSE
				ls_fase_afect += '0'
			END IF
		//ELSE
		//	ls_fase_afect += '0'
		//END IF
	
		// Si el tipo de instalaci$$HEX1$$f300$$ENDHEX$$n es un CT o superior, puede que afecte la interrupci$$HEX1$$f300$$ENDHEX$$n 
		// encontrada a m$$HEX1$$e100$$ENDHEX$$s fases por debajo del CT. Se consulta la tabla de decision
		IF tabpage_interrupciones.tv_1.of_ret_tipo(pl_handle) > fgci_tipo_ct AND li_tipo_instalacion_inter <= fgci_tipo_ct THEN
			ls_fases_extras = tabpage_interrupciones.tv_1.of_det_perdida_ct(ll_nro_instalacion,ls_fase_afect, tabpage_interrupciones.tv_1.of_ret_tipo_conexion(pl_handle) , tabpage_interrupciones.tv_1.of_ret_tipo_ct(pl_handle) )
		ELSE
			ls_fases_extras = ls_fase_afect
		END IF
		
		IF ls_fases_extras <> '' THEN
			IF Mid(ls_fases_extras,1,1) = '1' THEN
				lb_permitir_int_fase_a = FALSE
			END IF	
			IF Mid(ls_fases_extras,2,1) = '1' THEN
				lb_permitir_int_fase_b = FALSE
			END IF	
			IF Mid(ls_fases_extras,3,1) = '1' THEN
				lb_permitir_int_fase_c = FALSE
			END IF	
		END IF
//		IF Mid(ls_fase, 1,1) = '1' AND isnull(ldt_f_res_fase_a) THEN
//			lb_permitir_int_fase_a = FALSE 
//		END IF
//		IF MATCH(ls_fase, gs_fase_b) AND isnull(ldt_f_res_fase_b) THEN
//			lb_permitir_int_fase_b = FALSE
//		END IF
//		IF MATCH(ls_fase, gs_fase_c) AND isnull(ldt_f_res_fase_c) THEN
//			lb_permitir_int_fase_c = FALSE
//		END IF
		
//		IF MATCH(ls_fase, gs_fase_a) AND MATCH(ps_fase_afectada,gs_fase_a) AND isnull(ldt_f_res_fase_a) OR &
//			MATCH(ls_fase, gs_fase_b) AND MATCH(ps_fase_afectada,gs_fase_b) AND isnull(ldt_f_res_fase_b) OR &
//			MATCH(ls_fase, gs_fase_c) AND MATCH(ps_fase_afectada,gs_fase_c) AND isnull(ldt_f_res_fase_c) THEN
//		
		IF (MATCH(ps_fase_afectada,gs_fase_a) AND lb_permitir_int_fase_a=FALSE) OR &
			(MATCH(ps_fase_afectada,gs_fase_b) AND lb_permitir_int_fase_b=FALSE) OR &
			(MATCH(ps_fase_afectada,gs_fase_c) AND lb_permitir_int_fase_c=FALSE) THEN
			
			IF pb_mostrar_ventana THEN
				IF lds_inst_int.Find("ps_nom_instalacion = " + ls_nombre_instalacion, 1, lds_inst_int.RowCount()) <= 0 THEN
					ls_fase = ""
					IF Mid(ls_fase_int,1,1) = '1' THEN
						ls_fase = gs_fase_a
					END IF
					IF Mid(ls_fase_int,2,1) = '1' THEN
						ls_fase += gs_fase_b
					END IF
					IF Mid(ls_fase_int,3,1) = '1' THEN
						ls_fase += gs_fase_c
					END IF
					li_fila = lds_inst_int.InsertRow(0)
					lds_inst_int.SetItem(li_fila, 'pl_nro_incidencia', ll_nro_incidencia)
					lds_inst_int.SetItem(li_fila, 'ps_nom_instalacion', ls_nombre_instalacion)
					lds_inst_int.SetItem(li_fila, 'ps_fase_afectada', ls_fase)
					lds_inst_int.SetItem(li_fila, 'pi_fase_visible', 1)
				END IF
			END IF
			ll_interrupciones ++
		END IF
		IF (lb_permitir_int_fase_a OR lb_permitir_int_fase_b OR lb_permitir_int_fase_c) THEN
			FETCH lc_instalaciones 
			INTO :ls_nombre_instalacion,:ll_nro_incidencia, :ls_fase_int,
				  :ldt_f_res, :ldt_f_res_fase_a, :ldt_f_res_fase_b, :ldt_f_res_fase_c,
				  :li_tipo_instalacion_inter;
		END IF
	LOOP

	CLOSE lc_instalaciones;
END IF

IF lb_permitir_int_fase_a THEN
	ps_fase_permitida = gs_fase_a

END IF


IF lb_permitir_int_fase_b THEN

	ps_fase_permitida = ps_fase_permitida + gs_fase_b
END IF

IF lb_permitir_int_fase_c THEN
	ps_fase_permitida = ps_fase_permitida + gs_fase_c
END IF

IF gb_red_trifasica = FALSE THEN
	lb_permitir_int = lb_permitir_int_fase_a OR lb_permitir_int_fase_b OR lb_permitir_int_fase_c
END IF

if ll_interrupciones > 0 then
	
	IF pb_mostrar_ventana THEN
		lds_inst_int.AcceptText()
		gu_comunic.is_comunic.strval1 = 'Interrupciones de nivel superior que afectan a la instalaci$$HEX1$$f300$$ENDHEX$$n'
		IF NOT lb_permitir_int THEN
			messagebox("Atenci$$HEX1$$f300$$ENDHEX$$n", "No se puede dar de alta la Interrupci$$HEX1$$f300$$ENDHEX$$n ya que exiten Instalaciones superiores con Interrupciones pendientes")
		ELSE
			IF NOT gb_red_trifasica THEN
				messagebox("Atenci$$HEX1$$f300$$ENDHEX$$n", "No se pueden interrumpir todas las fases ya que $$HEX1$$e900$$ENDHEX$$stas se ven afectadas por Interrupciones en Instalaciones superiores")		
			END IF
		END IF
		OpenWithParm(w_mensaje_2, lds_inst_int)
	END IF
	IF lb_permitir_int THEN
		IF pb_mostrar_ventana THEN
			DESTROY lds_inst_int
		END IF
		return 1
	ELSE
		IF pb_mostrar_ventana THEN
			DESTROY lds_inst_int
		END IF
		return -1
	END IF		
end if

IF pb_mostrar_ventana THEN
	DESTROY lds_inst_int
END IF

return 1
end function

public function boolean of_comprobar_cierre_maniobras ();////////////////////////////////////////////////////////////////////////////////////////////////
//
// Funci$$HEX1$$f300$$ENDHEX$$n: of_componer_cierre_maniobras
// 
// Objetivo: Funci$$HEX1$$f300$$ENDHEX$$n que comprueba que todas las maniobras de apertura de una incidencia, 
//				 tengan su maniobra de cierre
//	 
// Ambito:	P$$HEX1$$fa00$$ENDHEX$$blico
//
// Par$$HEX1$$e100$$ENDHEX$$metros: 
//		Entrada:  --
//
//		Salida:   --
//						
// Devuelve:	TRUE -->  Si todas las maniobras de apertura tienen maniobra de cierre
//					FALSE --> Si no todas las maniobras de apertura tienen maniobra de cierre
//				 
//
//  Fecha	  Responsable	Actuaci$$HEX1$$f300$$ENDHEX$$n
// ---------	-------		----------------------------------------
//	06/04/01		LFE			Creaci$$HEX1$$f300$$ENDHEX$$n
//
////////////////////////////////////////////////////////////////////////////////////////////////

int li_sin_serv

SELECT NVL("ELTO_SINSERV",0)
INTO :li_sin_serv
FROM "SGD_INCIDENCIA"
WHERE "SGD_INCIDENCIA"."NRO_INCIDENCIA" = :il_nro_incidencia ; 

IF SQLCA.SQLCode = 0 THEN
	IF li_sin_serv = 0 THEN
		return TRUE
	ELSE
		IF messagebox("Atenci$$HEX1$$f300$$ENDHEX$$n", "Como consecuencia de las maniobras realizadas en la Incidencia, se han quedado tramos sin tensi$$HEX1$$f300$$ENDHEX$$n. $$HEX1$$bf00$$ENDHEX$$Desea a$$HEX1$$fa00$$ENDHEX$$n continuar? ", Question!, YesNo!) = 1 THEN 
			RETURN TRUE
		ELSE		
			return FALSE
		END IF
	END IF
ELSE
	Return FALSE
END IF

end function

public subroutine of_mostrar_fases_int (ref long pl_fila, string ps_fase_instalacion);////////////////////////////////////////////////////////////////////////////////////////////////
//
// Funci$$HEX1$$f300$$ENDHEX$$n: of_mostrar_fases_int
// 
// Objetivo: Funci$$HEX1$$f300$$ENDHEX$$n que habilita los checkbox que informan de las fases interrumpidas
//				 de una instalaci$$HEX1$$f300$$ENDHEX$$n si la red es monof$$HEX1$$e100$$ENDHEX$$sica
//	 
// Ambito:	P$$HEX1$$fa00$$ENDHEX$$blico
//
// Par$$HEX1$$e100$$ENDHEX$$metros: 
//		Entrada:  pl_fila --> fila donde se encuentra la instalaci$$HEX1$$f300$$ENDHEX$$n interrumpida en
//					 				 la datawindow d_datos_interrup
//					 ps_fase_instalacion --> fases de la instalaci$$HEX1$$f300$$ENDHEX$$n
//
//		Salida:   --
//						
// Devuelve:					 
//
//  Fecha	  Responsable	Actuaci$$HEX1$$f300$$ENDHEX$$n
// ---------	-------		----------------------------------------
//	20/03/01		LFE			Creaci$$HEX1$$f300$$ENDHEX$$n
//
////////////////////////////////////////////////////////////////////////////////////////////////

string ls_fase
Boolean lb_fase_marcada = False
Boolean lb_botones = FALSE
long ll_fila_con_int = 0, ll_siguiente_fila 
Boolean lb_tiene_fase_a = False
Boolean lb_tiene_fase_b = False
Boolean lb_tiene_fase_c = False
Long ll_busqueda = 1

// Se comprueba en qu$$HEX2$$e9002000$$ENDHEX$$formato viene la fase
IF Match(ps_fase_instalacion, '0') OR Match(ps_fase_instalacion, '1') THEN
	// Viene en formato num$$HEX1$$e900$$ENDHEX$$rico. Se pasa a formato de letra
	IF Mid(ps_fase_instalacion, 1, 1) = '1' THEN
		ls_fase = gs_fase_a
	END IF
	IF Mid(ps_fase_instalacion, 2, 1) = '1' THEN
		ls_fase += gs_fase_b
	END IF
	IF Mid(ps_fase_instalacion, 3, 1) = '1' THEN
		ls_fase += gs_fase_b
	END IF
	ps_fase_instalacion = ls_fase
	ls_fase = ""
END IF

IF pl_fila > 0 AND gb_red_trifasica = False THEN
	
	IF ps_fase_instalacion <> " " AND NOT isnull(ps_fase_instalacion) THEN
		IF NOT iw_contenedora.fw_incidencia_de_operaciones() THEN
			
			// Los checkbox s$$HEX1$$f300$$ENDHEX$$lo ser$$HEX1$$e100$$ENDHEX$$n visibles en el caso de que la incidencia se d$$HEX2$$e9002000$$ENDHEX$$de alta
			// desde el OPENSGI y no estemos en la ventana de hist$$HEX1$$f300$$ENDHEX$$ricos
			tabpage_interrupciones.st_fases_afect.visible = true
			tabpage_interrupciones.cbx_fase_a.visible = True AND is_tipo_ventana <> "w_2301_hist"
			tabpage_interrupciones.cbx_fase_b.visible = True AND is_tipo_ventana <> "w_2301_hist"
			tabpage_interrupciones.cbx_fase_c.visible = True AND is_tipo_ventana <> "w_2301_hist"
		END IF
		// Se comprueba si est$$HEX2$$e1002000$$ENDHEX$$cada fase
		// FASE A
		tabpage_interrupciones.cbx_fase_a.enabled = Match(ps_fase_instalacion, gs_fase_a) = TRUE
		
		// FASE B
		tabpage_interrupciones.cbx_fase_b.enabled = Match(ps_fase_instalacion, gs_fase_b) = TRUE
		
		// FASE C
		tabpage_interrupciones.cbx_fase_c.enabled = Match(ps_fase_instalacion, gs_fase_c)
				
	ELSE
		// No hay fases definidas 
		tabpage_interrupciones.cbx_fase_a.enabled = False
		tabpage_interrupciones.cbx_fase_a.visible = False
		tabpage_interrupciones.cbx_fase_b.enabled = False
		tabpage_interrupciones.cbx_fase_b.visible = False
		tabpage_interrupciones.cbx_fase_c.enabled = False
		tabpage_interrupciones.cbx_fase_c.visible = False
		tabpage_interrupciones.st_fases_afect.visible = False
	END IF
	
	// Se obtienen las fases interrumpidas para a$$HEX1$$f100$$ENDHEX$$adir la informaci$$HEX1$$f300$$ENDHEX$$n a la datawindow
	// Para ello hay que recorrerse todas las interrupciones dadas de alta en la instalaci$$HEX1$$f300$$ENDHEX$$n
	DO WHILE (lb_tiene_fase_a=FALSE OR lb_tiene_fase_b=FALSE OR lb_tiene_fase_c=FALSE) & 
				AND ll_busqueda <= tabpage_interrupciones.d_datos_interrup.RowCount() AND ll_busqueda > 0
		
		ll_busqueda = tabpage_interrupciones.d_datos_interrup.find("nro_instalacion = " + string(tabpage_interrupciones.d_datos_interrup.GetItemNumber(pl_fila,"nro_instalacion")), &
										 ll_busqueda,tabpage_interrupciones.d_datos_interrup.RowCount())
		
		IF ll_busqueda > 0 THEN
			IF NOT iw_contenedora.fw_incidencia_de_operaciones() THEN
				ls_fase = tabpage_interrupciones.d_datos_interrup.GetItemString(ll_busqueda, 'fase_afectada')
				lb_tiene_fase_a = lb_tiene_fase_a OR Mid(ls_fase,1,1) = '1'
				lb_tiene_fase_b = lb_tiene_fase_b OR Mid(ls_fase,2,1) = '1'
				lb_tiene_fase_c = lb_tiene_fase_c OR Mid(ls_fase,3,1) = '1' 
			ELSE
			 	ls_fase = tabpage_interrupciones.d_datos_interrup.GetItemString(ll_busqueda, 'sgd_valor_descripcion')
				lb_tiene_fase_a = lb_tiene_fase_a OR MATCH(ls_fase,gs_fase_a)
				lb_tiene_fase_b = lb_tiene_fase_b OR MATCH(ls_fase,gs_fase_b)
				lb_tiene_fase_c = lb_tiene_fase_c OR MATCH(ls_fase,gs_fase_c)
			END IF
		END IF
	
		IF ll_busqueda > 0 THEN
			ll_busqueda ++
		END IF
	LOOP
	
	ls_fase = ''
	
	IF lb_tiene_fase_a THEN
		ls_fase = gs_fase_a
	END IF
	IF lb_tiene_fase_b THEN
		ls_fase = ls_fase + gs_fase_b
	END IF
	IF lb_tiene_fase_c THEN
		ls_fase = ls_fase + gs_fase_c
	END IF
//ELSE
	//	ls_fase = tabpage_interrupciones.d_datos_interrup.GetItemString(pl_fila, 'sgd_valor_descripcion')
		//tabpage_interrupciones.d_datos_interrup.setitem(pl_fila, 'sgd_valor_descripcion',ls_fase) 
	//END IF
	IF ls_fase <> " " AND NOT isnull(ls_fase) AND ls_fase <> '' THEN
		// Se comprueba si est$$HEX2$$e1002000$$ENDHEX$$cada fase
		// FASE A
		tabpage_interrupciones.cbx_fase_a.checked = (Match(ls_fase, gs_fase_a) = TRUE AND tabpage_interrupciones.cbx_fase_a.enabled)
		// FASE B
		tabpage_interrupciones.cbx_fase_b.checked = (Match(ls_fase, gs_fase_b) = TRUE AND tabpage_interrupciones.cbx_fase_b.enabled)
		// FASE C
		tabpage_interrupciones.cbx_fase_c.checked = (Match(ls_fase, gs_fase_c) = TRUE AND tabpage_interrupciones.cbx_fase_c.enabled)
				
		// Se selecciona la fase interrumpida de la que se muestran los datos
		IF tabpage_interrupciones.cbx_fase_a.checked THEN 
			//IF lb_instalacion_con_int THEN
			ll_fila_con_int = tabpage_interrupciones.d_datos_interrup.find("nro_instalacion = " + string(tabpage_interrupciones.d_datos_interrup.GetItemNumber(pl_fila,"nro_instalacion")) + &
					" and (not isnull(f_alta_fase_a)) and isnull(f_reposicion_fase_a)" ,1,tabpage_interrupciones.d_datos_interrup.rowcount())
			IF ll_fila_con_int > 0 THEN
				IF NOT iw_contenedora.fw_incidencia_de_operaciones() THEN
					IF tabpage_interrupciones.tv_1.ii_tipo_icono<>tabpage_interrupciones.tv_1.f_icono_arbol(tabpage_interrupciones.tv_1.of_ret_tipo(il_handle_instalacion) + tabpage_interrupciones.tv_1.ii_instalaciones_repuestas) THEN	
						pl_fila = ll_fila_con_int
					END IF
				END IF
			//END IF
			//END IF
				//IF	isnull(tabpage_interrupciones.d_datos_interrup.GetItemDatetime(pl_fila, 'f_reposicion_fase_a')) THEN
				tabpage_interrupciones.d_datos_interrup.SetItem(pl_fila, 'fase_seleccionada', 1)
				lb_fase_marcada = TRUE
			//	END IF
			ELSE
				tabpage_interrupciones.cbx_fase_a.enabled = False
			END IF
		END IF
		
		IF tabpage_interrupciones.cbx_fase_b.checked THEN
			//IF lb_instalacion_con_int THEN
			ll_fila_con_int = tabpage_interrupciones.d_datos_interrup.find("nro_instalacion = " + string(tabpage_interrupciones.d_datos_interrup.GetItemNumber(pl_fila,"nro_instalacion")) + &
						" and (not isnull(f_alta_fase_b)) and isnull(f_reposicion_fase_b)" ,1,tabpage_interrupciones.d_datos_interrup.rowcount())
								
			IF ll_fila_con_int > 0 THEN
				IF lb_fase_marcada = FALSE THEN
					IF NOT iw_contenedora.fw_incidencia_de_operaciones() THEN
						IF tabpage_interrupciones.tv_1.ii_tipo_icono<>tabpage_interrupciones.tv_1.f_icono_arbol(tabpage_interrupciones.tv_1.of_ret_tipo(il_handle_instalacion) + tabpage_interrupciones.tv_1.ii_instalaciones_repuestas) THEN	
							pl_fila = ll_fila_con_int
						END IF
					END IF
			//END IF
			//END IF
			//IF isnull(tabpage_interrupciones.d_datos_interrup.GetItemDatetime(pl_fila, 'f_reposicion_fase_b')) THEN
				
					tabpage_interrupciones.d_datos_interrup.SetItem(pl_fila, 'fase_seleccionada', 2)
					lb_fase_marcada = TRUE
				END IF	
			ELSE
				tabpage_interrupciones.cbx_fase_b.enabled = False
			END IF
			
		END IF
		
		IF tabpage_interrupciones.cbx_fase_c.checked THEN
			//IF lb_instalacion_con_int THEN
			ll_fila_con_int = tabpage_interrupciones.d_datos_interrup.find("nro_instalacion = " + string(tabpage_interrupciones.d_datos_interrup.GetItemNumber(pl_fila,"nro_instalacion")) + &
						" and (not isnull(f_alta_fase_c)) and isnull(f_reposicion_fase_c)" ,1,tabpage_interrupciones.d_datos_interrup.rowcount())
				

			IF ll_fila_con_int > 0 THEN
				IF lb_fase_marcada = FALSE THEN
					IF NOT iw_contenedora.fw_incidencia_de_operaciones() THEN
						IF tabpage_interrupciones.tv_1.ii_tipo_icono<>tabpage_interrupciones.tv_1.f_icono_arbol(tabpage_interrupciones.tv_1.of_ret_tipo(il_handle_instalacion) + tabpage_interrupciones.tv_1.ii_instalaciones_repuestas) THEN	
							pl_fila = ll_fila_con_int
						END IF
					END IF
			//END IF
			//END IF
			//IF isnull(tabpage_interrupciones.d_datos_interrup.GetItemDatetime(pl_fila, 'f_reposicion_fase_c')) THEN
				
					tabpage_interrupciones.d_datos_interrup.SetItem(pl_fila, 'fase_seleccionada', 3)
					lb_fase_marcada = TRUE
				END IF
			ELSE
				tabpage_interrupciones.cbx_fase_c.enabled = False
			END IF
		END IF
		
		tabpage_interrupciones.d_datos_interrup.setitem(pl_fila, 'sgd_valor_descripcion',ls_fase)
		// No se ha seleccionado todav$$HEX1$$ed00$$ENDHEX$$a la fase interrumpida de la que se muestran los datos
		// Se selecciona la primera fase que se encuentra interrumpida
		IF lb_fase_marcada = False THEN
			IF tabpage_interrupciones.cbx_fase_a.checked THEN

				tabpage_interrupciones.d_datos_interrup.SetItem(pl_fila, 'fase_seleccionada', 1)
			ELSEIF tabpage_interrupciones.cbx_fase_b.checked THEN
				tabpage_interrupciones.d_datos_interrup.SetItem(pl_fila, 'fase_seleccionada', 2)
			ELSEIF tabpage_interrupciones.cbx_fase_c.checked THEN
				tabpage_interrupciones.d_datos_interrup.SetItem(pl_fila, 'fase_seleccionada', 3)
			END IF
		END IF
		tabpage_interrupciones.d_datos_interrup.AcceptText()
		
		IF ii_estado_oper >= fgci_incidencia_resuelta THEN
			tabpage_interrupciones.cbx_fase_a.enabled = False
			tabpage_interrupciones.cbx_fase_b.enabled = False
			tabpage_interrupciones.cbx_fase_c.enabled = False
		END IF
				
	ELSE
		tabpage_interrupciones.cbx_fase_a.visible = FALSE
		tabpage_interrupciones.cbx_fase_b.visible = FALSE
		tabpage_interrupciones.cbx_fase_c.visible = FALSE
		tabpage_interrupciones.st_fases_afect.visible = False
	END IF
ELSE
	IF pl_fila > 0 THEN
		ll_fila_con_int = tabpage_interrupciones.d_datos_interrup.find("nro_instalacion = " + string(tabpage_interrupciones.d_datos_interrup.GetItemNumber(pl_fila,"nro_instalacion")) + &
						" and (not isnull(f_alta)) and isnull(f_reposicion)" ,1,tabpage_interrupciones.d_datos_interrup.rowcount())
		IF ll_fila_con_int > 0 THEN
			IF NOT iw_contenedora.fw_incidencia_de_operaciones() THEN
				IF tabpage_interrupciones.tv_1.ii_tipo_icono<>tabpage_interrupciones.tv_1.f_icono_arbol(tabpage_interrupciones.tv_1.of_ret_tipo(il_handle_instalacion) + tabpage_interrupciones.tv_1.ii_instalaciones_repuestas) THEN	
					pl_fila = ll_fila_con_int
				END IF
			END IF
		END IF
		IF pl_fila > 0 THEN
			tabpage_interrupciones.d_datos_interrup.SetItem(pl_fila, 'fase_seleccionada', 0)
		END IF
	END IF
	tabpage_interrupciones.cbx_fase_a.visible = FALSE
	tabpage_interrupciones.cbx_fase_b.visible = FALSE
	tabpage_interrupciones.cbx_fase_c.visible = FALSE
	tabpage_interrupciones.st_fases_afect.visible = FALSE
END IF

IF iw_contenedora.fw_incidencia_de_operaciones() THEN
	lb_botones = True
ELSE
	IF tabpage_interrupciones.tv_1.HideSelection = FALSE AND tabpage_interrupciones.tv_1.ii_tipo_icono=tabpage_interrupciones.tv_1.f_icono_arbol(tabpage_interrupciones.tv_1.of_ret_tipo(il_handle_instalacion) + tabpage_interrupciones.tv_1.ii_instalaciones_repuestas) THEN
		lb_botones = True
		
	ELSEIF tabpage_interrupciones.d_lista_otras_inst_ant.visible AND &
			 tabpage_interrupciones.d_lista_otras_inst_ant.GetSelectedRow(0) > 0 THEN
			 
		IF NOT IsNull(tabpage_interrupciones.d_lista_otras_inst_ant.GetitemDatetime(tabpage_interrupciones.d_lista_otras_inst_ant.GetSelectedRow(0), 'f_reposicion')) THEN
			lb_botones = True
		END IF
	END IF
END IF

IF lb_botones AND pl_fila > 0 AND &
	(gi_tension_nivel_min = fgci_baja_tension OR NOT iw_contenedora.fw_incidencia_de_operaciones()) THEN
	
	ll_fila_con_int = tabpage_interrupciones.d_datos_interrup.find("nro_instalacion = " + string(tabpage_interrupciones.d_datos_interrup.GetItemNumber(pl_fila,"nro_instalacion")) &
													,1,tabpage_interrupciones.d_datos_interrup.rowcount())		
	IF ll_fila_con_int > 0 AND ll_fila_con_int < tabpage_interrupciones.d_datos_interrup.rowcount() THEN
		
		ll_siguiente_fila = tabpage_interrupciones.d_datos_interrup.find("nro_instalacion = " + string(tabpage_interrupciones.d_datos_interrup.GetItemNumber(pl_fila,"nro_instalacion")) &
													,ll_fila_con_int+1,tabpage_interrupciones.d_datos_interrup.rowcount())				
			
		IF ll_siguiente_fila > 0  THEN
			tabpage_interrupciones.pb_anterior.visible = true
			tabpage_interrupciones.pb_avanzar.visible = true
			tabpage_interrupciones.cb_separador.visible = true
			
			tabpage_interrupciones.pb_anterior.enabled = ll_fila_con_int < pl_fila 
		   tabpage_interrupciones.pb_avanzar.enabled = tabpage_interrupciones.d_datos_interrup.find("nro_instalacion = " + & 
			           string(tabpage_interrupciones.d_datos_interrup.GetItemNumber(pl_fila,"nro_instalacion")), pl_fila+1,tabpage_interrupciones.d_datos_interrup.rowcount()) > 0 AND pl_fila <> tabpage_interrupciones.d_datos_interrup.rowcount()				
			
		END IF
	
	END IF
END IF	

end subroutine

public subroutine fu_perfil_consulta (readonly datawindow adw_dw);///////////////////////////////////////////////////////
//										
// Funcion/Evento: fu_perfil_consulta
// 
// Objetivo: Inhabilita los datawindows y cambia de color los campos
// Responsable: JPA
//
// Par$$HEX1$$e100$$ENDHEX$$metros:
//    Entrada: DataWindow adw_dw
//		Salida : --
//
// Devuelve:
//
// Fecha        Responsable   Actuaci$$HEX1$$f300$$ENDHEX$$n
// ------	    -----------   ---------
// 15/05/2001   JPA
//
///////////////////////////////////////////////////////

Integer li_columnas, ll_i_col
Boolean lb_consulta_ext
dwItemStatus lst_status

adw_dw.AcceptText()
If gu_comunic.is_comunic.accion_llamada = "Consulta" Then lb_consulta_ext = True

If	ii_estado_oper >= fgci_incidencia_resuelta Or lb_consulta_ext Then
	
	If adw_dw.RowCount() > 0 Or lb_consulta_ext Then
		lst_status = adw_dw.GetItemStatus(adw_dw.GetRow(),0,PRIMARY!)
		
		If ( lst_status <> New! And lst_status <> NewModified! ) Or lb_consulta_ext THEN	
			li_columnas = Integer(adw_dw.Object.DataWindow.Column.Count)
	
			For ll_i_col = 1 To li_columnas
				adw_dw.Modify('#'+String(ll_i_col)+'.Protect=1')
				adw_dw.Modify('#'+String(ll_i_col)+'.BackGround.color='+gs_gris)
			Next
		End If
	End If
End If
end subroutine

public subroutine of_validaciones_sbt (long al_row, datawindow adw_dw);//***************************************
//**  OSGI 2001.1  	28/05/2001			**
//**  Jair Padilla / Soluziona PANAMA  **
//***************************************
Long ll_clientes_originales, ll_tipo_instalacion
Integer li_afec_parcial
double ld_potencia_original

//If al_row <= 0 Or IsNull(al_row) Then
//	al_row = adw_dw.GetRow()		
//End If

If al_row > 0 Then
	adw_dw.Modify("c_protect_afec_parcial.Expression='1'")
	adw_dw.SetTabOrder("c_protect_afec_parcial", 0)
	adw_dw.Modify("afec_parcial.Color="+ String(RGB(128,128,128)))
	adw_dw.Modify("afec_parcial_t.Color="+ String(RGB(128,128,128)))
	////////////////////////////////////////////////////////
	// AFECTACION PARCIAL VERSION UNIFICADA AMR 13/08/2002
	///////////////////////////////////////////////////////
	adw_dw.Modify("pot_inst_afec.Protect='1'")
	adw_dw.Modify("pot_inst_afec.BackGround.Color="+gs_gris)
   ll_tipo_instalacion = adw_dw.GetItemNumber(al_row, "tipo_instalacion")
	//////////////////////////////////////////////////////////
   
	If ib_afect_parcial Then
		/////////////////////////////////////////////////////////////
		// AFECTACION PARCIAL VERSIN UNIFICADA AMR 07/08/2002
		/////////////////////////////////////////////////////////////
		//If ib_afect_parcial And adw_dw.GetItemNumber(al_row, "tipo_instalacion") = fgci_tipo_salida_de_baja Then
		adw_dw.Modify("c_afectacion.Expression = '1'")
		If (ll_tipo_instalacion >= ii_tipo_inst and ll_tipo_instalacion <= fgci_tipo_salida_de_baja) then
			
			If	ii_estado_oper < fgci_incidencia_servicio_repuesto Then
				
				ll_clientes_originales = adw_dw.GetItemNumber(al_row, "cant_cli")
				ld_potencia_original = adw_dw.GetItemNumber(al_row, "pot_instalada")
				li_afec_parcial = adw_dw.GetItemNumber(al_row, "afec_parcial")

				/////////////////////////////////////////////////////////////
				// AFECTACION PARCIAL VERSIN UNIFICADA AMR 07/08/2002
				/////////////////////////////////////////////////////////////
		
				//If ll_clientes_originales > 1 And Not IsNull(ll_clientes_originales) Then
				/////////////////////////////////////////////////////////////
			
				If li_afec_parcial = 1 Then
//cant_cli_afec						adw_dw.SetTabOrder("cant_cli", 190)
//cant_cli_afec						adw_dw.Modify("cant_cli.Protect='0'")
//cant_cli_afec						adw_dw.Modify("cant_cli.BackGround.Color="+gs_blanco)
					IF fg_verifica_parametro('AFEC_PARCIAL_SUM') THEN
							adw_dw.Modify("cccli_afec_t.font.italic='1'")
							adw_dw.Modify("cccli_afec_t.font.underline='1'")
							adw_dw.Modify("cccli_afec_t.color='128'")
					ELSE
							adw_dw.SetTabOrder("cant_cli_afec", 190)
//							adw_dw.Modify("cant_cli_afec.Protect='0'")
//							adw_dw.Modify("cant_cli_afec.BackGround.Color="+gs_blanco)
					END IF
						
						////// AFECTACION PARCIAL AMR
					If ll_tipo_instalacion <> fgci_tipo_salida_de_baja Then
						adw_dw.SetTabOrder("pot_inst_afec", 200)
//						adw_dw.Modify("pot_inst_afec.Protect='0'")
//						adw_dw.Modify("pot_inst_afec.BackGround.Color="+gs_blanco)
					End if
						/////
				Else
					adw_dw.Modify("cccli_afec_t.font.italic='0'")
					adw_dw.Modify("cccli_afec_t.font.underline='0'")
					adw_dw.Modify("cccli_afec_t.color='0'")
//cant_cli_afec						adw_dw.Modify("cant_cli.Protect='1'")
//cant_cli_afec						adw_dw.Modify("cant_cli.BackGround.Color="+gs_gris)
						////// AFECTACION PARCIAL AMR
					   //adw_dw.setitem(al_row, "cant_cli_afec", ll_clientes_originales)
		       		//adw_dw.setitem(al_row, "pot_inst_afec", ld_potencia_original)
					If ll_tipo_instalacion <> fgci_tipo_salida_de_baja Then
							adw_dw.Modify("pot_inst_afec.Protect='1'")
							adw_dw.Modify("pot_inst_afec.BackGround.Color="+gs_gris)
					End if
						///////
						
					adw_dw.Modify("cant_cli_afec.Protect='1'")
					adw_dw.Modify("cant_cli_afec.BackGround.Color="+gs_gris)
				End If

				adw_dw.Modify("c_protect_afec_parcial.Expression='0'")
				adw_dw.SetTabOrder("c_protect_afec_parcial", 200)
				
				adw_dw.Modify("afec_parcial.Color="+ String(RGB(0,0,128)))
				adw_dw.Modify("afec_parcial_t.Color="+ String(RGB(0,0,0)))
			Else
//PRUEBA  					adw_dw.Modify("c_protect_afec_parcial.Expression='1'")

//cant_cli_afec					adw_dw.Modify("cant_cli.Protect='1'")
//cant_cli_afec					adw_dw.Modify("cant_cli.BackGround.Color="+gs_gris)
				If adw_dw.GetItemNumber(al_row, "afec_parcial") = 1 Then
					IF fg_verifica_parametro('AFEC_PARCIAL_SUM') THEN
						adw_dw.Modify("cccli_afec_t.font.italic='1'")
						adw_dw.Modify("cccli_afec_t.font.underline='1'")
						adw_dw.Modify("cccli_afec_t.color='128'")
					ELSE
						adw_dw.Modify("cccli_afec_t.font.italic='0'")
						adw_dw.Modify("cccli_afec_t.font.underline='0'")
						adw_dw.Modify("cccli_afec_t.color='0'")
					END IF	
				ELSE
					adw_dw.Modify("cccli_afec_t.font.italic='0'")
					adw_dw.Modify("cccli_afec_t.font.underline='0'")
					adw_dw.Modify("cccli_afec_t.color='0'")
				END IF
				adw_dw.Modify("cant_cli_afec.Protect='1'")
				adw_dw.Modify("cant_cli_afec.BackGround.Color="+gs_gris)
					
					////// AFECTACION PARCIAL AMR
				If ll_tipo_instalacion <> fgci_tipo_salida_de_baja Then
					adw_dw.Modify("pot_inst_afec.Protect='1'")
					adw_dw.Modify("pot_inst_afec.BackGround.Color="+gs_gris)
				End if
			End If
/////////////////////////////////////////////////////////////
// AFECTACION PARCIAL VERSIN UNIFICADA AMR 07/08/2002
/////////////////////////////////////////////////////////////
//			Else
//
////cant_cli_afec				adw_dw.Modify("cant_cli.Protect='1'")
////cant_cli_afec				adw_dw.Modify("cant_cli.BackGround.Color="+gs_gris)
//
//				adw_dw.Modify("cant_cli_afec.Protect='1'")
//				adw_dw.Modify("cant_cli_afec.BackGround.Color="+gs_gris)
//			End If
//////////////////////////////////////////////////////////////
		Else
//cant_cli_afec			adw_dw.Modify("cant_cli.Protect='1'")
			adw_dw.Modify("cccli_afec_t.font.italic='0'")
			adw_dw.Modify("cccli_afec_t.font.underline='0'")
			adw_dw.Modify("cccli_afec_t.color='0'")
			adw_dw.Modify("cant_cli_afec.Protect='1'")
			adw_dw.Modify("c_protect_afec_parcial.Protect='1'")
			////// AFECTACION PARCIAL AMR
			If ll_tipo_instalacion <> fgci_tipo_salida_de_baja Then
				adw_dw.Modify("pot_inst_afec.Protect='1'")
			End if
			
			
			//////
		End If
	Else
//cant_cli_afec		adw_dw.Modify("cant_cli.Protect='1'")



		adw_dw.Modify("cant_cli_afec.Protect='1'")
		adw_dw.Modify("c_protect_afec_parcial.Protect='1'")
		
			////// AFECTACION PARCIAL AMR
			If ll_tipo_instalacion <> fgci_tipo_salida_de_baja Then
				adw_dw.Modify("pot_inst_afec.Protect='1'")
			End if
			//////
			adw_dw.Modify("c_afectacion.Expression = '0'")
	End If
Else
//cant_cli_afec	adw_dw.Modify("cant_cli.Protect='1'")

	adw_dw.Modify("cant_cli_afec.Protect='1'")
	adw_dw.Modify("c_protect_afec_parcial.Protect='1'")
	
			////// AFECTACION PARCIAL AMR
			If ll_tipo_instalacion <> fgci_tipo_salida_de_baja Then
				adw_dw.Modify("pot_inst_afec.Protect='1'")
			End if
			//////
End If

IF ib_afect_parcial THEN
	//*****************************************************
	//**  JPA 20021122 SE QUITO PORQUE AFECTA EL SCROLL  **
	//**  DEL DW DE INFORMACION DE INTERRUPCIONES  		  **
	//*****************************************************
	//**  JPA 20021122 SE QUITO PORQUE AFECTA EL SCROLL  	adw_dw.SetColumn("afec_parcial")
	tabpage_interrupciones.d_datos_interrup.SetFocus()
	//*****************************************************
	//**  JPA 20021122 SE QUITO PORQUE AFECTA EL SCROLL  **
	//**  DEL DW DE INFORMACION DE INTERRUPCIONES  		  **

	//*****************************************************
END IF
//***************************************
//**  OSGI 2001.1  	28/05/2001			**
//**  Jair Padilla / Soluziona PANAMA  **
//***************************************
end subroutine

public function integer of_afec_parcial (readonly long al_row, datawindow adw_dw, readonly string as_column_name, readonly string as_data);//***************************************
//**  OSGI 2001.1  	28/05/2001			**
//**  Jair Padilla / Soluziona PANAMA  **
//***************************************

Long ll_clientes_originales_c, ll_clientes_originales_r, ll_clientes_originales_u, &
	  ll_height_gb_interr, ll_nro_instalacion, ll_clientes_originales, &
	  ll_nro_incidencia, ll_clientes_modif, ll_tipo_instalacion, ll_codigo
double ld_potencia_original, ll_pot_afec_c=0, ll_pot_afec_r=0, ll_pot_afec_u=0,ll_pot_cont_afec
DateTime ldt_fecha_inicio
Boolean ib_error_intem
string ls_fase_afectada_num, ls_tipo_area
integer li_tabla_decision

If al_row > 0 Then
	ll_clientes_modif = 0
	ib_error_intem = False
	///////////////////////////////////////////////////////
	// AFECTACION PARCIAL VERSION UNIFICADA AMR 13/08/2002
	///////////////////////////////////////////////////////
	IF adw_dw.GetItemNumber(al_row, "afec_parcial") = 0 THEN
		adw_dw.Modify("pot_inst_afec.BackGround.Color="+gs_gris)
	END IF
	ll_codigo = adw_dw.GetItemNumber(al_row, "nro_instalacion")
	ll_tipo_instalacion = adw_dw.GetItemNumber(al_row, "tipo_instalacion")
	//////////////////////////////////////////////////////////
		
   /////////////////////////////////////////////////////////////
	// AFECTACION PARCIAL VERSION UNIFICADA AMR 07/08/2002
	/////////////////////////////////////////////////////////////
	//If ib_afect_parcial And adw_dw.GetItemNumber(al_row, "tipo_instalacion") = fgci_tipo_salida_de_baja Then
	If (ll_tipo_instalacion >= ii_tipo_inst and ll_tipo_instalacion <= fgci_tipo_salida_de_baja) then
	//////////////////////////////////////////////////////////
		ll_clientes_originales = adw_dw.GetItemNumber(al_row, "cant_cli")
		ld_potencia_original =  adw_dw.GetItemNumber(al_row, "pot_instalada")
	  /////////////////////////////////////////////////////////////
	  // AFECTACION PARCIAL VERSION UNIFICADA AMR 07/08/2002
	  /////////////////////////////////////////////////////////////
		 //If ll_clientes_originales > 1 And Not IsNull(ll_clientes_originales) And ii_estado_oper < fgci_incidencia_servicio_repuesto Then
		If ii_estado_oper < fgci_incidencia_servicio_repuesto Then
	  ////////////////////////////////////////////////////////////	
			adw_dw.Modify("c_protect_afec_parcial.Expression='0'")
			adw_dw.SetTabOrder("c_protect_afec_parcial", 200)

			If Lower(as_column_name) = "afec_parcial" Then
				If Long(as_data) = 0 Then
					adw_dw.Modify("cccli_afec_t.font.italic=0")
					adw_dw.Modify("cccli_afec_t.font.underline=0")
					adw_dw.Modify("cccli_afec_t.color=0")
				/////////////////////////////////////////////////////////////
	  			// AFECTACION PARCIAL VERSION UNIFICADA AMR 07/08/2002
	  			/////////////////////////////////////////////////////////////		
				//adw_dw.SetItem(al_row, "cant_cli_afec", ll_clientes_originales)
				/////////////////////////////////////////////////////////////
					

					if gb_red_trifasica = false then
						ls_fase_afectada_num = adw_dw.GetItemString(al_row, 'fase_afectada')
									
						IF gb_tabla_decision THEN
							li_tabla_decision = 1
						ELSE
							li_tabla_decision = 0
						END IF
						
						tabpage_interrupciones.tv_1.of_cursor_clientes(1,ll_clientes_originales_c,ll_clientes_originales_r,ll_clientes_originales_u,ll_pot_cont_afec, string(ll_codigo),ls_fase_afectada_num,string(ll_tipo_instalacion),string(li_tabla_decision))

					else
						
						tabpage_interrupciones.tv_1.of_cursor_clientes(1,ll_clientes_originales_c,ll_clientes_originales_r,ll_clientes_originales_u,ll_pot_cont_afec, string(ll_codigo),ls_fase_afectada_num,string(ll_tipo_instalacion),string(li_tabla_decision))

					end if
					
					IF ll_tipo_instalacion < fgci_tipo_ct THEN
						
						SELECT NVL(SUM(DECODE(TIPO_AREA, 'C', POT_INSTALADA, 0)),0),
						 		 NVL(SUM(DECODE(TIPO_AREA, 'R', POT_INSTALADA, 0)),0),
				 				 NVL(SUM(DECODE(TIPO_AREA, 'U', POT_INSTALADA, 0)),0)
						INTO :ll_pot_afec_c, :ll_pot_afec_r, :ll_pot_afec_u
						FROM SGD_INSTALACION
						WHERE TIPO_INSTALACION = :fgci_tipo_ct AND BDI_JOB = 0
							AND FGNU_FASE_AFECTADA(NVL(TIPO_CONEXION,0), :ls_fase_afectada_num) = 1
						START WITH NRO_INSTALACION = :ll_codigo AND BDI_JOB = 0
						CONNECT BY PRIOR NRO_INSTALACION = NRO_INST_PADRE AND BDI_JOB = 0;
		
					ELSE
						SELECT FGNU_TIPO_AREA(:ll_codigo)
						INTO :ls_tipo_area
						FROM DUAL;
						
						IF SQLCA.SQLCode = 0 THEN
							CHOOSE CASE ls_tipo_area
								CASE 'C'
									ll_pot_afec_c=ld_potencia_original
								CASE 'R'
									ll_pot_afec_r=ld_potencia_original
								CASE 'U'
									ll_pot_afec_u=ld_potencia_original
							END CHOOSE
						END IF
					END IF
					
					ll_clientes_originales = ll_clientes_originales_c+ll_clientes_originales_r+ll_clientes_originales_u

					adw_dw.setitem(al_row, "cant_cli_afec", ll_clientes_originales)
					adw_dw.setitem(al_row, "ccli_afec_ciu", ll_clientes_originales_c)
					adw_dw.setitem(al_row, "ccli_afec_rur", ll_clientes_originales_r)
					adw_dw.setitem(al_row, "ccli_afec_urb", ll_clientes_originales_u)
					adw_dw.setitem(al_row, "pot_inst_afec", ll_pot_afec_c+ll_pot_afec_r+ll_pot_afec_u)
					adw_dw.setitem(al_row, "pot_inst_afec_ciu", ll_pot_afec_c)
					adw_dw.setitem(al_row, "pot_inst_afec_rur", ll_pot_afec_r)
					adw_dw.setitem(al_row, "pot_inst_afec_urb", ll_pot_afec_u)
					  /////  AFECTACION PARCIAL AMR 
				  	If ll_tipo_instalacion <> fgci_tipo_salida_de_baja Then
						adw_dw.Modify("pot_inst_afec.Protect='1'")
                 	adw_dw.Modify("pot_inst_afec.BackGround.Color="+gs_gris)
					ELSE
						IF fg_verifica_parametro('AFEC_PARCIAL_SUM') THEN
							long ll_fila
							ll_fila = tabpage_interrupciones.dw_afec_parcial_sum.Find("nro_instalacion="+string(adw_dw.GetItemNumber(al_row, 'nro_instalacion')) + &
																			" and f_alta = datetime('"+string(adw_dw.GetItemDatetime(al_row, 'f_alta')) + "')", 1, tabpage_interrupciones.dw_afec_parcial_sum.RowCount())
																			
							DO WHILE ll_fila > 0
								tabpage_interrupciones.dw_afec_parcial_sum.deleterow(ll_fila)
								ll_fila = tabpage_interrupciones.dw_afec_parcial_sum.Find("nro_instalacion="+string(adw_dw.GetItemNumber(al_row, 'nro_instalacion')) + &
																			" and f_alta = datetime('"+string(adw_dw.GetItemDatetime(al_row, 'f_alta')) + "')", 1, tabpage_interrupciones.dw_afec_parcial_sum.RowCount())
							LOOP

						END IF
				  	End if
				   
					adw_dw.Modify("cant_cli_afec.Protect='1'")
					adw_dw.Modify("cant_cli_afec.BackGround.Color="+gs_gris)

				  	/////
					

				Else
//cant_cli_afec					adw_dw.Modify("cant_cli.TabSequence=200")
//cant_cli_afec					adw_dw.Modify("cant_cli.BackGround.Color="+gs_blanco)
				 //// AFECTACION PARCIAL AMR
				 
					If ll_tipo_instalacion <> fgci_tipo_salida_de_baja Then
               	adw_dw.Modify("pot_inst_afec.TabSequence=210")
//						adw_dw.Modify("pot_inst_afec.BackGround.Color="+gs_blanco)
						adw_dw.SetTabOrder("pot_inst_afec", 210)
//						adw_dw.Modify("pot_inst_afec.Protect='0'")
//						adw_dw.Modify("pot_inst_afec.BackGround.Color="+gs_blanco)
				 	End if
             /////
					IF ll_tipo_instalacion = fgci_tipo_salida_de_baja AND fg_verifica_parametro('AFEC_PARCIAL_SUM') THEN
						adw_dw.Modify("cccli_afec_t.font.italic=1")
						adw_dw.Modify("cccli_afec_t.font.underline=1")
						adw_dw.Modify("cccli_afec_t.color=128")
						of_suministros_int(adw_dw, al_row, ll_codigo)
					ELSE
						adw_dw.Modify("cant_cli_afec.TabSequence=200")
						adw_dw.Modify("cant_cli_afec.BackGround.Color="+gs_blanco)

//cant_cli_afec					adw_dw.SetTabOrder("cant_cli", 200)					
//cant_cli_afec					adw_dw.Modify("cant_cli.Protect='0'")
				
						adw_dw.SetTabOrder("cant_cli_afec", 200)
//						adw_dw.Modify("cant_cli_afec.Protect='0'")
					END IF
				End If
			End If

			If ( Lower(as_column_name) = "f_alta" Or Lower(as_column_name) = "cant_cli_afec" ) And adw_dw.GetItemNumber(al_row, "afec_parcial") = 1 Then
				ll_height_gb_interr = Long(adw_dw.Describe("b_interrup.Height")) + &
											 Long(adw_dw.Describe("afec_parcial.Height"))
	
				ll_nro_instalacion = adw_dw.GetItemNumber(al_row, "nro_instalacion")
				ll_nro_incidencia = adw_dw.GetItemNumber(al_row, "nro_incidencia")
	//			ldt_fecha_inicio = DateTime(Date(as_data), Time(as_data))  //-> Viejo
				ldt_fecha_inicio = adw_dw.GetItemDateTime(al_row, "f_alta") //-> Nuevo, al parecer recoge el valor aunque el itemchanged no haya terminado
	
				tabpage_interrupciones.tv_1.of_cant_avisos(ll_nro_incidencia, ll_nro_instalacion, ldt_fecha_inicio)
				
				If Lower(as_column_name) = "cant_cli_afec" Then
					ll_clientes_modif = Long(as_data)
				Else
					ll_clientes_modif = adw_dw.GetItemNumber(al_row, "cant_cli_afec")
				End If

				If ll_clientes_modif <= 0 Then
					MessageBox("Atenci$$HEX1$$f300$$ENDHEX$$n", "La cantidad de clientes modificada tiene que ser mayor a cero.  Se colocar$$HEX2$$e1002000$$ENDHEX$$" + &
											  "la cantidad de clientes que posee la instalaci$$HEX1$$f300$$ENDHEX$$n.")
					ib_error_intem = True
				End If

				SELECT FGNU_TIPO_AREA(:ll_codigo) INTO :ls_tipo_area FROM DUAL;
				IF SQLCA.SQLCode < 0 THEN
					MessageBox("Atenci$$HEX1$$f300$$ENDHEX$$n", "No se ha podido modificar la cantidad de clientes debido a un error en la determinaci$$HEX1$$f300$$ENDHEX$$n del tipo de $$HEX1$$e100$$ENDHEX$$rea de la Instalaci$$HEX1$$f300$$ENDHEX$$n")
					ib_error_intem = True
				ELSEIF SQLCA.SQLCode <> 100 THEN
					CHOOSE CASE ls_tipo_area
						CASE 'R'
							adw_dw.setitem(al_row,"ccli_afec_rur", Long(as_data))
						CASE 'C'
							adw_dw.setitem(al_row,"ccli_afec_ciu", Long(as_data))
						CASE 'U'
							adw_dw.setitem(al_row,"ccli_afec_urb", Long(as_data))
					END CHOOSE
				END IF
				
				If ib_error_intem Then
					adw_dw.SetItem(al_row, "cant_cli_afec", ll_clientes_originales)
					Return 2
				End If
			End If
			IF Lower(as_column_name) = "pot_inst_afec"  And adw_dw.GetItemNumber(al_row, "afec_parcial") = 1 Then
				SELECT FGNU_TIPO_AREA(:ll_codigo) INTO :ls_tipo_area FROM DUAL;
				IF SQLCA.SQLCode = 0 THEN
					CHOOSE CASE ls_tipo_area
						CASE 'R'
							adw_dw.setitem(al_row,"pot_inst_afec_rur", double(as_data))
						CASE 'C'
							adw_dw.setitem(al_row,"pot_inst_afec_ciu", double(as_data))
						CASE 'U'
							adw_dw.setitem(al_row,"pot_inst_afec_urb", double(as_data))
					END CHOOSE
				END IF
			END IF
		Else

		///// AFECTACION PARCIAL AMR
		If ll_tipo_instalacion <> fgci_tipo_salida_de_baja Then
			adw_dw.Modify("pot_inst_afec.TabSequence=0")
			adw_dw.Modify("pot_inst_afec.Protect='1'")

			adw_dw.Modify("pot_inst_afec.BackGround.Color="+gs_gris)
		End if
		//////
			adw_dw.Modify("cant_cli_afec.TabSequence=0")
			adw_dw.Modify("cant_cli_afec.Protect='1'")
			adw_dw.Modify("cant_cli_afec.BackGround.Color="+gs_gris)

			adw_dw.Modify("c_protect_afec_parcial.Expression='1'")
		End If
	Else
// aqui
	End If
End If

Return 0
//***************************************
//**  OSGI 2001.1  	28/05/2001			**
//**  Jair Padilla / Soluziona PANAMA  **
//***************************************
end function

public function integer f_actualizar_estado ();///////////////////////////////////////////////////////
//										
// Funcion/Evento: f_actualizar_estado
// 
// Objetivo: Va actualizando los estados de la incidencia, seg$$HEX1$$fa00$$ENDHEX$$n esta
// 			 va avanzando.	
//
// Responsable: FDO 
//
// Par$$HEX1$$e100$$ENDHEX$$metros:
//    Entrada: --
//		Salida : --
//
// Devuelve:
//
// Fecha      Responsable   Actuaci$$HEX1$$f300$$ENDHEX$$n
// ------	   -----------   ---------
// 15/09/98    FDO
//
///////////////////////////////////////////////////////


int li_contador
int li_total_registros
int li_registros_r = 0
int li_registros_int = 0
int li_numeroReg					// N$$HEX1$$fa00$$ENDHEX$$mero de registros de la tabla se estados que se han creado desde el OSGM en estado pendiente
string ls_nulo
datetime ldt_fecha_alta, ldt_fecha_rep, ldt_fecha_nula, ldt_fecha_mayor_rep, &
		   ldt_fecha_menor_rep
int li_retorno = 1


//AHM (01/03/2010)
int	li_cant_trabajos			//Cantidad de trabajos asociados al descargo
int	li_ind_act_grafica		//Indicador de actualizaci$$HEX1$$f300$$ENDHEX$$n gr$$HEX1$$e100$$ENDHEX$$fica
long	ll_nro_descargo			//N$$HEX1$$fa00$$ENDHEX$$mero de descargo

if (iw_contenedora.fw_incidencia_de_operaciones() and &
	ii_estado_oper <= fgci_incidencia_servicio_repuesto) or &
	ii_estado_oper >= fgci_incidencia_resuelta or ii_alcance <> fgci_incidencia_con_interrupcion then
	
	// Operaciones se encarga de las actualizaciones
	return 1
end if

if isnull(idt_fec_deteccion) then  idt_fec_deteccion=tabpage_formulario.d_inf_general.GetItemDateTime(1,"f_deteccion")
// GNU 25-4-2006
if fg_verifica_parametro ("Activacion descargo anterior cumplir fecha") then
	ldt_fecha_mayor_rep=DateTime(Date("0001/01/01"),Time("00:00:01"))
else
	ldt_fecha_mayor_rep = idt_fec_deteccion
end if
// FIN GNU
ldt_fecha_menor_rep = DateTime(Date("2999/01/01"),Time("23:59:15"))

SetNull(ldt_fecha_nula)
SetNull(ls_nulo)

tabpage_interrupciones.d_datos_interrup.AcceptText()

li_total_registros = tabpage_interrupciones.d_datos_interrup.RowCount()

FOR li_contador = 1 TO li_total_registros
	IF tabpage_interrupciones.d_datos_interrup.GetItemNumber(li_contador, 'nro_incidencia') = il_nro_incidencia THEN
		IF gb_red_trifasica = FALSE THEN
			// Cuento las interrupciones marcadas
			ldt_fecha_alta = fgnu_valido_fecha_nula(tabpage_interrupciones.d_datos_interrup.GetItemDateTime(li_contador,"f_alta_fase_a"))
			IF NOT IsNull(ldt_fecha_alta) THEN
				li_registros_int ++
			END IF
			
			ldt_fecha_alta = fgnu_valido_fecha_nula(tabpage_interrupciones.d_datos_interrup.GetItemDateTime(li_contador,"f_alta_fase_b"))
			IF NOT IsNull(ldt_fecha_alta) THEN
				li_registros_int ++
			END IF
			
			ldt_fecha_alta = fgnu_valido_fecha_nula(tabpage_interrupciones.d_datos_interrup.GetItemDateTime(li_contador,"f_alta_fase_c"))
			IF NOT IsNull(ldt_fecha_alta) THEN
				li_registros_int ++
			END IF
			
			// Cuento la cantidad de interrupciones repuestas
			ldt_fecha_rep = fgnu_valido_fecha_nula(tabpage_interrupciones.d_datos_interrup.GetItemDateTime(li_contador,"f_reposicion_fase_a"))
			IF NOT IsNull(ldt_fecha_rep)  THEN
				li_registros_r ++
				// Obtengo la mayor fecha de reposicion
				IF ldt_fecha_mayor_rep < ldt_fecha_rep THEN
					ldt_fecha_mayor_rep = ldt_fecha_rep
				END IF
				
				// Obtengo la menor fecha de reposicion
				IF ldt_fecha_menor_rep > ldt_fecha_rep THEN
					ldt_fecha_menor_rep = ldt_fecha_rep
				END IF
		
			END IF
			
			ldt_fecha_rep = fgnu_valido_fecha_nula(tabpage_interrupciones.d_datos_interrup.GetItemDateTime(li_contador,"f_reposicion_fase_b"))
			IF NOT IsNull(ldt_fecha_rep)  THEN
				li_registros_r ++
				// Obtengo la mayor fecha de reposicion
				IF ldt_fecha_mayor_rep < ldt_fecha_rep THEN
					ldt_fecha_mayor_rep = ldt_fecha_rep
				END IF
			
				// Obtengo la menor fecha de reposicion
				IF ldt_fecha_menor_rep > ldt_fecha_rep THEN
					ldt_fecha_menor_rep = ldt_fecha_rep
				END IF
			END IF
			
			ldt_fecha_rep = fgnu_valido_fecha_nula(tabpage_interrupciones.d_datos_interrup.GetItemDateTime(li_contador,"f_reposicion_fase_c"))
			IF NOT IsNull(ldt_fecha_rep)  THEN
				li_registros_r ++
				// Obtengo la mayor fecha de reposicion
				IF ldt_fecha_mayor_rep < ldt_fecha_rep THEN
					ldt_fecha_mayor_rep = ldt_fecha_rep
				END IF
				
				// Obtengo la menor fecha de reposicion
				IF ldt_fecha_menor_rep > ldt_fecha_rep THEN
					ldt_fecha_menor_rep = ldt_fecha_rep
				END IF
			END IF
		ELSE
			// Cuento las interrupciones marcadas
			ldt_fecha_alta = fgnu_valido_fecha_nula(tabpage_interrupciones.d_datos_interrup.GetItemDateTime(li_contador,"f_alta"))
			IF NOT IsNull(ldt_fecha_alta) THEN
				li_registros_int ++
			END IF
			
			// Cuento la cantidad de interrupciones repuestas
			ldt_fecha_rep = fgnu_valido_fecha_nula(tabpage_interrupciones.d_datos_interrup.GetItemDateTime(li_contador,"f_reposicion"))
			IF NOT IsNull(ldt_fecha_rep)  THEN
				li_registros_r ++
			END IF
			

			// Obtengo la mayor fecha de reposicion
			IF ldt_fecha_mayor_rep < ldt_fecha_rep THEN
				ldt_fecha_mayor_rep = ldt_fecha_rep
			END IF
			
			// Obtengo la menor fecha de reposicion
			IF ldt_fecha_menor_rep > ldt_fecha_rep THEN
				ldt_fecha_menor_rep = ldt_fecha_rep
			END IF
	
		END IF
	END IF
NEXT
// Si hay menos registros repuestos que interrumpidos
// significa que agregue uno nuevo, por lo tanto paso a ER
IF li_registros_r < li_registros_int AND li_registros_r > 0  THEN
	// Paso a ER
	ii_estado_oper = fgci_incidencia_en_reposicion
	gi_est_oper = ii_estado_oper


//NCA-INICIO.DDAG-2482.20150610.
   idt_fecha_er = DateTime(Date(ldt_fecha_menor_rep),Time(String(Time(ldt_fecha_menor_rep),"hh:mm:ss")))	
//NCA-FIN.DDAG-2482.20150610.

	SetNull(idt_fecha_sr)
	// Actualizo el seguimiento
	tabpage_seguimiento.d_seguimiento_operaciones.SetItem(ii_incidencia_en_reposicion,"f_alta",idt_fecha_er)
	tabpage_seguimiento.d_seguimiento_operaciones.SetItem(ii_incidencia_servicio_repuesto,"f_alta",ldt_fecha_nula)
	tabpage_seguimiento.d_seguimiento_operaciones.SetItem(ii_incidencia_servicio_repuesto,"observacion",ls_nulo)

END IF

// Si la cantidad de registros repuestos es igual al de registros interrumpidos
// paso a SR
IF li_registros_r = li_registros_int AND li_registros_int > 0 &
	AND ii_estado_oper >= fgci_incidencia_enviado_brigada  THEN
	// Paso a SR siempre y cuando se haya definido una causa
//	IF ISNULL(tabpage_formulario.d_inf_general.object.st_causa.text) OR &
//		tabpage_formulario.d_inf_general.object.st_causa.text="" THEN
//		
//		gnv_msg.f_mensaje("AI57","","",ok!)
//		li_retorno = 0
//	ELSE
//NCA-INICIO.DDAG-2482.20150610.
		idt_fecha_er = DateTime(Date(ldt_fecha_menor_rep),Time(String(Time(ldt_fecha_menor_rep),"hh:mm:ss")))
		idt_fecha_sr = DateTime(Date(ldt_fecha_mayor_rep),Time(String(Time(ldt_fecha_mayor_rep),"hh:mm:ss")))
//NCA-FINI.DDAG-2482.20150610.
		
		ii_estado_oper = fgci_incidencia_servicio_repuesto
		gi_est_oper = ii_estado_oper
		//AHM (01/03/2010)
		IF ii_tipo_incid = fgci_incidencia_programada THEN
				// Comprobamos si la incidencia programada tiene asociado un tabajo de BDI
				SELECT nvl("SGD_DESCARGOS"."IND_ACT_GRAFICA",0),nro_descargo
				INTO :li_ind_act_grafica,:ll_nro_descargo  
				FROM "SGD_DESCARGOS"  
				WHERE "SGD_DESCARGOS"."NRO_INCIDENCIA" = :il_nro_incidencia;
				
				IF li_ind_act_grafica = 1 THEN
					//Comprobamos si todav$$HEX1$$ed00$$ENDHEX$$a se est$$HEX2$$e1002000$$ENDHEX$$gestionando el trabajo
					SELECT count(*) 
					INTO :li_cant_trabajos 
					FROM sgd_trabajos_bdi 
					WHERE nro_descargo = :ll_nro_descargo;
					
					//AHM (04/11/2011) Integraci$$HEX1$$f300$$ENDHEX$$n OSGI - OSGM
					//Obtenemos si el descargo ha sido generado por OSGM
//					IF gb_interfaseOsgm THEN
//						SELECT count(*)
//						INTO	 :li_numeroReg
//						FROM   sgd_estados_descargo
//						WHERE  UPPER(programa) = 'W_SGM_DESCARGO'
//								 AND estado = 1
//								 AND nro_descargo = :ll_nro_descargo;
//					END IF
				
					IF li_cant_trabajos > 0 AND li_numeroReg = 0 THEN
						tabpage_seguimiento.d_seguimiento_operaciones.SetItem(ii_incidencia_en_reposicion,"f_alta",idt_fecha_er)
						tabpage_seguimiento.d_seguimiento_operaciones.SetItem(ii_incidencia_servicio_repuesto,"f_alta",idt_fecha_sr)
						tabpage_seguimiento.d_seguimiento_operaciones.SetItem(ii_incidencia_pte_pta_explotacion,"f_alta",idt_fecha_sr)
						tabpage_seguimiento.d_seguimiento_operaciones.modify("f_alta.Protect= '1'")
						il_ultima_fila_clickeada_seg = ii_incidencia_pte_pta_explotacion
						tabpage_seguimiento.d_seguimiento_operaciones.postevent("ue_item_changed")
					ELSE 
						tabpage_seguimiento.d_seguimiento_operaciones.SetItem(ii_incidencia_en_reposicion,"f_alta",idt_fecha_er)
						tabpage_seguimiento.d_seguimiento_operaciones.SetItem(ii_incidencia_servicio_repuesto,"f_alta",idt_fecha_sr)
					END IF
				ELSE
					ii_eliminar_pe = 1
					of_iniciar_estados_oper()
					fnu_obte_estados_oper()
					tabpage_seguimiento.d_seguimiento_operaciones.SetItem(ii_incidencia_en_reposicion,"f_alta",idt_fecha_er)
					tabpage_seguimiento.d_seguimiento_operaciones.SetItem(ii_incidencia_servicio_repuesto,"f_alta",idt_fecha_sr)
				END IF
		END IF
		
		
		
		
		tabpage_seguimiento.d_seguimiento_operaciones.SetItem(ii_incidencia_en_reposicion,"f_alta",idt_fecha_er)
		tabpage_seguimiento.d_seguimiento_operaciones.SetItem(ii_incidencia_servicio_repuesto,"f_alta",idt_fecha_sr)
		//fnu_finalizar_ot(idt_fecha_sr)

// A$$HEX1$$f100$$ENDHEX$$adido por Sgo. Mejora 0/204830 de Panama. 22/06/2005.
		If gi_pais = 4 Then // Si el pa$$HEX1$$ed00$$ENDHEX$$s es Panam$$HEX1$$e100$$ENDHEX$$
			IF messagebox("Atenci$$HEX1$$f300$$ENDHEX$$n:", "$$HEX1$$bf00$$ENDHEX$$Desea finalizar la OT de esta Incidencia para liberar Brigadas?", Question!, YesNo!, 2) = 1 Then
				fnu_finalizar_ot(idt_fecha_sr)
			End If
		End If
// Fin. Sgo.
//	END IF

END IF

// Si la cantidad de registros repuestos es cero, significa que 
// borre las interrupciones o le puse fecha nula a la unica que tenia
// Paso a EB
IF li_registros_r = 0  AND ii_estado_oper >= fgci_incidencia_enviado_brigada THEN
	// Paso a EB
	ii_estado_oper = fgci_incidencia_enviado_brigada
	// Reseteo estados y fechas en seguimiento al nuevo estado.
	SetNull(idt_fecha_er)
	SetNull(idt_fecha_sr)
	tabpage_seguimiento.d_seguimiento_operaciones.SetItem(ii_incidencia_en_reposicion,"f_alta",ldt_fecha_nula)
	tabpage_seguimiento.d_seguimiento_operaciones.SetItem(ii_incidencia_en_reposicion,"observacion",ls_nulo)
	tabpage_seguimiento.d_seguimiento_operaciones.SetItem(ii_incidencia_servicio_repuesto,"f_alta",ldt_fecha_nula)
	tabpage_seguimiento.d_seguimiento_operaciones.SetItem(ii_incidencia_servicio_repuesto,"observacion",ls_nulo)
	
END IF

IF li_retorno = 1 THEN
	// Actualizo el estado en el formulario	
	tabpage_formulario.d_inf_general.SetItem(1,"estado_actual",ii_estado_oper)
END IF
 
return li_retorno
end function

public function datetime of_obtener_max_fecha_rep (datetime pdt_fecha1, datetime pdt_fecha2, datetime pdt_fecha3);////////////////////////////////////////////////////////////////////////////////////////////////
//
// Funci$$HEX1$$f300$$ENDHEX$$n: of_obtener_max_fecha_rep
// 
// Objetivo: Esta funci$$HEX1$$f300$$ENDHEX$$n obtiene el m$$HEX1$$e100$$ENDHEX$$ximo de entre tres fechas
//	 
// Ambito:	P$$HEX1$$fa00$$ENDHEX$$blico
//
// Par$$HEX1$$e100$$ENDHEX$$metros: 
//		Entrada:  pdt_fecha1 -> fecha primera
//					 pdt_fecha2 -> fecha segunda
//					 pdt_fecha3 -> fecha tercera
//
//		Salida:   --
//						
// Devuelve: M$$HEX1$$e100$$ENDHEX$$xima fecha entre pdt_fecha1, pdt_fecha2 y pdt_fecha3				 
//
//  Fecha	  Responsable	Actuaci$$HEX1$$f300$$ENDHEX$$n
// ---------	-------		----------------------------------------
//	20/03/01		LFE			Creaci$$HEX1$$f300$$ENDHEX$$n
//
////////////////////////////////////////////////////////////////////////////////////////////////

// 
datetime ldt_fecha_maxima

IF NOT ISNULL(pdt_fecha1) THEN
	IF NOT ISNULL(pdt_fecha2) THEN
		IF pdt_fecha1 >= pdt_fecha2 THEN
			ldt_fecha_maxima = pdt_fecha1
		ELSE
			ldt_fecha_maxima = pdt_fecha2
		END IF
		
		IF NOT ISNULL(pdt_fecha3) THEN
			IF ldt_fecha_maxima < pdt_fecha3 THEN
				ldt_fecha_maxima = pdt_fecha3
			END IF
		END IF
	ELSE // la segunda fecha es nula
		IF NOT ISNULL(pdt_fecha3) THEN
			IF pdt_fecha1 >= pdt_fecha3 THEN
				ldt_fecha_maxima = pdt_fecha1
			ELSE
				ldt_fecha_maxima = pdt_fecha3
			END IF
		ELSE
			ldt_fecha_maxima = pdt_fecha1
		END IF
	END IF
ELSE // la primera fecha es nula
	IF NOT ISNULL(pdt_fecha2) THEN
		IF NOT ISNULL(pdt_fecha3) THEN
			IF pdt_fecha2 >= pdt_fecha3 THEN
				ldt_fecha_maxima = pdt_fecha2
			ELSE
				ldt_fecha_maxima = pdt_fecha3
			END IF
		ELSE //  La fecha tercera tambi$$HEX1$$e900$$ENDHEX$$n es nula
			ldt_fecha_maxima = pdt_fecha2
		END IF
	ELSE // La fecha segunda es nula
		ldt_fecha_maxima = pdt_fecha3
	END IF
END IF
		
return ldt_fecha_maxima

end function

public subroutine of_calcular_min_fecha_alta (long pl_fila_int);////////////////////////////////////////////////////////////////////////////////////////////////
//
// Funci$$HEX1$$f300$$ENDHEX$$n: of_calcular_min_f_alta
// 
// Objetivo: Esta funci$$HEX1$$f300$$ENDHEX$$n actualiza el campo f_alta en d_datos_interrup para una instalaci$$HEX1$$f300$$ENDHEX$$n
//				 interrumpida en donde se ha cambiado la fecha de alta de alguna fase
//	 
// Ambito:	P$$HEX1$$fa00$$ENDHEX$$blico
//
// Par$$HEX1$$e100$$ENDHEX$$metros: 
//		Entrada:  pl_fila_int -> fila de la datawindow de interrupciones que contiene
//										 la instalaci$$HEX1$$f300$$ENDHEX$$n interrumpida
//
//		Salida:   --
//						
// Devuelve: 				 
//
//  Fecha	  Responsable	Actuaci$$HEX1$$f300$$ENDHEX$$n
// ---------	-------		----------------------------------------
//	20/03/01		LFE			Creaci$$HEX1$$f300$$ENDHEX$$n
//
////////////////////////////////////////////////////////////////////////////////////////////////


// 
datetime ldt_fecha_minima, ldt_fecha1, ldt_fecha2, ldt_fecha3, ldt_fecha_antig
long ll_contador

ldt_fecha1 = tabpage_interrupciones.d_datos_interrup.GetitemDatetime(pl_fila_int, 'f_alta_fase_a')
ldt_fecha2 = tabpage_interrupciones.d_datos_interrup.GetitemDatetime(pl_fila_int, 'f_alta_fase_b')
ldt_fecha3 = tabpage_interrupciones.d_datos_interrup.GetitemDatetime(pl_fila_int, 'f_alta_fase_c')

IF NOT ISNULL(ldt_fecha1) THEN
	IF NOT ISNULL(ldt_fecha2) THEN
		IF ldt_fecha1 <= ldt_fecha2 THEN
			ldt_fecha_minima = ldt_fecha1
		ELSE
			ldt_fecha_minima = ldt_fecha2
		END IF
		
		IF NOT ISNULL(ldt_fecha3) THEN
			IF ldt_fecha_minima > ldt_fecha3 THEN
				ldt_fecha_minima = ldt_fecha3
			END IF

		END IF
	ELSE // la segunda fecha es nula
		IF NOT ISNULL(ldt_fecha3) THEN
			IF ldt_fecha1 <= ldt_fecha3 THEN
				ldt_fecha_minima = ldt_fecha1
			ELSE
				ldt_fecha_minima = ldt_fecha3
			END IF
		ELSE
			ldt_fecha_minima = ldt_fecha1
		END IF
	END IF
ELSE // la primera fecha es nula
	IF NOT ISNULL(ldt_fecha2) THEN
		IF NOT ISNULL(ldt_fecha3) THEN
			IF ldt_fecha2 <= ldt_fecha3 THEN
				ldt_fecha_minima = ldt_fecha2
			ELSE
				ldt_fecha_minima = ldt_fecha3
			END IF
		ELSE //  La fecha tercera tambi$$HEX1$$e900$$ENDHEX$$n es nula
			ldt_fecha_minima = ldt_fecha2
		END IF
	ELSE // La fecha segunda es nula
		ldt_fecha_minima = ldt_fecha3
	END IF
END IF

IF	fg_verifica_parametro('AFEC_PARCIAL_SUM') THEN
	IF tabpage_interrupciones.d_datos_interrup.GetItemNumber(pl_fila_int, 'tipo_instalacion') = fgci_tipo_salida_de_baja THEN
		ldt_fecha_antig = tabpage_interrupciones.d_datos_interrup.GetItemDatetime(pl_fila_int, 'f_alta')
		IF ldt_fecha_antig <> ldt_fecha_minima THEN
			tabpage_interrupciones.dw_afec_parcial_sum.setfilter("nro_incidencia = " + string(tabpage_interrupciones.d_datos_interrup.GetItemNumber(pl_fila_int, 'nro_incidencia')) +&
																				  " and nro_instalacion = " + string(tabpage_interrupciones.d_datos_interrup.GetItemNumber(pl_fila_int, 'nro_instalacion')) +&
																				  " and f_alta = datetime('"+string(ldt_fecha_antig)+"')")
			tabpage_interrupciones.dw_afec_parcial_sum.filter()
			FOR ll_contador = 1 TO tabpage_interrupciones.dw_afec_parcial_sum.RowCount()
				tabpage_interrupciones.dw_afec_parcial_sum.setitem(ll_contador, 'f_alta', ldt_fecha_minima)
			NEXT
			tabpage_interrupciones.dw_afec_parcial_sum.Setfilter("")
			tabpage_interrupciones.dw_afec_parcial_sum.filter()
			
		END IF
	END IF
END IF

tabpage_interrupciones.d_datos_interrup.SetItem(pl_fila_int, 'f_alta', ldt_fecha_minima)

end subroutine

public subroutine of_cambiar_f_alta_int (datetime pdt_fec_nueva);long ll_fila = 0
DateTime ldt_fecha_alta
Boolean lb_hay_cambio = FALSE

IF gb_red_trifasica THEN
	// Si la red es trif$$HEX1$$e100$$ENDHEX$$sica se busca si existe una interrupci$$HEX1$$f300$$ENDHEX$$n cuya fecha de alta sea inferior
	// a la nueva fecha de detecci$$HEX1$$f300$$ENDHEX$$n. En caso de encontrar alguna interrupci$$HEX1$$f300$$ENDHEX$$n, se le cambia 
	// la fecha de alta
	DO
		ll_fila = tabpage_interrupciones.d_datos_interrup.Find("f_alta < datetime('" + String(pdt_fec_nueva) + "') and isnull(f_reposicion)" , ll_fila+1, tabpage_interrupciones.d_datos_interrup.RowCount())
		IF ll_fila > 0 THEN
			// Se cambia la fecha de alta por la fecha de detecci$$HEX1$$f300$$ENDHEX$$n
			tabpage_interrupciones.d_datos_interrup.setItem(ll_fila, 'f_alta', pdt_fec_nueva)
		END IF
	LOOP UNTIL (ll_fila <= 0  OR ll_fila = tabpage_interrupciones.d_datos_interrup.RowCount())
	
	tabpage_interrupciones.d_datos_interrup.AcceptText()
	
ELSE 
	DO
		// Si la red es monof$$HEX1$$e100$$ENDHEX$$sica se busca si existe alguna fase interrumpida cuya fecha de 
		// alta sea inferior a la nueva fecha de detecci$$HEX1$$f300$$ENDHEX$$n. En caso de encontrar alguna, 
		// se le cambia la fecha de alta
		lb_hay_cambio = FALSE
		ll_fila = tabpage_interrupciones.d_datos_interrup.find("( f_alta_fase_a < datetime('" + String(pdt_fec_nueva) + "') and isnull(f_reposicion_fase_a)) OR " +&
												"( f_alta_fase_b < datetime('" + String(pdt_fec_nueva) + "') and isnull(f_reposicion_fase_b)) OR " +&
												"( f_alta_fase_c < datetime('" + String(pdt_fec_nueva) + "') and isnull(f_reposicion_fase_c)) ",  ll_fila + 1, tabpage_interrupciones.d_datos_interrup.RowCount() )
		IF ll_fila > 0 THEN
			ldt_fecha_alta = tabpage_interrupciones.d_datos_interrup.GetItemDatetime(ll_fila, 'f_alta_fase_a') 
			IF NOT IsNull(ldt_fecha_alta) AND ldt_fecha_alta < pdt_fec_nueva THEN
				// Se cambia la fecha de alta de la interrupci$$HEX1$$f300$$ENDHEX$$n en la fase A por la fecha de detecci$$HEX1$$f300$$ENDHEX$$n
				tabpage_interrupciones.d_datos_interrup.setItem(ll_fila, 'f_alta_fase_a', pdt_fec_nueva)
				lb_hay_cambio = TRUE
			END IF
			
			ldt_fecha_alta = tabpage_interrupciones.d_datos_interrup.GetItemDatetime(ll_fila, 'f_alta_fase_b') 
			IF NOT IsNull(ldt_fecha_alta) AND ldt_fecha_alta < pdt_fec_nueva THEN
				// Se cambia la fecha de alta de la interrupci$$HEX1$$f300$$ENDHEX$$n en la fase B por la fecha de detecci$$HEX1$$f300$$ENDHEX$$n
				tabpage_interrupciones.d_datos_interrup.setItem(ll_fila, 'f_alta_fase_b', pdt_fec_nueva)
				lb_hay_cambio = TRUE
			END IF
			
			ldt_fecha_alta = tabpage_interrupciones.d_datos_interrup.GetItemDatetime(ll_fila, 'f_alta_fase_c') 
			IF NOT IsNull(ldt_fecha_alta) AND ldt_fecha_alta < pdt_fec_nueva THEN
				// Se cambia la fecha de alta de la interrupci$$HEX1$$f300$$ENDHEX$$n en la fase C por la fecha de detecci$$HEX1$$f300$$ENDHEX$$n
				tabpage_interrupciones.d_datos_interrup.setItem(ll_fila, 'f_alta_fase_c', pdt_fec_nueva)
				lb_hay_cambio = TRUE
			END IF
			
			IF lb_hay_cambio THEN
				// Como consecuencia de los cambio en alguna de las fechas de alta, hay que 
				// comprobar si con ello ha cambiado la fecha de alta general de la interrupci$$HEX1$$f300$$ENDHEX$$n
				tabpage_interrupciones.d_datos_interrup.AcceptText()
				of_calcular_min_fecha_alta(ll_fila)
			END IF
		END IF
	LOOP UNTIL (ll_fila <= 0  OR ll_fila = tabpage_interrupciones.d_datos_interrup.RowCount())
END IF

return
end subroutine

public subroutine fnu_otras_maniobras ();////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//
// Funci$$HEX1$$f300$$ENDHEX$$n/Evento: fnu_otras_maniobras
//
// Objetivo: Busca maniobras asociadas de otras incidencias y habilita el bot$$HEX1$$f300$$ENDHEX$$n correspondiente.
//         
// Ambito:  P$$HEX1$$fa00$$ENDHEX$$blico
//
// Par$$HEX1$$e100$$ENDHEX$$metros:
//
//        Entrada: --
//        Salida:	 --
//
// Devuelve: --
//
// Fecha            Responsable             Actuaci$$HEX1$$f300$$ENDHEX$$n
// --------         	  -----------             			---------
// 10/01/2002	    FDO					Creaci$$HEX1$$f300$$ENDHEX$$n
//		
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////// 

Long ll_contador

SELECT COUNT(*)
into :ll_contador
FROM SGD_INTERRUPCION
WHERE ((trunc(NVL((MANIOBRA_CIERRE_FASE_A / 1000),:il_nro_incidencia),0) <> :il_nro_incidencia) OR
			(trunc(NVL((MANIOBRA_CIERRE_FASE_B / 1000),:il_nro_incidencia),0) <> :il_nro_incidencia) OR
			(trunc(NVL((MANIOBRA_CIERRE_FASE_C / 1000),:il_nro_incidencia),0) <> :il_nro_incidencia) OR
			(trunc(NVL((MANIOBRA_CIERRE / 1000),:il_nro_incidencia),0) <> :il_nro_incidencia)) AND
			NRO_INCIDENCIA = :il_nro_incidencia ;

IF ll_contador > 0 then
	// existen mas maniobras,habilitamos el bot$$HEX1$$f300$$ENDHEX$$n.
	tabpage_maniobras.cb_otras_man.visible=true
ELSE
	tabpage_maniobras.cb_otras_man.visible=false
END IF

end subroutine

public function integer fnu_anadir_eb (datetime pdt_f_eb);////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//
// Funci$$HEX1$$f300$$ENDHEX$$n/Evento: fnu_anadir_eb
//
// Objetivo: A$$HEX1$$f100$$ENDHEX$$adir el estado Eb cuando la incidencia lo requiere
//         
// Ambito:  P$$HEX1$$fa00$$ENDHEX$$blico
//
// Par$$HEX1$$e100$$ENDHEX$$metros:
//
//        Entrada: pdt_f_eb Fecha de EB
//        Salida:
//
// Devuelve: 
//
// Fecha            Responsable             Actuaci$$HEX1$$f300$$ENDHEX$$n
// --------         -----------             ---------
// 09/02/2000	    FDO
//		
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////// 

long li_fila,a

idt_fecha_eb = pdt_f_eb

tabpage_seguimiento.d_estados_operaciones.SetFilter("")
tabpage_seguimiento.d_estados_operaciones.Filter()
tabpage_seguimiento.d_estados_operaciones.setsort("cod_estado A")
tabpage_seguimiento.d_estados_operaciones.sort()


if ii_incidencia_en_reposicion > 0 then
	li_fila = tabpage_seguimiento.d_seguimiento_operaciones.InsertRow(ii_incidencia_en_reposicion)
else
	li_fila =  tabpage_seguimiento.d_seguimiento_operaciones.InsertRow(ii_incidencia_servicio_repuesto)
end if

tabpage_seguimiento.d_seguimiento_operaciones.SetItem(li_fila,"nomenclatura",tabpage_seguimiento.d_estados_operaciones.GetItemString(fgci_incidencia_enviado_brigada,"nomenclatura"))
tabpage_seguimiento.d_seguimiento_operaciones.SetItem(li_fila,"usuario",gs_usuario)
tabpage_seguimiento.d_seguimiento_operaciones.SetItem(li_fila,"f_actual",fgnu_fecha_actual())
tabpage_seguimiento.d_seguimiento_operaciones.SetItem(li_fila,"h_actual",fgnu_fecha_actual())
tabpage_seguimiento.d_seguimiento_operaciones.SetItem(li_fila,"f_alta",idt_fecha_eb)
tabpage_seguimiento.d_seguimiento_operaciones.SetItem(li_fila,"h_alta",idt_fecha_eb)
tabpage_seguimiento.d_seguimiento_operaciones.SetItem(li_fila,"programa","iw_2301")
tabpage_seguimiento.d_seguimiento_operaciones.SetItem(li_fila,"est_oper",fgci_incidencia_enviado_brigada)
tabpage_seguimiento.d_seguimiento_operaciones.SetItem(li_fila,"nro_incidencia",il_nro_incidencia)
tabpage_seguimiento.d_seguimiento_operaciones.SetItem(li_fila,"ind_env_mant",0) //no enviado
ib_anadir_eb = true

of_iniciar_estados_oper()

For a= 1 to tabpage_seguimiento.d_seguimiento_operaciones.rowcount()
	tabpage_seguimiento.d_seguimiento_operaciones.object.f_alta[a] = tabpage_seguimiento.d_seguimiento_operaciones.object.f_alta[a]
Next

ii_avisar_oop_eb   = 1

return 1
end function

public function integer of_interrumpir_fase (boolean pb_fase_a, boolean pb_fase_b, boolean pb_fase_c, integer pi_cbx_pulsado, boolean pb_int_agrupadas, boolean pb_int_en_arbol);////////////////////////////////////////////////////////////////////////////////////////////////
//
// Funci$$HEX1$$f300$$ENDHEX$$n: of_interrumpir_fase
// 
// Objetivo: Funci$$HEX1$$f300$$ENDHEX$$n que interrumpe una fase de una instalaci$$HEX1$$f300$$ENDHEX$$n
//	 
// Ambito:	P$$HEX1$$fa00$$ENDHEX$$blico
//
// Par$$HEX1$$e100$$ENDHEX$$metros: 
//		Entrada:  pb_fase_a --> indica si est$$HEX2$$e1002000$$ENDHEX$$marcado o no cbx_fase_a
//					 pb_fase_b --> indica si est$$HEX2$$e1002000$$ENDHEX$$marcado o no cbx_fase_b
//					 pb_fase_c --> indica si est$$HEX2$$e1002000$$ENDHEX$$marcado o no cbx_fase_c
//					 pi_cbx_pulsado --> fase que se quiere interrumpir
//
//		Salida:   --
//						
// Devuelve:	0 -> si no se ha podido interrumpir la fase
//					1 -> Si todo ha ido bien
//				 
//
//  Fecha	  Responsable	Actuaci$$HEX1$$f300$$ENDHEX$$n
// ---------	-------		----------------------------------------
//	20/03/01		LFE			Creaci$$HEX1$$f300$$ENDHEX$$n
//
////////////////////////////////////////////////////////////////////////////////////////////////

long ll_fila=0, ll_codigo, ll_inst_hija
string ls_fase_afectada_num="", ls_fase_afectada= "", ls_fase_perm, ls_fase_abierta=""
string ls_campo_f_alta, ls_campo_f_rep, ls_tipo_area
DateTime ldt_f_primer_aviso, ldt_f_nula, ldt_fecha_sr
TreeviewItem le_elemento
int li_tipo_instalacion, li_contador, li_tabla_decision
Boolean lb_permitir_int = True, lb_eliminada = FALSE, lb_encontrado
Long ll_cant_cli_afec_c=0, ll_cant_cli_afec_r=0, ll_cant_cli_afec_u=0
Double ll_pot_afec_c=0, ll_pot_afec_r=0, ll_pot_afec_u=0, ll_pot_cont_afec=0, &
		 ll_pot_inst_afec=0

SetNull(ldt_f_primer_aviso)
SetNull(ldt_f_nula)

IF NOT pb_int_en_arbol THEN
	ll_codigo = tabpage_interrupciones.d_lista_otras_inst_ant.il_nro_instalacion
	
	IF pi_cbx_pulsado <> 1 AND tabpage_interrupciones.d_datos_interrup.find("nro_instalacion = " + string(ll_codigo) + &
				' and isnull(f_reposicion_fase_a) and not isnull(f_alta_fase_a)',&
				1,tabpage_interrupciones.d_datos_interrup.rowcount()) > 0 THEN
				
		pb_fase_a = TRUE
	END IF
	
	IF pi_cbx_pulsado <> 2 AND tabpage_interrupciones.d_datos_interrup.find("nro_instalacion = " + string(ll_codigo) + &
				' and isnull(f_reposicion_fase_b) and not isnull(f_alta_fase_b)',&
				1,tabpage_interrupciones.d_datos_interrup.rowcount()) > 0 THEN
				
		pb_fase_b = TRUE
	END IF
	
	IF pi_cbx_pulsado <> 3 AND tabpage_interrupciones.d_datos_interrup.find("nro_instalacion = " + string(ll_codigo) + &
				' and isnull(f_reposicion_fase_c) and not isnull(f_alta_fase_c)',&
				1,tabpage_interrupciones.d_datos_interrup.rowcount()) > 0 THEN
				
		pb_fase_c = TRUE
	END IF
END IF
		
IF il_handle_instalacion > 0  OR NOT pb_int_en_arbol THEN
	CHOOSE CASE pi_cbx_pulsado
		CASE 1
			ls_campo_f_alta = 'f_alta_fase_a' 
			ls_campo_f_rep = 'f_reposicion_fase_a'
		CASE 2
			ls_campo_f_alta = 'f_alta_fase_b'
			ls_campo_f_rep = 'f_reposicion_fase_b'
		CASE 3
			ls_campo_f_alta = 'f_alta_fase_c'
			ls_campo_f_rep = 'f_reposicion_fase_c'
	END CHOOSE
	
	IF pb_int_en_arbol THEN
		tabpage_interrupciones.tv_1.SelectItem(il_handle_instalacion)
		ll_codigo = tabpage_interrupciones.tv_1.of_ret_codigo(il_handle_instalacion)
	END IF
//	ll_fila = tabpage_interrupciones.d_datos_interrup.Getrow()
	ll_fila = tabpage_interrupciones.d_datos_interrup.find("nro_instalacion = " + string(ll_codigo) + &
									' and isnull(' + ls_campo_f_rep + ') and not isnull(' + ls_campo_f_alta + ')',&
									1,tabpage_interrupciones.d_datos_interrup.rowcount())
	IF ll_fila = 0 THEN
		//IF pb_int_en_arbol THEN
		//	ll_fila = tabpage_interrupciones.d_datos_interrup.Getrow()
		//ELSE
			ll_fila = tabpage_interrupciones.d_datos_interrup.find("nro_instalacion = " + string(ll_codigo) + &
									' and isnull(' + ls_campo_f_rep + ')' ,&
									1,tabpage_interrupciones.d_datos_interrup.rowcount())
		//END IF
	END IF
	
ELSE
	return 0
END IF

IF pb_fase_a = FALSE AND pb_fase_b = FALSE AND pb_fase_c = FALSE THEN
	messagebox("Atenci$$HEX1$$f300$$ENDHEX$$n", "No se puede dejar la instalaci$$HEX1$$f300$$ENDHEX$$n interrumpida sin fases afectadas. Pruebe a desmarcar la interrupci$$HEX1$$f300$$ENDHEX$$n")
	Return 0
END IF

IF ll_fila > 0 THEN
	pb_fase_a = pb_fase_a AND (pi_cbx_pulsado = 1 OR Mid(tabpage_interrupciones.d_datos_interrup.GetItemString(ll_fila, 'fase_afectada'), 1,1) = '1')
	pb_fase_b = pb_fase_b AND (pi_cbx_pulsado = 2 OR Mid(tabpage_interrupciones.d_datos_interrup.GetItemString(ll_fila, 'fase_afectada'), 2,1) = '1')
	pb_fase_c = pb_fase_c AND (pi_cbx_pulsado = 3 OR Mid(tabpage_interrupciones.d_datos_interrup.GetItemString(ll_fila, 'fase_afectada'), 3,1) = '1')
END IF

IF (NOT pb_fase_a AND pi_cbx_pulsado = 1 ) OR &
  	(NOT pb_fase_b AND pi_cbx_pulsado = 2 ) OR &
	(NOT pb_fase_c AND pi_cbx_pulsado = 3 ) THEN
		// Se ha desmarcado la interrupci$$HEX1$$f300$$ENDHEX$$n en alguna fase. En el caso de tener ya resuelta alguna
		// interrupci$$HEX1$$f300$$ENDHEX$$n en alguna fase de la instalaci$$HEX1$$f300$$ENDHEX$$n interrumpida no se deja desmarcar
	IF	tabpage_interrupciones.d_datos_interrup.Find("nro_instalacion = " + string(ll_codigo) + " and not isnull(f_reposicion_fase_a)", 1, tabpage_interrupciones.d_datos_interrup.RowCount()) > 0 & 
	   OR tabpage_interrupciones.d_datos_interrup.Find("nro_instalacion = " + string(ll_codigo) + " and not isnull(f_reposicion_fase_b)", 1, tabpage_interrupciones.d_datos_interrup.RowCount()) > 0 & 
		OR tabpage_interrupciones.d_datos_interrup.Find("nro_instalacion = " + string(ll_codigo) + " and not isnull(f_reposicion_fase_c)", 1, tabpage_interrupciones.d_datos_interrup.RowCount()) > 0 THEN
		
//	IF NOT IsNull (tabpage_interrupciones.d_datos_interrup.GetItemDatetime(ll_fila, 'f_reposicion_fase_a')) &
//		OR NOT IsNull (tabpage_interrupciones.d_datos_interrup.GetItemDatetime(ll_fila, 'f_reposicion_fase_b')) &
//		OR NOT IsNull (tabpage_interrupciones.d_datos_interrup.GetItemDatetime(ll_fila, 'f_reposicion_fase_c'))  THEN
//		
		// Existen interrupciones resueltas en la instalaci$$HEX1$$f300$$ENDHEX$$n interrumpida.
		// No se deja desmarcar la fase interrumpida
		messagebox("Atenci$$HEX1$$f300$$ENDHEX$$n", "No se puede desmarcar la interrupci$$HEX1$$f300$$ENDHEX$$n de la fase seleccionada debido a que se ya han resuelto interrupciones que afectan a alguna fase de la instalaci$$HEX1$$f300$$ENDHEX$$n")
		return 0
	END IF
ELSEIF pb_int_agrupadas = FALSE THEN // En el caso de las interrupciones agrupadas 
										       // esta comprobaci$$HEX1$$f300$$ENDHEX$$n ya est$$HEX2$$e1002000$$ENDHEX$$validada
	IF NOT isnull(tabpage_interrupciones.d_datos_interrup.GetItemDatetime(ll_fila,"f_reposicion")) THEN
		// Se comprueba el estado de la incidencia. En caso de estar en SR se trata de una 
		// reapertura.
		IF ii_estado_oper = fgci_incidencia_servicio_repuesto THEN
			IF of_comprobar_reapertura(tabpage_seguimiento.d_seguimiento_operaciones.GetItemDatetime(ii_incidencia_servicio_repuesto,'f_alta')) = FALSE THEN
				return 0
			END IF
		END IF
	END IF
END IF		

IF pb_int_agrupadas = FALSE THEN // En el caso de interrupciones agrupadas estas validaciones
											// ya est$$HEX1$$e100$$ENDHEX$$n hechas
	CHOOSE CASE pi_cbx_pulsado
		CASE 1
			
			IF pb_fase_a THEN
				IF fnu_valida_interrupcion_padre(il_handle_instalacion, gs_fase_a, pb_int_agrupadas) = -1 THEN
					messagebox("Atenci$$HEX1$$f300$$ENDHEX$$n", "No se puede marcar la interrupci$$HEX1$$f300$$ENDHEX$$n debido a que existe una interrupci$$HEX1$$f300$$ENDHEX$$n no resuelta en una instalaci$$HEX1$$f300$$ENDHEX$$n superior")
					return 0
				END IF
				IF fnu_valida_interrupcion(il_handle_instalacion, gs_fase_a, ls_fase_perm, TRUE) = -1 THEN
					return 0
				END IF
			END IF
		CASE 2
			IF pb_fase_b THEN
				IF fnu_valida_interrupcion_padre(il_handle_instalacion, gs_fase_b, pb_int_agrupadas) = -1 THEN
					messagebox("Atenci$$HEX1$$f300$$ENDHEX$$n", "No se puede marcar la interrupci$$HEX1$$f300$$ENDHEX$$n debido a que existe una interrupci$$HEX1$$f300$$ENDHEX$$n no resuelta en una instalaci$$HEX1$$f300$$ENDHEX$$n superior")
					return 0
				END IF
				IF fnu_valida_interrupcion(il_handle_instalacion, gs_fase_b, ls_fase_perm, TRUE) = -1 THEN
					return 0
				END IF
			END IF
		CASE 3
			IF pb_fase_c THEN
				IF fnu_valida_interrupcion_padre(il_handle_instalacion, gs_fase_c, pb_int_agrupadas) = -1 THEN
					messagebox("Atenci$$HEX1$$f300$$ENDHEX$$n", "No se puede marcar la interrupci$$HEX1$$f300$$ENDHEX$$n debido a que existe una interrupci$$HEX1$$f300$$ENDHEX$$n no resuelta en una instalaci$$HEX1$$f300$$ENDHEX$$n superior")
					return 0
				END IF
				IF fnu_valida_interrupcion(il_handle_instalacion, gs_fase_c, ls_fase_perm, TRUE) = -1 THEN
					return 0
				END IF
			END IF
	END CHOOSE
END IF

IF ll_fila > 0 THEN
	tabpage_interrupciones.d_lista_otras_inst.SetRedraw(False)
	
	IF pb_fase_a = TRUE THEN
		ls_fase_afectada_num = "1"
		ls_fase_afectada = gs_fase_a
		IF tabpage_interrupciones.cbx_fase_a.enabled THEN
			ls_fase_abierta = gs_fase_a
		END IF
		IF pi_cbx_pulsado = 1 THEN
			// Se obtiene la fecha de alta de la interrupci$$HEX1$$f300$$ENDHEX$$n en la fase A
			IF pb_int_agrupadas = FALSE THEN
				ldt_f_primer_aviso = fnu_o_primer_aviso(ll_codigo,"100",lb_encontrado)
				IF lb_encontrado THEN
					gu_comunic.is_comunic.datval1 = ldt_f_primer_aviso
					gu_comunic.is_comunic.strval1 = String(fgnu_fecha_actual())
					gu_comunic.is_comunic.intval1 = 1
					Messagebox("Atenci$$HEX1$$f300$$ENDHEX$$n", "La fecha definida para interrumpir es posterior a la fecha del " + &
								  "primer aviso encontrado para la instalaci$$HEX1$$f300$$ENDHEX$$n seleccionada. Debe confirmar dicha fecha.")
	
					Open(w_def_fecha_avisos)
					ldt_f_primer_aviso = gu_comunic.is_comunic.datval1
				END IF				
			ELSE
				ldt_f_primer_aviso = tabpage_interrupciones.tv_1.idt_f_alta_fase_a
			END IF
			if isnull(ldt_f_primer_aviso) then
				ldt_f_primer_aviso = fgnu_fecha_actual()
			end if
			tabpage_interrupciones.d_datos_interrup.SetItem(ll_fila, 'f_alta_fase_a', ldt_f_primer_aviso)
		END IF
	ELSE
		ls_fase_afectada_num = "0"
		IF pi_cbx_pulsado = 1	 THEN
			tabpage_interrupciones.d_datos_interrup.SetItem(ll_fila, 'f_alta_fase_a', ldt_f_nula)
		END IF
	END IF
	
	IF pb_fase_b = TRUE THEN
		ls_fase_afectada_num = ls_fase_afectada_num + "1"
		ls_fase_afectada = ls_fase_afectada + gs_fase_b
		IF tabpage_interrupciones.cbx_fase_b.enabled THEN
			ls_fase_abierta += gs_fase_b
		END IF

		IF pi_cbx_pulsado = 2 THEN
		// Se obtiene la fecha de alta de la interrupci$$HEX1$$f300$$ENDHEX$$n en la fase B
			IF pb_int_agrupadas = FALSE THEN
				ldt_f_primer_aviso = fnu_o_primer_aviso(ll_codigo,"010",lb_encontrado)
				IF lb_encontrado THEN
					gu_comunic.is_comunic.datval1 = ldt_f_primer_aviso
					gu_comunic.is_comunic.strval1 = String(fgnu_fecha_actual())
					gu_comunic.is_comunic.intval1 = 1
					Messagebox("Atenci$$HEX1$$f300$$ENDHEX$$n", "La fecha definida para interrumpir es posterior a la fecha del " + &
								  "primer aviso encontrado para la instalaci$$HEX1$$f300$$ENDHEX$$n seleccionada. Debe confirmar dicha fecha.")
	
					Open(w_def_fecha_avisos)
					ldt_f_primer_aviso = gu_comunic.is_comunic.datval1
				END IF
			ELSE
				ldt_f_primer_aviso = tabpage_interrupciones.tv_1.idt_f_alta_fase_b
			END IF
			if isnull(ldt_f_primer_aviso) then
				ldt_f_primer_aviso = fgnu_fecha_actual()
			end if
			tabpage_interrupciones.d_datos_interrup.SetItem(ll_fila, 'f_alta_fase_b', ldt_f_primer_aviso)
		END IF

	ELSE
		ls_fase_afectada_num = ls_fase_afectada_num + "0"
		IF pi_cbx_pulsado = 2	 THEN
			tabpage_interrupciones.d_datos_interrup.SetItem(ll_fila, 'f_alta_fase_b', ldt_f_nula)
		END IF
	END IF
	
	IF pb_fase_c = TRUE THEN
		ls_fase_afectada_num = ls_fase_afectada_num + "1"
		ls_fase_afectada = ls_fase_afectada + gs_fase_c
		IF tabpage_interrupciones.cbx_fase_c.enabled THEN
			ls_fase_abierta += gs_fase_c
		END IF

		IF pi_cbx_pulsado = 3 THEN
		// Se obtiene la fecha de alta de la interrupci$$HEX1$$f300$$ENDHEX$$n en la fase C
			IF pb_int_agrupadas = FALSE THEN
				ldt_f_primer_aviso = fnu_o_primer_aviso(ll_codigo,"001",lb_encontrado)
				IF lb_encontrado THEN
					gu_comunic.is_comunic.datval1 = ldt_f_primer_aviso
					gu_comunic.is_comunic.strval1 = String(fgnu_fecha_actual())
					gu_comunic.is_comunic.intval1 = 1
					Messagebox("Atenci$$HEX1$$f300$$ENDHEX$$n", "La fecha definida para interrumpir es posterior a la fecha del " + &
								  "primer aviso encontrado para la instalaci$$HEX1$$f300$$ENDHEX$$n seleccionada. Debe confirmar dicha fecha.")
	
					Open(w_def_fecha_avisos)
					ldt_f_primer_aviso = gu_comunic.is_comunic.datval1
				END IF
			ELSE
				ldt_f_primer_aviso = tabpage_interrupciones.tv_1.idt_f_alta_fase_c
			END IF
			if isnull(ldt_f_primer_aviso) then
				ldt_f_primer_aviso = fgnu_fecha_actual()
			end if
			tabpage_interrupciones.d_datos_interrup.SetItem(ll_fila, 'f_alta_fase_c', ldt_f_primer_aviso)

		END IF

	ELSE
		ls_fase_afectada_num = ls_fase_afectada_num + "0"
		IF pi_cbx_pulsado = 3	 THEN
			tabpage_interrupciones.d_datos_interrup.SetItem(ll_fila, 'f_alta_fase_c', ldt_f_nula)
		END IF
	END IF
	
	IF tabpage_interrupciones.d_datos_interrup.find("nro_instalacion = " + string(ll_codigo) + &
						' and isnull(f_alta_fase_a) and isnull(f_alta_fase_b) and isnull(f_alta_fase_c)', &
						1, tabpage_interrupciones.d_datos_interrup.RowCount()) = ll_fila THEN
		// No quedan interrupciones. Se borra la fila de la datawindow. Es un caso particular
		// que se da solo en la agrupaci$$HEX1$$f300$$ENDHEX$$n de incidencias
		//tabpage_interrupciones.tv_1.of_marca_interrupcion(tabpage_interrupciones.d_datos_interrup,il_handle_instalacion,0)
		tabpage_interrupciones.d_datos_interrup.DeleteRow(ll_fila)
		lb_eliminada = TRUE
		f_actualizar_estado()
		IF pb_int_en_arbol THEN
			tabpage_interrupciones.tv_1.Event Selectionchanged(il_handle_instalacion,il_handle_instalacion)

			tabpage_interrupciones.d_datos_interrup.VScrollBar = TRUE
			tabpage_interrupciones.d_datos_interrup.VScrollBar = FALSE
			tabpage_interrupciones.d_lista_otras_inst.SetRedraw(True)
		END IF
		return 1
	ELSE

		tabpage_interrupciones.d_datos_interrup.SetItem(ll_fila, 'fase_afectada', ls_fase_afectada_num)
		tabpage_interrupciones.d_datos_interrup.SetItem(ll_fila, 'sgd_valor_descripcion', ls_fase_afectada)
	END IF
	// Se calculan de nuevo los clientes afectados y la potencia contratada afectada,
	// ya que se han modificado las fases afectadas de la interrupci$$HEX1$$f300$$ENDHEX$$n
	li_tipo_instalacion = tabpage_interrupciones.d_datos_interrup.GetItemNumber(ll_fila, 'tipo_instalacion')
	
	IF gb_tabla_decision THEN
		li_tabla_decision = 1
	ELSE
		li_tabla_decision = 0
	END IF
	

  tabpage_interrupciones.tv_1.of_cursor_clientes(1,ll_cant_cli_afec_c,ll_cant_cli_afec_r,ll_cant_cli_afec_u,ll_pot_cont_afec, string(ll_codigo),ls_fase_afectada_num,string(li_tipo_instalacion),string(li_tabla_decision))


	IF li_tipo_instalacion < fgci_tipo_ct THEN
		SELECT NVL(SUM(DECODE(TIPO_AREA, 'C', POT_INSTALADA, 0)),0),
				 NVL(SUM(DECODE(TIPO_AREA, 'R', POT_INSTALADA, 0)),0),
				 NVL(SUM(DECODE(TIPO_AREA, 'U', POT_INSTALADA, 0)),0)
		INTO :ll_pot_afec_c, :ll_pot_afec_r, :ll_pot_afec_u
		FROM SGD_INSTALACION
		WHERE TIPO_INSTALACION = :fgci_tipo_ct AND BDI_JOB = 0 
				AND FGNU_FASE_AFECTADA(NVL(TIPO_CONEXION,0), :ls_fase_afectada_num) = 1
		START WITH NRO_INSTALACION = :ll_codigo AND BDI_JOB = 0
		CONNECT BY PRIOR NRO_INSTALACION = NRO_INST_PADRE AND BDI_JOB = 0;
		
		IF SQLCA.SQLCode = 0 THEN
			ll_pot_inst_afec = ll_pot_afec_c+ll_pot_afec_r+ll_pot_afec_u
		END IF
	ELSE
		SELECT FGNU_TIPO_AREA(:ll_codigo)
		INTO :ls_tipo_area
		FROM DUAL;
		
		IF SQLCA.SQLCode = 0 THEN
			CHOOSE CASE ls_tipo_area
				CASE 'C'
					ll_pot_afec_c=tabpage_interrupciones.d_datos_interrup.GetItemNumber(ll_fila, 'pot_inst_afec')
				CASE 'R'
					ll_pot_afec_r=tabpage_interrupciones.d_datos_interrup.GetItemNumber(ll_fila, 'pot_inst_afec')
				CASE 'U'
					ll_pot_afec_u=tabpage_interrupciones.d_datos_interrup.GetItemNumber(ll_fila, 'pot_inst_afec')
			END CHOOSE
		END IF
		ll_pot_inst_afec = tabpage_interrupciones.d_datos_interrup.GetItemNumber(ll_fila, 'pot_inst_afec')
	END IF

	tabpage_interrupciones.d_datos_interrup.SetItem(ll_fila, 'pot_contr_afec', ll_pot_cont_afec)
	tabpage_interrupciones.d_datos_interrup.SetItem(ll_fila, 'pot_inst_afec_ciu', ll_pot_afec_c)
	tabpage_interrupciones.d_datos_interrup.SetItem(ll_fila, 'pot_inst_afec_rur', ll_pot_afec_r)
	tabpage_interrupciones.d_datos_interrup.SetItem(ll_fila, 'pot_inst_afec_urb', ll_pot_afec_u)
	tabpage_interrupciones.d_datos_interrup.SetItem(ll_fila, 'pot_inst_afec', ll_pot_inst_afec)
	IF NOT (fg_verifica_parametro('AFEC_PARCIAL_SUM') AND li_tipo_instalacion = fgci_tipo_salida_de_baja AND &
		tabpage_interrupciones.d_datos_interrup.GetItemNumber(ll_fila, 'afec_parcial') = 1) THEN

		tabpage_interrupciones.d_datos_interrup.SetItem(ll_fila, 'cant_cli_afec', ll_cant_cli_afec_c+ll_cant_cli_afec_r+ll_cant_cli_afec_u)
		tabpage_interrupciones.d_datos_interrup.SetItem(ll_fila, 'ccli_afec_ciu', ll_cant_cli_afec_c)
		tabpage_interrupciones.d_datos_interrup.SetItem(ll_fila, 'ccli_afec_rur', ll_cant_cli_afec_r)
		tabpage_interrupciones.d_datos_interrup.SetItem(ll_fila, 'ccli_afec_urb', ll_cant_cli_afec_u)
	END IF
	
	tabpage_interrupciones.d_datos_interrup.AcceptText()
	
	IF (NOT pb_fase_a AND pi_cbx_pulsado = 1 ) OR &
   	(NOT pb_fase_b AND pi_cbx_pulsado = 2 ) OR &
		(NOT pb_fase_c AND pi_cbx_pulsado = 3 ) THEN
		// Se ha desmarcado la interrupci$$HEX1$$f300$$ENDHEX$$n en alguna fase. Se comprueba si con ello quedan o no
		// interrupciones pendientes en la instalaci$$HEX1$$f300$$ENDHEX$$n
		f_actualizar_estado()
		of_validar_fecha_rep(ll_fila, tabpage_interrupciones.d_datos_interrup, true)
	ELSE

		// Se comprueba si se marca una interrupci$$HEX1$$f300$$ENDHEX$$n sobre una instalaci$$HEX1$$f300$$ENDHEX$$n con todas sus
		// interrupciones resueltas
		IF NOT isnull(tabpage_interrupciones.d_datos_interrup.GetItemDatetime(ll_fila,"f_reposicion")) THEN
			// Se comprueba el estado de la incidencia. En caso de estar en SR se trata de una 
			// reapertura.


			IF ii_estado_oper = fgci_incidencia_servicio_repuesto THEN
				lb_permitir_int = of_comprobar_reapertura(tabpage_seguimiento.d_seguimiento_operaciones.GetItemDatetime(ii_incidencia_servicio_repuesto,'f_alta')) 
			END IF
			IF lb_permitir_int THEN
				// Hay que asignar a la instalaci$$HEX1$$f300$$ENDHEX$$n el icono de instalaci$$HEX1$$f300$$ENDHEX$$n interrumpida
				tabpage_interrupciones.d_datos_interrup.SetItem(ll_fila, 'f_reposicion', ldt_f_nula)

				tabpage_interrupciones.d_datos_interrup.SetItem(ll_fila, 'ind_reapertura', 1)
				tabpage_interrupciones.d_datos_interrup.AcceptText()			
				IF pb_int_en_arbol THEN
					tabpage_interrupciones.tv_1.getitem(il_handle_instalacion, le_elemento)
					li_tipo_instalacion = tabpage_interrupciones.d_datos_interrup.GetItemNumber(ll_fila, 'tipo_instalacion')

					tabpage_interrupciones.tv_1.of_icono_rama(li_tipo_instalacion,ll_codigo,tabpage_interrupciones.d_datos_interrup,le_elemento,il_handle_instalacion)
					tabpage_interrupciones.tv_1.setitem(il_handle_instalacion,le_elemento)
				END IF
				CHOOSE CASE pi_cbx_pulsado 
					CASE 1
//						tabpage_interrupciones.d_datos_interrup.object.f_reposicion_fase_a.protect = 0
//						tabpage_interrupciones.d_datos_interrup.object.f_reposicion_fase_a.background.color = gs_blanco
//						tabpage_interrupciones.d_datos_interrup.object.f_alta_fase_a.protect = 0
//						tabpage_interrupciones.d_datos_interrup.object.f_alta_fase_a.background.color = gs_blanco
					CASE 2
//						tabpage_interrupciones.d_datos_interrup.object.f_reposicion_fase_b.protect = 0
//						tabpage_interrupciones.d_datos_interrup.object.f_reposicion_fase_b.background.color = gs_blanco
//						tabpage_interrupciones.d_datos_interrup.object.f_alta_fase_b.protect = 0
//						tabpage_interrupciones.d_datos_interrup.object.f_alta_fase_b.background.color = gs_blanco
					CASE 3
//						tabpage_interrupciones.d_datos_interrup.object.f_reposicion_fase_c.protect = 0
//						tabpage_interrupciones.d_datos_interrup.object.f_reposicion_fase_c.background.color = gs_blanco
//						tabpage_interrupciones.d_datos_interrup.object.f_alta_fase_c.protect = 0
//						tabpage_interrupciones.d_datos_interrup.object.f_alta_fase_c.background.color = gs_blanco
				END CHOOSE

				IF ii_estado_oper = fgci_incidencia_servicio_repuesto THEN 
					// La incidencia ha sido reabierta. Se cambia de estado
					IF ii_alcance = fgci_incidencia_con_interrupcion THEN
						ii_estado_oper = fgci_incidencia_en_reposicion
						IF tabpage_ot.d_datos_ot.GetItemNumber(1, 'est_ot') = fgci_ot_resuelta THEN 
							tabpage_ot.d_crit_seleccion.enabled=true
							tabpage_ot.d_crit_seleccion.object.pi_tipo_brig.background.color=gs_blanco
							tabpage_ot.d_crit_seleccion.object.pdt_fecha_turno.background.color=gs_blanco
							//tabpage_ot.d_crit_seleccion.object.pi_brigadas_en_turno.background.color=gs_blanco
							tabpage_ot.tab_lista_brigadas.tabpage_disponibles.dw_brigadas_disponibles.enabled=true
							tabpage_ot.tab_lista_brigadas.tabpage_no_disponibles.dw_brigadas_no_disponibles.enabled=true
							tabpage_ot.rb_1.enabled = true
							tabpage_ot.rb_2.enabled = true
							//tabpage_ot.d_datos_ot.enabled = false
							tabpage_ot.dw_ambito.fnu_habi_centro()
							tabpage_ot.dw_ambito.fnu_habi_cmd()
							tabpage_ot.dw_ambito.fnu_habi_puesto()
							tabpage_ot.d_datos_ot.SetItem(1, 'f_hasta', ldt_f_nula)
							tabpage_ot.d_datos_ot.SetItem(1, 'est_ot', fgci_ot_trabajando)
							tabpage_ot.d_datos_ot.AcceptText()
						END IF
					ELSE
					// Si la incidencia se encontraba en SR y es sin p$$HEX1$$e900$$ENDHEX$$rdida, pasa al estado EB
						ii_estado_oper = fgci_incidencia_enviado_brigada
					END IF

					f_actualizar_estado()
				END IF
			END IF
		END IF
	END IF
	
	IF lb_permitir_int THEN
		// Se comprueba si la nueva fecha de alta es menor que la que hab$$HEX1$$ed00$$ENDHEX$$a en la incidencia

		// En este caso se pone como fecha de alta la nueva fecha 
		of_calcular_min_fecha_alta(ll_fila)
			
		IF pb_int_en_arbol THEN
			tabpage_interrupciones.tv_1.Event Selectionchanged(il_handle_instalacion,il_handle_instalacion)
			tabpage_interrupciones.tv_1.of_marcar_fase_afectada(il_handle_instalacion, ls_fase_abierta)
			ll_inst_hija = tabpage_interrupciones.tv_1.FindItem(ChildTreeItem!, il_handle_instalacion)

			DO WHILE ll_inst_hija > 0
				tabpage_interrupciones.tv_1.of_interrumpir_hijos(ll_inst_hija,tabpage_interrupciones.d_datos_interrup)
				ll_inst_hija = tabpage_interrupciones.tv_1.FindItem(NextTreeItem!, ll_inst_hija)
			LOOP
		
			CHOOSE CASE tabpage_interrupciones.d_datos_interrup.GetItemNumber(ll_fila, 'fase_seleccionada')
				CASE 1
					ls_campo_f_alta = 'f_alta_fase_a'
					ls_campo_f_rep  = 'f_reposicion_fase_a'
				CASE 2
					ls_campo_f_alta = 'f_alta_fase_b'
					ls_campo_f_rep  = 'f_reposicion_fase_b'

				CASE 3
					ls_campo_f_alta = 'f_alta_fase_c'
					ls_campo_f_rep  = 'f_reposicion_fase_c'
			END CHOOSE
					
		END IF	
	ELSE
		tabpage_interrupciones.d_lista_otras_inst.SetRedraw(True)
		Return 0
	END IF

	tabpage_interrupciones.d_lista_otras_inst.SetRedraw(True)
END IF

setfocus(tabpage_interrupciones.tv_1)
return 1

end function

public function datetime fnu_o_primer_aviso (long pl_nro_instalacion, string ps_fase_interrumpida, ref boolean pb_encontrado);////////////////
//	Obtengo la fecha del primer aviso para la instalacion pasada como par$$HEX1$$e100$$ENDHEX$$metro
// La fecha del primer aviso es la menor de las fechas en gi_aviso_ins
//	y en gi_avisos
//
//	Responsable				Fecha				Actuaci$$HEX1$$f300$$ENDHEX$$n
//-------------       ---------     -------------------
//		FDO				31/01/2000		              Funci$$HEX1$$f300$$ENDHEX$$n nueva.
///////////////

datetime ldt_fecha_p_av
string ls_campo_f_alta
Integer li_tabla_decision

// Esta select va a traer la fecha del menor de los avisos para las instalaciones afectadas por la 
// Incidencia. Sustituye a las antiguas funciones recursivas y cursores- FDO



//*******************************************
//**  OSGI 2001.2  	08/08/2002				 **
//**  Jair Padilla / Soluziona PANAMA  	 **
//**  PM001 RESTRICCION N DIAS ANTIG$$HEX1$$dc00$$ENDHEX$$EDAD  **
//*******************************************
//**  PM001 RESTRICCION N DIAS ANTIG$$HEX1$$dc00$$ENDHEX$$EDAD  SELECT MIN(GI_AVISOS_INSTALACION.F_ALTA)
//**  PM001 RESTRICCION N DIAS ANTIG$$HEX1$$dc00$$ENDHEX$$EDAD  INTO :ldt_fecha_p_av
//**  PM001 RESTRICCION N DIAS ANTIG$$HEX1$$dc00$$ENDHEX$$EDAD  FROM  GI_AVISOS_INSTALACION 
//**  PM001 RESTRICCION N DIAS ANTIG$$HEX1$$dc00$$ENDHEX$$EDAD  WHERE GI_AVISOS_INSTALACION.EST_AVISO = 1 
//**  PM001 RESTRICCION N DIAS ANTIG$$HEX1$$dc00$$ENDHEX$$EDAD    AND GI_AVISOS_INSTALACION.CLASE_AVISO = 0
//**  PM001 RESTRICCION N DIAS ANTIG$$HEX1$$dc00$$ENDHEX$$EDAD    AND GI_AVISOS_INSTALACION.NRO_INSTALACION = :pl_nro_instalacion
//**  PM001 RESTRICCION N DIAS ANTIG$$HEX1$$dc00$$ENDHEX$$EDAD    		AND ((SUBSTR(:ps_fase_interrumpida,1,1) ='1' AND SUBSTR(NVL(GI_AVISOS_INSTALACION.FASE,'111'),1,1) = '1' )  OR 
//**  PM001 RESTRICCION N DIAS ANTIG$$HEX1$$dc00$$ENDHEX$$EDAD   	 		  (SUBSTR(:ps_fase_interrumpida,2,1) ='1' AND SUBSTR(NVL(GI_AVISOS_INSTALACION.FASE,'111'),2,1) = '1' ) OR 
//**  PM001 RESTRICCION N DIAS ANTIG$$HEX1$$dc00$$ENDHEX$$EDAD  	 		  (SUBSTR(:ps_fase_interrumpida,3,1) ='1' AND SUBSTR(NVL(GI_AVISOS_INSTALACION.FASE,'111'),3,1) = '1' ));

IF gb_tabla_decision THEN
	li_tabla_decision = 1
ELSE
	li_tabla_decision = 0
END IF

SELECT MIN(GI_AVISOS_INSTALACION.F_ALTA)
INTO :ldt_fecha_p_av
FROM  GI_AVISOS_INSTALACION, GI_CAMBIO_FORMATO_FASE
WHERE NVL(GI_AVISOS_INSTALACION.FASE,'111') = GI_CAMBIO_FORMATO_FASE.FASE_AFECTADA AND
		Fgnu_fase_afect_decision_aa(GI_AVISOS_INSTALACION.TIPO_CT, 
											 GI_CAMBIO_FORMATO_FASE.TIPO_CONEXION,
											 :ps_fase_interrumpida,
											 NVL(GI_AVISOS_INSTALACION.FASE,'111'),
											 GI_AVISOS_INSTALACION.TIPO_INSTALACION - 1, 
											 :li_tabla_decision) = 1 
  AND GI_AVISOS_INSTALACION.EST_AVISO = :fgci_aviso_pendiente 
  AND GI_AVISOS_INSTALACION.CLASE_AVISO = 0
  AND GI_AVISOS_INSTALACION.NRO_INSTALACION = :pl_nro_instalacion
  AND ( Trunc((sysdate-F_ALTA), 0) < :gi_dias_antiguedad Or :gi_dias_antiguedad = 0 ) ;  /*  PM001 RESTRICCION N DIAS ANTIG$$HEX1$$dc00$$ENDHEX$$EDAD  */
//*******************************************
//**  OSGI 2001.2  	08/08/2002				 **
//**  Jair Padilla / Soluziona PANAMA  	 **
//**  PM001 RESTRICCION N DIAS ANTIG$$HEX1$$dc00$$ENDHEX$$EDAD  **
//*******************************************

  //AND fgnu_comparar_fase(GI_AVISOS_INSTALACION.FASE, NVL(:ps_fase_interrumpida,'111')) = 1;
			

if sqlca.sqlcode = -1 then
	messagebox("Atenci$$HEX1$$f300$$ENDHEX$$n","Error buscando primer aviso: " + sqlca.sqlerrtext , Exclamation!, ok!)	
	return fgnu_fecha_actual()
end if

IF NOT ISNULL(ldt_fecha_p_av) THEN
	CHOOSE CASE ps_fase_interrumpida
		CASE '100'
			ls_campo_f_alta = 'f_alta_fase_a'
		CASE '010'
			ls_campo_f_alta = 'f_alta_fase_b'
		CASE '001'
			ls_campo_f_alta = 'f_alta_fase_c'
		CASE '111'
			ls_campo_f_alta = 'f_alta'
		CASE ELSE
			ls_campo_f_alta = 'f_alta'
	END CHOOSE
	
	// Se comprueba si la instalaci$$HEX1$$f300$$ENDHEX$$n tiene una interrupci$$HEX1$$f300$$ENDHEX$$n anterior dada de alta para esa
	// fecha. En este caso se debe coger como fecha de alta la fecha actual
	IF tabpage_interrupciones.d_datos_interrup.Find("nro_instalacion = " + string(pl_nro_instalacion) &
			+ " and " + ls_campo_f_alta + "=datetime('" + string(ldt_fecha_p_av) + "')", 0, tabpage_interrupciones.d_datos_interrup.RowCount()) > 0 THEN
		
		pb_encontrado = FALSE
		return fgnu_fecha_actual()
	ELSE
		pb_encontrado = TRUE
		return ldt_fecha_p_av
	END IF
	
ELSE
	pb_encontrado = FALSE
	return fgnu_fecha_actual()
	
END IF

end function

public function integer of_bloquea_interrupciones ();Long ll_nro_instalacion
int li_lock_status = 0

DECLARE lc_inst_padres CURSOR FOR
	SELECT DISTINCT(DECODE(SGD_INSTALACION.NRO_INST_PADRE, :fgcdec_aviso_con_alimentacion, SGD_INSTALACION.NRO_INSTALACION, 
																								  SGD_INSTALACION.NRO_INST_PADRE))
	FROM SGD_INTERRUPCION, SGD_INSTALACION
	WHERE SGD_INTERRUPCION.NRO_INCIDENCIA = :il_nro_incidencia AND

			SGD_INTERRUPCION.F_REPOSICION IS NULL AND
			SGD_INTERRUPCION.NRO_INSTALACION = SGD_INSTALACION.NRO_INSTALACION AND
			SGD_INSTALACION.BDI_JOB = 0;
			
OPEN lc_inst_padres;

IF SQLCA.SQLCode = 0 THEN
	FETCH lc_inst_padres INTO :ll_nro_instalacion;
	

	DO WHILE SQLCA.SQLCode = 0 AND li_lock_status = 0
		li_lock_status = gnu_u_transaction.uf_lock(true,iw_contenedora.st_bloqueo,'sgd_instalacion','nro_instalacion = ' + string(ll_nro_instalacion))
		
		FETCH lc_inst_padres INTO :ll_nro_instalacion;
	LOOP
	
	CLOSE lc_inst_padres;
	
	IF li_lock_status <> 0 OR SQLCA.SQLCode < 0 THEN
		return -1
	ELSE
		return 1
	END IF
ELSE
	return -1
END IF
end function

public function integer fnu_valida_interrupcion_padre (long pl_handle, string ps_fase_afectada, boolean pb_int_agrupadas);////////////////////////////////////////////////////////////
////

//// Funci$$HEX1$$f300$$ENDHEX$$n/Evento: fnu_valida_interrupcion
////
//// Objetivo: Validar si es posible dar de alta una interrupcion en una instalacion
////         
//// Ambito:  P$$HEX1$$fa00$$ENDHEX$$blico
////
//// Par$$HEX1$$e100$$ENDHEX$$metros:
////
////        Entrada: 
////        Salida: 
////
//// Devuelve: 1 si esta permitido
////	            -1 si no est$$HEX2$$e1002000$$ENDHEX$$permitido
////
//// Fecha            Responsable             Actuaci$$HEX1$$f300$$ENDHEX$$n
//// --------             -----------             ---------
//// 01/09/2000	  FDO
////					  LFE
///////////////////////////////////////////////////////////// 

int li_handle_padre, li_fila, li_ret = 0, li_tipo_ct, li_tipo_conexion, li_tipo_instalacion
treeviewItem le_elemento
datetime ldt_f_res_fase
String ls_fase_afect, ls_fase_int, ls_fases_extras, ls_fase_instalacion

IF gb_red_trifasica = FALSE AND pb_int_agrupadas = FALSE THEN
	li_tipo_ct=tabpage_interrupciones.tv_1.of_ret_tipo_ct(pl_handle)
	li_tipo_conexion=tabpage_interrupciones.tv_1.of_ret_tipo_conexion(pl_handle)
	li_tipo_instalacion=tabpage_interrupciones.tv_1.of_ret_tipo(pl_handle)
	ls_fase_instalacion=tabpage_interrupciones.tv_1.of_ret_fase(pl_handle)
	
	li_handle_padre = pl_handle
	DO 
		li_handle_padre = tabpage_interrupciones.tv_1.FINDITEM(ParentTreeItem!,li_handle_padre)

		IF li_handle_padre > -1 THEN
			
			tabpage_interrupciones.tv_1.GETITEM(li_handle_padre,le_elemento)
			IF le_elemento.bold = TRUE AND le_elemento.StatePictureIndex = 2 THEN//Left(le_elemento.label, 2) = 'X ' THEN
				//lstr_datos_rama = le_elemento.data
				li_fila = tabpage_interrupciones.d_datos_interrup.find&
						("nro_instalacion = " + string(tabpage_interrupciones.tv_1.of_ret_codigo(li_handle_padre)) + ' and IsNull(f_reposicion) ' &
						, 1, tabpage_interrupciones.d_datos_interrup.rowcount())
				
				//IF isnull(tabpage_interrupciones.d_datos_interrup.GetItemDatetime(li_fila, 'f_reposicion')) THEN
				IF li_fila > 0 THEN
					ls_fase_afect=""


					// Existe un padre con interrupcion

					li_fila = tabpage_interrupciones.d_datos_interrup.find&
								("nro_instalacion = " + string(tabpage_interrupciones.tv_1.of_ret_codigo(li_handle_padre)) + ' and IsNull(f_reposicion_fase_a) and not isnull(f_alta_fase_a)' &
								 , 1, tabpage_interrupciones.d_datos_interrup.rowcount())
						
					IF li_fila > 0 THEN 
						ls_fase_afect+='1'
					ELSE
						ls_fase_afect+='0'
					END IF		

					li_fila = tabpage_interrupciones.d_datos_interrup.find&
								("nro_instalacion = " + string(tabpage_interrupciones.tv_1.of_ret_codigo(li_handle_padre)) + ' and IsNull(f_reposicion_fase_b) and not isnull(f_alta_fase_b)' &
								 , 1, tabpage_interrupciones.d_datos_interrup.rowcount())
			
					IF li_fila > 0 THEN 
						ls_fase_afect+='1'
					ELSE
						ls_fase_afect+='0'
					END IF		
					
					li_fila = tabpage_interrupciones.d_datos_interrup.find&
								("nro_instalacion = " + string(tabpage_interrupciones.tv_1.of_ret_codigo(li_handle_padre)) + ' and IsNull(f_reposicion_fase_c) and not isnull(f_alta_fase_c)' &
								 , 1, tabpage_interrupciones.d_datos_interrup.rowcount())
					IF li_fila > 0 THEN 
						ls_fase_afect+='1'
					ELSE
						ls_fase_afect+='0'
					END IF					
					
					IF li_tipo_instalacion > fgci_tipo_ct AND tabpage_interrupciones.tv_1.of_ret_tipo(li_handle_padre) <= fgci_tipo_ct THEN
						ls_fases_extras = tabpage_interrupciones.tv_1.of_det_perdida_ct(tabpage_interrupciones.tv_1.of_ret_codigo(pl_handle),ls_fase_afect, li_tipo_conexion, li_tipo_ct)
					ELSE
						ls_fases_extras = ls_fase_afect
					END IF
					
					ls_fase_int = ""
					
					IF Mid(ls_fases_extras,1,1) = '1' THEN
						ls_fase_int = gs_fase_a
					END IF
					IF Mid(ls_fases_extras,2,1) = '1' THEN
						ls_fase_int += gs_fase_b
					END IF
					IF Mid(ls_fases_extras,3,1) = '1' THEN
						ls_fase_int += gs_fase_c
					END IF

					IF Match(tabpage_interrupciones.tv_1.of_ret_fase(pl_handle), ps_fase_afectada) AND &
						NOT Match(ls_fase_int, ps_fase_afectada) THEN
						//ls_fase_int <> ls_fase_instalacion THEN
					
//					IF (NOT MATCH(tabpage_interrupciones.tv_1.of_ret_fase_afectada(li_handle_padre),ps_fase_afectada) OR li_fila < 0) AND &
//						MATCH(tabpage_interrupciones.tv_1.of_ret_fase(pl_handle), ps_fase_afectada) THEN
//						
						li_ret =  1
					ELSE
						li_ret = -1
					END IF
	
				END IF
			END IF
		END IF
	LOOP WHILE li_handle_padre > 0 AND li_ret = 0
ELSE
	li_ret = 1
END IF

IF li_ret = 0 THEN li_ret = 1

return li_ret

end function

public function integer fw_act_otras_inc (ref long pl_incidencias []);//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//
// Funci$$HEX1$$f300$$ENDHEX$$n/Evento: fw_act_otras_inc
//
// Objetivo: Actualiza datos de otras inc. como avisos asociados y el estado de la incidencia siempre que se 
//			   hayan resuelto datos de las mismas
//         
// Ambito:  P$$HEX1$$fa00$$ENDHEX$$blico
//
// Par$$HEX1$$e100$$ENDHEX$$metros:
//
//        Entrada: 
//        Salida:
//
// Devuelve: 1 si todo fue bien
//
// Fecha            Responsable             Actuaci$$HEX1$$f300$$ENDHEX$$n
// --------         -----------             ---------
// 07/09/2000	    FDO
//		
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

long ll_contador,ll_nro_inc,ll_nro_inst,ll_cantidad=0
Datetime ldt_f_desde,ldt_f_hasta,f_actual
integer li_est_anterior,li_estado_nuevo, li_pos = 1
string ls_texto
Boolean lb_incidencia_modif

f_actual=fgnu_fecha_actual()

// Realizo el update de la datawindow
// Hay que hacer update de los datos de la estructura en 

//fw_actualizo_otras_int()
ll_contador = tabpage_interrupciones.d_datos_interrup.Find("tip_interrupcion = 'O' and nro_incidencia <> " + string(il_nro_incidencia), 1,tabpage_interrupciones.d_datos_interrup.RowCount())

DO WHILE ll_contador > 0 AND ll_contador <= tabpage_interrupciones.d_datos_interrup.RowCount()
	// Se han resuelto interrupciones de esta incidencia 
	IF gb_red_trifasica THEN
		ldt_f_hasta = tabpage_interrupciones.d_datos_interrup.GetItemdatetime(ll_contador, 'f_reposicion')
	ELSE
		ldt_f_hasta = of_obtener_max_fecha_rep(tabpage_interrupciones.d_datos_interrup.GetItemdatetime(ll_contador, 'f_reposicion_fase_a'),&
														tabpage_interrupciones.d_datos_interrup.GetItemdatetime(ll_contador, 'f_reposicion_fase_b'),&
														tabpage_interrupciones.d_datos_interrup.GetItemdatetime(ll_contador, 'f_reposicion_fase_c'))	
	END IF	
	
	lb_incidencia_modif = False
	
	ll_nro_inc = tabpage_interrupciones.d_datos_interrup.GetItemNumber(ll_contador, 'nro_incidencia')
	ll_nro_inst = tabpage_interrupciones.d_datos_interrup.GetItemNumber(ll_contador, 'nro_instalacion')

	select est_actual
	into :li_est_anterior
	from sgd_incidencia
	where nro_incidencia=:ll_nro_inc;

	IF SQLCA.SQLCode <> 0 THEN
		messagebox("Error", "No se han podido actualizar los datos de las interrupciones de la incidencia asociada n$$HEX1$$fa00$$ENDHEX$$mero " + string(ll_nro_inc))
		return 0
	END IF
	
	ls_texto = 'Estado actualizado desde Incidencia ' + string(il_nro_incidencia)

	If not isnull(ldt_f_hasta) then
		ldt_f_desde=tabpage_interrupciones.d_datos_interrup.GetItemdatetime(ll_contador, 'f_alta')
		
		Select count(*)
		into :ll_cantidad
		from sgd_interrupcion 
		where nro_incidencia=:ll_nro_inc and f_reposicion is null;
	
		IF SQLCA.SQLCode <> 0 THEN
			messagebox("Error", "No se han podido actualizar los datos de las interrupciones de la incidencia asociada n$$HEX1$$fa00$$ENDHEX$$mero " + string(ll_nro_inc))
			return 0
		END IF

		if ll_cantidad=0 then
			// El estado de la incidencia va a pasar a SR. 
			li_estado_nuevo=fgci_incidencia_servicio_repuesto
			lb_incidencia_modif = TRUE
			
			Update sgd_incidencia
			set est_actual = :li_estado_nuevo,
				 COD_CAUSA = DECODE(NVL(COD_CAUSA,0), 0, :fgci_cod_causa_desconocida, COD_CAUSA),
				 FAM_CAUSA = DECODE(NVL(FAM_CAUSA,0), 0, :fgci_cod_fam_causa_desconocida, FAM_CAUSA),
				 FEC_CAUSA = DECODE(NVL(COD_CAUSA,0), 0, :ldt_f_hasta, FEC_CAUSA)
			where nro_incidencia=:ll_nro_inc;
			
			
			IF SQLCA.SQLCode <> 0 THEN
				messagebox("Error", "No se ha podido actualizar el estado de la incidencia asociada n$$HEX1$$fa00$$ENDHEX$$mero " + string(ll_nro_inc))
				return 0
			END IF

			// Actualizamos estado oper para ello tenemos que comprobar en que estado estaba la incidencia

			if li_est_anterior = fgci_incidencia_enviado_brigada then
				// Tendremos que insertar el estado ER
			
			  INSERT INTO "SGD_ESTADO_OPER"  
							( "COD_ESTADO",   
							  "USUARIO",   
							  "F_ACTUAL",   
							  "H_ACTUAL",   
							  "PROGRAMA",   
							  "OBSERVACION",   
							  "F_ALTA",   
							  "H_ALTA",   
							  "NRO_INCIDENCIA",   
							  "IND_ENV_MANT" )  
				  VALUES ( :fgci_incidencia_en_reposicion,   
							  :gs_usuario,   
							  :f_actual,   
							  :f_actual,   
								 'w_2301',   
								:ls_texto,   
								 :ldt_f_hasta,   
								 :ldt_f_hasta,   
								 :ll_nro_inc,   
								 0 )  ;
			
				IF SQLCA.SQLCode <> 0 THEN
					messagebox("Error", "No se ha podido actualizar el estado de la incidencia asociada n$$HEX1$$fa00$$ENDHEX$$mero " + string(ll_nro_inc))
					return 0
				END IF
		
			end if
			// Y tambien el estado SR
			IF li_est_anterior < fgci_incidencia_servicio_repuesto THEN
				INSERT INTO "SGD_ESTADO_OPER"  
							( "COD_ESTADO",   
							  "USUARIO",   
							  "F_ACTUAL",   
							  "H_ACTUAL",   
							  "PROGRAMA",   
							  "OBSERVACION",   
							  "F_ALTA",   
							  "H_ALTA",   
							  "NRO_INCIDENCIA",   
							  "IND_ENV_MANT" )  
				  VALUES ( :fgci_incidencia_servicio_repuesto,   
								 :gs_usuario,   
								 :f_actual,   
								 :f_actual,   
								 'w_2301',   
								:ls_texto,   
								 :ldt_f_hasta,   
								 :ldt_f_hasta,   
								 :ll_nro_inc,   
								 0 )  ;
							 

				IF SQLCA.SQLCode <> 0 THEN
					messagebox("Error", "No se ha podido actualizar el estado de la incidencia asociada n$$HEX1$$fa00$$ENDHEX$$mero " + string(ll_nro_inc))
					return 0
				END IF
			
				li_est_anterior = li_estado_nuevo
			END IF
		ELSE
			IF li_est_anterior=fgci_incidencia_enviado_brigada THEN
				// El estado de la incidencia va a pasar a ER.
				lb_incidencia_modif = TRUE
				li_estado_nuevo=fgci_incidencia_en_reposicion
			
				Update sgd_incidencia
				set est_actual = :li_estado_nuevo
				where nro_incidencia=:ll_nro_inc;
				
				IF SQLCA.SQLCode <> 0 THEN
					messagebox("Error", "No se ha podido actualizar el estado de la incidencia asociada n$$HEX1$$fa00$$ENDHEX$$mero " + string(ll_nro_inc))
					return 0
				END IF
				
				INSERT INTO "SGD_ESTADO_OPER"  
						( "COD_ESTADO",   
						  "USUARIO",   
						  "F_ACTUAL",   
						  "H_ACTUAL",   
						  "PROGRAMA",   
						  "OBSERVACION",   
						  "F_ALTA",   
						  "H_ALTA",   
						  "NRO_INCIDENCIA",   
						  "IND_ENV_MANT" )  
				VALUES (  :li_estado_nuevo,   
							 :gs_usuario,   
							 :f_actual,   
							 :f_actual,   
							 'w_2301',   
							 :ls_texto,   
							 :ldt_f_hasta,   
							 :ldt_f_hasta,   
							 :ll_nro_inc,   
							 0 )  ;
							 
				IF SQLCA.SQLCode <> 0 THEN
					messagebox("Error", "No se ha podido actualizar el estado de la incidencia asociada n$$HEX1$$fa00$$ENDHEX$$mero " + string(ll_nro_inc))
					return 0
				END IF
			
			end if
		END IF
	END IF
	
	IF lb_incidencia_modif AND isvalid(gu_operaciones) THEN
		pl_incidencias[li_pos] = ll_nro_inc
		li_pos ++ 
	END IF
	
	ll_contador ++
	IF ll_contador < tabpage_interrupciones.d_datos_interrup.RowCount() THEN
		ll_contador = tabpage_interrupciones.d_datos_interrup.Find("tip_interrupcion = 'O'", ll_contador, tabpage_interrupciones.d_datos_interrup.RowCount())
	END IF
LOOP

return 1
end function

public subroutine of_pot_interrump_col (datawindow adw_dw);//***************************************
//**  OSGI 2001.1  	19/11/2002			**
//**  Jair Padilla / Soluziona PANAMA  **
//***************************************
Long ll_row_ind_ob


If fg_verifica_parametro("POT_INTERRUMPIDA") Then
	adw_dw.Modify("c_ind_pot_int.Expression = '1'")

	ll_row_ind_ob = tabpage_formulario.d_inf_general.GetRow()

	If ll_row_ind_ob > 0 Then
		If ii_estado_oper >= fgci_incidencia_servicio_repuesto Or &
			tabpage_formulario.d_inf_general.GetItemNumber(ll_row_ind_ob, "estado_actual") >= fgci_incidencia_servicio_repuesto	Then
			adw_dw.Modify("pot_interrumpida.Protect='1'")
			adw_dw.Modify("pot_interrumpida.BackGround.Color="+gs_gris)
		Else
//			adw_dw.Modify("pot_interrumpida.Protect='0'")
//			adw_dw.Modify("pot_interrumpida.BackGround.Color="+gs_blanco)
		End If
	End If
Else
	adw_dw.Modify("c_ind_pot_int.Expression = '0'")
End If
//***************************************
//**  OSGI 2001.1  	19/11/2002			**
//**  Jair Padilla / Soluziona PANAMA  **
//***************************************
end subroutine

public subroutine of_suministros_int (ref datawindow adw_dw, long al_row, long pl_codigo);string ls_tipo_area
long ll_clientes_originales_c, ll_clientes_originales_r, ll_clientes_originales_u

gu_comunic.is_comunic.longval1 = adw_dw.GetItemNumber(al_row, 'nro_instalacion')
gu_comunic.is_comunic.longval2 = adw_dw.GetItemNumber(al_row, 'nro_incidencia')
gu_comunic.is_comunic.datval1 = adw_dw.GetItemdatetime(al_row, 'f_alta')
IF is_accion_llamada <> 'Consulta' THEN
	IF ii_estado_oper = fgci_incidencia_resuelta THEN
		gu_comunic.is_comunic.strval1 = 'Consulta'
	ELSE
		gu_comunic.is_comunic.strval1 = is_accion_llamada
	END IF
ELSE
	gu_comunic.is_comunic.strval1 = is_accion_llamada
END IF

tabpage_interrupciones.dw_afec_parcial_sum.setfilter("nro_instalacion=" + string(gu_comunic.is_comunic.longval1) + &
																	" and nro_incidencia=" + string(gu_comunic.is_comunic.longval2)  + &
																	" and f_alta=datetime('"+string(gu_comunic.is_comunic.datval1) + "')")
//" and '"+string(gu_comunic.is_comunic.datval1) + "'=string(f_alta, 'dd/mm/yyyy hh:mm:ss')")																	
																	
tabpage_interrupciones.dw_afec_parcial_sum.Filter()																						
openwithparm(w_afec_parcial_sum, tabpage_interrupciones.dw_afec_parcial_sum)
						
SELECT FGNU_TIPO_AREA(:pl_codigo)
INTO :ls_tipo_area
FROM DUAL;
	
IF SQLCA.SQLCode = 0 THEN
	CHOOSE CASE ls_tipo_area
		CASE 'C'
			ll_clientes_originales_c = tabpage_interrupciones.dw_afec_parcial_sum.RowCount()
			ll_clientes_originales_r = 0
			ll_clientes_originales_u = 0
			
		CASE 'R'
			ll_clientes_originales_c = 0
			ll_clientes_originales_r = tabpage_interrupciones.dw_afec_parcial_sum.RowCount()
			ll_clientes_originales_u = 0
		CASE 'U'
			ll_clientes_originales_c = 0
			ll_clientes_originales_r = 0
			ll_clientes_originales_u = tabpage_interrupciones.dw_afec_parcial_sum.RowCount()
	END CHOOSE
	adw_dw.SetItem(al_row, 'cant_cli_afec', tabpage_interrupciones.dw_afec_parcial_sum.RowCount())
	adw_dw.setitem(al_row,"ccli_afec_rur", ll_clientes_originales_r)
	adw_dw.setitem(al_row,"ccli_afec_ciu", ll_clientes_originales_c)
	adw_dw.setitem(al_row,"ccli_afec_urb", ll_clientes_originales_u)
	tabpage_interrupciones.dw_afec_parcial_sum.SetFilter("")	
	tabpage_interrupciones.dw_afec_parcial_sum.Filter()		
END IF
end subroutine

public function integer fnu_int_comunes (datetime pdt_f_desde, datetime pdt_f_hasta, long pdec_nro_inst);//return -1 // si no puede con f_alta
//return -2 // si no puede con f_desde
//return 0 // si funciona correctamente.

long ll_cant = 0,ll_row,ll_nro_incidencia
datetime ldt_f_alta,ldt_f_reposicion,ldt_f_actual
int li_retorno = 0

// Casos  1 y 3 // Hay una interrupcion abierta para la instalacion consultada. No podemos dejar interrumpir de nuevo ni resolver.
if isnull(pdt_f_hasta) then
	
	Select count(*)
	into :ll_cant
	from sgd_interrupcion
	where nro_instalacion = :pdec_nro_inst
		and (:pdt_f_desde between f_alta and nvl(f_reposicion,sysdate)) and nro_incidencia <> :il_nro_incidencia;
		
else

	Select count(*)
	into :ll_cant
	from sgd_interrupcion
	where nro_instalacion = :pdec_nro_inst
		and (:pdt_f_hasta between f_alta and nvl(f_reposicion,sysdate)) and nro_incidencia <> :il_nro_incidencia;
		
end if
		
if ll_cant > 0 and isnull(pdt_f_hasta) then
	li_retorno = -1
elseif ll_cant > 0 and not isnull(pdt_f_hasta) then
	li_retorno = -3
end if

if not isnull(pdt_f_hasta) and not isnull(pdt_f_desde) and li_retorno = 0 then
	
	// Caso 2
	declare lc_int cursor for
	Select f_alta,f_reposicion,f_actual,nro_incidencia
	from sgd_interrupcion
	where nro_instalacion = :pdec_nro_inst and
		f_alta >= :pdt_f_desde and
		f_reposicion <= :pdt_f_hasta and nro_incidencia <> :il_nro_incidencia;
	

	open lc_int;
	
	fetch lc_int 	into :ldt_f_alta,:ldt_f_reposicion,:ldt_f_actual,:ll_nro_incidencia;
	
	do while sqlca.sqlcode = 0 
		
		
		li_retorno = -2
	
		// se encontraron interrupciones para esta instalacion. 
		// Se rellena la datawindow correspondiente con las interrupciones que hay que eliminar de OOP		
		
		// Bloqueamos la incidencia
		IF gnu_u_transaction.uf_lock(iw_contenedora.st_bloqueo, "SGD_INCIDENCIA", "NRO_INCIDENCIA=" + string(ll_nro_incidencia), fgci_bloqueo_incidencia, ll_nro_incidencia) <> 0 THEN
			return -5
		END IF
			
		ll_row = tabpage_interrupciones.dw_lista_int_comunes.insertrow(0)
		
		tabpage_interrupciones.dw_lista_int_comunes.object.f_alta[ll_row] = ldt_f_alta
		tabpage_interrupciones.dw_lista_int_comunes.object.f_actual[ll_row] = ldt_f_actual

		tabpage_interrupciones.dw_lista_int_comunes.object.nro_incidencia[ll_row] = ll_nro_incidencia
		tabpage_interrupciones.dw_lista_int_comunes.object.nro_instalacion[ll_row] = pdec_nro_inst
		
		fetch lc_int 	into :ldt_f_alta,:ldt_f_reposicion,:ldt_f_actual,:ll_nro_incidencia;
		
	loop
	
	if sqlca.sqlcode = -1 then
		// Da error devuelvo -4
		close lc_int;
		li_retorno = -4
	else
		close lc_int;
	end if
	
end if

return li_retorno // si funciona correctamente.
end function

public function integer fnu_finalizar_descargo ();long ll_nro_descargo,ll_nro_instalacion
datetime ldt_inicio, ldt_fin

SELECT sgd_descargos.nro_descargo, 
		 sgd_estados_descargo.f_inicio,
		 sgd_estados_descargo.f_fin,
		 sgd_descargos.cod_inst_origen
INTO :ll_nro_descargo, 
	  :ldt_inicio,
	  :ldt_fin,
	  :ll_nro_instalacion
FROM sgd_descargos, sgd_estados_descargo
WHERE sgd_descargos.nro_incidencia= :il_nro_incidencia and
		sgd_descargos.nro_descargo = sgd_estados_descargo.nro_descargo and
		sgd_estados_descargo.estado = :fgci_descargo_activado;
			

IF ii_estado_oper = fgci_incidencia_resuelta THEN
	UPDATE "SGD_DESCARGOS"  
	SET "ESTADO" = :fgci_descargo_finalizado 
	WHERE "SGD_DESCARGOS"."NRO_DESCARGO" = :ll_nro_descargo;
		
	IF SQLCA.SQLCode = 0 THEN
		IF fg_insertar_estado_descargo(ll_nro_descargo, fgci_descargo_finalizado , &
													ldt_inicio, ldt_fin, fgnu_fecha_actual(),"", ll_nro_instalacion) THEN
	
				return 1
		ELSE
				messagebox("Atenci$$HEX1$$f300$$ENDHEX$$n", "Se ha producido un error a la hora de actualizar los estados del Descargo asociado a la Incidencia.")
				return -1
		END IF
	ELSE
		messagebox("Atenci$$HEX1$$f300$$ENDHEX$$n", "Se ha producido un error a la hora de finalizar el Descargo asociado a la Incidencia." + SQLCA.SQLErrText)
		return -1
	END IF				
ELSE
	Return 1
END IF
end function

public subroutine fw_grabar_eltos_corte ();//////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//										
// Funcion/Evento: fw_grabar_eltos_corte
//
// Graba los elementos de corte que se hayan seleccionado.
//
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//	
// Responsable: 	FDO 
//
// Fecha      	Responsable   	Actuaci$$HEX1$$f300$$ENDHEX$$n
// ------	   		-----------   		---------
// 15/09/2004    FDO
//
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////

string ls_matricula,ls_codigo_elto
int li_tipo,li_conta
datetime ld_f_actual

IF  tabpage_interrupciones.uo_eltos_corte.dw_elementos_corte.rowcount() > 0 THEN
	
	//Eliminamos los registros y volvemos a cargarlos por si se han producido cambios.
	
	DELETE SGD_ELEMENTOS_CORTE_INC WHERE NRO_INCIDENCIA =  :il_nro_incidencia;

	FOR li_conta = 1 to tabpage_interrupciones.uo_eltos_corte.dw_elementos_corte.rowcount()
				
		if isnull(tabpage_interrupciones.uo_eltos_corte.dw_elementos_corte.object.codigo[li_conta]) then
			ls_codigo_elto =  left(tabpage_interrupciones.uo_eltos_corte.dw_elementos_corte.object.matricula[li_conta],8)
		else
			ls_codigo_elto = string(tabpage_interrupciones.uo_eltos_corte.dw_elementos_corte.object.codigo[li_conta])
		end if
		
		ls_matricula = tabpage_interrupciones.uo_eltos_corte.dw_elementos_corte.object.mat[li_conta]
		li_tipo = tabpage_interrupciones.uo_eltos_corte.dw_elementos_corte.object.tipo[li_conta]
		
		if isnull(li_tipo) then
			tabpage_interrupciones.uo_eltos_corte.dw_elementos_corte.deleterow(li_conta)
		else
		
		  INSERT INTO "SGD_ELEMENTOS_CORTE_INC"  
					( "NRO_INCIDENCIA",   
					  "CODIGO",   
					  "MATRICULA",   
					  "TIPO",
					  "USUARIO",
					  "PROGRAMA",
					  "F_ACTUAL")  
		  VALUES ( :il_nro_incidencia,
		  			  to_number(:ls_codigo_elto),   
					  :ls_matricula,   
					  :li_tipo,
					  :gs_usuario,
					  'W_INCIDENCIAS',
					  :ld_f_actual);

			
			if sqlca.sqlcode <> 0 then
				messagebox("Atenci$$HEX1$$f300$$ENDHEX$$n","No se han podido dar de alta los elementos de corte. Error : "+ sqlca.sqlerrtext,Exclamation!,ok!)
				return
			end if
		end if
	NEXT

END IF
end subroutine

public function integer of_marcar_hijos (long pl_handle, boolean pl_bold);long ll_inst_hija, ll_nro_otra_incidencia
datos_arbol lstr_datos_rama
treeviewitem le_elemento
long ll_fila

ll_fila=tabpage_indisponibilidades.dw_datos_indisponibilidades.RowCount()

// Se obtienen los datos de la instalaci$$HEX1$$f300$$ENDHEX$$n
//tabpage_indisponibilidades.tv_2.getitem(pl_instalacion, le_elemento)
tabpage_indisponibilidades.tv_2.getitem(pl_handle,le_elemento)

lstr_datos_rama = le_elemento.data
ll_fila= tabpage_indisponibilidades.dw_datos_indisponibilidades.find("nro_incidencia= " + string(il_nro_incidencia) + " and nro_instalacion = " + string (lstr_datos_rama.ll_codigo), 1, tabpage_indisponibilidades.dw_datos_indisponibilidades.RowCount())

	SELECT NVL(SGD_INDISPONIBILIDAD.NRO_INCIDENCIA,0)
INTO :ll_nro_otra_incidencia
FROM SGD_INDISPONIBILIDAD
WHERE SGD_INDISPONIBILIDAD.NRO_INSTALACION= :lstr_datos_rama.ll_codigo
	AND SGD_INDISPONIBILIDAD.NRO_INCIDENCIA <> :il_nro_incidencia
	AND SGD_INDISPONIBILIDAD.F_REPOSICION IS NULL
	using SQLCA;
	
IF ll_nro_otra_incidencia<> 0 then
		le_elemento.bold=false
		le_elemento.pictureindex = tabpage_indisponibilidades.tv_2.f_icono_Arbol(lstr_datos_rama.ll_tipo + 700)
elseif ll_nro_otra_incidencia= 0 and pl_bold then
		le_elemento.bold=true
		le_elemento.pictureindex = tabpage_indisponibilidades.tv_2.f_icono_Arbol(lstr_datos_rama.ll_tipo + 600)
elseif ll_nro_otra_incidencia= 0 and not pl_bold and ll_fila <= 0 then
	le_elemento.bold=false
	le_elemento.pictureindex = tabpage_indisponibilidades.tv_2.f_icono_Arbol(lstr_datos_rama.ll_tipo + 400)
end if
le_elemento.selectedpictureindex = le_elemento.pictureindex

tabpage_indisponibilidades.tv_2.setitem(pl_handle,le_elemento)
ll_inst_hija = tabpage_indisponibilidades.tv_2.FindItem(ChildTreeItem!, pl_handle)
// Se marcan tambi$$HEX1$$e900$$ENDHEX$$n sin tensi$$HEX1$$f300$$ENDHEX$$n las instalaciones hijas de esta instalaci$$HEX1$$f300$$ENDHEX$$n que se encuentren

// visibles en el $$HEX1$$e100$$ENDHEX$$rbol
DO WHILE ll_inst_hija > 0
	of_marcar_hijos(ll_inst_hija,pl_bold)
	ll_inst_hija = tabpage_indisponibilidades.tv_2.FindItem(NextTreeItem!, ll_inst_hija)
LOOP


return 0
end function

public function boolean fnu_valida_indisponibilidad (long pl_handle);int li_fila 
long ll_tipo_instalacion, ll_nro_instalacion, ll_nro_incidencia, ll_nro_indisponibilidades=0
string ls_nom_instalacion
boolean lb_permitir_indisponibilidad=FALSE
treeviewitem le_elemento
datos_arbol lstr_datos_rama
DataStore lds_inst_ind

if pl_handle>0 then
	tabpage_indisponibilidades.tv_2.getitem(pl_handle, le_elemento)
	lstr_datos_rama = le_elemento.data
	ll_nro_instalacion=lstr_datos_rama.ll_codigo
else
	return false
end if

DECLARE lc_instalaciones CURSOR FOR
SELECT SGD_INSTALACION_AT.NOM_INSTALACION,
		 SGD_INDISPONIBILIDAD.NRO_INCIDENCIA,
		 SGD_INSTALACION_AT.TIPO_INSTALACION
FROM SGD_INSTALACION_AT, SGD_INDISPONIBILIDAD
WHERE SGD_INDISPONIBILIDAD.NRO_INSTALACION IN
	(SELECT NRO_INSTALACION
	 FROM SGD_INSTALACION_AT
	 START WITH NRO_INSTALACION= :ll_nro_instalacion AND BDI_JOB= 0
	 CONNECT BY PRIOR SGD_INSTALACION_AT.NRO_INST_PADRE=SGD_INSTALACION_AT.NRO_INSTALACION AND BDI_JOB=0)
	AND SGD_INDISPONIBILIDAD.NRO_INSTALACION=SGD_INSTALACION_AT.NRO_INSTALACION AND
	SGD_INDISPONIBILIDAD.NRO_INCIDENCIA <> :il_nro_incidencia AND
	SGD_INDISPONIBILIDAD.F_REPOSICION is NULL;
	
OPEN lc_instalaciones;

FETCH lc_instalaciones
INTO :ls_nom_instalacion,
	  :ll_nro_incidencia,
	  :ll_tipo_instalacion;
	  
IF sqlca.sqlcode=100 THEN
	lb_permitir_indisponibilidad= TRUE
ELSE
	lds_inst_ind= CREATE DataStore
	lds_inst_ind.DataObject= 'd_instalaciones_interrumpidas'
	
	DO WHILE sqlca.sqlcode= 0
		IF lds_inst_ind.Find ("ps_nom_instalacion= " + ls_nom_instalacion, 1, lds_inst_ind.RowCount()) <= 0 THEN
			li_fila= lds_inst_ind.InsertRow(0)
			lds_inst_ind.SetItem(li_fila,'pl_nro_incidencia', ll_nro_incidencia)
			lds_inst_ind.SetItem(li_fila,'ps_nom_instalacion', ls_nom_instalacion)
			lds_inst_ind.SetItem(li_fila,'pi_fase_visible',0)
		END IF
		
		FETCH lc_instalaciones
		INTO :ls_nom_instalacion,
	  	  	  :ll_nro_incidencia,
	  	  	  :ll_tipo_instalacion;
	LOOP
	
	MessageBox("Atenci$$HEX1$$f300$$ENDHEX$$n", "No se puede dar de alta la indisponibilidad ya que existen instalaciones superiores con indisponibilidades pendientes")
	
	OpenWithParm(w_mensaje_2, lds_inst_ind)

	DESTROY lds_inst_ind

END IF

CLOSE lc_instalaciones;
 
return lb_permitir_indisponibilidad



end function

public function integer of_cargar_indisponibilidad (long pl_nro_instalacion);long ll_bdi_job, ll_tipo_instalacion, ll_fila, ll_hay_indisponibilidad, ll_nro_otra_incidencia
string ls_nom_instalacion
datos_arbol lst_datos
treeviewitem le_elemento

int		li_nivel						//Nivel del $$HEX1$$e100$$ENDHEX$$rbol al que hay a$$HEX1$$f100$$ENDHEX$$adir los items
long		ll_bdiJobGrupo				//Bdi_job del grupo del activo afectado
long		ll_manejador				//Posici$$HEX1$$f300$$ENDHEX$$n del item a$$HEX1$$f100$$ENDHEX$$adido al $$HEX1$$e100$$ENDHEX$$rbol
long 		ll_manejadorAnterior		//Posici$$HEX1$$f300$$ENDHEX$$n de la instalaci$$HEX1$$f300$$ENDHEX$$n en el $$HEX1$$e100$$ENDHEX$$rbol anterior a la que estamos insertando
long		ll_nroGrupo					//C$$HEX1$$f300$$ENDHEX$$digo del grupo del activo afectado
long		ll_nroSubestacion			//C$$HEX1$$f300$$ENDHEX$$digo de la subestaci$$HEX1$$f300$$ENDHEX$$n
long		ll_nroInstalacion			//N$$HEX1$$fa00$$ENDHEX$$mero de la instalaci$$HEX1$$f300$$ENDHEX$$n que tenemos que a$$HEX1$$f100$$ENDHEX$$adir al $$HEX1$$e100$$ENDHEX$$rbol
long		ll_tipoGrupo				//Tipo del grupo del activo afectado
string	ls_nombreGrupo				//Nombre del grupo del activo afectado


setpointer(HourGlass!)
ll_manejador = 0
ll_manejadorAnterior = 0
/*SELECT nom_instalacion, bdi_job, tipo_instalacion
INTO :ls_nom_instalacion, :ll_bdi_job, :ll_tipo_instalacion 
FROM sgd_instalacion_at
WHERE nro_instalacion= :pl_nro_instalacion 
using sqlca;*/

//Captura de los datos de la subestaci$$HEX1$$f300$$ENDHEX$$n
SELECT a.nom_instalacion, a.bdi_job, a.tipo_instalacion, a.nro_instalacion
INTO :ls_nom_instalacion, :ll_bdi_job, :ll_tipo_instalacion, :ll_nroInstalacion
FROM sgd_instalacion_at a, sgd_instalacion_at b
WHERE a.nro_instalacion= b.cod_subestac_at
     AND b.nro_instalacion = :pl_nro_instalacion 
using sqlca;

if sqlca.sqlcode <> 0 then
	MessageBox("Error", "No se han podido obtener datos de la instalaci$$HEX1$$f300$$ENDHEX$$n")
	return -1
end if

ll_nroSubestacion = ll_nroInstalacion

//Borrado del $$HEX1$$e100$$ENDHEX$$rbol
//tabpage_indisponibilidades.tv_2.deleteitem(tabpage_indisponibilidades.tv_2.FindItem(RootTreeItem!, 0))		
tabpage_indisponibilidades.tv_2.deleteitem(0)		

//Carga de los datos en la estructura
lst_datos.ll_codigo = ll_nroInstalacion
lst_datos.ll_tipo = ll_tipo_instalacion
le_elemento.data = lst_datos
le_elemento.label = ls_nom_instalacion

//Carga de las instalaciones intermedias (entre la subestaci$$HEX1$$f300$$ENDHEX$$n y el activo afectado)
DO WHILE (ll_nroInstalacion <> pl_nro_instalacion)
	
	le_elemento.bold = FALSE
	le_elemento.pictureindex = tabpage_indisponibilidades.tv_2.f_icono_Arbol(lst_datos.ll_tipo + 400)
	le_elemento.selectedpictureindex = tabpage_indisponibilidades.tv_2.f_icono_Arbol(lst_datos.ll_tipo + 400)
	
	ll_manejadorAnterior = ll_manejador
	ll_manejador = tabpage_indisponibilidades.tv_2.insertitemsort(ll_manejador,le_elemento)
	
	//Despliega el item anterior
	IF ll_manejadorAnterior > 0 THEN
		tabpage_indisponibilidades.tv_2.expandItem(ll_manejadorAnterior)
	END IF

	SELECT nom_instalacion, bdi_job, tipo_instalacion, nro_instalacion
	INTO :ls_nom_instalacion, :ll_bdi_job, :ll_tipo_instalacion, :ll_nroInstalacion 
	FROM sgd_instalacion_at
	WHERE nro_inst_padre = :ll_nroInstalacion 
	START WITH nro_instalacion = :pl_nro_instalacion
	CONNECT BY PRIOR nro_inst_padre = nro_instalacion
	using sqlca;
	
	//Cargamos el grupo
	IF (li_nivel = 0) THEN
		
				
		SELECT a.codigo, a.descripcion, a.bdi_job, 25
		INTO :ll_nroGrupo, :ls_nombreGrupo, :ll_bdiJobGrupo, :ll_tipoGrupo
		FROM bdiv10_grupos_activos a, bdiv10_activos b
		WHERE b.grupo_activos_v10 = '6666:' || a.codigo
			AND b.codigo = (SELECT nro_instalacion
							FROM sgd_instalacion_at 
							WHERE nro_inst_padre = :ll_nroSubestacion
							START WITH nro_instalacion = :pl_nro_instalacion
							CONNECT BY PRIOR nro_inst_padre = nro_instalacion);
			
		IF (NOT(isNull(ll_nroGrupo)) AND ll_nroGrupo > 0)AND (ll_nroGrupo <> ll_nroInstalacion) THEN
						
			li_nivel++
			
			lst_datos.ll_codigo = ll_nroGrupo
			lst_datos.ll_tipo = ll_tipoGrupo
			le_elemento.data = lst_datos
			le_elemento.label = ls_nombreGrupo
			
			le_elemento.bold = FALSE
			le_elemento.pictureindex = tabpage_indisponibilidades.tv_2.f_icono_Arbol(lst_datos.ll_tipo + 400)
			le_elemento.selectedpictureindex = tabpage_indisponibilidades.tv_2.f_icono_Arbol(lst_datos.ll_tipo + 400)
			
			ll_manejadorAnterior = ll_manejador
			ll_manejador = tabpage_indisponibilidades.tv_2.insertitemsort(ll_manejador,le_elemento)
			
			IF ll_manejadorAnterior > 0 THEN
				tabpage_indisponibilidades.tv_2.expandItem(ll_manejadorAnterior)
			END IF
			
		ELSEIF (ll_nroGrupo = ll_nroInstalacion) THEN
			
			ls_nom_instalacion = ls_nombreGrupo
			ll_bdi_job = ll_bdiJobGrupo
			ll_tipo_instalacion = ll_tipoGrupo
			ll_nroInstalacion = ll_nroGrupo
			
		END IF
	END IF
	
	//Carga de los datos en la estructura
	lst_datos.ll_codigo = ll_nroInstalacion
	lst_datos.ll_tipo = ll_tipo_instalacion
	le_elemento.data = lst_datos
	le_elemento.label = ls_nom_instalacion

	li_nivel++
	
LOOP



ll_fila= tabpage_indisponibilidades.dw_datos_indisponibilidades.find("nro_instalacion = " + string(pl_nro_instalacion),1,tabpage_indisponibilidades.dw_datos_indisponibilidades.RowCount())

if ll_fila>0 then
	le_elemento.bold=true
	le_elemento.pictureindex = tabpage_indisponibilidades.tv_2.f_icono_Arbol(lst_datos.ll_tipo + 600)
	le_elemento.selectedpictureindex = tabpage_indisponibilidades.tv_2.f_icono_Arbol(lst_datos.ll_tipo + 600)
	//JME 22/06/09
	tabpage_indisponibilidades.dw_datos_indisponibilidades.SetRow(ll_fila)
	tabpage_indisponibilidades.dw_datos_indisponibilidades.ScrollToRow(ll_fila)
	tabpage_indisponibilidades.st_15.text= "Indisponibilidad en " + le_elemento.label
	tabpage_indisponibilidades.dw_datos_indisponibilidades.Visible = true
	tabpage_indisponibilidades.cb_maniobras.visible = true //JME 14/07/09
	//Fin JME
	
else

	SELECT NVL(SGD_INDISPONIBILIDAD.NRO_INCIDENCIA,0)
	INTO :ll_nro_otra_incidencia
	FROM SGD_INDISPONIBILIDAD
	WHERE SGD_INDISPONIBILIDAD.NRO_INSTALACION= :pl_nro_instalacion
		AND SGD_INDISPONIBILIDAD.NRO_INCIDENCIA <> :il_nro_incidencia
		AND SGD_INDISPONIBILIDAD.F_REPOSICION IS NULL
		using SQLCA;
		
	if ll_nro_otra_incidencia <> 0 and gu_comunic1.is_comunic.intval9<>1 THEN
		le_elemento.bold=false
		le_elemento.pictureindex = tabpage_indisponibilidades.tv_2.f_icono_Arbol(lst_datos.ll_tipo + 700)
		le_elemento.selectedpictureindex = tabpage_indisponibilidades.tv_2.f_icono_Arbol(lst_datos.ll_tipo + 700)
	else
		le_elemento.bold=false
		le_elemento.pictureindex = tabpage_indisponibilidades.tv_2.f_icono_Arbol(lst_datos.ll_tipo + 400)
		le_elemento.selectedpictureindex = tabpage_indisponibilidades.tv_2.f_icono_Arbol(lst_datos.ll_tipo + 400)
	end if
end if

ll_manejadorAnterior = ll_manejador
ll_manejador = tabpage_indisponibilidades.tv_2.insertitemsort(ll_manejador,le_elemento)


//Despliega el item anterior
IF ll_manejadorAnterior > 0 THEN
	tabpage_indisponibilidades.tv_2.expandItem(ll_manejadorAnterior)
END IF

RETURN 0


//long ll_bdi_job, ll_tipo_instalacion, ll_fila, ll_hay_indisponibilidad, ll_nro_otra_incidencia
//string ls_nom_instalacion
//datos_arbol lst_datos
//treeviewitem le_elemento
//
//setpointer(HourGlass!)
//
//SELECT nom_instalacion, bdi_job, tipo_instalacion
//INTO :ls_nom_instalacion, :ll_bdi_job, :ll_tipo_instalacion 
//FROM sgd_instalacion_at
//WHERE nro_instalacion= :pl_nro_instalacion 
//using sqlca;
//
//if sqlca.sqlcode <> 0 then
//	MessageBox("Error", "No se han podido obtener datos de la instalaci$$HEX1$$f300$$ENDHEX$$n")
//	return -1
//end if
//tabpage_indisponibilidades.tv_2.deleteitem(0)
////
////DECLARE cu_subestacion CURSOR FOR
////SELECT nro_instalacion, nom_instalacion, bdi_job, tipo_instalacion
////FROM sgd_instalacion_at
////WHERE tipo_instalacion=1
////ORDER BY nom_instalacion;
//// 
////OPEN cu_subestacion;
//// 
////FETCH cu_subestacion INTO :ll_nro_instalacion, :ls_nom_instalacion, :ll_bdi_job, :ll_tipo_instalacion;
////
////do while sqlca.sqlcode <>100 and sqlca.sqlcode <> -1
//	lst_datos.ll_codigo = pl_nro_instalacion
//	lst_datos.ll_tipo = ll_tipo_instalacion
//	le_elemento.data = lst_datos
//	le_elemento.label = ls_nom_instalacion
//	ll_fila= tabpage_indisponibilidades.dw_datos_indisponibilidades.find("nro_instalacion = " + string(pl_nro_instalacion),1,tabpage_indisponibilidades.dw_datos_indisponibilidades.RowCount())
//	if ll_fila>0 then
//		le_elemento.bold=true
//		le_elemento.pictureindex = tabpage_indisponibilidades.tv_2.f_icono_Arbol(lst_datos.ll_tipo + 600)
//		le_elemento.selectedpictureindex = tabpage_indisponibilidades.tv_2.f_icono_Arbol(lst_datos.ll_tipo + 600)
//		
//		
//		//JME 08/05/09
//		long ll_fila2
//		tabpage_indisponibilidades.dw_datos_indisponibilidades.Visible=True
//		tabpage_indisponibilidades.st_16.visible=False
//		tabpage_indisponibilidades.cb_maniobras.visible = true
//		
//		ll_fila2= tabpage_indisponibilidades.dw_lista_indisponibilidades.getselectedrow(0)
//		tabpage_indisponibilidades.dw_lista_indisponibilidades.SelectRow(ll_fila2, False)
//		if ll_fila <= tabpage_indisponibilidades.dw_lista_indisponibilidades.RowCount() then 
//			tabpage_indisponibilidades.dw_lista_indisponibilidades.SelectRow(ll_fila, True)	
//			tabpage_indisponibilidades.dw_lista_indisponibilidades.SetRow(ll_fila)
//			tabpage_indisponibilidades.dw_lista_indisponibilidades.ScrollToRow(ll_fila)
//		end if
//		
//		tabpage_indisponibilidades.dw_datos_indisponibilidades.SetRow(ll_fila)
//		tabpage_indisponibilidades.dw_datos_indisponibilidades.ScrollToRow(ll_fila)
//		
//		tabpage_indisponibilidades.st_15.text= "Indisponibilidad en " + le_elemento.label
//		//Fin JME	
//		
//		
//	else
//
//SELECT NVL(SGD_INDISPONIBILIDAD.NRO_INCIDENCIA,0)
//INTO :ll_nro_otra_incidencia
//FROM SGD_INDISPONIBILIDAD
//WHERE SGD_INDISPONIBILIDAD.NRO_INSTALACION= :pl_nro_instalacion
//	AND SGD_INDISPONIBILIDAD.NRO_INCIDENCIA <> :il_nro_incidencia
//	AND SGD_INDISPONIBILIDAD.F_REPOSICION IS NULL
//	using SQLCA;
//
//		if ll_nro_otra_incidencia <> 0 and gu_comunic1.is_comunic.intval9<>1 THEN
//			le_elemento.bold=false
//			le_elemento.pictureindex = tabpage_indisponibilidades.tv_2.f_icono_Arbol(lst_datos.ll_tipo + 700)
//			le_elemento.selectedpictureindex = tabpage_indisponibilidades.tv_2.f_icono_Arbol(lst_datos.ll_tipo + 700)
//		else
//			le_elemento.bold=false
//			le_elemento.pictureindex = tabpage_indisponibilidades.tv_2.f_icono_Arbol(lst_datos.ll_tipo + 400)
//			le_elemento.selectedpictureindex = tabpage_indisponibilidades.tv_2.f_icono_Arbol(lst_datos.ll_tipo + 400)
//		end if
//	end if
//	tabpage_indisponibilidades.tv_2.insertitemsort(0,le_elemento)
////	FETCH cu_subestacion INTO :ll_nro_instalacion, :ls_nom_instalacion, :ll_bdi_job, :ll_tipo_instalacion;
////loop
////
////close cu_subestacion;
//return 0
end function

public function integer fnu_valida_sr ();long ll_nro_trabajos, ll_nro_descargo
datetime ldt_f_nula
int li_respuesta, ii_sgi_sgt, li_ind_act_grafica = 0
long ll_agente

string ls_duracion 

if ii_estado_oper=fgci_incidencia_resuelta then return 0


SetNull(ldt_f_nula)

SELECT nvl("SGD_DESCARGOS"."IND_ACT_GRAFICA" ,0), "SGD_DESCARGOS"."NRO_DESCARGO"
INTO :li_ind_act_grafica, :ll_nro_descargo
FROM "SGD_DESCARGOS"  
WHERE "SGD_DESCARGOS"."NRO_INCIDENCIA" = :il_nro_incidencia   ;

// Se valida si se ha definido la instalaci$$HEX1$$f300$$ENDHEX$$n origen

IF NOT (ii_alcance = fgci_incidencia_de_suministro or &
   	  ii_tipo_incid = fgci_incidencia_calidad or &
	 	  ii_alcance = fgci_incidencia_reenganche or &
    	  ii_alcance = fgci_incidencia_sin_interrupcion) THEN

	//AHM(20/10/2011)	Integraci$$HEX1$$f300$$ENDHEX$$n OSGI - OSGM
	IF NOT(fg_verifica_parametro("OSGM ACTIVO")) THEN
		IF ii_tipo_incid <> fgci_incidencia_programada and (tabpage_formulario.d_inf_general.getitemnumber(1,"instalacion_origen") < 1 &
					or isnull(tabpage_formulario.d_inf_general.getitemnumber(1,"instalacion_origen"))) THEN
					Return -100
		END IF		
	ELSE
		IF ii_tipo_incid <> fgci_incidencia_programada and (idec_nro_instalacion_afectada < 1 &
					or isnull(idec_nro_instalacion_afectada)) THEN
					Return -100
		END IF	
		
	END IF
		
END IF
// Se valida si hay causa
IF IsNull(tabpage_formulario.d_inf_general.GetItemNumber(1, 'causa')) THEN
	Return -200
END IF

if	tabpage_formulario.d_inf_general.GetItemNumber(1, 'causa') = fgci_cod_causa_desconocida THEN
	return -300
END IF
		
// Se validan las observaciones
IF not iu_inc_2003_rn.frn_validar_observaciones(tabpage_formulario.d_inf_general) THEN
	return -400 
END IF
		
ll_agente=tabpage_otros.dw_otros.getitemnumber(1,'agente')

if  fg_verifica_parametro ('SELEC_AGENTE') and (ll_agente = 0 or isnull(ll_agente)) then
	return -500
END IF // FIN GNU
				
// GNU 30-10-2006- Mejora EPSA
if fg_verifica_parametro("indisponibilidades activas") then
	if tabpage_indisponibilidades.dw_lista_indisponibilidades.find("isnull(f_reposicion_origen)" , 1, tabpage_indisponibilidades.dw_lista_indisponibilidades.RowCount()) > 0 then
		Return -600 
	end if
END IF
			
				
IF li_ind_act_grafica = 1 AND ii_estado_oper = fgci_incidencia_pte_explotacion THEN
	SELECT COUNT(*)
	INTO :ll_nro_trabajos
	FROM SGD_TRABAJOS_BDI
	WHERE NRO_DESCARGO = :ll_nro_descargo AND 
			ESTADO_TRABAJO <> :fgci_trabajo_pto_servicio;
					
	IF SQLCA.SQLCode = 0 AND ll_nro_trabajos <> 0 THEN
		//Messagebox("Atenci$$HEX1$$f300$$ENDHEX$$n", "No se puede resolver la Incidencia debido a que no todos los trabajos de BDI ~r~nasociados al Descargo est$$HEX1$$e100$$ENDHEX$$n Puestos en Servicio.")
		return -800
	END IF
END IF

//AHM(10/10/2011) Integraci$$HEX1$$f300$$ENDHEX$$n OSGI-OSGM
//24/10/2008 YAF
//SE VALIDA SI EXISTE EL TAB interrupciones
IF tabpage_interrupciones.visible=false AND NOT(fg_verifica_parametro("OSGM ACTIVO")) then
	return -900
END IF

return 0
				
end function

public function integer fw_validacion_fecha_reposicion (datetime pdt_f_reposicion, datetime pdt_f_alta, datetime pdt_f_deteccion);///////////////////////////////////////////////////////
//										
// Funcion/Evento: fw_validacion_fecha_reposicion
// 
// Objetivo: Verifica la idoneidad de la fecha de reposici$$HEX1$$f300$$ENDHEX$$n
//
// Responsable: JME
//
// Par$$HEX1$$e100$$ENDHEX$$metros:
//    Entrada: --
//		Salida : --
//
// Devuelve:
//
// Fecha      	Responsable   Actuaci$$HEX1$$f300$$ENDHEX$$n
// ------	   -----------   ---------
// 29/04/09    JME				Creaci$$HEX1$$f300$$ENDHEX$$n
//
///////////////////////////////////////////////////////


int li_retorno = 0
datetime ldt_fecha_nula



if pdt_f_reposicion< pdt_f_deteccion then
	MessageBox("Atenci$$HEX1$$f300$$ENDHEX$$n", "La Fecha de Reposici$$HEX1$$f300$$ENDHEX$$n de la Indisponibilidad no puede ser menor que la fecha de alta de la Incidencia")
	Return 2
end if

if pdt_f_reposicion < pdt_f_alta then
	MessageBox("Atenci$$HEX1$$f300$$ENDHEX$$n", "La Fecha de Reposici$$HEX1$$f300$$ENDHEX$$n de la Indisponibilidad no puede ser menor que la Fecha de Alta de la misma")
	Return 2
end if

if pdt_f_reposicion > fgnu_fecha_actual() then
	gnv_msg.f_mensaje("AI110","","",ok!)
	Return 2
end if

return li_retorno
end function

public function long fw_actualiza_indisponibilidades_maniobra (datastore pds_atributos, datastore pds_indisponibilidades);
long ll_return = 0
long ll_cont, ll_rows, ll_rows_atributos

ll_rows = pds_indisponibilidades.RowCount()
ll_rows_atributos = pds_atributos.RowCount()

if (ll_rows > 0) and (ll_rows_atributos > 0) then 
	
	for ll_cont = 1 to ll_rows
		
		if not isnull (pds_atributos.object.DISPONIBILIDAD_ACT[1]) then 
			pds_indisponibilidades.object.DISPONIBILIDAD_ACT[ll_cont] = pds_atributos.object.DISPONIBILIDAD_ACT[1]
		end if
		
		if not isnull (pds_atributos.object.CONSIGNACION_NACIONAL[1]) then 
			pds_indisponibilidades.object.CONSIGNACION_NACIONAL[ll_cont] = pds_atributos.object.CONSIGNACION_NACIONAL[1]
		end if
		
		if not isnull (pds_atributos.object.DEMORA_JUSTIFICADA[1]) then 
			pds_indisponibilidades.object.DEMORA_JUSTIFICADA[ll_cont] = pds_atributos.object.DEMORA_JUSTIFICADA[1]
		end if
		
		if not isnull (pds_atributos.object.DESCRIPCION_DEMORA[1]) then 
			pds_indisponibilidades.object.DESCRIPCION_DEMORA[ll_cont] = pds_atributos.object.DESCRIPCION_DEMORA[1]
		end if
		
		if not isnull (pds_atributos.object.CONSIGNACION_NAC_CHECK[1]) then 
			pds_indisponibilidades.object.CONSIGNACION_NAC_CHECK[ll_cont] = pds_atributos.object.CONSIGNACION_NAC_CHECK[1]
		end if
		
		if not isnull (pds_atributos.object.PSM[1]) then 
			pds_indisponibilidades.object.PSM[ll_cont] = pds_atributos.object.PSM[1]
		end if
		
//		if not isnull (pds_atributos.object.FUERA_PSM[1]) then 
//			pds_indisponibilidades.object.FUERA_PSM[ll_cont] = pds_atributos.object.FUERA_PSM[1]
//		end if
		
		if not isnull (pds_atributos.object.TIEMPO_INSTRUCCION[1]) then 
			pds_indisponibilidades.object.TIEMPO_INSTRUCCION[ll_cont] = pds_atributos.object.TIEMPO_INSTRUCCION[1]
		end if
		
		if not isnull (pds_atributos.object.TIEMPO_REPORTE[1]) then 
			pds_indisponibilidades.object.TIEMPO_REPORTE[ll_cont] = pds_atributos.object.TIEMPO_REPORTE[1]
		end if
		
		if not isnull (pds_atributos.object.TIPO_REPORTE[1]) then 
			pds_indisponibilidades.object.TIPO_REPORTE[ll_cont] = pds_atributos.object.TIPO_REPORTE[1]
		end if
		
		if not isnull (pds_atributos.object.FECHA_BYPASS[1]) then 
			pds_indisponibilidades.object.FECHA_BYPASS[ll_cont] = pds_atributos.object.FECHA_BYPASS[1]
		end if
		
		if not isnull (pds_atributos.object.ACTIVO_CAUSANTE[1]) then 
			pds_indisponibilidades.object.ACTIVO_CAUSANTE[ll_cont] = pds_atributos.object.ACTIVO_CAUSANTE[1]
		end if
		
		if not isnull (pds_atributos.object.COD_CAUSA[1]) then 
			pds_indisponibilidades.object.COD_CAUSA[ll_cont] = pds_atributos.object.COD_CAUSA[1]
		end if
		
		if not isnull (pds_atributos.object.FECHA_CAUSA[1]) then 
			pds_indisponibilidades.object.FECHA_CAUSA[ll_cont] = pds_atributos.object.FECHA_CAUSA[1]
		end if
	
	next
end if

return ll_return

end function

public subroutine fw_actualiza_indisponibilidades_maniobra (long pl_cod_maniobra, datastore pds_atributos);
string ls_filtro

//Indisponibilidades asociadas a una maniobra de apertura
tabpage_indisponibilidades.dw_datos_indisponibilidades.SetFilter("")
tabpage_indisponibilidades.dw_datos_indisponibilidades.Filter()
ls_filtro = 't_mapertura = ' + string(pl_cod_maniobra)
tabpage_indisponibilidades.dw_datos_indisponibilidades.SetFilter(ls_filtro)
tabpage_indisponibilidades.dw_datos_indisponibilidades.Filter()
if tabpage_indisponibilidades.dw_datos_indisponibilidades.RowCount() > 0 then 
	fw_actualiza_indisponibilidades_apertura(pds_atributos, tabpage_indisponibilidades.dw_datos_indisponibilidades)
end if
tabpage_indisponibilidades.dw_datos_indisponibilidades.SetFilter("")
tabpage_indisponibilidades.dw_datos_indisponibilidades.Filter()			



//Indisponibilidades asociadas a una maniobra de cierre
ls_filtro = 't_mcierre = ' + string(pl_cod_maniobra)
tabpage_indisponibilidades.dw_datos_indisponibilidades.SetFilter(ls_filtro)
tabpage_indisponibilidades.dw_datos_indisponibilidades.Filter()
if tabpage_indisponibilidades.dw_datos_indisponibilidades.RowCount() > 0 then 
	fw_actualiza_indisponibilidades_cierre(pds_atributos, tabpage_indisponibilidades.dw_datos_indisponibilidades)
end if
tabpage_indisponibilidades.dw_datos_indisponibilidades.SetFilter("")
tabpage_indisponibilidades.dw_datos_indisponibilidades.Filter()	

tabpage_indisponibilidades.dw_datos_indisponibilidades.SetSort("NRO_INSTALACION, F_ALTA, F_ACTUAL")
tabpage_indisponibilidades.dw_datos_indisponibilidades.Sort()	






end subroutine

public function long fw_actualiza_indisponibilidades_cierre (datastore pds_atributos, datawindow pdw_indisponibilidades);
long ll_return = 0
long ll_cont, ll_rows, ll_rows_atributos, ll_activo, ll_tipo_reporte
string ls_tipo_activo

ll_rows = pdw_indisponibilidades.RowCount()
ll_rows_atributos = pds_atributos.RowCount()

if (ll_rows > 0) and (ll_rows_atributos > 0) then 
	
	for ll_cont = 1 to ll_rows
				
		ll_activo = pdw_indisponibilidades.object.nro_instalacion[ll_cont]
		
		SELECT trim(TIPO_ACTIVO)
		  INTO :ls_tipo_activo
		  FROM SGD_INSTALACION_AT
		 WHERE NRO_INSTALACION = :ll_activo;
						 
		if ls_tipo_activo = '2' or ls_tipo_activo = '3' then 
			ll_tipo_reporte = 0 
		else
			ll_tipo_reporte = pds_atributos.object.TIPO_EVENTO[1]
		end if
			
		// Los atributos de la maniobra deben heredarlo las indisponibilidades de los activos BAH$$HEX1$$cd00$$ENDHEX$$A
		if ls_tipo_activo = '1'then 		
			if not isnull (pds_atributos.object.DISPONIBILIDAD[1]) then 
				pdw_indisponibilidades.object.DISPONIBILIDAD_ACT_m_c[ll_cont] = pds_atributos.object.DISPONIBILIDAD[1]
			end if
			
			if not isnull (pds_atributos.object.NUMERO[1]) then 
				pdw_indisponibilidades.object.CONSIGNACION_NACIONAL_m_c[ll_cont] = pds_atributos.object.NUMERO[1]
			end if
			
			if not isnull (pds_atributos.object.DEMORA[1]) then 
				pdw_indisponibilidades.object.DEMORA_JUSTIFICADA_m_c[ll_cont] = pds_atributos.object.DEMORA[1]
			end if
			
			if not isnull (pds_atributos.object.DESCRIPCION_DEMORA[1]) then 
				pdw_indisponibilidades.object.DESCRIPCION_DEMORA_m_c[ll_cont] = pds_atributos.object.DESCRIPCION_DEMORA[1]
			end if
			
			if not isnull (pds_atributos.object.CONSIGNACION[1]) then 
				pdw_indisponibilidades.object.CONSIGNACION_NAC_CHECK_m_c[ll_cont] = pds_atributos.object.CONSIGNACION[1]
			end if
			
			if not isnull (pds_atributos.object.TIPO_PSM[1]) then 
				pdw_indisponibilidades.object.PSM_m_c[ll_cont] = pds_atributos.object.TIPO_PSM[1]
			end if
			
	//		if not isnull (pds_atributos.object.FUERA_PSM[1]) then 
	//			pdw_indisponibilidades.object.FUERA_PSM_m_c[ll_cont] = pds_atributos.object.FUERA_PSM[1]
	//		end if

			
			if not isnull (pds_atributos.object.FECHA_INSTRUCCION_CND[1]) then 
				pdw_indisponibilidades.object.TIEMPO_INSTRUCCION_m_c[ll_cont] = pds_atributos.object.FECHA_INSTRUCCION_CND[1]
			end if
			
			if not isnull (pds_atributos.object.FECHA_REPORTE_CND[1]) then 
				pdw_indisponibilidades.object.TIEMPO_REPORTE_m_c[ll_cont] = pds_atributos.object.FECHA_REPORTE_CND[1]
			end if
			
			if not isnull (pds_atributos.object.TIPO_EVENTO[1]) then 
				pdw_indisponibilidades.object.TIPO_REPORTE_m_c[ll_cont] = ll_tipo_reporte
			end if
			
			if not isnull (pds_atributos.object.FECHA_BYPASS[1]) then 
				pdw_indisponibilidades.object.FECHA_BYPASS_m_c[ll_cont] = pds_atributos.object.FECHA_BYPASS[1]
			end if
			
			if not isnull (pds_atributos.object.CM_ACTIVO_CAUSANTE[1]) then 
				pdw_indisponibilidades.object.CM_ACTIVO_CAUSANTE_m_c[ll_cont] = pds_atributos.object.CM_ACTIVO_CAUSANTE[1]
			end if
			
			if not isnull (pds_atributos.object.COD_CAUSA[1]) then 
				pdw_indisponibilidades.object.COD_CAUSA_m_c[ll_cont] = pds_atributos.object.COD_CAUSA[1]
			end if
			
			if not isnull (pds_atributos.object.FEC_CAUSA[1]) then 
				pdw_indisponibilidades.object.FECHA_CAUSA_m_c[ll_cont] = pds_atributos.object.FEC_CAUSA[1]
			end if
			
			if not isnull (pds_atributos.object.OBSERVACIONES[1]) then 
				pdw_indisponibilidades.object.OBSERVACIONES_m_c[ll_cont] = pds_atributos.object.OBSERVACIONES[1]
			end if
		
		else
			
			if not isnull (pds_atributos.object.FECHA_INSTRUCCION_CND[1]) then 
				pdw_indisponibilidades.object.TIEMPO_INSTRUCCION_m_c[ll_cont] = pds_atributos.object.FECHA_INSTRUCCION_CND[1]
			end if
			
			if not isnull (pds_atributos.object.FECHA_REPORTE_CND[1]) then 
				pdw_indisponibilidades.object.TIEMPO_REPORTE_m_c[ll_cont] = pds_atributos.object.FECHA_REPORTE_CND[1]
			end if
			
			if not isnull (pds_atributos.object.TIPO_EVENTO[1]) then 
				pdw_indisponibilidades.object.TIPO_REPORTE_m_c[ll_cont] = ll_tipo_reporte
			end if
			
			if not isnull (pds_atributos.object.CM_ACTIVO_CAUSANTE[1]) then 
				pdw_indisponibilidades.object.CM_ACTIVO_CAUSANTE_m_c[ll_cont] = pds_atributos.object.CM_ACTIVO_CAUSANTE[1]
			end if
			
			if not isnull (pds_atributos.object.OBSERVACIONES[1]) then 
				pdw_indisponibilidades.object.OBSERVACIONES_m_c[ll_cont] = pds_atributos.object.OBSERVACIONES[1]
			end if
			
		end if
	next
end if

return ll_return

end function

public function long fw_actualiza_indisponibilidades_apertura (datastore pds_atributos, datawindow pdw_indisponibilidades);
long ll_return = 0
long ll_cont, ll_rows, ll_rows_atributos, ll_activo, ll_tipo_reporte
string ls_tipo_activo

ll_rows = pdw_indisponibilidades.RowCount()
ll_rows_atributos = pds_atributos.RowCount()

if (ll_rows > 0) and (ll_rows_atributos > 0) then 
	
	for ll_cont = 1 to ll_rows
		
		ll_activo = pdw_indisponibilidades.object.nro_instalacion[ll_cont]
		
		SELECT trim(TIPO_ACTIVO)
		  INTO :ls_tipo_activo
		  FROM SGD_INSTALACION_AT
		 WHERE NRO_INSTALACION = :ll_activo;
		 
		if ls_tipo_activo = '2' or ls_tipo_activo = '3' then 
			ll_tipo_reporte = 0 
		else
			ll_tipo_reporte = pds_atributos.object.TIPO_EVENTO[1]
		end if
			
				
		// Los atributos de la maniobra deben heredarlo las indisponibilidades de los activos BAH$$HEX1$$cd00$$ENDHEX$$A
		if ls_tipo_activo = '1' then 		
		
			if not isnull (pds_atributos.object.DISPONIBILIDAD[1]) then 
				pdw_indisponibilidades.object.DISPONIBILIDAD_ACT[ll_cont] = pds_atributos.object.DISPONIBILIDAD[1]
			end if
			
			if not isnull (pds_atributos.object.NUMERO[1]) then 
				pdw_indisponibilidades.object.CONSIGNACION_NACIONAL[ll_cont] = pds_atributos.object.NUMERO[1]
			end if
			
			if not isnull (pds_atributos.object.DEMORA[1]) then 
				pdw_indisponibilidades.object.DEMORA_JUSTIFICADA[ll_cont] = pds_atributos.object.DEMORA[1]
			end if
			
			if not isnull (pds_atributos.object.DESCRIPCION_DEMORA[1]) then 
				pdw_indisponibilidades.object.DESCRIPCION_DEMORA[ll_cont] = pds_atributos.object.DESCRIPCION_DEMORA[1]
			end if
			
			if not isnull (pds_atributos.object.CONSIGNACION[1]) then 
				pdw_indisponibilidades.object.CONSIGNACION_NAC_CHECK[ll_cont] = pds_atributos.object.CONSIGNACION[1]
			end if
			
			if not isnull (pds_atributos.object.tipo_PSM[1]) then 
				pdw_indisponibilidades.object.PSM[ll_cont] = pds_atributos.object.tipo_PSM[1]
			end if
			
	//		if not isnull (pds_atributos.object.FUERA_PSM[1]) then 
	//			pdw_indisponibilidades.object.FUERA_PSM[ll_cont] = pds_atributos.object.FUERA_PSM[1]
	//		end if
			
			if not isnull (pds_atributos.object.FECHA_INSTRUCCION_CND[1]) then 
				pdw_indisponibilidades.object.TIEMPO_INSTRUCCION[ll_cont] = pds_atributos.object.FECHA_INSTRUCCION_CND[1]
			end if
			
			if not isnull (pds_atributos.object.FECHA_REPORTE_CND[1]) then 
				pdw_indisponibilidades.object.TIEMPO_REPORTE[ll_cont] = pds_atributos.object.FECHA_REPORTE_CND[1]
			end if
			
			if not isnull (pds_atributos.object.TIPO_EVENTO[1]) then 
				pdw_indisponibilidades.object.TIPO_REPORTE[ll_cont] = ll_tipo_reporte
			end if
			
			if not isnull (pds_atributos.object.FECHA_BYPASS[1]) then 
				pdw_indisponibilidades.object.FECHA_BYPASS[ll_cont] = pds_atributos.object.FECHA_BYPASS[1]
			end if
			
			if not isnull (pds_atributos.object.CM_ACTIVO_CAUSANTE[1]) then 
				pdw_indisponibilidades.object.CM_ACTIVO_CAUSANTE[ll_cont] = pds_atributos.object.CM_ACTIVO_CAUSANTE[1]
			end if
			
			if not isnull (pds_atributos.object.COD_CAUSA[1]) then 
				pdw_indisponibilidades.object.COD_CAUSA[ll_cont] = pds_atributos.object.COD_CAUSA[1]
			end if
			
			if not isnull (pds_atributos.object.FEC_CAUSA[1]) then 
				pdw_indisponibilidades.object.FECHA_CAUSA[ll_cont] = pds_atributos.object.FEC_CAUSA[1]
			end if
			
			if not isnull (pds_atributos.object.OBSERVACIONES[1]) then 
				pdw_indisponibilidades.object.OBSERVACIONES[ll_cont] = pds_atributos.object.OBSERVACIONES[1]
			end if
			
		else
			
			if not isnull (pds_atributos.object.FECHA_INSTRUCCION_CND[1]) then 
				pdw_indisponibilidades.object.TIEMPO_INSTRUCCION[ll_cont] = pds_atributos.object.FECHA_INSTRUCCION_CND[1]
			end if
			
			if not isnull (pds_atributos.object.FECHA_REPORTE_CND[1]) then 
				pdw_indisponibilidades.object.TIEMPO_REPORTE[ll_cont] = pds_atributos.object.FECHA_REPORTE_CND[1]
			end if
			
			if not isnull (pds_atributos.object.TIPO_EVENTO[1]) then 
				pdw_indisponibilidades.object.TIPO_REPORTE[ll_cont] = ll_tipo_reporte
			end if
						
			if not isnull (pds_atributos.object.CM_ACTIVO_CAUSANTE[1]) then 
				pdw_indisponibilidades.object.CM_ACTIVO_CAUSANTE[ll_cont] = pds_atributos.object.CM_ACTIVO_CAUSANTE[1]
			end if
			
			if not isnull (pds_atributos.object.OBSERVACIONES[1]) then 
				pdw_indisponibilidades.object.OBSERVACIONES[ll_cont] = pds_atributos.object.OBSERVACIONES[1]
			end if
			
		end if
	next
end if

return ll_return


end function

public function long fw_actualiza_otras_indisp_apertura (datastore pds_atributos, datastore pds_indisponibilidades);
long ll_return = 0
long ll_cont, ll_rows, ll_rows_atributos, ll_activo
string ls_tipo_activo

ll_rows = pds_indisponibilidades.RowCount()
ll_rows_atributos = pds_atributos.RowCount()

if (ll_rows > 0) and (ll_rows_atributos > 0) then 
	
	for ll_cont = 1 to ll_rows
		
		ll_activo = pds_indisponibilidades.object.nro_instalacion[ll_cont]
		
		SELECT trim(TIPO_ACTIVO)
		  INTO :ls_tipo_activo
		  FROM SGD_INSTALACION_AT
		 WHERE NRO_INSTALACION = :ll_activo;
		
		// Los atributos de la maniobra deben heredarlo las indisponibilidades de los activos BAH$$HEX1$$cd00$$ENDHEX$$A
		if ls_tipo_activo = '1' then 		
		
			if not isnull (pds_atributos.object.DISPONIBILIDAD[1]) then 
				pds_indisponibilidades.object.DISPONIBILIDAD_ACT[ll_cont] = pds_atributos.object.DISPONIBILIDAD[1]
			end if
			
			if not isnull (pds_atributos.object.NUMERO[1]) then 
				pds_indisponibilidades.object.CONSIGNACION_NACIONAL[ll_cont] = pds_atributos.object.NUMERO[1]
			end if
			
			if not isnull (pds_atributos.object.DEMORA[1]) then 
				pds_indisponibilidades.object.DEMORA_JUSTIFICADA[ll_cont] = pds_atributos.object.DEMORA[1]
			end if
			
			if not isnull (pds_atributos.object.DESCRIPCION_DEMORA[1]) then 
				pds_indisponibilidades.object.DESCRIPCION_DEMORA[ll_cont] = pds_atributos.object.DESCRIPCION_DEMORA[1]
			end if
			
			if not isnull (pds_atributos.object.CONSIGNACION[1]) then 
				pds_indisponibilidades.object.CONSIGNACION_NAC_CHECK[ll_cont] = pds_atributos.object.CONSIGNACION[1]
			end if
			
			if not isnull (pds_atributos.object.tipo_PSM[1]) then 
				pds_indisponibilidades.object.PSM[ll_cont] = pds_atributos.object.tipo_PSM[1]
			end if
			
	//		if not isnull (pds_atributos.object.FUERA_PSM[1]) then 
	//			pds_indisponibilidades.object.FUERA_PSM[ll_cont] = pds_atributos.object.FUERA_PSM[1]
	//		end if
			
			if not isnull (pds_atributos.object.FECHA_INSTRUCCION_CND[1]) then 
				pds_indisponibilidades.object.TIEMPO_INSTRUCCION[ll_cont] = pds_atributos.object.FECHA_INSTRUCCION_CND[1]
			end if
			
			if not isnull (pds_atributos.object.FECHA_REPORTE_CND[1]) then 
				pds_indisponibilidades.object.TIEMPO_REPORTE[ll_cont] = pds_atributos.object.FECHA_REPORTE_CND[1]
			end if
			
			if not isnull (pds_atributos.object.TIPO_EVENTO[1]) then 
				pds_indisponibilidades.object.TIPO_REPORTE[ll_cont] = pds_atributos.object.TIPO_EVENTO[1]
			end if
			
			if not isnull (pds_atributos.object.FECHA_BYPASS[1]) then 
				pds_indisponibilidades.object.FECHA_BYPASS[ll_cont] = pds_atributos.object.FECHA_BYPASS[1]
			end if
			
			if not isnull (pds_atributos.object.CM_ACTIVO_CAUSANTE[1]) then 
				pds_indisponibilidades.object.CM_ACTIVO_CAUSANTE[ll_cont] = pds_atributos.object.CM_ACTIVO_CAUSANTE[1]
			end if
			
			if not isnull (pds_atributos.object.COD_CAUSA[1]) then 
				pds_indisponibilidades.object.COD_CAUSA[ll_cont] = pds_atributos.object.COD_CAUSA[1]
			end if
			
			if not isnull (pds_atributos.object.FEC_CAUSA[1]) then 
				pds_indisponibilidades.object.FECHA_CAUSA[ll_cont] = pds_atributos.object.FEC_CAUSA[1]
			end if
			
			if not isnull (pds_atributos.object.OBSERVACIONES[1]) then 
				pds_indisponibilidades.object.OBSERVACIONES[ll_cont] = pds_atributos.object.OBSERVACIONES[1]
			end if
			
		else
			
			if not isnull (pds_atributos.object.FECHA_INSTRUCCION_CND[1]) then 
				pds_indisponibilidades.object.TIEMPO_INSTRUCCION[ll_cont] = pds_atributos.object.FECHA_INSTRUCCION_CND[1]
			end if
			
			if not isnull (pds_atributos.object.FECHA_REPORTE_CND[1]) then 
				pds_indisponibilidades.object.TIEMPO_REPORTE[ll_cont] = pds_atributos.object.FECHA_REPORTE_CND[1]
			end if
			
			if not isnull (pds_atributos.object.TIPO_EVENTO[1]) then 
				pds_indisponibilidades.object.TIPO_REPORTE[ll_cont] = pds_atributos.object.TIPO_EVENTO[1]
			end if
						
			if not isnull (pds_atributos.object.CM_ACTIVO_CAUSANTE[1]) then 
				pds_indisponibilidades.object.CM_ACTIVO_CAUSANTE[ll_cont] = pds_atributos.object.CM_ACTIVO_CAUSANTE[1]
			end if
			
			if not isnull (pds_atributos.object.OBSERVACIONES[1]) then 
				pds_indisponibilidades.object.OBSERVACIONES[ll_cont] = pds_atributos.object.OBSERVACIONES[1]
			end if
			
		end if
	next
end if

return ll_return


end function

public function long fw_actualiza_otras_indisp_cierre (datastore pds_atributos, datastore pds_indisponibilidades);
long ll_return = 0
long ll_cont, ll_rows, ll_rows_atributos, ll_activo
string ls_tipo_activo

ll_rows = pds_indisponibilidades.RowCount()
ll_rows_atributos = pds_atributos.RowCount()

if (ll_rows > 0) and (ll_rows_atributos > 0) then 
	
	for ll_cont = 1 to ll_rows
				
		ll_activo = pds_indisponibilidades.object.nro_instalacion[ll_cont]
		
		SELECT trim(TIPO_ACTIVO)
		  INTO :ls_tipo_activo
		  FROM SGD_INSTALACION_AT
		 WHERE NRO_INSTALACION = :ll_activo;
		
		// Los atributos de la maniobra deben heredarlo las indisponibilidades de los activos BAH$$HEX1$$cd00$$ENDHEX$$A
		if ls_tipo_activo = '1'then 		
			if not isnull (pds_atributos.object.DISPONIBILIDAD[1]) then 
				pds_indisponibilidades.object.DISPONIBILIDAD_ACT_m_c[ll_cont] = pds_atributos.object.DISPONIBILIDAD[1]
			end if
			
			if not isnull (pds_atributos.object.NUMERO[1]) then 
				pds_indisponibilidades.object.CONSIGNACION_NACIONAL_m_c[ll_cont] = pds_atributos.object.NUMERO[1]
			end if
			
			if not isnull (pds_atributos.object.DEMORA[1]) then 
				pds_indisponibilidades.object.DEMORA_JUSTIFICADA_m_c[ll_cont] = pds_atributos.object.DEMORA[1]
			end if
			
			if not isnull (pds_atributos.object.DESCRIPCION_DEMORA[1]) then 
				pds_indisponibilidades.object.DESCRIPCION_DEMORA_m_c[ll_cont] = pds_atributos.object.DESCRIPCION_DEMORA[1]
			end if
			
			if not isnull (pds_atributos.object.CONSIGNACION[1]) then 
				pds_indisponibilidades.object.CONSIGNACION_NAC_CHECK_m_c[ll_cont] = pds_atributos.object.CONSIGNACION[1]
			end if
			
			if not isnull (pds_atributos.object.TIPO_PSM[1]) then 
				pds_indisponibilidades.object.PSM_m_c[ll_cont] = pds_atributos.object.TIPO_PSM[1]
			end if
			
	//		if not isnull (pds_atributos.object.FUERA_PSM[1]) then 
	//			pds_indisponibilidades.object.FUERA_PSM_m_c[ll_cont] = pds_atributos.object.FUERA_PSM[1]
	//		end if
			
			if not isnull (pds_atributos.object.FECHA_INSTRUCCION_CND[1]) then 
				pds_indisponibilidades.object.TIEMPO_INSTRUCCION_m_c[ll_cont] = pds_atributos.object.FECHA_INSTRUCCION_CND[1]
			end if
			
			if not isnull (pds_atributos.object.FECHA_REPORTE_CND[1]) then 
				pds_indisponibilidades.object.TIEMPO_REPORTE_m_c[ll_cont] = pds_atributos.object.FECHA_REPORTE_CND[1]
			end if
			
			if not isnull (pds_atributos.object.TIPO_EVENTO[1]) then 
				pds_indisponibilidades.object.TIPO_REPORTE_m_c[ll_cont] = pds_atributos.object.TIPO_EVENTO[1]
			end if
			
			if not isnull (pds_atributos.object.FECHA_BYPASS[1]) then 
				pds_indisponibilidades.object.FECHA_BYPASS_m_c[ll_cont] = pds_atributos.object.FECHA_BYPASS[1]
			end if
			
			if not isnull (pds_atributos.object.CM_ACTIVO_CAUSANTE[1]) then 
				pds_indisponibilidades.object.CM_ACTIVO_CAUSANTE_m_c[ll_cont] = pds_atributos.object.CM_ACTIVO_CAUSANTE[1]
			end if
			
			if not isnull (pds_atributos.object.COD_CAUSA[1]) then 
				pds_indisponibilidades.object.COD_CAUSA_m_c[ll_cont] = pds_atributos.object.COD_CAUSA[1]
			end if
			
			if not isnull (pds_atributos.object.FEC_CAUSA[1]) then 
				pds_indisponibilidades.object.FECHA_CAUSA_m_c[ll_cont] = pds_atributos.object.FEC_CAUSA[1]
			end if
			
			if not isnull (pds_atributos.object.OBSERVACIONES[1]) then 
				pds_indisponibilidades.object.OBSERVACIONES_m_c[ll_cont] = pds_atributos.object.OBSERVACIONES[1]
			end if
		
		else
			
			if not isnull (pds_atributos.object.FECHA_INSTRUCCION_CND[1]) then 
				pds_indisponibilidades.object.TIEMPO_INSTRUCCION_m_c[ll_cont] = pds_atributos.object.FECHA_INSTRUCCION_CND[1]
			end if
			
			if not isnull (pds_atributos.object.FECHA_REPORTE_CND[1]) then 
				pds_indisponibilidades.object.TIEMPO_REPORTE_m_c[ll_cont] = pds_atributos.object.FECHA_REPORTE_CND[1]
			end if
			
			if not isnull (pds_atributos.object.TIPO_EVENTO[1]) then 
				pds_indisponibilidades.object.TIPO_REPORTE_m_c[ll_cont] = pds_atributos.object.TIPO_EVENTO[1]
			end if
			
			if not isnull (pds_atributos.object.CM_ACTIVO_CAUSANTE[1]) then 
				pds_indisponibilidades.object.CM_ACTIVO_CAUSANTE_m_c[ll_cont] = pds_atributos.object.CM_ACTIVO_CAUSANTE[1]
			end if
			
			if not isnull (pds_atributos.object.OBSERVACIONES[1]) then 
				pds_indisponibilidades.object.OBSERVACIONES_m_c[ll_cont] = pds_atributos.object.OBSERVACIONES[1]
			end if
			
		end if
	next
end if

return ll_return

end function

public subroutine fw_actualiza_otras_indisponibilidades (long pl_cod_maniobra, datastore pds_atributos);

// Las modificaciones de una maniobra deben heredarse no solo por las indisponibilidades de la incidencia
// sino tambi$$HEX1$$e900$$ENDHEX$$n por las indisponibilidades asociadas a otras incidencias 

long ll_rows
string ls_filtro
datastore lds_otras_indisponibilidades

lds_otras_indisponibilidades = CREATE datastore
lds_otras_indisponibilidades.dataobject = 'd_otras_indisp_x_mapertura'
lds_otras_indisponibilidades.SetTransObject(SQLCA)

lds_otras_indisponibilidades.Retrieve(il_nro_incidencia, pl_cod_maniobra)

ls_filtro = 'maniobra_apertura = ' + string(pl_cod_maniobra)
lds_otras_indisponibilidades.SetFilter(ls_filtro)
lds_otras_indisponibilidades.Filter()

ll_rows = lds_otras_indisponibilidades.RowCount()

if ll_rows > 0 then 
	fw_actualiza_otras_indisp_apertura(pds_atributos, lds_otras_indisponibilidades)
end if

lds_otras_indisponibilidades.SetFilter("")
lds_otras_indisponibilidades.Filter()

ls_filtro = 'maniobra_cierre = ' + string(pl_cod_maniobra)
lds_otras_indisponibilidades.SetFilter(ls_filtro)
lds_otras_indisponibilidades.Filter()

ll_rows = lds_otras_indisponibilidades.RowCount()

if ll_rows > 0 then 
	fw_actualiza_otras_indisp_cierre(pds_atributos, lds_otras_indisponibilidades)
end if






DESTROY lds_otras_indisponibilidades


end subroutine

public function integer of_validarindisponibilidad (long pl_nroincidencia);/********************************************************************************/
/* Descripci$$HEX1$$f300$$ENDHEX$$n : valida si las disponibilidades est$$HEX1$$e100$$ENDHEX$$n rellenas.				     */
/*	Argumentos  :	pl_nroIncidencia -> n$$HEX1$$fa00$$ENDHEX$$mero de incidencia.							  */
/* Devuelve    :  1 correcto																	  */
/*					  -1 incorrecto																  */
/*					Autor					Fecha							Accion					  */
/*				  	 AHM             09/12/2009				  Creaci$$HEX1$$f300$$ENDHEX$$n					  */
/********************************************************************************/

long		ll_nroManiobras				// N$$HEX1$$fa00$$ENDHEX$$mero de maniobras asociadas a una disponibilidad
long		ll_nroIndisponibilidades	// N$$HEX1$$fa00$$ENDHEX$$mero de indisponibilidades

ll_nroManiobras = 0	
//SELECT count(*) 
//INTO   :ll_nroManiobras
//FROM   sgd_maniobra m, bdiv10_bahia_corte b 
//WHERE  m.cod_elemento = b.corte_open 
//		 AND b.onis_ver NOT LIKE '%.%' 
//		 AND b.onis_stat = 0 
//		 AND m.fecha_reporte_cnd IS NULL
//		 AND m.nro_incidencia = :pl_nroIncidencia;

SELECT count(*) 
INTO   :ll_nroIndisponibilidades
FROM   sgd_indisponibilidad m, bdiv10_activos b 
WHERE  m.nro_instalacion = b.codigo 
	    AND b.onis_ver NOT LIKE '%.%' 
		 AND b.onis_stat = 0 
		 AND (m.tiempo_reporte IS NULL OR m.tiempo_reporte_m_c IS NULL ) 
		 AND m.nro_incidencia = :pl_nroIncidencia;
		 
IF ll_nroManiobras > 0 OR ll_nroIndisponibilidades > 0 THEN
	RETURN -1
ELSE
	RETURN 1
END IF
end function

public function integer of_validacionessolicitudmant ();/***************************************************************************************/
/* Descripci$$HEX1$$f300$$ENDHEX$$n : Realiza las validaciones que faltan (resoluci$$HEX1$$f300$$ENDHEX$$n de la incidencia) 		*/
/*					  para el env$$HEX1$$ed00$$ENDHEX$$o de la incidencia a mantenimiento.								*/
/*	Par$$HEX1$$e100$$ENDHEX$$metros	: -																							*/
/*	Devoluci$$HEX1$$f300$$ENDHEX$$n	:  1 OK																						*/
/*					  -1 KO																						*/
/*						Autor						Fecha							Acci$$HEX1$$f300$$ENDHEX$$n						*/
/*						 AHM					 02/11/2011					  Creaci$$HEX1$$f300$$ENDHEX$$n						*/
/***************************************************************************************/
long		ll_agente				//Agente seleccinado en la pesta$$HEX1$$f100$$ENDHEX$$a OTROS

//Validaci$$HEX1$$f300$$ENDHEX$$n de la instalaci$$HEX1$$f300$$ENDHEX$$n origen 
IF ii_tipo_incid <> fgci_incidencia_programada AND (tabpage_formulario.d_inf_general.getitemnumber(1,"instalacion_origen") < 1 &
				OR isnull(tabpage_formulario.d_inf_general.getitemnumber(1,"instalacion_origen"))) THEN				
	IF NOT iw_contenedora.fw_incidencia_de_operaciones() THEN
		gnv_msg.f_mensaje("AI140","","",OK!)
		RETURN -1				
	END IF
END IF


//Validaci$$HEX1$$f300$$ENDHEX$$n del agente
ll_agente=tabpage_otros.dw_otros.getitemnumber(1,'agente')
if  fg_verifica_parametro ('SELEC_AGENTE') AND &
	(ll_agente = 0 OR isnull(ll_agente)) THEN
	messagebox("Atenci$$HEX1$$f300$$ENDHEX$$n", "Seleccione campo agente")
	RETURN -1
END IF

//Validaci$$HEX1$$f300$$ENDHEX$$n de la indisponibilidades
IF fg_verifica_parametro("indisponibilidades activas") THEN
	IF tabpage_indisponibilidades.dw_lista_indisponibilidades.find("isnull(f_reposicion_origen)" , 1, tabpage_indisponibilidades.dw_lista_indisponibilidades.RowCount()) > 0 THEN
		messagebox("Atenci$$HEX1$$f300$$ENDHEX$$n", "Hay indisponibilidades abiertas")
		RETURN -1 
	END IF

	IF of_validarIndisponibilidad(il_nro_incidencia) = -1 THEN
		messagebox("Atenci$$HEX1$$f300$$ENDHEX$$n", "No se ha rellenado la informaci$$HEX1$$f300$$ENDHEX$$n de las indisponibilidades")
		RETURN -1
	END IF	
END IF

RETURN 1
end function

public function boolean frn_evaluo_f_elim_peligro ();//////////////////////////////////////////////////////////
//
// Funci$$HEX1$$f300$$ENDHEX$$n: frn_evaluo_f_elim_peligro
//
// Objetivo: Evalua fecha de detecci$$HEX1$$f300$$ENDHEX$$n.
//
// Ambito: P$$HEX1$$fa00$$ENDHEX$$blico
//
// Par$$HEX1$$e100$$ENDHEX$$metros:
//        Entrada: pd_dw, pdt_fec_ant
//        Salida : --
//
// Devuelve: 
//
// Fecha		   Responsable		Actuaci$$HEX1$$f300$$ENDHEX$$n
// -----	 	   -----------		---------
//08/09/2013	LSH				DEO12-00000263
//
///////////////////////////////////////////////////////////
//LSH INI 08/09/2013 evolutivo DEO12-00000263
datetime ld_f_elim
datetime ld_f_det
datetime ld_gen_max

ld_f_elim=tabpage_formulario.d_inf_general.getitemdatetime(1,'f_elim_peligro')
ld_f_det=tabpage_formulario.d_inf_general.getitemdatetime(1,'f_deteccion')
ld_gen_max = datetime(RelativeDate(date(ld_f_det), 3) , time(ld_f_det))

if ld_f_elim < ld_f_det and not isnull(ld_f_elim) then
	messagebox("Atenci$$HEX1$$f300$$ENDHEX$$n","La fecha de eliminaci$$HEX1$$f300$$ENDHEX$$n de peligro no debe ser menor que la fecha de detecci$$HEX1$$f300$$ENDHEX$$n", Exclamation!)
	tabpage_formulario.d_inf_general.SetItem(1,'f_elim_peligro', idt_fec_elim_peligro)
	tabpage_formulario.d_inf_general.Accepttext()
	return false	
end if

if ld_f_elim > ld_gen_max and not isnull(ld_f_elim) then
	messagebox("Atenci$$HEX1$$f300$$ENDHEX$$n","La fecha de eliminaci$$HEX1$$f300$$ENDHEX$$n de peligro no debe sobrepasar 3 dias despues de la fecha de detecci$$HEX1$$f300$$ENDHEX$$n.", Exclamation!)
	tabpage_formulario.d_inf_general.SetItem(1,'f_elim_peligro', idt_fec_elim_peligro)
	tabpage_formulario.d_inf_general.Accepttext()
	return false
end if

idt_fec_elim_peligro=ld_f_elim

return true
//LSH FIN 08/09/2013 evolutivo DEO12-00000263
end function

on u_tab_2301_form_incidencias.create
this.tabpage_formulario=create tabpage_formulario
this.tabpage_observaciones=create tabpage_observaciones
this.tabpage_ot=create tabpage_ot
this.tabpage_cuadrillas=create tabpage_cuadrillas
this.tabpage_interrupciones=create tabpage_interrupciones
this.tabpage_seguimiento=create tabpage_seguimiento
this.tabpage_acciones=create tabpage_acciones
this.tabpage_maniobras=create tabpage_maniobras
this.tabpage_indisponibilidades=create tabpage_indisponibilidades
this.tabpage_otros=create tabpage_otros
this.tabpage_ocen=create tabpage_ocen
this.Control[]={this.tabpage_formulario,&
this.tabpage_observaciones,&
this.tabpage_ot,&
this.tabpage_cuadrillas,&
this.tabpage_interrupciones,&
this.tabpage_seguimiento,&
this.tabpage_acciones,&
this.tabpage_maniobras,&
this.tabpage_indisponibilidades,&
this.tabpage_otros,&
this.tabpage_ocen}
end on

on u_tab_2301_form_incidencias.destroy
destroy(this.tabpage_formulario)
destroy(this.tabpage_observaciones)
destroy(this.tabpage_ot)
destroy(this.tabpage_cuadrillas)
destroy(this.tabpage_interrupciones)
destroy(this.tabpage_seguimiento)
destroy(this.tabpage_acciones)
destroy(this.tabpage_maniobras)
destroy(this.tabpage_indisponibilidades)
destroy(this.tabpage_otros)
destroy(this.tabpage_ocen)
end on

event selectionchanged;//string ls_estado_op
int li_count,li_count2,li_error
f_changed(oldindex,newindex)
ii_indice=newindex

if This.control[newindex]=tabpage_ot then	// El formulario 
	//LSH INI 02/10/2013 evolutivo DEO12-00000263
	IF iw_contenedora.lu_comunic.is_comunic.accion_llamada = "Consulta" THEN
		IF date(idt_fec_elim_peligro) <> date("01/01/1900") THEN
			tabpage_ot.d_datos_ot.SetItem(1,"f_elim_peligro", idt_fec_elim_peligro)
		END IF
		tabpage_ot.d_datos_ot.Modify("f_elim_peligro.protect=1")
		tabpage_ot.d_datos_ot.Modify("f_elim_peligro.background.color="+gs_gris)
	ELSE
		IF ii_estado_oper = fgci_incidencia_resuelta THEN
			IF date(idt_fec_elim_peligro) <> date("01/01/1900") THEN
				tabpage_ot.d_datos_ot.SetItem(1,"f_elim_peligro", idt_fec_elim_peligro)
			END IF
			tabpage_ot.d_datos_ot.Modify("f_elim_peligro.protect=1")
			tabpage_ot.d_datos_ot.Modify("f_elim_peligro.background.color="+gs_gris)
		ELSE
			IF date(idt_fec_elim_peligro) <> date("01/01/1900") THEN
				tabpage_ot.d_datos_ot.SetItem(1,"f_elim_peligro", idt_fec_elim_peligro)
			END IF
//			tabpage_ot.d_datos_ot.Modify("f_elim_peligro.protect=0")
//			tabpage_ot.d_datos_ot.Modify("f_elim_peligro.background.color="+gs_blanco)			
		END IF
	END IF
	//LSH FIN 02/10/2013 evolutivo DEO12-00000263
	if ii_estado_oper>=fgci_incidencia_enviado_brigada then
		for li_count=1 to tabpage_ot.d_lista_brigadas_ot.rowcount()
			for li_count2= 1 to tabpage_ot.tab_lista_brigadas.tabpage_no_disponibles.dw_brigadas_no_disponibles.rowcount()
				if  tabpage_ot.d_lista_brigadas_ot.getitemstring(li_count,"brigada")= &
					tabpage_ot.tab_lista_brigadas.tabpage_no_disponibles.dw_brigadas_no_disponibles.getitemstring(li_count2,"brigada") then
					li_error=tabpage_ot.tab_lista_brigadas.tabpage_no_disponibles.dw_brigadas_no_disponibles.setitem(li_count2,"gi_incidencia_est_actual",ii_estado_oper)
				end if
			next
		next
	end if
end if

if this.control[newindex]=tabpage_ocen then
	tabpage_ocen.uo_ot_ocen.il_incidencia_nro=il_nro_incidencia
	tabpage_ocen.uo_ot_ocen.ii_estado_incidencia=ii_estado_oper
	tabpage_ocen.uo_ot_ocen.il_validacion=fnu_valida_sr()
	tabpage_ocen.uo_ot_ocen.iw_contenedora = iw_contenedora
	tabpage_ocen.uo_ot_ocen.is_descripcion=tabpage_formulario.d_inf_general.getitemstring(1,"desc")   
	//AHM(20/10/2011) Integraci$$HEX1$$f300$$ENDHEX$$n OSGI - OSGM
   tabpage_ocen.uo_ot_ocen.il_nro_instalacion=idec_nro_instalacion_afectada
	tabpage_ocen.uo_ot_ocen.sle_instalacion.text = string(idec_nro_instalacion_afectada)
	//21/10/2008 YAF
	//tabpage_ocen.uo_ot_ocen.il_nro_instalacion=tabpage_formulario.d_inf_general.getitemnumber(1,"instalacion_origen")
	//
	tabpage_ocen.uo_ot_ocen.triggerEvent("ue_carga_datos")
end if
end event

event selectionchanging;IF f_changing(oldindex,newindex) = -1 THEN
	Return 1
END IF
ii_viejo_index=newindex
end event

event constructor;//  Fecha         Responsable   Actuaci$$HEX1$$f300$$ENDHEX$$n
// ---------    -------         ----------------------------------------
// 23/02/2000     DSA				Introducir las contratas

//inicializa las variables de tipo fecha en nulo para que cuando se cargan 
//en el tabpage de incidencias no d$$HEX2$$e9002000$$ENDHEX$$problemas
//en la correlativilidad de las fechas

datawindowchild ddw_tipo_brigada
//comentario
//operaciones
setNull(idt_fecha_pt_pex)
setNull(idt_fec_deteccion)
setNull(idt_fecha_eb)
setNull(idt_fecha_cl)
setNull(idt_fecha_er)
setNull(idt_fecha_sr)
setNull(idt_fecha_resuelta)
setnull(idt_fecha_nueva_repos)

//mantenimiento
setNull( idt_fecha_st_mant)
setNull(idt_fecha_eb_mant )
setNull( idt_fecha_al_mant)
setNull( idt_fecha_rp_mant)
setNull( idt_fecha_pr_mant)
setNull( idt_fecha_rm_mant)

//	Se establece conecci$$HEX1$$f300$$ENDHEX$$n con la Base de Datos 
//	para todas las datawindows del tabpage

tabpage_cuadrillas.visible=false  //TDA Mejora 10-01-2019
tabpage_ocen.visible=false        //TDA Mejora 10-01-2019


//los Datawindow los comente para poder optimizar la ventana y que se hagan los SetTransObject(SQLCA) en el
//constructor de los datawindows correspondientes
//tabpage_formulario.dw_1.SetTransObject(SQLCA)
//tabpage_formulario.dw_2.SetTransObject(SQLCA)
//tabpage_formulario.dw_3.SetTransObject(SQLCA)
//tabpage_formulario.d_inf_general.SetTransObject(SQLCA)
//tabpage_formulario.dw_detalle_interr.SetTransObject(SQLCA)
//tabpage_ot.d_lista_brigadas_ot.SetTransObject(SQLCA)

//tabpage_ot.d_datos_ot.SetTransObject(SQLCA)
//tabpage_cuadrillas.d_materiales.SetTransObject(SQLCA) 
tabpage_interrupciones.d_datos_interrup.SetTransObject(SQLCA)
tabpage_interrupciones.d_lista_otras_inst.SetTransObject(SQLCA)
tabpage_interrupciones.dw_lista_int_comunes.SetTransObject(SQLCA)
tabpage_interrupciones.dw_lista_int_operaciones.SetTransObject(SQLCA)
tabpage_interrupciones.dw_lista_acometidas.SetTransObject(SQLCA)
tabpage_interrupciones.d_lista_otras_inst_ant.SetTransObject(SQLCA)
IF fg_verifica_parametro('AFEC_PARCIAL_SUM') THEN
	tabpage_interrupciones.dw_afec_parcial_sum.SetTransObject(SQLCA)
END IF
tabpage_seguimiento.d_seguimiento_operaciones.SetTransObject(SQLCA)
tabpage_seguimiento.d_seguimiento_mantenimiento.SetTransObject(SQLCA)
tabpage_acciones.d_lista_acciones_incidencia.SetTransObject(SQLCA)
tabpage_acciones.d_lista_acciones.SetTransObject(SQLCA)
//tabpage_ot.tab_lista_brigadas.tabpage_disponibles.dw_brigadas_disponibles.SetTransObject(SQLCA)
//tabpage_ot.tab_lista_brigadas.tabpage_no_disponibles.dw_brigadas_no_disponibles.SetTransObject(SQLCA)


if gb_ole = true then
	tabpage_observaciones.cb_2.visible = true
	tabpage_observaciones.cb_14.visible = true
	tabpage_observaciones.ole_1.visible = true
	tabpage_observaciones.mle_observaciones.visible = false
else
	tabpage_observaciones.cb_2.visible = false
	tabpage_observaciones.cb_14.visible = false
	tabpage_observaciones.ole_1.visible = false
	tabpage_observaciones.mle_observaciones.visible = true

end if


iu_filtro = Create u_gen_0000_nu_filtro;                   // DSA 23/02/2000

gu_control_v_incidencias.of_recupera_padre(iw_contenedora,this,"w_2301_form_incidencia")

tabpage_ot.dw_ambito.fpr_crea_dddw()
tabpage_ot.dw_ambito.f_insertar_fila()
tabpage_ot.dw_ambito.fnu_insertar_datos(gi_nro_centro, gi_nro_cmd, gi_nro_puesto, 0)
tabpage_ot.dw_ambito.AcceptText()

//***************************************
//**  OSGI 2001.1  	15/05/2001			**
//**  Jair Padilla / Soluziona PANAMA  **
//***************************************
ib_pestana_otros = fg_verifica_parametro('pestana_otros')
ib_nuevos_tip_inc = fg_verifica_parametro('nuevos_tip_inc')
ib_pxt_cxt = fg_verifica_parametro('pxt_cxt') 


/////////////////////////////////////////////////////////////
// AFECTACION PARCIAL VERSION UNIFICADA AMR 07/08/2002
////////////////////////////////////////////////////////////
//ib_afect_parcial = fg_verifica_parametro('afect_parcial')

ii_tipo_inst = fg_inst_afec_parcial()

ib_afect_parcial = ii_tipo_inst > 0  

/////////////////////////////////////////////////////////////

If ib_pestana_otros Then
	//tabpage_otros.Visible = True
	 tabpage_otros.visible=false        //TDA Mejora 10-01-2019
End If

If ib_pxt_cxt And Lower(Parent.ClassName()) <> 'w_2301_form_incidencia' Then
	tabpage_formulario.st_pxt_t.Visible = True
	tabpage_formulario.st_pxt_valor.Visible = True
	tabpage_formulario.st_cxt_t.Visible = True
	tabpage_formulario.st_cxt_valor.Visible = True
Else
	tabpage_formulario.st_pxt_t.Visible = False
	tabpage_formulario.st_pxt_valor.Visible = False
	tabpage_formulario.st_cxt_t.Visible = False
	tabpage_formulario.st_cxt_valor.Visible = False
End If
//***************************************
//**  OSGI 2001.1  	15/05/2001			**
//**  Jair Padilla / Soluziona PANAMA  **
//***************************************

tabpage_ot.d_crit_seleccion.GetChild('pi_tipo_brig', ddw_tipo_brigada)
ddw_tipo_brigada.SetTransObject(sqlca)
ddw_tipo_brigada.Retrieve()

tabpage_ot.d_crit_seleccion.InsertRow(0)
tabpage_ot.d_crit_seleccion.SetItem(1,"pi_brigadas_en_turno",1)
tabpage_ot.d_crit_seleccion.SetItem(1,"pi_tipo_brig",1)


//NCA-INICIO.DDAG-2482.20150612.La pdt_fecha_turno la obtenemos de la funcion que trae la fecha actual con segundos.
tabpage_ot.d_crit_seleccion.SetItem(1,"pdt_fecha_turno", fgnu_fecha_actual_con_seg())
//NCA-FIN.DDAG-2482.20150612.

tabpage_ot.d_crit_seleccion.accepttext()

//if gb_operaciones_inst then
//	il_inst_dig[] = gu_rf.il_instalaciones[]
//	ii_resul_dig = gu_rf.ii_resultado
//end if

//Comentario

//SRE
//AHM(07/09/2011) Integraci$$HEX1$$f300$$ENDHEX$$n OSGI - OSGM
IF fg_valor_parametro("OCEN")=1 THEN
	tabpage_ocen.visible=TRUE
	//AHU Mostrar estado ocen
	tabpage_formulario.d_inf_general.object.gb_3.height = string(218)
ELSEIF gb_interfaseOsgm THEN 	//Est$$HEX2$$e1002000$$ENDHEX$$activo el par$$HEX1$$e100$$ENDHEX$$metro del OSGM
	
	//Hace visible y cambia el texto del tabpage
	tabpage_ocen.visible=TRUE
	tabpage_ocen.Text = "OSGM"
	tabpage_ocen.uo_ot_ocen.cb_peticion.text = 'Enviar Mant.'
	
	//Hace invisible el sevicio ejecutor y el bot$$HEX1$$f300$$ENDHEX$$n de borrado
	tabpage_ocen.uo_ot_ocen.dw_servicios.visible = FALSE
	tabpage_ocen.uo_ot_ocen.st_3.visible = FALSE
	tabpage_ocen.uo_ot_ocen.cb_borrar.visible = FALSE
	
	//Cargamos el datawindow de la solicitud OSGM en vez del dw de OCEN
	tabpage_ocen.uo_ot_ocen.dw_ot_ocen.dataObject = "d_datos_solicitud_mantenimiento"
	
	//Redimensiona el tama$$HEX1$$f100$$ENDHEX$$o del grupo de los estados de la incidencia
	tabpage_formulario.d_inf_general.object.gb_3.height = string(218)
	
ELSE
	tabpage_ocen.visible=FALSE
	//AHU Mostrar estado ocen
	tabpage_formulario.d_inf_general.object.estado_mantenimiento.visible = FALSE
	tabpage_formulario.d_inf_general.object.estado_mantenimiento_t.visible = FALSE
END IF

end event

event clicked;ib_open = False
end event

type tabpage_formulario from userobject within u_tab_2301_form_incidencias
event create ( )
event destroy ( )
integer x = 18
integer y = 112
integer width = 5527
integer height = 3872
integer taborder = 10
long backcolor = 79741120
string text = "Incidencia"
long tabtextcolor = 33554432
long tabbackcolor = 79741120
string picturename = "Watcom!"
long picturemaskcolor = 553648127
dw_informe_tecnico dw_informe_tecnico
st_18 st_18
st_cxt_valor st_cxt_valor
st_cxt_t st_cxt_t
st_pxt_valor st_pxt_valor
st_pxt_t st_pxt_t
st_pxt_cxt_fondo st_pxt_cxt_fondo
dw_3 dw_3
dw_1 dw_1
dw_detalle_interr dw_detalle_interr
cbx_blackout cbx_blackout
dw_2 dw_2
st_2 st_2
st_1 st_1
d_inf_general d_inf_general
st_fases st_fases
gb_3 gb_3
end type

on tabpage_formulario.create
this.dw_informe_tecnico=create dw_informe_tecnico
this.st_18=create st_18
this.st_cxt_valor=create st_cxt_valor
this.st_cxt_t=create st_cxt_t
this.st_pxt_valor=create st_pxt_valor
this.st_pxt_t=create st_pxt_t
this.st_pxt_cxt_fondo=create st_pxt_cxt_fondo
this.dw_3=create dw_3
this.dw_1=create dw_1
this.dw_detalle_interr=create dw_detalle_interr
this.cbx_blackout=create cbx_blackout
this.dw_2=create dw_2
this.st_2=create st_2
this.st_1=create st_1
this.d_inf_general=create d_inf_general
this.st_fases=create st_fases
this.gb_3=create gb_3
this.Control[]={this.dw_informe_tecnico,&
this.st_18,&
this.st_cxt_valor,&
this.st_cxt_t,&
this.st_pxt_valor,&
this.st_pxt_t,&
this.st_pxt_cxt_fondo,&
this.dw_3,&
this.dw_1,&
this.dw_detalle_interr,&
this.cbx_blackout,&
this.dw_2,&
this.st_2,&
this.st_1,&
this.d_inf_general,&
this.st_fases,&
this.gb_3}
end on

on tabpage_formulario.destroy
destroy(this.dw_informe_tecnico)
destroy(this.st_18)
destroy(this.st_cxt_valor)
destroy(this.st_cxt_t)
destroy(this.st_pxt_valor)
destroy(this.st_pxt_t)
destroy(this.st_pxt_cxt_fondo)
destroy(this.dw_3)
destroy(this.dw_1)
destroy(this.dw_detalle_interr)
destroy(this.cbx_blackout)
destroy(this.dw_2)
destroy(this.st_2)
destroy(this.st_1)
destroy(this.d_inf_general)
destroy(this.st_fases)
destroy(this.gb_3)
end on

type dw_informe_tecnico from datawindow within tabpage_formulario
integer x = 3835
integer y = 96
integer width = 1586
integer height = 968
integer taborder = 60
string title = "none"
string dataobject = "d_inc_2051_otros"
boolean livescroll = true
borderstyle borderstyle = stylelowered!
end type

type st_18 from statictext within tabpage_formulario
boolean visible = false
integer x = 1925
integer y = 960
integer width = 402
integer height = 64
integer textsize = -10
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
boolean italic = true
boolean underline = true
long textcolor = 128
long backcolor = 81324524
string text = "Sub-Causa :"
boolean focusrectangle = false
end type

event clicked;//VMC.INI.DDAG-6453.14/07/2016
integer li_cod_causa, li_cod_causa_subtipo, li_hay_subcausa
string ls_descripcion_causa, ls_desc_subtipo

ls_descripcion_causa = tabpage_formulario.d_inf_general.object.st_causa.text

	

select cod_causa 
	into :li_cod_causa 
from gi_causa 
	where descripcion = :ls_descripcion_causa;
	
	
	
if isnull(ls_descripcion_causa) or ls_descripcion_causa = '' then
	messagebox("Atenci$$HEX1$$f300$$ENDHEX$$n", "Primero debe escoger una causa de la incidencia")
	return
end if	

select count(*) into :li_hay_subcausa from gi_causa_subtipo where cod_causa = :li_cod_causa;
if li_hay_subcausa = 0 then
	messagebox("Atenci$$HEX1$$f300$$ENDHEX$$n", "Esta causa no tiene una subcausa asignada")
	return
end if	

OpenWithParm(w_2301_sel_causa_subtipo,string(li_cod_causa))


IF  (Message.StringParm <> ' ') then
	ls_desc_subtipo = Message.StringParm
end if

if ls_desc_subtipo <> ' ' and not isnull(ls_desc_subtipo) then
	tabpage_formulario.d_inf_general.object.st_causa_subtipo.text = ls_desc_subtipo 
	
	select cod_causa_subtipo 
		into :li_cod_causa_subtipo 
	from gi_causa_subtipo 
		where descripcion = :ls_desc_subtipo;
		
		
	
	d_inf_general.setitem(1,"causa_subtipo",li_cod_causa_subtipo )
	
	
end if
//VMC.FIN.DDAG-6453.14/07/2016




end event

type st_cxt_valor from statictext within tabpage_formulario
boolean visible = false
integer x = 1376
integer y = 1840
integer width = 270
integer height = 76
integer textsize = -8
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "MS Sans Serif"
long textcolor = 8388608
long backcolor = 16777215
boolean enabled = false
string text = "0.0"
boolean border = true
borderstyle borderstyle = stylelowered!
boolean focusrectangle = false
end type

type st_cxt_t from statictext within tabpage_formulario
boolean visible = false
integer x = 855
integer y = 1852
integer width = 521
integer height = 60
integer textsize = -8
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "MS Sans Serif"
long textcolor = 33554432
long backcolor = 67108864
boolean enabled = false
string text = "Clientes x Tiempo:"
boolean focusrectangle = false
end type

type st_pxt_valor from statictext within tabpage_formulario
boolean visible = false
integer x = 576
integer y = 1840
integer width = 270
integer height = 76
integer textsize = -8
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "MS Sans Serif"
long textcolor = 8388608
long backcolor = 16777215
boolean enabled = false
string text = "0.0"
boolean border = true
borderstyle borderstyle = stylelowered!
boolean focusrectangle = false
end type

type st_pxt_t from statictext within tabpage_formulario
boolean visible = false
integer x = 37
integer y = 1852
integer width = 544
integer height = 60
integer textsize = -8
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "MS Sans Serif"
long textcolor = 33554432
long backcolor = 67108864
boolean enabled = false
string text = "Potencia x Tiempo:"
boolean focusrectangle = false
end type

type st_pxt_cxt_fondo from statictext within tabpage_formulario
boolean visible = false
integer x = 23
integer y = 1836
integer width = 1641
integer height = 88
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "MS Sans Serif"
long textcolor = 33554432
long backcolor = 67108864
boolean enabled = false
boolean border = true
borderstyle borderstyle = styleraised!
boolean focusrectangle = false
end type

type dw_3 from datawindow within tabpage_formulario
boolean visible = false
integer x = 2939
integer y = 1500
integer width = 494
integer height = 360
integer taborder = 15
string dataobject = "d_2301_graf_cli_afec"
boolean livescroll = true
borderstyle borderstyle = stylelowered!
end type

event retrieveend;if rowcount = 0 then
	this.visible = false
else
	this.visible = true
end if
end event

event doubleclicked;Setpointer(HourGlass!)

if this.width = 494 then
	// Amplia
	this.setredraw(false)
	this.x = 2190
	this.y = 750
	this.width = 1239
	this.height = 880
	this.show()
	this.setredraw(true)
else
	// Reduce
	this.x = 2935
	this.y = 1200
	this.width = 494
	this.height = 360
	this.show()
	dw_1.show()
	dw_2.show()
end if


end event

event constructor;this.SetTransObject(SQLCA)
end event

type dw_1 from datawindow within tabpage_formulario
boolean visible = false
integer x = 1829
integer y = 1496
integer width = 494
integer height = 360
integer taborder = 40
string dataobject = "d_2301_graf_prop"
boolean livescroll = true
borderstyle borderstyle = stylelowered!
end type

event retrieveend;if rowcount = 0 then
	this.visible = false
else
	this.visible = true
end if
end event

event doubleclicked;Setpointer(HourGlass!)

if this.width = 494 then

	// Amplia
	this.setredraw(false)
	this.x = 1083
	this.y = 750
	this.width = 1239
	this.height = 880
	this.show()
	this.setredraw(true)
else
	// Reduce
	this.x = 1829
	this.y = 1200
	this.width = 494
	this.height = 360
	this.show()
	dw_2.show()
	dw_3.show()
end if


end event

event constructor;this.SetTransObject(SQLCA)
end event

type dw_detalle_interr from u_inc_2005_pr_detalle_interrup within tabpage_formulario
boolean visible = false
integer x = 23
integer y = 1472
integer width = 1641
integer height = 360
integer taborder = 3
boolean livescroll = false
borderstyle borderstyle = styleraised!
end type

event constructor;call super::constructor;this.SetTransObject(SQLCA)
end event

type cbx_blackout from checkbox within tabpage_formulario
event clicked pbm_bnclicked
boolean visible = false
integer x = 2734
integer y = 192
integer width = 430
integer height = 72
boolean bringtotop = true
integer textsize = -10
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 255
long backcolor = 81324524
string text = "BLACKOUT"
end type

event clicked;//SetPointer(HourGlass!)
//
//Parent.SetRedraw(False)
//md_ingreso_incidencias lm_menu
//lm_menu= iw_contenedora.menuid
//IF This.Checked = True THEN
//
//	iu_id_instalacion.is_comunic.intval1 = gi_nro_centro
//	iu_id_instalacion.is_comunic.intval2 = gi_nro_cmd
//	iu_id_instalacion.is_comunic.intval3 = gi_nro_puesto
//
//	iu_id_instalacion.is_comunic.decval1 = fgcdec_aviso_con_alimentacion
//	iu_id_instalacion.is_comunic.decval2 = 0
//
//	iu_id_instalacion.is_comunic.intval4 = 0
//  	iu_id_instalacion.is_comunic.intval5 = 0
//	iu_id_instalacion.is_comunic.intval6 = 2				// Media Tensi$$HEX1$$f300$$ENDHEX$$n
//	iu_id_instalacion.is_comunic.strval1 = ""
//	iu_id_instalacion.is_comunic.strval2 = "Con Alimentaci$$HEX1$$f300$$ENDHEX$$n"
//	iu_id_instalacion.is_comunic.strval10 = "BlackOut"
//      
//	iu_id_instalacion.is_comunic.longval1 = 0				//il_pot_inst
//	iu_id_instalacion.is_comunic.longval2 = 0				//il_pot_contr
//	iu_id_instalacion.is_comunic.longval3 = 0				//il_cant_cli
//	iu_id_instalacion.is_comunic.longval4 = 0				//il_nro_aco
//
//	d_inf_general.SetItem(1,"nombre_ins",fgcdec_aviso_con_alimentacion)
//
//	Parent.fnu_m_accion_perfil_pactivate_ins_afect(il_ult_inc)
//
//	ii_co_nivel = 0										//iu_id_instalacion.is_comunic.intval5
//	d_inf_general.SetColumn("f_deteccion")		
//
//	d_inf_general.SetItem(1,"co_nivel",ii_co_nivel)		
//	d_inf_general.SetItem(1,"nro_centro",gi_nro_centro)
//	d_inf_general.SetItem(1,"nro_cmd",gi_nro_cmd)
//	d_inf_general.SetItem(1,"nro_mesa",gi_nro_puesto)
//	d_inf_general.modify("tipo_incidencia.protect=1")
//	d_inf_general.modify("tipo_incidencia.background.color="+gs_gris)
//
//	ib_hubo_cambios=TRUE	
//ELSEIF This.Checked = False THEN
//
//	string ls_nulo
//	decimal{0} ldec_nulo
//
//	SetNull(ls_nulo)
//	SetNull(ldec_nulo)
//
//	fgnu_resetear_s_comunicaciones(iu_id_instalacion)
//
//	d_inf_general.SetItem(1,"nombre_ins",ldec_nulo)
//	d_inf_general.SetItem(1,"nombre_instalacion",ls_nulo)
//	d_inf_general.SetItem(1,"nomb_tipo",ls_nulo)
//	d_inf_general.modify("tipo_incidencia.protect=1")
//	d_inf_general.modify("tipo_incidencia.background.color="+gs_gris)
//	iu_inc_2003_rn.frn_ini_campos_por_defecto(d_inf_general,lu_comunic)
//	iu_inc_2003_rn.fnu_ini_centros_alta(d_inf_general)
//
//	Parent.fnu_m_accion_perfil_pactivate_ins_afect(il_ult_inc)
//

//END IF
//
//frn_habilitar_opciones_menu(lu_comunic.is_comunic.accion_llamada)
//
////IF This.Checked = True THEN
////	lm_menu.m_consultar.m_instalacionafectada.Enabled = False
////ELSEIF This.Checked = True THEN
////	lm_menu.m_consultar.m_instalacionafectada.Enabled = True
////END IF
//
//fnu_resetear_var_comunicaciones()
//

//Parent.SetRedraw(True)
//
//

end event

type dw_2 from datawindow within tabpage_formulario
boolean visible = false
integer x = 2386
integer y = 1500
integer width = 494
integer height = 360
integer taborder = 15
boolean bringtotop = true
string dataobject = "d_2301_graf_pot_cont"
boolean livescroll = true
borderstyle borderstyle = stylelowered!
end type

event retrieveend;if rowcount = 0 then
	this.visible = false
else
	this.visible = true
end if
end event

event doubleclicked;Setpointer(HourGlass!)



if this.width = 494 then
	// Amplia
	this.setredraw(false)
	this.x = 1637
	this.y = 750	
	this.width = 1239
	this.height = 880
	this.show()
	this.setredraw(true)
else
	// Reduce
	this.x = 2382
	this.y = 1200
	this.width = 494
	this.height = 360
	this.show()	
	dw_1.show()
	dw_3.show()
end if


end event

event constructor;this.SetTransObject(SQLCA)
end event

type st_2 from statictext within tabpage_formulario
boolean visible = false
integer x = 1751
integer y = 1056
integer width = 443
integer height = 76
integer textsize = -10
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
boolean italic = true
boolean underline = true
string pointer = "mano.cur"
long textcolor = 128
long backcolor = 67108864
string text = "Mat, Averiado :"
boolean focusrectangle = false
end type

event clicked;string ls_codigo
string ls_descripcion

Open(w_2401_ayuda_materiales)
ls_codigo = gu_comunic.is_comunic.strval1
ls_descripcion = gu_comunic.is_comunic.strval2


IF Len(Trim(ls_codigo)) > 0 THEN
	d_inf_general.setitem(1,"material_averiado",ls_codigo)
	d_inf_general.object.st_mat_averiado.text = ls_descripcion
end if





end event

type st_1 from statictext within tabpage_formulario
boolean visible = false
integer x = 1929
integer y = 868
integer width = 233
integer height = 76
integer textsize = -10
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
boolean italic = true
boolean underline = true
string pointer = "mano.cur"
long textcolor = 128
long backcolor = 81324524
string text = "Causa :"
boolean focusrectangle = false
end type

event doubleclicked;md_ingreso_incidencias lm_menu
long		ll_agenteCausa	

setpointer(HourGlass!)
lm_menu= iw_contenedora.menuid


//***************************************
//**  OSGI 2001.1  	16/08/2001			**
//**  Jair Padilla / Soluziona PANAMA  **
//***************************************
//**  OSGI 2001.1  	16/05/2001  open(w_2301_sel_causa)

If fg_verifica_parametro('CAUSAS') Then
	//*****************************************
	//**  OSGI 2001.2  	20/11/2002			  **
	//**  Jair Padilla / Soluziona PANAMA    **
	//**  INDICATIVO DE INCIDENCIA OBLIGADA  **
	//*****************************************
	//**  INDICATIVO DE INCIDENCIA OBLIGADA  	OpenWithParm(w_2301_sel_causa_x_tipo, ii_tipo_incid)

	If tabpage_formulario.d_inf_general.GetRow() > 0 Then
		If tabpage_formulario.d_inf_general.GetItemNumber(tabpage_formulario.d_inf_general.GetRow(), "sgd_incidencia_ind_obligada") = 1 Then
			OpenWithParm(w_2301_sel_causa_x_tipo, fgci_incidencia_obligada)
		Else
			OpenWithParm(w_2301_sel_causa_x_tipo, ii_tipo_incid)
		End If
	End If
	//*****************************************
	//**  OSGI 2001.2  	20/11/2002			  **
	//**  Jair Padilla / Soluziona PANAMA    **
	//**  INDICATIVO DE INCIDENCIA OBLIGADA  **
	//*****************************************
Else
	Open(w_2301_sel_causa)
End If
//***************************************
//**  OSGI 2001.1  	16/08/2001			**
//**  Jair Padilla / Soluziona PANAMA  **
//***************************************


if gu_comunic2.is_comunic.longval4 > 0 then
	d_inf_general.setitem(1,"causa",gu_comunic2.is_comunic.longval4)
	d_inf_general.object.st_causa.text = gu_comunic2.is_comunic.strval9
	ii_causa_ant = d_inf_general.getitemnumber(1,"causa")
	idt_fecha_cl = d_inf_general.getitemdatetime(1,"fec_causa")
	d_inf_general.triggerevent("ue_cambio_causa")
	lm_menu.m_archivo.m_grabar.enabled = true
	iw_contenedora.tab_1.f_deshab_tabs(true)
	st_2.visible = true
	
	//HLA.INI.DDAG-6453.25/08/2016	
	IF ii_causa <> gu_comunic2.is_comunic.longval4 THEN
		tabpage_formulario.d_inf_general.object.st_causa_subtipo.text = ""
		d_inf_general.setitem(1,"causa_subtipo",0 )
	END IF
	ii_causa = gu_comunic2.is_comunic.longval4
	//HLA.FIN.DDAG-6453.25/08/2016

	//AHM (23/07/2009) Mejora 1/578447
	IF tabpage_formulario.d_inf_general.getItemNumber(1, "estado_actual") <> 5 THEN
		st_2.visible = true
	END IF
	
	//AHM(23/07/2009) Mejora 1/452003
	SELECT agente 
	INTO :ll_agenteCausa
	FROM gi_causa
	WHERE cod_causa = :gu_comunic2.is_comunic.longval4;
	
	IF ll_agenteCausa = 0 OR isNull(ll_agenteCausa) THEN
//		tabpage_otros.dw_otros.modify("agente.protect = 0")
//		tabpage_otros.dw_otros.modify("agente.background.color = " + gs_blanco)
	ELSE
		tabpage_otros.dw_otros.setItem(1, "agente", ll_agenteCausa)
		tabpage_otros.dw_otros.modify("agente.protect = 1")		
		tabpage_otros.dw_otros.modify("agente.background.color = " + gs_gris)
	END IF
	//Fin AHM

	yield()
end if

end event

type d_inf_general from u_inc_2003_pr_form_inf_general within tabpage_formulario
event clicked pbm_dwnlbuttonclk
event itemchanged pbm_dwnitemchange
event itemerror pbm_dwnitemvalidationerror
event ue_cambio_causa pbm_custom72
event ue_cambio_f_deteccion pbm_custom73
event ue_cambio_f_est_res pbm_custom75
event ue_keydown pbm_dwnkey
event ue_seteo_columna pbm_custom50
event ue_post_itemchanged ( readonly string as_columna,  readonly datetime adt_fecha_vieja )
event ue_cambio_f_elim_peligro pbm_custom75
integer x = 9
integer y = 36
integer width = 3799
integer height = 2092
integer taborder = 4
borderstyle borderstyle = styleraised!
end type

event itemchanged;string ls_Nombre_Columna
DateTime ldt_f_causa_nueva
md_ingreso_incidencias lm_menu

//LSH INI 01/01/2014 evolutivo DEO13-00000184
datetime ld_f_elim
datetime ld_f_det
datetime ld_gen_max
//datetime ld_fecha_alta_inc //LSH 24/02/2013 evolutivo DEO14-00000221
//datetime ld_alta_max //LSH 24/02/2013 evolutivo DEO14-00000221
//datetime ld_f_elim_datos_ot //LSH 24/02/2013 evolutivo DEO14-00000221
datetime ldt_null
setnull(ldt_null)
//LSH INI 01/01/2014 evolutivo DEO13-00000184

ib_hubo_error=false
ls_Nombre_Columna = dwo.name //this.GetColumnName( ) 

lm_menu= iw_contenedora.menuid

CHOOSE CASE ls_Nombre_Columna
	CASE "f_deteccion"
		idt_fec_deteccion = this.getitemdatetime(1,"f_deteccion")
		idt_fec_deteccion_nueva = DateTime(Date(Left(data,10)),Time(Right(data,15)))
		this.accepttext()
		this.postevent("ue_cambio_f_deteccion")
	CASE "f_est_res"
		idt_fec_est_res = this.getitemdatetime(1,"f_est_res")
		this.accepttext()
	   this.postevent("ue_cambio_f_est_res")
	//LSH INI 08/09/2013 evolutivo DEO12-00000263
	CASE "f_elim_peligro"
		this.accepttext()
		
		idt_fec_elim_peligro = this.getitemdatetime(1,"f_elim_peligro")
		ld_f_elim = tabpage_formulario.d_inf_general.getitemdatetime(1,'f_elim_peligro')
		ld_f_det = tabpage_formulario.d_inf_general.getitemdatetime(1,'f_deteccion')
		ld_gen_max = datetime(RelativeDate(date(ld_f_det), 3) , time(ld_f_det))
		
		//LSH INI 24/02/2013 evolutivo DEO14-00000221
		//ld_f_elim_datos_ot = tabpage_ot.d_datos_ot.GetItemDateTime(1,'f_elim_peligro')
		//fecha de alta de la incidencia
		//ld_fecha_alta_inc = tabpage_formulario.d_inf_general.GetItemDatetime(1, 'f_alta')
		//fecha de alta de la incidencia mas 5 dias sumados, esto de acuerdo a la mejora
		//ld_alta_max = datetime(RelativeDate(date(ld_fecha_alta_inc), 5) , time(ld_fecha_alta_inc))
		//LSH INI 24/02/2013 evolutivo DEO14-00000221
		
		idt_fec_elim_peligro=ld_f_elim
		
		if ld_f_elim < ld_f_det and not isnull(ld_f_elim) then
			messagebox("Atenci$$HEX1$$f300$$ENDHEX$$n","La fecha de eliminaci$$HEX1$$f300$$ENDHEX$$n de peligro no debe ser menor que la fecha de detecci$$HEX1$$f300$$ENDHEX$$n de la incidencia", Exclamation!)
			//tabpage_formulario.d_inf_general.SetItem(1,'f_elim_peligro', idt_fec_elim_peligro)
			tabpage_formulario.d_inf_general.SetItem(1,'f_elim_peligro', ldt_null)//LSH 01/01/2014 correctivo DEO13-00000184
			tabpage_formulario.d_inf_general.Accepttext()
			idt_fec_elim_peligro = ldt_null//LSH 01/01/2014 correctivo DEO13-00000184
			tabpage_ot.d_datos_ot.SetItem(1,"f_elim_peligro", ldt_null)//LSH INI 01/01/2014 correctivo DEO13-00000184
			return 1	
		end if
		
		if ld_f_elim > ld_gen_max and not isnull(ld_f_elim) then
			messagebox("Atenci$$HEX1$$f300$$ENDHEX$$n","La fecha de eliminaci$$HEX1$$f300$$ENDHEX$$n de peligro no debe sobrepasar 3 d$$HEX1$$ed00$$ENDHEX$$as despu$$HEX1$$e900$$ENDHEX$$s de la fecha de detecci$$HEX1$$f300$$ENDHEX$$n de la incidencia.", Exclamation!)
			//tabpage_formulario.d_inf_general.SetItem(1,'f_elim_peligro', idt_fec_elim_peligro)
			tabpage_formulario.d_inf_general.SetItem(1,'f_elim_peligro', ldt_null)//LSH 01/01/2014 correctivo DEO13-00000184
			tabpage_formulario.d_inf_general.Accepttext()
			idt_fec_elim_peligro = ldt_null//LSH 01/01/2014 correctivo DEO13-00000184
			tabpage_ot.d_datos_ot.SetItem(1,"f_elim_peligro", ldt_null)//#LSH 01/01/2014 correctivo DEO13-00000184
			return 1
		end if
		
   	//this.postevent("ue_cambio_f_elim_peligro")
		IF date(idt_fec_elim_peligro) <> date("01/01/1900") THEN
			//messagebox("idt_fec_elim_peligro",string(idt_fec_elim_peligro))
			tabpage_ot.d_datos_ot.SetItem(1,"f_elim_peligro", idt_fec_elim_peligro)
		END IF
		
	//LSH FIN 08/09/2013 evolutivo DEO12-00000263
	CASE "fec_causa"

		ldt_f_causa_nueva = DateTime(Date(Left(data,10)),Time(Right(data,15)))
		this.accepttext()
		// Valido la fecha nueva ingresada contra la fecha de ER 
		// (en caso que la incidencia este en ER o posterior)
		//IF ii_estado_oper >= fgci_incidencia_en_reposicion THEN
		IF isnull(ldt_f_causa_nueva) THEN
			IF this.object.st_causa.text <> "" THEN
				This.SetItem(1, 'fec_causa', This.GetItemDateTime(1,'fec_causa', Primary!, True))
				messagebox("Atenci$$HEX1$$f300$$ENDHEX$$n", "La fecha de la causa no puede ser nula")
				Return 1
			END IF
				
		ELSEIF ldt_f_causa_nueva < idt_fec_deteccion THEN
				//messagebox("Atenci$$HEX1$$f300$$ENDHEX$$n","La Fecha de Causa Localizada no puede ser menor que la fecha de En Reposici$$HEX1$$f300$$ENDHEX$$n.")
			//gnv_msg.f_mensaje("AI107","","",ok!)
			This.SetItem(1, 'fec_causa', This.GetItemDateTime(1,'fec_causa', Primary!, True))
			messagebox("Atenci$$HEX1$$f300$$ENDHEX$$n", "La fecha de la causa no puede ser menor que la fecha de detecci$$HEX1$$f300$$ENDHEX$$n de la incidencia")
			Return 1
		//ELSEIF ldt_f_causa_nueva > fgnu_fecha_actual() THEN //** INI ** 23/06/2015 *** evolutivo DDAG-2482
		ELSEIF ldt_f_causa_nueva > fgnu_fecha_actual_con_seg() THEN //** FIN ** 23/06/2015 *** evolutivo DDAG-2482

			//gnv_msg.f_mensaje("AI107","","",ok!)
			This.SetItem(1, 'fec_causa', This.GetItemDateTime(1,'fec_causa', Primary!, True))
			messagebox("Atenci$$HEX1$$f300$$ENDHEX$$n", "La fecha de la causa no puede ser mayor que la fecha actual")
	//			This.SetItem(1, 'fec_causa', This.GetItemDateTime(1,'fec_causa', Primary!, True))
			Return 1
		END IF
		//END IF

//	CASE "tipo_incidencia"
//		this.accepttext()
//		this.postevent("ue_cambio_tip_inc")
	CASE "causa"
		ii_causa_ant = this.getitemnumber(1,"causa")
		idt_fecha_cl = this.getitemdatetime(1,"fec_causa")
		this.accepttext()
		this.triggerevent("ue_cambio_causa")

	CASE "desc"
		this.AcceptText()
		
//	CASE "alcance"
//		this.accepttext()
//		this.postevent("ue_cambio_ind_calidad")
		
END CHOOSE
//ib_hubo_cambios=TRUE
//yield()

if ii_estado_oper < ii_incidencia_resuelta then
	lm_menu.m_archivo.m_grabar.enabled = true
end if



//*******************************************
//**  OSGI 2002.1  	07/08/2002				 **
//**  Jair Padilla / Soluziona PANAMA  	 **
//**  PM001 RESTRICCION N DIAS ANTIG$$HEX1$$dc00$$ENDHEX$$EDAD  **
//*******************************************
This.Post Event ue_post_itemchanged(ls_Nombre_Columna, idt_fec_deteccion)
//*******************************************
//**  OSGI 2002.1  	07/08/2002				 **
//**  Jair Padilla / Soluziona PANAMA  	 **
//**  PM001 RESTRICCION N DIAS ANTIG$$HEX1$$dc00$$ENDHEX$$EDAD  **
//*******************************************

if ls_Nombre_Columna <> "sgd_incidencia_ind_obligada" then
  iw_contenedora.tab_1.f_deshab_tabs(false)
end if



end event

event itemerror;return 1
end event

event ue_cambio_causa;// gi_con_material_averiado

md_ingreso_incidencias lm_menu
lm_menu= iw_contenedora.menuid


tabpage_formulario.d_inf_general.AcceptText()

string ls_nulo
SetNull(ls_nulo)

iw_contenedora.tab_1.fnu_evaluo_sin_selec(ii_causa_ant)

IF ISNULL(d_inf_general.getitemnumber(1,"causa")) THEN
	d_inf_general.modify("fec_causa.protect=1") 
	d_inf_general.modify("fec_causa.background.color="+gs_gris)
	
ELSE
	IF ii_alcance <> fgci_incidencia_sin_interrupcion THEN
		
		lm_menu.m_consultar.m_avisos.enabled=true
	END IF
//	d_inf_general.modify("fec_causa.protect=0") 
//	d_inf_general.modify("fec_causa.background.color="+gs_blanco)

	// Si la incidencia es sin interrupcion pongo visible la opci$$HEX1$$f300$$ENDHEX$$n de finalizar la OT.
//	d_inf_general.modify("material_averiado.protect = 0")
//	d_inf_general.modify("material_averiado.background.color="+gs_blanco)
END IF

end event

event ue_cambio_f_deteccion;
If (iw_contenedora.tab_1.frn_evaluo_f_deteccion(idt_fec_deteccion_nueva,idt_fec_deteccion)) THEN
//	l_si_valido = true

//NCA-INICIO.
	tabpage_seguimiento.d_seguimiento_operaciones.SetItem(ii_incidencia_pendiente,"f_alta", Datetime(Date(idt_fec_deteccion),Time(String(Time(idt_fec_deteccion), "hh:mm:ss"))))
//NCA-FIN.	
Else
//	ib_valido = FALSE	
	d_inf_general.setcolumn("f_deteccion")
	idt_fec_deteccion_nueva = idt_fec_deteccion
	ib_hubo_error=true
//	l_si_valido = false
END IF
end event

event ue_cambio_f_est_res;if iw_contenedora.tab_1.frn_evaluo_f_res_estimada()=false then
	ib_hubo_error= true
end if

end event

on ue_keydown;call u_inc_2003_pr_form_inf_general::ue_keydown;iF keydown(keyEnter!) THEN
	this.triggerevent("ue_seteo_columna")
END IF
end on

on ue_seteo_columna;call u_inc_2003_pr_form_inf_general::ue_seteo_columna;String ls_columna
ls_columna=this.getcolumnname()
choose case ls_columna
	case "f_deteccion"
		this.setcolumn("f_est_res")
	Case "f_est_res"
		this.setcolumn("desc")
	Case "desc"
		this.setcolumn("causa")
	Case "causa"
		this.setcolumn("fec_causa")
END CHOOSE

end on

event ue_post_itemchanged(readonly string as_columna, readonly datetime adt_fecha_vieja);//*******************************************
//**  OSGI 2002.1  	07/08/2002				 **
//**  Jair Padilla / Soluziona PANAMA  	 **
//**  PM001 RESTRICCION N DIAS ANTIG$$HEX1$$dc00$$ENDHEX$$EDAD  **
//*******************************************
If as_columna = 'f_deteccion' And ib_error_fec_deteccion Then
	This.SetItem(1, "f_deteccion", adt_fecha_vieja)
	This.AcceptText()
	This.SetColumn("f_deteccion")
	This.SetFocus()
End If

ib_error_fec_deteccion = False
//*******************************************
//**  OSGI 2002.1  	07/08/2002				 **
//**  Jair Padilla / Soluziona PANAMA  	 **
//**  PM001 RESTRICCION N DIAS ANTIG$$HEX1$$dc00$$ENDHEX$$EDAD  **
//*******************************************


//*****************************************
//**  OSGI 2001.2  	20/11/2002			  **
//**  Jair Padilla / Soluziona PANAMA    **
//**  INDICATIVO DE INCIDENCIA OBLIGADA  **
//*****************************************
Integer li_causa_ind_ob

If as_columna = 'sgd_incidencia_ind_obligada' And This.GetRow() > 0 Then
	If This.GetItemNumber(This.GetRow(), "causa") <> fgci_cod_causa_desconocida And &
		Not IsNull(This.GetItemNumber(This.GetRow(), "causa")) Then
		SetNull(li_causa_ind_ob)
		This.SetItem(This.GetRow(), "causa", li_causa_ind_ob)
		This.Modify("st_causa.Text=''")

		MessageBox("Aviso", "Deber$$HEX2$$e1002000$$ENDHEX$$seleccionar la causa de la incidencia, ya que ha cambiado el indicativo de incidencia obligada.")

		This.AcceptText()
	End If
End If
//*****************************************
//**  OSGI 2001.2  	20/11/2002			  **
//**  Jair Padilla / Soluziona PANAMA    **
//**  INDICATIVO DE INCIDENCIA OBLIGADA  **
//*****************************************
end event

event ue_cambio_f_elim_peligro;//LSH INI 08/09/2013 evolutivo DEO12-00000263
if iw_contenedora.tab_1.frn_evaluo_f_elim_peligro()=false then
	ib_hubo_error= true
end if
//LSH FIN 08/09/2013 evolutivo DEO12-00000263
end event

event constructor;call super::constructor; 
this.SETROWFOCUSINDICATOR(OFF!)

if fg_verifica_parametro('nuevos_tip_inc') then
	
	This.modify("sgd_incidencia_ind_obligada.visible = '0~tif( tipo_incidencia <> " &
		+ string(fgci_incidencia_alum_pub) + " and tipo_incidencia <> " + string(fgci_incidencia_calidad) + &
		" and alcance <> " + string(fgci_incidencia_de_suministro) + " , 1, 0 ) '")
		
	This.modify("sgd_incidencia_ind_obligada.protect = '0~tif( estado_actual < " &
		+ string(fgci_incidencia_resuelta) +  " and tipo_incidencia <> " &
		+ string(fgci_incidencia_programada) +  " and alcance <> " &
		+ string(fgci_incidencia_de_suministro) + ", 0, 1)'")
		
else
	this.modify("sgd_incidencia_ind_obligada.visible = '0'")
	this.modify("sgd_incidencia_ind_obligada.protect = '1'")
end if 

this.SetTransObject(SQLCA)

end event

event retrieveend;long ll_num_causa, ll_filas, ll_num_causa_subtipo
string ls_descripcion, ls_mat_averiado, ls_descripcion_subtipo
//Pongo la etiqueta de la causa$$HEX1$$e700$$ENDHEX$$
if rowcount > 0 then
	ll_num_causa = d_inf_general.getitemnumber(1,"causa")
	
	SELECT descripcion into 

	 :ls_descripcion from (SELECT DESCRIPCION FROM GI_CAUSA WHERE COD_CAUSA = :ll_num_causa
								  UNION
			          		  SELECT NOM_CAUSA FROM GI_HIST_INCIDENCIAS WHERE NRO_INCIDENCIA = :il_nro_incidencia)
	WHERE ROWNUM = 1;
	
	d_inf_general.object.st_causa.text = ls_descripcion
	
	
	//TDA-EDM1-24042017
	
	ll_num_causa_subtipo = d_inf_general.getitemnumber(1,"causa_subtipo")
	
	SELECT descripcion into 

	 :ls_descripcion_subtipo from (SELECT DESCRIPCION FROM GI_CAUSA_SUBTIPO WHERE COD_CAUSA_SUBTIPO = :ll_num_causa_subtipo
								  UNION
			          		  SELECT NOM_CAUSA_SUBTIPO FROM GI_HIST_INCIDENCIAS WHERE NRO_INCIDENCIA = :il_nro_incidencia)
	WHERE ROWNUM = 1;
	
	d_inf_general.object.st_causa_subtipo.text = ls_descripcion_subtipo
	
	//END-TDA-EDM1-24042017
	
	//Pongo el material averiado
	ls_mat_averiado = d_inf_general.getitemstring(1,"material_averiado")
	
	if not isnull(ls_mat_averiado) then
		SELECT "DESCRIPCION" INTO :ls_descripcion  FROM "SGD_MATERIALES" WHERE "COD_MATERIAL" = :ls_mat_averiado   ;
		d_inf_general.object.st_mat_averiado.text = ls_descripcion
	end if
	
end if


end event

type st_fases from statictext within tabpage_formulario
boolean visible = false
integer x = 46
integer y = 688
integer width = 951
integer height = 64
boolean bringtotop = true
integer textsize = -10
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
boolean italic = true
boolean underline = true
string pointer = "mano.cur"
long textcolor = 128
long backcolor = 79741120
string text = "Fases sugeridas para interrumpir :"
boolean focusrectangle = false
end type

event clicked;String ls_fase_instalacion, ls_fase_sugerida

// gu_comunic.is_comunic.strval1 --> contendr$$HEX2$$e1002000$$ENDHEX$$la fase sugerida
// gu_comunic.is_comunic.strval2 --> contendr$$HEX2$$e1002000$$ENDHEX$$la fase de la instalaci$$HEX1$$f300$$ENDHEX$$n afectada

// Se determina la fase de la instalaci$$HEX1$$f300$$ENDHEX$$n afectada
ls_fase_sugerida = tabpage_formulario.d_inf_general.GetItemString(1, 'fase_sugerida')
IF isnull(ls_fase_sugerida) THEN
	ls_fase_sugerida = " "
END IF
gu_comunic.is_comunic.strval1 = ls_fase_sugerida

SELECT fgci_fase_instalacion(TIPO_CONEXION)
INTO :ls_fase_instalacion
FROM SGD_INSTALACION
WHERE NRO_INSTALACION = :idec_nro_instalacion_afectada AND
		BDI_JOB = 0;
		
IF SQLCA.SQLCode = 0 THEN
	gu_comunic.is_comunic.strval2 = ls_fase_instalacion
ELSE
	gu_comunic.is_comunic.strval2 = " "
END IF
gu_comunic.is_comunic.accion_llamada = 'Seleccion'
open(w_seleccion_fase)




end event

type gb_3 from groupbox within tabpage_formulario
integer x = 3822
integer y = 20
integer width = 1614
integer height = 1096
integer taborder = 40
integer textsize = -10
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
boolean underline = true
long textcolor = 134217856
long backcolor = 67108864
string text = "Informe Tecnico"
end type

type tabpage_observaciones from userobject within u_tab_2301_form_incidencias
integer x = 18
integer y = 112
integer width = 5527
integer height = 3872
long backcolor = 79741120
string text = "Obs."
long tabtextcolor = 33554432
long tabbackcolor = 79741120
string picturename = "ScriptYes!"
long picturemaskcolor = 553648127
cb_14 cb_14
cb_2 cb_2
st_3 st_3
st_4 st_4
mle_observaciones_mnto mle_observaciones_mnto
mle_observaciones mle_observaciones
ole_1 ole_1
end type

on tabpage_observaciones.create
this.cb_14=create cb_14
this.cb_2=create cb_2
this.st_3=create st_3
this.st_4=create st_4
this.mle_observaciones_mnto=create mle_observaciones_mnto
this.mle_observaciones=create mle_observaciones
this.ole_1=create ole_1
this.Control[]={this.cb_14,&
this.cb_2,&
this.st_3,&
this.st_4,&
this.mle_observaciones_mnto,&
this.mle_observaciones,&
this.ole_1}
end on

on tabpage_observaciones.destroy
destroy(this.cb_14)
destroy(this.cb_2)
destroy(this.st_3)
destroy(this.st_4)
destroy(this.mle_observaciones_mnto)
destroy(this.mle_observaciones)
destroy(this.ole_1)
end on

type cb_14 from commandbutton within tabpage_observaciones
boolean visible = false
integer x = 1216
integer y = 20
integer width = 247
integer height = 96
integer taborder = 14
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "MS Sans Serif"
boolean enabled = false
string text = "Cerrar"
end type

event clicked;Setpointer(HourGlass!)

string ls_nom_doc

ls_nom_doc = trim("c:\" + string(il_nro_incidencia) + ".doc")
ole_1.saveas(ls_nom_doc)
ole_1.clear()
//ole_1.visible  = false  

tabpage_formulario.d_inf_general.setitem(1,"nom_doc",trim(string(il_nro_incidencia) + ".doc" ))

tabpage_formulario.enabled = true
tabpage_observaciones.enabled = true

if ic_tabs[3]='1' then
	tabpage_ot.enabled = true
else
	tabpage_ot.enabled = false
end if

if	ic_tabs[4]='1' then
	tabpage_cuadrillas.enabled=true
else
	tabpage_cuadrillas.enabled=false
end if

if ic_tabs[5]= '1' then
	tabpage_interrupciones.enabled = true
else
	tabpage_interrupciones.enabled = false
end if

if ic_tabs[6]='1' then
	tabpage_seguimiento.enabled = true
else
	tabpage_seguimiento.enabled = false
end if

if ic_tabs[7]='1' then
	tabpage_acciones.enabled = true
else
	tabpage_acciones.enabled = false
end if

if	ic_tabs[8]='1' then
	tabpage_maniobras.enabled = true
else
	tabpage_maniobras.enabled = false
end if
ole_1.event close()
this.enabled = false
cb_2.enabled = true
end event

type cb_2 from commandbutton within tabpage_observaciones
boolean visible = false
integer x = 901
integer y = 20
integer width = 247
integer height = 96
integer taborder = 26
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "MS Sans Serif"
string text = "Mostrar"
end type

event clicked;Setpointer(HourGlass!)

long ll_result
string ls_fichero

this.enabled = false

ls_fichero = trim(tabpage_formulario.d_inf_general.getitemstring(1,"nom_doc"))

if not len(ls_fichero) > 0 or isnull(ls_fichero) then

	ls_fichero = "template.doc"

end if

ll_result = ole_1.open("c:\" + trim(ls_fichero))
if ll_result = -1 then
	if gnv_msg.f_mensaje("CP03","","",YesNo!) = 1 then
		ll_result = ole_1.open("c:\" + trim("c:\template.doc"))
	else
		this.enabled = true
		return
	end if
end if
	

cb_14.enabled = true

//Compruebo el estado de los 8 Tagpages que existen

ic_tabs[1]='1'
ic_tabs[2]='1'

if tabpage_ot.enabled then
	ic_tabs[3]='1'
else
	ic_tabs[3]='0'
end if

if tabpage_cuadrillas.enabled then
	ic_tabs[4]='1'
else
	ic_tabs[4]='0'
end if

if tabpage_interrupciones.enabled then
	ic_tabs[5]='1'
else
	ic_tabs[5]='0'
end if

if tabpage_seguimiento.enabled then
	ic_tabs[6]='1'
else
	ic_tabs[6]='0'
end if

if tabpage_acciones.enabled then
	ic_tabs[7]='1'
else
	ic_tabs[7]='0'
end if

if tabpage_maniobras.enabled then
	ic_tabs[8]='1'
else
	ic_tabs[8]='0'
end if

//Deshabilito todos los tabpages

tabpage_formulario.enabled = false
tabpage_ot.enabled = false
tabpage_cuadrillas.enabled = false
tabpage_interrupciones.enabled = false
tabpage_seguimiento.enabled = false
tabpage_acciones.enabled = false
tabpage_maniobras.enabled = false

//Hago visible el tabpage

ole_1.activate(InPlace!)

end event

type st_3 from statictext within tabpage_observaciones
integer x = 119
integer y = 44
integer width = 763
integer height = 60
integer textsize = -10
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 33554432
long backcolor = 67108864
boolean enabled = false
string text = "Obs. Operaciones"
boolean focusrectangle = false
end type

type st_4 from statictext within tabpage_observaciones
boolean visible = false
integer x = 119
integer y = 884
integer width = 864
integer height = 76
integer textsize = -10
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 33554432
long backcolor = 67108864
boolean enabled = false
string text = "Obs. Mantenimiento"
boolean focusrectangle = false
end type

type mle_observaciones_mnto from multilineedit within tabpage_observaciones
event ue_tecla pbm_keyup
boolean visible = false
integer x = 119
integer y = 948
integer width = 3282
integer height = 740
integer taborder = 12
integer textsize = -10
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long backcolor = 16777215
boolean autovscroll = true
integer limit = 1000
boolean displayonly = true
end type

event ue_tecla;if this.text="" or isnull(this.text) then
	iw_contenedora.tab_1.f_deshab_tabs(false)
	ib_observ=true
elseif this.text <> "" and  ib_observ=true then
	iw_contenedora.tab_1.f_deshab_tabs(false)
	ib_observ=false
end if

end event

type mle_observaciones from multilineedit within tabpage_observaciones
event ue_tecla pbm_keyup
integer x = 55
integer y = 132
integer width = 5435
integer height = 2568
integer taborder = 2
integer textsize = -10
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long backcolor = 16777215
boolean vscrollbar = true
boolean autovscroll = true
integer limit = 2000
end type

event ue_tecla;//AHM (19/04/2011) ASUR 1056521
IF isValid(iw_contenedora) THEN
	if iw_contenedora.lu_comunic.is_comunic.Accion_llamada<> "Consulta" then 
		if this.text="" or isnull(this.text) then
			iw_contenedora.tab_1.f_deshab_tabs(false)
			ib_observ=true
		elseif this.text <> "" and  ib_observ=true then
			iw_contenedora.tab_1.f_deshab_tabs(false)
			ib_observ=false
		end if
	end if
END IF
end event

type ole_1 from olecontrol within tabpage_observaciones
boolean visible = false
integer x = 119
integer y = 288
integer width = 3282
integer height = 1360
integer taborder = 13
boolean bringtotop = true
borderstyle borderstyle = stylelowered!
boolean focusrectangle = false
string binarykey = "u_tab_2301_form_incidencias.udo"
integer binaryindex = 1
omdisplaytype displaytype = displayascontent!
omcontentsallowed contentsallowed = containsany!
end type

type tabpage_ot from userobject within u_tab_2301_form_incidencias
event create ( )
event destroy ( )
integer x = 18
integer y = 112
integer width = 5527
integer height = 3872
long backcolor = 79741120
string text = "OT"
long tabtextcolor = 33554432
long tabbackcolor = 79741120
string picturename = "ApplicationIcon!"
long picturemaskcolor = 553648127
st_sin_ot st_sin_ot
cb_ot cb_ot
gb_11 gb_11
rb_2 rb_2
rb_1 rb_1
bmp_brigada_responsable bmp_brigada_responsable
d_lista_brigadas_ot d_lista_brigadas_ot
dw_lista_contratas dw_lista_contratas
tab_lista_brigadas tab_lista_brigadas
d_crit_seleccion d_crit_seleccion
gb_2 gb_2
dw_ambito dw_ambito
d_datos_ot d_datos_ot
end type

on tabpage_ot.create
this.st_sin_ot=create st_sin_ot
this.cb_ot=create cb_ot
this.gb_11=create gb_11
this.rb_2=create rb_2
this.rb_1=create rb_1
this.bmp_brigada_responsable=create bmp_brigada_responsable
this.d_lista_brigadas_ot=create d_lista_brigadas_ot
this.dw_lista_contratas=create dw_lista_contratas
this.tab_lista_brigadas=create tab_lista_brigadas
this.d_crit_seleccion=create d_crit_seleccion
this.gb_2=create gb_2
this.dw_ambito=create dw_ambito
this.d_datos_ot=create d_datos_ot
this.Control[]={this.st_sin_ot,&
this.cb_ot,&
this.gb_11,&
this.rb_2,&
this.rb_1,&
this.bmp_brigada_responsable,&
this.d_lista_brigadas_ot,&
this.dw_lista_contratas,&
this.tab_lista_brigadas,&
this.d_crit_seleccion,&
this.gb_2,&
this.dw_ambito,&
this.d_datos_ot}
end on

on tabpage_ot.destroy
destroy(this.st_sin_ot)
destroy(this.cb_ot)
destroy(this.gb_11)
destroy(this.rb_2)
destroy(this.rb_1)
destroy(this.bmp_brigada_responsable)
destroy(this.d_lista_brigadas_ot)
destroy(this.dw_lista_contratas)
destroy(this.tab_lista_brigadas)
destroy(this.d_crit_seleccion)
destroy(this.gb_2)
destroy(this.dw_ambito)
destroy(this.d_datos_ot)
end on

type st_sin_ot from statictext within tabpage_ot
boolean visible = false
integer x = 622
integer y = 632
integer width = 270
integer height = 52
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "MS Sans Serif"
long textcolor = 128
long backcolor = 79741120
boolean enabled = false
string text = "<SIN OT>"
boolean focusrectangle = false
end type

type cb_ot from commandbutton within tabpage_ot
boolean visible = false
integer x = 1024
integer y = 260
integer width = 430
integer height = 84
integer taborder = 23
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "MS Sans Serif"
string text = "OT~'s Existentes"
end type

event clicked;///////////////////////////////////////////////////////////////////////////////////////////////////////////////////// 
//
// Funci$$HEX1$$f300$$ENDHEX$$n/Evento: cb_ot.clicked
//
// Objetivo: Reutilizar una Ot existente
//         
// Ambito:  P$$HEX1$$fa00$$ENDHEX$$blico
//
// Par$$HEX1$$e100$$ENDHEX$$metros:
//
//        Entrada: 
//        Salida:
//
// Devuelve: 
//
// Fecha            	Responsable             Actuaci$$HEX1$$f300$$ENDHEX$$n
// --------        		-----------           			 ---------
// 18/01/2002	    FDO						Creacci$$HEX1$$f300$$ENDHEX$$n.
//		
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////// 

long ll_ot_existente
datetime ldt_fecha_brigada_mas_vieja
string ls_nom_inst

u_generico_comunicaciones lu_comunic
lu_comunic = create u_generico_comunicaciones
ls_nom_inst = tabpage_formulario.d_inf_general.object.nombre_instalacion[1]
// La instalaci$$HEX1$$f300$$ENDHEX$$n seleccionada tiene OT's asignadas.
// Se permite al usuario seleccionar una OT o definir una nueva
lu_comunic.is_comunic.intval1 = 2 
lu_comunic.is_comunic.intval3 = 1 
lu_comunic.is_comunic.longval1 = idec_nro_instalacion_afectada
lu_comunic.is_comunic.accion_llamada = 'Alta_nivel_instalacion'
lu_comunic.is_comunic.strval1 = ls_nom_inst
lu_comunic.is_comunic.datval2 = idt_fec_deteccion

gu_comunic.is_comunic   = lu_comunic.is_comunic  				
				
Open(w_1106_selec_incid)

IF gu_comunic.is_comunic.longval4 > 0 THEN
	// Acepto la ot pasada como parametro
	il_nro_ot = gu_comunic.is_comunic.longval4
	
	// Si existen brigadas previas las desbloqueo.
	if d_lista_brigadas_ot.rowcount() > 0 then
		iw_contenedora.fw_bloquear_brigadas_asignadas(0)
	end if
	// Cambio el estado de la incidencia y recupero los
	// datos correspondientes a la ot existente
//	ii_estado_oper = fgci_incidencia_enviado_brigada
	d_datos_ot.Retrieve(gu_comunic.is_comunic.longval4)
	if d_datos_ot.RowCount() > 0 then
		if d_datos_ot.object.tip_brigada[1] = 2 then
			fnu_cambiar_ot_tipo('CO')
		else								
			fnu_cambiar_ot_tipo('BR')
		end if
	else
		fnu_cambiar_ot_tipo('BR')
	end if
	d_lista_brigadas_ot.Retrieve(gu_comunic.is_comunic.longval4)
	iw_contenedora.fw_bloquear_brigadas_asignadas(1)
	IF d_lista_brigadas_ot.RowCount() > 0 THEN
		ldt_fecha_brigada_mas_vieja = iw_contenedora.fw_o_fecha_eb()
	ELSE
		SetNull(ldt_fecha_brigada_mas_vieja)
	END IF
//	tabpage_formulario.d_inf_general.SetItem(1,"estado_actual",ii_estado_oper)
	tabpage_formulario.d_inf_general.SetItem(1,"ot",gu_comunic.is_comunic.longval4)
//	tabpage_seguimiento.d_seguimiento_operaciones.SetItem(ii_incidencia_enviado_brigada,"f_alta",ldt_fecha_brigada_mas_vieja)
	enabled = true
	st_sin_ot.visible=false
	
	// A$$HEX1$$d100$$ENDHEX$$ADIR ESTADO EB	
	
	if ii_estado_oper > fgci_incidencia_enviado_brigada and ldt_fecha_brigada_mas_vieja < idt_fecha_er then
		fnu_anadir_eb(ldt_fecha_brigada_mas_vieja)
	end if
	

END IF
end event

type gb_11 from groupbox within tabpage_ot
boolean visible = false
integer x = 2944
integer y = 84
integer width = 421
integer height = 220
integer taborder = 12
integer textsize = -10
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "MS Sans Serif"
long textcolor = 33554432
long backcolor = 67108864
end type

type rb_2 from radiobutton within tabpage_ot
boolean visible = false
integer x = 2971
integer y = 224
integer width = 375
integer height = 64
boolean bringtotop = true
integer textsize = -10
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "MS Sans Serif"
long textcolor = 33554432
long backcolor = 67108864
string text = "Contratas"
end type

event clicked;fnu_cambiar_ot_tipo('CO')

int	li_brigadaW				//N$$HEX1$$fa00$$ENDHEX$$mero de fila de la brigada wireless
// GNU 23-5-2006. Mejora 1/442721
long ll_tipo_brig
long ll_brigadas_en_turno

ll_brigadas_en_turno= tabpage_ot.d_crit_seleccion.GetItemNumber(1,'pi_brigadas_en_turno')

SELECT CODIGO
INTO :ll_tipo_brig
FROM SGD_VALOR
WHERE  "SGD_VALOR"."CODIF" = 'TBRD';

IF sqlca.sqlcode=100 THEN ll_tipo_brig=1;

tabpage_ot.d_crit_seleccion.SetItem(1,"pi_tipo_brig",ll_tipo_brig)
//tabpage_ot.d_crit_seleccion.triggerevent("ue_itemchanged")

iw_contenedora.tab_1.triggerevent("ue_armar_sql")
//tabpage_ot.d_crit_seleccion.SetItem(1,"pi_brigadas_en_turno",ll_brigadas_en_turno)
// FIN GNU

// se traen las contratas que cumplen las condiciones del filtro
dw_lista_contratas.SetRedraw(FALSE)
dw_lista_contratas.Retrieve()	
//AHM (23/01/2008)
IF gi_pais = 6 THEN 			//Comprueba que es EPSA
	li_brigadaW = dw_lista_contratas.find("nro_brigada = 9001", 1, dw_lista_contratas.rowCount())
	IF li_brigadaW > 1 THEN		//Comprueba que se ha encontrado la brigada wireless
		dw_lista_contratas.deleteRow(li_brigadaW)
	END IF
END IF
//Fin AHM

dw_lista_contratas.SetRedraw(TRUE)

end event

type rb_1 from radiobutton within tabpage_ot
boolean visible = false
integer x = 2971
integer y = 132
integer width = 375
integer height = 68
boolean bringtotop = true
integer textsize = -10
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "MS Sans Serif"
long textcolor = 33554432
long backcolor = 67108864
string text = "Brigadas"
boolean checked = true
end type

event clicked;Datetime ldt_fecha_turno

fnu_cambiar_ot_tipo('BR')
// GNU 23-5-2006. Mejora 1/442721
long ll_brigadas_en_turno

ll_brigadas_en_turno= tabpage_ot.d_crit_seleccion.GetItemNumber(1,'pi_brigadas_en_turno')
tabpage_ot.d_crit_seleccion.SetItem(1,"pi_tipo_brig",1)
//tabpage_ot.d_crit_seleccion.triggerevent("ue_itemchanged")
iw_contenedora.tab_1.triggerevent("ue_armar_sql")
//tabpage_ot.d_crit_seleccion.SetItem(1,"pi_brigadas_en_turno",ll_brigadas_en_turno)

// FIN GNU

// Se traen las brigadas que cumplen la condici$$HEX1$$f300$$ENDHEX$$n del filtro
ldt_fecha_turno = tabpage_ot.d_crit_seleccion.GetItemDatetime(1, 'pdt_fecha_turno')
// se actualizan las brigadas que entran en el horario
iw_contenedora.dw_brigadas_calendario_rango.Retrieve(Datetime(Date(ldt_fecha_turno)), ldt_fecha_turno)
if tab_lista_brigadas.il_retrieve = 1 then 
	tab_lista_brigadas.tabpage_no_disponibles.dw_brigadas_no_disponibles.SetRedraw(FALSE)
	tab_lista_brigadas.tabpage_no_disponibles.dw_brigadas_no_disponibles.retrieve()
end if
tab_lista_brigadas.tabpage_disponibles.dw_brigadas_disponibles.SetRedraw(FALSE)
tab_lista_brigadas.tabpage_disponibles.dw_brigadas_disponibles.retrieve(IL_NRO_OT)
tab_lista_brigadas.tabpage_no_disponibles.dw_brigadas_no_disponibles.SetRedraw(TRUE)
tab_lista_brigadas.tabpage_disponibles.dw_brigadas_disponibles.SetRedraw(TRUE)
end event

type bmp_brigada_responsable from picture within tabpage_ot
event clicked pbm_bnclicked
integer x = 1166
integer y = 88
integer width = 146
integer height = 128
string picturename = ".\recursos\ALTCONTR.BMP"
boolean focusrectangle = false
end type

event clicked;long ll_row

IF ii_estado_oper = fgci_incidencia_resuelta OR &
	d_datos_ot.GetItemNumber(1, 'est_ot') = fgci_ot_resuelta THEN
	Return
END IF

ll_row=d_lista_brigadas_ot.GetRow()	

IF ll_row >0 THEN
	iw_contenedora.tab_1.fnu_asignar_responsable(d_lista_brigadas_ot,ll_row)
ELSE
	gnv_msg.f_mensaje("AI04","una brigada","",OK!)
END IF
end event

type d_lista_brigadas_ot from u_bri_2002_pr_list_brigadas_ot within tabpage_ot
integer x = 23
integer y = 56
integer width = 4169
integer height = 504
integer taborder = 3
string dragicon = "Row.ico"
boolean hscrollbar = true
boolean vscrollbar = true
borderstyle borderstyle = styleraised!
end type

event clicked;call super::clicked;click_row_brig_ot = row	//ANG

This.SetRedraw(False)
This.ScrollToRow(row)

IF is_accion_llamada="Consulta" THEN
	This.SetRedraw(True)
	Return
END IF


IF ii_estado_oper = fgci_incidencia_resuelta THEN
	This.SetRedraw(True)
	Return
END IF

IF row>0 THEN
	IF d_lista_brigadas_ot.object.est_brigada[row] < fgci_ot_trabajando then
		this.Drag(Begin!)	
	END IF
	
END IF
This.SetRedraw(True)
end event

event dragdrop;call super::dragdrop;//  Fecha         Responsable   Actuaci$$HEX1$$f300$$ENDHEX$$n
// ---------    -------         ----------------------------------------
// 23/02/2000     DSA				Introducir las contratas
//
////////////////////////////////////////////////////////////////////////////////////////////////

su_drag_brigada_ot s_estructura 
long ll_nro_ot, ll_ccli_afec, ll_nro_brigada
int li_brig_permitida 
int li_disponible
int li_fila_no_dsp, li_fila
int li_unica_brig = 0
int li_lock_status
int li_cant_brigadas,li_conta,li_cont2
datawindow objeto
datetime ld_fecha_ini_ot
string ls_nom_instalacion

//messagebox("Informaci$$HEX1$$f300$$ENDHEX$$n","DragDrop",information!,ok!)

objeto = source 
IF typeof(Objeto)=DataWindow! THEN

	ls_nom_instalacion = tabpage_formulario.d_inf_general.GetItemString(1,"nombre_instalacion")
	ll_ccli_afec = tabpage_formulario.d_inf_general.GetItemNumber(1,"ccli_afec")

	IF objeto.DataObject="d_bri_2004_pr_lista_brigadas" then
		// SE EST$$HEX2$$c1002000$$ENDHEX$$INTENTANDO ASIGNAR UNA BRIGADA NO DISPONIBLE
	
		ll_nro_brigada=objeto.getitemnumber(click_row,'nro_brigada')
		// En primer lugar se bloquea la brigada
		li_lock_status=gnu_u_transaction.uf_lock_brigada(ll_nro_brigada)
  	   IF li_lock_status<>0 THEN
			// La brigada la est$$HEX2$$e1002000$$ENDHEX$$manipulando otro usuario
        	//gnv_msg.f_mensaje("AI96","La Brigada","modificada",OK!)
			This.Drag(Cancel!)
			Return
		END IF

		d_datos_ot.AcceptText()
		ld_fecha_ini_ot = d_datos_ot.GetItemDateTime(1,"f_desde")
		s_estructura=tab_lista_brigadas.fpr_devolver_brigada(tab_lista_brigadas.tabpage_no_disponibles.dw_brigadas_no_disponibles,&
																				ld_fecha_ini_ot,click_row)
		s_estructura.nro_ot=d_datos_ot.GetItemNumber(1,"nro_ot")
		
		li_brig_permitida = iw_contenedora.tab_1.fw_valida_drag_brigada_no_disp(s_estructura.nro_brigada)
		
		IF (s_estructura.Click_Row > 0) AND (li_brig_permitida = 1) then
			// Llamo a la ventana de desasignar a la brigada de la OT / Tarea 
			// en que esta trabajando para asignarla a la OT actual
			
			// Cargo en la estructura de comunicaciones las variables necesarias 
			// para abrir la ventana de desasignar brigada
			
			fgnu_resetear_s_comunicaciones(gu_comunic)
			
			// Si esta asignada a una tarea
			IF tab_lista_brigadas.tabpage_no_disponibles.dw_brigadas_no_disponibles.GetItemNumber(click_row,"nro_ot") = 0 OR &
				IsNull(tab_lista_brigadas.tabpage_no_disponibles.dw_brigadas_no_disponibles.GetItemNumber(click_row,"nro_ot")) THEN
				
				gu_comunic.is_comunic.accion_llamada = "tarea" 
				gu_comunic.is_comunic.longval4 = tab_lista_brigadas.tabpage_no_disponibles.dw_brigadas_no_disponibles.GetItemNumber(click_row,"nro_tarea")
				gu_comunic.is_comunic.intval4 = 0
				
			ELSE		
			// Si esta asignada a una ot
				gu_comunic.is_comunic.accion_llamada = "ot" 
				gu_comunic.is_comunic.intval2 = tab_lista_brigadas.tabpage_no_disponibles.dw_brigadas_no_disponibles.GetItemNumber(click_row,"gi_incidencia_est_actual")
				
				ll_nro_ot = tab_lista_brigadas.tabpage_no_disponibles.dw_brigadas_no_disponibles.GetItemNumber(click_row,"nro_ot")
				gu_comunic.is_comunic.longval4 = ll_nro_ot
				
				SELECT count(*) into :li_unica_brig FROM GI_BRIGADA_OT
				WHERE NRO_OT = :ll_nro_ot AND F_HASTA IS NULL;
				
				gu_comunic.is_comunic.intval4 = li_unica_brig
				// Antes era el nro instalacion afectada de la incidencia
				gu_comunic.is_comunic.longval1 = tab_lista_brigadas.tabpage_no_disponibles.dw_brigadas_no_disponibles.GetItemNumber(click_row,"nro_instalacion")
				//
				gu_comunic.is_comunic.longval2 = tab_lista_brigadas.tabpage_no_disponibles.dw_brigadas_no_disponibles.GetItemNumber(click_row,"nro_incidencia")
				gu_comunic.is_comunic.strval1 = tab_lista_brigadas.tabpage_no_disponibles.dw_brigadas_no_disponibles.GetItemString(click_row,"instalacion_afectada")
				gu_comunic.is_comunic.datval2 = idt_fec_deteccion
				gu_comunic.is_comunic.strval3 = tabpage_formulario.d_inf_general.GetItemString(1,"nombre_instalacion")
				
			END IF
			gu_comunic.is_comunic.programa_llamante = "w_2301"
			gu_comunic.is_comunic.longval3 = tab_lista_brigadas.tabpage_no_disponibles.dw_brigadas_no_disponibles.GetItemNumber(click_row,"nro_brigada")
			gu_comunic.is_comunic.strval2 = tab_lista_brigadas.tabpage_no_disponibles.dw_brigadas_no_disponibles.GetItemString(click_row,"brigada")
			gu_comunic.is_comunic.datval1 = tab_lista_brigadas.tabpage_no_disponibles.dw_brigadas_no_disponibles.GetItemDateTime(click_row,"f_inicio_tarea_ot")
			
			// Llamo a la ventana de desasignar brigada		
			Open(w_2302_asignar_brigada)
			
			// Si la ventana pudo desasignar la brigada, proceso
			IF gu_comunic.is_comunic.programa_retorno="w_2302" THEN
				
				IF gu_comunic.is_comunic.accion_retorno = "aceptado"  THEN
					//tab_lista_brigadas.tabpage_no_disponibles.dw_brigadas_no_disponibles.DeleteRow(click_row)
					iw_contenedora.tab_1.fnu_agregar_brigada(d_lista_brigadas_ot,s_estructura)
					
					if (isnull(il_nro_ot) or il_nro_ot=0 )  then  
					   il_nro_ot=f_actualizar_ultima_ot()
					   tabpage_formulario.d_inf_general.Object.ot[1] = il_nro_ot
					   tabpage_ot.d_datos_ot.Object.nro_ot[1] = il_nro_ot
					   tabpage_ot.d_lista_brigadas_ot.object.nro_ot[1] = il_nro_ot
					   st_sin_ot.visible=false
					   cb_ot.visible = false
						
						if ii_estado_oper > fgci_incidencia_enviado_brigada and ld_fecha_ini_ot < idt_fecha_er then
							fnu_anadir_eb(ld_fecha_ini_ot)
						end if			
						
					end if
					
					li_disponible = 0
   				tab_lista_brigadas.fpr_quitar_brigada(tab_lista_brigadas.tabpage_no_disponibles.dw_brigadas_no_disponibles,s_estructura.nro_brigada)
			
					// Actualizo en la datawindow la nueva OT a la que esta asignada
					tab_lista_brigadas.fpr_actualizar_dw_no_disp(s_estructura, &
						il_nro_incidencia,ii_estado_oper,idt_fec_deteccion, &
						idec_nro_instalacion_afectada,ls_nom_instalacion,ii_tipo_incid, &
						ii_alcance,il_nro_ot,click_row,ll_ccli_afec)
						
					IF d_datos_ot.object.est_ot[1] = fgci_ot_resuelta THEN
						d_datos_ot.object.est_ot[1] = fgci_ot_trabajando
					END IF
				
				ELSE		// Si cancelo desbloqueo
					gnu_u_transaction.uf_unlock_brigada(ll_nro_brigada)
					Return
				END IF
						
			END IF
			
		END IF
	END IF

	IF (objeto.DataObject="d_bri_2004_pr_lista_brigadas_disp") or&
										(objeto.DataObject="d_con_2004_pr_lista_contratas")	THEN
		d_datos_ot.AcceptText()
		ll_nro_brigada=objeto.getitemnumber(click_row,'nro_brigada')
		
		IF (objeto.DataObject="d_bri_2004_pr_lista_brigadas_disp") THEN
			li_lock_status=gnu_u_transaction.uf_lock_brigada(ll_nro_brigada)
		ELSE
			li_lock_status = 0
		END IF

		
		IF li_lock_status<>0 THEN
			this.SelectRow(0, FALSE)
			//gnv_msg.f_mensaje("AI96","La Brigada","modificada",OK!)
			li_brig_permitida = 0
		ELSE	
			IF of_brigada_aun_disponible(ll_nro_brigada) THEN
				IF d_datos_ot.rowCount() <= 0 THEN
					d_datos_ot.insertrow(0)
				END IF
				ld_fecha_ini_ot = d_datos_ot.GetItemDateTime(1,"f_desde")
		
				if tipo_ot = 'BR' then
						s_estructura=tab_lista_brigadas.fpr_devolver_brigada(&
													tab_lista_brigadas.tabpage_disponibles.dw_brigadas_disponibles,&
													ld_fecha_ini_ot,click_row)
				else						

						s_estructura=tab_lista_brigadas.fpr_devolver_brigada(&
													dw_lista_contratas,&
													ld_fecha_ini_ot,click_row)			
				end if
				
				s_estructura.nro_ot=d_datos_ot.GetItemNumber(1,"nro_ot")
				li_brig_permitida = iw_contenedora.tab_1.frn_validar_drag_brigada(d_lista_brigadas_ot,s_estructura.nro_brigada)			//dsa

			
				IF (s_estructura.Click_Row > 0) AND (li_brig_permitida = 1) THEN
					// QUITARLO
					iw_contenedora.tab_1.fnu_agregar_brigada(d_lista_brigadas_ot,s_estructura)
					if (isnull(il_nro_ot) or il_nro_ot=0 )  then  
					   il_nro_ot=f_actualizar_ultima_ot()
					   tabpage_formulario.d_inf_general.Object.ot[1] = il_nro_ot
					   tabpage_ot.d_datos_ot.Object.nro_ot[1] = il_nro_ot
					   tabpage_ot.d_lista_brigadas_ot.object.nro_ot[1] = il_nro_ot
					   st_sin_ot.visible=false
					   cb_ot.visible = false
						If gi_pais = 8 Then
							tabpage_ot.d_datos_ot.Object.nro_ot_t.Visible = True
							tabpage_ot.d_datos_ot.Object.f_prepara_lm.Visible = True
							// GNU 23-09-2005 Incidencia 0/373898
//							tabpage_ot.d_datos_ot.Modify("f_prepara_lm.protect=0")
//							tabpage_ot.d_datos_ot.Modify("f_prepara_lm.background.color=" + gs_blanco)
//							// Fin GNU
						End IF
// Fin. Sgo.
					end if
					
					li_disponible = 1
				
					// DSA 23/02/2000 La contrata siempre esta disponible
					if tipo_ot = 'BR' then
						tab_lista_brigadas.fpr_quitar_brigada(&
										tab_lista_brigadas.tabpage_disponibles.dw_brigadas_disponibles,&
										s_estructura.nro_brigada)
					// Borro la brigada de la lista de disponibles
						tab_lista_brigadas.tabpage_disponibles.&
										dw_brigadas_disponibles.DeleteRow(click_row)
					else

						tab_lista_brigadas.fpr_quitar_brigada(&
										dw_lista_contratas,&
										s_estructura.nro_brigada)
					// Borro la brigada de la lista de disponibles
						dw_lista_contratas.DeleteRow(click_row)
					end if				
				
					IF d_datos_ot.object.est_ot[1] = fgci_ot_resuelta THEN
						d_datos_ot.object.est_ot[1] = fgci_ot_trabajando
					END IF
				
					if tipo_ot = 'BR'   then // DSA 23/02/2000
					// La agrego en la lista de no disponibles
					li_fila_no_dsp = tab_lista_brigadas.tabpage_no_disponibles.dw_brigadas_no_disponibles.InsertRow(0)
					
					tab_lista_brigadas.fpr_actualizar_dw_no_disp(s_estructura, &
								il_nro_incidencia,ii_estado_oper,idt_fec_deteccion, &
								idec_nro_instalacion_afectada,ls_nom_instalacion,ii_tipo_incid, &
								ii_alcance,il_nro_ot,li_fila_no_dsp,ll_ccli_afec)
					end if		
				ELSE
					if objeto.DataObject="d_bri_2004_pr_lista_brigadas_disp"  then // DSA 23/02/2000
						gnu_u_transaction.uf_unlock_brigada(ll_nro_brigada)
					end if				
				END IF
			ELSE // La brigada ya no se encuentra disponible
				gnu_u_transaction.uf_unlock_brigada(ll_nro_brigada)
				gnv_msg.f_mensaje("AI89","","",OK!)
				li_brig_permitida = 0
			END IF
		END IF
	END IF
END IF
This.BorderStyle = StyleRaised!
this.Drag(End!)
// chequea para ver si hay brigadas trabajando.
if ib_mensaje=true then 
	int li_contador
	boolean lb_hay_f_desde=false
	if ii_estado_oper >= fgci_incidencia_enviado_brigada and ii_estado_oper < fgci_incidencia_servicio_repuesto then
		for li_contador=1 to tabpage_ot.d_lista_brigadas_ot.rowcount()
			if not isnull(tabpage_ot.d_lista_brigadas_ot.object.f_desde[li_contador]) and &
				isnull(tabpage_ot.d_lista_brigadas_ot.object.f_hasta[li_contador]) then
				lb_hay_f_desde=true
			end if		 
		next
		if lb_hay_f_desde=true then
			ib_mensaje=false
			iw_contenedora.tab_1.f_deshab_tabs(false)
		end if
	end if
else
	iw_contenedora.tab_1.f_deshab_tabs(false)
end if

// Valida para ver si solo hay una brigada trabajando para mostrar o no el 

// boton brigada encargada


iw_contenedora.tab_1.tabpage_ot.d_lista_brigadas_ot.accepttext()
li_cant_brigadas= iw_contenedora.tab_1.tabpage_ot.d_lista_brigadas_ot.rowcount()
	
if li_cant_brigadas > 1 then
	for li_conta= 1 to li_cant_brigadas
		if isnull(iw_contenedora.tab_1.tabpage_ot.d_lista_brigadas_ot.object.f_hasta[li_conta]) then
			li_cont2 ++
		end if
	next
end if

if li_cont2>1 and objeto.DataObject="d_bri_2004_pr_lista_brigadas_disp"  then
	li_fila = This.Find("tipo = 'Brig.'", 0, this.rowCount())
	IF li_fila > 0 and li_fila < This.RowCount() THEN
		li_fila = This.Find("tipo = 'Brig.'", li_fila + 1 , this.rowCount())
		
		IF li_fila > 0 THEN
			iw_contenedora.tab_1.tabpage_ot.bmp_brigada_responsable.visible=true	
		ELSE
			iw_contenedora.tab_1.tabpage_ot.bmp_brigada_responsable.visible=False	
		END IF	
	END IF
END IF
	
if isnull(d_datos_ot.object.est_ot[1]) or d_datos_ot.object.est_ot[1] < 2 then
	d_datos_ot.object.est_ot[1]=fgci_ot_trabajando
end if

fnu_fecha_menor_prev()

IF This.RowCount() > 0 AND ii_alcance <> fgci_incidencia_con_interrupcion AND &
	NOT iw_contenedora.fw_incidencia_de_operaciones() THEN 
// A$$HEX1$$f100$$ENDHEX$$adido por Sgo. 06/07/2005. Mejora Moldavia.
	If gi_pais = 8 Then
//		tabpage_ot.d_datos_ot.Modify("f_prepara_lm.protect=0")
//		tabpage_ot.d_datos_ot.Modify("f_prepara_lm.background.color=" + gs_blanco)
	End If
// Fin. Sgo.
//	tabpage_ot.d_datos_ot.Modify("f_hasta.protect=0")
//	tabpage_ot.d_datos_ot.Modify("f_hasta.background.color="+gs_blanco)
END IF

IF ii_estado_oper < fgci_incidencia_enviado_brigada THEN
	tabpage_cuadrillas.enabled = TRUE
	tabpage_acciones.enabled = TRUE
END IF
end event

event dragenter;call super::dragenter;//  Fecha         Responsable   Actuaci$$HEX1$$f300$$ENDHEX$$n
// ---------    -------         ----------------------------------------
// 23/02/2000     DSA				Introducir las contratas
//
////////////////////////////////////////////////////////////////////////////////////////////////

datawindow objeto

objeto = source 
IF typeof(Objeto)=DataWindow! THEN
	IF objeto.DataObject="d_bri_2004_pr_lista_brigadas" OR &
			objeto.DataObject="d_bri_2004_pr_lista_brigadas_disp"    or &
			  objeto.DataObject="d_con_2004_pr_lista_contratas"		THEN // DSA 23/02/2000
		
		This.BorderStyle = StyleLowered!
				
 	END IF
END IF
end event

event dragleave;call super::dragleave;//  Fecha         Responsable   Actuaci$$HEX1$$f300$$ENDHEX$$n
// ---------    -------         ----------------------------------------
// 23/02/2000     DSA				Introducir las contratas
//
////////////////////////////////////////////////////////////////////////////////////////////////

datawindow objeto
//this.accepttext()
//this.setcolumn("f_desde")
objeto = source 
IF typeof(Objeto)=DataWindow! THEN
	IF objeto.DataObject="d_bri_2004_pr_lista_brigadas" OR &
			objeto.DataObject="d_bri_2004_pr_lista_brigadas_disp"    or &
			  objeto.DataObject="d_con_2004_pr_lista_contratas"		THEN // DSA 23/02/2000
		
		This.BorderStyle = StyleRaised!
 	END IF
END IF









end event

event itemchanged;int li_nueva_brig_resp, li_tipo, li_ya_trabajaba = 0
Datetime ldt_f_nula, ldt_fecha_ingresada, ldt_f_desde, ldt_min_f_maniobra, ldt_max_f_maniobra
Datetime ldt_f_max
string ls_columna_bri_ot 
long ll_nro_brig, ll_fila_fecha

this.Drag(End!)

if row>0 then
	SetNull(ldt_f_nula)
	ls_columna_bri_ot = dwo.name
	idt_f_brigada_old = This.GetItemDateTime(row,ls_columna_bri_ot)
		
	This.AcceptText()
//	This.PostEvent("ue_itemchanged")

	This.SetItem(row,"f_hasta",fgnu_valido_fecha_nula(This.GetItemDateTime(row,"f_hasta")))
	
	ldt_fecha_ingresada = This.GetItemDateTime(row,ls_columna_bri_ot)
	
	IF ls_columna_bri_ot = "f_desde" THEN
		IF ldt_fecha_ingresada = ldt_f_nula OR ISNULL(ldt_fecha_ingresada) THEN
			// La fecha de inicio de tareas no puede ser mayor que la fecha de su primera maniobra
			messagebox("Atenci$$HEX1$$f300$$ENDHEX$$n", "La fecha de inicio de tareas de brigada/contrata no puede ser nula")
			IF Not Isnull(idt_f_brigada_old) THEN
				This.SetItem(row, "f_desde", idt_f_brigada_old)
			ELSE
				This.SetItem(row, "f_desde", fgnu_fecha_actual())
			END IF
			This.AcceptText()
			return 1
		END IF
	END IF
	
	IF NOT This.fpr_validar_fechas(row, idt_f_brigada_old,ldt_fecha_ingresada,ls_columna_bri_ot) THEN
		Return 1
	END IF
	
	// Se comprueba que la fecha no sea posterior a la fecha de la maniobra asignada al equipo
	IF This.GetItemString(row, 'tipo') = 'Brig.' THEN
		li_tipo = 1
	ELSE
		li_tipo = 2
	END IF
	
	ll_nro_brig = This.GetItemNumber(row, 'nro_brigada')
		
	// Se comprueba que la brigada no estuviera trabajando en la OT a esa misma hora
	IF This.find("nro_brigada = " + string(ll_nro_brig) + & 
			 	    " and f_hasta > datetime('" + String(ldt_fecha_ingresada) + "') " + &
			  		 " and getrow() <> " + string(row) + " and tipo = '" + This.GetItemString(row, 'tipo') + "'", 1, This.RowCount()) > 0 THEN
	
		messagebox("Atenci$$HEX1$$f300$$ENDHEX$$n", "La fecha ingresada no puede ser menor que la fecha de fin de su $$HEX1$$fa00$$ENDHEX$$ltimo trabajo en la OT.")
		This.SetItem(row, ls_columna_bri_ot, fgnu_fecha_actual())
		This.AcceptText()
		return 1
	END IF
			
	// Se obtiene la fecha de la maniobra a partir de la cual se buscan la fecha m$$HEX1$$e100$$ENDHEX$$xima y m$$HEX1$$ed00$$ENDHEX$$nima
	ll_fila_fecha = 1
	
	DO WHILE ll_fila_fecha > 0 AND ll_fila_fecha <= This.RowCount()
		ll_fila_fecha = Find("nro_brigada = " + string(ll_nro_brig) + " and (not isnull(f_hasta)) " + &
									" and getrow() <> " + string(row) + " and tipo = '" + This.GetItemString(row, 'tipo') + "'", &
									ll_fila_fecha, This.RowCount())
									
		IF ll_fila_fecha > 0 THEN
			IF ldt_f_max < This.GetitemDateTime(ll_fila_fecha, 'f_hasta') THEN
				ldt_f_max = This.GetitemDateTime(ll_fila_fecha, 'f_hasta')
				li_ya_trabajaba = 1
			END IF
			
			ll_fila_fecha ++
		END IF									
	LOOP		
	
	SELECT MIN(FECHA_MANIOBRA), MAX(FECHA_MANIOBRA)
	INTO :ldt_min_f_maniobra, :ldt_max_f_maniobra
	FROM SGD_MANIOBRA, GI_MANIOBRA_BRIGADA
	WHERE SGD_MANIOBRA.NRO_INCIDENCIA = :il_nro_incidencia AND
			SGD_MANIOBRA.COD_MANIOBRA = GI_MANIOBRA_BRIGADA.COD_MANIOBRA AND
			GI_MANIOBRA_BRIGADA.NRO_BRIGADA = :ll_nro_brig AND
			GI_MANIOBRA_BRIGADA.TIPO = :li_tipo AND
			FECHA_MANIOBRA >= DECODE(:li_ya_trabajaba, 1, :ldt_f_max, FECHA_MANIOBRA);
	
	IF SQLCA.SQLCode = 0 THEN
		IF ls_columna_bri_ot = "f_desde" THEN
			IF ldt_fecha_ingresada > ldt_min_f_maniobra THEN
				// La fecha de inicio de tareas no puede ser mayor que la fecha de su primera maniobra
				messagebox("Atenci$$HEX1$$f300$$ENDHEX$$n", "La fecha de inicio de tareas de brigada/contrata no puede ser mayor que la fecha de su primera maniobra")
				This.SetItem(row, "f_desde", idt_f_brigada_old)
				This.AcceptText()
				return 1
			END IF
		ELSE
			IF ldt_fecha_ingresada < ldt_max_f_maniobra THEN
				messagebox("Atenci$$HEX1$$f300$$ENDHEX$$n", "La fecha de fin de tareas de brigada/contrata no puede ser menor que la fecha de su $$HEX1$$fa00$$ENDHEX$$ltima maniobra")
				This.SetItem(row, "f_hasta", idt_f_brigada_old)
				This.AcceptText()
				return 1
			END IF
		END IF
	END IF
	
	IF ls_columna_bri_ot = "f_desde" THEN
		// Si la fecha de hasta es menor que la fecha de desde, error
		IF ldt_fecha_ingresada >= fgnu_fecha_actual() THEN
			// La fecha de incicio de tareas no puede ser mayor que la fecha actual
			gnv_msg.f_mensaje("AI88", "", "", OK!)
			This.SetItem(row, "f_desde", fgnu_fecha_actual())
			This.AcceptText()
			return 1
		END IF
		IF ldt_fecha_ingresada < tabpage_formulario.d_inf_general.getitemdatetime(1, 'f_deteccion') THEN
			// La fecha de inicio de tareas no puede ser menor la fecha de detecci$$HEX1$$f300$$ENDHEX$$n de la incidencia
			gnv_msg.f_mensaje("AI108", "", "", OK!)
			This.SetItem(row, "f_desde", fgnu_fecha_actual())
			This.AcceptText()
			return 1
		END IF

		
	END IF
	
	IF ls_columna_bri_ot = "f_hasta" THEN

		// Si la fecha de hasta es menor que la fecha de desde, error
		IF ldt_fecha_ingresada < this.GetItemDateTime(row,"f_desde") THEN
			// La fecha de fin de tareas no puede ser menor que la fecha de inicio.
			//gnv_msg.f_mensaje("AI90", "", "", OK!)
			Messagebox("Atenci$$HEX1$$f300$$ENDHEX$$n", "La fecha de fin de tareas no puede ser menor que la fecha de inicio.")
			This.SetItem(row,"f_hasta",idt_f_brigada_old)
			This.AcceptText()
			return 1
		END IF
		
	END IF


	//IF NOT IsNull(This.GetItemDatetime(pi_fila, 'f_hasta')) THEN
	IF ls_columna_bri_ot = "f_hasta" AND NOT IsNull(ldt_fecha_ingresada) THEN
		IF This.GetItemstring(row,'tipo') = 'Brig.' THEN
			This.SetItem(row, 'trabajo_resuelto', '1')
		END IF
		This.SetItem(row, 'est_brigada', fgci_ot_resuelta)
		This.SetColumn("brigada")
		
		// Si es una brigada la que ha terminado su trabajo se comprueba si es responsable de la OT.
		// En caso de que sea responsable hay que escoger otra brigada responsable en caso de que 
		// exista. Si no hay m$$HEX1$$e100$$ENDHEX$$s brigadas se tiene que verificar que exista al menos una contrata
		IF This.GetItemstring(row,'tipo') = 'Brig.' AND &
			This.GetItemNumber(row, 'ind_responsable') = 1 THEN
		
			li_nueva_brig_resp = This.Find("ind_responsable = 0 and isnull(f_hasta) and tipo = 'Brig.'", 0, this.rowcount())
			IF li_nueva_brig_resp > 0 THEN
				fnu_asignar_responsable(d_lista_brigadas_ot,li_nueva_brig_resp)
			ELSE
			
				IF This.Find("isnull(f_hasta)", 1, This.RowCount()) <= 0 AND &
					ii_estado_oper < fgci_incidencia_servicio_repuesto THEN
					gnv_msg.f_mensaje("AI104","","",ok!)
				END IF
			END IF
		ELSE
			IF This.Find("isnull(f_hasta)", 1, This.RowCount()) <= 0 AND &
				ii_estado_oper < fgci_incidencia_servicio_repuesto THEN
				gnv_msg.f_mensaje("AI104","","",ok!)
			END IF
		END IF
	END IF


// DSA 29/03/2000	

  	if this.object.est_brigada[row] = 0 and ib_valido_ot=false then
	
		ldt_f_desde = d_lista_brigadas_ot.object.f_desde[row]
	
		if not isnull(ldt_f_desde)  then
			if (ldt_f_desde >= idt_f_actual AND ldt_f_desde <= idt_fec_deteccion) then
					this.object.est_brigada[row]=fgci_ot_trabajando
					//d_datos_ot.object.est_ot[1]=fgci_ot_trabajando
					//d_datos_ot.object.ind_trabajo[1] = 1
					
					// A$$HEX1$$d100$$ENDHEX$$ADIR ESTADO EB	
				
					if ii_estado_oper > fgci_incidencia_enviado_brigada and ldt_f_desde < idt_fecha_er &
					   and ii_incidencia_enviado_brigada = 0 then
						fnu_anadir_eb(ldt_f_desde)
					end if						
						
			end if
		end if
	end if
	d_datos_ot.object.est_ot[1]=fgci_ot_trabajando
	d_datos_ot.object.ind_trabajo[1] = 1
end if



end event

event scrollhorizontal;// Este Script soluciona el problema de que cuando un campo fecha esta cortado por la mitad 
// y se escribe se cae el sistema

long rows, ll_desp = 0
rows = this.rowcount() 

if  rows > 0 then
	if rows > 4 then
		ll_desp = 70
	end if
	//Guardamos el valor del campo para caso cuando el campo pierde el foco 
   //this.AcceptText() 
	

	if scrollpos < 140 + ll_desp  then
		SetTabOrder("f_hasta",0)
	else
		SetTabOrder("f_hasta",40)
	end if
	
end if


end event

event itemerror;//gnv_msg.f_mensaje("EO03","","",Ok!)

return 1
end event

event rowfocuschanged;call super::rowfocuschanged;//  Fecha         Responsable   Actuaci$$HEX1$$f300$$ENDHEX$$n
// ---------    -------         ----------------------------------------
// 23/02/2000     DSA				Introducir las contratas
//
////////////////////////////////////////////////////////////////////////////////////////////////

int li_fila

This.SetRedraw(False)
IF currentrow > 0 THEN
	IF This.GetItemstring(currentrow,'tipo') = 'Brig.' THEN
		li_fila = This.Find("tipo = 'Brig.'", 0, this.rowCount())
		IF li_fila > 0 and li_fila < This.RowCount() THEN
			li_fila = This.Find("tipo = 'Brig.'", li_fila + 1 , this.rowCount())
		
			IF li_fila > 0 THEN
				iw_contenedora.tab_1.tabpage_ot.bmp_brigada_responsable.visible=true	
			ELSE
				iw_contenedora.tab_1.tabpage_ot.bmp_brigada_responsable.visible=False	
			END IF	
		END IF
	ELSE
		iw_contenedora.tab_1.tabpage_ot.bmp_brigada_responsable.visible=False	

	END IF
END IF

This.SetRedraw(True)
end event

event losefocus;call super::losefocus;This.AcceptText()
end event

event ue_key_down;//
if key = KeyEnter! then
	this.accepttext()	
end if
end event

event retrievestart;call super::retrievestart;//messagebox("Informaci$$HEX1$$f300$$ENDHEX$$n","Retrieve",information!,ok!)
end event

event constructor;call super::constructor;this.SetTransObject(SQLCA)
end event

type dw_lista_contratas from u_gen_0002_pr_generico within tabpage_ot
boolean visible = false
integer x = 14
integer y = 916
integer width = 2304
integer height = 728
integer taborder = 11
string dataobject = "d_con_2004_pr_lista_contratas"
boolean vscrollbar = true
borderstyle borderstyle = styleraised!
end type

event clicked;call super::clicked;//  Fecha         Responsable   Actuaci$$HEX1$$f300$$ENDHEX$$n
// ---------    -------         ----------------------------------------
// 23/02/2000     DSA				Introducir las contratas
//
////////////////////////////////////////////////////////////////////////////////////////////////

IF iw_contenedora.tab_1.is_accion_llamada="Consulta" THEN
	Return
END IF


IF row > 0 THEN
	this.SelectRow(0, FALSE)

	this.SetRow(row)
	this.SelectRow(row,true)
	
	// Agregado por AFS
	iw_contenedora.tab_1.click_row = row
		//Si la ot no esta anulada permito el draged
	//IF ch_ot_anulada.Checked=FALSE THEN 
	//fg_SetRow(d_lista_brigadas)
	this.Drag(Begin!)
	//END IF
END IF

end event

event dragdrop;call super::dragdrop;//  Fecha         Responsable   Actuaci$$HEX1$$f300$$ENDHEX$$n
// ---------    -------         ----------------------------------------
// 23/02/2000     DSA				Introducir las contratas
//
////////////////////////////////////////////////////////////////////////////////////////////////
Datetime ldt_f_nula

This.SetRedraw(False)
su_drag_brigada_ot s_estructura 
long i, ll_cant_row
int li_brig_permitida,li_turno,li_disponible
int li_fila
int li_fila_no_disp=0
datawindow objeto

objeto = source
IF typeof(Objeto)=DataWindow! THEN
	IF objeto.DataObject="d_bri_2002_pr_list_brigadas_ot" THEN
		
		long xx
		xx = iw_contenedora.tab_1.click_row_brig_ot
		IF iw_contenedora.tab_1.tabpage_ot.d_lista_brigadas_ot.GetItemString(xx, 'tipo') = 'Cont.' THEN
			s_estructura = f_devolver_brigada_ot(d_lista_brigadas_ot,xx)
					
			d_lista_brigadas_ot.AcceptText()
			li_brig_permitida = frn_validar_quitar_brigada(d_lista_brigadas_ot,s_estructura.nro_brigada)
			// Si es la brigada mas vieja asignada a la OT, es decir, la brigada
			// cuya fecha de inicio de tareas coincide con  la fecha de EB, o es 
			// la $$HEX1$$fa00$$ENDHEX$$nica brigada asignada, no permito quitarla
//			IF iw_contenedora.tab_1.ii_estado_oper > fgci_incidencia_enviado_brigada THEN
//			
//				IF (s_estructura.f_desde = iw_contenedora.tab_1.idt_fecha_eb AND &
//					iw_contenedora.tab_1.tabpage_ot.d_lista_brigadas_ot.RowCount() > 1) OR &
//					(iw_contenedora.tab_1.tabpage_ot.d_lista_brigadas_ot.RowCount() = 1) THEN
//					
//					li_brig_permitida = 0
//					
//				END IF
//			
//			END IF
			IF (s_estructura.Click_Row >0) AND (li_brig_permitida=1) THEN
				// Borro la contrata de la lista de las asignadas
				iw_contenedora.tab_1.tabpage_ot.d_lista_brigadas_ot.DeleteRow(xx)
				This.Retrieve()	
			END IF	
		END IF
	END IF
END IF

IF d_lista_brigadas_ot.RowCount() = 0 THEN

// A$$HEX1$$f100$$ENDHEX$$adido por Sgo. 06/07/2005. Mejora Moldavia.
	If gi_pais = 8 Then
		d_datos_ot.Object.f_prepara_lm.Visible = False
		d_datos_ot.Modify("f_prepara_lm.protect=1")
		d_datos_ot.Modify("f_prepara_lm.background.color=" + gs_gris)
	End If
// Fin. Sgo.

	d_datos_ot.Modify("f_hasta.protect=1")
	d_datos_ot.Modify("f_hasta.background.color="+gs_gris)
	tabpage_cuadrillas.enabled = FALSE
	tabpage_acciones.enabled = FALSE
	SetNull(ldt_f_nula)
	tabpage_ot.d_datos_ot.SetItem(1, 'est_ot', fgci_ot_pendiente)
	tabpage_ot.d_datos_ot.SetItem(1, 'f_desde', ldt_f_nula)
	setnull(iw_contenedora.tab_1.il_nro_ot)
	iw_contenedora.tab_1.tabpage_ot.d_datos_ot.object.nro_ot[1] = iw_contenedora.tab_1.il_nro_ot
	If gi_pais <> 8 Then // A$$HEX1$$f100$$ENDHEX$$adido por Sgo. 14/06/2005. Mejora Moldavia.
		iw_contenedora.tab_1.tabpage_ot.st_sin_ot.visible = true
	End If // A$$HEX1$$f100$$ENDHEX$$adido por Sgo. 14/06/2005. Mejora Moldavia.
	IF iw_contenedora.tab_1.ii_incidencia_enviado_brigada <> 0 THEN
		iw_contenedora.tab_1.tabpage_seguimiento.d_seguimiento_operaciones.setitem(iw_contenedora.tab_1.ii_incidencia_enviado_brigada, 'f_alta', ldt_f_nula)
	END IF
		
END IF

This.SetRedraw(True)
this.Drag(End!)


end event

event sqlpreview;//
end event

event ue_as_need;//
end event

event constructor;call super::constructor;//  Fecha         Responsable   Actuaci$$HEX1$$f300$$ENDHEX$$n
// ---------    -------         ----------------------------------------
// 23/02/2000     DSA				Introducir las contratas
//
////////////////////////////////////////////////////////////////////////////////////////////////

iu_filtro.load(tabpage_ot.dw_lista_contratas)				  
end event

event retrieveend;call super::retrieveend;// Filtro por calendario
long ll_fila
long ll_nro_cont

SetPointer(HourGlass!)

IF rowcount <= 0 THEN Return

// Si no esta seleccionado "Brigadas en turno"
// entonces no filtro
IF tabpage_ot.d_crit_seleccion.GetItemNumber(1,"pi_brigadas_en_turno") = 1 THEN
	
	FOR ll_fila = 1 TO rowcount
		ll_nro_cont = This.Object.nro_brigada[ll_fila]
		
		IF NOT fw_equipo_disponible(ll_nro_cont,'CO') THEN
			SetPointer(HourGlass!)
			This.Object.ind_disponible[ll_fila] = 0
		END IF
	NEXT
	
	This.SetFilter('ind_disponible <> 0')
	This.Filter()
ELSE
	This.SetFilter('')
	This.Filter()
END IF
This.SetFilter('')


end event

type tab_lista_brigadas from u_tab_brigadas within tabpage_ot
boolean visible = false
integer x = 9
integer y = 916
integer width = 2313
integer height = 728
integer taborder = 2
end type

event selectionchanging;call super::selectionchanging;setpointer(hourglass!)

if newindex = 2 and  tab_lista_brigadas.il_retrieve = 0 then
	tab_lista_brigadas.tabpage_no_disponibles.dw_brigadas_no_disponibles.SetRedraw(FALSE)
	tab_lista_brigadas.tabpage_no_disponibles.dw_brigadas_no_disponibles.retrieve()
	tab_lista_brigadas.tabpage_no_disponibles.dw_brigadas_no_disponibles.SetRedraw(TRUE)
end if
end event

type d_crit_seleccion from datawindow within tabpage_ot
event ue_itemchanged ( )
boolean visible = false
integer x = 1600
integer y = 92
integer width = 1266
integer height = 216
integer taborder = 3
string dataobject = "d_bri_2019_crit_seleccion_2"
boolean border = false
boolean livescroll = true
end type

event ue_itemchanged();int ll_en_turno
long ll_ret
datetime ldt_fecha_turno
string ls_campo
int	li_brigadaW				//N$$HEX1$$fa00$$ENDHEX$$mero de fila de la brigada wireless


This.AcceptText()
ls_campo = this.GetColumnName()
// si el campo modificado es el de las brigadas en turno, entonces se conmuta el valor a mano
// para que el cambio tenga efecto antes de traer los datos, ya que de no ser a s$$HEX1$$ed00$$ENDHEX$$, el 
// cambio no tiene efecto hasta que no se sale de este script
IF ls_campo="pi_brigadas_en_turno" OR ls_campo="pdt_fecha_turno" THEN 
	IF ls_campo="pi_brigadas_en_turno" THEN
		ll_en_turno = getItemNumber(1, "pi_brigadas_en_turno")
		IF ll_en_turno = 0 THEN
//			This.Object.pdt_fecha_turno.Protect = 0
//			This.Object.pdt_fecha_turno.Background.color = gs_blanco
			SetItem(1, "pi_brigadas_en_turno",1)
		ELSE
			SetItem(1, "pi_brigadas_en_turno",0)
			This.Object.pdt_fecha_turno.Protect = 1
			This.Object.pdt_fecha_turno.Background.color = gs_gris
		END IF
	END IF
	ldt_fecha_turno = This.GetItemDatetime(1, 'pdt_fecha_turno')
	ll_ret = iw_contenedora.dw_brigadas_calendario_rango.Retrieve(Datetime(Date(ldt_fecha_turno)), ldt_fecha_turno)
END IF

SetPointer(HourGlass!)

iw_contenedora.tab_1.triggerevent("ue_armar_sql")
//filtro para que no haya repeticiones
if tipo_ot = 'BR' then//dsa   
	if tab_lista_brigadas.il_retrieve = 1 then
		tab_lista_brigadas.tabpage_no_disponibles.dw_brigadas_no_disponibles.SetRedraw(FALSE)
		tab_lista_brigadas.tabpage_no_disponibles.dw_brigadas_no_disponibles.retrieve()

	end if
	tab_lista_brigadas.tabpage_disponibles.dw_brigadas_disponibles.SetRedraw(FALSE)
	tab_lista_brigadas.tabpage_disponibles.dw_brigadas_disponibles.retrieve(IL_NRO_OT)
	tab_lista_brigadas.tabpage_no_disponibles.dw_brigadas_no_disponibles.SetRedraw(TRUE)
	tab_lista_brigadas.tabpage_disponibles.dw_brigadas_disponibles.SetRedraw(TRUE)

else
	dw_lista_contratas.SetRedraw(FALSE)
	dw_lista_contratas.Retrieve()	
	//AHM (23/01/2008)
	IF gi_pais = 6 THEN 			//Comprueba que es EPSA
		li_brigadaW = dw_lista_contratas.find("nro_brigada = 9001", 1, dw_lista_contratas.rowCount())
		IF li_brigadaW > 1 THEN		//Comprueba que se ha encontrado la brigada wireless
			dw_lista_contratas.deleteRow(li_brigadaW)
		END IF
	END IF
	//Fin AHM
	dw_lista_contratas.SetRedraw(TRUE)
end if
end event

event losefocus;This.AcceptText()
end event

event itemchanged;This.TriggerEvent('ue_itemchanged')
end event

type gb_2 from groupbox within tabpage_ot
boolean visible = false
integer x = 1513
integer y = 36
integer width = 1934
integer height = 308
integer taborder = 2
integer textsize = -10
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "MS Sans Serif"
long backcolor = 81324524
string text = " Criterios de Selecci$$HEX1$$f300$$ENDHEX$$n "
end type

type dw_ambito from u_cen_2001_pr_form_centro_cmd_mesa within tabpage_ot
boolean visible = false
integer width = 1010
integer height = 388
integer taborder = 13
boolean bringtotop = true
boolean border = false
end type

event itemchanged;call super::itemchanged;This.AcceptText()
tabpage_ot.d_crit_seleccion.setcolumn('pi_tipo_brig')
tabpage_ot.d_crit_seleccion.TriggerEvent("itemchanged")
end event

type d_datos_ot from datawindow within tabpage_ot
integer x = 27
integer y = 592
integer width = 4165
integer height = 1236
integer taborder = 12
string dataobject = "d_ot_2001_pr_form_orden_de_trabajo_inc"
boolean livescroll = true
borderstyle borderstyle = styleraised!
end type

event itemchanged;datetime ldt_f_hasta_antigua, ldt_f_hasta
datetime ldt_f_prep_lm_antigua, ldt_f_prep_lm // A$$HEX1$$f100$$ENDHEX$$adido por Sgo. Mejora Moldavia. 07/05/2005.
Integer li_msg_result = 0 // A$$HEX1$$f100$$ENDHEX$$adido por Sgo. Mejora Moldavia. 19/05/2005.
// GNU 22-2-2006. Incidencia 0/409566
datetime ldt_f_desde_max

//AHM (01/03/2010)
int	li_cant_trabajos			//Cantidad de trabajos asociados al descargo
int	li_ind_act_grafica		//Indicativo de actualizaci$$HEX1$$f300$$ENDHEX$$n gr$$HEX1$$e100$$ENDHEX$$fica
long	ll_nro_descargo 			//N$$HEX1$$fa00$$ENDHEX$$mero de descargo

//LSH INI 08/09/2013 evolutivo DEO12-00000263
//datetime ld_alta_max //LSH 24/02/2013 evolutivo DEO14-00000221
string ls_mia_fecha
//datetime ld_fecha_alta_inc //LSH 24/02/2013 evolutivo DEO14-00000221
datetime ldt_f_elim_antigua
datetime ld_f_elim_peligro_inc
//LSH FIN 08/09/2013 evolutivo DEO12-00000263

//LSH INI 24/02/2013 evolutivo DEO14-00000221
datetime ld_f_elim
datetime ld_f_det
datetime ld_det_max
//LSH  FIN 24/02/2013 evolutivo DEO14-00000221

//LSH INI 08/09/2013 correctivo DEO13-00000184
datetime ldt_null
setnull(ldt_null)
//LSH FIN 08/09/2013 correctivo DEO13-00000184

//LSH INI 08/09/2013 evolutivo DEO12-00000263
//fecha de alta de la incidencia
//LSH INI 24/02/2013 evolutivo DEO14-00000221
//ld_fecha_alta_inc = tabpage_formulario.d_inf_general.GetItemDatetime(1, 'f_alta')
//LSH FIN 24/02/2013 evolutivo DEO14-00000221
//fecha de alta de la incidencia mas 5 dias sumados, esto de acuerdo a la mejora
//LSH INI 24/02/2013 evolutivo DEO14-00000221
//ld_alta_max = datetime(RelativeDate(date(ld_fecha_alta_inc), 5) , time(ld_fecha_alta_inc))
//LSH INI 24/02/2013 evolutivo DEO14-00000221
//LSH FIN 08/09/2013 evolutivo DEO12-00000263



IF row > 0 THEN

// A$$HEX1$$f100$$ENDHEX$$adido por Sgo. Mejora Moldavia. 07/05/2005.
	If gi_pais = 8 Then
		IF dwo.name = 'f_prepara_lm' THEN
			ldt_f_prep_lm_antigua = This.GetItemDateTime(row, 'f_prepara_lm')
				
			This.AcceptText()
			ldt_f_prep_lm = This.GetItemDateTime(row, 'f_prepara_lm')

			// Se comprueba que la fecha no sea mayor que la fecha actual
			IF ldt_f_prep_lm > fgnu_fecha_actual() THEN
				MessageBox("Atenci$$HEX1$$f300$$ENDHEX$$n", "La fecha de Preparaci$$HEX1$$f300$$ENDHEX$$n LM introducida no puede ser mayor que la fecha actual")
				This.SetItem(row, 'f_prepara_lm', ldt_f_prep_lm_antigua)
				Return 1
			END IF

			// Se comprueba que la fecha sea menor que la fecha de inicio de tareas de las brigadas/contratas
			IF d_lista_brigadas_ot.Find("f_desde < datetime('" + string(ldt_f_prep_lm) + "')", 0, d_lista_brigadas_ot.RowCount()) > 0 THEN
				If MessageBox("Atenci$$HEX1$$f300$$ENDHEX$$n", "La fecha de Preparaci$$HEX1$$f300$$ENDHEX$$n LM es mayor que el tiempo de Inicio de Tareas, $$HEX1$$bf00$$ENDHEX$$Desea continuar?", Question!, OKCANCEL!) = 1 Then
					This.SetItem(row, 'f_prepara_lm', ldt_f_prep_lm_antigua)
				Else
					This.SetItem(row, 'f_prepara_lm', fgnu_fecha_actual())
				End If
			END IF

//			f_changing(3,3)
			This.SetColumn('f_prepara_lm')
			This.SetFocus()

		END IF //IF dwo.name = 'f_prepara_lm' THEN
	End If // If gi_pais = 8 Then
// Fin. Sgo.


	//LSH INI 08/09/2013 evolutivo DEO12-00000263
	IF dwo.name = 'f_elim_peligro' THEN
		
		This.AcceptText()
		//LSH INI 01/01/2014 correctivo DEO13-00000184
		//ldt_f_elim_antigua = This.GetItemDateTime(row, 'f_elim_peligro')
		ldt_f_elim_antigua = ldt_null
		//LSH FIN 01/01/2014 correctivo DEO13-00000184
		
		
		//LSH INI 24/02/2013 evolutivo DEO14-00000221
		ld_f_elim = This.GetItemDateTime(1, 'f_elim_peligro')
		ld_f_det = tabpage_formulario.d_inf_general.getitemdatetime(1,'f_deteccion')
		//ld_det_max = datetime(RelativeDate(date(ld_f_det), 5) , time(ld_f_det))
		ld_det_max = datetime(RelativeDate(date(ld_f_det), 3) , time(ld_f_det))

		//LSH  INI 24/02/2013 evolutivo DEO14-00000221
		//messagebox("f_elim_peligro",string(ld_f_elim))
		//messagebox("ld_f_det", string(ld_f_det))		
		//IF This.GetItemDateTime(row, 'f_elim_peligro') <= ld_fecha_alta_inc THEN
		//LSH  INI 09/06/2014 evolutivo DEO14-00000499
		//IF ld_f_elim <= ld_f_det THEN
		IF ld_f_elim < ld_f_det THEN
			//Messagebox("Atencion","La fecha de eliminacion de peligro no puede ser menor o igual que la fecha de alta de la incidencia",Exclamation!)
			//Messagebox("Atencion","La fecha de eliminaci$$HEX1$$f300$$ENDHEX$$n de peligro no puede ser menor que la fecha de detecci$$HEX1$$f300$$ENDHEX$$n de la incidencia",Exclamation!)
			Messagebox("Atencion","La fecha de eliminaci$$HEX1$$f300$$ENDHEX$$n de peligro no puede ser menor que la fecha de detecci$$HEX1$$f300$$ENDHEX$$n de la incidencia",Exclamation!)
		//LSH  FIN 09/06/2014 evolutivo DEO14-00000499
		//LSH  INI 24/02/2013 evolutivo DEO14-00000221
			This.SetItem(row, 'f_elim_peligro', ldt_null)//LSH 01/01/2014 correctivo DEO13-00000184
			idt_fec_elim_peligro = ldt_null//LSH 01/01/2014 correctivo DEO13-00000184
			tabpage_formulario.d_inf_general.SetItem(1,"f_elim_peligro", ldt_null)//LSH 01/01/2014 correctivo DEO13-00000184
			This.AcceptText()
			This.SetColumn('f_elim_peligro')		
			Return 1
		END IF
	
		IF ld_f_elim > ld_det_max THEN //LSH 24/02/2013 evolutivo DEO14-00000221
			Messagebox("Atencion","La fecha de eliminaci$$HEX1$$f300$$ENDHEX$$n de peligro no debe sobrepasar 3 d$$HEX1$$ed00$$ENDHEX$$as despu$$HEX1$$e900$$ENDHEX$$s de la fecha de detecci$$HEX1$$f300$$ENDHEX$$n de la incidencia", Exclamation!)
			This.SetItem(row, 'f_elim_peligro', ldt_null)//LSH 01/01/2014 correctivo DEO13-00000184
			idt_fec_elim_peligro = ldt_null//LSH 01/01/2014 correctivo DEO13-00000184
			tabpage_formulario.d_inf_general.SetItem(1,"f_elim_peligro", ldt_null)//LSH 01/01/2014 correctivo DEO13-00000184
			This.AcceptText()
			This.SetColumn('f_elim_peligro')		
			Return 1
		END IF
		
		IF ld_f_elim <> datetime("01/01/1900 00:00:00") THEN
			tabpage_formulario.d_inf_general.SetItem(1,"f_elim_peligro", This.GetItemDateTime(row, 'f_elim_peligro'))
			idt_fec_elim_peligro = ldt_f_elim_antigua
		END IF		
	END IF
	//LSH FIN 08/09/2013 evolutivo DEO12-00000263

	IF dwo.name = 'f_hasta' THEN
		ldt_f_hasta_antigua = This.GetItemDateTime(row, 'f_hasta')
// Modificado por Sgo. Mejora Moldavia. 19/05/2005.
//		IF	gnv_msg.f_mensaje("CO01", "", "", OKCANCEL!) = 1 THEN
		If	gi_pais = 8 Then
			//AHM(01/03/2010)
			IF ii_tipo_incid = fgci_incidencia_programada THEN
				// COMPROBAMOS SI ES CON TRABJO GRAFICO DE BDI
				SELECT nvl("SGD_DESCARGOS"."IND_ACT_GRAFICA",0),nro_descargo
				INTO :li_ind_act_grafica,:ll_nro_descargo  
				FROM "SGD_DESCARGOS"  
				WHERE "SGD_DESCARGOS"."NRO_INCIDENCIA" = :il_nro_incidencia   ;

				IF li_ind_act_grafica = 1 THEN
					// Comprobamos si todav$$HEX1$$ed00$$ENDHEX$$a se est$$HEX2$$e1002000$$ENDHEX$$gestionando el trabajo
//					SELECT count(*) 
//					INTO :li_cant_trabajos 
//					FROM sgd_trabajos_bdi 
//					WHERE nro_descargo = :ll_nro_descargo;
//				
//					IF lI_cant_trabajos > 0 THEN
						li_msg_result = gnv_msg.f_mensaje("CO01", "", "", OKCANCEL!)
//					END IF
				ELSE
					li_msg_result = messagebox("Atenci$$HEX1$$f300$$ENDHEX$$n", "Esta opci$$HEX1$$f300$$ENDHEX$$n Finalizar$$HEX2$$e1002000$$ENDHEX$$la OT y el trabajo de todas las brigadas que se encuentren en ella trabajando, y Resolver$$HEX2$$e1002000$$ENDHEX$$la Incidencia. $$HEX1$$bf00$$ENDHEX$$Desea continuar con esta operaci$$HEX1$$f300$$ENDHEX$$n?", Question!, OKCANCEL!)
				END IF
			ELSE
				li_msg_result = messagebox("Atenci$$HEX1$$f300$$ENDHEX$$n", "Esta opci$$HEX1$$f300$$ENDHEX$$n Finalizar$$HEX2$$e1002000$$ENDHEX$$la OT y el trabajo de todas las brigadas que se encuentren en ella trabajando, y Resolver$$HEX2$$e1002000$$ENDHEX$$la Incidencia. $$HEX1$$bf00$$ENDHEX$$Desea continuar con esta operaci$$HEX1$$f300$$ENDHEX$$n?", Question!, OKCANCEL!)
			END IF
		Else
			li_msg_result = gnv_msg.f_mensaje("CO01", "", "", OKCANCEL!)
		End If
		IF	li_msg_result = 1 THEN
// Fin. Sgo.

			
			This.AcceptText()
			ldt_f_hasta = This.GetItemDateTime(row, 'f_hasta')
			
			// Se comprueba que la fecha no sea mayor que la fecha actual

			IF ldt_f_hasta > fgnu_fecha_actual() THEN
				MessageBox("Atenci$$HEX1$$f300$$ENDHEX$$n", "La fecha de finalizaci$$HEX1$$f300$$ENDHEX$$n de la OT no puede ser mayor que la fecha actual")
				This.SetItem(row, 'f_hasta', ldt_f_hasta_antigua)
				Return 1
			END IF
			
			// Se comprueba que la fecha no sea menor que la fecha de alta de la OT
			IF ldt_f_hasta < This.GetItemDatetime(row, 'f_desde') THEN
				MessageBox("Atenci$$HEX1$$f300$$ENDHEX$$n", "La fecha de finalizaci$$HEX1$$f300$$ENDHEX$$n de la OT no puede ser menor que la fecha de alta de la OT")
				This.SetItem(row, 'f_hasta', ldt_f_hasta_antigua)
				Return 1
			END IF
			
			// Se comprueba que la fecha no sea menor que la fecha de finalizaci$$HEX1$$f300$$ENDHEX$$n del trabajo de
			// las brigadas/contratas
			long ll
			ll = d_lista_brigadas_ot.Find("f_hasta > datetime('" + string(ldt_f_hasta) + "')", 0, d_lista_brigadas_ot.RowCount())
			IF d_lista_brigadas_ot.Find("f_hasta > datetime('" + string(ldt_f_hasta) + "')", 0, d_lista_brigadas_ot.RowCount()) > 0 THEN
				MessageBox("Atenci$$HEX1$$f300$$ENDHEX$$n", "La fecha de finalizaci$$HEX1$$f300$$ENDHEX$$n de la OT no puede ser menor que la fecha de finalizaci$$HEX1$$f300$$ENDHEX$$n del trabajo de las brigadas")
				This.SetItem(row, 'f_hasta', ldt_f_hasta_antigua)
				Return 1
			END IF
			
			// Se comprueba que la fecha de finalizaci$$HEX1$$f300$$ENDHEX$$n de la OT sea superior a la fecha de 
			// las maniobras si la incidencia es de Operaci$$HEX1$$f300$$ENDHEX$$n
			// GNU 22-2-2006. Incidencia 0/409566
			IF d_lista_brigadas_ot.Find("f_desde > datetime('" + string(ldt_f_hasta) + "')", 0, d_lista_brigadas_ot.RowCount()) > 0 THEN
				MessageBox("Atenci$$HEX1$$f300$$ENDHEX$$n", "La fecha de finalizaci$$HEX1$$f300$$ENDHEX$$n de la OT no puede ser menor que la fecha de inicio del trabajo de las brigadas")
				This.SetItem(row, 'f_hasta', ldt_f_hasta_antigua)	
				Return 1
			END IF
			// FIN GNU
			
			IF iw_contenedora.fw_incidencia_de_operaciones() THEN
				IF tabpage_maniobras.dw_maniobras.Find("fecha_maniobra > datetime('" + string(ldt_f_hasta) + "')", 0, tabpage_maniobras.dw_maniobras.RowCount()) > 0 THEN
					MessageBox("Atenci$$HEX1$$f300$$ENDHEX$$n", "La fecha de finalizaci$$HEX1$$f300$$ENDHEX$$n de la OT no puede ser menor que la fecha de la $$HEX1$$fa00$$ENDHEX$$ltima maniobra")
					This.SetItem(row, 'f_hasta', ldt_f_hasta_antigua)
					Return 1
				END IF
			END IF
		
			f_changing(3,3)
			
			IF fnu_finalizar_ot(ldt_f_hasta) = -1 THEN
				This.SetItem(row, 'f_hasta', ldt_f_hasta_antigua)
				Return 1
			END IF
			
			tabpage_ot.d_datos_ot.SetColumn('f_hasta')
			tabpage_ot.d_datos_ot.SetFocus()
			
			IF ii_alcance = fgci_incidencia_de_suministro or ii_tipo_incid = fgci_incidencia_calidad THEN
				idt_fecha_sr = ldt_f_hasta
			END IF
			
			d_lista_brigadas_ot.setcolumn('brigada')

// A$$HEX1$$f100$$ENDHEX$$adido por Sgo. Mejora de Moldavia. 19/05/2005.
			//AHM (01/03/2010)
			If gi_pais = 8 AND li_ind_act_grafica <> 1 Then
				If ii_estado_oper >= ii_incidencia_servicio_repuesto Then
//				If ii_estado_oper = ii_incidencia_resuelta Then
					tabpage_seguimiento.d_seguimiento_operaciones.SetItem(ii_incidencia_resuelta,"f_alta", ldt_f_hasta)
					il_ultima_fila_clickeada_seg = ii_incidencia_resuelta
					tabpage_seguimiento.d_seguimiento_operaciones.TriggerEvent("ue_item_changed")
				End If
			End If
// Fin. Sgo.
		ELSE
			This.SetItem(row, 'f_hasta', ldt_f_hasta_antigua)
			Return 1
		END IF
	END IF

END IF


end event

event itemerror;return 1
end event

event losefocus;This.AcceptText()

end event

event constructor;this.SetTransObject(SQLCA)
end event

type tabpage_cuadrillas from userobject within u_tab_2301_form_incidencias
integer x = 18
integer y = 112
integer width = 5527
integer height = 3872
long backcolor = 79741120
string text = "Materiales"
long tabtextcolor = 33554432
long tabbackcolor = 79741120
string picturename = "Application!"
long picturemaskcolor = 553648127
cb_eliminar cb_eliminar
cb_agregar cb_agregar
d_materiales d_materiales
end type

on tabpage_cuadrillas.create
this.cb_eliminar=create cb_eliminar
this.cb_agregar=create cb_agregar
this.d_materiales=create d_materiales
this.Control[]={this.cb_eliminar,&
this.cb_agregar,&
this.d_materiales}
end on

on tabpage_cuadrillas.destroy
destroy(this.cb_eliminar)
destroy(this.cb_agregar)
destroy(this.d_materiales)
end on

type cb_eliminar from u_cb within tabpage_cuadrillas
event clicked pbm_bnclicked
integer x = 2501
integer y = 1412
integer width = 411
integer height = 96
integer taborder = 2
fontcharset fontcharset = ansi!
string facename = "MS Sans Serif"
string text = "&Eliminar"
end type

event clicked;call super::clicked;
IF gnv_msg.f_mensaje("CM05","","",YesNo!) = 1 THEN
	d_materiales.DeleteRow(0)
//	ib_modif = False
	IF d_materiales.RowCount() <= 0 THEN
		cb_eliminar.enabled = False
	END IF
END IF
end event

type cb_agregar from u_cb within tabpage_cuadrillas
event clicked pbm_bnclicked
integer x = 672
integer y = 1412
integer width = 411
integer height = 96
integer taborder = 2
fontcharset fontcharset = ansi!
string facename = "MS Sans Serif"
string text = "&Agregar"
end type

event clicked;int li_ultima_fila

d_materiales.InsertRow(0)

li_ultima_fila = d_materiales.RowCount()
d_materiales.SetRow(li_ultima_fila)
d_materiales.ScrollToRow(li_ultima_fila)
//d_materiales.SetItem(li_ultima_fila,"cdescripcion","Seleccione un Material")

d_materiales.SetItem(li_ultima_fila,"tipo_usuario",-1)
d_materiales.SetItem(li_ultima_fila,"ind_oper",1)

cb_eliminar.enabled = True

d_materiales.triggerevent("ue_dblclicked")
d_materiales.Setfocus()
d_materiales.setcolumn('materiales_cantidad')

end event

type d_materiales from u_bri_2005_pr_materiales_incidencia within tabpage_cuadrillas
event ue_clicked pbm_custom50
event ue_dblclicked ( long row )
integer x = 91
integer y = 80
integer width = 3278
integer height = 1256
integer taborder = 2
boolean vscrollbar = true
borderstyle borderstyle = styleraised!
end type

event ue_clicked;// En este evento valido que si el usuario es del mismo tipo que el que
// ingres$$HEX2$$f3002000$$ENDHEX$$el registro clickeado (esto es, operaciones o mantenimiento)
// le permito eliminarlo, en caso contrario no.

int li_protect

IF ii_fila_selec_mat >0 THEN
	
	This.SetRow(ii_fila_selec_mat)
	This.ScrollToRow(ii_fila_selec_mat)
	This.SetColumn("materiales_cantidad")
	
	li_protect = This.GetItemNumber(ii_fila_selec_mat,"tipo_usuario") + This.GetItemNumber(ii_fila_selec_mat,"ind_oper")

	IF li_protect <> 0 THEN
		cb_eliminar.enabled = False
		
	ELSE
		cb_eliminar.enabled = True
		
	END IF

END IF

end event

event ue_dblclicked;string ls_codigo, ls_descripcion, ls_unidades
long li_ya_existe

// Si se realiz$$HEX2$$f3002000$$ENDHEX$$el dobleclick sobre el icono se abre la ventana de ayuda
// que contiene el $$HEX1$$e100$$ENDHEX$$rbol de selecci$$HEX1$$f300$$ENDHEX$$n de materiales
 

IF this.getrow() > 0 THEN
	Open(w_2401_ayuda_materiales)

	// Recupero el codigo y la descripcion del material retornados
	// por la ventana de ayuda
	
	ls_codigo = gu_comunic.is_comunic.strval1
	ls_descripcion = gu_comunic.is_comunic.strval2
	ls_unidades = gu_comunic.is_comunic.strval3
	
	// Si la ventana de materiales devolvi$$HEX2$$f3002000$$ENDHEX$$un codigo v$$HEX1$$e100$$ENDHEX$$lido
	IF Len(Trim(ls_codigo)) > 0 THEN
		//	Valido que el material seleccionado no est$$HEX2$$e9002000$$ENDHEX$$ya ingresado 
		li_ya_existe = This.Find("materiales_material = '" + ls_codigo + "'" ,1,This.RowCount())
		IF li_ya_existe > 0 THEN // Si lo encontr$$HEX1$$f300$$ENDHEX$$
			gnv_msg.f_mensaje("EI34","","",OK!)  // Mensaje que ya existe ese material
			d_materiales.SetFocus()
			ib_valido_mat = False
		
		ELSEIF li_ya_existe = 0 THEN // Si no lo encontr$$HEX1$$f300$$ENDHEX$$
			// Seteo la datawindow con los datos recibidos
			This.SetItem(this.getrow(),"cdescripcion",ls_descripcion)
			This.SetItem(this.getrow(),"materiales_material",ls_codigo)
			This.SetItem(this.getrow(),"unidad_medida",ls_unidades)
			ib_valido_mat = True
						
		END IF
	END IF
	if ib_valido_mat = false or len(trim(ls_codigo)) < 1 or isnull(ls_codigo ) then
			this.deleterow(this.getrow())
			if this.rowcount() = 0 then
				cb_eliminar.enabled = false
			end if
	end if
END IF

end event

event clicked;call super::clicked;

ii_fila_selec_mat = row

This.TriggerEvent("ue_clicked")



end event

event itemerror;call super::itemerror;string a, ls_titulo, ls_modstring

ls_modstring = "Debe introducir una cantidad v$$HEX1$$e100$$ENDHEX$$lida"
ls_titulo = "Datawindow.message.title='Atenci$$HEX1$$f300$$ENDHEX$$n'"
a = This.Modify(ls_titulo)
ls_modstring = "materiales_cantidad.ValidationMsg='" + ls_modstring + "'"
a = This.Modify(ls_modstring)

ib_valido_mat = False
This.SetFocus()

end event

event retrieveend;int j
this.SetRedraw(false)

	FOR j = 1 TO This.RowCount()
		This.SetItem(j,"tipo_usuario",-1)
	NEXT

FOR j=1 to This.RowCount()
	IF This.GetItemNumber(j,"tipo_usuario") + This.GetItemNumber(j,"ind_oper") = 0 THEN
		
		ii_fila_selec_mat = j
		This.TriggerEvent("ue_clicked")
		Exit
	END IF

NEXT

this.SetRedraw(true)

end event

event constructor;call super::constructor;SetRowFocusIndicator(Hand!)

this.SetTransObject(SQLCA)
end event

event ue_key_down;//

end event

event getfocus;call super::getfocus;IF This.Rowcount() > 0 AND KeyDown(KeyTab!) THEN
	This.SetRow(1)
	This.ScrollToRow(1)
	This.SetColumn("materiales_cantidad")
END IF
end event

type tabpage_interrupciones from userobject within u_tab_2301_form_incidencias
integer x = 18
integer y = 112
integer width = 5527
integer height = 3872
long backcolor = 79741120
string text = "Interrupciones"
long tabtextcolor = 33554432
long tabbackcolor = 79741120
string picturename = ".\recursos\INCORPOR.bmp"
long picturemaskcolor = 553648127
cb_1 cb_1
uo_eltos_corte uo_eltos_corte
dw_lista_int_comunes dw_lista_int_comunes
pb_anterior pb_anterior
st_fases_afect st_fases_afect
cbx_fase_c cbx_fase_c
cbx_fase_b cbx_fase_b
cbx_fase_a cbx_fase_a
pb_avanzar pb_avanzar
st_duracion_total st_duracion_total
st_durac_total st_durac_total
st_datos_interrup st_datos_interrup
st_durac st_durac
st_duracion st_duracion
st_lista_int_operaciones st_lista_int_operaciones
cb_separador cb_separador
st_otras_inst st_otras_inst
rb_otras_inc rb_otras_inc
rb_misma_inc rb_misma_inc
dw_afec_parcial_sum dw_afec_parcial_sum
dw_sin_interrupcion dw_sin_interrupcion
d_datos_interrup d_datos_interrup
dw_lista_int_operaciones dw_lista_int_operaciones
d_lista_otras_inst_ant d_lista_otras_inst_ant
dw_lista_acometidas dw_lista_acometidas
d_lista_otras_inst d_lista_otras_inst
tv_1 tv_1
end type

on tabpage_interrupciones.create
this.cb_1=create cb_1
this.uo_eltos_corte=create uo_eltos_corte
this.dw_lista_int_comunes=create dw_lista_int_comunes
this.pb_anterior=create pb_anterior
this.st_fases_afect=create st_fases_afect
this.cbx_fase_c=create cbx_fase_c
this.cbx_fase_b=create cbx_fase_b
this.cbx_fase_a=create cbx_fase_a
this.pb_avanzar=create pb_avanzar
this.st_duracion_total=create st_duracion_total
this.st_durac_total=create st_durac_total
this.st_datos_interrup=create st_datos_interrup
this.st_durac=create st_durac
this.st_duracion=create st_duracion
this.st_lista_int_operaciones=create st_lista_int_operaciones
this.cb_separador=create cb_separador
this.st_otras_inst=create st_otras_inst
this.rb_otras_inc=create rb_otras_inc
this.rb_misma_inc=create rb_misma_inc
this.dw_afec_parcial_sum=create dw_afec_parcial_sum
this.dw_sin_interrupcion=create dw_sin_interrupcion
this.d_datos_interrup=create d_datos_interrup
this.dw_lista_int_operaciones=create dw_lista_int_operaciones
this.d_lista_otras_inst_ant=create d_lista_otras_inst_ant
this.dw_lista_acometidas=create dw_lista_acometidas
this.d_lista_otras_inst=create d_lista_otras_inst
this.tv_1=create tv_1
this.Control[]={this.cb_1,&
this.uo_eltos_corte,&
this.dw_lista_int_comunes,&
this.pb_anterior,&
this.st_fases_afect,&
this.cbx_fase_c,&
this.cbx_fase_b,&
this.cbx_fase_a,&
this.pb_avanzar,&
this.st_duracion_total,&
this.st_durac_total,&
this.st_datos_interrup,&
this.st_durac,&
this.st_duracion,&
this.st_lista_int_operaciones,&
this.cb_separador,&
this.st_otras_inst,&
this.rb_otras_inc,&
this.rb_misma_inc,&
this.dw_afec_parcial_sum,&
this.dw_sin_interrupcion,&
this.d_datos_interrup,&
this.dw_lista_int_operaciones,&
this.d_lista_otras_inst_ant,&
this.dw_lista_acometidas,&
this.d_lista_otras_inst,&
this.tv_1}
end on

on tabpage_interrupciones.destroy
destroy(this.cb_1)
destroy(this.uo_eltos_corte)
destroy(this.dw_lista_int_comunes)
destroy(this.pb_anterior)
destroy(this.st_fases_afect)
destroy(this.cbx_fase_c)
destroy(this.cbx_fase_b)
destroy(this.cbx_fase_a)
destroy(this.pb_avanzar)
destroy(this.st_duracion_total)
destroy(this.st_durac_total)
destroy(this.st_datos_interrup)
destroy(this.st_durac)
destroy(this.st_duracion)
destroy(this.st_lista_int_operaciones)
destroy(this.cb_separador)
destroy(this.st_otras_inst)
destroy(this.rb_otras_inc)
destroy(this.rb_misma_inc)
destroy(this.dw_afec_parcial_sum)
destroy(this.dw_sin_interrupcion)
destroy(this.d_datos_interrup)
destroy(this.dw_lista_int_operaciones)
destroy(this.d_lista_otras_inst_ant)
destroy(this.dw_lista_acometidas)
destroy(this.d_lista_otras_inst)
destroy(this.tv_1)
end on

type cb_1 from commandbutton within tabpage_interrupciones
boolean visible = false
integer x = 1746
integer y = 828
integer width = 466
integer height = 80
integer taborder = 12
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "MS Sans Serif"
string text = "Elementos de Corte"
end type

event clicked;long ll_cant_eltos=0,ll_cant

tabpage_interrupciones.uo_eltos_corte.idec_nro_instalacion_afectada = idec_nro_instalacion_afectada

IF uo_eltos_corte.visible = false THEN
	uo_eltos_corte.visible = true
	This.Text = '&Ocultar'
ELSE
	uo_eltos_corte.visible = false
	This.Text = '&Elementos de Corte'
END IF

SELECT SUM(ELTO)
INTO :ll_cant_eltos FROM
	(SELECT COUNT(*) ELTO 
	FROM SGD_ELEMENTOS_CORTE_INC  
	WHERE NRO_INCIDENCIA = :il_nro_incidencia 
	UNION
	SELECT COUNT(*) ELTO 
	FROM GI_HIST_ELEMENTOS_CORTE_INC 
	WHERE NRO_INCIDENCIA = :il_nro_incidencia);

//if ll_cant_eltos = 0 and ii_estado_oper = fgci_incidencia_resuelta then return
	
if uo_eltos_corte.dw_elementos_corte.rowcount() = 0 then
	DataWindowChild dwc_eltos
	uo_eltos_corte.dw_elementos_corte.GetChild("matricula", dwc_eltos)
	dwc_eltos.SetTransObject(SQLCA)
	ll_cant = dwc_eltos.Retrieve(idec_nro_instalacion_afectada)
	if ll_cant <> 0 or ll_cant_eltos <> 0 then 
		uo_eltos_corte.dw_elementos_corte.retrieve(il_nro_incidencia)
	else
		return
	end if
end if
	
if tabpage_interrupciones.uo_eltos_corte.dw_elementos_corte.rowcount() > 0 and ii_estado_oper > fgci_incidencia_servicio_repuesto then
	tabpage_interrupciones.uo_eltos_corte.dw_elementos_corte.object.matricula.protect = true
	tabpage_interrupciones.uo_eltos_corte.dw_elementos_corte.object.matricula.background.color = gs_gris		
end if



//IF uo_eltos_corte.visible = false THEN
//	uo_eltos_corte.visible = true
//	This.Text = '&Ocultar'
//ELSE
//	uo_eltos_corte.visible = false
//	This.Text = '&Elementos de Corte'
//END IF
//
//if uo_eltos_corte.dw_elementos_corte.rowcount() = 0 then
//	DataWindowChild dwc_eltos
//	uo_eltos_corte.dw_elementos_corte.GetChild("matricula", dwc_eltos)
//	dwc_eltos.SetTransObject(SQLCA)
//	dwc_eltos.Retrieve(idec_nro_instalacion_afectada)
//	uo_eltos_corte.dw_elementos_corte.retrieve(il_nro_incidencia)
//end if
//if tabpage_interrupciones.uo_eltos_corte.dw_elementos_corte.rowcount() > 0 and ii_estado_oper > fgci_incidencia_servicio_repuesto then
//	tabpage_interrupciones.uo_eltos_corte.dw_elementos_corte.object.matricula.protect = true
//	tabpage_interrupciones.uo_eltos_corte.dw_elementos_corte.object.matricula.background.color = gs_gris		
//end if
end event

event constructor;This.visible = fg_verifica_parametro('ELEMENTOS CORTE')

end event

type uo_eltos_corte from u_elementos_corte within tabpage_interrupciones
event destroy ( )
boolean visible = false
integer x = 1033
integer y = 316
integer taborder = 23
end type

on uo_eltos_corte.destroy
call u_elementos_corte::destroy
end on

type dw_lista_int_comunes from datawindow within tabpage_interrupciones
boolean visible = false
integer x = 805
integer y = 228
integer width = 1266
integer height = 240
integer taborder = 23
string dataobject = "d_lista_interrupciones_inc"
boolean livescroll = true
borderstyle borderstyle = stylelowered!
end type

type pb_anterior from picturebutton within tabpage_interrupciones
boolean visible = false
integer y = 1668
integer width = 101
integer height = 88
integer taborder = 22
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "MS Sans Serif"
string picturename = "./recursos/atras.bmp"
string disabledname = "./recursos/atras_1.bmp"
end type

event clicked;int li_fila_actual
long ll_nro_instalacion, ll_fila_anterior


li_fila_actual = d_datos_interrup.GetRow()

//IF gi_tension_nivel_min = fgci_media_tension THEN
	IF li_fila_actual = 1 THEN
		this.enabled = false
	ELSE
		ll_nro_instalacion = d_datos_interrup.GetItemNumber(li_fila_actual, 'nro_instalacion')
		ll_fila_anterior = d_datos_interrup.Find("nro_instalacion = " + string(ll_nro_instalacion), li_fila_actual -1, 1 )
		IF pb_avanzar.enabled = False THEN
			pb_avanzar.enabled = True
		END IF
		IF ll_fila_anterior > 0 THEN
			IF is_tipo_ventana <> "w_2301_hist" THEN
				of_mostrar_fases_int(ll_fila_anterior, d_datos_interrup.GetItemString(ll_fila_anterior, 'sgd_valor_descripcion'))
			END IF
			d_datos_interrup.ScrollToRow(ll_fila_anterior)
			d_datos_interrup.SetRow(ll_fila_anterior)
//			IF ll_fila_anterior > 1 THEN
//				// se comprueba si hay m$$HEX1$$e100$$ENDHEX$$s interrupciones definidas
//				IF d_datos_interrup.Find("nro_instalacion = " + string(ll_nro_instalacion), ll_fila_anterior -1, 1) <= 0 THEN
//					This.enabled = False
//				END IF					
//			ELSE
//				This.enabled = False
//			END IF
//		ELSE
//			This.enabled = False
		END IF
	END IF
//ELSE
//
//	IF li_fila_actual = 1 THEN
//		this.enabled = false
//	ELSE
//		li_fila_actual --
//		d_datos_interrup.ScrollToRow(li_fila_actual)
//		d_datos_interrup.SetRow(li_fila_actual)
//		
//		IF pb_avanzar.enabled = False THEN
//			pb_avanzar.enabled = True
//		END IF
//		
//		IF li_fila_actual = 1 THEN 
//			this.enabled = false
//		END IF
//	END IF
//END IF
end event

type st_fases_afect from statictext within tabpage_interrupciones
boolean visible = false
integer x = 3735
integer y = 60
integer width = 379
integer height = 76
integer textsize = -8
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "MS Sans Serif"
boolean underline = true
long textcolor = 128
long backcolor = 16777215
boolean enabled = false
string text = "Fases afect. :"
boolean focusrectangle = false
end type

type cbx_fase_c from checkbox within tabpage_interrupciones
boolean visible = false
integer x = 3735
integer y = 344
integer width = 302
integer height = 76
integer textsize = -8
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "MS Sans Serif"
long textcolor = 128
long backcolor = 16777215
string text = "Fase C "
boolean lefttext = true
end type

event clicked;IF is_accion_llamada = 'Consulta' THEN
	this.checked = NOT This.checked
	return
END IF

IF of_interrumpir_fase(cbx_fase_a.checked, cbx_fase_b.checked, cbx_fase_c.checked, 3, FALSE, TRUE) = 0 THEN
	this.checked = NOT This.checked
END IF
end event

event constructor;This.Text = 'Fase ' + gs_fase_c
end event

type cbx_fase_b from checkbox within tabpage_interrupciones
boolean visible = false
integer x = 3735
integer y = 260
integer width = 302
integer height = 76
integer textsize = -8
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "MS Sans Serif"
long textcolor = 128
long backcolor = 16777215
string text = "Fase B "
boolean lefttext = true
end type

event clicked;IF is_accion_llamada = 'Consulta' THEN
	this.checked = NOT This.checked
	return
END IF

IF of_interrumpir_fase(cbx_fase_a.checked, cbx_fase_b.checked, cbx_fase_c.checked, 2, FALSE, TRUE) = 0 THEN
	this.checked = NOT This.checked
END IF
end event

event constructor;This.Text = 'Fase ' + gs_fase_b
end event

type cbx_fase_a from checkbox within tabpage_interrupciones
boolean visible = false
integer x = 3735
integer y = 164
integer width = 302
integer height = 76
integer textsize = -8
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "MS Sans Serif"
long textcolor = 128
long backcolor = 16777215
string text = "Fase A "
boolean lefttext = true
end type

event clicked;IF is_accion_llamada = 'Consulta' THEN
	this.checked = NOT This.checked
	return
END IF

IF of_interrumpir_fase(cbx_fase_a.checked, cbx_fase_b.checked, cbx_fase_c.checked, 1, FALSE, TRUE) = 0 THEN
	this.checked = NOT This.checked
END IF
end event

event constructor;This.Text = 'Fase ' + gs_fase_a
end event

type pb_avanzar from picturebutton within tabpage_interrupciones
boolean visible = false
integer x = 919
integer y = 1668
integer width = 101
integer height = 88
integer taborder = 12
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "MS Sans Serif"
string picturename = "recursos/delante.bmp"
string disabledname = "recursos/delante_1.bmp"
end type

event clicked;int li_fila_actual, li_num_filas
long ll_nro_instalacion, ll_fila_siguiente

li_fila_actual = d_datos_interrup.GetRow()
li_num_filas = d_datos_interrup.RowCount()

//IF gi_tension_nivel_min = fgci_media_tension THEN
	IF li_fila_actual = li_num_filas THEN
		this.enabled = false
		pb_anterior.enabled = True
	ELSE
		ll_nro_instalacion = d_datos_interrup.GetItemNumber(li_fila_actual, 'nro_instalacion')
		ll_fila_siguiente = d_datos_interrup.Find("nro_instalacion = " + string(ll_nro_instalacion), li_fila_actual+1, li_num_filas)
		IF pb_anterior.enabled = False THEN
			pb_anterior.enabled = True
		END IF
		IF ll_fila_siguiente > 0 THEN
			IF is_tipo_ventana <> "w_2301_hist" THEN
				of_mostrar_fases_int(ll_fila_siguiente, d_datos_interrup.GetItemString(ll_fila_siguiente, 'sgd_valor_descripcion'))
			END IF
			d_datos_interrup.ScrollToRow(ll_fila_siguiente)
			d_datos_interrup.SetRow(ll_fila_siguiente)
//			IF ll_fila_siguiente < li_num_filas THEN
//				// se comprueba si hay m$$HEX1$$e100$$ENDHEX$$s interrupciones definidas
//				IF d_datos_interrup.Find("nro_instalacion = " + string(ll_nro_instalacion), ll_fila_siguiente+1, li_num_filas) <= 0 THEN
//					This.enabled = False

//				END IF					
//			ELSE
//				This.enabled = False
//			END IF
//		ELSE
//			This.enabled = False
		END IF
	END IF

//ELSE

//	
//	IF li_fila_actual = li_num_filas THEN
//		this.enabled = false
//	ELSE
//		li_fila_actual ++
//		d_datos_interrup.ScrollToRow(li_fila_actual)
//		d_datos_interrup.SetRow(li_fila_actual)
//	
//		IF pb_anterior.enabled = False THEN
//			pb_anterior.enabled = True
//		END IF
//		
//		IF li_fila_actual = li_num_filas THEN 
//			this.enabled = false
//		END IF
//	END IF
//END IF
end event

type st_duracion_total from statictext within tabpage_interrupciones
boolean visible = false
integer x = 4686
integer y = 1608
integer width = 553
integer height = 80
integer textsize = -10
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 33554432
long backcolor = 67108864
boolean enabled = false
alignment alignment = center!
boolean focusrectangle = false
end type

type st_durac_total from statictext within tabpage_interrupciones
boolean visible = false
integer x = 4187
integer y = 1624
integer width = 425
integer height = 72
integer textsize = -10
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "MS Sans Serif"
long textcolor = 33554432
long backcolor = 67108864
boolean enabled = false
string text = "Dur. Total Int.:"
boolean focusrectangle = false
end type

type st_datos_interrup from statictext within tabpage_interrupciones
integer x = 4187
integer y = 20
integer width = 1093
integer height = 84
integer textsize = -10
integer weight = 700
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 16777215
long backcolor = 128
string text = " Datos de la Interrupci$$HEX1$$f300$$ENDHEX$$n."
boolean border = true
borderstyle borderstyle = styleraised!
boolean focusrectangle = false
end type

type st_durac from statictext within tabpage_interrupciones
boolean visible = false
integer x = 4187
integer y = 1516
integer width = 553
integer height = 72
boolean bringtotop = true
integer textsize = -10
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "MS Sans Serif"
long textcolor = 16777215
long backcolor = 128
boolean enabled = false
string text = "Dur. Ultima Int.:"
boolean focusrectangle = false
end type

type st_duracion from statictext within tabpage_interrupciones
boolean visible = false
integer x = 4187
integer y = 1588
integer width = 553
integer height = 72
boolean bringtotop = true
integer textsize = -10
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 33554432
long backcolor = 67108864
boolean enabled = false
alignment alignment = center!
boolean border = true
boolean focusrectangle = false
end type

type st_lista_int_operaciones from statictext within tabpage_interrupciones
boolean visible = false
integer x = 18
integer y = 20
integer width = 4128
integer height = 84
integer textsize = -10
integer weight = 700
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 16777215
long backcolor = 128
boolean enabled = false
string text = "CT~'s afectados por la Incidencia."
alignment alignment = center!
boolean border = true
borderstyle borderstyle = styleraised!
boolean focusrectangle = false
end type

type cb_separador from commandbutton within tabpage_interrupciones
boolean visible = false
integer x = 96
integer y = 1668
integer width = 827
integer height = 88
integer taborder = 12
boolean bringtotop = true
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "MS Sans Serif"
boolean enabled = false
end type

type st_otras_inst from statictext within tabpage_interrupciones
boolean visible = false
integer x = 18
integer y = 1484
integer width = 4128
integer height = 84
boolean bringtotop = true
integer textsize = -10
integer weight = 700
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 16777215
long backcolor = 128
boolean enabled = false
string text = " Otras Interrupciones :"
boolean border = true
borderstyle borderstyle = styleraised!
boolean focusrectangle = false
end type

type rb_otras_inc from radiobutton within tabpage_interrupciones
boolean visible = false
integer x = 713
integer y = 992
integer width = 722
integer height = 76
boolean bringtotop = true
integer textsize = -8
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "MS Sans Serif"
long textcolor = 79741120
long backcolor = 8421504
string text = "Otras Incidencias"
boolean checked = true
end type

event clicked;d_lista_otras_inst.visible = TRUE
d_lista_otras_inst_ant.visible = FALSE

IF d_lista_otras_inst.GetSelectedRow(0) > 0 THEN
	d_lista_otras_inst.Event RowFocusChanged(d_lista_otras_inst.GetSelectedRow(0)) 
END IF
end event

event constructor;This.visible = fg_verifica_parametro("Otras Interrupciones")
end event

type rb_misma_inc from radiobutton within tabpage_interrupciones
boolean visible = false
integer x = 1376
integer y = 992
integer width = 741
integer height = 76
boolean bringtotop = true
integer textsize = -8
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "MS Sans Serif"
long textcolor = 79741120
long backcolor = 8421504
string text = "Misma Incidencia"
end type

event clicked;d_lista_otras_inst.visible = FALSE
d_lista_otras_inst_ant.visible = TRUE

IF d_lista_otras_inst_ant.GetSelectedRow(0) > 0 THEN
	d_lista_otras_inst_ant.Event RowFocusChanged(d_lista_otras_inst_ant.GetSelectedRow(0)) 
END IF
end event

event constructor;This.visible = fg_verifica_parametro("Otras Interrupciones")
end event

type dw_afec_parcial_sum from datawindow within tabpage_interrupciones
boolean visible = false
integer x = 818
integer y = 468
integer width = 1262
integer height = 380
integer taborder = 13
boolean bringtotop = true
string dataobject = "d_sum_inter_bt"
boolean hscrollbar = true
boolean vscrollbar = true
boolean livescroll = true
borderstyle borderstyle = stylelowered!
end type

type dw_sin_interrupcion from datawindow within tabpage_interrupciones
boolean visible = false
integer x = 4187
integer y = 124
integer width = 1093
integer height = 868
integer taborder = 16
string dataobject = "d_ins_2010_lista_sin_interrupcion"
boolean livescroll = true
borderstyle borderstyle = stylelowered!
end type

event constructor;//***************************************
//**  OSGI 2001.1  	31/05/2001			**
//**  Jair Padilla / Soluziona PANAMA  **
//***************************************
If ib_afect_parcial Then This.Modify("c_valida_sbt.Expression = '" + String(fgci_tipo_salida_de_baja) + "'")
This.Modify("c_protect_afec_parcial.Expression = '1'")
//***************************************
//**  OSGI 2001.1  	31/05/2001			**
//**  Jair Padilla / Soluziona PANAMA  **
//***************************************
end event

type d_datos_interrup from datawindow within tabpage_interrupciones
event ue_key pbm_dwnkey
event ue_postitem ( )
event ue_itemchanged ( )
integer x = 4187
integer y = 100
integer width = 1093
integer height = 1380
integer taborder = 60
boolean bringtotop = true
string dataobject = "d_ins_2010_lista_interrupciones"
boolean livescroll = true
borderstyle borderstyle = stylelowered!
end type

event ue_key;/////////////////////////////////////////////////////
//	No permito scrollear la datawindow
//
//////////////////////////////////////////////////////

IF key = KeyUpArrow! OR  key = KeyDownArrow! OR key = KeyEnter! OR &
	key = KeyPageUp! OR key = KeyPageDown! OR key = KeyEnd! OR key = KeyHome! THEN
	return -1
END IF


end event

event ue_postitem;datetime ldt_fecha_nula

SetNull(ldt_fecha_nula)

This.SetItem(This.GetRow(),"f_reposicion",ldt_fecha_nula)

end event

event ue_itemchanged();//AHM (15/10/2010)
ii_estActualAnterior = ii_estado_oper
This.AcceptText()
end event

event itemchanged;////////////////////////////////
// Evento : Itemchanged de la datawindow de los datos de la interrupcion
//
// En este evento se realizan las validaciones de la nueva fecha 
//	de reposicion , y en caso de pasar dichas validaciones se llama
//	una funcion (f_actualizar_estado) en la que se actualiza el estado de la incidencia
// y las fechas de los estados en el seguimiento
//
//		AFS				Version Original
////////////////////////////////////////////////

datetime ldt_fecha_nula, ldt_f_alta, ldt_primer_aviso, ldt_desde, ldt_hasta
long ll_tiempo_interrupcion, ll_nro_instalacion, ll_nulo,ll_retorno, ll_fila, ll_inst_hija
string ls_fases_interrumpidas, ls_campo_fecha_rep, ls_campo_fecha_alta, ls_fase_res, ls_tipo_fase_res 
int li_fase_seleccionada,li_devuelve, li_sel
long ll_busqueda = 1
Boolean lb_tiene_fase_a=false, lb_tiene_fase_b=false, lb_tiene_fase_c=false
Boolean lb_encontrado
string ls_fase_int

String ls_tiempo_max_int // GNU 01/02/2007. Mejora 1/464613
int li_respuesta // GNU 01/02/2007. Mejora 1/464613


SetNull(ldt_fecha_nula)
SetNull(ll_nulo)
SetNull(ldt_desde)
SetNull(ldt_hasta)

This.SetReDraw(False)
this.accepttext()

IF dwo.name = 'fase_seleccionada' THEN

	// Se recalcula la duraci$$HEX1$$f300$$ENDHEX$$n de la interrupci$$HEX1$$f300$$ENDHEX$$n
	li_fase_seleccionada = Integer(data)
	CHOOSE CASE li_fase_seleccionada
		CASE 0
			ldt_desde = This.GetItemDateTime(row,"f_alta")
			ldt_hasta = This.GetItemDateTime(row,"f_reposicion")
			ls_campo_fecha_alta = "f_alta"
			ls_campo_fecha_rep = "f_reposicion"
		CASE 1
			ldt_desde = This.GetItemDateTime(row,"f_alta_fase_a")
			ldt_hasta = This.GetItemDateTime(row,"f_reposicion_fase_a")
			ls_campo_fecha_alta = "f_alta_fase_a"
			ls_campo_fecha_rep = "f_reposicion_fase_a"
		CASE 2
			ldt_desde = This.GetItemDateTime(row,"f_alta_fase_b")
			ldt_hasta = This.GetItemDateTime(row,"f_reposicion_fase_b")
			ls_campo_fecha_alta = "f_alta_fase_b"
			ls_campo_fecha_rep = "f_reposicion_fase_b"
		CASE 3
			ldt_desde = This.GetItemDateTime(row,"f_alta_fase_c")
			ldt_hasta = This.GetItemDateTime(row,"f_reposicion_fase_c")
			ls_campo_fecha_alta = "f_alta_fase_c"
			ls_campo_fecha_rep = "f_reposicion_fase_c"

	END CHOOSE
	
	IF NOT iw_contenedora.fw_incidencia_de_operaciones() THEN
		IF is_tipo_ventana <> "w_2301_hist" THEN
			IF tv_1.ii_tipo_icono <> tv_1.f_icono_arbol(tv_1.of_ret_tipo(il_handle_instalacion) + tv_1.ii_instalaciones_repuestas) THEN
				IF NOT ISNULL(ldt_hasta) OR ISNULL(ldt_desde) THEN
					ll_fila = This.find("nro_instalacion = " + string(This.GetItemNumber(row,"nro_instalacion")) + &
									" and (not isnull(" + ls_campo_fecha_alta + ")) and isnull(" + ls_campo_fecha_rep + ")" ,1,This.rowcount())
									
					IF ll_fila > 0 AND ll_fila <> row THEN
						This.setitem(ll_fila, 'fase_seleccionada',li_fase_seleccionada) 
						This.ScrollToRow(ll_fila)
						This.SetRow(ll_fila)
						ldt_desde = This.GetItemDateTime(ll_fila, ls_campo_fecha_alta)
						ldt_hasta = This.GetItemDateTime(ll_fila, ls_campo_fecha_rep)
					ELSEIF ll_fila = 0 THEN
						This.Modify(ls_campo_fecha_alta + ".Protect = '1'")
						This.Modify(ls_campo_fecha_alta + ".Background.Color = '" + gs_gris + "'")
						This.Modify(ls_campo_fecha_rep + ".Protect = '1'")
						This.Modify(ls_campo_fecha_rep + ".Background.Color = '" + gs_gris + "'")
					END IF

					
						
				END IF
				
				IF ISNULL(ldt_desde) THEN
					ll_fila = This.find("nro_instalacion = " + string(This.GetItemNumber(row,"nro_instalacion")) + &
									" and not isnull(" + ls_campo_fecha_alta + ")" ,1,This.rowcount())
									
					IF ll_fila > 0 THEN
						This.setitem(ll_fila, 'fase_seleccionada',li_fase_seleccionada) 
						This.ScrollToRow(ll_fila)
						This.SetRow(ll_fila)
						//This.setitem(ll_fila, 'fase_seleccionada',li_fase_seleccionada) 
						
						IF NOT ISNULL(This.GetitemDateTime(ll_fila, ls_campo_fecha_rep)) THEN
							//This.object.f_reposicion_fase_c[row].protect = 1
							This.Modify(ls_campo_fecha_alta + ".Protect = '1'")
							This.Modify(ls_campo_fecha_alta + ".Background.Color = '" + gs_gris + "'")
							This.Modify(ls_campo_fecha_rep + ".Protect = '1'")
							This.Modify(ls_campo_fecha_rep + ".Background.Color = '" + gs_gris + "'")
						END IF
						ldt_desde = This.GetItemDateTime(ll_fila, ls_campo_fecha_alta)
						ldt_hasta = This.GetItemDateTime(ll_fila, ls_campo_fecha_rep)
			
					END IF
				END IF
			END IF
		END IF		
		// Se obtienen todas las fase interrumpidas de la instalaci$$HEX1$$f300$$ENDHEX$$n
		// Para ello hay que recorrerse todas las interrupciones dadas de alta en la instalaci$$HEX1$$f300$$ENDHEX$$n
		DO WHILE (lb_tiene_fase_a=FALSE OR lb_tiene_fase_b=FALSE OR lb_tiene_fase_c=FALSE) & 
					AND ll_busqueda <= This.RowCount() AND ll_busqueda > 0
			
			ll_busqueda = This.find("nro_instalacion = " + string(This.GetItemNumber(row,"nro_instalacion")), &
											 ll_busqueda,This.RowCount())
			
			IF ll_busqueda > 0 THEN
				ls_fase_int = This.GetItemString(ll_busqueda, 'sgd_valor_descripcion')
				lb_tiene_fase_a = lb_tiene_fase_a OR MATCH(ls_fase_int,gs_fase_a)
				lb_tiene_fase_b = lb_tiene_fase_b OR MATCH(ls_fase_int,gs_fase_b)
				lb_tiene_fase_c = lb_tiene_fase_c OR MATCH(ls_fase_int,gs_fase_c)
			END IF
		
			IF ll_busqueda > 0 THEN
				ll_busqueda ++
			END IF
		LOOP
		
		ls_fase_int= ''
		
		IF lb_tiene_fase_a THEN
			ls_fase_int = gs_fase_a
		END IF
		IF lb_tiene_fase_b THEN
			ls_fase_int = ls_fase_int + gs_fase_b
		END IF
		IF lb_tiene_fase_c THEN
			ls_fase_int = ls_fase_int + gs_fase_c
		END IF
		This.setitem(ll_fila, 'sgd_valor_descripcion',ls_fase_int) 
	END IF		
	
END IF

IF dwo.name = "f_reposicion" OR  &
	dwo.name = "f_reposicion_fase_a" OR &
	dwo.name = "f_reposicion_fase_b" OR &
	dwo.name = "f_reposicion_fase_c" then
	
	ib_dejo_cambiar = True
	ls_campo_fecha_rep = dwo.name

	IF dwo.name = "f_reposicion" THEN
		ls_fase_res = "111"
		ls_campo_fecha_alta = "f_alta"
		ls_tipo_fase_res = gs_fase_a + gs_fase_b + gs_fase_c
		
		// PACHO. Validaci$$HEX1$$f300$$ENDHEX$$n de instalaciones para moldavia.
		
		if gb_operaciones_inst = true then // se validan las instalaciones interrumpidas.
			li_devuelve = fnu_int_comunes(This.GetItemdatetime(row,"f_alta"),This.GetItemdatetime(row,"f_reposicion"),This.GetItemNumber(row,"nro_instalacion"))
		end if
		
		choose case li_devuelve
			case -1
				MessageBox("Atenci$$HEX1$$f300$$ENDHEX$$n", "Existe una Interrupci$$HEX1$$f300$$ENDHEX$$n sobre esta misma instalaci$$HEX1$$f300$$ENDHEX$$n en el periodo de tiempo que intenta interrumpir.",information!,ok!)
				ib_dejo_cambiar = False
				This.SetReDraw(True)
				ldt_primer_aviso = fnu_o_primer_aviso(ll_nro_instalacion, ls_fases_interrumpidas, lb_encontrado)
				This.SetItem(row,ls_campo_fecha_alta,ldt_primer_aviso)
				Return 2
			case -2
				MessageBox("Atenci$$HEX1$$f300$$ENDHEX$$n", "La interrupci$$HEX1$$f300$$ENDHEX$$n que est$$HEX2$$e1002000$$ENDHEX$$resolviendo engloba a otra/s interrupcione/s que se eliminar$$HEX1$$e100$$ENDHEX$$n al resolver la incidencia.",information!,ok!)
			case -3
				MessageBox("Atenci$$HEX1$$f300$$ENDHEX$$n", "Existe una Interrupci$$HEX1$$f300$$ENDHEX$$n sobre esta misma instalaci$$HEX1$$f300$$ENDHEX$$n en el periodo de tiempo que intenta interrumpir.",information!,ok!)
				ib_dejo_cambiar = False
				This.SetReDraw(True)
				This.SetItem(row, ls_campo_fecha_rep, ldt_fecha_nula)
				Return 2
			case -4
				MessageBox("Atenci$$HEX1$$f300$$ENDHEX$$n", "Se ha producido un error al comprobar la existencia de otras interrupciones en la misma instalaci$$HEX1$$f300$$ENDHEX$$n.",exclamation!,ok!)
				ib_dejo_cambiar = False
				This.SetReDraw(True)
				This.SetItem(row, ls_campo_fecha_rep, ldt_fecha_nula)
				Return 2			
			case -5
				MessageBox("Atenci$$HEX1$$f300$$ENDHEX$$n", "La interrupci$$HEX1$$f300$$ENDHEX$$n que est$$HEX2$$e1002000$$ENDHEX$$resolviendo engloba a otra/s interrupcione/s. Sin embargo no ha sido posible bloquear dichas interrupciones por que estan siendo usadas por otro usuario.",exclamation!,ok!)
				ib_dejo_cambiar = False
				This.SetReDraw(True)
				This.SetItem(row, ls_campo_fecha_rep, ldt_fecha_nula)
				Return 2		
		end choose
		// PACHO. Validaci$$HEX1$$f300$$ENDHEX$$n de instalaciones para moldavia.		
		
	ELSEIF dwo.name = "f_reposicion_fase_a" THEN
		ls_fase_res = "100"
		ls_campo_fecha_alta = "f_alta_fase_a"
		ls_tipo_fase_res = gs_fase_a
	ELSEIF dwo.name = "f_reposicion_fase_b" THEN
		ls_fase_res = "010"
		ls_campo_fecha_alta = "f_alta_fase_b"
		ls_tipo_fase_res = gs_fase_b
	ELSEIF dwo.name = "f_reposicion_fase_c" THEN
		ls_fase_res = "001"
		ls_campo_fecha_alta = "f_alta_fase_c"
		ls_tipo_fase_res = gs_fase_c
	END IF
	
	// Valido que el estado de la incidencia >= EB

	IF ii_estado_oper < fgci_incidencia_enviado_brigada THEN
		//messagebox("Atenci$$HEX1$$f300$$ENDHEX$$n","No puede reponer interrupciones hasta que no seleccione una causa.")
		gnv_msg.f_mensaje("AI108","","",ok!)
		This.SetItem(row, ls_campo_fecha_rep, ldt_fecha_nula)
		ib_dejo_cambiar = False
		This.SetReDraw(True)
		Return 2
	END IF
	
	// Capturo la nueva fecha ingresada 
	idt_fecha_nueva_repos = DateTime(Date(Left(data,10)),Time(Right(data,15)))
	
	// Si borraron la fecha de repos. seteo en nulo la variable
	idt_fecha_nueva_repos = fgnu_valido_fecha_nula(idt_fecha_nueva_repos)
	
	IF IsNull(idt_fecha_nueva_repos) THEN
		
		This.SetItem(row,ls_campo_fecha_rep,ldt_fecha_nula)
		This.SetItem(row,"tiempo_interrupcion",ll_tiempo_interrupcion)	
			
		iw_contenedora.tab_1.f_actualizar_estado()		
		of_validar_fecha_rep(row, d_datos_interrup, true)
		This.SetReDraw(True)
		Return 2
		
	ELSE // Si la fecha nueva no es nula, procedo a validarla
		
		/////////    VALIDACIONES DE LA FECHA REPOSICION INGRESADA    //////////
		
		idt_fecha_vieja_repos = This.GetItemDateTime(row, ls_campo_fecha_rep)
		
		IF d_lista_otras_inst.GetSelectedRow(0) = 0 THEN
			// Se valida que no haya ninguna instalaci$$HEX1$$f300$$ENDHEX$$n superior en la incidencia interrumpida
			IF fnu_valida_interrupcion_padre(il_handle_instalacion, ls_tipo_fase_res, False) = -1 THEN
				MessageBox("Atenci$$HEX1$$f300$$ENDHEX$$n", "Existe una Instalaci$$HEX1$$f300$$ENDHEX$$n de nivel superior interrumpida. Tiene que resolver antes esa Interrupci$$HEX1$$f300$$ENDHEX$$n")
				This.SetItem(row,ls_campo_fecha_rep,ldt_fecha_nula)
				ib_dejo_cambiar = False
				This.SetReDraw(True)
				Return 2
			END IF
		END IF
		
		// Valido que la fecha sea mayor que la fecha de alta
		IF idt_fecha_nueva_repos < This.GetItemDateTime(row, ls_campo_fecha_alta) THEN
			//MessageBox("Atenci$$HEX1$$f300$$ENDHEX$$n","La Fecha de Reposici$$HEX1$$f300$$ENDHEX$$n no puede ser menor que la fecha de alta de la interrupci$$HEX1$$f300$$ENDHEX$$n.")
			gnv_msg.f_mensaje("AI109","","",ok!)
			This.SetItem(row,ls_campo_fecha_rep,ldt_fecha_nula)
			ib_dejo_cambiar = False
			This.SetReDraw(True)
			Return 2
		END IF
		// Valida que si es una incidencia imprevista, la fecha de reposicion
		// no pueda ser mayor que la fecha actual
		//IF idt_fecha_nueva_repos > fgnu_fecha_actual() THEN //** INI ** 23/06/2015 *** evolutivo DDAG-2482
		IF idt_fecha_nueva_repos > fgnu_fecha_actual_con_seg() THEN //** FIN ** 23/06/2015 *** evolutivo DDAG-2482
			//MessageBox("Atenci$$HEX1$$f300$$ENDHEX$$n","La Fecha de Reposici$$HEX1$$f300$$ENDHEX$$n no puede ser mayor que la fecha actual.")
			gnv_msg.f_mensaje("AI110","","",ok!)
			This.SetItem(row,ls_campo_fecha_rep,ldt_fecha_nula)
			ib_dejo_cambiar = False		
			This.SetReDraw(True)
			Return 2
		END IF
		
		// Valido que la fecha de reposici$$HEX1$$f300$$ENDHEX$$n sea mayor que la fecha de Enviado Brigada
		 IF idt_fecha_nueva_repos < tabpage_ot.d_datos_ot.GetitemDateTime(1, 'f_desde') THEN
			gnv_msg.f_mensaje("AI111","","",ok!)
			This.SetItem(row,ls_campo_fecha_rep,ldt_fecha_nula)
			ib_dejo_cambiar = False
			This.SetReDraw(True)
			Return 2
		END IF
		
		// GNU 01/02/2007. Mejora 1/464613
		SELECT VALOR
		INTO :ls_tiempo_max_int
		FROM SGD_VALOR
		WHERE CODIF='INTI';
		
		IF long (ls_tiempo_max_int) > 0 AND &
			fg_duracion_horas (This.GetItemDateTime(row, ls_campo_fecha_alta),idt_fecha_nueva_repos) >= long (ls_tiempo_max_int) THEN
			li_respuesta=MessageBox("Atenci$$HEX1$$f300$$ENDHEX$$n","La Fecha de Reposici$$HEX1$$f300$$ENDHEX$$n sobrepasa el tiempo estimado. $$HEX1$$bf00$$ENDHEX$$Aceptar?",Exclamation!,YesNo!)
//			gnv_msg.f_mensaje("AI109","","",ok!)
			IF li_respuesta= 2 THEN
				This.SetItem(row,ls_campo_fecha_rep,ldt_fecha_nula)
				ib_dejo_cambiar = False
				This.SetReDraw(True)
				Return 2
			END IF
		END IF
		// GNU 01/02/2007. Mejora 1/464613
		///////   FIN DE VALIDACIONES DE FECHA REPOSICION  //////////
	END IF
		
	//ll_tiempo_interrupcion = fg_duracion_minutos(This.GetItemDateTime(row,ls_campo_fecha_alta),idt_fecha_nueva_repos)
	//This.SetItem(row,"tiempo_interrupcion",ll_tiempo_interrupcion)
//	iw_contenedora.tab_1.f_actualizar_estado()
//	of_validar_fecha_rep(row, d_datos_interrup, true)

//	SFP DEO12-00000219 JHE 20130403
// Se recalcula la duraci$$HEX1$$f300$$ENDHEX$$n de la interrupci$$HEX1$$f300$$ENDHEX$$n, para validar el tiempo
// entre la fecha de alta y la fecha de reposicion.
If ii_valtiempomax > 0 Then
	
	li_fase_seleccionada = This.GetItemNumber(row,"fase_seleccionada")
	
	CHOOSE CASE li_fase_seleccionada
		CASE 0
			ldt_desde = This.GetItemDateTime(row,"f_alta")
			ldt_hasta = This.GetItemDateTime(row,"f_reposicion")
			ls_campo_fecha_rep = "f_reposicion"
		CASE 1
			ldt_desde = This.GetItemDateTime(row,"f_alta_fase_a")
			ldt_hasta = This.GetItemDateTime(row,"f_reposicion_fase_a")
			ls_campo_fecha_rep = "f_reposicion_fase_a"
		CASE 2
			ldt_desde = This.GetItemDateTime(row,"f_alta_fase_b")
			ldt_hasta = This.GetItemDateTime(row,"f_reposicion_fase_b")
			ls_campo_fecha_rep = "f_reposicion_fase_b"
		CASE 3
			ldt_desde = This.GetItemDateTime(row,"f_alta_fase_c")
			ldt_hasta = This.GetItemDateTime(row,"f_reposicion_fase_c")
			ls_campo_fecha_rep = "f_reposicion_fase_c"

	END CHOOSE
	

	If fg_duracion_horas (ldt_desde,ldt_hasta) > ii_valtiempomax Then
		li_sel =  Messagebox("Atenci$$HEX1$$f300$$ENDHEX$$n","Entre la fecha de alta "+string(ldt_desde) +" y la fecha de reposici$$HEX1$$f300$$ENDHEX$$n "+string(ldt_hasta)+"~n"+", la interrupci$$HEX1$$f300$$ENDHEX$$n tiene un tiempo de resolucion que es mayor a "+string(ii_valtiempomax)+" horas."+"~n"+"$$HEX2$$bf002000$$ENDHEX$$Continuar ?" , Question!, YesNo!)
		if li_sel = 2 Then
			This.SetItem(row, ls_campo_fecha_rep, ldt_fecha_nula)
			ib_dejo_cambiar = False
			IF gb_red_trifasica = FALSE THEN
				of_calcular_min_fecha_alta(row)
		   END IF
			This.SetReDraw(True)
			Return 2
		end if
	End if
End If
//	SFP DEO12-00000219 JHE 20130403 FIN	


	IF d_lista_otras_inst.GetSelectedRow(0) = 0 THEN

		ll_retorno= fnu_valida_cierre_interrupcion(tv_1.finditem(CurrentTreeItem!,0), ls_fase_res )

		if ll_retorno= -1 then
			This.SetItem(row, ls_campo_fecha_rep, ldt_fecha_nula)
			idt_fecha_nueva_repos=ldt_fecha_nula
			ib_dejo_cambiar = False
			This.SetReDraw(True)
			return 2
		elseif ll_retorno = 2 then
			ib_dejo_cambiar = False
			This.SetReDraw(True)
			return 2
		end if
		
		IF iw_contenedora.tab_1.f_actualizar_estado() = 0 THEN
			This.setfocus()
			This.SetItem(row, ls_campo_fecha_rep, ldt_fecha_nula)
			This.SetItem(row, 'f_reposicion', ldt_fecha_nula)
			idt_fecha_nueva_repos=ldt_fecha_nula
			ib_dejo_cambiar = False
			This.SetReDraw(True)
			return 2
		END IF
		of_validar_fecha_rep(row, d_datos_interrup, NOT (This.GetItemNumber(row, 'ind_otras_ins') = 1))
		
		setPointer(Hourglass!)
		ll_inst_hija = tabpage_interrupciones.tv_1.FindItem(ChildTreeItem!, il_handle_instalacion)
		DO WHILE ll_inst_hija > 0
			tabpage_interrupciones.tv_1.of_interrumpir_hijos(ll_inst_hija,tabpage_interrupciones.d_datos_interrup)
			ll_inst_hija = tabpage_interrupciones.tv_1.FindItem(NextTreeItem!, ll_inst_hija)
		LOOP
		setPointer(Arrow!)
		
		IF dwo.name = "f_reposicion_fase_a" THEN
			cbx_fase_a.enabled = False
		ELSEIF dwo.name = "f_reposicion_fase_b" THEN
			cbx_fase_b.enabled = False
		ELSEIF dwo.name = "f_reposicion_fase_c" THEN
			cbx_fase_c.enabled = False
		END IF
		
		ldt_hasta = idt_fecha_nueva_repos
		
		IF This.GetItemNumber(row, 'ind_otras_ins') = 1 THEN
			IF d_lista_otras_inst_ant.GetSelectedRow(0) > 0 THEN
				d_lista_otras_inst_ant.SetItem(d_lista_otras_inst_ant.GetSelectedRow(0), 'f_reposicion', This.GetItemDatetime(row, 'f_reposicion'))
			END IF
		END IF
	ELSE
		//d_lista_otras_inst.SetItem(d_lista_otras_inst.GetSelectedRow(0), ls_campo_fecha_rep, idt_fecha_nueva_repos)
		of_validar_fecha_rep(row, d_datos_interrup, FALSE)
		//d_lista_otras_inst.Event Itemchanged(d_lista_otras_inst.GetSelectedRow(0), dwo, data)
	END IF
	This.Modify(ls_campo_fecha_alta+".Protect='1'")
	This.Modify(ls_campo_fecha_alta+".Background.Color='"+gs_gris+"'")
END IF

//	Si cambie la fecha de alta
IF dwo.name = "f_alta"  OR  &
	dwo.name = "f_alta_fase_a" OR &
	dwo.name = "f_alta_fase_b" OR &
	dwo.name = "f_alta_fase_c" THEN
	
	ib_dejo_cambiar = True
	ls_campo_fecha_alta = dwo.name
		
	IF dwo.name = "f_alta" THEN
		ls_campo_fecha_rep = "f_reposicion"
		
		// PACHO. Validaci$$HEX1$$f300$$ENDHEX$$n de instalaciones para moldavia.
		
		if gb_operaciones_inst = true then // se validan las instalaciones interrumpidas.
			li_devuelve = fnu_int_comunes(This.GetItemdatetime(row,"f_alta"),This.GetItemdatetime(row,"f_reposicion"),This.GetItemNumber(row,"nro_instalacion"))
		end if
		
		choose case li_devuelve
			case -1
				MessageBox("Atenci$$HEX1$$f300$$ENDHEX$$n", "Existe una Interrupci$$HEX1$$f300$$ENDHEX$$n sobre esta misma instalaci$$HEX1$$f300$$ENDHEX$$n en el periodo de tiempo que intenta interrumpir.",information!,ok!)
				ib_dejo_cambiar = False
				This.SetReDraw(True)
				ldt_primer_aviso = fnu_o_primer_aviso(ll_nro_instalacion, ls_fases_interrumpidas, lb_encontrado)
				This.SetItem(row,ls_campo_fecha_alta,ldt_primer_aviso)
				Return 2
			case -2
				MessageBox("Atenci$$HEX1$$f300$$ENDHEX$$n", "La interrupci$$HEX1$$f300$$ENDHEX$$n que est$$HEX2$$e1002000$$ENDHEX$$resolviendo engloba a otra/s interrupcione/s que se eliminar$$HEX1$$e100$$ENDHEX$$n al resolver la incidencia.",information!,ok!)
			case -3
				MessageBox("Atenci$$HEX1$$f300$$ENDHEX$$n", "Existe una Interrupci$$HEX1$$f300$$ENDHEX$$n sobre esta misma instalaci$$HEX1$$f300$$ENDHEX$$n en el periodo de tiempo que intenta interrumpir.",information!,ok!)
				ib_dejo_cambiar = False
				This.SetReDraw(True)
				This.SetItem(row, ls_campo_fecha_rep, ldt_fecha_nula)
				Return 2
			case -4
				MessageBox("Atenci$$HEX1$$f300$$ENDHEX$$n", "Se ha producido un error al comprobar la existencia de otras interrupciones en la misma instalaci$$HEX1$$f300$$ENDHEX$$n.",exclamation!,ok!)
				ib_dejo_cambiar = False
				This.SetReDraw(True)
				This.SetItem(row, ls_campo_fecha_rep, ldt_fecha_nula)
				Return 2			
			case -5
				MessageBox("Atenci$$HEX1$$f300$$ENDHEX$$n", "La interrupci$$HEX1$$f300$$ENDHEX$$n que est$$HEX2$$e1002000$$ENDHEX$$resolviendo engloba a otra/s interrupcione/s. Sin embargo no ha sido posible bloquear dichas interrupciones por que estan siendo usadas por otro usuario.",exclamation!,ok!)
				ib_dejo_cambiar = False
				This.SetReDraw(True)
				This.SetItem(row, ls_campo_fecha_rep, ldt_fecha_nula)
				Return 2		
		end choose
		// PACHO. Validaci$$HEX1$$f300$$ENDHEX$$n de instalaciones para moldavia.		
		
	ELSEIF dwo.name = "f_alta_fase_a" THEN
		ls_campo_fecha_rep = "f_reposicion_fase_a"
	ELSEIF dwo.name = "f_alta_fase_b" THEN
		ls_campo_fecha_rep = "f_reposicion_fase_b"
	ELSEIF dwo.name = "f_alta_fase_c" THEN
		ls_campo_fecha_rep = "f_reposicion_fase_c"
	END IF
	// Capturo la fecha ingresada
	ldt_f_alta = DateTime(Date(Left(data,10)),Time(Right(data,15)))
	//LSH
	//messagebox("ldt_f_alta", string(ldt_f_alta))
	
	//messagebox("fgnu_fecha_actual()", string(fgnu_fecha_actual()))
	
	ll_nro_instalacion = This.GetItemNumber(row,"nro_instalacion")
	ls_fases_interrumpidas = This.GetItemString(row, "fase_afectada")
	
	// La fecha de alta de la interrupcion no puede ser menor que la fecha de deteccion
	// de la incidencia; sin embargo s$$HEX2$$ed002000$$ENDHEX$$se debe permitir que sea mayor que la fecha del 
	// primer aviso para esa instalacion
	// La fecha del primer aviso la devuelve la funcion fnu_o_primer_aviso(nro_instalacion)
	ldt_primer_aviso = fnu_o_primer_aviso(ll_nro_instalacion, ls_fases_interrumpidas, lb_encontrado)

	// Se valida que la fecha de alta no puede ser nula
	IF ISNULL(ldt_f_alta)  THEN
		MessageBox("Atenci$$HEX1$$f300$$ENDHEX$$n", "La Fecha de Alta de la Interrupci$$HEX1$$f300$$ENDHEX$$n no puede ser nula") 
		This.SetItem(row,ls_campo_fecha_alta,ldt_primer_aviso)
		ib_dejo_cambiar = False
		// En caso de que la red sea monof$$HEX1$$e100$$ENDHEX$$sica, si la fecha nueva es menor que la fecha de 
		// alta, $$HEX1$$e900$$ENDHEX$$sta ser$$HEX2$$e1002000$$ENDHEX$$la nueva fecha de alta

		IF gb_red_trifasica = FALSE THEN
			of_calcular_min_fecha_alta(row)
		END IF
		This.SetReDraw(True)
		Return 2
	END IF

	
	// Valida que si es una incidencia imprevista, la fecha de alta
	// no pueda ser mayor que la fecha del primer aviso
	IF ldt_f_alta > ldt_primer_aviso and ii_tipo_incid = fgci_incidencia_imprevista THEN
		//MessageBox("Atenci$$HEX1$$f300$$ENDHEX$$n","La Fecha de Alta de la Interrupci$$HEX1$$f300$$ENDHEX$$n no puede ser mayor ~nque la fecha del primer aviso alimentado por esta instalaci$$HEX1$$f300$$ENDHEX$$n.")
		IF MessageBox("Atenci$$HEX1$$f300$$ENDHEX$$n", "La Fecha de Alta de la Interrupci$$HEX1$$f300$$ENDHEX$$n es mayor que la fecha del primer aviso alimentado por esta instalaci$$HEX1$$f300$$ENDHEX$$n. Algunos avisos asociados a la incidencia alimentados por la instalaci$$HEX1$$f300$$ENDHEX$$n ser$$HEX1$$e100$$ENDHEX$$n liberados al grabar la incidencia. $$HEX1$$bf00$$ENDHEX$$Desea continuar?", Question!, YesNo!) = 2 THEN
		//gnv_msg.f_mensaje("AI112","","",ok!)
			This.SetItem(row,ls_campo_fecha_alta,ldt_primer_aviso)
			ib_dejo_cambiar = False
			// En caso de que la red sea monof$$HEX1$$e100$$ENDHEX$$sica, si la fecha nueva es menor que la fecha de 
			// alta, $$HEX1$$e900$$ENDHEX$$sta ser$$HEX2$$e1002000$$ENDHEX$$la nueva fecha de alta
			IF gb_red_trifasica = FALSE THEN
				of_calcular_min_fecha_alta(row)
			END IF
			This.SetReDraw(True)
			Return 2
		END IF
	END IF
	
	/// Valida que la fecha de alta
	// no pueda ser menor que la fecha de otra interrupci$$HEX1$$f300$$ENDHEX$$n sobre la misma instalaci$$HEX1$$f300$$ENDHEX$$n
	ll_fila = This.Find('nro_instalacion = ' + string(ll_nro_instalacion) &
							  + ' and (not isnull(' + ls_campo_fecha_rep + ')) and ' &
							  + ls_campo_fecha_rep + ' > datetime("' + string(ldt_f_alta) + '")', 0, This.RowCount())
	
	IF ll_fila > 0 THEN
		// La interrupci$$HEX1$$f300$$ENDHEX$$n se solapa con otra ya resuelta
		MessageBox("Atenci$$HEX1$$f300$$ENDHEX$$n", "La Fecha de Alta de la Interrupci$$HEX1$$f300$$ENDHEX$$n no puede ser menor que la fecha de reposici$$HEX1$$f300$$ENDHEX$$n de otra interrupci$$HEX1$$f300$$ENDHEX$$n resuelta sobre esta instalaci$$HEX1$$f300$$ENDHEX$$n")		
		This.SetItem(row,ls_campo_fecha_alta,fgnu_fecha_actual())

		ib_dejo_cambiar = False
		// En caso de que la red sea monof$$HEX1$$e100$$ENDHEX$$sica, si la fecha nueva es menor que la fecha de 
		// alta, $$HEX1$$e900$$ENDHEX$$sta ser$$HEX2$$e1002000$$ENDHEX$$la nueva fecha de alta
		IF gb_red_trifasica = FALSE THEN
			of_calcular_min_fecha_alta(row)
		END IF
		This.SetReDraw(True)
		Return 2
	END IF
	
	// Valida que la fecha de alta
	// no pueda ser mayor que la fecha del d$$HEX1$$ed00$$ENDHEX$$a
	IF ldt_f_alta > fgnu_fecha_actual()  THEN
		//MessageBox("Atenci$$HEX1$$f300$$ENDHEX$$n","La Fecha de Alta de la Interrupci$$HEX1$$f300$$ENDHEX$$n no puede ser mayor ~nque la fecha del primer aviso alimentado por esta instalaci$$HEX1$$f300$$ENDHEX$$n.")
		MessageBox("Atenci$$HEX1$$f300$$ENDHEX$$n", "La Fecha de Alta de la Interrupci$$HEX1$$f300$$ENDHEX$$n no puede ser mayor que la fecha del d$$HEX1$$ed00$$ENDHEX$$a")
		//gnv_msg.f_mensaje("AI112","","",ok!)
		This.SetItem(row,ls_campo_fecha_alta,fgnu_fecha_actual())
		ib_dejo_cambiar = False
		// En caso de que la red sea monof$$HEX1$$e100$$ENDHEX$$sica, si la fecha nueva es menor que la fecha de 
		// alta, $$HEX1$$e900$$ENDHEX$$sta ser$$HEX2$$e1002000$$ENDHEX$$la nueva fecha de alta
		IF gb_red_trifasica = FALSE THEN
			of_calcular_min_fecha_alta(row)
		END IF

		This.SetReDraw(True)
		Return 2
	END IF
	

	// La fecha de deteccion no puede ser menor que la fecha de deteccion de la incidencia
	IF ldt_f_alta < idt_fec_deteccion THEN
		//MessageBox("Atenci$$HEX1$$f300$$ENDHEX$$n","La Fecha de Alta no puede ser menor que la Fecha de Detecci$$HEX1$$f300$$ENDHEX$$n de la Incidencia.")
		gnv_msg.f_mensaje("AI113","","",ok!)
		This.SetItem(row,ls_campo_fecha_alta,idt_fec_deteccion)
		ib_dejo_cambiar = False
		// En caso de que la red sea monof$$HEX1$$e100$$ENDHEX$$sica, si la fecha nueva es menor que la fecha de 
		// alta, $$HEX1$$e900$$ENDHEX$$sta ser$$HEX2$$e1002000$$ENDHEX$$la nueva fecha de alta
		IF gb_red_trifasica = FALSE THEN
			of_calcular_min_fecha_alta(row)
		END IF

		This.SetReDraw(True)
		Return 2
	END IF
	
		// GNU 01/02/2007. Mejora 1/464613
		SELECT VALOR
		INTO :ls_tiempo_max_int
		FROM SGD_VALOR
		WHERE CODIF='INTA';
		
		IF long (ls_tiempo_max_int) > 0 AND &
			fg_duracion_horas (idt_fec_deteccion,ldt_f_alta) >= long (ls_tiempo_max_int) THEN
			li_respuesta=MessageBox("Atenci$$HEX1$$f300$$ENDHEX$$n","La Fecha de Reposici$$HEX1$$f300$$ENDHEX$$n sobrepasa el tiempo estimado. $$HEX1$$bf00$$ENDHEX$$Continuar?",Exclamation!,YesNo!)
//			gnv_msg.f_mensaje("AI109","","",ok!)
			IF li_respuesta= 2 THEN
				This.SetItem(row,ls_campo_fecha_alta,idt_fec_deteccion)
				ib_dejo_cambiar = False				
				IF gb_red_trifasica = FALSE THEN
					of_calcular_min_fecha_alta(row)
				END IF
				This.SetReDraw(True)
				Return 2
			END IF
		END IF
			
		// FIN GNU
	
	// No puede haber ning$$HEX1$$fa00$$ENDHEX$$n padre con una interrupci$$HEX1$$f300$$ENDHEX$$n cerrada con fecha de resoluci$$HEX1$$f300$$ENDHEX$$n mayor
	// que la fecha de alta de la nueva interrupci$$HEX1$$f300$$ENDHEX$$n
	IF tv_1.of_comprobar_fecha_alta(this, ldt_f_alta) = FALSE THEN
		gnv_msg.f_mensaje("AI144","","",ok!)
		This.SetItem(row,ls_campo_fecha_alta,fgnu_fecha_actual())
		ib_dejo_cambiar = False
		// En caso de que la red sea monof$$HEX1$$e100$$ENDHEX$$sica, si la fecha nueva es menor que la fecha de 
		// alta, $$HEX1$$e900$$ENDHEX$$sta ser$$HEX2$$e1002000$$ENDHEX$$la nueva fecha de alta
		IF gb_red_trifasica = FALSE THEN
			of_calcular_min_fecha_alta(row)
		END IF
		This.SetReDraw(True)
		Return 2
	END IF
	
	ldt_desde = ldt_f_alta
	
	// En caso de que la red sea monof$$HEX1$$e100$$ENDHEX$$sica, si la fecha nueva es menor que la fecha de 
	// alta, $$HEX1$$e900$$ENDHEX$$sta ser$$HEX2$$e1002000$$ENDHEX$$la nueva fecha de alta
	IF gb_red_trifasica = FALSE THEN
		of_calcular_min_fecha_alta(row)
	END IF
	
END IF


// GNU 19-07-2006. Incidencia 0/442382
// Lo pongo en dos IF porque si no casca
//IF dwo.name = 'afec_parcial' AND This.GetItemNumber(row, 'tipo_instalacion') = fgci_tipo_salida_de_baja THEN
IF dwo.name = 'afec_parcial' THEN 
	IF This.GetItemNumber(row, 'tipo_instalacion') = fgci_tipo_salida_de_baja THEN
// FIN GNU
		IF	fg_verifica_parametro('AFEC_PARCIAL_SUM') AND long(data) = 0 THEN
			IF Messagebox("Atenci$$HEX1$$f300$$ENDHEX$$n", "Si realiza esta acci$$HEX1$$f300$$ENDHEX$$n se eliminar$$HEX1$$e100$$ENDHEX$$n los suministros asociados a la interrupci$$HEX1$$f300$$ENDHEX$$n. $$HEX1$$bf00$$ENDHEX$$Desea continuar?", Question!, YesNo!) = 2 THEN
				//This.setitem(row, 'afec_parcial', 1)
				This.SetReDraw(True)
				return 1
			END IF
		END IF
	END IF
END IF

IF IsNull(ldt_hasta) THEN
	ldt_hasta = fgnu_fecha_actual()
END IF
IF IsNull(ldt_desde) THEN
	ldt_desde = ldt_hasta
END IF
		
If not isnull(ldt_desde) then
	st_duracion.text = fg_duracion_str(ldt_desde, ldt_hasta, 1)
	//st_duracion.visible = true
else
	st_duracion.text = ""
//			st_durac.visible = false
end if


This.SetReDraw(True)


//***************************************
//**  OSGI 2001.1  	28/05/2001			**
//**  Jair Padilla / Soluziona PANAMA  **
//***************************************
If ib_afect_parcial AND NOT iw_contenedora.fw_incidencia_de_operaciones() Then
	Return of_afec_parcial(row, This, dwo.Name, data)
End If
//***************************************
//**  OSGI 2001.1  	28/05/2001			**
//**  Jair Padilla / Soluziona PANAMA  **
//***************************************

end event

event losefocus;// Llamar a un evento que realice un AcceptText()
This.TriggerEvent("ue_itemchanged")

end event

event rowfocuschanged;datetime ldt_desde, ldt_hasta
int li_fase_seleccionada

if this.getrow() > 0 then	
		li_fase_seleccionada = This.GetItemNumber(this.getrow(),"fase_seleccionada")
		CHOOSE CASE li_fase_seleccionada
			CASE 0
				ldt_desde = This.GetItemDateTime(this.getrow(),"f_alta")
				ldt_hasta = This.GetItemDateTime(this.getrow(),"f_reposicion")
			CASE 1
				ldt_desde = This.GetItemDateTime(this.getrow(),"f_alta_fase_a")
				ldt_hasta = This.GetItemDateTime(this.getrow(),"f_reposicion_fase_a")
			CASE 2
				ldt_desde = This.GetItemDateTime(this.getrow(),"f_alta_fase_b")
				ldt_hasta = This.GetItemDateTime(this.getrow(),"f_reposicion_fase_b")
			CASE 3
				ldt_desde = This.GetItemDateTime(this.getrow(),"f_alta_fase_c")
				ldt_hasta = This.GetItemDateTime(this.getrow(),"f_reposicion_fase_c")
		END CHOOSE
		
		IF IsNull(ldt_hasta) THEN
			
			ldt_hasta = fgnu_fecha_actual()
			
		END IF
		
		If not isnull(ldt_desde) then
			st_duracion.text = fg_duracion_str(ldt_desde, ldt_hasta, 1)
//			st_duracion.visible = true
		else
			st_duracion.text = ""
//			st_durac.visible = false
		end if
//	end if

end if
end event

event constructor;//***************************************
//**  OSGI 2001.1  	31/05/2001			**
//**  Jair Padilla / Soluziona PANAMA  **
//***************************************
///// AFECTACION PARCIAL AMR 09/08/2002
//If ib_afect_parcial Then This.Modify("c_valida_sbt.Expression = '" + String(fgci_tipo_salida_de_baja) + "'")
/////
This.Modify("c_protect_afec_parcial.Expression = '1'")
//***************************************
//**  OSGI 2001.1  	31/05/2001			**
//**  Jair Padilla / Soluziona PANAMA  **
//***************************************


This.Object.fase_a.Text='Fase ' + gs_fase_a
This.Object.fase_b.Text='Fase ' + gs_fase_b
This.Object.fase_c.Text='Fase ' + gs_fase_c


end event

event itemerror;return 3
end event

event retrievestart;//***************************************
//**  OSGI 2001.2  	19/11/2002			**
//**  Jair Padilla / Soluziona PANAMA  **
//**  POT_INTERRUMPIDA COLOMBIA		   **
//***************************************
of_pot_interrump_col(d_datos_interrup)
//***************************************
//**  OSGI 2001.2  	19/11/2002			**
//**  Jair Padilla / Soluziona PANAMA  **
//**  POT_INTERRUMPIDA COLOMBIA		   **
//***************************************
end event

event doubleclicked;IF dwo.name = 'cccli_afec_t' THEN
	IF Long(dwo.font.underline) = 1 THEN
		of_suministros_int(d_datos_interrup, row, this.getitemNumber(row, 'nro_instalacion'))
	END IF
END IF
end event

type dw_lista_int_operaciones from u_lista_interrupciones_operacion within tabpage_interrupciones
boolean visible = false
integer x = 18
integer y = 100
integer width = 4128
integer height = 1380
integer taborder = 11
string dragicon = "recursos/Rows.ico"
boolean hscrollbar = true
boolean vscrollbar = true
boolean hsplitscroll = true
borderstyle borderstyle = styleraised!
end type

event rowfocuschanged;call super::rowfocuschanged;long ll_codigo_ct, ll_fila, ll_codigo, ll_fila_int
string ls_nom_ct, ls_Fase_afectada
Datetime ldt_f_alta, ldt_f_reposicion


SetPointer(HourGlass!)

d_datos_interrup.SetRedraw(False)
iw_contenedora.setredraw(False)


IF currentrow > 0 THEN
	dw_lista_acometidas.SetRedraw(False)
	This.SelectRow(0, FALSE)
	This.SelectRow(currentrow, TRUE)
	ll_codigo_ct = This.GetItemNumber(currentrow,"codigo")
	ls_nom_ct = GetItemString(currentrow, "nom_instalacion")

	IF (gi_tension_nivel_min >= fgci_baja_tension OR is_tipo_ventana <> "w_2301_hist")  THEN 
		

		st_otras_inst.Text = " Acometidas interrumpidas del CT " + ls_nom_ct
		dw_lista_acometidas.DbCancel()
		dw_lista_acometidas.Reset()
		dw_lista_acometidas.Retrieve(ll_codigo_ct, il_nro_incidencia)
		pb_avanzar.visible = False
		pb_anterior.visible = False
		cb_separador.visible = False
		IF dw_lista_acometidas.RowCount() > 0 THEN
			d_datos_interrup.visible = TRUE
			st_datos_interrup.visible = TRUE
			//This.Width = 2336
			//st_lista_int_operaciones.Width = 2336
			//st_otras_inst.Width = 2336
			//dw_lista_acometidas.width = 2336
			ll_codigo = dw_lista_acometidas.GetItemNumber(1,"codigo")
			st_durac.visible = true
			st_duracion.visible = true
			dw_lista_acometidas.SelectRow(0, False)
			dw_lista_acometidas.SelectRow(1,True)
			ll_fila = d_datos_interrup.Retrieve(il_nro_incidencia, ll_codigo)
			IF ll_fila > 1 THEN
				IF gi_tension_nivel_min = fgci_media_tension THEN
					ldt_f_alta = This.GetItemDateTime(currentrow,"f_alta")
					ll_fila_int = d_datos_interrup.Find("f_alta = datetime('" + string(ldt_f_alta) + "')", 0, ll_fila)
//					// GNU 30-6-2006. Incidencia 0/439862
//					if ll_fila_int > 0 then
//						ll_fila_int=currentrow
//					end if
//					// FIN GNU
					IF ll_fila_int > 0 THEN
						ll_fila = ll_fila_int
					END IF
 				ELSE
					pb_avanzar.visible = True
					pb_avanzar.enabled = True
					pb_anterior.visible = True
					pb_anterior.enabled = False
					cb_separador.visible = True
				END IF
			END IF
		
		ELSE
			d_datos_interrup.Reset()
			d_datos_interrup.visible = FALSE
			st_datos_interrup.visible = FALSE
			st_durac.visible = false
			st_duracion.visible = false
			//This.Width = 3429
			//st_lista_int_operaciones.Width = 3429
			//dw_lista_acometidas.width = 3429
			//st_otras_inst.Width = 3429
		END IF
	ELSE
		// GNU 3-8-2006. Incidencia 0/439862
		ldt_f_alta = This.GetItemDateTime(currentrow,"f_alta")
		ldt_f_reposicion = This.GetItemDateTime(currentrow,"f_reposicion")
		// operaciones tiene digitalizado media tensi$$HEX1$$f300$$ENDHEX$$n y se est$$HEX2$$e1002000$$ENDHEX$$en la ventana de hist$$HEX1$$f300$$ENDHEX$$ricos
		ll_fila = d_datos_interrup.find("nro_instalacion = " + string(ll_codigo_ct) + " AND f_alta = datetime('" + string(ldt_f_alta) + "')" ,1,d_datos_interrup.rowcount())
//		// GNU 30-6-2006. Incidencia 0/439862
//		if ll_fila > 0 then
//			ll_fila=currentrow
//		end if
//		// FIN GNU
		st_durac.text="Duraci$$HEX1$$f300$$ENDHEX$$n Int.:"
		st_durac.visible = true
		st_duracion.visible = true
//		IF ll_fila > 0 THEN
//			d_datos_interrup.ScrollToRow(ll_fila)
//		END IF
	END IF
	

	IF ll_fila > 0 THEN
		//IF gi_tension_nivel_min = fgci_baja_tension THEN
			ls_fase_afectada = d_datos_interrup.GetItemString(ll_fila, 'sgd_valor_descripcion')
			of_mostrar_fases_int(ll_fila, ls_fase_afectada)
		//END IF
		d_datos_interrup.Scrolltorow(ll_fila)
		d_datos_interrup.Setrow(ll_fila)
	END IF
	
	dw_lista_acometidas.SetRedraw(True)

END IF
d_datos_interrup.SetRedraw(True)
iw_contenedora.setredraw(True)
end event

event sqlpreview;//
end event

type d_lista_otras_inst_ant from u_ins_2010_pr_lista_dat_tecnicos within tabpage_interrupciones
event ue_eliminar pbm_custom42
boolean visible = false
integer x = 18
integer y = 1064
integer width = 2299
integer height = 584
integer taborder = 30
boolean hscrollbar = true
boolean vscrollbar = true
borderstyle borderstyle = styleraised!
end type

event ue_eliminar;Long ll_nro_instalacion, ll_fila, ll_nulo = 0, ll_fila_borrar

ll_fila_borrar = This.GetSelectedRow(0)
IF ll_fila_borrar > 0 THEN
	ll_nro_instalacion = This.GetItemNumber(ll_fila_borrar, 'nro_instalacion')
	
	// Se verifica la Causa de la incidencia si como consecuencia de la eliminaci$$HEX1$$f300$$ENDHEX$$n de la
	// interrupci$$HEX1$$f300$$ENDHEX$$n la incidencia pasase a SR
	IF ii_estado_oper = fgci_incidencia_en_reposicion AND &
		d_datos_interrup.Find('IsNull(f_reposicion) and nro_instalacion <> ' + string(ll_nro_instalacion), &
										1, d_datos_interrup.RowCount()) <= 0 AND &
		tabpage_formulario.d_inf_general.object.st_causa.Text = "" THEN
		
		gnv_msg.f_mensaje("AI57","","",ok!)
	
	ELSE
		ll_fila = d_datos_interrup.find("IsNull(f_reposicion) and nro_instalacion = " + string(ll_nro_instalacion), 1, d_datos_interrup.rowcount())
	
		DO WHILE ll_fila > 0 
			
			IF ll_fila < d_datos_interrup.rowcount() THEN
				d_datos_interrup.deleterow(ll_fila)
				ll_fila = d_datos_interrup.find("IsNull(f_reposicion) and nro_instalacion = " + string(ll_nro_instalacion), ll_fila + 1, d_datos_interrup.rowcount())
			ELSE
				d_datos_interrup.deleterow(ll_fila)
				ll_fila = 0
			END IF
		LOOP
		
		f_actualizar_estado()
		This.SelectRow(0, FALSE)
		This.setrow(ll_fila_borrar)
		This.DeleteRow(ll_fila_borrar)
		tv_1.Post Event SelectionChanged(0, il_handle_instalacion)
	END IF
END IF

end event

event rbuttondown;////////////////
//	Llama a un menu que permite agregar o eliminar 
//	interrupciones sobre otras instalaciones
Long ll_nro_instalacion,ll_array[]
int li_tipo_instalacion
m_btder_otras_inst NewMenu
String ls_busqueda

IF is_accion_llamada <> "Consulta" AND ii_estado_oper < fgci_incidencia_resuelta THEN
	IF	row <> This.GetSelectedRow(0) THEN
		This.Event RowFocusChanged(row)
	ELSE
		NewMenu = CREATE m_btder_otras_inst
		
		IF row > 0 THEN
			//This.Event RowFocusChanged(row)
			ll_nro_instalacion = This.GetItemNumber(row, 'nro_instalacion')
			li_tipo_instalacion = This.GetItemNumber(row, 'tipo_instalacion')
			IF gb_red_trifasica THEN
				ls_busqueda = "nro_instalacion=" + string(ll_nro_instalacion) + " and not IsNull(f_reposicion)" 
			ELSE
				ls_busqueda = "nro_instalacion=" + string(ll_nro_instalacion) + &
								  " and ( (not IsNull(f_reposicion_fase_a)) OR (not IsNull(f_reposicion_fase_b)) OR (not IsNull(f_reposicion_fase_c))" + &
											" or (not isnull(f_reposicion)))"
		
			END IF
				
			IF d_datos_interrup.Find(ls_busqueda, 1, d_datos_interrup.RowCount()) > 0 THEN
				NewMenu.m_eliminar.enabled = False
			END IF
			
			ls_busqueda = "nro_instalacion=" + string(ll_nro_instalacion) + " and IsNull(f_reposicion)" 
			IF d_datos_interrup.Find(ls_busqueda, 1, d_datos_interrup.RowCount()) <= 0 THEN
				NewMenu.m_gestionar.enabled = False
			END IF
			
			NewMenu.PopMenu(pointerx() + 100,pointery()+1500)
		ELSE
			NewMenu.m_eliminar.enabled = False
			NewMenu.m_gestionar.enabled = False
			NewMenu.PopMenu(pointerx() + 100,pointery()+1500)
		END IF
		
		IF NewMenu.ii_accion = 1 THEN
			gu_comunic1.is_comunic.Decval1 = 0
			tv_1.triggerEvent("ue_otras_interr")
			This.Event RowFocusChanged(row)
		ELSEIF NewMenu.ii_accion = 2 THEN
			gu_comunic1.is_comunic.Decval1 = This.GetitemNumber(row, 'nro_instalacion_padre')
			gu_comunic1.is_comunic.strval2 = This.GetitemString(row, 'nom_inst_padre')
			ll_array[2] = ll_nro_instalacion
			// FDO CORRECCION INCIDENCIA 0/315974
			IF gb_operaciones = true and gb_operaciones_inst = true then	  
				gu_rf.of_comprueba_inst_digitalizada(ll_array[],li_tipo_instalacion)
			END IF
			/////
			tv_1.triggerEvent("ue_otras_interr")
			This.Event RowFocusChanged(row)
		ELSEIF NewMenu.ii_accion = 3 THEN
			This.PostEvent("ue_eliminar")
		END IF
		

		DESTROY NewMenu
	END IF
END IF
end event

event rowfocuschanged;call super::rowfocuschanged;long ll_codigo, ll_fila, ll_fila_ant

IF This.visible AND currentrow > 0 AND currentrow <= this.RowCount() THEN
	tv_1.HideSelection = TRUE
	
	This.Selectrow(0, False)
	This.SelectRow(currentrow, True)
	
	pb_anterior.visible = False
	pb_avanzar.visible = False
	cb_separador.visible = False
	
	st_datos_interrup.visible=true
		
	d_datos_interrup.visible = TRUE
	dw_sin_interrupcion.visible = FALSE
	
	st_datos_interrup.text=" Datos de la Interrupci$$HEX1$$f300$$ENDHEX$$n."
	st_durac.visible = TRUE
	st_duracion.visible =TRUE
	ll_codigo = THIS.getitemNumber(currentrow, 'nro_instalacion')
	
	ll_fila = d_datos_interrup.find("nro_instalacion = " + string(ll_codigo),1,d_datos_interrup.rowcount())
	

	iw_contenedora.SetRedraw(FALSE)
	
	IF ll_fila > 0 THEN
		// La variable ll_fila puede cambiar en la funci$$HEX1$$f300$$ENDHEX$$n of_mostrar_fases_int, ya que se
		// tiene que seleccionar la fila que tenga una interrupci$$HEX1$$f300$$ENDHEX$$n no resuelta en la primera 
		// fase interrumpida, y esta fila puede que no sea la seleccionada con anterioridad
//		d_datos_interrup.object.f_reposicion.protect = 0
//		d_datos_interrup.object.f_reposicion.background.color = gs_blanco
//		d_datos_interrup.object.f_alta.protect = 0
//		d_datos_interrup.object.f_alta.background.color = gs_blanco
//		d_datos_interrup.object.f_reposicion_fase_a.protect = 0
//		d_datos_interrup.object.f_reposicion_fase_a.background.color = gs_blanco
//		d_datos_interrup.object.f_alta_fase_a.protect = 0
//		d_datos_interrup.object.f_alta_fase_a.background.color = gs_blanco
//		d_datos_interrup.object.f_reposicion_fase_b.protect = 0
//		d_datos_interrup.object.f_reposicion_fase_b.background.color = gs_blanco
//		d_datos_interrup.object.f_alta_fase_b.protect = 0
//		d_datos_interrup.object.f_alta_fase_b.background.color = gs_blanco
//		d_datos_interrup.object.f_reposicion_fase_c.protect = 0
//		d_datos_interrup.object.f_reposicion_fase_c.background.color = gs_blanco
//		d_datos_interrup.object.f_alta_fase_c.protect = 0
//		d_datos_interrup.object.f_alta_fase_c.background.color = gs_blanco
				
		// Dependiendo de si hay brigadas asignadas o de las fechas de reposici$$HEX1$$f300$$ENDHEX$$n se 
		// controla la protecci$$HEX1$$f300$$ENDHEX$$n de los campos de fecha de reposici$$HEX1$$f300$$ENDHEX$$n de las fases
		// interrumpidas
		IF tabpage_ot.d_lista_brigadas_ot.RowCount() <= 0  & 
			OR tabpage_ot.d_lista_brigadas_ot.find('isnull(f_hasta)', 0, tabpage_ot.d_lista_brigadas_ot.RowCount()) = 0 &
			OR d_datos_interrup.Find("nro_instalacion = " + string(ll_codigo) + " and isnull(f_reposicion) ", 1, d_datos_interrup.RowCount()) <= 0 &
			OR iw_contenedora.lu_comunic.is_comunic.accion_llamada = "Consulta" THEN
				
			d_datos_interrup.object.f_reposicion.protect = 1
			d_datos_interrup.object.f_reposicion.background.color = gs_gris
			d_datos_interrup.object.f_alta.protect = 1
			d_datos_interrup.object.f_alta.background.color = gs_gris
			d_datos_interrup.object.f_reposicion_fase_a.protect = 1
			d_datos_interrup.object.f_reposicion_fase_a.background.color = gs_gris
			d_datos_interrup.object.f_alta_fase_a.protect = 1
			d_datos_interrup.object.f_alta_fase_a.background.color = gs_gris
			d_datos_interrup.object.f_reposicion_fase_b.protect = 1
			d_datos_interrup.object.f_reposicion_fase_b.background.color = gs_gris
			d_datos_interrup.object.f_alta_fase_b.protect = 1
			d_datos_interrup.object.f_alta_fase_b.background.color = gs_gris
			d_datos_interrup.object.f_reposicion_fase_c.protect = 1
			d_datos_interrup.object.f_reposicion_fase_c.background.color = gs_gris

			d_datos_interrup.object.f_alta_fase_c.protect = 1
			d_datos_interrup.object.f_alta_fase_c.background.color = gs_gris

			//ELSEIF NOT isnull(d_datos_interrup.GetItemDatetime(ll_fila, 'f_reposicion_fase_a')) THEN
				// Se busca si la instalaci$$HEX1$$f300$$ENDHEX$$n tiene otra interrupci$$HEX1$$f300$$ENDHEX$$n definida en la fase A 
				// pendiente de ser resuelta
		ELSE
			ll_fila_ant = d_datos_interrup.Find('nro_instalacion = ' + string(ll_codigo) + ' and (not isnull(f_alta_fase_a)) and isnull(f_reposicion_fase_a)', 1, d_datos_interrup.RowCount())
			IF ll_fila_ant <= 0 THEN
				d_datos_interrup.object.f_reposicion_fase_a.protect = 1
				d_datos_interrup.object.f_reposicion_fase_a.background.color = gs_gris
				d_datos_interrup.object.f_alta_fase_a.protect = 1
				d_datos_interrup.object.f_alta_fase_a.background.color = gs_gris
			ELSE
				ll_fila = ll_fila_ant
			END IF
			
			// Se busca si la instalaci$$HEX1$$f300$$ENDHEX$$n tiene otra interrupci$$HEX1$$f300$$ENDHEX$$n definida en la fase B 
			// pendiente de ser resuelta
			ll_fila_ant = d_datos_interrup.Find('nro_instalacion = ' + string(ll_codigo) + ' and (not isnull(f_alta_fase_b)) and isnull(f_reposicion_fase_b)', 1, d_datos_interrup.RowCount())
			IF ll_fila_ant <= 0 THEN
				d_datos_interrup.object.f_reposicion_fase_b.protect = 1
				d_datos_interrup.object.f_reposicion_fase_b.background.color = gs_gris
				d_datos_interrup.object.f_alta_fase_b.protect = 1
				d_datos_interrup.object.f_alta_fase_b.background.color = gs_gris
			ELSE
				ll_fila = ll_fila_ant
			END IF

			// Se busca si la instalaci$$HEX1$$f300$$ENDHEX$$n tiene otra interrupci$$HEX1$$f300$$ENDHEX$$n definida en la fase A 
			// pendiente de ser resuelta
			ll_fila_ant = d_datos_interrup.Find('nro_instalacion = ' + string(ll_codigo) + ' and (not isnull(f_alta_fase_c)) and isnull(f_reposicion_fase_c)', 1, d_datos_interrup.RowCount())
			IF ll_fila_ant <= 0 THEN
				d_datos_interrup.object.f_reposicion_fase_c.protect = 1
				d_datos_interrup.object.f_reposicion_fase_c.background.color = gs_gris
				d_datos_interrup.object.f_alta_fase_c.protect = 1
				d_datos_interrup.object.f_alta_fase_c.background.color = gs_gris
			ELSE
				ll_fila_ant
			END IF
		END IF
	
		of_mostrar_fases_int(ll_fila, This.GetItemString(currentrow, 'fase_instalacion'))
		ll_fila_ant = d_datos_interrup.GetRow()
		d_datos_interrup.SetRow(ll_fila)
		d_datos_interrup.scrolltorow(ll_fila)
		
		//***************************************
		//**  OSGI 2001.1  	29/05/2001			**
		//**  Jair Padilla / Soluziona PANAMA  **
		//***************************************
		of_validaciones_sbt(ll_fila, d_datos_interrup)
		//***************************************
		//**  OSGI 2001.1  	29/05/2001			**
		//**  Jair Padilla / Soluziona PANAMA  **
		//***************************************

		//***************************************
		//**  OSGI 2001.2  	19/11/2002			**
		//**  Jair Padilla / Soluziona PANAMA  **
		//**  POT_INTERRUMPIDA COLOMBIA		   **
		//***************************************
		of_pot_interrump_col(d_datos_interrup)
		//***************************************
		//**  OSGI 2001.2  	19/11/2002			**
		//**  Jair Padilla / Soluziona PANAMA  **
		//**  POT_INTERRUMPIDA COLOMBIA		   **
		//***************************************

		IF ll_fila_ant = ll_fila then
			d_datos_interrup.TriggerEvent("rowfocuschanged")
		END IF

		st_durac.text="Duraci$$HEX1$$f300$$ENDHEX$$n Int.:"
		
		st_fases_afect.visible = FALSE
		cbx_fase_a.visible = FALSE
		cbx_fase_b.visible = FALSE
		cbx_fase_c.visible = FALSE
	END IF
	iw_contenedora.SetRedraw(TRUE)
	This.SetFocus()
	
END IF	

end event

event clicked;call super::clicked;IF row > 0 THEN
	//IF This.GetSelectedRow(0) = 0 THEN	
	This.Event RowFocusChanged(row)
END IF
end event

event retrieveend;call super::retrieveend;int li_contador
long ll_nro_instalacion

FOR li_contador=rowcount TO 1 STEP - 1
	ll_nro_instalacion = This.GetitemNumber(li_contador, 'nro_instalacion')
	IF This.find("nro_instalacion = " + string(ll_nro_instalacion) + &
					 " and IsNull(f_reposicion) and getrow() <> " + string(li_contador), 1, This.RowCount()) > 0 THEN
			

		This.deleterow(li_contador)
	END IF
	
NEXT


end event

event ue_as_need;//
end event

event sqlpreview;//
end event

type dw_lista_acometidas from u_inc_lista_acometidas_int within tabpage_interrupciones
boolean visible = false
integer x = 18
integer y = 1572
integer width = 4128
integer height = 576
integer taborder = 11
boolean hscrollbar = true
boolean vscrollbar = true
borderstyle borderstyle = styleraised!
end type

event rowfocuschanged;call super::rowfocuschanged;long ll_fila = 1, ll_codigo, ll_cant_aco
string ls_fase_afectada
datetime ldt_f_alta

d_datos_interrup.SetRedraw(False)
IF currentrow > 0 THEN
	st_durac.visible = true
	st_duracion.visible = true
	This.SelectRow(0, False)
	This.SelectRow(currentrow,True)
	ll_codigo = This.GetItemNumber(currentrow,"codigo")
	ll_cant_aco = d_datos_interrup.Retrieve(il_nro_incidencia, ll_codigo)
	IF (gi_tension_nivel_min >= fgci_baja_tension OR is_tipo_ventana <> "w_2301_hist")  THEN 
		IF ll_cant_aco > 1 THEN
			IF gi_tension_nivel_min < fgci_baja_tension THEN // Media Tensi$$HEX1$$f300$$ENDHEX$$n digitalizada
				ldt_f_alta = dw_lista_int_operaciones.GetitemDateTime(dw_lista_int_operaciones.GetRow(), 'f_alta')
				//ll_fila = dw_lista_int_operaciones.Find("f_alta = datetime('" + string(ldt_f_alta) + "')", 0, ll_cant_aco)				
				dw_lista_int_operaciones.Find("f_alta = datetime('" + string(ldt_f_alta) + "')", 0, ll_cant_aco)				
			ELSE
				pb_avanzar.visible = True
				pb_avanzar.enabled = True
				pb_anterior.visible = True
				pb_anterior.enabled = False
				cb_separador.visible = True
			END IF
		ELSE
			pb_avanzar.visible = False
			pb_anterior.visible = False
			cb_separador.visible = False
		END IF
		
		
			
//	ELSE	
//		ll_fila = d_datos_interrup.find("nro_instalacion = " + string(ll_codigo),1,d_datos_interrup.rowcount())
//		d_datos_interrup.scrolltorow(ll_fila)
	END IF
	
	IF ll_cant_aco > 0 THEN
		//IF gi_tension_nivel_min = fgci_baja_tension THEN
			ls_fase_afectada = d_datos_interrup.GetItemString(ll_fila, 'sgd_valor_descripcion')
			of_mostrar_fases_int(ll_fila, ls_fase_afectada)	
		//END IF
		d_datos_interrup.Scrolltorow(ll_fila)
		d_datos_interrup.Setrow(ll_fila)
	END IF
		
ELSE
	IF This.RowCount() = 0 THEN
		st_durac.visible = false
		st_duracion.visible = false
	END IF
END IF

d_datos_interrup.SetRedraw(True)
end event

type d_lista_otras_inst from u_ins_2010_pr_lista_otras_ins within tabpage_interrupciones
boolean visible = false
integer x = 18
integer y = 1068
integer width = 4114
integer height = 568
integer taborder = 11
string dataobject = "d_ins_2010_pr_lista_otras_ins"
boolean hscrollbar = true
boolean vscrollbar = true
borderstyle borderstyle = styleraised!
end type

event losefocus;call super::losefocus;This.AcceptText()
//f_actualizar_estado()
end event

event retrievestart;call super::retrievestart;long ll_estado_red

////////////////////////////////////////////////////////////////////////////////////
// Esta Select es para saber si se trata de una incidencia dada de alta antes de la 
// conversi$$HEX1$$f300$$ENDHEX$$n de los datos. Esto ocurre cuando el campo Estado_Red es -10
SELECT NVL(ESTADO_RED,0)
INTO :ll_estado_red
FROM SGD_INCIDENCIA
WHERE NRO_INCIDENCIA = :il_nro_incidencia;

IF ll_estado_red = -10 and gb_operaciones_inst = false THEN Return 1
end event

event buttonclicked;call super::buttonclicked;long ll_nro_instalacion, ll_fila
Int li_lock_status

IF row > 0 AND is_accion_llamada <> "Consulta" THEN
	iw_contenedora.SetRedraw(FALSE)
	
	// Se busca si existe la interrupci$$HEX1$$f300$$ENDHEX$$n de la dw de interrupciones
	ll_nro_instalacion = This.GetItemNumber(row, 'nro_instalacion')
	
	ll_fila = d_datos_interrup.Find("nro_incidencia<>" + string(il_nro_incidencia)+" and nro_instalacion = " + string(ll_nro_instalacion), 1, d_datos_interrup.RowCount())
	
	IF ll_fila <= 0 THEN // La interrupci$$HEX1$$f300$$ENDHEX$$n no existe. 
		// Se bloquea la incidencia de la interrupci$$HEX1$$f300$$ENDHEX$$n
		gnu_u_transaction.uf_rollback(iw_contenedora.st_bloqueo, "SGD_INCIDENCIA", "NRO_INCIDENCIA=" + string(This.GetItemNumber(row, 'nro_incidencia')), fgci_bloqueo_incidencia, This.GetItemNumber(row, 'nro_incidencia'))

		IF gnu_u_transaction.uf_lock(iw_contenedora.st_bloqueo, "SGD_INCIDENCIA", "NRO_INCIDENCIA=" + string(This.GetItemNumber(row, 'nro_incidencia')), fgci_bloqueo_incidencia, This.GetItemNumber(row, 'nro_incidencia')) = 0 THEN
			//Bloqueamos la interrupci$$HEX1$$f300$$ENDHEX$$n
			
			// Se desbloquea la instalaci$$HEX1$$f300$$ENDHEX$$n padre si la ten$$HEX1$$ed00$$ENDHEX$$amos bloqueada
			IF This.GetItemNumber(row, 'nro_padre') <> fgcdec_aviso_con_alimentacion THEN
				gnu_u_transaction.uf_rollback(iw_contenedora.st_bloqueo,'sgd_instalacion','nro_instalacion = ' + string(This.GetItemNumber(row, 'nro_padre')),true)
				// Se bloquea la instalaci$$HEX1$$f300$$ENDHEX$$n padre
				li_lock_status = gnu_u_transaction.uf_lock(true,iw_contenedora.st_bloqueo,'sgd_instalacion','nro_instalacion = ' + string(This.GetItemNumber(row, 'nro_padre')))
			ELSE
				gnu_u_transaction.uf_rollback(iw_contenedora.st_bloqueo,'sgd_instalacion','nro_instalacion = ' + string(ll_nro_instalacion),true)
				li_lock_status = gnu_u_transaction.uf_lock(true,iw_contenedora.st_bloqueo,'sgd_instalacion','nro_instalacion = ' + string(ll_nro_instalacion))
			END IF
			
			if li_lock_status = 0 then
			
				tv_1.HideSelection = TRUE
			
				// La insertamos en la dw
				ll_fila = d_datos_interrup.InsertRow(0)
				d_datos_interrup.setitem(ll_fila,"cant_cli_afec",This.GetItemNumber(row, 'ccli_afec'))
				d_datos_interrup.setitem(ll_fila,"co_nivel",This.GetItemNumber(row, 'co_nivel'))
				d_datos_interrup.setitem(ll_fila,"f_actual",This.GetItemDateTime(row, 'f_actual'))
				d_datos_interrup.setitem(ll_fila,"f_alta",This.GetItemDateTime(row, 'f_alta'))
				d_datos_interrup.setitem(ll_fila,"f_reposicion",This.GetItemDateTime(row, 'f_reposicion'))
				d_datos_interrup.setitem(ll_fila,"kwh",This.GetItemNumber(row, 'kwh'))
				d_datos_interrup.setitem(ll_fila,"nro_incidencia",This.GetItemNumber(row, 'nro_incidencia'))
				d_datos_interrup.setitem(ll_fila,"nro_instalacion",This.GetItemNumber(row, 'nro_instalacion'))
				d_datos_interrup.setitem(ll_fila,"nro_padre",This.GetItemNumber(row, 'nro_padre'))
				d_datos_interrup.setitem(ll_fila,"programa",'W_2301')
				d_datos_interrup.setitem(ll_fila,"tipo_instalacion",This.GetItemNumber(row, 'tipo_instalacion'))
				d_datos_interrup.setitem(ll_fila,"usuario",gs_usuario)
				d_datos_interrup.setitem(ll_fila,"pot_instalada",This.GetItemNumber(row, 'pot_instalada'))
				d_datos_interrup.setitem(ll_fila,"pot_contratada",This.GetItemNumber(row, 'pot_contratada'))
				d_datos_interrup.setitem(ll_fila,"pot_inst_afec", This.GetItemNumber(row, 'pot_inst_afec'))
				d_datos_interrup.setitem(ll_fila,"pot_contr_afec",This.GetItemNumber(row, 'pot_contr_afec'))
				d_datos_interrup.setitem(ll_fila,"cant_cli",This.GetItemNumber(row, 'cant_cli'))
				d_datos_interrup.setitem(ll_fila,"tip_interrupcion",'O')
				d_datos_interrup.setitem(ll_fila,"ind_otras_ins",This.GetItemNumber(row, 'ind_otras_ins'))
				d_datos_interrup.setitem(ll_fila,"f_alta_fase_a",This.GetItemDateTime(row, 'f_alta_fase_a'))
				d_datos_interrup.setitem(ll_fila,"f_alta_fase_b",This.GetItemDateTime(row, 'f_alta_fase_b'))
				d_datos_interrup.setitem(ll_fila,"f_alta_fase_c",This.GetItemDateTime(row, 'f_alta_fase_c'))
				d_datos_interrup.setitem(ll_fila,"f_reposicion_fase_a",This.GetItemDateTime(row, 'f_reposicion_fase_a'))
				d_datos_interrup.setitem(ll_fila,"f_reposicion_fase_b",This.GetItemDateTime(row, 'f_reposicion_fase_b'))
				d_datos_interrup.setitem(ll_fila,"f_reposicion_fase_c",This.GetItemDateTime(row, 'f_reposicion_fase_c'))
				d_datos_interrup.setitem(ll_fila,"fase_afectada",This.GetItemString(row, 'fase_afectada'))
				d_datos_interrup.setitem(ll_fila,"sgd_valor_descripcion",This.GetItemString(row, 'sgd_valor_descripcion'))
				d_datos_interrup.AcceptText()
			
				d_datos_interrup.SetItemStatus(ll_fila, 0, Primary!, DataModified!)
			ELSE // la interrupci$$HEX1$$f300$$ENDHEX$$n no se ha podido bloquear. Desbloqueamos la incidencia
				gnu_u_transaction.uf_commit(Parent, "SGD_INCIDENCIA", "NRO_INCIDENCIA=" + string(This.GetItemNumber(row, 'nro_incidencia')), fgci_bloqueo_incidencia, This.GetItemNumber(row, 'nro_incidencia'))	
				ll_fila = 0
			END IF
		ELSE
			ll_fila = 0
		END IF
	END IF
	
	IF ll_fila > 0 THEN
		d_datos_interrup.setrow(ll_fila)
		d_datos_interrup.ScrollToRow(ll_fila)
		d_datos_interrup.visible = TRUE
		dw_sin_interrupcion.visible = FALSE
		of_mostrar_fases_int(ll_fila, this.GetitemString(row,'sgd_valor_descripcion'))
		cbx_fase_a.visible = FALSE
		cbx_fase_b.visible = FALSE
		cbx_fase_c.visible = FALSE

		st_fases_afect.visible = FALSE
		This.of_habilitar_fechas(row, d_datos_interrup)
	END IF
	iw_contenedora.SetRedraw(TRUE)

END IF


end event

event rowfocuschanged;call super::rowfocuschanged;long ll_nro_instalacion, ll_fila

IF This.visible AND currentrow > 0 AND currentrow <= this.RowCount() AND tv_1.HideSelection THEN
	This.SelectRow(0,False)
	This.SelectRow(currentrow,true)
	iw_contenedora.SetRedraw(FALSE)
	
	// Se busca si existe la interrupci$$HEX1$$f300$$ENDHEX$$n de la dw de interrupciones
	ll_nro_instalacion = This.GetItemNumber(currentrow, 'nro_instalacion')
	
	ll_fila = d_datos_interrup.Find("nro_incidencia<>" + string(il_nro_incidencia)+" and nro_instalacion = " + string(ll_nro_instalacion), 1, d_datos_interrup.RowCount())
	
	IF ll_fila <= 0 THEN
		cbx_fase_a.visible = False
		cbx_fase_b.visible = False
		cbx_fase_c.visible = False
		dw_sin_interrupcion.visible = True
		d_datos_interrup.Visible = False
		st_fases_afect.visible = FALSE
	
		ll_fila = dw_sin_interrupcion.find("nro_instalacion = " + string(ll_nro_instalacion),1,dw_sin_interrupcion.rowcount())
		
		if ll_fila=0 then
			fnu_carga_sin_interrup(ll_nro_instalacion,This.GetItemNumber(currentrow, 'tipo_instalacion'))
		ELSE
			dw_sin_interrupcion.visible = TRUE
			dw_sin_interrupcion.scrolltorow(ll_fila)
			dw_sin_interrupcion.setrow(ll_fila)
		end if
		st_datos_interrup.text=" Datos de la Instalaci$$HEX1$$f300$$ENDHEX$$n."
		d_datos_interrup.visible = FALSE
		st_durac.visible = FALSE
		st_duracion.visible = FALSE
		st_durac_total.visible = FALSE
		st_duracion_total.visible = FALSE			
		st_datos_interrup.visible=true

	ELSE
		d_datos_interrup.setrow(ll_fila)
		d_datos_interrup.ScrollToRow(ll_fila)
		d_datos_interrup.visible = TRUE
		dw_sin_interrupcion.visible = FALSE
		of_mostrar_fases_int(ll_fila, this.GetitemString(currentrow,'sgd_valor_descripcion'))
		IF is_accion_llamada <> "Consulta" THEN
			This.of_habilitar_fechas(currentrow, d_datos_interrup)
		END IF
		cbx_fase_a.visible = FALSE
		cbx_fase_b.visible = FALSE
		cbx_fase_c.visible = FALSE
		st_fases_afect.visible = FALSE

	END IF
	iw_contenedora.SetRedraw(TRUE)

END IF

end event

event clicked;call super::clicked;IF row > 0 THEN
	tv_1.HideSelection = TRUE
	IF This.GetSelectedRow(0) = 0 THEN	This.Event RowFocusChanged(row)
END IF
end event

event constructor;call super::constructor;IF gb_red_trifasica THEN
	This.modify("fase_afectada_t.visible='0'")
	This.modify("sgd_valor_descripcion.visible='0'")
ELSE
	This.modify("fase_afectada_t.x='2267'")
	This.modify("sgd_valor_descripcion.x='2285'")
END IF
	
end event

type tv_1 from u_tv within tabpage_interrupciones
integer x = 18
integer y = 20
integer width = 4128
integer height = 956
integer taborder = 20
string dragicon = ""
integer textsize = 0
integer weight = 0
fontpitch fontpitch = default!
fontfamily fontfamily = anyfont!
string facename = ""
boolean hideselection = false
string picturename[] = {".\recursos\subestaca.bmp",".\recursos\salat.bmp",".\recursos\SUBEST.bmp",".\recursos\SAL_TRA1.BMP","CT1.bmp","TRANSFOR.bmp","SALBAJ.bmp","nsubest.bmp","nsal_tra1.bmp","nct1.bmp","ntransfor.bmp","nsalbaj.bmp","rsubest.bmp","r_sal_tra1.bmp","rct1.bmp","rtransfor.bmp","rsalbaj.bmp"}
string statepicturename[] = {".\recursos\off.bmp",".\recursos\on.bmp",".\recursos\on.bmp",".\recursos\ALARMA.BMP"}
end type

event selectionchanged;treeviewitem le_elemento, le_elem_padre

long ll_codigo, ll_fila,ll_contador,ll_handle_padre, ll_fila_ant,ll_ret
int li_tension, li_tabla_decision,li_instalaciones_inst
boolean lb_padre_int = False
string ls_fase_campo_rep, ls_campo_fecha_alta

IF newhandle > 0 AND This.Visible = True THEN
	pb_anterior.visible = False
	pb_avanzar.visible = False
	cb_separador.visible = False
	il_handle_instalacion = newhandle
	this.il_handle_seleccionado = newhandle
	// PACHO, comprobaci$$HEX1$$f300$$ENDHEX$$n de otras interrupciones
	
	THIS.getitem(newhandle,le_elemento)
	This.ii_tipo_icono = le_elemento.pictureindex
		
	
		

	
	d_lista_otras_inst.reset()
	
	st_datos_interrup.visible=true
	//Left(le_elemento.label,2) = 'X ') & 	
//	IF (le_elemento.bold = TRUE AND le_elemento.StatePictureIndex = 2) &
//		OR le_elemento.pictureindex = f_icono_arbol(of_ret_tipo(newhandle) + ii_instalaciones_repuestas) THEN//&
//			 AND (ii_estado_oper = fgci_incidencia_resuelta)) THEN
	IF (le_elemento.bold = TRUE AND le_elemento.StatePictureIndex = 2) &
		OR le_elemento.StatePictureIndex = 3 THEN
		
		d_datos_interrup.visible = TRUE
		//d_datos_interrup.SetReDraw(FALSE)
		dw_sin_interrupcion.visible = FALSE
		st_datos_interrup.text=" Datos de la Interrupci$$HEX1$$f300$$ENDHEX$$n."
		st_durac.visible = TRUE
		st_duracion.visible =TRUE
		ll_codigo = THIS.of_ret_codigo(newhandle)
		ll_fila = d_datos_interrup.find("nro_incidencia=" + string(il_nro_incidencia)+" and nro_instalacion = " + string(ll_codigo),1,d_datos_interrup.rowcount())
		IF ll_fila > 0 THEN
			// La variable ll_fila puede cambiar en la funci$$HEX1$$f300$$ENDHEX$$n of_mostrar_fases_int, ya que se
			// tiene que seleccionar la fila que tenga una interrupci$$HEX1$$f300$$ENDHEX$$n no resuelta en la primera 
			// fase interrumpida, y esta fila puede que no sea la seleccionada con anterioridad
//			d_datos_interrup.object.f_reposicion.protect = 0
//			d_datos_interrup.object.f_reposicion.background.color = gs_blanco
//			d_datos_interrup.object.f_alta.protect = 0
//			d_datos_interrup.object.f_alta.background.color = gs_blanco
//			d_datos_interrup.object.f_reposicion_fase_a.protect = 0
//			d_datos_interrup.object.f_reposicion_fase_a.background.color = gs_blanco
//			d_datos_interrup.object.f_alta_fase_a.protect = 0
//			d_datos_interrup.object.f_alta_fase_a.background.color = gs_blanco
//			d_datos_interrup.object.f_reposicion_fase_b.protect = 0
//			d_datos_interrup.object.f_reposicion_fase_b.background.color = gs_blanco
//			d_datos_interrup.object.f_alta_fase_b.protect = 0
//			d_datos_interrup.object.f_alta_fase_b.background.color = gs_blanco
//			d_datos_interrup.object.f_reposicion_fase_c.protect = 0
//			d_datos_interrup.object.f_reposicion_fase_c.background.color = gs_blanco
//			d_datos_interrup.object.f_alta_fase_c.protect = 0
//			d_datos_interrup.object.f_alta_fase_c.background.color = gs_blanco
			
			IF gb_red_trifasica THEN
				ll_handle_padre = This.FindItem(ParentTreeItem!, newhandle)
				
				IF ll_handle_padre > 0 THEN
					THIS.getitem(ll_handle_padre, le_elem_padre)
					lb_padre_int = le_elem_padre.bold
				END IF				
			END IF
			// Dependiendo de si hay brigadas asignadas o de las fechas de reposici$$HEX1$$f300$$ENDHEX$$n se 
			// controla la protecci$$HEX1$$f300$$ENDHEX$$n de los campos de fecha de reposici$$HEX1$$f300$$ENDHEX$$n de las fases
			// interrumpidas
			IF tabpage_ot.d_lista_brigadas_ot.RowCount() <= 0  & 
				OR tabpage_ot.d_lista_brigadas_ot.find('isnull(f_hasta)', 0, tabpage_ot.d_lista_brigadas_ot.RowCount()) = 0 &
				OR d_datos_interrup.Find("nro_incidencia=" + string(il_nro_incidencia)+" and nro_instalacion = " + string(ll_codigo) + " and isnull(f_reposicion) ", 1, d_datos_interrup.RowCount()) <= 0 &
				OR iw_contenedora.lu_comunic.is_comunic.accion_llamada = "Consulta" &
				OR lb_padre_int THEN
				
				d_datos_interrup.object.f_reposicion.protect = 1
				d_datos_interrup.object.f_reposicion.background.color = gs_gris
				d_datos_interrup.object.f_alta.protect = 1
				d_datos_interrup.object.f_alta.background.color = gs_gris
				d_datos_interrup.object.f_reposicion_fase_a.protect = 1
				d_datos_interrup.object.f_reposicion_fase_a.background.color = gs_gris
				d_datos_interrup.object.f_alta_fase_a.protect = 1
				d_datos_interrup.object.f_alta_fase_a.background.color = gs_gris
				d_datos_interrup.object.f_reposicion_fase_b.protect = 1
				d_datos_interrup.object.f_reposicion_fase_b.background.color = gs_gris
				d_datos_interrup.object.f_alta_fase_b.protect = 1
				d_datos_interrup.object.f_alta_fase_b.background.color = gs_gris
				d_datos_interrup.object.f_reposicion_fase_c.protect = 1
				d_datos_interrup.object.f_reposicion_fase_c.background.color = gs_gris
				d_datos_interrup.object.f_alta_fase_c.protect = 1
				d_datos_interrup.object.f_alta_fase_c.background.color = gs_gris

			//ELSEIF NOT isnull(d_datos_interrup.GetItemDatetime(ll_fila, 'f_reposicion_fase_a')) THEN
				// Se busca si la instalaci$$HEX1$$f300$$ENDHEX$$n tiene otra interrupci$$HEX1$$f300$$ENDHEX$$n definida en la fase A 
				// pendiente de ser resuelta
			ELSE
				IF d_datos_interrup.Find("nro_incidencia=" + string(il_nro_incidencia)+' and nro_instalacion = ' + string(ll_codigo) + ' and (not isnull(f_alta_fase_a)) and isnull(f_reposicion_fase_a)', 1, d_datos_interrup.RowCount()) <= 0 THEN
					d_datos_interrup.object.f_reposicion_fase_a.protect = 1
					d_datos_interrup.object.f_reposicion_fase_a.background.color = gs_gris
					d_datos_interrup.object.f_alta_fase_a.protect = 1
					d_datos_interrup.object.f_alta_fase_a.background.color = gs_gris
				END IF
			
			//ELSEIF NOT isnull(d_datos_interrup.GetItemDatetime(ll_fila, 'f_reposicion_fase_b')) THEN
				// Se busca si la instalaci$$HEX1$$f300$$ENDHEX$$n tiene otra interrupci$$HEX1$$f300$$ENDHEX$$n definida en la fase B 
				// pendiente de ser resuelta
				IF d_datos_interrup.Find("nro_incidencia=" + string(il_nro_incidencia)+' and nro_instalacion = ' + string(ll_codigo) + ' and (not isnull(f_alta_fase_b)) and isnull(f_reposicion_fase_b)', 1, d_datos_interrup.RowCount()) <= 0 THEN
					d_datos_interrup.object.f_reposicion_fase_b.protect = 1
					d_datos_interrup.object.f_reposicion_fase_b.background.color = gs_gris
					d_datos_interrup.object.f_alta_fase_b.protect = 1
					d_datos_interrup.object.f_alta_fase_b.background.color = gs_gris
				END IF

			//ELSEIF NOT isnull(d_datos_interrup.GetItemDatetime(ll_fila, 'f_reposicion_fase_c')) THEN
				// Se busca si la instalaci$$HEX1$$f300$$ENDHEX$$n tiene otra interrupci$$HEX1$$f300$$ENDHEX$$n definida en la fase A 
				// pendiente de ser resuelta
				IF d_datos_interrup.Find("nro_incidencia=" + string(il_nro_incidencia)+' and nro_instalacion = ' + string(ll_codigo) + ' and (not isnull(f_alta_fase_c)) and isnull(f_reposicion_fase_c)', 1, d_datos_interrup.RowCount()) <= 0 THEN
					d_datos_interrup.object.f_reposicion_fase_c.protect = 1
					d_datos_interrup.object.f_reposicion_fase_c.background.color = gs_gris
					d_datos_interrup.object.f_alta_fase_c.protect = 1
					d_datos_interrup.object.f_alta_fase_c.background.color = gs_gris
				END IF
			END IF	
			
			of_mostrar_fases_int(ll_fila, This.of_ret_fase(newhandle))
			ll_fila_ant = d_datos_interrup.GetRow()
			d_datos_interrup.SetRow(ll_fila)
			d_datos_interrup.scrolltorow(ll_fila)
			IF ll_fila_ant = ll_fila then
				d_datos_interrup.TriggerEvent("rowfocuschanged")
			END IF
		END IF
		
		IF NOT iw_contenedora.fw_incidencia_de_operaciones() AND ll_fila > 0 THEN
		
			IF gb_operaciones = FALSE THEN
				li_tension = 0
			ELSE
				li_tension = gi_tension_nivel_min
			END IF
			IF gb_tabla_decision THEN
				li_tabla_decision = 1
			ELSE
				li_tabla_decision = 0
			END IF
			
			li_instalaciones_inst = 0
			
			if gb_operaciones_inst then li_instalaciones_inst = 1
			
			ll_ret = d_lista_otras_inst.retrieve(ll_codigo,il_nro_incidencia, &
										       d_datos_interrup.GetItemString(ll_fila, 'fase_afectada'),&
												 d_datos_interrup.GetItemNumber(ll_fila, 'tipo_instalacion'),&
												 li_tension, li_tabla_decision, li_instalaciones_inst)

			CHOOSE CASE d_datos_interrup.GetItemNumber(ll_fila, 'fase_seleccionada')
				CASE 0
					ls_fase_campo_rep = 'f_reposicion'
					ls_campo_fecha_alta = 'f_alta'
				CASE 1
					ls_fase_campo_rep = 'f_reposicion_fase_a'
					ls_campo_fecha_alta = 'f_alta_fase_a'
				CASE 2

					ls_fase_campo_rep = 'f_reposicion_fase_b'
					ls_campo_fecha_alta = 'f_alta_fase_b'
				CASE 3
					ls_fase_campo_rep = 'f_reposicion_fase_c'
					ls_campo_fecha_alta = 'f_alta_fase_c'
				CASE ELSE
					ls_fase_campo_rep = 'f_reposicion'
					ls_campo_fecha_alta = 'f_alta'

			END CHOOSE
						
//			//Una vez hecho el retrieve del nuevo codigo, compruebo pa ver si esta en la estructura.
		//	if NOT ISNULL(d_datos_interrup.object.f_reposicion[ll_fila]) and &
			if NOT ISNULL(d_datos_interrup.GetItemDatetime(ll_fila, ls_fase_campo_rep)) and &
			   ii_estado_oper < fgci_incidencia_servicio_repuesto then
				FOR ll_contador = 1 to d_lista_otras_inst.rowcount()
					d_lista_otras_inst.object.color[ll_contador] = 1	
				NEXT
			END IF
		end if
	
		st_durac.text="Duraci$$HEX1$$f300$$ENDHEX$$n Int.:"
		
//		IF ll_fila > 0 THEN
//			of_mostrar_fases_int(ll_fila, This.of_ret_fase(newhandle))
//			d_datos_interrup.SetRow(ll_fila)
//			d_datos_interrup.scrolltorow(ll_fila)
//		END IF
		//d_datos_interrup.scrolltorow(ll_fila)
		//d_datos_interrup.SetReDraw(TRUE)

	ELSE

		cbx_fase_a.visible = False
		cbx_fase_b.visible = False
		cbx_fase_c.visible = False
		st_fases_afect.visible = FALSE
		ll_codigo = THIS.of_ret_codigo(newhandle)
		
		ll_fila = dw_sin_interrupcion.find("nro_instalacion = " + string(ll_codigo),1,dw_sin_interrupcion.rowcount())
		
		if ll_fila=0 then
			// Le paso a la funci$$HEX1$$f300$$ENDHEX$$n el tipo de la instalacion para que solo baje dos niveles - PACHO
			fnu_carga_sin_interrup(ll_codigo,tv_1.of_ret_tipo(newhandle))
		end if
		
		ll_fila = dw_sin_interrupcion.find("nro_instalacion = " + string(ll_codigo),1,dw_sin_interrupcion.rowcount())
		
		if ll_fila>0 then	
			dw_sin_interrupcion.visible = TRUE
			dw_sin_interrupcion.scrolltorow(ll_fila)
			dw_sin_interrupcion.Setrow(ll_fila)
		end if
		
		st_datos_interrup.text=" Datos de la Instalaci$$HEX1$$f300$$ENDHEX$$n."
		d_datos_interrup.visible = FALSE
		st_durac.visible = FALSE
		st_duracion.visible = FALSE
		st_durac_total.visible = FALSE
		st_duracion_total.visible = FALSE			
		st_datos_interrup.visible=true
			
	END IF

END IF
end event

event clicked;call super::clicked;treeviewitem le_elemento, le_elem_padre
long ll_codigo, ll_fila,ll_encontrado,ll_contador,ll_contador2, ll_handle_padre, ll_fila_ant
boolean lb_cargado, lb_padre_int = False

IF tv_1.HideSelection THEN
	iw_contenedora.SetRedraw(FALSE)
	tv_1.HideSelection = FALSE
	IF handle = 0 THEN handle = 1
	This.Event SelectionChanged(handle,handle)
	d_lista_otras_inst.Selectrow(0, FALSE)	
	d_lista_otras_inst_ant.Selectrow(0, FALSE)	
	iw_contenedora.SetRedraw(TRUE)
	return
END IF

IF handle > 0 then
	d_lista_otras_inst.Selectrow(0, FALSE)	
	pb_anterior.visible = False
	pb_avanzar.visible = False
	cb_separador.visible = False
	This.SelectItem(handle)
	il_handle_instalacion = handle
	this.il_handle_seleccionado = handle
	THIS.getitem(handle,le_elemento)
	
	st_datos_interrup.visible=true
	
	This.ii_tipo_icono = le_elemento.pictureindex

//	Left(le_elemento.label,2) = 'X '
//	IF le_elemento.bold = TRUE AND le_elemento.StatePictureIndex = 2  &
//		OR le_elemento.pictureindex = f_icono_arbol(of_ret_tipo(handle) + ii_instalaciones_repuestas) THEN //&
//	 		 AND (ii_estado_oper = fgci_incidencia_resuelta)) THEN
	IF (le_elemento.bold = TRUE AND le_elemento.StatePictureIndex = 2) &
		OR le_elemento.StatePictureIndex = 3 THEN
		
		// Esto es para evitar que en una situaci$$HEX1$$f300$$ENDHEX$$n muy particular la datawindow no muestra 
		// los datos de la interrupci$$HEX1$$f300$$ENDHEX$$n. S$$HEX1$$f300$$ENDHEX$$lo los muestra si la datawindow tiene barras de 
		// scroll, as$$HEX2$$ed002000$$ENDHEX$$que se pone y se quita. Cosas de POWER    (LFE)
		//d_datos_interrup.VScrollBar = TRUE
		//d_datos_interrup.VScrollBar = FALSE
		IF d_datos_interrup.visible = FALSE THEN
			// Es para evitar que se haga un setredraw
			d_datos_interrup.visible = TRUE
			st_duracion.visible =FALSE // Se hace visible m$$HEX1$$e100$$ENDHEX$$s abajo. Esto se hace para evitar 
												// que la datawindow se quede por encima y no se muestre
												// la duraci$$HEX1$$f300$$ENDHEX$$n
		END IF
		
		d_datos_interrup.SetRedraw(FALSE)
		dw_sin_interrupcion.visible = FALSE
		st_datos_interrup.text=" Datos de la Interrupci$$HEX1$$f300$$ENDHEX$$n."
		st_durac.visible = TRUE
		
		st_duracion.visible =True
		ll_codigo = THIS.of_ret_codigo(handle)
		ll_fila = d_datos_interrup.find("nro_incidencia=" + string(il_nro_incidencia)+" and nro_instalacion = " + string(ll_codigo),1,d_datos_interrup.rowcount())
		
		st_durac.text="Duraci$$HEX1$$f300$$ENDHEX$$n Int.:"

		IF ll_fila > 0 THEN
			// La variable ll_fila puede cambiar en la funci$$HEX1$$f300$$ENDHEX$$n of_mostrar_fases_int, ya que se
			// tiene que seleccionar la fila que tenga una interrupci$$HEX1$$f300$$ENDHEX$$n no resuelta en la primera 
			// fase interrumpida, y esta fila puede que no sea la seleccionada con anterioridad
			of_mostrar_fases_int(ll_fila, This.of_ret_fase(handle))
			ll_fila_ant = d_datos_interrup.GetRow()
			d_datos_interrup.SetRow(ll_fila)
			d_datos_interrup.scrolltorow(ll_fila)
			
			IF ll_fila_ant = ll_fila then
				d_datos_interrup.TriggerEvent("rowfocuschanged")
			END IF
			
		END IF
		
		//***************************************
		//**  OSGI 2001.1  	29/05/2001			**
		//**  Jair Padilla / Soluziona PANAMA  **
		//***************************************
		of_validaciones_sbt(ll_fila, d_datos_interrup)
		//***************************************
		//**  OSGI 2001.1  	29/05/2001			**
		//**  Jair Padilla / Soluziona PANAMA  **
		//***************************************

		//***************************************
		//**  OSGI 2001.2  	19/11/2002			**
		//**  Jair Padilla / Soluziona PANAMA  **
		//**  POT_INTERRUMPIDA COLOMBIA		   **
		//***************************************
		of_pot_interrump_col(d_datos_interrup)
		//***************************************
		//**  OSGI 2001.2  	19/11/2002			**
		//**  Jair Padilla / Soluziona PANAMA  **
		//**  POT_INTERRUMPIDA COLOMBIA		   **
		//***************************************

		d_datos_interrup.SetRedraw(TRUE)
		
	ELSE
		cbx_fase_a.visible = False
		cbx_fase_b.visible = False
		cbx_fase_c.visible = False
		st_fases_afect.visible = FALSE
		ll_codigo = THIS.of_ret_codigo(handle)
		
		ll_fila = dw_sin_interrupcion.find("nro_instalacion = " + string(ll_codigo),1,dw_sin_interrupcion.rowcount())
		
		if ll_fila=0 then
			fnu_carga_sin_interrup(ll_codigo,tv_1.of_ret_tipo(handle))
			
		//ll_fila = dw_sin_interrupcion.find("nro_instalacion = " + string(ll_codigo),1,dw_sin_interrupcion.rowcount())
		ELSE
			dw_sin_interrupcion.visible = TRUE
			dw_sin_interrupcion.scrolltorow(ll_fila)
			dw_sin_interrupcion.setrow(ll_fila)
		end if
		st_datos_interrup.text=" Datos de la Instalaci$$HEX1$$f300$$ENDHEX$$n."
		d_datos_interrup.visible = FALSE
		st_durac.visible = FALSE
		st_duracion.visible = FALSE
		st_durac_total.visible = FALSE
		st_duracion_total.visible = FALSE			
		st_datos_interrup.visible=true
		d_lista_otras_inst_ant.Selectrow(0, FALSE)
	END IF

END IF

end event

event rightclicked;call super::rightclicked;treeviewitem le_elemento

IF This.Getitem(handle, le_elemento) <> -1 THEN
	This.Event Clicked(il_handle_instalacion)
	This.Event Selectionchanged(il_handle_instalacion,handle)
END IF

//***************************************
//**  OSGI 2001.1  	04/06/2001			**
//**  Jair Padilla / Soluziona PANAMA  **
//***************************************
//of_validaciones_sbt(d_datos_interrup.GetRow(), d_datos_interrup)
//***************************************
//**  OSGI 2001.1  	04/06/2001			**
//**  Jair Padilla / Soluziona PANAMA  **
//***************************************

end event

type tabpage_seguimiento from userobject within u_tab_2301_form_incidencias
event ue_cerrar ( )
integer x = 18
integer y = 112
integer width = 5527
integer height = 3872
long backcolor = 79741120
string text = "Seguimiento"
long tabtextcolor = 33554432
long tabbackcolor = 79741120
string picturename = "Step!"
long picturemaskcolor = 553648127
chk_resolucion_mant chk_resolucion_mant
d_estados_mantenimientos d_estados_mantenimientos
d_seguimiento_operaciones d_seguimiento_operaciones
d_seguimiento_mantenimiento d_seguimiento_mantenimiento
d_estados_operaciones d_estados_operaciones
end type

event ue_cerrar;close(iw_contenedora)
end event

on tabpage_seguimiento.create
this.chk_resolucion_mant=create chk_resolucion_mant
this.d_estados_mantenimientos=create d_estados_mantenimientos
this.d_seguimiento_operaciones=create d_seguimiento_operaciones
this.d_seguimiento_mantenimiento=create d_seguimiento_mantenimiento
this.d_estados_operaciones=create d_estados_operaciones
this.Control[]={this.chk_resolucion_mant,&
this.d_estados_mantenimientos,&
this.d_seguimiento_operaciones,&
this.d_seguimiento_mantenimiento,&
this.d_estados_operaciones}
end on

on tabpage_seguimiento.destroy
destroy(this.chk_resolucion_mant)
destroy(this.d_estados_mantenimientos)
destroy(this.d_seguimiento_operaciones)
destroy(this.d_seguimiento_mantenimiento)
destroy(this.d_estados_operaciones)
end on

type chk_resolucion_mant from checkbox within tabpage_seguimiento
event clicked pbm_bnclicked
boolean visible = false
integer x = 1335
integer y = 88
integer width = 873
integer height = 68
integer textsize = -10
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long backcolor = 81324524
boolean enabled = false
string text = "Resuelve Mantenimiento"
end type

event clicked;//boolean lb_check
//lb_check = this.Checked
//
//IF NOT this.Checked THEN 
//	ii_resuelve_mant = 0	//no resuelve mant
//	gi_resuelve_mant = 0
//ELSE
//	ii_resuelve_mant = 1	//resuelve mant
//	gi_resuelve_mant = 1
//END IF
//
//tabpage_formulario.d_inf_general.SetItem(1,"resuelve_mant",ii_resuelve_mant)
//
end event

type d_estados_mantenimientos from u_ema_2002_pr_lista_estado_mantenimiento within tabpage_seguimiento
boolean visible = false
integer x = 2103
integer y = 648
integer width = 187
integer height = 748
integer taborder = 60
boolean bringtotop = true
boolean border = false
end type

type d_seguimiento_operaciones from u_eop_2001_pr_seguimiento_operaciones within tabpage_seguimiento
event clicked pbm_dwnlbuttonclk
event dragdrop pbm_dwndragdrop
event itemchanged pbm_dwnitemchange
event ue_item_changed pbm_custom72
integer x = 37
integer y = 180
integer width = 5417
integer height = 2500
integer taborder = 21
string dragicon = "ENV_MAN.ICO"
boolean border = false
borderstyle borderstyle = styleraised!
end type

event clicked;long ll_row
datetime ld_fecha

this.AcceptText()

IF il_ultima_fila_clickeada_seg > 0 AND ib_inc_finalizada AND &
	( row <> ii_incidencia_resuelta OR (row = ii_incidencia_resuelta AND dwo.name <> "f_alta" ) )  THEN
	ib_inc_finalizada = FALSE
	this.TriggerEvent("ue_item_changed")
END IF


il_click_oper_seg = row

IF dwo.name = "f_alta" AND row = ii_incidencia_resuelta AND is_accion_llamada <> "Consulta" AND &
	NOT ib_inc_finalizada AND  &
	 ( (ii_estado_oper = fgci_incidencia_servicio_repuesto AND ii_incidencia_pte_pta_explotacion = 0) OR &
	 	(ii_estado_oper = fgci_incidencia_pte_explotacion) ) then
	
	IF IsNull(This.GetItemDateTime(ii_incidencia_resuelta, 'f_alta')) THEN
		il_ultima_fila_clickeada_seg = row
		ib_inc_finalizada = TRUE
		
		This.Setitem(ii_incidencia_resuelta, 'f_alta', fgnu_fecha_actual())
		This.AcceptText()
		ib_mensaje_resuelta=false		
		Return 0
	END IF
	
END IF

// Solo se puede derivar a mantenimiento en estado servicio repuesto
IF gb_mantenimiento=FALSE OR NOT il_click_oper_seg > 0 OR &
	il_click_oper_seg  <> ii_incidencia_servicio_repuesto THEN
	Return
END IF

//Si la incidencia es de suministro no pude derivar a mant
IF (ii_tipo_incid <> fgci_incidencia_imprevista OR &
	ii_alcance = fgci_incidencia_de_suministro) AND ib_ind_scada = false &
	AND ii_tipo_incid <> fgci_incidencia_calidad THEN
	Return
END IF
//
//Si se dio click fuera de la datwindow o en el cabezal 
//o en estado de resuelta o si la incidencia esta en estado resuelta 

ld_fecha = d_seguimiento_operaciones.GetItemDateTime(ii_incidencia_servicio_repuesto,"f_alta")

IF NOT ISNULL(d_seguimiento_operaciones.GetItemDateTime(ii_incidencia_resuelta, "f_alta")) OR &
	is_accion_llamada = "Consulta" THEN
	Return
END IF

//Si no es un usuario de operaciones y no se esta anulando la operacion
IF fgnu_auto_der_oper() THEN
	ll_row=d_seguimiento_operaciones.Find("ind_env_mant = " + string(fgci_entrada)+" OR ind_env_mant ="+string(fgci_entrada_salida),0,d_seguimiento_operaciones.RowCount())

   IF ll_row <> il_click_oper_seg THEN
		return
	ELSE		//es anulacion de derivacion a operaciones y usuario de mantenimiento
		if gb_mantenimiento = true then
			this.Drag(Begin!)
		end if
	END IF	

END IF

//Si el estado no esta en por lo menos en SR o SI fue derivada a mant
IF il_click_oper_seg < ii_incidencia_servicio_repuesto  OR &
	iw_contenedora.tab_1.fnu_devolver_env_mant(tabpage_seguimiento.d_seguimiento_mantenimiento) THEN
	Return
END IF

This.AcceptText()
IF NOT ISNULL(this.GetItemdatetime(il_click_oper_seg,"f_alta")) and gb_mantenimiento = true THEN
	this.Drag(Begin!)
END IF
end event

event dragdrop;////////////////////////////////////////////////////////////////////////////
////	Evento: Obtener el estado de operaciones seleccionado para 
////				actualizar la bd
/////////////////////////////////////////////////////////////////////////////
//// MERC long x
//long i, ll_cant_row
//int li_est_actual,pi_est_mant,ejecutar
//string accion
//datawindow objeto
//
//gi_est_mant = ii_estado_mant			// estado de mantenimiento  
//gi_resuelve_mant = ii_resuelve_mant				//ind_resuelve mantenimiento
//
////This.SetFocus()
//This.AcceptText()
//objeto = source
//IF typeof(Objeto) = DataWindow! THEN
//	IF objeto.DataObject = "d_ema_2001_pr_list_seguimiento_mant" THEN
//		IF iw_contenedora.tab_1.frn_es_anulacion(tabpage_seguimiento.d_seguimiento_mantenimiento,il_click_mant_seg) THEN
//			IF iw_contenedora.tab_1.frn_validar_anulacion(tabpage_seguimiento.d_seguimiento_mantenimiento,il_click_mant_seg) THEN
//				ii_estado_mant=0
//				ii_resuelve_mant=0
//				tabpage_formulario.d_inf_general.SetItem(1,"estado_mantenimiento",ii_estado_mant)
//				SetNull(idt_fecha_st_mant)
//				d_seguimiento_mantenimiento.fpr_anulacion_mant(1,il_click_mant_seg)
//				d_seguimiento_operaciones.fpr_anulacion_oper(1)
//				iw_contenedora.tab_1.frn_habilita_resuelve_mant()
//				IF NOT ISNULL(d_seguimiento_operaciones.GetItemDateTime(ii_incidencia_servicio_repuesto,"f_alta")) THEN
//					d_seguimiento_operaciones.SetItem(ii_incidencia_resuelta,"usuario",gs_usuario)
//				END IF
//				d_seguimiento_mantenimiento.AcceptText()
//				d_seguimiento_operaciones.AcceptText()
//				d_seguimiento_operaciones.SetFocus()
//			END IF
//		ELSE
//			IF iw_contenedora.tab_1.frn_validar_salida_mant(d_estados_mantenimientos,d_seguimiento_mantenimiento,il_click_mant_seg,ii_estado_mant) THEN
//				d_seguimiento_operaciones.fpr_marcar_entrada_oper(ii_estado_oper)
//				d_seguimiento_mantenimiento.fpr_marcar_salida_mant(il_click_mant_seg)
//			END IF
//		END IF
//	END IF
//END IF
//
//
//this.Drag(End!)
//
end event

event itemchanged;//24/10/2008  yaf

datetime ldt_fecha_nueva

il_ultima_fila_clickeada_seg = row

IF dwo.name = "f_alta" then
	ldt_fecha_nueva = DateTime(Date(Left(data,10)),Time(Right(data,15)))
	this.postevent("ue_item_changed")
ELSEIF dwo.name = "observacion" then  // LFE
	// Se previene que en la modificaci$$HEX1$$f300$$ENDHEX$$n del campo observaci$$HEX1$$f300$$ENDHEX$$n no se inserte un nulo
	IF data = '' THEN 
		This.Setitem(row, 'observacion', ' ')
		return 2
	END IF

END IF
end event

event ue_item_changed;long ll_nro_trabajos, ll_nro_descargo, ll_total
datetime ldt_fecha_ingresada, ldt_f_nula
int li_respuesta, ii_sgi_sgt, li_ind_act_grafica = 0

string ls_duracion // GNU 5-6-2007. Mejora 1/465490

int		li_posicion			//Fila del tab seguimiento que debemos poner la fecha a nul

Long ll_nro_solicitudes
int li_net
string	ls_mensaje			//Mensaje que se muestra al cerrar la incidencia si est$$HEX2$$e1002000$$ENDHEX$$activo OCEN o OSGM

ldt_fecha_ingresada = fgnu_valido_fecha_nula(this.getitemdatetime(il_ultima_fila_clickeada_seg,"f_alta"))
SetNull(ldt_f_nula)
//u_enlace lu_onis

IF ib_inc_finalizada Then return

this.setitem(il_ultima_fila_clickeada_seg,"f_alta",ldt_fecha_ingresada)

IF il_ultima_fila_clickeada_seg = ii_incidencia_resuelta or il_ultima_fila_clickeada_seg= ii_incidencia_pte_pta_explotacion then
	
	

	SELECT nvl("SGD_DESCARGOS"."IND_ACT_GRAFICA" ,0), NVL("SGD_DESCARGOS"."NRO_DESCARGO",0)
   INTO :li_ind_act_grafica, :ll_nro_descargo
   FROM "SGD_DESCARGOS"  
   WHERE "SGD_DESCARGOS"."NRO_INCIDENCIA" = :il_nro_incidencia   ;

	//SRE necesito que siempre tenga numero de descargo... aunque sea CERO
	SELECT COUNT(*)
	INTO :ll_total
	FROM "SGD_DESCARGOS"
	WHERE "SGD_DESCARGOS"."NRO_INCIDENCIA" = :il_nro_incidencia   ;

	IF (ll_total=0) THEN
		li_ind_act_grafica=0
		ll_nro_descargo=0
	END IF 
	
	// Si es incidencia resuelta or pdte_pta_explotacion
	IF NOT IsNull(ldt_fecha_ingresada) THEN
		

		// Se valida si se ha definido la instalaci$$HEX1$$f300$$ENDHEX$$n origen
		

		IF NOT (ii_alcance = fgci_incidencia_de_suministro or &
   		ii_tipo_incid = fgci_incidencia_calidad or &
	 		ii_alcance = fgci_incidencia_reenganche or &
    		ii_alcance = fgci_incidencia_sin_interrupcion) THEN
			
			IF ii_tipo_incid <> fgci_incidencia_programada and (tabpage_formulario.d_inf_general.getitemnumber(1,"instalacion_origen") < 1 &
				or isnull(tabpage_formulario.d_inf_general.getitemnumber(1,"instalacion_origen"))) THEN
				
				IF NOT iw_contenedora.fw_incidencia_de_operaciones() THEN
					gnv_msg.f_mensaje("AI140","","",OK!)
					this.setitem(il_ultima_fila_clickeada_seg,"f_alta",ldt_f_nula)
					ib_retorno_segumiento= true
					Return
				ELSE
					tabpage_formulario.d_inf_general.SetItem(1,"instalacion_origen",tabpage_formulario.d_inf_general.getitemnumber(1,"nombre_ins"))
				END IF
			END IF
		END IF		
		
		//NCA-INICIO.DDAG-1783.20150319.Validamos que se escoja una acci$$HEX1$$f300$$ENDHEX$$n de incidencia antes de resolver la incidencia.
			If IsNull(tabpage_formulario.d_inf_general.GetItemNumber(1, 'cod_accion_inc')) or &
                tabpage_formulario.d_inf_general.GetItemNumber(1, 'cod_accion_inc') = 0 Then	
					gnv_msg.f_mensaje("AI04","acci$$HEX1$$f300$$ENDHEX$$n de incidencia","",ok!)
					
							IF li_ind_act_grafica = 1 AND ii_incidencia_resuelta = 6 THEN
//								iw_contenedora.tab_1.tabpage_interrupciones.d_datos_interrup.Modify("f_reposicion.Protect= '0'")
//								iw_contenedora.tab_1.tabpage_interrupciones.d_datos_interrup.Modify("f_reposicion.Background.Color= '" + gs_blanco + "'")
								iw_contenedora.tab_1.tabpage_interrupciones.d_datos_interrup.setItem(1, "f_reposicion", ldt_f_nula)				
								fpr_deshabilitar_lista_brigadas_ot(iw_contenedora.tab_1.tabpage_ot.d_datos_ot, 1)	
								ii_estado_oper = ii_estActualAnterior
								
								FOR li_posicion = ii_estado_oper TO il_ultima_fila_clickeada_seg
									this.setitem(li_posicion,"f_alta",ldt_f_nula)
								NEXT
							
							END IF
				this.setitem(il_ultima_fila_clickeada_seg,"f_alta",ldt_f_nula)
				ib_retorno_segumiento= true	
				iw_contenedora.tab_1.Post Event ue_selecttab(1)
				tabpage_formulario.setredraw(true)
				Return
		 END IF
	  //NCA-FIN.DDAG-1783.20150319.			
		
		// Se valida si hay causa
		//JME 02/06/09 Debe comprobarse que no es la causa gen$$HEX1$$e900$$ENDHEX$$rica
		//IF IsNull(tabpage_formulario.d_inf_general.GetItemNumber(1, 'causa')) THEN
		IF IsNull(tabpage_formulario.d_inf_general.GetItemNumber(1, 'causa')) or &
			tabpage_formulario.d_inf_general.GetItemNumber(1, 'causa') = 999 THEN
			
			IF ib_error_en_causa = FALSE THEN
				Messagebox("Atenci$$HEX1$$f300$$ENDHEX$$n", "Debe seleccionar una causa")
			END IF
			//AHM (14/10/2010)
			IF li_ind_act_grafica = 1 AND ii_incidencia_resuelta = 6 THEN
//				iw_contenedora.tab_1.tabpage_interrupciones.d_datos_interrup.Modify("f_reposicion.Protect= '0'")
//				iw_contenedora.tab_1.tabpage_interrupciones.d_datos_interrup.Modify("f_reposicion.Background.Color= '" + gs_blanco + "'")
				iw_contenedora.tab_1.tabpage_interrupciones.d_datos_interrup.setItem(1, "f_reposicion", ldt_f_nula)				
				fpr_deshabilitar_lista_brigadas_ot(iw_contenedora.tab_1.tabpage_ot.d_datos_ot, 1)
/*				iw_contenedora.tab_1.tabpage_ot.d_datos_ot.Modify("f_hasta.Protect= '1'")
				iw_contenedora.tab_1.tabpage_ot.d_datos_ot.Modify("f_hasta.Background.Color= '" + gs_gris + "'")*/
				//AHM (15/10/2010)
				ii_estado_oper = ii_estActualAnterior
				
				FOR li_posicion = ii_estado_oper TO il_ultima_fila_clickeada_seg
					this.setitem(li_posicion,"f_alta",ldt_f_nula)
				NEXT
					
			END IF
			this.setitem(il_ultima_fila_clickeada_seg,"f_alta",ldt_f_nula)
//			tabpage_formulario.st_1.visible = TRUE
			ib_retorno_segumiento= true
			ib_error_en_causa = FALSE
			iw_contenedora.tab_1.Post Event ue_selecttab(1)
			tabpage_formulario.setredraw(true)
			Return
		END IF
		
		//TDA.INI.EDM-2.05052017 Validar que la sub causa no se guarde vac$$HEX1$$ed00$$ENDHEX$$a
		IF IsNull(tabpage_formulario.d_inf_general.GetItemNumber(1,'causa_subtipo')) or &
			tabpage_formulario.d_inf_general.GetItemNumber(1,'causa_subtipo') = 0 THEN
			
			IF ib_error_en_causa_subtipo = FALSE THEN
				Messagebox("Atenci$$HEX1$$f300$$ENDHEX$$n", "Debe seleccionar una sub causa")
			END IF
			
			//AHM (14/10/2010)
			IF li_ind_act_grafica = 1 AND ii_incidencia_resuelta = 6 THEN
//				iw_contenedora.tab_1.tabpage_interrupciones.d_datos_interrup.Modify("f_reposicion.Protect= '0'")
//				iw_contenedora.tab_1.tabpage_interrupciones.d_datos_interrup.Modify("f_reposicion.Background.Color= '" + gs_blanco + "'")
				iw_contenedora.tab_1.tabpage_interrupciones.d_datos_interrup.setItem(1, "f_reposicion", ldt_f_nula)				
				fpr_deshabilitar_lista_brigadas_ot(iw_contenedora.tab_1.tabpage_ot.d_datos_ot, 1)
/*				iw_contenedora.tab_1.tabpage_ot.d_datos_ot.Modify("f_hasta.Protect= '1'")
				iw_contenedora.tab_1.tabpage_ot.d_datos_ot.Modify("f_hasta.Background.Color= '" + gs_gris + "'")*/
				//AHM (15/10/2010)
				ii_estado_oper = ii_estActualAnterior
				
				FOR li_posicion = ii_estado_oper TO il_ultima_fila_clickeada_seg
					this.setitem(li_posicion,"f_alta",ldt_f_nula)
				NEXT					
			END IF
			
			this.setitem(il_ultima_fila_clickeada_seg,"f_alta",ldt_f_nula)
//			tabpage_formulario.st_18.visible = TRUE
			ib_retorno_segumiento= true
			ib_error_en_causa_subtipo = FALSE
			iw_contenedora.tab_1.Post Event ue_selecttab(1)
			tabpage_formulario.setredraw(true)
			
			
			Return
		END IF
		
		IF IsNull(tabpage_formulario.d_inf_general.GetItemString(1,'rep_red')) OR tabpage_formulario.d_inf_general.GetItemString(1,'rep_red') = '' THEN
			MessageBox("Atenci$$HEX1$$f300$$ENDHEX$$n","Debe seleccionar Rtro Obj/Rpro Red")
			
			//AHM (14/10/2010)
			IF li_ind_act_grafica = 1 AND ii_incidencia_resuelta = 6 THEN
//				iw_contenedora.tab_1.tabpage_interrupciones.d_datos_interrup.Modify("f_reposicion.Protect= '0'")
//				iw_contenedora.tab_1.tabpage_interrupciones.d_datos_interrup.Modify("f_reposicion.Background.Color= '" + gs_blanco + "'")
				iw_contenedora.tab_1.tabpage_interrupciones.d_datos_interrup.setItem(1, "f_reposicion", ldt_f_nula)				
				fpr_deshabilitar_lista_brigadas_ot(iw_contenedora.tab_1.tabpage_ot.d_datos_ot, 1)
/*				iw_contenedora.tab_1.tabpage_ot.d_datos_ot.Modify("f_hasta.Protect= '1'")
				iw_contenedora.tab_1.tabpage_ot.d_datos_ot.Modify("f_hasta.Background.Color= '" + gs_gris + "'")*/
				//AHM (15/10/2010)
				ii_estado_oper = ii_estActualAnterior
				
				FOR li_posicion = ii_estado_oper TO il_ultima_fila_clickeada_seg
					this.setitem(li_posicion,"f_alta",ldt_f_nula)
				NEXT					
			END IF
			
			this.setitem(il_ultima_fila_clickeada_seg,"f_alta",ldt_f_nula)
			iw_contenedora.tab_1.Post Event ue_selecttab(1)
			tabpage_formulario.setredraw(true)
			Return
		END IF
		
		IF IsNull(tabpage_formulario.d_inf_general.GetItemString(1,'origen_incidencia')) OR tabpage_formulario.d_inf_general.GetItemString(1,'origen_incidencia') = '' THEN
			MessageBox("Atenci$$HEX1$$f300$$ENDHEX$$n","Debe seleccionar el Origen de la incidencia")
			
			//AHM (14/10/2010)
			IF li_ind_act_grafica = 1 AND ii_incidencia_resuelta = 6 THEN
//				iw_contenedora.tab_1.tabpage_interrupciones.d_datos_interrup.Modify("f_reposicion.Protect= '0'")
//				iw_contenedora.tab_1.tabpage_interrupciones.d_datos_interrup.Modify("f_reposicion.Background.Color= '" + gs_blanco + "'")
				iw_contenedora.tab_1.tabpage_interrupciones.d_datos_interrup.setItem(1, "f_reposicion", ldt_f_nula)				
				fpr_deshabilitar_lista_brigadas_ot(iw_contenedora.tab_1.tabpage_ot.d_datos_ot, 1)
/*				iw_contenedora.tab_1.tabpage_ot.d_datos_ot.Modify("f_hasta.Protect= '1'")
				iw_contenedora.tab_1.tabpage_ot.d_datos_ot.Modify("f_hasta.Background.Color= '" + gs_gris + "'")*/
				//AHM (15/10/2010)
				ii_estado_oper = ii_estActualAnterior
				
				FOR li_posicion = ii_estado_oper TO il_ultima_fila_clickeada_seg
					this.setitem(li_posicion,"f_alta",ldt_f_nula)
				NEXT					
			END IF
			
			this.setitem(il_ultima_fila_clickeada_seg,"f_alta",ldt_f_nula)
			iw_contenedora.tab_1.Post Event ue_selecttab(1)
			tabpage_formulario.setredraw(true)
			Return
		END IF
		
	  //TDA.FIN.EDM-2.05052017	
		

		if	tabpage_formulario.d_inf_general.GetItemNumber(1, 'causa') = fgci_cod_causa_desconocida THEN
			
			IF ib_error_en_causa = FALSE  THEN
				Messagebox("Atenci$$HEX1$$f300$$ENDHEX$$n", "Debe seleccionar una causa que no sea desconocida")
			END IF
			

			this.setitem(il_ultima_fila_clickeada_seg,"f_alta",ldt_f_nula)
//			tabpage_formulario.st_1.visible = TRUE
			ib_retorno_segumiento= true
			ib_error_en_causa = FALSE
			iw_contenedora.tab_1.Post Event ue_selecttab(1)
			tabpage_formulario.setredraw(true)
			Return
		END IF
		
		// Se validan las observaciones
		IF not iu_inc_2003_rn.frn_validar_observaciones(tabpage_formulario.d_inf_general) THEN
			this.setitem(il_ultima_fila_clickeada_seg,"f_alta",ldt_f_nula)
			ib_retorno_segumiento= true
			
			iw_contenedora.tab_1.Post Event ue_selecttab(2)
			iw_contenedora.setredraw(False)
			iw_contenedora.setredraw(True)
			return 
		END IF
		
		// Valido la fecha ingresada
		IF ldt_fecha_ingresada > fgnu_fecha_actual() THEN
			//MessageBox("Atenci$$HEX1$$f300$$ENDHEX$$n","La fecha ingresada no puede ser mayor que la fecha actual.")
			gnv_msg.f_mensaje("AI120","","",ok!)
			this.setitem(il_ultima_fila_clickeada_seg,"f_alta",ldt_f_nula)
			ib_retorno_segumiento= true
			Return
		END IF
		
		// Validacion que la fecha de resuelta sea mayor que fecha SR
		IF ldt_fecha_ingresada < This.GetItemDateTime(ii_incidencia_servicio_repuesto,"f_alta") THEN
			//MessageBox("Atenci$$HEX1$$f300$$ENDHEX$$n","La fecha ingresada no puede ser menor que la fecha de SR.")
			gnv_msg.f_mensaje("AI121","","",ok!)
			this.setitem(il_ultima_fila_clickeada_seg,"f_alta",ldt_f_nula)
			ib_retorno_segumiento= true
			Return 
		END IF
	
		// Validacion que la fecha de resuelta sea mayor que fecha de la $$HEX1$$fa00$$ENDHEX$$ltima maniobra
		// si la incidencia es de operaci$$HEX1$$f300$$ENDHEX$$n
		IF iw_contenedora.fw_incidencia_de_operaciones() THEN
			IF tabpage_maniobras.dw_maniobras.Find("fecha_maniobra > datetime('" + string(ldt_fecha_ingresada) + "')", 0, tabpage_maniobras.dw_maniobras.RowCount()) > 0 THEN
				MessageBox("Atenci$$HEX1$$f300$$ENDHEX$$n", "La fecha de resoluci$$HEX1$$f300$$ENDHEX$$n de la Incidencia no puede ser menor que la fecha de la $$HEX1$$fa00$$ENDHEX$$ltima maniobra")
				this.setitem(il_ultima_fila_clickeada_seg,"f_alta",ldt_f_nula)
				ib_retorno_segumiento= true
				Return 
			END IF
		END IF
		
		// Validacion que la fecha de resuelta sea mayor que la fecha de finalizaci$$HEX1$$f300$$ENDHEX$$n de
		// la OT en caso de que est$$HEX2$$e9002000$$ENDHEX$$resuelta
		IF tabpage_ot.d_datos_ot.GetItemNumber(1, 'est_ot') = fgci_ot_resuelta THEN
			IF ldt_fecha_ingresada < tabpage_ot.d_datos_ot.GetItemDatetime(1, 'f_hasta') THEN
				MessageBox("Atenci$$HEX1$$f300$$ENDHEX$$n", "La fecha de resoluci$$HEX1$$f300$$ENDHEX$$n de la Incidencia no puede ser menor que la fecha de finalizaci$$HEX1$$f300$$ENDHEX$$n de la OT")
				this.setitem(il_ultima_fila_clickeada_seg,"f_alta",ldt_f_nula)
				ib_retorno_segumiento= true
				Return 
			END IF
		END IF
		
		// Validacion que la fecha de resuelta sea mayor que la fecha de finalizaci$$HEX1$$f300$$ENDHEX$$n de
		// la OT en caso de que est$$HEX2$$e9002000$$ENDHEX$$resuelta
		IF il_nro_ot > 0 then
			IF ldt_fecha_ingresada < tabpage_ot.d_datos_ot.GetItemDatetime(1, 'f_desde') THEN
				MessageBox("Atenci$$HEX1$$f300$$ENDHEX$$n", "La fecha de resoluci$$HEX1$$f300$$ENDHEX$$n de la Incidencia no puede ser menor que la fecha de inicio de la OT")
				this.setitem(il_ultima_fila_clickeada_seg,"f_alta",ldt_f_nula)
				ib_retorno_segumiento= true
				Return 
			END IF
				
			// A$$HEX1$$b700$$ENDHEX$$adido por Sgo. 26/05/2004. Incidencia de validaciones.
			// Se comprueba que la fecha de finalizaci$$HEX1$$f300$$ENDHEX$$n de la incidencia sea superior a la fecha 
			// de inicio del trabajo de las brigadas/contratas
			IF tabpage_ot.d_lista_brigadas_ot.Find("f_desde > datetime('" + string(ldt_fecha_ingresada) + "')", 0, tabpage_ot.d_lista_brigadas_ot.RowCount()) > 0 THEN
				MessageBox("Atenci$$HEX1$$f300$$ENDHEX$$n", "La fecha de resoluci$$HEX1$$f300$$ENDHEX$$n de la Incidencia no puede ser menor que la fecha de inicio del trabajo de las brigadas/contratas")
				this.setitem(il_ultima_fila_clickeada_seg,"f_alta",ldt_f_nula)
				ib_retorno_segumiento= true
				Return 
			END IF
			// Fin. Sgo.
	
		END IF
		
				
		//AHM 14/05/2009. Incidencia 0/100080843
		//tabpage_otros.dw_otros.acceptText()	TDA MEJORA
		

			// GNU 22-11-2005. Mejora 1/353424
		long ll_agente
		ll_agente=tabpage_otros.dw_otros.getitemnumber(1,'agente')
			if  fg_verifica_parametro ('SELEC_AGENTE') and &
	  			(ll_agente = 0 or isnull(ll_agente)) then
				messagebox("Atenci$$HEX1$$f300$$ENDHEX$$n", "Seleccione campo agente")
				this.setitem(il_ultima_fila_clickeada_seg,"f_alta",ldt_f_nula)
				ib_retorno_segumiento= true
				return
			END IF // FIN GNU
				
		// GNU 30-10-2006- Mejora EPSA
		if fg_verifica_parametro("indisponibilidades activas") then
			if tabpage_indisponibilidades.dw_lista_indisponibilidades.find("isnull(f_reposicion_origen)" , 1, tabpage_indisponibilidades.dw_lista_indisponibilidades.RowCount()) > 0 then
				messagebox("Atenci$$HEX1$$f300$$ENDHEX$$n", "Hay indisponibilidades abiertas")
				this.setitem(il_ultima_fila_clickeada_seg,"f_alta",ldt_f_nula)
				ib_retorno_segumiento= true
				Return 
			end if
			//AHM (09/12/2009) Validaci$$HEX1$$f300$$ENDHEX$$n de las indisponibilidades
			IF of_validarIndisponibilidad(il_nro_incidencia) = -1 THEN
				messagebox("Atenci$$HEX1$$f300$$ENDHEX$$n", "No se ha rellenado la informaci$$HEX1$$f300$$ENDHEX$$n de las indisponibilidades")
				this.setitem(il_ultima_fila_clickeada_seg,"f_alta",ldt_f_nula)
				ib_retorno_segumiento= TRUE
				Return 
			END IF
			
		END IF
		
		//AHM (02/11/2011) Integraci$$HEX1$$f300$$ENDHEX$$n OSGI - OSGM
		//AHM (18/12/2008)
		IF fg_valor_parametro("OPERACION_OCEN") = 1 OR (gb_interfaseOsgm AND ii_tipo_incid <> 2) THEN
		   //SRE 25/03/2008 Interfaz SGI-OCEN.
	
			//Verificamos que no se quiere hacer solicitudes OCEN.			

			IF gb_interfaseOsgm THEN
			
				SELECT COUNT(*) 
				INTO :ll_nro_solicitudes
				FROM "GM_SOLICITUDES"
				WHERE "COD_INCIDENCIA" =  :il_nro_incidencia;
			
				ls_mensaje = "Si continua no podr$$HEX2$$e1002000$$ENDHEX$$realizar ninguna solicitud a mantenimiento. $$HEX1$$bf00$$ENDHEX$$Desea continuar?"
			ELSE
				
				SELECT COUNT(*) 
				INTO :ll_nro_solicitudes
				FROM "GI_OCEN_OT"
				WHERE "GI_OCEN_OT"."NRO_INCIDENCIA" =  :il_nro_incidencia;
				
				ls_mensaje = "Si continua no podr$$HEX2$$e1002000$$ENDHEX$$realizar ninguna SOLICITUD OCEN. $$HEX1$$bf00$$ENDHEX$$Desea continuar?"
	
			END IF			

			
			IF (ll_nro_solicitudes = 0) AND il_ultima_fila_clickeada_seg = ii_incidencia_resuelta THEN
	
				li_Net = MessageBox("Atenci$$HEX1$$f300$$ENDHEX$$n", ls_mensaje, Question!, YesNo!, 2)
				IF li_Net = 1 THEN
					// Process OK.
				ELSE
					this.setitem(il_ultima_fila_clickeada_seg,"f_alta",ldt_f_nula)
					ib_retorno_segumiento= true
					Return 
				END IF
			END IF
	
				//Si se trat de una incidencia que viene de un descargo
				// y se trata de ocen entonces abrimos la ventana..
			IF fg_valor_parametro("OCEN")=1 THEN	
				IF (ll_nro_descargo <> 0) THEN
					ib_necesita_enviar_estados=TRUE
					//SRE openwithparm(w_7107_envio_estado_descargo_ocen,ll_nro_descargo)
				END IF
			END IF
			//Verificamos que todas las Solicitudes OCEN han sido finalizadas.
			
					
			IF NOT gb_interfaseOSGM THEN
				Long ll_nro_solicitudes_fin
		
				SELECT COUNT(*) 
				INTO :ll_nro_solicitudes_fin
				FROM "GI_OCEN_OT"
				WHERE "GI_OCEN_OT"."NRO_INCIDENCIA" =  :il_nro_incidencia AND 
						"GI_OCEN_OT"."FECHA_FIN" IS NULL;
		
				IF ll_nro_solicitudes_fin > 0 THEN
					MessageBox("Atenci$$HEX1$$f300$$ENDHEX$$n","Ocen debe cerrar o cancelar la solicitud abierta",Exclamation!, Ok!, 1)
					this.setitem(il_ultima_fila_clickeada_seg,"f_alta",ldt_f_nula)
					ib_retorno_segumiento= true
					Return 
				END IF
			END IF
			
		END IF
		
		// Se comprueba que la fecha de finalizaci$$HEX1$$f300$$ENDHEX$$n de la incidencia sea superior a la fecha 
		// de finalizaci$$HEX1$$f300$$ENDHEX$$n del trabajo de las brigadas/contratas
		IF tabpage_ot.d_lista_brigadas_ot.Find("f_hasta > datetime('" + string(ldt_fecha_ingresada) + "')", 0, tabpage_ot.d_lista_brigadas_ot.RowCount()) > 0 THEN
			MessageBox("Atenci$$HEX1$$f300$$ENDHEX$$n", "La fecha de resoluci$$HEX1$$f300$$ENDHEX$$n de la Incidencia no puede ser menor que la fecha de finalizaci$$HEX1$$f300$$ENDHEX$$n del trabajo de las brigadas/contratas")
			this.setitem(il_ultima_fila_clickeada_seg,"f_alta",ldt_f_nula)
			ib_retorno_segumiento= true
			Return 
		END IF
		
		// GNU 5-6-2007. Mejora 1/465490
		ls_duracion='0'
		SELECT VALOR
		INTO :ls_duracion 
		FROM SGD_VALOR
		WHERE CODIF='INCD';
		IF long (ls_duracion)> 0 and &
			fg_duracion_horas(idt_fec_deteccion, ldt_fecha_ingresada)>= long (ls_duracion) THEN

				MessageBox("Informaci$$HEX1$$f300$$ENDHEX$$n", "La incidencia tiene una duraci$$HEX1$$f300$$ENDHEX$$n mayor de " + ls_duracion + " horas")
		END IF	
		// FIN GNU
		
		If ib_mensaje_resuelta= false then 
			// Si paso las validaciones, pido confirmacion de la resolucion
			IF il_ultima_fila_clickeada_seg = ii_incidencia_resuelta then 
				// GNU 8-2-2006. Incidencia pruebas Integradas Nicaragua
				if ib_mensaje_resuelta= false then
					li_respuesta = gnv_msg.f_mensaje("CI11","","",YesNo!)
					ib_mensaje_resuelta= true
				end if
				Yield()
				//FIN GNU
			else
				
					SELECT COUNT(*)
					INTO :ll_nro_trabajos
					FROM SGD_TRABAJOS_BDI
					WHERE NRO_DESCARGO = :ll_nro_descargo;
					
					if ll_nro_trabajos > 0 then
						li_respuesta = messagebox("Informaci$$HEX1$$f300$$ENDHEX$$n","La incidencia pasar$$HEX2$$e1002000$$ENDHEX$$a estado Pendiente Puesta en Explotaci$$HEX1$$f300$$ENDHEX$$n. A partir de este momento no se podr$$HEX1$$e100$$ENDHEX$$n modificar los datos de la misma. Para asegurar esto se cerrar$$HEX2$$e1002000$$ENDHEX$$la incidencia.",information!,YesNo!)
					else
						messagebox("Informaci$$HEX1$$f300$$ENDHEX$$n","Los trabajos han sido aprobados durante la gesti$$HEX1$$f300$$ENDHEX$$n de esta incidencia. El estado 'PE' desaparece quedando pendiente la resoluci$$HEX1$$f300$$ENDHEX$$n de la incidencia.",information!,ok!)
						ii_eliminar_pe = 1
						of_iniciar_estados_oper()
						fnu_obte_estados_oper()
						li_respuesta = 0
	
					end if
					
			end if

			IF li_respuesta = 1 THEN
				// Se comprueba si hay operaciones que todas las maniobras se encuentren cerradas
	//			IF iw_contenedora.fw_incidencia_de_operaciones() THEN
	//				IF of_comprobar_cierre_maniobras() = FALSE THEN
	//					this.setitem(il_ultima_fila_clickeada_seg,"f_alta",ldt_f_nula)
	//					ib_retorno_segumiento= true
	//					Return
	//				END IF
	//			END IF
	// COMENTADO FDO
	
				//Evaluacion de SGM
				if gb_mantenimiento = true then
					iw_contenedora.ib_resuelta = true
				end if
				
				//pone fecha de fin a la ot a las brigadas etc.. 
				if iw_contenedora.tab_1.fnu_comprueba_fin_ot(ldt_fecha_ingresada)= -1 then
					this.setitem(il_ultima_fila_clickeada_seg,"f_alta",ldt_f_nula)
					ib_retorno_segumiento= true
					return
				end if
				
				IF li_ind_act_grafica = 1 AND ii_estado_oper = fgci_incidencia_pte_explotacion THEN
					
					SELECT COUNT(*)
					INTO :ll_nro_trabajos
					FROM SGD_TRABAJOS_BDI
	
					WHERE NRO_DESCARGO = :ll_nro_descargo AND 
							ESTADO_TRABAJO <> :fgci_trabajo_pto_servicio;
					
					IF SQLCA.SQLCode = 0 AND ll_nro_trabajos <> 0 THEN
						Messagebox("Atenci$$HEX1$$f300$$ENDHEX$$n", "No se puede resolver la Incidencia debido a que no todos los trabajos de BDI ~r~nasociados al Descargo est$$HEX1$$e100$$ENDHEX$$n Puestos en Servicio.")
						this.setitem(il_ultima_fila_clickeada_seg,"f_alta",ldt_f_nula)
						ib_retorno_segumiento= true
						return
					END IF
				END IF
				
				// Actualizo el estado de la incidencia, el formulario, las fechas
				IF li_ind_Act_grafica =0 or ll_nro_trabajos = 0 then
					ii_estado_oper = fgci_incidencia_resuelta
					idt_fecha_resuelta = ldt_fecha_ingresada
				else
					IF ii_estado_oper = fgci_incidencia_pte_explotacion THEN
						ii_estado_oper = fgci_incidencia_resuelta
						idt_fecha_resuelta = ldt_fecha_ingresada
					ELSEIF ii_estado_oper <> fgci_incidencia_resuelta THEN
						ii_estado_oper =  fgci_incidencia_pte_explotacion
						idt_fecha_pt_pex = ldt_fecha_ingresada
					END IF
				end if
	
				idt_fecha_resuelta = ldt_fecha_ingresada
				iw_contenedora.tab_1.tabpage_formulario.d_inf_general.SetItem(1,"estado_actual",ii_estado_oper)
				iw_contenedora.tab_1.tabpage_formulario.d_inf_general.SetItem(1,"fec_resolucion",ldt_fecha_ingresada)
				
				// Deshabilito el formulario
				//iw_contenedora.tab_1.tabpage_formulario.d_inf_general.Enabled = False
				
				// Cambio la presentacion del formulario
				iw_contenedora.tab_1.tabpage_formulario.d_inf_general.modify("desc.background.color="+gs_gris)
				// Le pongo fecha de fin a todas las brigadas que no la tenian
				fnu_finalizar_ot(ldt_fecha_ingresada)
				

				
				// SGT - Interfase con el SGT, en el siguiente paso se analizar$$HEX1$$e100$$ENDHEX$$
				// si el sistema ha sido instalado con el SGT, en tal caso se 
				// actualizar$$HEX2$$e1002000$$ENDHEX$$la tabla SGD_OBRAS, con los datos de la incidencia
	
				if gb_sgt then
					
					long ll_max_obra,ll_prov
					string ls_descripcion,ls_max_obra
						ls_descripcion= tabpage_formulario.d_inf_general.getitemstring(1,"desc")
					datetime ld_fecha_hoy
						ld_fecha_hoy=fgnu_fecha_actual()
					datetime ld_fecha_detect
						ld_fecha_detect=tabpage_formulario.d_inf_general.getitemdatetime(1,"f_deteccion")
					string ls_prov,ls_calle,ls_dupli   
					long ll_puerta
					
			  SELECT "CALLEJERO"."COD_PROV",   
						"CALLEJERO"."NOM_CALLE",   
						"SGD_INSTALACION"."NUM_PUERTA",   
						"SGD_INSTALACION"."DUPLICADOR"  
				INTO :ll_prov,   
					  :ls_calle,   
					  :ll_puerta,   
					  :ls_dupli  
				FROM "SGD_INSTALACION",   
					  "CALLEJERO"  
				WHERE ( "SGD_INSTALACION"."NRO_INSTALACION" = :idec_nro_instalacion_afectada ) AND 
						( "SGD_INSTALACION"."BDI_JOB" = 0 ) AND //DBE 11/01/2000
						( "CALLEJERO"."COD_CALLE" = "SGD_INSTALACION"."COD_CALLE" );
	
				ls_prov=string(ll_prov)
				
					SELECT max("SGD_OBRAS"."COD_OBRA")  
					 INTO :ll_max_obra  
					 FROM "SGD_OBRAS"  ;
					
					
					if isnull(ll_max_obra) then 
						ll_max_obra=1
					else
						ll_max_obra++
					end if
					
					ls_max_obra=string(ll_max_obra)
	
					INSERT INTO "SGD_OBRAS"  
					 ( "COD_OBRA", 
						"ESTADO",   
						"DESCRIPCION",   
						"TIPO_OBRA",   
						"COD_CENTRO_PETICIONARIO",   
						"COD_CENTRO_RESPONSABLE",   
						"COD_INSTALACION",   
						"TIPO_AVERIA",   
						"FECHA_INI_REAL",   
						"FECHA_FIN_REAL",   
						"PROVINCIA",   
						"CALLE",   
						"NUM_PUERTA",   
						"DUPLICADOR",   
						"DEPARTAMENTO",   
						"MUNICIPIO",   
						"F_ALTA",   
						"USUARIO",   
						"PROGRAMA" )  
					VALUES ( :ls_max_obra,   
								'10001',   
								:ls_descripcion,   
								'01300',   
								1,   
								1,   
								:idec_nro_instalacion_afectada,   
								null,   
								:ld_fecha_detect,   
								:ldt_fecha_ingresada,   
								:ls_prov,   
								:ls_calle,   
								:ll_puerta,   
								:ls_dupli,   
								null,   
								null,   
								:ld_fecha_hoy,   
								:gs_usuario,   
								'sgi' )  ;
				end if
				
				IF il_ultima_fila_clickeada_seg = ii_incidencia_pte_pta_explotacion then 
					parent.postevent("ue_cerrar")
				end if
				
				//LSH
				tabpage_ot.d_datos_ot.Modify("f_elim_peligro.protect=1")
				tabpage_ot.d_datos_ot.Modify("f_elim_peligro.background.color="+gs_gris)
				
			ELSE		// Si no confirmo la resolucion
				this.setitem(il_ultima_fila_clickeada_seg,"f_alta",ldt_f_nula)
				ib_retorno_segumiento= true
				This.ScrollToRow(1) 
				Parent.setfocus()
			END IF
		end if
	END IF
END IF

end event

event itemerror;call super::itemerror;return 3
end event

event losefocus;call super::losefocus;//24/10/2008  yaf


IF il_ultima_fila_clickeada_seg > 0 AND ib_inc_finalizada THEN
	ib_inc_finalizada = FALSE
	this.TriggerEvent("ue_item_changed")
END IF
end event

type d_seguimiento_mantenimiento from u_ema_2001_pr_seguimiento_mantenimiento within tabpage_seguimiento
event clicked pbm_dwnlbuttonclk
event dragdrop pbm_dwndragdrop
event itemchanged pbm_dwnitemchange
event ue_item_changed pbm_custom72
boolean visible = false
integer x = 1760
integer y = 180
integer width = 1719
integer height = 1400
integer taborder = 20
string dragicon = "ENV_OPER.ICO"
boolean border = false
end type

event clicked;//YIELD()
//il_click_mant_seg= row
//string ls_click_estado
//
//This.AcceptText()
//			//Si el click fue fuera de la las lienas de la datawindow permitada
//			// o si el la incidencia esta resuelta
//IF il_click_mant_seg = 0 OR &
//	ISNULL(il_click_mant_seg) OR &
//	ii_estado_oper=fgci_incidencia_resuelta OR &
//	is_accion_llamada="Consulta" THEN
//
//	Return
//END IF
//IF ISNULL(this.getitemDatetime(il_click_mant_seg,"f_alta")) THEN

//
//	Return
//END IF
//
//ls_click_estado=this.Getitemstring(il_click_mant_seg,"nomenclatura")
//
//		//si usuario mantenimiento ,NO resuelve mantenimiento 
//		//y estado es = PR y
//		//no fue derivada a operaciones
//IF	ls_click_estado=fgcs_nomenclatura_pr AND &
//	fgnu_auto_der_oper()  AND &
//	NOT chk_resolucion_mant.Checked AND &
//	NOT iw_contenedora.tab_1.fnu_env_operaciones() THEN
//
//	d_seguimiento_mantenimiento.Drag(Begin!) 
//END IF
//	
//		//si tiene el registro 2 fecha no nula y
//		// usuario operaciones y
//		// se dio click en el estado st y
//		// no se derivo a operaciones y
//		//se derivo a mantenimiento
//IF iw_contenedora.tab_1.fnu_fecha_solo_en_st() AND &
//	fgnu_auto_der_mant() AND &
//	ls_click_estado=fgcs_nomenclatura_st AND &
//	iw_contenedora.tab_1.fnu_devolver_env_mant(tabpage_seguimiento.d_seguimiento_operaciones) AND &
//	NOT iw_contenedora.tab_1.fnu_env_operaciones() THEN
//
//	d_seguimiento_mantenimiento.Drag(Begin!)
//END IF
//
end event

event dragdrop;//long i, ll_cant_row
//int li_est_actual,ejecutar 
//string ls_usuario_nulo
//datetime ld_f
//long pi_nro_incidencia
//datawindow objeto
//parnum1=0
//objeto = source
//DateTime ldt_fecha_derivacion
//
//IF typeof(Objeto)=DataWindow! THEN
//	IF objeto.DataObject="d_eop_2001_pr_list_seguimiento_operacion" THEN
//		IF iw_contenedora.tab_1.frn_es_anulacion(tabpage_seguimiento.d_seguimiento_operaciones,il_click_oper_seg) THEN
//			IF iw_contenedora.tab_1.frn_validar_anulacion(tabpage_seguimiento.d_seguimiento_operaciones,il_click_oper_seg) THEN
//				d_seguimiento_mantenimiento.fpr_anulacion_mant(2,il_click_mant_seg)
//				d_seguimiento_operaciones.fpr_anulacion_oper(2)
//			END IF
//		ELSE
//			IF iw_contenedora.tab_1.frn_validar_salida_oper(il_click_oper_seg) THEN
//				
//				datetime ld_fecha_deteccion, ld_fecha_resolucion
//
//				ld_fecha_deteccion = iw_contenedora.tab_1.tabpage_formulario.d_inf_general.getitemdatetime(1,"f_deteccion")
//				ld_fecha_resolucion = iw_contenedora.tab_1.tabpage_seguimiento.d_seguimiento_operaciones.getitemdatetime(ii_incidencia_servicio_repuesto,"f_alta")
//				if fg_duracion_minutos(ld_fecha_deteccion,ld_fecha_resolucion) > 3 then
//				
//					ldt_fecha_derivacion = tabpage_seguimiento.d_seguimiento_operaciones.GetItemdateTime(il_click_oper_seg,"f_alta")
//					d_seguimiento_mantenimiento.fpr_marcar_entrada_mant(ldt_fecha_derivacion)
//					d_seguimiento_operaciones.fpr_marcar_salida_oper(il_click_oper_seg)
//					//idt_fecha_st_mant = fgnu_fecha_actual()
//					idt_fecha_st_mant = ldt_fecha_derivacion
//					ii_estado_mant = fgci_incidencia_mant_sin_atender
//					ii_resuelve_mant=0
//					gi_est_mant = ii_estado_mant
//					gi_resuelve_mant = ii_resuelve_mant
//					tabpage_formulario.d_inf_general.SetItem(1,"estado_mantenimiento",ii_estado_mant)
//	//				tabpage_formulario.d_inf_general.SetItem(1,"resuelve_mant",ii_resuelve_mant)
//					SetNull(ls_usuario_nulo)
//					d_seguimiento_operaciones.SetItem(ii_incidencia_resuelta,"usuario",ls_usuario_nulo)
//					iw_contenedora.tab_1.frn_habilita_resuelve_mant()
//					d_seguimiento_operaciones.SetFocus()
//					//d_seguimiento_operaciones.object.f_alta[li_fila_estado_rs].background.color=gs_gris
//										
//				else
//					//No se ha podido derivar a mantenimiento
//					gnv_msg.f_mensaje("AI146", "", "", OK!)
//					d_seguimiento_operaciones.Drag(end!)
//				END IF					
//			END IF
//		END IF
//	ii_estado_oper = fgci_incidencia_env_mto 
//	tabpage_formulario.d_inf_general.SetItem(1,"estado_actual",ii_estado_oper)
//	ib_derivada_mante = true
//	END IF
//END IF
//
//this.Drag(End!)
//
end event

event itemchanged;//il_ultima_fila_click_mant_seg = row
//idt_fecha_ant_mant_seg = this.getitemdatetime(il_ultima_fila_click_mant_seg,"f_alta")
//this.postevent("ue_item_changed")
end event

event ue_item_changed;//long ll_contador 
//DateTime ldt_fecha_nueva
//
//this.setitem(il_ultima_fila_click_mant_seg,"f_alta", fgnu_valido_fecha_nula(this.GetItemDateTime(il_ultima_fila_click_mant_seg,"f_alta")))
//ldt_fecha_nueva = this.GetItemDateTime(il_ultima_fila_click_mant_seg,"f_alta")
//
//// SI ES UN ESTADO EN QUE LA INCIDENCIA FUE DERIVADA, LA FECHA NO PUEDE SER NULA
//
//IF This.GetItemNumber(il_ultima_fila_click_mant_seg,"ind_env_mant") = 1 THEN  
//	IF ISNULL(ldt_fecha_nueva) THEN
//		//MessageBox("Atenci$$HEX1$$f300$$ENDHEX$$n","La fecha no puede ser nula.")
//		gnv_msg.f_mensaje("AI116","","",ok!)
//		this.setitem(il_ultima_fila_click_mant_seg,"f_alta",idt_fecha_ant_mant_seg)
//		Return
//	END IF
//
//END IF
//
//IF NOT iw_contenedora.tab_1.frn_valida_fechas_de_derivacion(tabpage_seguimiento.d_seguimiento_operaciones,tabpage_seguimiento.d_seguimiento_mantenimiento) THEN
//	this.setitem(il_ultima_fila_click_mant_seg,"f_alta",idt_fecha_ant_mant_seg)
//	Return 

//END IF
//// Si estoy resolviendo, la fecha de resolucion no puede ser menor
//// que la de SR en operaciones
//IF gi_resuelve_mant = 1 AND il_ultima_fila_click_mant_seg = 5 THEN
//	IF ii_estado_oper = fgci_incidencia_servicio_repuesto THEN
//		IF ldt_fecha_nueva < idt_fecha_sr THEN
//			//messagebox("Atenci$$HEX1$$f300$$ENDHEX$$n","La fecha de Resuelta Mantenimiento no puede ser menor ~nque la fecha de Servicio Repuesto")
//			gnv_msg.f_mensaje("AI117","","",ok!)
//			This.SetItem(il_ultima_fila_click_mant_seg,"f_alta",idt_fecha_ant_mant_seg)
//			Return
//		END IF
//	END IF
//END IF
//
//
////si las fechas son correlativas actualizo el estado en mantenimiento
//ll_contador = 1
//IF iw_contenedora.tab_1.frn_v_fechas(tabpage_seguimiento.d_seguimiento_mantenimiento) THEN
//	DO WHILE Not ISNull(this.GetItemDateTime(ll_contador,"f_alta"))
//		ii_estado_mant = this.GetItemNumber(ll_contador,"est_mant")	//estado en mant
//		gi_est_mant = ii_estado_mant
//		ll_contador ++
//		if ll_contador > 5 then exit
//		
//	LOOP
//END IF
//
//IF gi_resuelve_mant = 1 AND ii_estado_mant = 5 THEN
//	ii_estado_mant = fgci_incidencia_mant_resuelta_mant
//	gi_est_mant = ii_estado_mant
//END IF
//
//
//tabpage_formulario.d_inf_general.SetItem(1,"estado_mantenimiento",ii_estado_mant)
//
//CHOOSE CASE this.GetItemNumber(il_ultima_fila_click_mant_seg,"est_mant")
//	CASE fgci_incidencia_mant_sin_atender 
//		idt_fecha_st_mant = ldt_fecha_nueva
//	CASE  fgci_incidencia_mant_enviado_brigada
//		idt_fecha_eb_mant = ldt_fecha_nueva
//	CASE  fgci_incidencia_mant_averia_localizada
//		idt_fecha_al_mant	= ldt_fecha_nueva
//	CASE  fgci_incidencia_mant_reparando
//		idt_fecha_rp_mant	= ldt_fecha_nueva
//	CASE  fgci_incidencia_mant_para_resolucion
//		idt_fecha_pr_mant	= ldt_fecha_nueva
//	CASE  fgci_incidencia_mant_resuelta_mant
//		idt_fecha_rm_mant	= ldt_fecha_nueva
//		
//END CHOOSE
//int li_respuesta
//DateTime ldt_f_nula
//SetNull(ldt_f_nula)
//// Si esta resolviendo, actualizo el formulario, el estado y las fechas
//IF gi_resuelve_mant = 1 THEN
//	IF ii_estado_oper = fgci_incidencia_servicio_repuesto THEN
//		IF ii_estado_mant = fgci_incidencia_mant_resuelta_mant THEN
//			li_respuesta = gnv_msg.f_mensaje("CI11","","",YesNo!)
//			IF li_respuesta = 1 THEN
//				// Actualizo el estado de la incidencia, el formulario, las fechas
//				ii_estado_oper = fgci_incidencia_resuelta
//				tabpage_seguimiento.d_seguimiento_operaciones.SetItem(ii_incidencia_resuelta,"f_alta",ldt_fecha_nueva)
//				iw_contenedora.tab_1.tabpage_formulario.d_inf_general.SetItem(1,"estado_actual",ii_estado_oper)
//				idt_fecha_resuelta = ldt_fecha_nueva
//				
//				// Deshabilito el formulario
//				iw_contenedora.tab_1.tabpage_formulario.d_inf_general.Enabled = False
//				
//				// Cambio la presentacion del formulario
////				iw_contenedora.tab_1.tabpage_formulario.d_inf_general.modify("material_averiado.background.color="+gs_gris)
//				iw_contenedora.tab_1.tabpage_formulario.d_inf_general.modify("f_deteccion.background.color="+gs_gris)
//				iw_contenedora.tab_1.tabpage_formulario.d_inf_general.modify("f_est_res.background.color="+gs_gris)
//				iw_contenedora.tab_1.tabpage_formulario.d_inf_general.modify("causa.background.color="+gs_gris)
//				iw_contenedora.tab_1.tabpage_formulario.d_inf_general.modify("fec_causa.background.color="+gs_gris)
//				iw_contenedora.tab_1.tabpage_formulario.d_inf_general.modify("desc.background.color="+gs_gris)
//				
//				// Le pongo fecha de fin a todas las brigadas que no la tenian
//				iw_contenedora.tab_1.f_finalizar_tareas_brigadas()
//				
//			ELSE		// Si no confirmo la resolucion
//				this.setitem(il_ultima_fila_click_mant_seg,"f_alta",ldt_f_nula)
//				
//			END IF
//		END IF
//	END IF
//		
//END IF
end event

type d_estados_operaciones from u_eop_2002_pr_lista_estados_operaciones within tabpage_seguimiento
boolean visible = false
integer x = 1970
integer y = 224
integer width = 297
integer height = 892
integer taborder = 50
boolean bringtotop = true
boolean border = false
end type

type tabpage_acciones from userobject within u_tab_2301_form_incidencias
integer x = 18
integer y = 112
integer width = 5527
integer height = 3872
long backcolor = 79741120
string text = "Acciones"
long tabtextcolor = 33554432
long tabbackcolor = 79741120
string picturename = "ArrangeTables!"
long picturemaskcolor = 553648127
st_titulo st_titulo
d_lista_acciones d_lista_acciones
d_lista_acciones_incidencia d_lista_acciones_incidencia
mle_observacion_accion_incidencia mle_observacion_accion_incidencia
end type

event clicked;//SetPointer(HourGlass!)
//md_ingreso_incidencias lm_menu
//lm_menu= iw_contenedora.menuid

//Parent.SetRedraw(False)
//
//IF This.Checked = True THEN
//
//	iu_id_instalacion.is_comunic.intval1 = gi_nro_centro
//	iu_id_instalacion.is_comunic.intval2 = gi_nro_cmd
//	iu_id_instalacion.is_comunic.intval3 = gi_nro_puesto
//
//	iu_id_instalacion.is_comunic.decval1 = fgcdec_aviso_con_alimentacion
//	iu_id_instalacion.is_comunic.decval2 = 0
//
//	iu_id_instalacion.is_comunic.intval4 = 0
//  	iu_id_instalacion.is_comunic.intval5 = 0
//	iu_id_instalacion.is_comunic.intval6 = 2				// Media Tensi$$HEX1$$f300$$ENDHEX$$n
//	iu_id_instalacion.is_comunic.strval1 = ""
//	iu_id_instalacion.is_comunic.strval2 = "Con Alimentaci$$HEX1$$f300$$ENDHEX$$n"
//	iu_id_instalacion.is_comunic.strval10 = "BlackOut"
//      
//	iu_id_instalacion.is_comunic.longval1 = 0				//il_pot_inst
//	iu_id_instalacion.is_comunic.longval2 = 0				//il_pot_contr
//	iu_id_instalacion.is_comunic.longval3 = 0				//il_cant_cli
//	iu_id_instalacion.is_comunic.longval4 = 0				//il_nro_aco
//
//	d_inf_general.SetItem(1,"nombre_ins",fgcdec_aviso_con_alimentacion)
//
//	Parent.fnu_m_accion_perfil_pactivate_ins_afect(il_ult_inc)
//
//	ii_co_nivel = 0										//iu_id_instalacion.is_comunic.intval5
//	d_inf_general.SetColumn("f_deteccion")		
//
//	d_inf_general.SetItem(1,"co_nivel",ii_co_nivel)		
//	d_inf_general.SetItem(1,"nro_centro",gi_nro_centro)
//	d_inf_general.SetItem(1,"nro_cmd",gi_nro_cmd)
//	d_inf_general.SetItem(1,"nro_mesa",gi_nro_puesto)
//	d_inf_general.modify("tipo_incidencia.protect=1")
//	d_inf_general.modify("tipo_incidencia.background.color="+gs_gris)
//
//	ib_hubo_cambios=TRUE	
//ELSEIF This.Checked = False THEN
//
//	string ls_nulo
//	decimal{0} ldec_nulo
//
//	SetNull(ls_nulo)
//	SetNull(ldec_nulo)
//
//	fgnu_resetear_s_comunicaciones(iu_id_instalacion)
//
//	d_inf_general.SetItem(1,"nombre_ins",ldec_nulo)
//	d_inf_general.SetItem(1,"nombre_instalacion",ls_nulo)
//	d_inf_general.SetItem(1,"nomb_tipo",ls_nulo)
//	d_inf_general.modify("tipo_incidencia.protect=1")
//	d_inf_general.modify("tipo_incidencia.background.color="+gs_gris)
//	iu_inc_2003_rn.frn_ini_campos_por_defecto(d_inf_general,lu_comunic)
//	iu_inc_2003_rn.fnu_ini_centros_alta(d_inf_general)
//
//	Parent.fnu_m_accion_perfil_pactivate_ins_afect(il_ult_inc)
//
//END IF
//
//frn_habilitar_opciones_menu(lu_comunic.is_comunic.accion_llamada)
//
////IF This.Checked = True THEN
////	lm_menu.m_consultar.m_instalacionafectada.Enabled = False
////ELSEIF This.Checked = True THEN
////	lm_menu.m_consultar.m_instalacionafectada.Enabled = True
////END IF
//
//fnu_resetear_var_comunicaciones()
//
//Parent.SetRedraw(True)
//
//
end event

on tabpage_acciones.create
this.st_titulo=create st_titulo
this.d_lista_acciones=create d_lista_acciones
this.d_lista_acciones_incidencia=create d_lista_acciones_incidencia
this.mle_observacion_accion_incidencia=create mle_observacion_accion_incidencia
this.Control[]={this.st_titulo,&
this.d_lista_acciones,&
this.d_lista_acciones_incidencia,&
this.mle_observacion_accion_incidencia}
end on

on tabpage_acciones.destroy
destroy(this.st_titulo)
destroy(this.d_lista_acciones)
destroy(this.d_lista_acciones_incidencia)
destroy(this.mle_observacion_accion_incidencia)
end on

type st_titulo from statictext within tabpage_acciones
integer x = 1696
integer y = 40
integer width = 1609
integer height = 92
integer textsize = -10
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long backcolor = 81324524
boolean enabled = false
string text = " Observaciones"
boolean border = true
borderstyle borderstyle = styleraised!
boolean focusrectangle = false
end type

type d_lista_acciones from u_inc_2015_pr_lista_acciones within tabpage_acciones
event clicked pbm_dwnlbuttonclk
event dragdrop pbm_dwndragdrop
event getfocus pbm_dwnsetfocus
event rowfocuschanged pbm_dwnrowchange
string tag = "0"
integer x = 105
integer y = 712
integer width = 1449
integer height = 656
integer taborder = 2
string dragicon = "RECIBO.ICO"
boolean vscrollbar = true
string icon = "None!"
borderstyle borderstyle = styleraised!
end type

event clicked;call super::clicked;IF is_accion_llamada <> "Consulta" THEN
 
	ll_row_accion_acc = row
	IF row > 0 AND row <= This.RowCount() THEN
		This.Drag(Begin!)
	END IF

END IF

end event

event dragdrop;DataWindow Objeto
 
objeto = source
IF typeof(Objeto) = DataWindow! THEN
	IF objeto.DataObject = "dw_2014_lista_acciones_incidencia" THEN
		iw_contenedora.tab_1.fnu_quitar_accion(tabpage_acciones.d_lista_acciones_incidencia,ll_row_acc_inc_acc)		
		tabpage_acciones.d_lista_acciones_incidencia.AcceptText()
		IF tabpage_acciones.d_lista_acciones_incidencia.RowCount() = 0 THEN
			tabpage_acciones.mle_observacion_accion_incidencia.text = " "
			tabpage_acciones.mle_observacion_accion_incidencia.enabled = False
		End If
		IF tabpage_acciones.d_lista_acciones_incidencia.RowCount() > 0 THEN
			ll_row_acc_inc_acc = 1
			tabpage_acciones.mle_observacion_accion_incidencia.Text = tabpage_acciones.d_lista_acciones_incidencia.GetItemString(ll_row_acc_inc_acc,"Observacion")		
		END IF
		
		st_titulo.text= " Observaciones " 
		d_lista_acciones_incidencia.Event RowFocusChanged(1)
			
	
	END IF
END IF
tabpage_acciones.d_lista_acciones_incidencia.Drag(End!)
end event

event getfocus;
//IF is_accion_llamada <> "Consulta" THEN
//	mle_observacion_accion_incidencia.enabled = False
//END IF
end event

event rowfocuschanged;call super::rowfocuschanged;this.SelectRow(0,False)
this.SelectRow(currentrow,True)


end event

type d_lista_acciones_incidencia from u_inc_2014_pr_lista_acciones_incidencia within tabpage_acciones
event clicked pbm_dwnlbuttonclk
event dragdrop pbm_dwndragdrop
event rowfocuschanged pbm_dwnrowchange
string tag = "1"
integer x = 105
integer y = 36
integer width = 1440
integer height = 632
integer taborder = 2
string dragicon = "RECIBO1.ICO"
boolean vscrollbar = true
string icon = "None!"
borderstyle borderstyle = styleraised!
end type

event clicked;int li_tipo_accion

IF row > 0 THEN
	li_tipo_accion = This.getitemnumber(row,"accion_inc_tip_accion")
	
	if  li_tipo_accion = 1 and ii_estado_oper < fgci_incidencia_resuelta AND &
		 is_accion_llamada <> "Consulta" THEN
		This.Drag(Begin!)
	end if  
END IF	

end event

event dragdrop;int li_nro_accion, li_accion_repetida, li_respuesta
string ls_descripcion_accion
datawindow objeto

objeto = source
IF typeof(Objeto) = DataWindow! THEN
	IF objeto.DataObject = "dw_2015_lista_acciones" THEN
		li_nro_accion = d_lista_acciones.GetItemNumber(ll_row_accion_acc,"cod_accion")
		li_accion_repetida = this.Find('cod_accion = ' + string(li_nro_accion), 0, this.rowcount())
		IF li_accion_repetida > 0 THEN
			li_respuesta = messagebox("Atenci$$HEX1$$f300$$ENDHEX$$n", "La acci$$HEX1$$f300$$ENDHEX$$n ya existe, $$HEX1$$bf00$$ENDHEX$$desea agregarla de nuevo?", Question!,YesNo!) 
		END IF
		IF li_accion_repetida = 0 OR li_respuesta = 1 THEN
			d_lista_acciones_incidencia.SelectRow(0,False)
			ls_descripcion_accion = d_lista_acciones.GetItemString(ll_row_accion_acc,"accion")
			ll_row_acc_inc_acc = iw_contenedora.tab_1.fnu_agregar_accion(tabpage_acciones.d_lista_acciones_incidencia,li_nro_accion,ls_descripcion_accion,il_nro_incidencia,false)
			tabpage_acciones.mle_observacion_accion_incidencia.enabled = True
			tabpage_acciones.mle_observacion_accion_incidencia.DisplayOnly = False
			tabpage_acciones.mle_observacion_accion_incidencia.backcolor = long(gs_blanco)
			tabpage_acciones.mle_observacion_accion_incidencia.text = " "
			This.SetRow(ll_row_acc_inc_acc)
			This.ScrollToRow(ll_row_acc_inc_acc)
			This.SelectRow(ll_row_acc_inc_acc,True)		
			tabpage_acciones.mle_observacion_accion_incidencia.SetFocus()
			//st_titulo.text= " Observaciones: " + this.getitemstring(ll_row_acc_inc_acc,"accion")
		END IF
	END IF
			
END IF
d_lista_acciones.Drag(End!)
end event

event rowfocuschanged;int li_tipo_accion
ll_row_acc_inc_acc=currentrow

IF currentrow > 0 AND currentrow <= This.RowCount() THEN
	li_tipo_accion = This.getitemnumber(currentrow,"accion_inc_tip_accion")

	// Cargo en el mle las observaciones
	tabpage_acciones.mle_observacion_accion_incidencia.Text = This.GetItemString(currentrow,"observacion")
	this.SelectRow(0,False)
	this.SelectRow(currentrow,True)	

ELSE
	Return
	
END IF

IF is_accion_llamada = "Consulta" THEN
	
	mle_observacion_accion_incidencia.DisplayOnly = True
	mle_observacion_accion_incidencia.backcolor = long(gs_gris)
	Return
ELSE
	IF li_tipo_accion = 1 and ii_estado_oper < fgci_incidencia_resuelta then 
		mle_observacion_accion_incidencia.DisplayOnly = False 
		mle_observacion_accion_incidencia.backcolor = long(gs_blanco)
	ELSE
		mle_observacion_accion_incidencia.DisplayOnly = True
		mle_observacion_accion_incidencia.backcolor = long(gs_gris)
	END IF 

	
END IF	


IF currentrow > 0 AND currentrow <= This.RowCount() THEN
	//st_titulo.text= " Observaciones: " + this.getitemstring(currentrow,"accion")
end if
end event

event itemchanged;call super::itemchanged;


int position

position = row
end event

type mle_observacion_accion_incidencia from multilineedit within tabpage_acciones
integer x = 1696
integer y = 128
integer width = 1609
integer height = 1228
integer taborder = 3
integer textsize = -10
integer weight = 400
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long backcolor = 16777215
boolean vscrollbar = true
integer limit = 250
end type

event losefocus;
tabpage_acciones.d_lista_acciones_incidencia.AcceptText()

IF tabpage_acciones.d_lista_acciones_incidencia.RowCount() > 0  THEN
	fnu_devolver_obs_accion(tabpage_acciones.d_lista_acciones_incidencia,tabpage_acciones.mle_observacion_accion_incidencia,ll_row_acc_inc_acc)
END IF

end event

type tabpage_maniobras from userobject within u_tab_2301_form_incidencias
integer x = 18
integer y = 112
integer width = 5527
integer height = 3872
long backcolor = 79741120
string text = "Maniobras"
long tabtextcolor = 33554432
long tabbackcolor = 79741120
string picturename = "Options!"
long picturemaskcolor = 553648127
cb_otras_man cb_otras_man
dw_maniobras dw_maniobras
end type

on tabpage_maniobras.create
this.cb_otras_man=create cb_otras_man
this.dw_maniobras=create dw_maniobras
this.Control[]={this.cb_otras_man,&
this.dw_maniobras}
end on

on tabpage_maniobras.destroy
destroy(this.cb_otras_man)
destroy(this.dw_maniobras)
end on

type cb_otras_man from commandbutton within tabpage_maniobras
boolean visible = false
integer x = 23
integer y = 1512
integer width = 791
integer height = 108
integer taborder = 12
integer textsize = -10
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "&Otras Maniobras de Cierre"
end type

event clicked;openwithparm(w_2304_maniobras_asociadas,il_nro_incidencia)
end event

type dw_maniobras from u_inc_2052_lista_maniobras within tabpage_maniobras
integer x = 23
integer y = 40
integer width = 5285
integer height = 1440
integer taborder = 12
boolean hscrollbar = true
boolean vscrollbar = true
borderstyle borderstyle = styleraised!
end type

event rowfocuschanged;call super::rowfocuschanged;//SetPointer(HourGlass!)

IF currentrow > 0 THEN
	This.SelectRow(0, FALSE)
	This.SelectRow(currentrow, TRUE)
END IF
end event

event doubleclicked;call super::doubleclicked;
//JME 28/04/09

long 		ll_cod_instalacion, ll_nro_incidencia, ll_status, ll_cod_maniobra
datetime ldt_f_alta, ldt_f_reposicion, ldt_fecha_causa
long   	ll_causa, ll_causa_original, ll_cod_causa, ll_valor
string  	ls_filtro
int 		li_auxiliar

long     ll_cod_elemento, ll_count = 0
str_atributos_maniobra_indisponibilidad lstr_atributos_maniobra 
datastore lds_atributos, lds_indisponibilidades

//md_ingreso_incidencias lm_menu
//lm_menu= iw_contenedora.menuid

SELECT VALOR
  INTO :ll_valor
  FROM SGD_PARAMETROS
 WHERE DESCRIPCION = 'IND_ATRIBUTOS_MANIOBRA';			

IF row > 0 AND ll_valor = 1 and gi_ind_tratar_disp_indisp = 1  THEN
	ll_cod_maniobra = This.GetItemNumber(row, 'cod_maniobra')
	IF This.GetItemString(row, 'nom_brig_cont') = 'Varios' THEN
		// Se abre la ventana que muestra las brigadas asociadas a una maniobra
		OpenWithParm(w_brigadas_contr_maniobra, ll_cod_maniobra)
	else
		
		ll_cod_elemento = This.GetItemNumber(row, 'cod_elemento')
		
		//AHM (15/03/2010)
//		SELECT count(*)
//		  INTO :ll_count
//		  FROM BDIV10_BAHIA_CORTE
//		 WHERE BDI_JOB = 0
//		   AND CORTE_OPEN NOT LIKE '88%'
//			AND CORTE_OPEN = :ll_cod_elemento; 

		SELECT count(*)
		INTO :ll_count
		FROM sgd_indisponibilidad
		WHERE (maniobra_apertura = :ll_cod_maniobra
				OR maniobra_cierre = :ll_cod_maniobra)
				AND class_id = 5555;
		
		
		if ll_count <> 0 then 		
			
			
			lds_atributos = create datastore
			lds_atributos.dataobject = 'd_atributos_maniobra'
			lds_atributos.SetTransobject(SQLCA) 
			lds_atributos.Retrieve(ll_cod_maniobra)		
			
			lstr_atributos_maniobra.ps_tipo_modificacion = 'MANIOBRA'
			lstr_atributos_maniobra.pl_cod_incidencia = il_nro_incidencia
			//lstr_atributos_maniobra.pl_cod_instalacion = this.object.cod_instalacion[row]
			lstr_atributos_maniobra.pl_cod_maniobra = ll_cod_maniobra
			lstr_atributos_maniobra.pds_atributos_maniobra = lds_atributos	
			
			lstr_atributos_maniobra.ps_accion_llamada = is_accion_llamada
	
			OpenWithParm(w_modificar_atributos_apertura_cierre, lstr_atributos_maniobra )
			
			lstr_atributos_maniobra = Message.PowerObjectParm
			
			if lstr_atributos_maniobra.pb_ind_modificaciones = true then
	
				li_auxiliar = lds_atributos.Update()
				fw_actualiza_indisponibilidades_maniobra(ll_cod_maniobra, lds_atributos)
				
				//fw_actualiza_otras_indisponibilidades(ll_cod_maniobra, lds_atributos)
				
			end if
			
			DESTROY lds_atributos
		
		end if

	END IF
END IF


	
	
	
end event

event buttonclicked;call super::buttonclicked;//AHM (22/04/2010) Bot$$HEX1$$f300$$ENDHEX$$n causas
long 		  	ll_cod				//C$$HEX1$$f300$$ENDHEX$$digo de la causa
long			ll_maniobra			//C$$HEX1$$f300$$ENDHEX$$digo de la maniobra
datastore  	lds_atributos		//Datos de la maniobra

setpointer(HourGlass!)

IF is_accion_llamada <> "Consulta" THEN
	
	gu_comunic2 = create u_generico_comunicaciones
	
	If fg_verifica_parametro('CAUSAS') Then
		OpenWithParm(w_2301_sel_causa_x_tipo, 1)
	Else
		Open(w_2301_sel_causa)
	End If
	
	if gu_comunic2.is_comunic.longval4 > 0 then
		
		ll_cod = gu_comunic2.is_comunic.longval4
		ll_maniobra = dw_maniobras.object.cod_maniobra[row]
		
		lds_atributos = create datastore
		lds_atributos.dataobject = 'd_atributos_maniobra'
		lds_atributos.SetTransobject(SQLCA) 
		lds_atributos.Retrieve(ll_maniobra)	
		
		dw_maniobras.object.cod_causa[row]=gu_comunic2.is_comunic.longval4
		dw_maniobras.object.causa[row]=gu_comunic2.is_comunic.strval9
//		ii_modifica_causa = 1
 		lds_atributos.setitem(1, "cod_causa", ll_cod)
		lds_atributos.Update()

		yield()
		
		destroy lds_atributos
	end if
	
	destroy gu_comunic2
	
	setpointer(HourGlass!)

ELSE
	
	MESSAGEBOX("Informaci$$HEX1$$f300$$ENDHEX$$n","Se encuentra en modo consulta.",Information!,ok!)
	
END IF
end event

type tabpage_indisponibilidades from userobject within u_tab_2301_form_incidencias
event create ( )
event destroy ( )
boolean visible = false
integer x = 18
integer y = 112
integer width = 5527
integer height = 3872
long backcolor = 81324524
string text = "Indisponibilidades"
long tabtextcolor = 33554432
long tabbackcolor = 81324524
string picturename = "indispon.bmp"
long picturemaskcolor = 536870912
cb_maniobras cb_maniobras
dw_lista_indisponibilidades_batch dw_lista_indisponibilidades_batch
em_1 em_1
st_17 st_17
st_15 st_15
st_14 st_14
st_13 st_13
st_12 st_12
st_11 st_11
st_10 st_10
st_9 st_9
st_8 st_8
st_7 st_7
st_6 st_6
st_5 st_5
p_10 p_10
p_9 p_9
p_8 p_8
p_7 p_7
p_6 p_6
p_5 p_5
p_4 p_4
p_3 p_3
p_2 p_2
p_1 p_1
dw_lista_indisponibilidades dw_lista_indisponibilidades
tv_2 tv_2
gb_1 gb_1
st_16 st_16
dw_datos_indisponibilidades dw_datos_indisponibilidades
dw_filtro_indisponibilidades dw_filtro_indisponibilidades
end type

on tabpage_indisponibilidades.create
this.cb_maniobras=create cb_maniobras
this.dw_lista_indisponibilidades_batch=create dw_lista_indisponibilidades_batch
this.em_1=create em_1
this.st_17=create st_17
this.st_15=create st_15
this.st_14=create st_14
this.st_13=create st_13
this.st_12=create st_12
this.st_11=create st_11
this.st_10=create st_10
this.st_9=create st_9
this.st_8=create st_8
this.st_7=create st_7
this.st_6=create st_6
this.st_5=create st_5
this.p_10=create p_10
this.p_9=create p_9
this.p_8=create p_8
this.p_7=create p_7
this.p_6=create p_6
this.p_5=create p_5
this.p_4=create p_4
this.p_3=create p_3
this.p_2=create p_2
this.p_1=create p_1
this.dw_lista_indisponibilidades=create dw_lista_indisponibilidades
this.tv_2=create tv_2
this.gb_1=create gb_1
this.st_16=create st_16
this.dw_datos_indisponibilidades=create dw_datos_indisponibilidades
this.dw_filtro_indisponibilidades=create dw_filtro_indisponibilidades
this.Control[]={this.cb_maniobras,&
this.dw_lista_indisponibilidades_batch,&
this.em_1,&
this.st_17,&
this.st_15,&
this.st_14,&
this.st_13,&
this.st_12,&
this.st_11,&
this.st_10,&
this.st_9,&
this.st_8,&
this.st_7,&
this.st_6,&
this.st_5,&
this.p_10,&
this.p_9,&
this.p_8,&
this.p_7,&
this.p_6,&
this.p_5,&
this.p_4,&
this.p_3,&
this.p_2,&
this.p_1,&
this.dw_lista_indisponibilidades,&
this.tv_2,&
this.gb_1,&
this.st_16,&
this.dw_datos_indisponibilidades,&
this.dw_filtro_indisponibilidades}
end on

on tabpage_indisponibilidades.destroy
destroy(this.cb_maniobras)
destroy(this.dw_lista_indisponibilidades_batch)
destroy(this.em_1)
destroy(this.st_17)
destroy(this.st_15)
destroy(this.st_14)
destroy(this.st_13)
destroy(this.st_12)
destroy(this.st_11)
destroy(this.st_10)
destroy(this.st_9)
destroy(this.st_8)
destroy(this.st_7)
destroy(this.st_6)
destroy(this.st_5)
destroy(this.p_10)
destroy(this.p_9)
destroy(this.p_8)
destroy(this.p_7)
destroy(this.p_6)
destroy(this.p_5)
destroy(this.p_4)
destroy(this.p_3)
destroy(this.p_2)
destroy(this.p_1)
destroy(this.dw_lista_indisponibilidades)
destroy(this.tv_2)
destroy(this.gb_1)
destroy(this.st_16)
destroy(this.dw_datos_indisponibilidades)
destroy(this.dw_filtro_indisponibilidades)
end on

type cb_maniobras from commandbutton within tabpage_indisponibilidades
integer x = 1522
integer y = 440
integer width = 343
integer height = 92
integer taborder = 40
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "MS Sans Serif"
string text = "Maniobras"
end type

event clicked;//AHM (04/12/2008)
datetime			ldt_fecha_nula				//Constante con valor nulo
datetime			ldt_f_alta					//Fecha de alta de la indisponibilidad
datetime			ldt_f_reposicion			//Fecha de reposici$$HEX1$$f300$$ENDHEX$$n de la indisponibilidad
long				ll_fila						//Numero de fila de la instalaci$$HEX1$$f300$$ENDHEX$$n afectada en la lista de instalaciones
long				ll_handle					//Manejador del arbol de instalaciones
treeviewitem	le_elemento					//Elemento del arbol de instalaciones
datos_arbol		lstr_datos_rama			//Datos de la rama del arbol

long 				ll_rowselected
SetNull(ldt_fecha_nula)

//JME 04/0609 Este script es err$$HEX1$$f300$$ENDHEX$$neo. S$$HEX1$$f300$$ENDHEX$$lo mira el registro 1 de dw_datos_indisponibilidades
ll_rowselected = dw_lista_indisponibilidades.getselectedrow(0)

IF not (ll_rowselected > 0) THEN
	Messagebox("Atenci$$HEX1$$f300$$ENDHEX$$n", "No hay seleccionada ninguna indisponibilidad en el listado inferior")
ELSE
	
	IF dw_datos_indisponibilidades.rowCount() > 0 THEN							//Comprueba que hay datos 
		
		//JME 14/07/2009
		//	ldt_f_reposicion=dw_datos_indisponibilidades.GetItemDatetime(ll_rowselected, 'f_reposicion')
		//	IF NOT isNull(ldt_f_reposicion) THEN
		IF IsNull(dw_datos_indisponibilidades.GetItemDatetime(ll_rowselected, 'f_reposicion')) then 
			
			dw_datos_indisponibilidades.object.f_reposicion[ll_rowselected] = idt_fec_deteccion
			dw_lista_indisponibilidades.object.f_reposicion[ll_rowselected] = idt_fec_deteccion
			
			dw_datos_indisponibilidades.AcceptText()
			dw_lista_indisponibilidades.AcceptText()
		END IF 
			
			
		ldt_f_alta=dw_datos_indisponibilidades.GetItemDateTime(ll_rowselected, "f_alta")
		ldt_f_reposicion=dw_datos_indisponibilidades.GetItemDatetime(ll_rowselected, 'f_reposicion')
		
		IF gb_operaciones = true and gb_operaciones_inst = true then
				gu_comunic2.is_comunic.longval1=0
				gu_comunic2.is_comunic.datval2=ldt_f_reposicion
				OPEN (w_listado_maniobras)
				IF NOT (gu_comunic2.is_comunic.longval1 > 0) THEN
					Messagebox("Atenci$$HEX1$$f300$$ENDHEX$$n", "No se ha seleccionado una maniobra de cierre")
					dw_datos_indisponibilidades.SetItem(ll_rowselected, "f_reposicion", ldt_fecha_nula)	
					Return 2
				ELSE
					ldt_f_reposicion=gu_comunic2.is_comunic.datval2
				END IF
		END IF
		
		If Not IsNull (ldt_f_reposicion) THEN
		
			if ldt_f_reposicion< idt_fec_deteccion then
				MessageBox("Atenci$$HEX1$$f300$$ENDHEX$$n", "La Fecha de Reposici$$HEX1$$f300$$ENDHEX$$n de la Indisponibilidad no puede ser menor que la fecha de alta de la Incidencia")
				dw_datos_indisponibilidades.SetItem(ll_rowselected, "f_reposicion", ldt_fecha_nula)
				Return 2
			end if
		
			if ldt_f_reposicion < ldt_f_alta then
				MessageBox("Atenci$$HEX1$$f300$$ENDHEX$$n", "La Fecha de Reposici$$HEX1$$f300$$ENDHEX$$n de la Indisponibilidad no puede ser menor que la Fecha de Alta de la misma")
				dw_datos_indisponibilidades.SetItem(ll_rowselected, "f_reposicion", ldt_fecha_nula)
				Return 2
			end if
		
			if ldt_f_reposicion > fgnu_fecha_actual() then
				gnv_msg.f_mensaje("AI110","","",ok!)
				dw_datos_indisponibilidades.SetItem(ll_rowselected, "f_reposicion", ldt_fecha_nula)
				Return 2
			end if
			
			if ldt_f_reposicion >= ldt_f_alta then
				
				dw_datos_indisponibilidades.SetItem(ll_rowselected, "f_reposicion",  ldt_f_reposicion)
				dw_datos_indisponibilidades.Modify("f_alta.Protect= '1'")
				dw_datos_indisponibilidades.Modify("f_alta.Background.Color= '" + gs_gris + "'")
				//JME 08/05/09
				//dw_datos_indisponibilidades.Modify("f_reposicion.Protect= '1'")
				//dw_datos_indisponibilidades.Modify("f_reposicion.Background.Color= '" + gs_gris + "'")
				
				//ll_handle = tv_2.FINDITEM(CurrentTreeItem! ,0)
				//tv_2.GETITEM(ll_handle,le_elemento)
				//lstr_datos_rama = le_elemento.data
				//ll_fila=tabpage_indisponibilidades.dw_lista_indisponibilidades.find("nro_instalacion= " + string(lstr_datos_rama.ll_codigo),1,tabpage_indisponibilidades.dw_lista_indisponibilidades.RowCount())
				
				ll_fila=tabpage_indisponibilidades.dw_lista_indisponibilidades.find("nro_instalacion= " + string(il_nro_inst_indisponibilidad),1,tabpage_indisponibilidades.dw_lista_indisponibilidades.RowCount())			
				//Fin JME
				IF gu_comunic2.is_comunic.longval1 > 0 then
					dw_datos_indisponibilidades.SetItem(ll_rowselected,"t_mcierre",gu_comunic2.is_comunic.longval1)
					tabpage_indisponibilidades.dw_lista_indisponibilidades.SetItem(ll_rowselected,'maniobra_cierre', gu_comunic2.is_comunic.longval1)
					tabpage_indisponibilidades.dw_lista_indisponibilidades.SetItem(ll_rowselected,'f_reposicion', ldt_f_reposicion)
				END IF
			end if
		end if
	//	ELSE
	//		messageBox("Aviso", "La fecha de reposici$$HEX1$$f300$$ENDHEX$$n no puede estar vacia")
	//	END IF
	END IF
END IF	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	////AHM (04/12/2008)
	//datetime			ldt_fecha_nula				//Constante con valor nulo
	//datetime			ldt_f_alta					//Fecha de alta de la indisponibilidad
	//datetime			ldt_f_reposicion			//Fecha de reposici$$HEX1$$f300$$ENDHEX$$n de la indisponibilidad
	//long				ll_fila						//Numero de fila de la instalaci$$HEX1$$f300$$ENDHEX$$n afectada en la lista de instalaciones
	//long				ll_handle					//Manejador del arbol de instalaciones
	//treeviewitem	le_elemento					//Elemento del arbol de instalaciones
	//datos_arbol		lstr_datos_rama			//Datos de la rama del arbol
	//
	//SetNull(ldt_fecha_nula)
	//
	//IF dw_datos_indisponibilidades.rowCount() > 0 THEN							//Comprueba que hay datos 
	//	ldt_f_reposicion=dw_datos_indisponibilidades.GetItemDatetime(1, 'f_reposicion')
	//	IF NOT isNull(ldt_f_reposicion) THEN
	//		ldt_f_alta=dw_datos_indisponibilidades.GetItemDateTime(1, "f_alta")
	//		
	//		
	//		IF gb_operaciones = true and gb_operaciones_inst = true then
	//				gu_comunic2.is_comunic.longval1=0
	//				gu_comunic2.is_comunic.datval2=ldt_f_reposicion
	//				OPEN (w_listado_maniobras)
	//				IF NOT (gu_comunic2.is_comunic.longval1 > 0) THEN
	//					Messagebox("Atenci$$HEX1$$f300$$ENDHEX$$n", "No se ha seleccionado una maniobra de cierre")
	//					dw_datos_indisponibilidades.SetItem(1, "f_reposicion", ldt_fecha_nula)	
	//					Return 2
	//				ELSE
	//					ldt_f_reposicion=gu_comunic2.is_comunic.datval2
	//				END IF
	//		END IF
	//		
	//		If Not IsNull (ldt_f_reposicion) THEN
	//		
	//			if ldt_f_reposicion< idt_fec_deteccion then
	//				MessageBox("Atenci$$HEX1$$f300$$ENDHEX$$n", "La Fecha de Reposici$$HEX1$$f300$$ENDHEX$$n de la Indisponibilidad no puede ser menor que la fecha de alta de la Incidencia")
	//				dw_datos_indisponibilidades.SetItem(1, "f_reposicion", ldt_fecha_nula)
	//				Return 2
	//			end if
	//		
	//			if ldt_f_reposicion < ldt_f_alta then
	//				MessageBox("Atenci$$HEX1$$f300$$ENDHEX$$n", "La Fecha de Reposici$$HEX1$$f300$$ENDHEX$$n de la Indisponibilidad no puede ser menor que la Fecha de Alta de la misma")
	//				dw_datos_indisponibilidades.SetItem(1, "f_reposicion", ldt_fecha_nula)
	//				Return 2
	//			end if
	//		
	//			if ldt_f_reposicion > fgnu_fecha_actual() then
	//				gnv_msg.f_mensaje("AI110","","",ok!)
	//				dw_datos_indisponibilidades.SetItem(1, "f_reposicion", ldt_fecha_nula)
	//				Return 2
	//			end if
	//			
	//			if ldt_f_reposicion >= ldt_f_alta then
	//				
	//				dw_datos_indisponibilidades.SetItem(1, "f_reposicion",  ldt_f_reposicion)
	//				dw_datos_indisponibilidades.Modify("f_alta.Protect= '1'")
	//				dw_datos_indisponibilidades.Modify("f_alta.Background.Color= '" + gs_gris + "'")
	//				//JME 08/05/09
	//				//dw_datos_indisponibilidades.Modify("f_reposicion.Protect= '1'")
	//				//dw_datos_indisponibilidades.Modify("f_reposicion.Background.Color= '" + gs_gris + "'")
	//				
	//				//ll_handle = tv_2.FINDITEM(CurrentTreeItem! ,0)
	//				//tv_2.GETITEM(ll_handle,le_elemento)
	//				//lstr_datos_rama = le_elemento.data
	//				//ll_fila=tabpage_indisponibilidades.dw_lista_indisponibilidades.find("nro_instalacion= " + string(lstr_datos_rama.ll_codigo),1,tabpage_indisponibilidades.dw_lista_indisponibilidades.RowCount())
	//				
	//				ll_fila=tabpage_indisponibilidades.dw_lista_indisponibilidades.find("nro_instalacion= " + string(il_nro_inst_indisponibilidad),1,tabpage_indisponibilidades.dw_lista_indisponibilidades.RowCount())			
	//				//Fin JME
	//				IF gu_comunic2.is_comunic.longval1 > 0 then
	//					dw_datos_indisponibilidades.SetItem(1,"t_mcierre",gu_comunic2.is_comunic.longval1)
	//					tabpage_indisponibilidades.dw_lista_indisponibilidades.SetItem(ll_fila,'maniobra_cierre', gu_comunic2.is_comunic.longval1)
	//					tabpage_indisponibilidades.dw_lista_indisponibilidades.SetItem(ll_fila,'f_reposicion', ldt_f_reposicion)
	//				END IF
	//			end if
	//		end if
	//	ELSE
	//		messageBox("Aviso", "La fecha de reposici$$HEX1$$f300$$ENDHEX$$n no puede estar vacia")
	//	END IF
	//END IF
	//
	//
end event

type dw_lista_indisponibilidades_batch from datawindow within tabpage_indisponibilidades
boolean visible = false
integer x = 2171
integer y = 728
integer width = 686
integer height = 400
integer taborder = 31
string title = "none"
string dataobject = "d_lista_indisponibilidades"
boolean livescroll = true
borderstyle borderstyle = stylelowered!
end type

type em_1 from editmask within tabpage_indisponibilidades
integer x = 2578
integer y = 656
integer width = 448
integer height = 80
integer taborder = 21
integer textsize = -10
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "MS Sans Serif"
long textcolor = 33554432
boolean enabled = false
string text = "none"
borderstyle borderstyle = stylelowered!
maskdatatype maskdatatype = decimalmask!
string mask = "###"
end type

event modified;il_ENR=long(em_1.text)

end event

type st_17 from statictext within tabpage_indisponibilidades
integer x = 2395
integer y = 656
integer width = 183
integer height = 76
integer textsize = -10
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "MS Sans Serif"
long textcolor = 33554432
long backcolor = 67108864
boolean enabled = false
string text = "ENR:"
boolean focusrectangle = false
end type

type st_15 from statictext within tabpage_indisponibilidades
integer x = 1399
integer y = 8
integer width = 2011
integer height = 72
integer textsize = -10
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "MS Sans Serif"
long textcolor = 33554432
long backcolor = 67108864
string text = "Indisponibilidad en "
boolean border = true
borderstyle borderstyle = styleraised!
boolean focusrectangle = false
end type

type st_14 from statictext within tabpage_indisponibilidades
integer x = 1847
integer y = 712
integer width = 325
integer height = 52
integer textsize = -7
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 33554432
long backcolor = 67108864
string text = "Int. cabecera AT"
boolean focusrectangle = false
end type

type st_13 from statictext within tabpage_indisponibilidades
integer x = 1079
integer y = 632
integer width = 229
integer height = 64
integer textsize = -7
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 33554432
long backcolor = 67108864
string text = "Banco AT"
boolean focusrectangle = false
end type

type st_12 from statictext within tabpage_indisponibilidades
integer x = 1042
integer y = 708
integer width = 347
integer height = 56
integer textsize = -7
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 33554432
long backcolor = 67108864
string text = "Transformador AT"
boolean focusrectangle = false
end type

type st_11 from statictext within tabpage_indisponibilidades
integer x = 567
integer y = 712
integer width = 379
integer height = 52
integer textsize = -7
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 33554432
long backcolor = 67108864
string text = "Transformador Pot."
boolean focusrectangle = false
end type

type st_10 from statictext within tabpage_indisponibilidades
integer x = 1847
integer y = 636
integer width = 302
integer height = 56
integer textsize = -7
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 33554432
long backcolor = 67108864
string text = "Interruptor AT"
boolean focusrectangle = false
end type

type st_9 from statictext within tabpage_indisponibilidades
integer x = 1518
integer y = 708
integer width = 197
integer height = 56
integer textsize = -7
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 33554432
long backcolor = 67108864
string text = "Celda AT"
boolean focusrectangle = false
end type

type st_8 from statictext within tabpage_indisponibilidades
integer x = 1518
integer y = 636
integer width = 187
integer height = 56
integer textsize = -7
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 33554432
long backcolor = 67108864
string text = "Barra AT"
boolean focusrectangle = false
end type

type st_7 from statictext within tabpage_indisponibilidades
integer x = 567
integer y = 636
integer width = 219
integer height = 56
integer textsize = -7
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 33554432
long backcolor = 67108864
string text = "Parque AT"
boolean focusrectangle = false
end type

type st_6 from statictext within tabpage_indisponibilidades
integer x = 128
integer y = 708
integer width = 297
integer height = 56
integer textsize = -7
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 33554432
long backcolor = 67108864
string text = "L$$HEX1$$ed00$$ENDHEX$$nea AT"
boolean focusrectangle = false
end type

type st_5 from statictext within tabpage_indisponibilidades
integer x = 128
integer y = 636
integer width = 297
integer height = 56
integer textsize = -7
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 33554432
long backcolor = 67108864
string text = "Subestaci$$HEX1$$f300$$ENDHEX$$n AT"
boolean focusrectangle = false
end type

type p_10 from picture within tabpage_indisponibilidades
integer x = 1774
integer y = 704
integer width = 73
integer height = 64
boolean originalsize = true
string picturename = ".\recursos\int_cabecera_at.bmp"
boolean focusrectangle = false
end type

type p_9 from picture within tabpage_indisponibilidades
integer x = 969
integer y = 632
integer width = 73
integer height = 64
boolean originalsize = true
string picturename = "banco_at.bmp"
boolean focusrectangle = false
end type

type p_8 from picture within tabpage_indisponibilidades
integer x = 969
integer y = 704
integer width = 73
integer height = 64
boolean originalsize = true
string picturename = "TRANSFOR_AT.bmp"
boolean focusrectangle = false
end type

type p_7 from picture within tabpage_indisponibilidades
integer x = 494
integer y = 704
integer width = 73
integer height = 64
boolean originalsize = true
string picturename = "TRANSFOR_POT.bmp"
boolean focusrectangle = false
end type

type p_6 from picture within tabpage_indisponibilidades
integer x = 1774
integer y = 632
integer width = 73
integer height = 64
boolean originalsize = true
string picturename = "manual.bmp"
boolean focusrectangle = false
end type

type p_5 from picture within tabpage_indisponibilidades
integer x = 1445
integer y = 704
integer width = 73
integer height = 64
boolean originalsize = true
string picturename = "celda_at.bmp"
boolean focusrectangle = false
end type

type p_4 from picture within tabpage_indisponibilidades
integer x = 1445
integer y = 632
integer width = 73
integer height = 64
boolean originalsize = true
string picturename = ".\recursos\barra_at.bmp"
boolean focusrectangle = false
end type

type p_3 from picture within tabpage_indisponibilidades
integer x = 494
integer y = 632
integer width = 73
integer height = 64
boolean originalsize = true
string picturename = ".\recursos\parque_at.bmp"
boolean focusrectangle = false
end type

type p_2 from picture within tabpage_indisponibilidades
integer x = 55
integer y = 704
integer width = 73
integer height = 64
boolean originalsize = true
string picturename = ".\recursos\salat.bmp"
boolean focusrectangle = false
end type

type p_1 from picture within tabpage_indisponibilidades
integer x = 55
integer y = 632
integer width = 73
integer height = 64
boolean originalsize = true
string picturename = ".\recursos\subestaca.bmp"
boolean focusrectangle = false
end type

type dw_lista_indisponibilidades from u_gen_0000_lista within tabpage_indisponibilidades
integer x = 18
integer y = 784
integer width = 3401
integer height = 864
integer taborder = 20
string dataobject = "d_lista_indisponibilidades"
boolean hscrollbar = true
boolean vscrollbar = true
end type

event itemchanged;call super::itemchanged;
// FDO - Detecta modificaciones en el tipo de indisponibilidad o en la fecha de cierre de las indisponibilidades.
// Es necesario validar esta fecha.
//
//this.accepttext()

//CHOOSE CASE dwo.name
//	case f_reposicion
//		if f_reposici$$HEX1$$f300$$ENDHEX$$n
//	case ind_comercial
		// Si modifica la Indisponibilidad Comercial

//END CHOOSE

end event

event buttonclicked;call super::buttonclicked;int li_fila
int li_manual

IF is_accion_llamada <> "Consulta" THEN
	
	IF (ii_estado_oper > fgci_incidencia_pendiente and ii_estado_oper <= fgci_incidencia_servicio_repuesto) or (ii_estado_oper = fgci_incidencia_pendiente and ib_ind_scada) then

		gu_comunic2.is_comunic.datval1= this.object.f_alta[row]
		
		li_manual= this.object.sgd_indisponibilidad_manual[row]
		
		if (this.object.modificado[row] = '0' or this.object.modificado[row] = '2') and li_manual = 1 then
			OPEN(w_listado_maniobras)
		elseif this.object.modificado[row] = '1' and li_manual = 1 then
			messagebox("Informaci$$HEX1$$f300$$ENDHEX$$n","La Fecha de Reposici$$HEX1$$f300$$ENDHEX$$n debe ser nula.",information!,okcancel!)
		end if
		
		if gu_comunic2.is_comunic.programa_llamante = "w_listado_maniobras" then
			
			this.object.f_reposicion[row] = gu_comunic2.is_comunic.datval2
			this.object.maniobra_cierre[row] = gu_comunic2.is_comunic.longval1
			this.object.modificado[row] = "2"	
			
			do while this.GetSelectedRow(0) > 0	
				li_fila = this.GetSelectedRow(0)
				this.object.f_reposicion[li_fila] = gu_comunic2.is_comunic.datval2
				this.object.maniobra_cierre[li_fila] = gu_comunic2.is_comunic.longval1
				this.object.modificado[li_fila] = "2"
				this.selectRow(li_fila, false);
			loop
			
		end if
		
		fgnu_resetear_s_comunicaciones(gu_comunic2)
	
	end if
	
end if
end event

event clicked;int li_fila
long ll_contador
long ll_nro_instalacion

li_fila =Row

if row > 0 then
	if dwo.name <> "cb_fechas" then
			
		if this.getselectedrow(li_fila - 1) = li_fila then
			this.selectrow(li_fila,false)
		else
			
				This.SelectRow(0, False)

				This.SelectRow(li_fila, True)
				This.SetRow(li_fila)
				this.scrolltorow(li_fila)
				
				// GNU 20-8-2007. Mejora EPSA indisponibilidades operaci$$HEX1$$f300$$ENDHEX$$n
				ll_nro_instalacion= This.getItemNumber(li_fila, 'nro_instalacion')
				
				//JME 08/05/09
				il_nro_inst_indisponibilidad = ll_nro_instalacion
				il_row_datos_indisponibilidad = li_fila
				//Fin JME
				
//				tv_2.deleteitem(0)
				of_cargar_indisponibilidad(ll_nro_instalacion)
//			end if
		end if
		
		ii_fila_clickeada = li_fila
		
	end if
end if
end event

event ue_key_down;call super::ue_key_down;long ll_fila_actual, ll_fila_ultima, ll_nro_instalacion

ll_fila_actual = this.getrow()
ll_fila_ultima = this.rowcount()

this.setredraw(false)

IF KeyDown(KeyDownArrow!) AND KeyDown(KeyShift!) THEN
	setpointer(Hourglass!)
	if ll_fila_actual < ll_fila_ultima then
		if this.isselected(ll_fila_actual + 1) =true then
			This.SelectRow(ll_fila_actual, False)
		else
			This.SelectRow(ll_fila_actual + 1, True)
		end if
	end if
	this.setrow(ll_fila_actual)
end if


IF KeyDown(KeyUpArrow!) AND KeyDown(KeyShift!) THEN
	setpointer(HourGlass!)
	if ll_fila_actual > 1 then
		if this.isselected(ll_fila_actual - 1) =true then
			This.SelectRow(ll_fila_actual, False)
		else
			This.SelectRow(ll_fila_actual - 1, True)
		end if
	end if
	this.setrow(ll_fila_actual)
end if


IF KeyDown(KeyEnd!) AND KeyDown(KeyShift!) THEN
	setpointer(HourGlass!)
	this.setredraw(false)
	if ll_fila_actual < ll_fila_ultima then
			FOR ll_fila_actual=ll_fila_actual TO ll_fila_ultima + 1 step 1
				This.SelectRow(ll_fila_actual, True)
			NEXT
			ll_fila_actual = ll_fila_ultima
	end if
	this.setrow(ll_fila_actual)
end if


IF KeyDown(KeyHome!) AND KeyDown(KeyShift!) THEN
	setpointer(HourGlass!)
	this.setredraw(false)
	if ll_fila_actual > 1 then
			FOR ll_fila_actual=ll_fila_actual TO 1 step -1
				This.SelectRow(ll_fila_actual, True)
			NEXT
			ll_fila_actual = 1
	end if
	this.setrow(ll_fila_actual)
end if

//ii_clicked_row=ll_fila_actual

//JME 04/06/09
ll_nro_instalacion= This.getItemNumber(ll_fila_actual, 'nro_instalacion')	
il_nro_inst_indisponibilidad = ll_nro_instalacion
il_row_datos_indisponibilidad = ll_fila_actual

of_cargar_indisponibilidad(ll_nro_instalacion)
//Fin JME

this.setredraw(true)
setpointer(Arrow!)
end event

event doubleclicked;call super::doubleclicked;
long ll_nro_instalacion, ll_count, ll_ind_tratar_atributos = 1
str_atributos_maniobra_indisponibilidad lstr_atributos_maniobra
	 
IF row > 0  and gi_ind_tratar_disp_indisp = 1  THEN
	
	if ll_ind_tratar_atributos = 1 then 	
	
		lstr_atributos_maniobra.ps_tipo_modificacion = 'INDISPONIBILIDAD'
		lstr_atributos_maniobra.pl_cod_incidencia = il_nro_incidencia
		lstr_atributos_maniobra.pl_cod_instalacion = this.object.nro_instalacion[row]
		lstr_atributos_maniobra.pdw_indisponibilidad = dw_datos_indisponibilidades
		lstr_atributos_maniobra.pl_row = row
		lstr_atributos_maniobra.ps_accion_llamada = is_accion_llamada
		
		ll_nro_instalacion = this.object.nro_instalacion[row]
		
		SELECT count(*) 
		  INTO :ll_count 
		  FROM SGD_INSTALACION_AT
		 WHERE TIPO_ACTIVO <> 0
			AND NRO_INSTALACION = :ll_nro_instalacion ; 
		
	 
		IF (ll_count >= 1) THEN
			
			OpenWithParm(w_modificar_atributos_apertura_cierre, lstr_atributos_maniobra )
			
			lstr_atributos_maniobra = Message.PowerObjectParm
			
			em_1.text = string( lstr_atributos_maniobra.pl_enr)
			il_enr = lstr_atributos_maniobra.pl_enr
			
			//Para pruebas
			long ll_cod_causa
			ll_cod_causa = dw_datos_indisponibilidades.object.cod_causa[row]
		end if 					
	end if 
end if
end event

type tv_2 from uo_man_instalac within tabpage_indisponibilidades
integer x = 14
integer y = 48
integer width = 1353
integer height = 544
integer taborder = 30
string dragicon = ""
boolean bringtotop = true
integer textsize = -8
integer weight = 0
fontcharset fontcharset = ansi!
fontpitch fontpitch = default!
fontfamily fontfamily = anyfont!
string facename = "MS Sans Serif"
long textcolor = 33554432
long backcolor = 67108864
boolean border = true
borderstyle borderstyle = stylelowered!
string picturename[]
long picturemaskcolor = 536870912
long statepicturemaskcolor = 536870912
integer ii_icono_ct_bd = 100
integer ii_icono_ct_mbd = 200
integer ii_instalaciones_modificadas = 300
integer ii_instalaciones_interrumpidas = 500
integer ii_instalaciones_repuestas = 400
integer ii_cmd_padre = 600
integer ii_instalaciones_at = 700
integer ii_instalaciondes_indisponibles = 1000
integer ii_instalaciones_indisponibles_oi = 1512
integer ii_area_densidad = 1512
end type

event constructor;call super::constructor;//long ll_nro_instalacion, ll_bdi_job, ll_tipo_instalacion
//string ls_nom_instalacion
//datos_arbol lst_datos
//treeviewitem le_elemento
//
//setpointer(HourGlass!)
//
//DECLARE cu_subestacion CURSOR FOR
//SELECT nro_instalacion, nom_instalacion, bdi_job, tipo_instalacion
//FROM sgd_instalacion_at
//WHERE tipo_instalacion=1
//ORDER BY nom_instalacion;
// 
//OPEN cu_subestacion;
// 
//FETCH cu_subestacion INTO :ll_nro_instalacion, :ls_nom_instalacion, :ll_bdi_job, :ll_tipo_instalacion;
//
//do while sqlca.sqlcode <>100 and sqlca.sqlcode <> -1
//	lst_datos.ll_codigo = ll_nro_instalacion
//	lst_datos.ll_tipo = ll_tipo_instalacion
//	le_elemento.data = lst_datos
//	le_elemento.label = ls_nom_instalacion
//	le_elemento.pictureindex = f_icono_Arbol(lst_datos.ll_tipo)
//	le_elemento.selectedpictureindex = f_icono_Arbol(lst_datos.ll_tipo)
//
//	tv_2.insertitemsort(0,le_elemento)
//	FETCH cu_subestacion INTO :ll_nro_instalacion, :ls_nom_instalacion, :ll_bdi_job, :ll_tipo_instalacion;
//loop
//
//close cu_subestacion;
end event

event doubleclicked;call super::doubleclicked;long ll_codigo, ll_fila, ll_nro_otra_incidencia
long ll_tipo, ll_bdijob, ll_pict, ll_tipo_instalacion
long ll_codigo_padre
long ll_noserie
long	ll_manejadorPrimerElemento				//Manejador del primer elemento (subestaci$$HEX1$$f300$$ENDHEX$$n)
datos_arbol lst_datos
datos_arbol	ls_datosPrimerElemento			//Datos del primer elemento del $$HEX1$$e100$$ENDHEX$$rbol (subestaci$$HEX1$$f300$$ENDHEX$$n)
string ls_nombre
treeviewitem le_elemento
treeviewitem le_elemento_nuevo
treeviewitem lt_primerElemento				//Primer elemento del $$HEX1$$e100$$ENDHEX$$rbol (subestaci$$HEX1$$f300$$ENDHEX$$n)


IF handle = 0 THEN // no hay ning$$HEX1$$fa00$$ENDHEX$$n elemento seleccionado
	return
END IF

if gb_bdi and gb_hay_sesion then
	if isnull(handle) then handle=message.LongParm	
end if	

this.getitem(handle,le_elemento)

//Comprueba si esa rama ya esta abierta o si esta contraida
//En negativo la abre haciendo un acceso a la B.D.

if le_elemento.Children = true then
	return
end if
lst_datos = le_elemento.data
ll_tipo = long(lst_datos.ll_tipo)
ll_codigo_padre = long(lst_datos.ll_codigo)

if ll_codigo_padre < 1 then 
	return
end if
//AHM (04/06/2009) Mostrar activos
IF ll_tipo = 25 THEN	//Es un grupo



	ll_manejadorPrimerElemento = THIS.FindItem(RootTreeItem!, 0)
	THIS.getitem(ll_manejadorPrimerElemento,lt_primerElemento)
	ls_datosPrimerElemento = lt_primerElemento.data
	
	//AHM 14/04/2010 Carga de todos los activos de una grupo
	DECLARE cu_instalacionA CURSOR FOR 
	SELECT I.NRO_INSTALACION, I.NOM_INSTALACION, I.BDI_JOB, I.TIPO_INSTALACION
	FROM SGD_INSTALACION_AT I, BDIV10_GRUPOS_ACTIVOS G, BDIV10_ACTIVOS A
	WHERE A.GRUPO_ACTIVOS_V10 = '6666:' || G.CODIGO
		AND A.CODIGO = I.NRO_INSTALACION
		AND G.CODIGO = :ll_codigo_padre
		//AND I.COD_SUBESTAC_AT = :ls_datosPrimerElemento.ll_codigo
	ORDER BY NOM_INSTALACION ASC;
	
	open cu_instalacionA;
	fetch cu_instalacionA into :ll_codigo, :ls_nombre,:ll_bdijob,:ll_pict;

ELSEIF ll_tipo = 1 THEN //Es la subestaci$$HEX1$$f300$$ENDHEX$$n

	DECLARE cu_instalacionG CURSOR FOR 
	SELECT DISTINCT(G.CODIGO) AS NUMERO, G.DESCRIPCION AS NOMBRE, G.BDI_JOB AS BDI_JOB, 25 AS TIPO_INSTALACION
	FROM SGD_INSTALACION_AT I, BDIV10_GRUPOS_ACTIVOS G, BDIV10_ACTIVOS A
	WHERE A.GRUPO_ACTIVOS_V10 = '6666:' || G.CODIGO
		  AND A.CODIGO = I.NRO_INSTALACION
		  AND I.NRO_INST_PADRE = :ll_codigo_padre
	UNION
	SELECT NRO_INSTALACION AS NUMERO, NOM_INSTALACION AS NOMBRE, BDI_JOB , TIPO_INSTALACION
	FROM SGD_INSTALACION_AT SGD_INSTALACIONA
	WHERE NRO_INST_PADRE = :ll_codigo_padre  AND
	BDI_JOB=(SELECT MAX(BDI_JOB) FROM SGD_INSTALACION_AT 
	WHERE NRO_INSTALACION=SGD_INSTALACIONA.NRO_INSTALACION)
	AND SGD_INSTALACIONA.NRO_INSTALACION  NOT IN (SELECT A.CODIGO
																 FROM SGD_INSTALACION_AT I, BDIV10_GRUPOS_ACTIVOS G, BDIV10_ACTIVOS A
																 WHERE A.GRUPO_ACTIVOS_V10 = '6666:' || G.CODIGO
																	  AND A.CODIGO = I.NRO_INSTALACION
																	  AND I.NRO_INST_PADRE = :ll_codigo_padre)
	ORDER BY NOMBRE ASC;

	open cu_instalacionG;
	fetch cu_instalacionG into :ll_codigo, :ls_nombre,:ll_bdijob,:ll_pict;

ELSE
	
	DECLARE cu_instalacion CURSOR FOR 
	SELECT NRO_INSTALACION, NOM_INSTALACION, BDI_JOB, TIPO_INSTALACION
	FROM SGD_INSTALACION_AT SGD_INSTALACIONA
	WHERE NRO_INST_PADRE = :ll_codigo_padre  AND
	BDI_JOB=(SELECT MAX(BDI_JOB) FROM SGD_INSTALACION_AT 
	WHERE NRO_INSTALACION=SGD_INSTALACIONA.NRO_INSTALACION)
	ORDER BY NOM_INSTALACION ASC;

	//Aqui a$$HEX1$$f100$$ENDHEX$$ade al elemento pinchado que tiene el identificador handle
	//los hijos que le correspondan de la tabla inferior
	
	open cu_instalacion;
	fetch cu_instalacion into :ll_codigo, :ls_nombre,:ll_bdijob,:ll_pict;
	
END IF		

do while sqlca.sqlcode <>100 and sqlca.sqlcode <> -1
// COMENTADO MULTINIVEL INSTALACIONES
//	if gb_hay_sesion and ib_busqueda_padre then
//		if ll_tipo + 1>= f_nivel(onis.instalaciones[1].class_id) then // SE ABRE LA RAMA HASTA EL NIVEL DEL PADRE DE LA INSTALACION
//			exit
//		end if
//	end if
	le_elemento_nuevo.label = ls_nombre
	lst_datos.ll_codigo = ll_codigo
	lst_datos.ll_tipo = ll_pict
	le_elemento_nuevo.data = lst_datos
	ll_fila= tabpage_indisponibilidades.dw_datos_indisponibilidades.find("nro_instalacion = " + string(ll_codigo),1,tabpage_indisponibilidades.dw_datos_indisponibilidades.RowCount())

//	if le_elemento.bold or ll_fila>0 then
	if ll_fila>0 then
		le_elemento_nuevo.bold=true
		le_elemento_nuevo.pictureindex = f_icono_arbol(lst_datos.ll_tipo + 600)
		le_elemento_nuevo.selectedpictureindex = f_icono_arbol(lst_datos.ll_tipo + 600)
	else
		SELECT NVL(SGD_INDISPONIBILIDAD.NRO_INCIDENCIA,0)
		INTO :ll_nro_otra_incidencia
		FROM SGD_INDISPONIBILIDAD
		WHERE SGD_INDISPONIBILIDAD.NRO_INSTALACION= :ll_codigo
		AND SGD_INDISPONIBILIDAD.NRO_INCIDENCIA <> :il_nro_incidencia
		AND SGD_INDISPONIBILIDAD.F_REPOSICION IS NULL
		using SQLCA;
		IF ll_nro_otra_incidencia<> 0 and gu_comunic1.is_comunic.intval9<>1 THEN
			le_elemento_nuevo.bold=false
			le_elemento_nuevo.pictureindex = tabpage_indisponibilidades.tv_2.f_icono_Arbol(lst_datos.ll_tipo + 700)
			le_elemento_nuevo.selectedpictureindex= tabpage_indisponibilidades.tv_2.f_icono_Arbol(lst_datos.ll_tipo + 700)
		else
			le_elemento_nuevo.bold=false
			le_elemento_nuevo.pictureindex = f_icono_arbol(lst_datos.ll_tipo + 400)
			le_elemento_nuevo.selectedpictureindex = f_icono_arbol(lst_datos.ll_tipo + 400)
		end if
		ll_nro_otra_incidencia=0
	end if
	
	this.insertitemsort(handle,le_elemento_nuevo)

	IF ll_tipo = 25 THEN 		//Se ha seleccinado un grupo
		fetch cu_instalacionA into :ll_codigo, :ls_nombre,:ll_bdijob,:ll_pict;
	ELSEIF ll_tipo = 1 THEN		//Se ha seleccionado la subestaci$$HEX1$$f300$$ENDHEX$$n
		fetch cu_instalacionG into :ll_codigo, :ls_nombre,:ll_bdijob,:ll_pict;
	ELSE
		fetch cu_instalacion into :ll_codigo, :ls_nombre,:ll_bdijob,:ll_pict;
	END IF

loop

IF ll_tipo = 25 THEN 		//Se ha seleccinado un grupo
	CLOSE cu_instalacionA;
ELSEIF ll_tipo = 1 THEN		//Se ha seleccionado la subestaci$$HEX1$$f300$$ENDHEX$$n
	CLOSE cu_instalacionG;
ELSE
	CLOSE cu_instalacion;
END IF

//THIS.expandItem(handle)

end event

event clicked;call super::clicked;treeviewitem le_elemento
long ll_codigo, ll_fila, ll_handle_padre, ll_cod_causa, ll_fila2
integer li_tipo_icono
datos_arbol lstr_datos_rama
string ls_Causa

IF handle > 0 THEN
	This.SelectItem(handle)
	This.Getitem(handle, le_elemento)
	il_handle_indisponibilidad=handle
	this.getitem(il_handle_indisponibilidad,le_elemento)
	
	li_tipo_icono=le_elemento.pictureindex
	
//	dw_datos_indisponibilidades.SetRedraw(FALSE)
	
	lstr_datos_rama=le_elemento.data
	ll_codigo=lstr_datos_rama.ll_codigo
	st_15.text= "Indisponibilidad en " + le_elemento.label
	ll_fila= dw_datos_indisponibilidades.find("nro_incidencia= " + string(il_nro_incidencia) + " and nro_instalacion = " + string (ll_codigo), 1, dw_datos_indisponibilidades.RowCount())
	
	//JME 08/05/09
	il_nro_inst_indisponibilidad = ll_codigo
	il_row_datos_indisponibilidad = ll_fila
	IF LL_FILA <= 0 THEN 
		dw_lista_indisponibilidades.SelectRow(0, False)
	ELSE
		ll_fila2= dw_lista_indisponibilidades.getselectedrow(0)
		dw_lista_indisponibilidades.SelectRow(ll_fila2, False)
		dw_lista_indisponibilidades.SelectRow(ll_fila, True)	
		dw_lista_indisponibilidades.SetRow(ll_fila)
		dw_lista_indisponibilidades.ScrollToRow(ll_fila)
		dw_datos_indisponibilidades.SetRow(ll_fila)
		dw_datos_indisponibilidades.ScrollToRow(ll_fila)
	END IF
	//Fin JME
	
	IF ll_fila<= 0 THEN
		dw_datos_indisponibilidades.Visible=False
		st_16.visible=false
		//AHM (24/01/2008)
		cb_maniobras.visible = FALSE
//		IF tabpage_ot.d_lista_brigadas_ot.RowCount() <= 0  & 
//			OR tabpage_ot.d_lista_brigadas_ot.find('isnull(f_hasta)', 0, tabpage_ot.d_lista_brigadas_ot.RowCount()) = 0 THEN
//			dw_datos_indisponibilidades.Modify("f_reposicion.Protect= '1'")
//			dw_datos_indisponibilidades.Modify("f_reposicion.Background.Color= '" + gs_gris + "'")
//		ELSE
//			dw_datos_indisponibilidades.Modify("f_reposicion.Protect= '0'")
//			dw_datos_indisponibilidades.Modify("f_reposicion.Background.Color= '" + gs_blanco + "'")
//		END IF
	ELSE
		dw_datos_indisponibilidades.Visible=True
		//AHM (24/01/2008)
		//cb_maniobras.visible = TRUE
		cb_maniobras.visible = FALSE  //JME 12/05/09
		ll_fila2= dw_lista_indisponibilidades.getselectedrow(0)
		if ll_fila2>0 then 
			ll_fila=ll_fila2
		end if
		//st_16.show()  //JME 12/05/09
		IF IsNull(dw_datos_indisponibilidades.GetItemDateTime(ll_fila,"f_reposicion")) &
			AND iw_contenedora.lu_comunic.is_comunic.accion_llamada <> "Consulta" THEN
			dw_datos_indisponibilidades.SetRow(ll_fila)
			dw_datos_indisponibilidades.ScrollToRow(ll_fila)
			dw_datos_indisponibilidades.Modify("f_alta.Protect= '1'")
			dw_datos_indisponibilidades.Modify("f_alta.Background.Color= '" + gs_gris + "'")
//			dw_datos_indisponibilidades.Modify("f_reposicion.Protect= '0'")
//			dw_datos_indisponibilidades.Modify("f_reposicion.Background.Color= '" + gs_blanco + "'")
		ELSE
			dw_datos_indisponibilidades.SetRow(ll_fila)
			dw_datos_indisponibilidades.ScrollToRow(ll_fila)
			dw_datos_indisponibilidades.Modify("f_alta.Protect= '1'")
			dw_datos_indisponibilidades.Modify("f_alta.Background.Color= '" + gs_gris + "'")
			//JME 08/05/09
			//dw_datos_indisponibilidades.Modify("f_reposicion.Protect= '1'")
			//dw_datos_indisponibilidades.Modify("f_reposicion.Background.Color= '" + gs_gris + "'")
			//Fin JME
		END IF
		ll_cod_causa=dw_datos_indisponibilidades.getitemnumber(ll_fila,"cod_causa")
		SELECT descripcion
		INTO :ls_causa
		FROM GI_CAUSA
		WHERE cod_causa=:ll_Cod_causa
		USING SQLCA;
		
		IF sqlca.sqlcode<0 THEN
//			MessageBox("Atenci$$HEX1$$f300$$ENDHEX$$n", "No se ha encontrado la causa")
			dw_datos_indisponibilidades.object.st_causa.text=''
		ELSE
			dw_datos_indisponibilidades.object.st_causa.text = ls_causa
		END IF
			yield()
	END IF
//	dw_datos_indisponibilidades.SetRedraw(TRUE)
END IF	
end event

event rightclicked;call super::rightclicked;m_indisponibilidad lm_menu
treeviewitem le_elemento, le_elemento_padre
datos_arbol lst_datos
long ll_codigo
boolean aux
long ll_fila, ll_nro_otra_incidencia, ll_class_id
string ls_entidad, ls_nombre
long ll_cod_maniobra

treeviewitem 	le_elementoAux		//Elemento auxiliar necesario para generar de nuevo el $$HEX1$$e100$$ENDHEX$$rbol
datos_arbol		lst_datosAux		//Dato auxiliar para la generaci$$HEX1$$f300$$ENDHEX$$n del nodo

if ii_estado_oper <= fgci_incidencia_servicio_repuesto then

	lm_menu = CREATE m_indisponibilidad

	tv_2.getitem(il_handle_indisponibilidad,le_elemento)
//ll_inst_padre=tv_2.FindItem(ParentTreeItem!, il_handle_indisponibilidad)

	if il_handle_indisponibilidad>0 then
	
//	if ll_inst_padre >0 then
//		tv_2.getitem(ll_inst_padre,le_elemento_padre)
//	else
//		le_elemento_padre.bold=false
//	end if
//	if le_elemento.bold then
////		le_elemento.StatePictureIndex=1
////		le_elemento.bold=false
////		lst_datos=le_elemento.data
////		le_elemento.pictureindex = tv_2.f_icono_Arbol(lst_datos.ll_tipo)
////		le_elemento.selectedpictureindex = le_elemento.pictureindex
//	else
//
////		le_elemento.StatePictureIndex=2
////		le_elemento.bold=true
////		lst_datos=le_elemento.data
////		le_elemento.pictureindex = tv_2.f_icono_Arbol(lst_datos.ll_tipo + 600)
////		le_elemento.selectedpictureindex = le_elemento.pictureindex
//	end if

// Si el padre est$$HEX2$$e1002000$$ENDHEX$$marcado no puedo desmarcarlo
//	if le_elemento_padre.bold=true  and le_elemento.bold = true then
//		aux=false
//	elseif le_elemento.bold=false  and &
//		 not fnu_valida_indisponibilidad(il_handle_indisponibilidad) then
//		aux=false
//	else
//		aux= true
//	end if


	lst_datos=le_elemento.data
	ll_fila= dw_datos_indisponibilidades.find("nro_incidencia= " + string(il_nro_incidencia) + " and nro_instalacion = " + string (lst_datos.ll_codigo), 1, dw_datos_indisponibilidades.RowCount())
	
	SELECT NVL(SGD_INDISPONIBILIDAD.NRO_INCIDENCIA,0)
	INTO :ll_nro_otra_incidencia
	FROM SGD_INDISPONIBILIDAD
	WHERE SGD_INDISPONIBILIDAD.NRO_INSTALACION= :lst_datos.ll_codigo
	AND SGD_INDISPONIBILIDAD.NRO_INCIDENCIA <> :il_nro_incidencia
	AND SGD_INDISPONIBILIDAD.F_REPOSICION IS NULL
	using SQLCA;
	
	if ll_fila <=0 and ll_nro_otra_incidencia= 0 then
		lm_menu.m_marcarindisponibilidad.visible=true
		lm_menu.m_desmarcarindisponibilidad.visible=false
		lm_menu.m_marcarindisponibilidadrama.visible=true
		lm_menu.m_desmarcarindisponibilidadrama.visible=false
		lm_menu.m_incidencia.visible= false
		lm_menu.m_instalacionafectada.visible= true
//				ll_fila=tabpage_indisponibilidades.dw_datos_indisponibilidades.InsertRow(0)
	elseif ll_fila <=0 and ll_nro_otra_incidencia> 0 then
		lm_menu.m_marcarindisponibilidad.visible=false
		lm_menu.m_desmarcarindisponibilidad.visible=false
		lm_menu.m_marcarindisponibilidadrama.visible=false
		lm_menu.m_desmarcarindisponibilidadrama.visible=false
		lm_menu.m_incidencia.visible= true
		lm_menu.m_instalacionafectada.visible= true
	else
		lm_menu.m_marcarindisponibilidad.visible=false
		lm_menu.m_desmarcarindisponibilidad.visible=true
		lm_menu.m_marcarindisponibilidadrama.visible=false

		lm_menu.m_desmarcarindisponibilidadrama.visible=true

		lm_menu.m_incidencia.visible= false
		lm_menu.m_instalacionafectada.visible= true
	end if
	
	//AHM (03/06/2009) Mostrar activos
	IF lst_datos.ll_tipo = 1 OR  lst_datos.ll_tipo = 25 THEN
		lm_menu.m_marcarindisponibilidad.visible=FALSE
		IF lst_datos.ll_tipo = 1 THEN
			lm_menu.m_nuevaindisponibilidad.visible = TRUE
			lm_menu.m_desmarcarindisponibilidad.visible = FALSE
		END IF
	END IF
//				tabpage_indisponibilidades.dw_datos_indisponibilidades.Visible=True
//				tabpage_indisponibilidades.dw_datos_indisponibilidades.SetItem(ll_fila,'nro_instalacion', lst_datos.ll_codigo)
//				tabpage_indisponibilidades.dw_datos_indisponibilidades.SetItem(ll_fila,'f_alta',fgnu_fecha_actual())
//				tabpage_indisponibilidades.dw_datos_indisponibilidades.SetItem(ll_fila,'nro_incidencia', il_nro_incidencia)
//				tabpage_indisponibilidades.dw_datos_indisponibilidades.SetItem(ll_fila,'usuario', gs_usuario)
////				tabpage_indisponibilidades.dw_datos_indisponibilidades.SetRow(ll_fila)
//				tabpage_indisponibilidades.dw_datos_indisponibilidades.ScrollToRow(ll_fila)
//		else
//			if ll_fila > 0 then
//				tabpage_indisponibilidades.dw_datos_indisponibilidades.Visible=False
//				tabpage_indisponibilidades.dw_datos_indisponibilidades.DeleteRow(ll_fila)
//			end if
//		end if
//		tv_2.setitem(il_handle_indisponibilidad,le_elemento)

	lm_menu.PopMenu(PointerX(), PointerY())
	SetPointer(HourGlass!)
	CHOOSE CASE lm_menu.ii_opcion_indisponibilidad
	CASE 1 // Marcar Indisponibilidad
		
//		SELECT NVL(SGD_INDISPONIBILIDAD.NRO_INCIDENCIA,0)
//		INTO :ll_nro_otra_incidencia
//		FROM SGD_INDISPONIBILIDAD
//		WHERE SGD_INDISPONIBILIDAD.NRO_INSTALACION= :lst_datos.ll_codigo
//		AND SGD_INDISPONIBILIDAD.NRO_INCIDENCIA <> :il_nro_incidencia
//		AND SGD_INDISPONIBILIDAD.F_REPOSICION IS NULL
//		using SQLCA;
		
//		if ll_nro_otra_incidencia = 0 then			
				IF gb_operaciones = true and gb_operaciones_inst = true then
//		IF isvalid(gu_rf_servidor_operacion) THEN 
//			IF (gu_rf.of_comprueba_inst_digitalizada(ll_array[], ll_codigo)> 0) AND &
//			 ((ll_Tipo= fgci_tipo_celda_at) OR (ll_tipo= fgci_tipo_celda_mt))THEN
		   // Abrir ventana de selecci$$HEX1$$f300$$ENDHEX$$n de maniobra de apertura
				gu_comunic2.is_comunic.longval1=1
				gu_comunic2.is_comunic.datval2=fgnu_fecha_actual()
				open(w_listado_maniobras)
				IF gu_comunic2.is_comunic.longval1=0 then
					Messagebox("Atenci$$HEX1$$f300$$ENDHEX$$n", "No se ha seleccionado una maniobra de apertura")
					return
				ELSE 
					ll_cod_maniobra=gu_comunic2.is_comunic.longval1
					gu_comunic2.is_comunic.longval1= 0	

					if gu_comunic2.is_comunic.datval2> fgnu_fecha_actual() then
						MessageBox("Atenci$$HEX1$$f300$$ENDHEX$$n", "La Fecha de Alta de la Indisponibilidad no puede ser mayor que la fecha del d$$HEX1$$ed00$$ENDHEX$$a")
						Return
					end if

					if gu_comunic2.is_comunic.datval2< idt_fec_deteccion then
						gnv_msg.f_mensaje("AI113","","",ok!)
						Return
					end if
				END IF
//			END IF
		END IF
		
		
			le_elemento.StatePictureIndex=2
			le_elemento.bold=true
			lst_datos=le_elemento.data
			le_elemento.pictureindex = tv_2.f_icono_Arbol(lst_datos.ll_tipo + 600)
			le_elemento.selectedpictureindex = le_elemento.pictureindex
			tv_2.setitem(il_handle_indisponibilidad,le_elemento)
			ll_fila=tabpage_indisponibilidades.dw_datos_indisponibilidades.InsertRow(0)
			
			//JME 12/05/09
			datetime ldt_f_actual, ldt_fecha_causa, ldt_aux
			long ll_cod_causa
			
			SELECT NVL(COD_CAUSA, 999), NVL(FEC_CAUSA, FECHA_MANIOBRA)
			  INTO :ll_cod_causa, :ldt_fecha_causa
			  FROM SGD_MANIOBRA
			 WHERE COD_MANIOBRA = :ll_cod_maniobra;
			
			tabpage_indisponibilidades.dw_datos_indisponibilidades.SetItem(ll_fila,'cod_causa', ll_cod_causa)	
			tabpage_indisponibilidades.dw_datos_indisponibilidades.SetItem(ll_fila,'fecha_causa', ldt_fecha_causa)	
			
			ldt_f_actual = fgnu_fecha_actual()
			tabpage_indisponibilidades.dw_datos_indisponibilidades.SetItem(ll_fila,'F_ACTUAL', ldt_f_actual)	
			ldt_aux = tabpage_indisponibilidades.dw_datos_indisponibilidades.Object.f_actual[ll_fila]
			//Fin JME
			
			tabpage_indisponibilidades.dw_datos_indisponibilidades.SetItem(ll_fila,'nro_instalacion', lst_datos.ll_codigo)
			tabpage_indisponibilidades.dw_datos_indisponibilidades.SetItem(ll_fila,'f_alta',fgnu_fecha_actual())
			tabpage_indisponibilidades.dw_datos_indisponibilidades.SetItem(ll_fila,'nro_incidencia', il_nro_incidencia)
			tabpage_indisponibilidades.dw_datos_indisponibilidades.SetItem(ll_fila,'usuario', gs_usuario)
			
			SELECT NVL(class_id,0)
			INTO :ll_class_id
			FROM sgd_instalacion_at
			WHERE nro_instalacion=:lst_datos.ll_codigo
					and bdi_job=0
			using SQLCA;
			
			tabpage_indisponibilidades.dw_datos_indisponibilidades.SetItem(ll_fila,'class_id', ll_class_id)
			tabpage_indisponibilidades.dw_datos_indisponibilidades.accepttext()
//				tabpage_indisponibilidades.dw_datos_indisponibilidades.SetRow(ll_fila)
			tabpage_indisponibilidades.dw_datos_indisponibilidades.Visible=True
			//AHM (24/01/2008)
			tabpage_indisponibilidades.cb_maniobras.visible = TRUE
			tabpage_indisponibilidades.dw_datos_indisponibilidades.ScrollToRow(ll_fila)
			if  ll_cod_maniobra>0 THEN
				tabpage_indisponibilidades.dw_datos_indisponibilidades.SetItem(ll_fila,'t_mapertura', ll_cod_maniobra)
				tabpage_indisponibilidades.dw_datos_indisponibilidades.SetItem(ll_fila,'f_alta', gu_comunic2.is_comunic.datval2)
				tabpage_indisponibilidades.dw_datos_indisponibilidades.Modify("f_alta.Protect= '1'")
				tabpage_indisponibilidades.dw_datos_indisponibilidades.Modify("f_alta.Background.Color= '" + gs_gris + "'")
			END IF
			
			ll_fila=tabpage_indisponibilidades.dw_lista_indisponibilidades.InsertRow(0)
			tabpage_indisponibilidades.dw_lista_indisponibilidades.SetItem(ll_fila,'tip_interrupcion', 0)
			SELECT ENTIDAD
			INTO: LS_ENTIDAD
			FROM SGD_ENTIDADES
			WHERE SGD_ENTIDADES.CLASS_ID=:ll_class_id  OR 
          SGD_ENTIDADES.CLASS_ID_ESQ=:ll_class_id
			USING SQLCA;
			
			tabpage_indisponibilidades.dw_lista_indisponibilidades.SetItem(ll_fila,'entidad', ls_entidad)
			tabpage_indisponibilidades.dw_lista_indisponibilidades.SetItem(ll_fila,'f_alta',fgnu_fecha_actual())
			tabpage_indisponibilidades.dw_lista_indisponibilidades.SetItem(ll_fila,'nombre', le_elemento.label)
			tabpage_indisponibilidades.dw_lista_indisponibilidades.SetItem(ll_fila,'nro_instalacion', lst_datos.ll_codigo)
			if  ll_cod_maniobra>0 THEN

				tabpage_indisponibilidades.dw_lista_indisponibilidades.SetItem(ll_fila,'maniobra_apertura', ll_cod_maniobra)
				tabpage_indisponibilidades.dw_lista_indisponibilidades.SetItem(ll_fila,'f_alta', gu_comunic2.is_comunic.datval2)
			END IF
			//tabpage_indisponibilidades.st_16.show()      //JME 12/05/09
			//AHM(04/01/2008)
			tabpage_indisponibilidades.cb_maniobras.visible = TRUE
			
						
			//JME 14/07/09
			int li_fila_seleccionada
			li_fila_seleccionada = tabpage_indisponibilidades.dw_lista_indisponibilidades.getselectedrow(0) 
			
			if li_fila_seleccionada > 0 then 
				tabpage_indisponibilidades.dw_lista_indisponibilidades.selectrow(li_fila_seleccionada,false)
			end if
			tabpage_indisponibilidades.dw_lista_indisponibilidades.selectrow(ll_fila, true)
					
//		else
//			MessageBox("Atenci$$HEX1$$f300$$ENDHEX$$n", "La instalaci$$HEX1$$f300$$ENDHEX$$n se encuentra indisponible en la incidencia n$$HEX1$$fa00$$ENDHEX$$mero: " + string(ll_nro_otra_incidencia))
//		end if
	CASE 2 // Desmarcar Indisponibilidad

		le_elemento.StatePictureIndex=1
		le_elemento.bold=false
		lst_datos=le_elemento.data
		le_elemento.pictureindex = tv_2.f_icono_Arbol(lst_datos.ll_tipo + 400)
		le_elemento.selectedpictureindex = le_elemento.pictureindex
		tv_2.setitem(il_handle_indisponibilidad,le_elemento)
		tabpage_indisponibilidades.dw_datos_indisponibilidades.Visible=False

		//AHM (24/01/2008)
		tabpage_indisponibilidades.cb_maniobras.visible = FALSE
		tabpage_indisponibilidades.dw_datos_indisponibilidades.DeleteRow(ll_fila)

		tabpage_indisponibilidades.dw_lista_indisponibilidades.setredraw(false)
		ll_fila=tabpage_indisponibilidades.dw_lista_indisponibilidades.find("nro_instalacion= " + string(lst_datos.ll_codigo),1,tabpage_indisponibilidades.dw_lista_indisponibilidades.RowCount())
		tabpage_indisponibilidades.dw_lista_indisponibilidades.DeleteRow(ll_fila)
		tabpage_indisponibilidades.dw_lista_indisponibilidades.setredraw(true)
		
	CASE 3 // Marcar Hijos
		of_marcar_hijos(il_handle_indisponibilidad,true)
		
		IF gb_operaciones = true and gb_operaciones_inst = true then
			 gu_comunic2.is_comunic.longval1=1
			 gu_comunic2.is_comunic.datval2=fgnu_fecha_actual()
			open(w_listado_maniobras)
			IF gu_comunic2.is_comunic.longval1=0 then
				Messagebox("Atenci$$HEX1$$f300$$ENDHEX$$n", "No se ha seleccionado una maniobra de apertura")
				return
			ELSE 
				ll_cod_maniobra=gu_comunic2.is_comunic.longval1
				gu_comunic2.is_comunic.longval1= 0	
				if gu_comunic2.is_comunic.datval2> fgnu_fecha_actual() then
					MessageBox("Atenci$$HEX1$$f300$$ENDHEX$$n", "La Fecha de Alta de la Indisponibilidad no puede ser mayor que la fecha del d$$HEX1$$ed00$$ENDHEX$$a")
					Return
				end if

				if gu_comunic2.is_comunic.datval2< idt_fec_deteccion then
					gnv_msg.f_mensaje("AI113","","",ok!)
					Return
				end if
			END IF
		END IF
		
		DECLARE cu_instalacion CURSOR FOR 
		select nro_instalacion, nom_instalacion
		from sgd_instalacion_At
		where nro_instalacion in
		(select nro_instalacion from sgd_instalacion_at
		start with nro_instalacion=:lst_datos.ll_codigo
		and bdi_job=0
		connect by prior sgd_instalacion_at.nro_instalacion=sgd_instalacion_at.nro_inst_padre
		and bdi_job=0);
		
		open cu_instalacion;
		fetch cu_instalacion into :ll_codigo,:ls_nombre;
		
		do while sqlca.sqlcode <>100 and sqlca.sqlcode <> -1
		
			ll_fila= dw_datos_indisponibilidades.find("nro_incidencia= " + string(il_nro_incidencia) + " and nro_instalacion = " + string (ll_codigo), 1, dw_datos_indisponibilidades.RowCount())
			if ll_fila <= 0 then	
				
				SELECT NVL(SGD_INDISPONIBILIDAD.NRO_INCIDENCIA,0)
				INTO :ll_nro_otra_incidencia
				FROM SGD_INDISPONIBILIDAD
				WHERE SGD_INDISPONIBILIDAD.NRO_INSTALACION= :ll_codigo
				AND SGD_INDISPONIBILIDAD.NRO_INCIDENCIA <> :il_nro_incidencia
				AND SGD_INDISPONIBILIDAD.F_REPOSICION IS NULL
				using SQLCA;
				if ll_nro_otra_incidencia = 0 then	
					ll_fila=tabpage_indisponibilidades.dw_datos_indisponibilidades.InsertRow(0)
					tabpage_indisponibilidades.dw_datos_indisponibilidades.SetItem(ll_fila,'nro_instalacion', ll_codigo)
					tabpage_indisponibilidades.dw_datos_indisponibilidades.SetItem(ll_fila,'f_alta',fgnu_fecha_actual())
					tabpage_indisponibilidades.dw_datos_indisponibilidades.SetItem(ll_fila,'nro_incidencia', il_nro_incidencia)
					tabpage_indisponibilidades.dw_datos_indisponibilidades.SetItem(ll_fila,'usuario', gs_usuario)	
										
					if ll_cod_maniobra > 0 then
						tabpage_indisponibilidades.dw_datos_indisponibilidades.SetItem(ll_fila,'t_mapertura', ll_cod_maniobra)
						tabpage_indisponibilidades.dw_datos_indisponibilidades.SetItem(ll_fila,'f_alta', gu_comunic2.is_comunic.datval2)
						tabpage_indisponibilidades.dw_datos_indisponibilidades.Modify("f_alta.Protect= '1'")
						tabpage_indisponibilidades.dw_datos_indisponibilidades.Modify("f_alta.Background.Color= '" + gs_gris + "'")
					end if
					
					SELECT NVL(class_id,0)
					INTO :ll_class_id
					FROM sgd_instalacion_at
					WHERE nro_instalacion=:lst_datos.ll_codigo
						and bdi_job=0
					using SQLCA;
			
					tabpage_indisponibilidades.dw_datos_indisponibilidades.SetItem(ll_fila,'class_id', ll_class_id)
					
					ll_fila=tabpage_indisponibilidades.dw_lista_indisponibilidades.InsertRow(0)
					tabpage_indisponibilidades.dw_lista_indisponibilidades.SetItem(ll_fila,'tip_interrupcion', 0)
					SELECT ENTIDAD
					INTO: LS_ENTIDAD
					FROM SGD_ENTIDADES
					WHERE SGD_ENTIDADES.CLASS_ID=:ll_class_id  OR 
          		SGD_ENTIDADES.CLASS_ID_ESQ=:ll_class_id
					USING SQLCA;
			
					tabpage_indisponibilidades.dw_lista_indisponibilidades.SetItem(ll_fila,'entidad', ls_entidad)
					tabpage_indisponibilidades.dw_lista_indisponibilidades.SetItem(ll_fila,'f_alta',fgnu_fecha_actual())
					tabpage_indisponibilidades.dw_lista_indisponibilidades.SetItem(ll_fila,'nombre', ls_nombre)
					tabpage_indisponibilidades.dw_lista_indisponibilidades.SetItem(ll_fila,'nro_instalacion', lst_datos.ll_codigo)
					if  ll_cod_maniobra>0 THEN
						tabpage_indisponibilidades.dw_lista_indisponibilidades.SetItem(ll_fila,'maniobra_apertura', ll_cod_maniobra)
						tabpage_indisponibilidades.dw_lista_indisponibilidades.SetItem(ll_fila,'f_alta', gu_comunic2.is_comunic.datval2)
					END IF
					//tabpage_indisponibilidades.st_16.show()     //JME 12/05/09
					
//					tabpage_indisponibilidades.dw_datos_indisponibilidades.SetItem(ll_fila,'tip_interrupcion', '0')
//					tabpage_indisponibilidades.dw_datos_indisponibilidades.SetItem(ll_fila,'manual',1)
//					tabpage_indisponibilidades.dw_datos_indisponibilidades.Modify("manual.CheckBox.on="
				end if
			end if
			fetch cu_instalacion into :ll_codigo, :ls_nombre;
			ll_nro_otra_incidencia = 0
		loop
		close cu_instalacion;
		tabpage_indisponibilidades.dw_datos_indisponibilidades.Visible=True
		//AHM (24/01/2008)
		tabpage_indisponibilidades.cb_maniobras.visible = TRUE
		ll_fila= dw_datos_indisponibilidades.find("nro_incidencia= " + string(il_nro_incidencia) + " and nro_instalacion = " + string (lst_datos.ll_codigo), 1, dw_datos_indisponibilidades.RowCount())
		tabpage_indisponibilidades.dw_datos_indisponibilidades.ScrollToRow(ll_fila)
		
	CASE 4 // Desmarcar hijos
//		of_marcar_hijos(il_handle_indisponibilidad,false)
		
		DECLARE cu_instalacion_2 CURSOR FOR 
		select nro_instalacion
		from sgd_instalacion_At
		where nro_instalacion in
		(select nro_instalacion from sgd_instalacion_at
		start with nro_instalacion=:lst_datos.ll_codigo
		and bdi_job=0
		connect by prior sgd_instalacion_at.nro_instalacion=sgd_instalacion_at.nro_inst_padre
		and bdi_job=0);
		
		open cu_instalacion_2;
		fetch cu_instalacion_2 into :ll_codigo;
		
		do while sqlca.sqlcode <>100 and sqlca.sqlcode <> -1
		
			ll_fila= dw_datos_indisponibilidades.find("nro_incidencia= " + string(il_nro_incidencia) + " and nro_instalacion = " + string (ll_codigo), 1, dw_datos_indisponibilidades.RowCount())
			if ll_fila > 0 then	
				tabpage_indisponibilidades.dw_datos_indisponibilidades.DeleteRow(ll_fila)	 
				ll_fila=tabpage_indisponibilidades.dw_lista_indisponibilidades.find("nro_instalacion= " + string(lst_datos.ll_codigo),1,tabpage_indisponibilidades.dw_lista_indisponibilidades.RowCount())
				tabpage_indisponibilidades.dw_lista_indisponibilidades.DeleteRow(ll_fila)
			end if
			fetch cu_instalacion_2 into :ll_codigo;
		loop
		close cu_instalacion_2;
		
		tabpage_indisponibilidades.dw_datos_indisponibilidades.Visible=False
		//AHM (24/01/2008)
		tabpage_indisponibilidades.cb_maniobras.visible = FALSE
		of_marcar_hijos(il_handle_indisponibilidad,false)

	CASE 5
//		SELECT NVL(SGD_INDISPONIBILIDAD.NRO_INCIDENCIA,0)
//		INTO :ll_nro_otra_incidencia
//		FROM SGD_INDISPONIBILIDAD
//		WHERE SGD_INDISPONIBILIDAD.NRO_INSTALACION= :lst_datos.ll_codigo
//		AND SGD_INDISPONIBILIDAD.NRO_INCIDENCIA <> :il_nro_incidencia
//		AND SGD_INDISPONIBILIDAD.F_REPOSICION IS NULL
//		using SQLCA;

		MessageBox("Informaci$$HEX1$$f300$$ENDHEX$$n", "La indisponibilidad se encuentra dada de alta en la incidencia: " + string (ll_nro_otra_incidencia))
		
	CASE 6
		this.deleteitem(0)
		of_cargar_indisponibilidad(long(tabpage_formulario.d_inf_general.getitemnumber(1,'nombre_ins')))

	CASE 7 //Nueva indisponibilidad (AHM 03/06/2009 Mostrar activos)
		
		tv_2.getitem(handle,le_elemento)
		
		//Carga de los datos en la estructura
		lst_datosAux = le_elemento.data
		le_elementoAux.data = le_elemento.data
		le_elementoAux.label = le_elemento.label

		le_elementoAux.bold = FALSE
		le_elementoAux.pictureindex = THIS.f_icono_Arbol(lst_datosAux.ll_tipo + 400)
		le_elementoAux.selectedpictureindex = THIS.f_icono_Arbol(lst_datosAux.ll_tipo + 400)
		
		tv_2.deleteItem(0)	//Borra el $$HEX1$$e100$$ENDHEX$$rbol de instalaciones
		
		tabpage_indisponibilidades.tv_2.insertitemsort(0,le_elementoAux)
		

	END CHOOSE
//		lst_datos=le_elemento.data
//	end if
	end if
end if
il_handle_indisponibilidad=0


end event

type gb_1 from groupbox within tabpage_indisponibilidades
integer x = 18
integer y = 584
integer width = 2199
integer height = 192
integer taborder = 22
integer textsize = -7
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 33554432
long backcolor = 67108864
string text = "Leyenda de Instalaciones"
end type

type st_16 from statictext within tabpage_indisponibilidades
boolean visible = false
integer x = 2469
integer y = 304
integer width = 256
integer height = 64
boolean bringtotop = true
integer textsize = -10
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
boolean italic = true
boolean underline = true
long textcolor = 128
long backcolor = 81324524
boolean enabled = false
string text = "Causa"
boolean focusrectangle = false
end type

event clicked;long ll_gpo_Causa

If fg_verifica_parametro('CAUSAS') Then
	OpenWithParm(w_2301_sel_causa_x_tipo, ii_tipo_incid)
else
	Open(w_2301_sel_causa)
end if

if gu_comunic2.is_comunic.longval4 > 0 then
	dw_datos_indisponibilidades.setitem(dw_datos_indisponibilidades.getrow(),"cod_causa",gu_comunic2.is_comunic.longval4)
	
	SELECT GPO_CAUSA
	INTO :ll_gpo_causa
	FROM GI_CAUSA
	WHERE COD_CAUSA =:gu_comunic2.is_comunic.longval4
	using SQLCA;

	dw_datos_indisponibilidades.setitem(dw_datos_indisponibilidades.getrow(),"fam_causa",ll_gpo_causa)	
	dw_datos_indisponibilidades.object.st_causa.text = gu_comunic2.is_comunic.strval9
	yield()
end if
end event

type dw_datos_indisponibilidades from datawindow within tabpage_indisponibilidades
integer x = 1408
integer y = 80
integer width = 2002
integer height = 480
integer taborder = 23
string title = "none"
string dataobject = "dw_datos_indisponibilidades"
boolean livescroll = true
borderstyle borderstyle = stylelowered!
end type

event itemchanged;datetime ldt_fecha_nula, ldt_f_alta, ldt_f_reposicion, ldt_f_desde, ldt_f_hasta
long ll_nro_instalacion, ll_fila, ll_handle, ll_status, ll_auxiliar
treeviewitem le_elemento
datos_arbol lstr_datos_rama

SetNull(ldt_fecha_nula)
//This.SetRedraw(False)
This.AcceptText()

ldt_f_desde= This.GetItemDateTime(row,"f_alta")

IF dwo.name= "f_alta" THEN
	ldt_f_alta=DateTime(Date(Left(data,10)),Time(Right(data,15)))
	
	if IsNull(ldt_f_alta) THEN
		MessageBox("Atenci$$HEX1$$f300$$ENDHEX$$n", "La Fecha de Alta de la Indisponibilidad no puede ser nula")
		This.SetItem(row, "f_alta", fgnu_fecha_actual())
	//	This.SetRedraw(True)
		Return 2
	end if

	if ldt_f_alta > fgnu_fecha_actual() then
		MessageBox("Atenci$$HEX1$$f300$$ENDHEX$$n", "La Fecha de Alta de la Indisponibilidad no puede ser mayor que la fecha del d$$HEX1$$ed00$$ENDHEX$$a")
		This.SetItem(row, "f_alta", fgnu_fecha_actual())
		//This.SetRedraw(True)
		Return 2
	end if

	if ldt_f_alta< idt_fec_deteccion then
		gnv_msg.f_mensaje("AI113","","",ok!)
		This.SetItem(row, "f_alta", idt_fec_deteccion)
//		This.SetRedraw(True)
		Return 2
	end if
	


// Se busca la instalaci$$HEX1$$f300$$ENDHEX$$n marcada
ll_handle = tv_2.FINDITEM(CurrentTreeItem! ,0)

if ll_handle > 1 then
DO 
	// se recorre la jerarqu$$HEX1$$ed00$$ENDHEX$$a de instalaciones hacia arriba para ver si existe alguna
	// instalaci$$HEX1$$f300$$ENDHEX$$n con una interrupci$$HEX1$$f300$$ENDHEX$$n resuelta 
	ll_handle = tv_2.FINDITEM(ParentTreeItem!,ll_handle)

	tv_2.GETITEM(ll_handle,le_elemento)
	IF le_elemento.bold = TRUE THEN
		lstr_datos_rama = le_elemento.data
		ll_fila = this.find("nro_instalacion = " + string(lstr_datos_rama.ll_codigo), 1, This.rowcount())
		IF ll_fila > 0 THEN 
			// Existe una interrupci$$HEX1$$f300$$ENDHEX$$n en una instalaci$$HEX1$$f300$$ENDHEX$$n superior. Se comprueba que la
			// fecha de resoluci$$HEX1$$f300$$ENDHEX$$n sea menor que la fecha de alta de la nueva interrupci$$HEX1$$f300$$ENDHEX$$n
			ldt_f_reposicion = This.GetItemDatetime(ll_fila, 'f_reposicion')
			IF NOT isnull(ldt_f_reposicion) THEN
				IF ldt_f_reposicion > ldt_f_alta THEN
					MessageBox("Atenci$$HEX1$$f300$$ENDHEX$$n", "La Fecha de Alta de la Indisponibilidad no puede mayor que la Fecha de Reposici$$HEX1$$f300$$ENDHEX$$n del padre")
					This.SetItem(row, "f_alta", fgnu_fecha_actual())
	//				This.SetRedraw(True)
					Return 2
				END IF
			ELSE 
				MessageBox("Atenci$$HEX1$$f300$$ENDHEX$$n", "Existe una indisponibilidad abierta en una capa superior")
				This.SetItem(row, "f_alta", fgnu_fecha_actual())
		//		This.SetRedraw(True)
				Return 2
			END IF
		END IF
	END IF

LOOP WHILE ll_handle > 0

end if



This.SetItem(row, "f_alta", ldt_f_alta)

tv_2.GETITEM(ll_handle,le_elemento)
lstr_datos_rama = le_elemento.data
ll_fila=tabpage_indisponibilidades.dw_lista_indisponibilidades.find("nro_instalacion= " + string(lstr_datos_rama.ll_codigo),1,tabpage_indisponibilidades.dw_lista_indisponibilidades.RowCount())
tabpage_indisponibilidades.dw_lista_indisponibilidades.SetItem(ll_fila,'f_alta', ldt_f_alta)

END IF

//AHM (04/01/2008)
//IF dwo.name= "f_reposicion" THEN
//	ldt_f_reposicion=DateTime(Date(Left(data,10)),Time(Right(data,15)))
//	
//	ldt_f_alta=This.GetItemDateTime(row, "f_alta")
//
////	if IsNull(ldt_f_reposicion) THEN
////		MessageBox("Atenci$$HEX1$$f300$$ENDHEX$$n", "La Fecha de Reposici$$HEX1$$f300$$ENDHEX$$n de la Indisponibilidad no puede ser nula")
////		This.SetItem(row, "f_alta", idt_fec_deteccion)
////		This.SetRedraw(True)
////		Return 2
////	end if
////	
//
//
//			IF gb_operaciones = true and gb_operaciones_inst = true then
////			IF isvalid(gu_rf_servidor_operacion) THEN
////			
////				IF ((gu_rf.of_comprueba_inst_digitalizada(ll_array[], lstr_datos_rama.ll_codigo)> 0) AND &
////					(lstr_datos_rama.ll_Tipo= fgci_tipo_celda_at) OR (lstr_datos_rama.ll_tipo= fgci_tipo_celda_mt)) THEN
//					gu_comunic2.is_comunic.longval1=0
//					gu_comunic2.is_comunic.datval2=ldt_f_reposicion
//					OPEN (w_listado_maniobras)
//					IF NOT (gu_comunic2.is_comunic.longval1 > 0) THEN
//						Messagebox("Atenci$$HEX1$$f300$$ENDHEX$$n", "No se ha seleccionado una maniobra de cierre")
//						This.SetItem(row, "f_reposicion", ldt_fecha_nula)	
//						Return 2
//					ELSE
//						ldt_f_reposicion=gu_comunic2.is_comunic.datval2
//					END IF
////				END IF
//			END IF
//
//	If Not IsNull (ldt_f_reposicion) THEN
//
//		if ldt_f_reposicion< idt_fec_deteccion then
//			MessageBox("Atenci$$HEX1$$f300$$ENDHEX$$n", "La Fecha de Reposici$$HEX1$$f300$$ENDHEX$$n de la Indisponibilidad no puede ser menor que la fecha de alta de la Incidencia")
//			This.SetItem(row, "f_reposicion", ldt_fecha_nula)
////			This.SetRedraw(True)
//			Return 2
//		end if
//	
//		if ldt_f_reposicion < ldt_f_alta then
//			MessageBox("Atenci$$HEX1$$f300$$ENDHEX$$n", "La Fecha de Reposici$$HEX1$$f300$$ENDHEX$$n de la Indisponibilidad no puede ser menor que la Fecha de Alta de la misma")
//			This.SetItem(row, "f_reposicion", ldt_fecha_nula)
//	//		This.SetRedraw(True)
//			Return 2
//		end if
//	
//		if ldt_f_reposicion > fgnu_fecha_actual() then
//			gnv_msg.f_mensaje("AI110","","",ok!)
//			This.SetItem(row, "f_reposicion", ldt_fecha_nula)
////			This.SetRedraw(True)
//			Return 2
//		end if
//		
////		if ldt_f_reposicion < tabpage_ot.d_datos_ot.GetItemDateTime(1,'f_desde') THEN
////			MessageBox("Atenci$$HEX1$$f300$$ENDHEX$$n", "La Fecha de Reposici$$HEX1$$f300$$ENDHEX$$n no puede ser menor que la de Embiando Brigada")
////			This.SetItem(row, "f_reposicion", ldt_fecha_nula)
//////			This.SetRedraw(True)
////			Return 2
////		end if
//	
//		if ldt_f_reposicion >= ldt_f_alta then
//			
////			IF gb_operaciones = true and gb_operaciones_inst = true then
//////			IF isvalid(gu_rf_servidor_operacion) THEN
//////			
//////				IF ((gu_rf.of_comprueba_inst_digitalizada(ll_array[], lstr_datos_rama.ll_codigo)> 0) AND &
//////					(lstr_datos_rama.ll_Tipo= fgci_tipo_celda_at) OR (lstr_datos_rama.ll_tipo= fgci_tipo_celda_mt)) THEN
////					gu_comunic2.is_comunic.longval1=0
////					gu_comunic2.is_comunic.datval2=ldt_f_reposicion
////					OPEN (w_listado_maniobras)
////					IF NOT (gu_comunic2.is_comunic.longval1 > 0) THEN
////						Messagebox("Atenci$$HEX1$$f300$$ENDHEX$$n", "No se ha seleccionado una maniobra de cierre")
////						This.SetItem(row, "f_reposicion", ldt_fecha_nula)	
////						Return 2
////					END IF
//////				END IF
////			END IF
//			
////			This.SetItem(row, "f_reposicion", ldt_f_reposicion)
//			This.SetItem(row, "f_reposicion",  ldt_f_reposicion)
//			This.Modify("f_alta.Protect= '1'")
//			This.Modify("f_alta.Background.Color= '" + gs_gris + "'")
//			This.Modify("f_reposicion.Protect= '1'")
//			This.Modify("f_reposicion.Background.Color= '" + gs_gris + "'")
//			ll_handle = tv_2.FINDITEM(CurrentTreeItem! ,0)
//			tv_2.GETITEM(ll_handle,le_elemento)
//			lstr_datos_rama = le_elemento.data
//			ll_fila=tabpage_indisponibilidades.dw_lista_indisponibilidades.find("nro_instalacion= " + string(lstr_datos_rama.ll_codigo),1,tabpage_indisponibilidades.dw_lista_indisponibilidades.RowCount())
//			IF gu_comunic2.is_comunic.longval1 > 0 then
//				This.SetItem(row,"t_mcierre",gu_comunic2.is_comunic.longval1)
//				tabpage_indisponibilidades.dw_lista_indisponibilidades.SetItem(ll_fila,'maniobra_cierre', gu_comunic2.is_comunic.longval1)
//				tabpage_indisponibilidades.dw_lista_indisponibilidades.SetItem(ll_fila,'f_reposicion', ldt_f_reposicion)
//			END IF
////			tabpage_indisponibilidades.dw_lista_indisponibilidades.SetItem(ll_fila,'f_reposicion', ldt_f_reposicion)
//		end if
//	end if
//	return 2
//END IF
//Fin AHM

IF dwo.name= "tip_interrupcion" THEN
	This.SetItem(row,"tip_interrupcion", data)
	// A$$HEX1$$f100$$ENDHEX$$adido por RCA (28/03/2008) El FindItem devolvia -1 a causa de que el TreeWiew perdia el foco.
	tv_2.SetFocus()
	ll_handle = tv_2.FINDITEM(CurrentTreeItem! ,0)
	tv_2.GETITEM(ll_handle,le_elemento)
	lstr_datos_rama = le_elemento.data
	ll_fila=tabpage_indisponibilidades.dw_lista_indisponibilidades.find("nro_instalacion= " + string(lstr_datos_rama.ll_codigo),1,tabpage_indisponibilidades.dw_lista_indisponibilidades.RowCount())
	tabpage_indisponibilidades.dw_lista_indisponibilidades.SetItem(ll_fila,'tip_interrupcion', data)
END IF

IF dwo.name= "causa" THEN
	This.SetItem(row,"causa", data)
END IF

//JME 29/04/09
IF dwo.name= "f_reposicion" THEN

	ldt_f_reposicion=DateTime(Date(Left(data,10)),Time(Right(data,15)))

	if IsNull(ldt_f_reposicion) THEN
		MessageBox("Atenci$$HEX1$$f300$$ENDHEX$$n", "La Fecha de Reposici$$HEX1$$f300$$ENDHEX$$n de la Indisponibilidad no puede ser nula")
		This.SetItem(row, "f_reposicion", idt_fec_deteccion)
		This.SetRedraw(True)
		Return 2
	end if
	
	ldt_f_alta=This.GetItemDateTime(row, "f_alta")

	ll_status = fw_validacion_fecha_reposicion(ldt_f_reposicion, ldt_f_alta, idt_fec_deteccion)
	
	IF ll_status <> 0 THEN  
		This.SetItem(row, "f_reposicion", idt_fec_deteccion)
		This.SetRedraw(True)
		return 2
	ELSE
	
		setnull(ll_auxiliar)
		This.SetItem(row, "t_mcierre", ll_auxiliar)
		ll_fila = tabpage_indisponibilidades.dw_lista_indisponibilidades.GetRow()
		if ll_fila > 0 then 
			tabpage_indisponibilidades.dw_lista_indisponibilidades.SetItem(ll_fila,'f_reposicion', ldt_f_reposicion)
			tabpage_indisponibilidades.dw_lista_indisponibilidades.SetItem(ll_fila,'maniobra_cierre', ll_auxiliar)
		end if
	end if
END IF
//Fin JME	
	





end event

event losefocus;//This.TriggerEvent("ue_itemchanged")
This.AcceptText()
end event

event retrieveend;//AHM (04/01/2008)
IF THIS.rowCount() = 0  THEN		//Si no hay fechas se hace invisible el bot$$HEX1$$f300$$ENDHEX$$n de selecci$$HEX1$$f300$$ENDHEX$$n de maniobas	
	cb_maniobras.visible = FALSE
END IF
end event

type dw_filtro_indisponibilidades from datawindow within tabpage_indisponibilidades
boolean visible = false
integer x = 5
integer y = 48
integer width = 3447
integer height = 264
integer taborder = 10
string title = "none"
string dataobject = "d_filtro_indisponibilidades"
boolean border = false
boolean livescroll = true
end type

event itemchanged;
// PACHO SE ACTIVAN LOS FILTROS

string ls_tipo,ls_instalacion

// Si el registro se modifica

this.accepttext()

choose case dwo.name 

	case "tip_instalacion" 
		
		ls_tipo = this.object.tip_instalacion[1]
		ls_instalacion= this.object.nom_instalacion[1]
		if ls_tipo = "0" then 
			dw_lista_indisponibilidades.Setfilter("")
			dw_lista_indisponibilidades.Filter()
		else
			dw_lista_indisponibilidades.Setfilter("class_id = " + ls_tipo )
			dw_lista_indisponibilidades.Filter()		
		end if

	case "nom_instalacion" 

		ls_tipo = this.object.tip_instalacion[1]
		ls_instalacion= this.object.nom_instalacion[1]
		dw_lista_indisponibilidades.Setfilter("nombre like '" + ls_instalacion + "%'")
		dw_lista_indisponibilidades.Filter()

end choose


	
end event

type tabpage_otros from userobject within u_tab_2301_form_incidencias
boolean visible = false
integer x = 18
integer y = 112
integer width = 5527
integer height = 3872
long backcolor = 79741120
string text = "Otros"
long tabtextcolor = 33554432
long tabbackcolor = 79741120
string picturename = "Otros.bmp"
long picturemaskcolor = 553648127
dw_otros dw_otros
end type

on tabpage_otros.create
this.dw_otros=create dw_otros
this.Control[]={this.dw_otros}
end on

on tabpage_otros.destroy
destroy(this.dw_otros)
end on

type dw_otros from datawindow within tabpage_otros
integer y = 16
integer width = 1595
integer height = 976
integer taborder = 31
string dataobject = "d_inc_2051_otros"
boolean border = false
boolean livescroll = true
end type

event itemchanged;//AHM (04/05/2009) Almacena nombre del usuario que ha modificado el campo agente
IF (gi_pais = 8 AND UPPER(dwo.name) = 'AGENTE') THEN	//Comprueba que es Moldavia y se ha modificado el agente

	THIS.setItem(1, "usuario_agente", gs_usuario)	
	
END IF
end event

type tabpage_ocen from userobject within u_tab_2301_form_incidencias
event create ( )
event destroy ( )
integer x = 18
integer y = 112
integer width = 5527
integer height = 3872
long backcolor = 81324524
string text = "OT Ocen"
long tabtextcolor = 33554432
long tabbackcolor = 81324524
string picturename = "CreateLibrary!"
long picturemaskcolor = 536870912
uo_ot_ocen uo_ot_ocen
end type

on tabpage_ocen.create
this.uo_ot_ocen=create uo_ot_ocen
this.Control[]={this.uo_ot_ocen}
end on

on tabpage_ocen.destroy
destroy(this.uo_ot_ocen)
end on

type uo_ot_ocen from u_2301_tabpage_ocen within tabpage_ocen
event destroy ( )
integer x = -18
integer y = 16
integer taborder = 20
end type

on uo_ot_ocen.destroy
call u_2301_tabpage_ocen::destroy
end on


Start of PowerBuilder Binary Data Section : Do NOT Edit
03u_tab_2301_form_incidencias.bin 
2B00000600e011cfd0e11ab1a1000000000000000000000000000000000003003e0009fffe00000006000000000000000000000001000000010000000000001000fffffffe00000000fffffffe0000000000000000fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffdfffffffeffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff006f00520074006f004500200074006e00790072000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000050016ffffffffffffffffffffffff000000000000000000000000000000000000000000000000000000000000000000000000fffffffe00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ffffffffffffffffffffffff0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ffffffffffffffffffffffff0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ffffffffffffffffffffffff000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
13u_tab_2301_form_incidencias.bin 
End of PowerBuilder Binary Data Section : No Source Expected After This Point
